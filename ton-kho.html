<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Báo Cáo Tồn Kho - Nano Data Premium</title>
	<link rel="icon" type="image/svg+xml"
		href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%236366f1'/><text x='50%' y='50%' dominant-baseline='central' text-anchor='middle' fill='white' font-size='60' font-family='sans-serif' font-weight='800'>DV</text></svg>">
	<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
		rel="stylesheet">
	<style>
		:root {
			--primary: #FFB347;
			--primary-dark: #f39c12;
			--bg-dark: #0f0f0f;
			--card-bg: #1a1a1a;
			--glass: rgba(255, 255, 255, 0.05);
			--glass-border: rgba(255, 255, 255, 0.1);
			--text-main: #ffffff;
			--text-gray: #a0a0a0;
			--success: #2ecc71;
			--error: #e74c3c;
		}

		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}

		body {
			background-color: var(--bg-dark);
			color: var(--text-main);
			-webkit-font-smoothing: antialiased;
			-moz-osx-font-smoothing: grayscale;
			text-rendering: optimizeLegibility;
			font-family: 'Plus Jakarta Sans', sans-serif;
			min-height: 100vh;
			padding: 40px 20px;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
		}

		header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 40px;
		}

		.header-left h1 {
			font-size: 2.2rem;
			font-weight: 800;
			background: linear-gradient(45deg, #fff, var(--primary));
			-webkit-background-clip: text;
			background-clip: text;
			-webkit-text-fill-color: transparent;
		}

		.btn-add {
			padding: 14px 24px;
			background: var(--primary);
			color: #000;
			text-decoration: none;
			border-radius: 16px;
			font-weight: 800;
			display: flex;
			align-items: center;
			gap: 10px;
			transition: 0.3s;
		}

		.btn-add:hover {
			transform: translateY(-3px);
			box-shadow: 0 10px 20px rgba(255, 179, 71, 0.2);
		}

		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
			gap: 20px;
			margin-bottom: 30px;
		}

		.stat-card {
			background: var(--card-bg);
			border: 1px solid var(--glass-border);
			padding: 25px;
			border-radius: 24px;
		}

		.stat-card label {
			color: var(--text-gray);
			font-size: 0.8rem;
			text-transform: uppercase;
			font-weight: 700;
		}

		.stat-card .value {
			font-size: 1.8rem;
			font-weight: 800;
			display: block;
			margin-top: 10px;
		}

		.table-card {
			background: var(--card-bg);
			border: 1px solid var(--glass-border);
			border-radius: 24px;
			overflow: hidden;
		}

		table {
			width: 100%;
			border-collapse: collapse;
		}

		th {
			background: rgba(255, 255, 255, 0.03);
			padding: 20px;
			text-align: left;
			font-size: 0.8rem;
			color: var(--text-gray);
			text-transform: uppercase;
			font-weight: 700;
		}

		td {
			padding: 18px 20px;
			border-bottom: 1px solid var(--glass-border);
			font-size: 0.9rem;
		}

		tr:hover td {
			background: rgba(255, 255, 255, 0.01);
		}

		.badge {
			padding: 6px 12px;
			border-radius: 10px;
			font-size: 0.75rem;
			font-weight: 800;
		}

		.badge-nhap {
			background: rgba(46, 204, 113, 0.15);
			color: var(--success);
		}

		.badge-xuat {
			background: rgba(231, 76, 60, 0.15);
			color: var(--error);
		}

		.loader {
			text-align: center;
			padding: 50px;
			font-weight: 800;
			color: var(--primary);
		}

		/* Floating Menu - Left side */
		.floating-menu {
			position: fixed;
			bottom: 30px;
			left: 30px;
			z-index: 1000;
		}

		.fab-btn {
			width: 65px;
			height: 65px;
			background: linear-gradient(135deg, var(--primary), var(--primary-dark));
			border-radius: 50%;
			border: none;
			color: #000;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			box-shadow: 0 10px 30px rgba(255, 179, 71, 0.3);
			transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
		}

		.fab-btn:hover {
			transform: scale(1.1);
		}

		.fab-menu-list {
			position: absolute;
			bottom: 85px;
			left: 0;
			display: flex;
			flex-direction: column;
			gap: 12px;
			opacity: 0;
			pointer-events: none;
			transform: translateY(20px);
			transition: 0.3s ease;
		}

		.fab-menu-list.active {
			opacity: 1;
			pointer-events: all;
			transform: translateY(0);
		}

		.menu-item {
			background: #1a1a1a;
			padding: 12px 20px;
			border-radius: 16px;
			color: white;
			text-decoration: none;
			display: flex;
			align-items: center;
			gap: 12px;
			white-space: nowrap;
			border: 1px solid var(--glass-border);
			font-weight: 600;
			font-size: 0.9rem;
			transition: 0.2s;
		}

		.menu-item:hover {
			background: #252525;
			border-color: var(--primary);
			color: var(--primary);
		}

		.btn-delete {
			background: rgba(231, 76, 60, 0.1);
			color: var(--error);
			border: 1px solid rgba(231, 76, 60, 0.2);
			padding: 6px 10px;
			border-radius: 8px;
			cursor: pointer;
			font-size: 0.8rem;
			font-weight: 700;
			transition: 0.2s;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.btn-delete:hover {
			background: var(--error);
			color: white;
			transform: scale(1.05);
		}
	</style>
</head>

<body>
	<div class="container">
		<header>
			<div class="header-left">
				<h1>Báo Cáo Tồn Kho</h1>
				<p style="color: var(--text-gray);">Theo dõi Nhập - Xuất - Tồn theo thời gian thực</p>
			</div>
			<a href="nhap-kho.html" class="btn-add">+ NHẬP HÀNG MỚI</a>
		</header>

		<div class="stats-grid" id="statsGrid">
			<div class="stat-card">
				<label>Tổng mã sản phẩm</label>
				<span class="value" id="valTotalItems">0</span>
			</div>
			<div class="stat-card">
				<label>Đang có hàng</label>
				<span class="value" id="valInStock" style="color: var(--success);">0</span>
			</div>
			<div class="stat-card">
				<label>Sắp hết hàng ( < 10 )</label>
						<span class="value" id="valLowStock" style="color: var(--error);">0</span>
			</div>
		</div>

		<div class="table-card">
			<table>
				<thead>
					<tr>
						<th>Ngày tháng</th>
						<th>Mã Đơn/ID</th>
						<th>Tên Sản Phẩm</th>
						<th>Loại</th>
						<th>Số lượng</th>
						<th>Tồn hiện tại</th>
						<th style="text-align: right;">Thao tác</th>
					</tr>
				</thead>
				<tbody id="inventoryBody">
					<tr>
						<td colspan="6" class="loader">ĐANG TẢI DỮ LIỆU TỒN KHO...</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>

	<!-- Menu nổi bên trái -->
	<div class="floating-menu">
		<div class="fab-menu-list" id="fabMenu">
			<a href="len-don-khach.html" class="menu-item">Tạo đơn mới</a>
			<a href="danh-sach-don-khach.html" class="menu-item">Danh sách đơn hàng</a>
			<a href="san-pham-khach.html" class="menu-item">Sản phẩm</a>
			<a href="danh-sach-khach-hang.html" class="menu-item">Khách hàng</a>
			<a href="ton-kho.html" class="menu-item" style="color: var(--primary);">Tồn kho</a>
			<a href="index.html" class="menu-item">Trang chủ</a>
		</div>
		<button class="fab-btn" onclick="toggleFabMenu()">
			<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
				<line x1="3" y1="12" x2="21" y2="12" />
				<line x1="3" y1="6" x2="21" y2="6" />
				<line x1="3" y1="18" x2="21" y2="18" />
			</svg>
		</button>
	</div>

	<script>
		// --- CONFIGURATION ---
		const TONKHO_URL = 'https://script.google.com/macros/s/AKfycbxhXNBpF0lgvQg-EQ-Y5GpBIfGl7orPeIZdkVIOo3BoJmvJpdqHvSnvrMQOtOzGZh_u/exec';
		let currentUser = JSON.parse(localStorage.getItem('user') || '{}');

		document.addEventListener('DOMContentLoaded', () => {
			if (!currentUser.email) window.location.href = 'auth.html';
			fetchInventory();
		});

		async function fetchInventory() {
			try {
				if (TONKHO_URL.includes('PASTE_YOUR_NEW_TONKHO_URL_HERE')) {
					document.getElementById('inventoryBody').innerHTML = '<tr><td colspan="7" class="loader">Hệ thống Tồn Kho chưa được kích hoạt. Hãy liên hệ kỷ thuật!</td></tr>';
					return;
				}

				const safeAdmin = currentUser.adminEmail || currentUser.email;
				const res = await fetch(`${TONKHO_URL}?action=read&adminEmail=${encodeURIComponent(safeAdmin)}`);
				const result = await res.json();
				if (result.success) {
					// Backend returns { success: true, data: all }
					// We need to calculate summary on the fly if backend doesn't provide it
					const summary = {};
					result.data.forEach(log => {
						const pid = log.productId || log.id_san_pham;
						if (!summary[pid]) summary[pid] = 0;
						if (log.type === 'NHAP') summary[pid] += parseFloat(log.quantity || 0);
						else if (log.type === 'XUAT') summary[pid] -= parseFloat(log.quantity || 0);
					});
					renderTable(result.data, summary);
				}
			} catch (e) {
				document.getElementById('inventoryBody').innerHTML = '<tr><td colspan="7" class="loader" style="color:var(--error)">LỖI KẾT NỐI SERVER</td></tr>';
			}
		}

		function renderTable(logs, summary) {
			const body = document.getElementById('inventoryBody');

			// Sắp xếp log mới nhất lên đầu
			const sortedLogs = [...logs].reverse();

			if (sortedLogs.length === 0) {
				body.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 50px;">Chưa có dữ liệu nhập xuất</td></tr>';
				return;
			}

			body.innerHTML = sortedLogs.map(item => {
				const isNhap = item.type === 'NHAP';
				const qty = parseFloat(item.quantity || item.so_luong_nhap || item.so_luong_xuat || 0);
				const pid = item.productId || item.id_san_pham;

				return `
                    <tr>
                        <td style="color: var(--text-gray); font-size: 0.8rem;">${new Date(item.date).toLocaleString('vi-VN')}</td>
                        <td class="bold">${item.id || item.id_don_nhap_xuat || 'N/A'}</td>
                        <td class="bold" style="color: var(--primary);">${item.productName || item.ten_san_pham}</td>
                        <td>
                            <span class="badge ${isNhap ? 'badge-nhap' : 'badge-xuat'}">
                                ${isNhap ? 'NHẬP KHO' : 'XUẤT KHO'}
                            </span>
                        </td>
                        <td class="bold">${qty}</td>
                        <td class="bold">${summary[pid] || 0}</td>
                        <td style="text-align: right;">
                            ${isNhap ? `
                                <button class="btn-delete" onclick="deleteEntry('${item.id || item.id_don_nhap_xuat}', '${pid}')">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                    <span style="margin-left:5px">Xóa</span>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
			}).join('');

			// Cập nhật stats
			const productIdsWithHistory = Object.keys(summary);
			document.getElementById('valTotalItems').innerText = productIdsWithHistory.length;

			const inStock = productIdsWithHistory.filter(id => summary[id] > 0).length;
			document.getElementById('valInStock').innerText = inStock;

			const lowStock = productIdsWithHistory.filter(id => summary[id] > 0 && summary[id] < 10).length;
			document.getElementById('valLowStock').innerText = lowStock;
		}

		function toggleFabMenu() {
			document.getElementById('fabMenu').classList.toggle('active');
		}

		async function deleteEntry(idDon, idSP) {
			if (!confirm(`Bạn có chắc muốn XÓA bản ghi nhập ${idDon}?`)) return;

			try {
				const res = await fetch(TONKHO_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'hard_delete',
						id_don_nhap_xuat: idDon,
						id_san_pham: idSP
					})
				});
				const result = await res.json();
				if (result.success) {
					alert("Đã xóa bản ghi thành công!");
					fetchInventory();
				} else {
					alert("Lỗi: " + result.message);
				}
			} catch (e) {
				alert("Lỗi kết nối. Vui lòng kiểm tra lại Script!");
			}
		}

		// Đóng menu khi click ngoài
		document.addEventListener('click', (e) => {
			if (!e.target.closest('.floating-menu')) {
				document.getElementById('fabMenu').classList.remove('active');
			}
		});
	</script>
	<script src="floating-menu.js"></script>
	<script src="chatbot.js"></script>
</body>

</html>