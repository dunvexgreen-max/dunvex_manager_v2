/**
 * GAS_Debt_Script.txt
 * Quản lý công nợ khách hàng, tích hợp thanh toán và thông báo email
 */

const FILES = {
  TONG_HOP: 'cong_no_tong_hop.json',
  LICH_SU: 'lich_su_thanh_toan.json',
  ORDER_HEADER: 'order.json'
};

const DATA_FOLDER_ID = '1_LT4rzVui2E3BgfcwUSfMsUGQMN9NRTs';
const EVIDENCE_FOLDER_ID = '1aM3-HGbuZTLxW8TAz_9rqz1yXkPeKCUC';
const XOR_SECRET = 'dunvex_secure_key_2025_custom';

const SafeStore = {
  read: function(filename) {
    try {
      const folder = DriveApp.getFolderById(DATA_FOLDER_ID);
      const files = folder.getFilesByName(filename);
      if (!files.hasNext()) return [];
      const content = files.next().getBlob().getDataAsString().trim();
      if (!content) return [];
      return content.split('\n').filter(l => l.trim()).map(l => JSON.parse(l));
    } catch (e) { return []; }
  },
  write: function(filename, newData, action = 'APPEND') {
    const lock = LockService.getScriptLock();
    try {
      lock.waitLock(30000);
      const folder = DriveApp.getFolderById(DATA_FOLDER_ID);
      let file, files = folder.getFilesByName(filename);
      if (files.hasNext()) file = files.next();
      else file = folder.createFile(filename, '', MimeType.PLAIN_TEXT);

      if (action === 'APPEND') {
        const currentContent = file.getBlob().getDataAsString();
        const separator = (currentContent && !currentContent.endsWith('\n')) ? '\n' : '';
        file.setContent(currentContent + separator + JSON.stringify(newData));
      } else {
        let data = (action === 'REPLACE_ALL') ? newData : this.read(filename);
        if (action === 'UPDATE') {
          const id = newData.id;
          const idx = data.findIndex(item => item.id === id);
          if (idx !== -1) data[idx] = Object.assign({}, data[idx], newData);
          else data.push(newData);
        }
        file.setContent(data.map(item => JSON.stringify(item)).join('\n'));
      }
      return { success: true };
    } catch (e) { return { success: false, message: e.toString() }; }
    finally { lock.releaseLock(); }
  }
};

function encryptData(text) {
  if (!text) return "";
  const inputBytes = Utilities.newBlob(text.toString()).getBytes();
  const keyBytes = Utilities.newBlob(XOR_SECRET).getBytes();
  const outputBytes = inputBytes.map((b, i) => b ^ keyBytes[i % keyBytes.length]);
  return Utilities.base64Encode(outputBytes);
}

const AES_KEY = Utilities.newBlob('dunvex_secure_16').getBytes();

function decryptXOR(base64Text) {
  if (!base64Text || base64Text.length < 5) return base64Text;
  try {
    const inputBytes = Utilities.base64Decode(base64Text);
    const keyBytes = Utilities.newBlob(XOR_SECRET).getBytes();
    const outputBytes = inputBytes.map((b, i) => b ^ keyBytes[i % keyBytes.length]);
    return Utilities.newBlob(outputBytes).getDataAsString();
  } catch (e) { return base64Text; }
}

function decryptAES(base64Text) {
  if (!base64Text || base64Text.length < 10) return base64Text;
  try {
    const decoded = Utilities.base64Decode(base64Text);
    const decrypted = Utilities.decrypt(Utilities.CipherAlgorithm.AES_128, AES_KEY, decoded);
    return decrypted.getDataAsString();
  } catch (e) { return base64Text; }
}

function decryptData(base64Text) {
  if (!base64Text || typeof base64Text !== 'string') return base64Text;
  let dec = decryptXOR(base64Text);
  if ((!dec || !dec.includes('@')) && base64Text.length > 5) {
     const aes = decryptAES(base64Text);
     if (aes && aes.includes('@')) return aes;
  }
  return dec;
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    let result;

    switch (action) {
      case 'get_debt_report':
        result = getDebtReport(data.adminEmail);
        break;
      case 'save_payment':
        result = savePayment(data);
        break;
      case 'sync_order_to_debt':
        result = syncOrderToDebt(data.orderId, data.adminEmail);
        break;
      case 'get_customer_history':
        result = getCustomerHistory(data.customerId, data.adminEmail);
        break;
      case 'delete_payment':
        result = deletePayment(data.paymentId, data.adminEmail);
        break;
      default:
        result = { success: false, message: 'Thao tác không hợp lệ' };
    }
    return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ success: false, message: err.toString() })).setMimeType(ContentService.MimeType.JSON);
  }
}

function getDebtReport(adminEmail) {
  const safeAdmin = (adminEmail || "").toLowerCase().trim();
  
  // 1. Lấy dữ liệu tổng hợp
  let allSummary = SafeStore.read(FILES.TONG_HOP);
  let summary = allSummary.filter(d => decryptData(d.ownedByAdmin).toLowerCase() === safeAdmin);

  // 2. Lấy danh sách đơn hàng chốt (để hiện ở tab 1)
  const allOrders = SafeStore.read(FILES.ORDER_HEADER);
  const orders = allOrders.filter(o => {
    const mgr = decryptData(o.manager_email || "").toLowerCase();
    // Super admin hoặc manager sở hữu đơn
    return (safeAdmin === 'dunvex.green@gmail.com' || mgr.includes(safeAdmin)) && o.trang_thai_don_hang === 'Đơn chốt';
  }).map(o => ({
    ngay_len_don: o.ngay_len_don,
    ten_khach_hang: o.ten_khach_hang,
    id_don_hang: o.id_don_hang,
    so_tien_con_lai: parseFloat(o.so_tien_con_lai) || 0
  }));

  // 3. Lấy lịch sử thanh toán (để hiện ở tab 3)
  const allPayments = SafeStore.read(FILES.LICH_SU);
  const payments = allPayments.filter(p => {
    const owned = decryptData(p.ownedByAdmin).toLowerCase();
    return safeAdmin === 'dunvex.green@gmail.com' || owned === safeAdmin;
  }).map(p => {
       const pCopy = Object.assign({}, p);
       pCopy.userEmail = decryptData(p.userEmail);
       pCopy.customerEmail = decryptData(p.customerEmail);
       pCopy.managingAdminEmail = decryptData(p.managingAdminEmail);
       return pCopy;
    });

  // 4. Tự động đồng bộ lại Summary dựa trên trạng thái thực tế của Orders (Tránh data ảo nếu đơn bị xóa/hủy)
  let summaryChanged = false;
  summary.forEach(s => {
    if (s.syncedOrders && s.syncedOrders.length > 0) {
      const validSynced = s.syncedOrders.filter(id => {
        const orderExists = allOrders.find(o => o.id_don_hang === id && o.trang_thai_don_hang === 'Đơn chốt');
        return !!orderExists;
      });
      
      if (validSynced.length !== s.syncedOrders.length) {
        // Có đơn hàng đã bị xóa hoặc chuyển trạng thái -> Tính toán lại totalDebt
        s.syncedOrders = validSynced;
        s.totalDebt = validSynced.reduce((sum, id) => {
          const o = allOrders.find(x => x.id_don_hang === id);
          return sum + (parseFloat(o.so_tien_con_lai) || 0);
        }, 0);
        s.remaining = (parseFloat(s.totalDebt) || 0) - (parseFloat(s.paid) || 0);
        summaryChanged = true;
      }
    }
  });
  if (summaryChanged) SafeStore.write(FILES.TONG_HOP, allSummary, 'REPLACE_ALL');

  // 5. Nếu summary rỗng mà có orders... (rebuild mechanism)
  if (summary.length === 0 && orders.length > 0) {
    const rebuilt = {};
    orders.forEach(o => {
      const key = o.customerId || o.ten_khach_hang;
      if (!rebuilt[key]) rebuilt[key] = { customerId: key, customerName: o.ten_khach_hang, totalDebt: 0, paid: 0, remaining: 0, syncedOrders: [], ownedByAdmin: encryptData(safeAdmin) };
      rebuilt[key].totalDebt += o.so_tien_con_lai;
      rebuilt[key].syncedOrders.push(o.id_don_hang);
    });
    payments.forEach(p => {
       const key = p.customerId;
       if (rebuilt[key]) rebuilt[key].paid += p.amount;
    });
    Object.values(rebuilt).forEach(r => {
      r.remaining = r.totalDebt - r.paid;
      allSummary.push(r);
    });
    SafeStore.write(FILES.TONG_HOP, allSummary, 'REPLACE_ALL');
    summary = allSummary.filter(d => decryptData(d.ownedByAdmin).toLowerCase() === safeAdmin);
  }

  return { 
    success: true, 
    summary: summary,
    orders: orders,
    payments: payments
  };
}

function savePayment(payload) {
  const { customerId, customerName, customerEmail, amount, note, evidenceImage, userEmail, adminEmail, managingAdminEmail, sendEmail } = payload;
  const safeAdmin = (adminEmail || "").toLowerCase().trim();
  const safeManagingAdmin = (managingAdminEmail || adminEmail || "").toLowerCase().trim();
  
  let imageUrl = "";
  if (evidenceImage && evidenceImage.base64) {
    const blob = Utilities.newBlob(Utilities.base64Decode(evidenceImage.base64), evidenceImage.type, "Debt_" + customerId + "_" + new Date().getTime());
    const file = DriveApp.getFolderById(EVIDENCE_FOLDER_ID).createFile(blob);
    imageUrl = "https://lh3.googleusercontent.com/d/" + file.getId();
  }

  const paymentEntry = {
    id: "PAY-" + new Date().getTime(),
    customerId,
    customerName,
    amount: parseFloat(amount),
    date: new Date().toISOString(),
    imageUrl,
    note,
    userEmail: encryptData(userEmail),
    customerEmail: encryptData(customerEmail),
    managingAdminEmail: encryptData(safeManagingAdmin),
    ownedByAdmin: encryptData(safeAdmin)
  };

  SafeStore.write(FILES.LICH_SU, paymentEntry, 'APPEND');

  // Cập nhật tổng hợp
  let allDebt = SafeStore.read(FILES.TONG_HOP);
  let debtItem = allDebt.find(d => d.customerId === customerId && decryptData(d.ownedByAdmin).toLowerCase() === safeAdmin);
  
  if (debtItem) {
    debtItem.paid = (parseFloat(debtItem.paid) || 0) + parseFloat(amount);
    debtItem.remaining = (parseFloat(debtItem.totalDebt) || 0) - debtItem.paid;
  } else {
    debtItem = {
      customerId,
      customerName,
      totalDebt: 0,
      paid: parseFloat(amount),
      remaining: -parseFloat(amount),
      ownedByAdmin: encryptData(safeAdmin)
    };
    allDebt.push(debtItem);
  }
  SafeStore.write(FILES.TONG_HOP, allDebt, 'REPLACE_ALL');

  if ((sendEmail === true || sendEmail === "true") && customerEmail && customerEmail.includes("@")) {
    try {
      sendDebtEmail(customerEmail, customerName, amount, debtItem.remaining, "Thanh toán công nợ", safeAdmin);
    } catch(err) { console.error("Email delay but data saved"); }
  }

  return { 
    success: true, 
    message: "Đã lưu thanh toán thành công", 
    remaining: debtItem.remaining,
    emailSentTo: customerEmail || "No Email Provided"
  };
}

function syncOrderToDebt(orderId, adminEmail, sendEmail) {
  const safeAdmin = (adminEmail || "").toLowerCase().trim();
  const orders = SafeStore.read(FILES.ORDER_HEADER);
  const order = orders.find(o => o.id_don_hang === orderId);
  const CRM_SS_ID = '15niaoQ7FozkRCushPGNtq4zj6pwA0UQ5Wel61ksv8L8';
  
  if (!order) return { success: false, message: "Không tìm thấy đơn hàng" };
  
  // Lấy email khách hàng từ CRM Sheet (Cải tiến truy vấn)
  let custEmail = "";
  try {
    const ss = SpreadsheetApp.openById(CRM_SS_ID);
    const sheet = ss.getSheetByName('data_khach_hang');
    const data = sheet.getDataRange().getValues();
    const targetName = (order.ten_khach_hang || "").toString().toLowerCase().trim();
    const targetId = (order.customerId || "").toString().trim();
    
    const custRow = data.find(r => {
      const sheetName = (r[1] || "").toString().toLowerCase().trim();
      const sheetId = (r[0] || "").toString().trim();
      return (targetId && sheetId === targetId) || (sheetName === targetName);
    });
    if (custRow) custEmail = (custRow[2] || "").toString().trim(); 
  } catch(e) { console.error("CRM Email Lookup Error: " + e.toString()); }
  
  const isFinalized = order.trang_thai_don_hang === 'Đơn chốt';
  const amount = parseFloat(order.so_tien_con_lai) || 0;
  const customerId = order.customerId || (order.ten_khach_hang ? order.ten_khach_hang.toString().toUpperCase() : "GUEST");

  let allDebt = SafeStore.read(FILES.TONG_HOP);
  let debtItem = allDebt.find(d => d.customerId === customerId && decryptData(d.ownedByAdmin).toLowerCase() === safeAdmin);

  if (isFinalized) {
    if (debtItem) {
      if (!debtItem.syncedOrders) debtItem.syncedOrders = [];
      if (!debtItem.syncedOrders.includes(orderId)) {
        // Đơn hàng chưa từng được chốt nợ trước đây -> Gửi mail
        debtItem.totalDebt = (parseFloat(debtItem.totalDebt) || 0) + amount;
        debtItem.syncedOrders.push(orderId);
        
        if ((sendEmail === true || sendEmail === "true") && custEmail && custEmail.includes("@")) {
          try {
            sendDebtEmail(custEmail, order.ten_khach_hang, amount, (parseFloat(debtItem.totalDebt) || 0) - (parseFloat(debtItem.paid) || 0), "Chốt công nợ đơn hàng: " + orderId, safeAdmin);
            emailStatus = custEmail;
          } catch(e) { console.error("Sync Email Error: " + e.toString()); }
        }
      }
    } else {
      // Khách hàng mới hoàn toàn, đơn đầu tiên chốt
      debtItem = {
        customerId,
        customerName: order.ten_khach_hang,
        totalDebt: amount,
        paid: 0,
        remaining: amount,
        syncedOrders: [orderId],
        ownedByAdmin: encryptData(safeAdmin)
      };
      allDebt.push(debtItem);
      
      if ((sendEmail === true || sendEmail === "true") && custEmail && custEmail.includes("@")) {
        try {
          sendDebtEmail(custEmail, order.ten_khach_hang, amount, amount, "Chốt công nợ đơn hàng: " + orderId, safeAdmin);
          emailStatus = custEmail;
        } catch(e) { console.error("Sync Email Error: " + e.toString()); }
      }
    }
  } else {
    // Nếu đơn KHÔNG PHẢI ĐƠN CHỐT: Nếu trước đó đã sync thì phải trừ đi
    if (debtItem && debtItem.syncedOrders && debtItem.syncedOrders.includes(orderId)) {
        debtItem.totalDebt = (parseFloat(debtItem.totalDebt) || 0) - amount;
        debtItem.syncedOrders = debtItem.syncedOrders.filter(id => id !== orderId);
        if (debtItem.totalDebt < 0) debtItem.totalDebt = 0;
    }
  }
  
  if (debtItem) {
     debtItem.remaining = (parseFloat(debtItem.totalDebt) || 0) - (parseFloat(debtItem.paid) || 0);
     SafeStore.write(FILES.TONG_HOP, allDebt, 'REPLACE_ALL');
  }

  return { success: true, remaining: debtItem ? debtItem.remaining : 0, emailSentTo: emailStatus };
}

function deletePayment(paymentId, adminEmail) {
  const safeAdmin = (adminEmail || "").toLowerCase().trim();
  let history = SafeStore.read(FILES.LICH_SU);
  const payment = history.find(p => p.id === paymentId);
  if (!payment) return { success: false, message: "Không tìm thấy phiếu thu" };

  // Xóa khỏi lịch sử
  history = history.filter(p => p.id !== paymentId);
  SafeStore.write(FILES.LICH_SU, history, 'REPLACE_ALL');

  // Cập nhật lại Summary
  const customerId = payment.customerId;
  let allDebt = SafeStore.read(FILES.TONG_HOP);
  let debtItem = allDebt.find(d => d.customerId === customerId && decryptData(d.ownedByAdmin).toLowerCase() === safeAdmin);
  if (debtItem) {
    debtItem.paid = (parseFloat(debtItem.paid) || 0) - parseFloat(payment.amount);
    if (debtItem.paid < 0) debtItem.paid = 0;
    debtItem.remaining = (parseFloat(debtItem.totalDebt) || 0) - debtItem.paid;
    SafeStore.write(FILES.TONG_HOP, allDebt, 'REPLACE_ALL');
  }

  return { success: true, message: "Đã xóa phiếu thu thành công" };
}

function getCustomerHistory(customerId, adminEmail) {
  const safeAdmin = (adminEmail || "").toLowerCase().trim();
  const history = SafeStore.read(FILES.LICH_SU);
  const filtered = history.filter(h => h.customerId === customerId && decryptData(h.ownedByAdmin).toLowerCase() === safeAdmin);
  return { success: true, data: filtered };
}

function sendDebtEmail(to, name, payAmount, balance, type, adminEmail) {
  if (!to || !to.includes("@")) return;
  
  const isPayment = type.includes("Thanh toán");
  const actionLabel = isPayment ? "SỐ TIỀN ĐÃ TRẢ" : "GIÁ TRỊ ĐƠN HÀNG";
  const actionColor = isPayment ? "#10b981" : "#ef4444";
  
  // Manual currency formatter for GAS compatibility
  const fmt = (v) => v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + " đ";

  const subject = `[Dunvex Digital] ${isPayment ? 'Xác nhận thanh toán' : 'Thông báo đơn hàng mới'} - ${name}`;
  const body = `
    <html>
      <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #1e293b; background-color: #f1f5f9; padding: 20px;">
        <div style="max-width: 600px; margin: auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
          <div style="background: #4f46e5; padding: 20px; text-align: center;">
            <h1 style="color: white; margin: 0; font-size: 22px;">DUNVEX DIGITAL</h1>
          </div>
          <div style="padding: 30px;">
            <p>Kính gửi <strong>${name}</strong>,</p>
            <p>Hệ thống ghi nhận giao dịch mới:</p>
            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin: 20px 0;">
              <p style="margin: 5px 0;">Nội dung: <strong>${type}</strong></p>
              <p style="margin: 5px 0;">${actionLabel}: <span style="color: ${actionColor}; font-weight: bold;">${fmt(payAmount)}</span></p>
              <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 15px 0;">
              <p style="margin: 5px 0; font-size: 18px;">TỔNG NỢ CÒN LẠI: <span style="color: #4f46e5; font-weight: 800;">${fmt(balance)}</span></p>
            </div>
            <p style="font-size: 12px; color: #64748b; text-align: center;">Đây là email tự động, vui lòng không trả lời.</p>
          </div>
        </div>
      </body>
    </html>
  `;
  
  try {
    // Switch to GmailApp for better deliverability
    GmailApp.sendEmail(to, subject, "", {
      htmlBody: body,
      name: "Dunvex Digital Notification"
    });
  } catch (e) { 
    console.error("GmailApp failed, trying MailApp: " + e.toString());
    try {
      MailApp.sendEmail({ to, subject, htmlBody: body });
    } catch(e2) { console.error("All email methods failed"); }
  }
}
