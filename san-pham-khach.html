<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Qu·∫£n L√Ω S·∫£n Ph·∫©m & ƒê∆°n H√†ng</title>
	<link rel="icon"
		href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgC6ibu0IT2Ihhik57NmlGYZgx57h3XvSk5dLipgo7cZTS0pEV7dmPGQZhwXAxTFqFH9l2C74l14MamphdzEWaRBZbeWSUsyIh2Wd-wKuPv274PMjrAgMtirxbfrK-eUcFp5Rx0cFL7uPMA93RBiWrnp5sghMDD78oBCEk3FA_QbZUY4eG3jTZK_nt65vM/s1600/logo12.png"
		type="image/png">
	<link
		href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Dancing+Script:wght@700&display=swap"
		rel="stylesheet">
	<style>
		:root {
			--primary: #FFD700;
			--primary-dark: #FFC000;
			--accent: #FDB931;
			--dark: #121212;
			--dark-card: #1e1e1e;
			--text-light: #ffffff;
			--text-gray: #a0a0a0;
			--success: #00c853;
			--danger: #ff3d00;
			--glass: rgba(255, 255, 255, 0.05);
			--glass-border: rgba(255, 255, 255, 0.1);
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Plus Jakarta Sans', sans-serif;
		}

		body {
			background-color: var(--dark);
			color: var(--text-light);
			min-height: 100vh;
			overflow-x: hidden;
		}

		/* Gradient backgrounds */
		.bg-gradient {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: radial-gradient(circle at 50% 50%, #1e1e1e 0%, #121212 100%);
			z-index: -1;
		}

		.bg-blob {
			position: fixed;
			width: 500px;
			height: 500px;
			background: var(--primary);
			filter: blur(150px);
			opacity: 0.05;
			z-index: -1;
			border-radius: 50%;
		}

		.blob-1 {
			top: -200px;
			right: -200px;
		}

		.blob-2 {
			bottom: -200px;
			left: -200px;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 40px 20px;
		}

		/* Header */
		header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 50px;
			animation: fadeInDown 0.8s ease-out;
		}

		.header-left h1 {
			font-size: 2.5rem;
			font-weight: 800;
			background: linear-gradient(to right, var(--primary), #fff);
			-webkit-background-clip: text;
			background-clip: text;
			-webkit-text-fill-color: transparent;
			letter-spacing: -1px;
		}

		.header-left p {
			color: var(--text-gray);
			font-size: 1rem;
			margin-top: 5px;
		}

		.header-right {
			display: flex;
			gap: 15px;
			align-items: center;
		}

		.user-chip {
			background: var(--glass);
			border: 1px solid var(--glass-border);
			padding: 8px 15px;
			border-radius: 30px;
			display: flex;
			align-items: center;
			gap: 10px;
			backdrop-filter: blur(10px);
		}

		.user-chip span {
			font-weight: 600;
			font-size: 0.9rem;
		}

		.user-chip .avatar {
			width: 30px;
			height: 30px;
			background: var(--primary);
			color: var(--dark);
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 800;
			font-size: 0.8rem;
		}

		/* Buttons */
		.btn {
			padding: 12px 24px;
			border-radius: 14px;
			font-weight: 700;
			cursor: pointer;
			transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
			border: none;
			display: inline-flex;
			align-items: center;
			gap: 10px;
			text-decoration: none;
			font-size: 0.95rem;
		}

		.btn-primary {
			background: var(--primary);
			color: var(--dark);
		}

		.btn-primary:hover {
			transform: translateY(-3px) scale(1.02);
			box-shadow: 0 10px 20px rgba(255, 215, 0, 0.2);
			background: #fff;
		}

		.btn-glass {
			background: var(--glass);
			color: var(--text-light);
			border: 1px solid var(--glass-border);
			backdrop-filter: blur(10px);
		}

		.btn-glass:hover {
			background: rgba(255, 255, 255, 0.1);
			border-color: var(--primary);
		}

		/* Actions Bar */
		.actions-bar {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
			gap: 20px;
			animation: fadeIn 1s ease-out 0.2s both;
		}

		.search-box {
			position: relative;
			flex: 1;
			max-width: 400px;
		}

		.search-box input {
			width: 100%;
			background: var(--glass);
			border: 1px solid var(--glass-border);
			padding: 14px 20px 14px 50px;
			border-radius: 16px;
			color: #fff;
			outline: none;
			transition: 0.3s;
			font-size: 1rem;
		}

		.search-box input:focus {
			border-color: var(--primary);
			background: rgba(255, 255, 255, 0.08);
			box-shadow: 0 0 20px rgba(255, 215, 0, 0.05);
		}

		.search-box svg {
			position: absolute;
			left: 20px;
			top: 50%;
			transform: translateY(-50%);
			color: var(--text-gray);
		}

		/* Product Grid */
		.product-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
			gap: 25px;
			animation: fadeInUp 0.8s ease-out 0.4s both;
		}

		.product-card {
			background: var(--dark-card);
			border: 1px solid var(--glass-border);
			border-radius: 24px;
			overflow: hidden;
			transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
			position: relative;
		}

		.product-card:hover {
			transform: translateY(-10px);
			border-color: var(--primary);
			box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
		}

		.product-img {
			width: 100%;
			height: 200px;
			background: #252525;
			position: relative;
			overflow: hidden;
		}

		.product-img img {
			width: 100%;
			height: 100%;
			object-fit: cover;
			transition: 0.5s;
		}

		.product-card:hover .product-img img {
			transform: scale(1.1);
		}

		.product-badge {
			position: absolute;
			top: 15px;
			right: 15px;
			background: rgba(0, 0, 0, 0.6);
			backdrop-filter: blur(5px);
			padding: 5px 12px;
			border-radius: 20px;
			font-size: 0.75rem;
			font-weight: 700;
			color: var(--primary);
			z-index: 2;
		}

		.product-info {
			padding: 20px;
		}

		.product-info h3 {
			font-size: 1.1rem;
			font-weight: 700;
			margin-bottom: 8px;
			color: #fff;
		}

		.product-info .category {
			font-size: 0.85rem;
			color: var(--text-gray);
			margin-bottom: 15px;
			display: block;
		}

		.product-footer {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding-top: 15px;
			border-top: 1px solid var(--glass-border);
		}

		.product-price {
			font-size: 1.2rem;
			font-weight: 800;
			color: var(--primary);
		}

		.product-actions {
			display: flex;
			gap: 8px;
		}

		.action-btn {
			width: 36px;
			height: 36px;
			border-radius: 10px;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: 0.3s;
			border: 1px solid var(--glass-border);
			background: var(--glass);
		}

		.btn-edit:hover {
			background: var(--primary);
			color: var(--dark);
			border-color: var(--primary);
		}

		.btn-delete:hover {
			background: var(--danger);
			color: white;
			border-color: var(--danger);
		}

		/* Empty State */
		.empty-state {
			grid-column: 1 / -1;
			padding: 100px 0;
			text-align: center;
			background: var(--glass);
			border: 2px dashed var(--glass-border);
			border-radius: 24px;
		}

		.empty-state svg {
			width: 80px;
			height: 80px;
			color: var(--glass-border);
			margin-bottom: 20px;
		}

		.empty-state h2 {
			font-size: 1.5rem;
			color: var(--text-gray);
			font-weight: 600;
		}

		/* Modal */
		.modal {
			display: none;
			position: fixed;
			z-index: 1000;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			backdrop-filter: blur(10px);
			align-items: center;
			justify-content: center;
			padding: 20px;
		}

		.modal.active {
			display: flex;
		}

		.modal-content {
			background: var(--dark-card);
			width: 100%;
			max-width: 600px;
			border-radius: 30px;
			border: 1px solid var(--glass-border);
			position: relative;
			padding: 40px;
			box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
			animation: modalZoom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
		}

		@keyframes modalZoom {
			from {
				opacity: 0;
				transform: scale(0.9) translateY(20px);
			}

			to {
				opacity: 1;
				transform: scale(1) translateY(0);
			}
		}

		.modal-header {
			margin-bottom: 30px;
		}

		.modal-header h2 {
			font-size: 1.8rem;
			font-weight: 800;
		}

		.close-modal {
			position: absolute;
			top: 25px;
			right: 25px;
			width: 40px;
			height: 40px;
			background: var(--glass);
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: 0.3s;
		}

		.close-modal:hover {
			background: var(--danger);
			transform: rotate(90deg);
		}

		/* Form */
		.form-group {
			margin-bottom: 20px;
		}

		.form-group label {
			display: block;
			font-size: 0.85rem;
			font-weight: 700;
			color: var(--text-gray);
			margin-bottom: 10px;
			text-transform: uppercase;
			letter-spacing: 1px;
		}

		.form-input,
		.form-select {
			width: 100%;
			background: var(--glass);
			border: 1px solid var(--glass-border);
			padding: 14px 20px;
			border-radius: 14px;
			color: #fff;
			outline: none;
			font-size: 1rem;
			transition: 0.3s;
		}

		.form-input:focus,
		.form-select:focus {
			border-color: var(--primary);
			background: rgba(255, 255, 255, 0.08);
		}

		.form-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 20px;
		}

		/* Image Upload */
		.image-upload-wrapper {
			position: relative;
			width: 100%;
			height: 180px;
			border: 2px dashed var(--glass-border);
			border-radius: 20px;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: 0.3s;
			overflow: hidden;
			background: var(--glass);
		}

		.image-upload-wrapper:hover {
			border-color: var(--primary);
			background: rgba(255, 215, 0, 0.05);
		}

		.image-preview {
			width: 100%;
			height: 100%;
			object-fit: contain;
			display: none;
		}

		.upload-placeholder {
			text-align: center;
			color: var(--text-gray);
		}

		.upload-placeholder svg {
			width: 40px;
			height: 40px;
			margin-bottom: 10px;
		}

		#fileInput {
			display: none;
		}

		/* Loader */
		.loader-overlay {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			backdrop-filter: blur(10px);
			z-index: 2000;
			flex-direction: column;
			align-items: center;
			justify-content: center;
		}

		.spinner {
			width: 50px;
			height: 50px;
			border: 4px solid var(--glass-border);
			border-top: 4px solid var(--primary);
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}

			100% {
				transform: rotate(360deg);
			}
		}

		/* Animations */
		@keyframes fadeInDown {
			from {
				opacity: 0;
				transform: translateY(-30px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		@keyframes fadeInUp {
			from {
				opacity: 0;
				transform: translateY(30px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
			}

			to {
				opacity: 1;
			}
		}

		/* Tabs */
		.tab-container {
			display: flex;
			gap: 15px;
			margin-bottom: 30px;
			border-bottom: 1px solid var(--glass-border);
			padding-bottom: 10px;
			animation: fadeIn 1s ease-out 0.3s both;
		}

		.tab-btn {
			padding: 12px 25px;
			background: none;
			border: none;
			color: var(--text-gray);
			cursor: pointer;
			font-weight: 600;
			font-size: 1rem;
			transition: all 0.3s;
			position: relative;
		}

		.tab-btn.active {
			color: var(--primary);
		}

		.tab-btn.active::after {
			content: '';
			position: absolute;
			bottom: -11px;
			left: 0;
			width: 100%;
			height: 2px;
			background: var(--primary);
			box-shadow: 0 0 10px var(--primary);
		}

		.tab-content {
			display: none;
			animation: fadeIn 0.4s ease-out;
		}

		.tab-content.active {
			display: block;
		}

		/* Inventory Table */
		.table-wrapper {
			background: var(--glass);
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			overflow-x: auto;
			backdrop-filter: blur(10px);
			margin-top: 20px;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			text-align: left;
		}

		th {
			padding: 20px;
			color: var(--text-gray);
			font-weight: 600;
			border-bottom: 1px solid var(--glass-border);
			font-size: 0.85rem;
			text-transform: uppercase;
			letter-spacing: 1px;
			background: rgba(255, 255, 255, 0.02);
		}

		td {
			padding: 18px 20px;
			border-bottom: 1px solid var(--glass-border);
			font-size: 0.95rem;
		}

		tr:hover {
			background: rgba(255, 255, 255, 0.02);
		}

		/* Mobile Adjustments */
		@media (max-width: 768px) {
			header {
				flex-direction: column;
				align-items: flex-start;
				gap: 20px;
			}

			.header-left h1 {
				font-size: 2rem;
			}

			.actions-bar {
				flex-direction: column;
				align-items: stretch;
			}

			.form-grid {
				grid-template-columns: 1fr;
			}

			.modal-content {
				padding: 30px 20px;
			}

			.tab-container {
				overflow-x: auto;
				gap: 10px;
			}

			.tab-btn {
				font-size: 0.9rem;
				padding: 10px 20px;
				white-space: nowrap;
			}
		}

		/* Choice Modal Styles */
		.choice-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 20px;
			margin-top: 20px;
		}

		.choice-card {
			padding: 30px;
			background: var(--glass);
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			text-align: center;
			cursor: pointer;
			transition: all 0.3s;
		}

		.choice-card:hover {
			border-color: var(--primary);
			transform: translateY(-5px);
			background: rgba(255, 215, 0, 0.05);
		}

		.choice-card svg {
			color: var(--primary);
			margin-bottom: 15px;
		}

		/* Order Rows (Dynamic Products) */
		.order-items-table {
			margin-top: 20px;
			width: 100%;
		}

		.order-items-table th {
			padding: 10px;
		}

		.order-items-table td {
			padding: 8px;
		}

		.total-section {
			margin-top: 30px;
			padding-top: 20px;
			border-top: 1px solid var(--glass-border);
			display: flex;
			flex-direction: column;
			align-items: flex-end;
			gap: 15px;
		}

		.total-row {
			display: flex;
			gap: 20px;
			font-size: 1.1rem;
		}

		.total-val {
			font-weight: 800;
			color: var(--primary);
			min-width: 150px;
			text-align: right;
		}

		/* Invoice Styling */
		.invoice-preview {
			background: white;
			color: #333;
			padding: 40px;
			border-radius: 8px;
			min-height: 100%;
		}

		.invoice-header {
			display: flex;
			justify-content: space-between;
			border-bottom: 2px solid #f0f0f0;
			padding-bottom: 20px;
			margin-bottom: 30px;
		}

		.invoice-title {
			color: #1a1a1a;
			font-size: 1.8rem;
			font-weight: 800;
		}

		.invoice-info-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 40px;
			margin-bottom: 30px;
		}

		.info-item label {
			display: block;
			color: #888;
			font-size: 0.8rem;
			text-transform: uppercase;
			margin-bottom: 5px;
		}

		.info-item p {
			font-weight: 600;
			color: #333;
		}

		.invoice-table {
			width: 100%;
			border-collapse: collapse;
			margin-bottom: 30px;
		}

		.invoice-table th {
			background: #f8f9fa;
			color: #555;
			border: none;
			padding: 12px 15px;
			font-size: 0.85rem;
		}

		.invoice-table td {
			padding: 15px;
			border-bottom: 1px solid #f0f0f0;
			color: #444;
		}

		.invoice-summary {
			margin-left: auto;
			width: 100%;
			max-width: 500px;
			border-top: 1px solid #f0f0f0;
			padding-top: 20px;
		}

		.summary-row {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 12px;
			gap: 20px;
		}

		.summary-label {
			color: #888;
			white-space: nowrap;
		}

		.summary-value {
			font-weight: 600;
			white-space: nowrap;
			color: #333;
		}

		.summary-row.grand-total {
			padding-top: 15px;
			border-top: 2px solid var(--primary);
			margin-top: 5px;
		}

		.summary-label-total {
			font-weight: 800;
			font-size: 1.2rem;
			color: #1a1a1a;
			white-space: nowrap;
		}

		.summary-value-total {
			color: var(--primary);
			font-weight: 800;
			font-size: 1.4rem;
			white-space: nowrap;
		}

		/* Responsive Invoice Modal */
		#invoiceModal .modal-content {
			max-width: 950px;
			max-height: 95vh;
			display: flex;
			flex-direction: column;
			padding: 0;
			overflow: hidden;
			background: #fff;
		}

		#invoiceContent {
			flex: 1;
			overflow-y: auto;
			padding: 40px;
			background: white;
		}

		@media (max-width: 768px) {
			#invoiceModal .modal-content {
				width: 98%;
				max-height: 98vh;
				border-radius: 15px;
			}

			#invoiceContent {
				padding: 20px;
			}

			.invoice-header {
				flex-direction: column !important;
				gap: 15px;
				text-align: left;
			}

			.invoice-header div:last-child {
				text-align: left !important;
			}

			.invoice-info-grid {
				grid-template-columns: 1fr !important;
				gap: 20px;
			}

			.invoice-table-wrapper {
				overflow-x: auto;
				margin: 0 -20px 20px -20px;
				padding: 0 20px;
				-webkit-overflow-scrolling: touch;
			}

			.invoice-table {
				min-width: 600px;
			}

			.invoice-summary {
				max-width: 100% !important;
			}

			.invoice-signatures {
				flex-direction: column !important;
				gap: 50px;
				margin-top: 40px !important;
			}

			.invoice-signatures>div {
				width: 100% !important;
			}
		}

		@media print {
			body * {
				visibility: hidden;
			}

			#invoiceModal,
			#invoiceModal * {
				visibility: visible;
			}

			#invoiceModal {
				position: absolute;
				left: 0;
				top: 0;
				width: 100%;
				background: white !important;
			}

			.modal-header,
			.btn-print-action {
				display: none !important;
			}

			.invoice-preview {
				box-shadow: none;
				border: none;
				padding: 0;
			}
		}
	</style>
</head>

<body>
	<div class="bg-gradient"></div>
	<div class="bg-blob blob-1"></div>
	<div class="bg-blob blob-2"></div>

	<div id="loader" class="loader-overlay">
		<div class="spinner"></div>
		<p style="margin-top: 20px; font-weight: 700;">ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...</p>
	</div>

	<div class="container">
		<header>
			<div class="header-left">
				<h1>H·ªá Th·ªëng Qu·∫£n L√Ω To√†n Di·ªán</h1>
				<p>S·∫£n ph·∫©m, T·ªìn kho & ƒê∆°n h√†ng c·ªßa t√¥i</p>
			</div>
			<div class="header-right">
				<div class="user-chip">
					<div class="avatar" id="userAvatar">?</div>
					<span id="userName">Kh√°ch h√†ng</span>
				</div>
				<a href="index.html" class="btn btn-glass">
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
						stroke-linecap="round" stroke-linejoin="round">
						<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
						<polyline points="9 22 9 12 15 12 15 22"></polyline>
					</svg>
					Trang ch·ªß
				</a>
			</div>
		</header>

		<!-- Tab Navigation -->
		<div class="tab-container">
			<button class="tab-btn active" onclick="switchTab('products')">üì¶ S·∫¢N PH·∫®M</button>
			<button class="tab-btn" onclick="switchTab('inventory')">üìä T·ªíN KHO</button>
			<button class="tab-btn" onclick="switchTab('orders')">üìù ƒê∆†N H√ÄNG</button>
			<button class="tab-btn" onclick="switchTab('customers')">üë• KH√ÅCH H√ÄNG</button>
		</div>

		<!-- Tab: S·∫£n Ph·∫©m -->
		<div id="productsTab" class="tab-content active">
			<div class="actions-bar">
				<div class="search-box">
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
						stroke-linecap="round" stroke-linejoin="round">
						<circle cx="11" cy="11" r="8"></circle>
						<line x1="21" y1="21" x2="16.65" y2="16.65"></line>
					</svg>
					<input type="text" id="searchInput" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." oninput="filterProducts()">
				</div>
				<button class="btn btn-primary" onclick="openModal('create')">
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
						stroke-linecap="round" stroke-linejoin="round">
						<line x1="12" y1="5" x2="12" y2="19"></line>
						<line x1="5" y1="12" x2="19" y2="12"></line>
					</svg>
					TH√äM S·∫¢N PH·∫®M M·ªöI
				</button>
			</div>

			<div id="productGrid" class="product-grid">
				<!-- Products will be loaded here -->
				<div class="empty-state">
					<div class="spinner" style="margin: 0 auto;"></div>
					<p style="margin-top: 20px;">ƒêang t·∫£i s·∫£n ph·∫©m...</p>
				</div>
			</div>
		</div>

		<!-- Tab: T·ªìn Kho -->
		<div id="inventoryTab" class="tab-content">
			<div class="actions-bar">
				<h2 style="color: var(--primary); font-size: 1.5rem; margin: 0;">Qu·∫£n L√Ω T·ªìn Kho</h2>
				<button class="btn btn-primary" onclick="openInventoryModal()">
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
						stroke-linecap="round" stroke-linejoin="round">
						<line x1="12" y1="5" x2="12" y2="19"></line>
						<line x1="5" y1="12" x2="19" y2="12"></line>
					</svg>
					NH·∫¨P T·ªíN KHO
				</button>
			</div>

			<div class="table-wrapper">
				<table id="inventoryTable">
					<thead>
						<tr>
							<th>Ng√†y</th>
							<th>T√™n S·∫£n Ph·∫©m</th>
							<th>ID S·∫£n Ph·∫©m</th>
							<th>S·ªë L∆∞·ª£ng Nh·∫≠p</th>
							<th>S·ªë L∆∞·ª£ng Xu·∫•t</th>
							<th>C√≤n L·∫°i</th>
							<th>Ghi Ch√∫</th>
							<th>Thao T√°c</th>
						</tr>
					</thead>
					<tbody id="inventoryBody">
						<tr>
							<td colspan="8" style="text-align: center; padding: 40px;">
								<div class="spinner" style="margin: 0 auto;"></div>
								<p style="margin-top: 20px;">ƒêang t·∫£i d·ªØ li·ªáu t·ªìn kho...</p>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>

		<!-- Tab: ƒê∆°n H√†ng -->
		<div id="ordersTab" class="tab-content">
			<div class="actions-bar">
				<div class="search-box">
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
						stroke-linecap="round" stroke-linejoin="round">
						<circle cx="11" cy="11" r="8"></circle>
						<line x1="21" y1="21" x2="16.65" y2="16.65"></line>
					</svg>
					<input type="text" id="orderSearch" placeholder="T√¨m ki·∫øm ƒë∆°n h√†ng, kh√°ch h√†ng..."
						onkeyup="filterOrders()">
				</div>
				<button class="btn btn-primary" onclick="openChoiceModal()">
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
						stroke-linecap="round" stroke-linejoin="round">
						<line x1="12" y1="5" x2="12" y2="19"></line>
						<line x1="5" y1="12" x2="19" y2="12"></line>
					</svg>
					L√äN ƒê∆†N M·ªöI
				</button>
			</div>

			<div class="table-wrapper">
				<table id="ordersTable">
					<thead>
						<tr>
							<th>ID ƒê∆°n</th>
							<th>T√™n Kh√°ch H√†ng</th>
							<th>T·ªïng Ti·ªÅn</th>
							<th>Ng√†y T·∫°o</th>
							<th>Tr·∫°ng Th√°i</th>
							<th>Thao T√°c</th>
						</tr>
					</thead>
					<tbody id="ordersBody">
						<tr>
							<td colspan="5" style="text-align: center; padding: 40px;">
								Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>

		<!-- Tab: Kh√°ch H√†ng -->
		<div id="customersTab" class="tab-content">
			<div class="actions-bar">
				<div class="search-box">
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
						stroke-linecap="round" stroke-linejoin="round">
						<circle cx="11" cy="11" r="8"></circle>
						<line x1="21" y1="21" x2="16.65" y2="16.65"></line>
					</svg>
					<input type="text" id="customerSearch" placeholder="T√¨m t√™n kh√°ch, s·ªë ƒëi·ªán tho·∫°i..."
						onkeyup="filterCustomers()">
				</div>
				<button class="btn btn-primary" onclick="openCustomerModal('create')">
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
						stroke-linecap="round" stroke-linejoin="round">
						<line x1="12" y1="5" x2="12" y2="19"></line>
						<line x1="5" y1="12" x2="19" y2="12"></line>
					</svg>
					TH√äM KH√ÅCH H√ÄNG
				</button>
			</div>

			<div class="table-wrapper">
				<table>
					<thead>
						<tr>
							<th>M√£ KH</th>
							<th>T√™n Kh√°ch H√†ng</th>
							<th>S·ªë ƒêi·ªán Tho·∫°i</th>
							<th>Ghi Ch√∫</th>
							<th>Thao T√°c</th>
						</tr>
					</thead>
					<tbody id="customersBody">
						<tr>
							<td colspan="5" style="text-align: center; padding: 40px;">
								Ch∆∞a c√≥ kh√°ch h√†ng n√†o.
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<!-- Custom Confirm Modal -->
	<div id="confirmModal" class="modal">
		<div class="modal-content" style="max-width: 400px; text-align: center;">
			<div style="margin-bottom: 25px;">
				<div
					style="width: 70px; height: 70px; background: rgba(255, 61, 0, 0.1); color: var(--danger); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
					<svg width="35" height="35" viewBox="0 0 24 24" fill="none" stroke="currentColor"
						stroke-width="2.5">
						<path
							d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
						</path>
						<line x1="12" y1="9" x2="12" y2="13"></line>
						<line x1="12" y1="17" x2="12.01" y2="17"></line>
					</svg>
				</div>
				<h2 id="confirmTitle" style="font-size: 1.5rem; margin-bottom: 10px;">X√°c nh·∫≠n x√≥a</h2>
				<p id="confirmMessage" style="color: var(--text-gray); font-size: 0.95rem; line-height: 1.6;">B·∫°n c√≥
					ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
			</div>
			<div style="display: flex; gap: 15px;">
				<button class="btn btn-glass" style="flex: 1; justify-content: center;"
					onclick="closeConfirmModal()">H·ª¶Y</button>
				<button id="confirmExecuteBtn" class="btn btn-primary"
					style="flex: 1; justify-content: center; background: var(--danger); color: white;">X√ìA NGAY</button>
			</div>
		</div>
	</div>

	<!-- Product Modal -->
	<div id="productModal" class="modal">
		<div class="modal-content">
			<div class="close-modal" onclick="closeModal()">
				<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
					stroke-linecap="round" stroke-linejoin="round">
					<line x1="18" y1="6" x2="6" y2="18"></line>
					<line x1="6" y1="6" x2="18" y2="18"></line>
				</svg>
			</div>
			<div class="modal-header">
				<h2 id="modalTitle">Th√™m S·∫£n Ph·∫©m</h2>
				<p style="color: var(--text-gray);">ƒêi·ªÅn th√¥ng tin s·∫£n ph·∫©m c·ªßa b·∫°n v√†o b√™n d∆∞·ªõi</p>
			</div>
			<form id="productForm">
				<input type="hidden" id="editId">
				<div class="form-group">
					<label>H√¨nh ·∫£nh s·∫£n ph·∫©m</label>
					<div class="image-upload-wrapper" onclick="document.getElementById('fileInput').click()">
						<div class="upload-placeholder" id="uploadPlaceholder">
							<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
								stroke-linecap="round" stroke-linejoin="round">
								<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
								<circle cx="8.5" cy="8.5" r="1.5"></circle>
								<polyline points="21 15 16 10 5 21"></polyline>
							</svg>
							<p>Nh·∫•n ƒë·ªÉ t·∫£i h√¨nh l√™n</p>
							<span style="font-size: 0.7rem; opacity: 0.6;">JPG, PNG ho·∫∑c WebP</span>
						</div>
						<img id="imagePreview" class="image-preview" src="">
					</div>
					<input type="file" id="fileInput" accept="image/*" onchange="previewImage(event)">
				</div>

				<div class="form-group">
					<label>T√™n s·∫£n ph·∫©m</label>
					<input type="text" id="productName" class="form-input" placeholder="V√≠ d·ª•: T·∫•m ·ªëp Nano 400x9mm..."
						required>
				</div>

				<div class="form-grid">
					<div class="form-group">
						<label>Ng√†nh h√†ng</label>
						<input type="text" id="productCategory" class="form-input" list="categoryList"
							placeholder="Ch·ªçn ho·∫∑c nh·∫≠p m·ªõi..." required>
						<datalist id="categoryList">
							<option value="T·∫•m Pima">
							<option value="Duraflex">
							<option value="Weber">
							<option value="Ph·ª• Ki·ªán">
						</datalist>
					</div>
					<div class="form-group">
						<label>Gi√° b√°n (VNƒê)</label>
						<input type="text" id="productPrice" class="form-input" placeholder="0"
							oninput="formatPriceInput(this)" required>
					</div>
				</div>

				<div style="margin-top: 20px;">
					<button type="submit" class="btn btn-primary"
						style="width: 100%; justify-content: center; padding: 16px;">
						<span id="submitBtnText">L∆ØU S·∫¢N PH·∫®M</span>
					</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Inventory Modal -->
	<div id="inventoryModal" class="modal">
		<div class="modal-content">
			<div class="close-modal" onclick="closeInventoryModal()">
				<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
					stroke-linecap="round" stroke-linejoin="round">
					<line x1="18" y1="6" x2="6" y2="18"></line>
					<line x1="6" y1="6" x2="18" y2="18"></line>
				</svg>
			</div>
			<div class="modal-header">
				<h2>Nh·∫≠p T·ªìn Kho</h2>
				<p style="color: var(--text-gray);">ƒêi·ªÅn th√¥ng tin nh·∫≠p/xu·∫•t kho s·∫£n ph·∫©m</p>
			</div>
			<form id="inventoryForm">
				<div class="form-grid">
					<div class="form-group">
						<label>Ng√†y</label>
						<input type="date" id="invDate" class="form-input" required>
					</div>
					<div class="form-group">
						<label>S·∫£n ph·∫©m</label>
						<select id="invProduct" class="form-select" required onchange="updateProductInfo()">
							<option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
						</select>
					</div>
				</div>

				<div class="form-group">
					<label>ID S·∫£n Ph·∫©m</label>
					<input type="text" id="invProductId" class="form-input" readonly
						style="background: rgba(255,255,255,0.03);">
				</div>

				<div class="form-grid">
					<div class="form-group">
						<label>S·ªë l∆∞·ª£ng nh·∫≠p</label>
						<input type="number" id="invQuantityIn" class="form-input" placeholder="0" min="0"
							oninput="calculateRemaining()">
					</div>
					<div class="form-group">
						<label>S·ªë l∆∞·ª£ng xu·∫•t (t·ª± ƒë·ªông)</label>
						<input type="number" id="invQuantityOut" class="form-input" readonly
							style="background: rgba(255,255,255,0.03);" placeholder="0">
					</div>
				</div>

				<div class="form-group">
					<label>C√≤n l·∫°i</label>
					<input type="number" id="invRemaining" class="form-input" readonly
						style="background: rgba(255,255,255,0.03); color: var(--primary); font-weight: 700;"
						placeholder="0">
				</div>

				<div class="form-group">
					<label>Ghi ch√∫</label>
					<input type="text" id="invNote" class="form-input" placeholder="Ghi ch√∫ th√™m...">
				</div>

				<div style="margin-top: 20px;">
					<button type="submit" class="btn btn-primary"
						style="width: 100%; justify-content: center; padding: 16px;">
						L∆ØU TH√îNG TIN T·ªíN KHO
					</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Modal Ch·ªçn lo·∫°i kh√°ch -->
	<div id="choiceModal" class="modal">
		<div class="modal-content" style="max-width: 500px;">
			<div class="close-modal" onclick="closeChoiceModal()">
				<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
					stroke-linecap="round" stroke-linejoin="round">
					<line x1="18" y1="6" x2="6" y2="18"></line>
					<line x1="6" y1="6" x2="18" y2="18"></line>
				</svg>
			</div>
			<div class="modal-header">
				<h2 style="text-align: center; margin-bottom: 30px;">B·∫°n mu·ªën l√™n ƒë∆°n cho ai?</h2>
			</div>
			<div class="choice-grid">
				<div class="choice-card" onclick="startNewCustomerOrder()">
					<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
						<circle cx="8.5" cy="7" r="4"></circle>
						<line x1="20" y1="8" x2="20" y2="14"></line>
						<line x1="17" y1="11" x2="23" y2="11"></line>
					</svg>
					<h3>KH√ÅCH H√ÄNG M·ªöI</h3>
					<p style="font-size: 0.8rem; color: var(--text-gray); margin-top: 5px;">T·∫°o h·ªì s∆° v√† l√™n ƒë∆°n</p>
				</div>
				<div class="choice-card" onclick="startOldCustomerOrder()">
					<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
						<circle cx="8.5" cy="7" r="4"></circle>
						<polyline points="17 11 19 13 23 9"></polyline>
					</svg>
					<h3>KH√ÅCH H√ÄNG C≈®</h3>
					<p style="font-size: 0.8rem; color: var(--text-gray); margin-top: 5px;">Ch·ªçn kh√°ch t·ª´ danh s√°ch</p>
				</div>
			</div>
			<button class="btn btn-glass" style="width: 100%; margin-top: 25px; justify-content: center;"
				onclick="closeChoiceModal()">ƒê√≥ng</button>
		</div>
	</div>

	<!-- Modal Form Kh√°ch H√†ng -->
	<div id="customerModal" class="modal">
		<div class="modal-content" style="max-width: 500px;">
			<div class="close-modal" onclick="closeCustomerModal()">
				<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
					stroke-linecap="round" stroke-linejoin="round">
					<line x1="18" y1="6" x2="6" y2="18"></line>
					<line x1="6" y1="6" x2="18" y2="18"></line>
				</svg>
			</div>
			<div class="modal-header">
				<h2 id="customerModalTitle">Th√™m Kh√°ch H√†ng M·ªõi</h2>
			</div>
			<form id="customerForm">
				<input type="hidden" id="custId">
				<div class="form-group" style="margin-bottom: 20px;">
					<label>T√™n kh√°ch h√†ng *</label>
					<input type="text" id="custName" class="form-input" required placeholder="Nh·∫≠p t√™n kh√°ch h√†ng...">
				</div>
				<div class="form-group" style="margin-bottom: 20px;">
					<label>S·ªë ƒëi·ªán tho·∫°i</label>
					<input type="text" id="custPhone" class="form-input" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i...">
				</div>
				<div class="form-group" style="margin-bottom: 20px;">
					<label>Mail qu·∫£n l√Ω (T·ª± ƒë·ªông)</label>
					<input type="text" id="custEmail" class="form-input" readonly
						style="background: var(--dark-bg); color: var(--text-gray);">
				</div>
				<div class="form-group" style="margin-bottom: 25px;">
					<label>Ghi ch√∫</label>
					<textarea id="custNote" class="form-input" rows="3" placeholder="Ghi ch√∫ th√™m..."></textarea>
				</div>
				<button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">L∆ØU TH√îNG
					TIN</button>
			</form>
		</div>
	</div>

	<!-- Modal L√™n ƒê∆°n H√†ng -->
	<div id="orderModal" class="modal">
		<div class="modal-content" style="max-width: 1100px;">
			<div class="close-modal" onclick="closeOrderModal()">
				<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
					stroke-linecap="round" stroke-linejoin="round">
					<line x1="18" y1="6" x2="6" y2="18"></line>
					<line x1="6" y1="6" x2="18" y2="18"></line>
				</svg>
			</div>
			<div class="modal-header">
				<h2 id="orderModalTitle">L√™n ƒê∆°n H√†ng M·ªõi</h2>
			</div>
			<div class="form-grid"
				style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
				<div class="form-group">
					<label>Kh√°ch h√†ng *</label>
					<select id="orderCustSelect" class="form-select" required>
						<option value="">-- Ch·ªçn kh√°ch h√†ng --</option>
					</select>
				</div>
				<div class="form-group">
					<label>Tr·∫°ng th√°i ƒë∆°n h√†ng *</label>
					<select id="orderStatus" class="form-select" required>
						<option value="Nh√°p">üìù ƒê∆°n Nh√°p</option>
						<option value="Ch·ªët">‚úÖ ƒê∆°n Ch·ªët (S·∫Ω tr·ª´ t·ªìn kho)</option>
					</select>
				</div>
				<div class="form-group">
					<label>Ghi ch√∫ ƒë∆°n h√†ng</label>
					<input type="text" id="orderGlobalNote" class="form-input"
						placeholder="V√≠ d·ª•: Giao g·∫•p bu·ªïi chi·ªÅu...">
				</div>
				<div class="form-group">
					<label>D·ªãch v·ª• / Chi·∫øt kh·∫•u</label>
					<div style="display: flex; gap: 8px;">
						<select id="orderServiceType" class="form-select" style="flex: 1;"
							onchange="calculateOrderTotal()">
							<option value="v·∫≠n chuy·ªÉn">üöö V·∫≠n chuy·ªÉn (+)</option>
							<option value="chi·∫øt kh·∫•u">üè∑Ô∏è Chi·∫øt kh·∫•u (-)</option>
						</select>
						<input type="text" id="orderServiceFee" class="form-input" style="flex: 1.5;"
							placeholder="Nh·∫≠p s·ªë ti·ªÅn..." value="0"
							onkeyup="formatCurrencyInput(this); calculateOrderTotal();">
					</div>
				</div>
			</div>

			<div style="margin: 20px 0; display: flex; justify-content: space-between; align-items: center;">
				<h3 style="font-size: 1rem; color: var(--primary);">DANH S√ÅCH S·∫¢N PH·∫®M TRONG ƒê∆†N</h3>
				<div style="display:flex; gap:8px; align-items:center;">
					<button class="btn btn-glass" type="button" id="addRowButton" style="padding:6px 15px;">+ Th√™m
						d√≤ng</button>
				</div>
			</div>

			<div class="table-wrapper" style="border-radius: 12px; max-height: 400px; overflow-y: auto;">
				<table class="order-items-table">
					<thead>
						<tr>
							<th style="width: 150px;">Ng√†nh h√†ng</th>
							<th style="width: 250px;">S·∫£n ph·∫©m</th>
							<th style="width: 120px;">ƒê∆°n gi√°</th>
							<th style="width: 80px;">S.L∆∞·ª£ng</th>
							<th>Th√†nh ti·ªÅn</th>
							<th style="width: 40px;"></th>
						</tr>
					</thead>
					<tbody id="orderItemsBody"></tbody>
				</table>
			</div>

			<div class="total-section">
				<div class="total-row">
					<span>T·ªïng c·ªông ƒë∆°n h√†ng:</span>
					<span id="orderFinalTotal" class="total-val" style="color: var(--primary);">0 ƒë</span>
				</div>
			</div>

			<div style="margin-top: 30px; display: flex; justify-content: flex-end; gap: 15px;">
				<button class="btn btn-glass" onclick="closeOrderModal()">H·ª¶Y</button>
				<button class="btn btn-primary" onclick="saveOrder()">X√ÅC NH·∫¨N L∆ØU ƒê∆†N</button>
			</div>
		</div>
	</div>

	<!-- Modal Xem Chi Ti·∫øt ƒê∆°n H√†ng (Phi·∫øu ƒê∆°n) -->
	<div id="invoiceModal" class="modal">
		<div class="modal-content">
			<div class="close-modal" onclick="closeInvoiceModal()" style="top: 10px; right: 20px;">
				<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
					stroke-linecap="round" stroke-linejoin="round">
					<line x1="18" y1="6" x2="6" y2="18"></line>
					<line x1="6" y1="6" x2="18" y2="18"></line>
				</svg>
			</div>
			<div class="modal-header" style="padding: 20px 40px; background: var(--dark-card); margin-bottom: 0;">
				<h2 style="font-size: 1.2rem;">CHI TI·∫æT ƒê∆†N H√ÄNG</h2>
				<button class="btn btn-primary btn-print-action" onclick="window.print()"
					style="padding: 8px 15px; font-size: 0.85rem; margin-left: 20px;">üñ®Ô∏è IN PHI·∫æU</button>
			</div>

			<div class="invoice-preview" id="invoiceContent">
				<!-- Content dynamic -->
			</div>
		</div>
	</div>

	<script>
		// --- CONFIG ---
		const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzM8tzbdJJvXE0r6NcP8cJGO2RHsgYUR6Jy73U4NDLkSQRjT3fus_i4lugwVQZIKI8zhw/exec';
		const ORDER_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzM8tzbdJJvXE0r6NcP8cJGO2RHsgYUR6Jy73U4NDLkSQRjT3fus_i4lugwVQZIKI8zhw/exec';

		let currentProducts = [];
		let currentInventory = [];
		let currentCustomers = [];
		let currentOrders = [];
		let userData = null;
		let isUploading = false;
		let editOrderId = null;

		// --- HELPERS ---
		function updateLoader(msg) {
			const loader = document.getElementById('loader');
			if (loader) {
				loader.style.display = 'flex';
				const p = loader.querySelector('p');
				if (p) p.innerText = msg;
			}
		}

		function hideLoader() {
			const loader = document.getElementById('loader');
			if (loader) {
				// Th√™m m·ªôt ch√∫t delay ƒë·ªÉ UI ·ªïn ƒë·ªãnh, kh√¥ng b·ªã gi·∫≠t
				setTimeout(() => {
					loader.style.display = 'none';
				}, 500);
			}
		}

		// Robust helper to get value from object by key (ignore accents, spaces, case)
		function normalizeStr(str) {
			if (!str) return '';
			return str.toString()
				.replace(/ƒë/g, 'd')
				.replace(/ƒê/g, 'd')
				.normalize('NFD')
				.replace(/[\u0300-\u036f]/g, '')
				.replace(/[\s_]+/g, '')
				.toLowerCase();
		}

		function getVal(obj, searchKey) {
			if (!obj || !searchKey) return '';
			const normSearch = normalizeStr(searchKey);

			// Try direct match first
			if (obj[searchKey] !== undefined) return obj[searchKey];

			// Search through keys
			for (let k in obj) {
				const normK = normalizeStr(k);
				if (normK === normSearch) return obj[k];
			}
			return '';
		}

		document.addEventListener('DOMContentLoaded', () => {
			// Check Auth
			const userStr = localStorage.getItem('userLoggedIn');
			if (!userStr) {
				window.location.href = 'index.html';
				return;
			}
			userData = JSON.parse(userStr);

			document.getElementById('userName').innerText = userData.name;
			document.getElementById('userAvatar').innerText = userData.name.charAt(0).toUpperCase();

			loadAllData();
		});

		async function loadAllData() {
			updateLoader('ƒêang t·∫£i d·ªØ li·ªáu...');
			try {
				await Promise.all([
					loadProducts(), // This will populate currentProducts
					fetchCustomers(),
					fetchOrders()
				]);
				renderCustomers();
				renderDetailedOrders();
			} catch (err) {
				console.error("Load failed", err);
			} finally {
				hideLoader();
			}
		}

		async function fetchCustomers() {
			try {
				// 1. Fetch JSON data
				let jsonData = [];
				try {
					const jsonRes = await fetch('data/data_khach.json');
					if (jsonRes.ok) {
						const rawJson = await jsonRes.json();
						jsonData = rawJson.filter(item => {
							const email = getVal(item, 'mail ƒëƒÉng nh·∫≠p') || getVal(item, 'ng∆∞·ªùi t·∫°o');
							return email && email.toLowerCase() === userData.email.toLowerCase();
						});
					}
				} catch (e) { console.warn("Kh√¥ng t√¨m th·∫•y file JSON kh√°ch h√†ng", e); }

				// 2. Fetch Sheet data
				let sheetData = [];
				try {
					const url = `${ORDER_SCRIPT_URL}?action=read_customers&email=${encodeURIComponent(userData.email)}`;
					const res = await fetch(url);
					const json = await res.json();
					if (json.success) {
						sheetData = json.data;
					} else {
						console.error("Fetch customers error:", json.message);
					}
				} catch (e) { console.error("Fetch customers from sheet failed", e); }

				// 3. Merge data
				const merged = [];
				const processedIds = new Set();

				// Preference to Sheet data
				sheetData.forEach(s => {
					const id = getVal(s, 'id kh√°ch h√†ng');
					if (id) {
						merged.push(s);
						processedIds.add(id);
					}
				});

				jsonData.forEach(j => {
					const id = getVal(j, 'id kh√°ch h√†ng');
					if (id && !processedIds.has(id)) {
						merged.push(j);
					}
				});

				currentCustomers = merged;
				console.log("Total customers merged:", currentCustomers.length);
			} catch (e) { console.error("Fetch customers failed", e); }
		}

		async function fetchOrders() {
			try {
				// 1. Fetch JSON data
				let jsonData = [];
				try {
					const jsonRes = await fetch('data/data_don_hang.json');
					if (jsonRes.ok) {
						const rawJson = await jsonRes.json();
						jsonData = rawJson.filter(item => {
							const email = getVal(item, 'mail ƒëƒÉng nh·∫≠p') || getVal(item, 'ng∆∞·ªùi t·∫°o');
							return email && email.toLowerCase() === userData.email.toLowerCase();
						});
					}
				} catch (e) { console.warn("Kh√¥ng t√¨m th·∫•y file JSON ƒë∆°n h√†ng", e); }

				// 2. Fetch Sheet data
				let sheetData = [];
				try {
					const url = `${ORDER_SCRIPT_URL}?action=read_orders&email=${encodeURIComponent(userData.email)}`;
					const res = await fetch(url);
					const json = await res.json();
					if (json.success) {
						sheetData = json.data;
					} else {
						console.error("Fetch orders error:", json.message);
					}
				} catch (e) { console.error("Fetch orders from sheet failed", e); }

				// 3. Merge data (Orders are more complex because they are multi-row)
				// We filter out deleted items if status exists
				const merged = [];
				const sheetOrderIds = new Set(sheetData.map(s => getVal(s, 'id ƒë∆°n h√†ng')).filter(Boolean));

				// Preference to Sheet data
				sheetData.forEach(s => merged.push(s));

				// Add JSON orders only if they don't exist in Sheet
				jsonData.forEach(j => {
					const id = getVal(j, 'id ƒë∆°n h√†ng');
					if (id && !sheetOrderIds.has(id)) {
						merged.push(j);
					}
				});

				currentOrders = merged;
				console.log("Total orders merged:", currentOrders.length);
			} catch (e) { console.error("Fetch orders failed", e); }
		}

		function renderCustomers() {
			const body = document.getElementById('customersBody');
			if (!currentCustomers.length) {
				body.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">Ch∆∞a c√≥ kh√°ch h√†ng n√†o.</td></tr>';
				return;
			}
			body.innerHTML = currentCustomers.map(c => `
				<tr>
					<td style="font-weight:700; color:var(--primary);">${getVal(c, 'id kh√°ch h√†ng')}</td>
					<td style="font-weight:600;">${getVal(c, 't√™n kh√°ch h√†ng')}</td>
					<td>${getVal(c, 'phone')}</td>
					<td style="font-size:0.85rem; color:var(--text-gray);">${getVal(c, 'ghi ch√∫') || '-'}</td>
					<td style="text-align:right;">
						<div style="display:flex; gap:8px; justify-content:flex-end;">
							<button class="btn btn-glass" onclick="openOrderModal('create', '${getVal(c, 'id kh√°ch h√†ng')}')" title="L√™n ƒë∆°n cho kh√°ch n√†y">
								<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
							</button>
							<button class="btn btn-glass" onclick="openCustomerModal('edit', '${getVal(c, 'id kh√°ch h√†ng')}')" title="S·ª≠a">
								<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
							</button>
						</div>
					</td>
				</tr>
			`).join('');
			updateOrderSelect();
		}

		function updateOrderSelect() {
			const select = document.getElementById('orderCustSelect');
			if (select) {
				select.innerHTML = '<option value="">-- Ch·ªçn kh√°ch h√†ng --</option>' +
					currentCustomers.map(c => `<option value="${getVal(c, 'id kh√°ch h√†ng')}">${getVal(c, 't√™n kh√°ch h√†ng')} (${getVal(c, 'id kh√°ch h√†ng')})</option>`).join('');
			}
		}

		function renderDetailedOrders() {
			const body = document.getElementById('ordersBody');
			if (!currentOrders.length) {
				body.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</td></tr>';
				return;
			}
			const ordersMap = {};
			currentOrders.forEach(row => {
				const id = getVal(row, 'id ƒë∆°n h√†ng') || 'N/A';
				if (!ordersMap[id]) {
					let totalVal = getVal(row, 't·ªïng ti·ªÅn trong ƒë∆°n') || 0;
					if (typeof totalVal === 'string') totalVal = parseFloat(totalVal.replace(/\./g, '')) || 0;

					ordersMap[id] = {
						id: id,
						customer: getVal(row, 't√™n kh√°ch h√†ng') || '·∫®n danh',
						total: totalVal,
						date: getVal(row, 'ng√†y t·∫°o') || '-',
						status: getVal(row, 'tr·∫°ng th√°i ƒë∆°n h√†ng') || 'Ch·ªët',
						rows: []
					};
				}
				ordersMap[id].rows.push(row);
			});

			const orderList = Object.values(ordersMap).sort((a, b) => {
				const parseDate = (dStr) => {
					if (!dStr || dStr === '-') return 0;
					try {
						// Handle "HH:mm:ss dd/MM/yyyy" or "dd/MM/yyyy HH:mm:ss"
						const parts = dStr.trim().split(' ');
						if (parts.length < 2) return 0;
						let datePart, timePart;
						if (parts[0].includes('/')) { datePart = parts[0]; timePart = parts[1]; }
						else { datePart = parts[1]; timePart = parts[0]; }

						const d = datePart.split('/');
						const t = timePart.split(':');
						return new Date(d[2], d[1] - 1, d[0], t[0], t[1], t[2]).getTime();
					} catch (e) { return 0; }
				};
				return parseDate(b.date) - parseDate(a.date);
			});

			body.innerHTML = orderList.map(o => {
				const isConfirmed = String(o.status).includes('Ch·ªët');
				const statusStyle = isConfirmed ? 'background: rgba(46, 125, 50, 0.1); color: #2e7d32;' : 'background: rgba(237, 108, 2, 0.1); color: #ed6c02;';

				return `
				<tr>
					<td style="font-weight:700; color:var(--primary);">${o.id}</td>
					<td style="font-weight:600;">${o.customer}</td>
					<td style="color:var(--primary); font-weight:700;">${formatCurrency(o.total)}</td>
					<td style="font-size:0.85rem; color:var(--text-gray);">${o.date || '-'}</td>
					<td>
						<span style="padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; ${statusStyle}">
							${o.status.toUpperCase()}
						</span>
					</td>
					<td>
						<div style="display:flex; gap:10px;">
							<button class="btn btn-glass" style="padding:5px 10px; color:var(--primary);" onclick="viewInvoice('${o.id}')">Xem</button>
							<button class="btn btn-glass" style="padding:5px 10px;" onclick="openOrderModal('edit', '${o.id}')">S·ª≠a</button>
							<button class="btn btn-glass" style="padding:5px 10px; color:var(--danger);" onclick="deleteOrder('${o.id}')">X√≥a</button>
						</div>
					</td>
				</tr>
			`}).join('');
		}

		function openChoiceModal() { document.getElementById('choiceModal').classList.add('active'); }
		function closeChoiceModal() { document.getElementById('choiceModal').classList.remove('active'); }

		function startNewCustomerOrder() {
			closeChoiceModal();
			window.pendingOrderFlow = true;
			openCustomerModal('create');
		}

		function startOldCustomerOrder() {
			closeChoiceModal();
			openOrderModal('create');
		}

		function openCustomerModal(mode, id = null) {
			const modal = document.getElementById('customerModal');
			document.getElementById('customerForm').reset();
			if (mode === 'create') {
				document.getElementById('customerModalTitle').innerText = 'Th√™m Kh√°ch H√†ng M·ªõi';
				document.getElementById('custId').value = '';
				document.getElementById('custEmail').value = userData.email;
			} else {
				const c = currentCustomers.find(item => getVal(item, 'id kh√°ch h√†ng') === id);
				if (c) {
					document.getElementById('customerModalTitle').innerText = 'Ch·ªânh S·ª≠a Kh√°ch H√†ng';
					document.getElementById('custId').value = getVal(c, 'id kh√°ch h√†ng');
					document.getElementById('custName').value = getVal(c, 't√™n kh√°ch h√†ng');
					document.getElementById('custPhone').value = getVal(c, 'phone');
					document.getElementById('custEmail').value = getVal(c, 'mail ƒëƒÉng nh·∫≠p') || userData.email;
					document.getElementById('custNote').value = getVal(c, 'ghi ch√∫');
				}
			}
			modal.classList.add('active');
			document.body.style.overflow = 'hidden';
		}

		function closeCustomerModal() {
			document.getElementById('customerModal').classList.remove('active');
			document.body.style.overflow = '';
		}

		document.getElementById('customerForm').onsubmit = async (e) => {
			e.preventDefault();
			const id = document.getElementById('custId').value;
			const data = {
				't√™n kh√°ch h√†ng': document.getElementById('custName').value,
				'phone': document.getElementById('custPhone').value,
				'ghi ch√∫': document.getElementById('custNote').value,
				'mail ƒëƒÉng nh·∫≠p': userData.email,
				'tr·∫°ng th√°i x√≥a': 'ACTIVE'
			};
			if (id) data['id kh√°ch h√†ng'] = id;

			document.getElementById('loader').style.display = 'flex';
			try {
				const res = await fetch(ORDER_SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({ action: 'upsert_customer', data })
				});
				const json = await res.json();
				if (json.success) {
					await fetchCustomers();
					renderCustomers();
					closeCustomerModal();
					if (window.pendingOrderFlow) {
						window.pendingOrderFlow = false;
						openOrderModal('create', json.id);
					}
				}
			} catch (e) {
				console.error("Save customer detailed error:", e);
				alert("L·ªói khi l∆∞u kh√°ch h√†ng: " + e.message);
			}
			finally { document.getElementById('loader').style.display = 'none'; }
		};

		async function deleteCustomer(id) {
			if (!confirm("X√≥a kh√°ch h√†ng n√†y?")) return;
			document.getElementById('loader').style.display = 'flex';
			try {
				const res = await fetch(ORDER_SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({ action: 'delete_customer', id })
				});
				if ((await res.json()).success) {
					await fetchCustomers();
					renderCustomers();
				}
			} finally { document.getElementById('loader').style.display = 'none'; }
		}

		function openOrderModal(mode, id = null) {
			const modal = document.getElementById('orderModal');
			editOrderId = (mode === 'edit') ? id : null;
			document.getElementById('orderModalTitle').innerText = (mode === 'edit') ? 'Ch·ªânh S·ª≠a ƒê∆°n H√†ng' : 'L√™n ƒê∆°n H√†ng M·ªõi';
			document.getElementById('orderItemsBody').innerHTML = '';
			document.getElementById('orderGlobalNote').value = '';
			document.getElementById('orderServiceFee').value = '0';
			document.getElementById('orderServiceType').value = 'v·∫≠n chuy·ªÉn';
			document.getElementById('orderStatus').value = 'Ch·ªët';

			updateOrderSelect();

			if (mode === 'edit') {
				const rows = currentOrders.filter(r => getVal(r, 'id ƒë∆°n h√†ng') === id);
				if (rows.length > 0) {
					const first = rows[0];
					document.getElementById('orderCustSelect').value = getVal(first, 'id kh√°ch h√†ng');
					document.getElementById('orderGlobalNote').value = getVal(first, 'ghi ch√∫');
					document.getElementById('orderStatus').value = getVal(first, 'tr·∫°ng th√°i ƒë∆°n h√†ng') || 'Ch·ªët';

					const fee = parseFloat(getVal(first, 'd·ªãch v·ª• th√™m trong ƒë∆°n')) || 0;
					if (fee < 0) {
						document.getElementById('orderServiceType').value = 'chi·∫øt kh·∫•u';
						document.getElementById('orderServiceFee').value = formatCurrencyNoSymbol(Math.abs(fee));
					} else {
						document.getElementById('orderServiceType').value = 'v·∫≠n chuy·ªÉn';
						document.getElementById('orderServiceFee').value = formatCurrencyNoSymbol(fee);
					}

					rows.forEach(r => addOrderRow(r));
				}
			} else if (id) {
				// Pre-select customer if id provided
				document.getElementById('orderCustSelect').value = id;
				addOrderRow();
			} else {
				addOrderRow();
			}
			modal.classList.add('active');
			calculateOrderTotal();
		}

		function closeOrderModal() { document.getElementById('orderModal').classList.remove('active'); }

		function addOrderRow(data = null) {
			const tbody = document.getElementById('orderItemsBody');
			const tr = document.createElement('tr');

			const categories = [...new Set(currentProducts.map(p => p.ten_nganh_hang || p['t√™n ng√†nh h√†ng'] || 'Kh√°c'))].filter(Boolean);
			const categoryOptions = categories.map(cat =>
				`<option value="${cat}" ${data && (data.tennganhhang || data.t√™nng√†nhh√†ng) === cat ? 'selected' : ''}>${cat}</option>`
			).join('');

			tr.innerHTML = `
				<td>
					<select class="form-select row-category" onchange="updateProductList(this)" required>
						<option value="">-- Ch·ªçn ng√†nh --</option>
						${categoryOptions}
					</select>
				</td>
				<td>
					<select class="form-select row-product" onchange="updateRowInfo(this)" required>
						<option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
					</select>
				</td>
				<td><input type="text" class="form-input row-price" value="${data ? formatCurrencyNoSymbol(data.giasanpham || data.gi√°s·∫£nph·∫©m || data.ƒë∆°ngi√°) : '0'}" onkeyup="formatCurrencyInput(this); calculateOrderTotal();"></td>
				<td><input type="number" class="form-input row-qty" value="${data ? (data.soluong || data.s·ªël∆∞·ª£ng) : '1'}" min="1" oninput="calculateOrderTotal()"></td>
				<td class="row-total" style="font-weight: 700; color: var(--primary);">0 ƒë</td>
				<td>
					<button class="btn btn-glass" onclick="this.parentElement.parentElement.remove(); calculateOrderTotal();" style="color: var(--danger); padding: 5px;">
						<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
					</button>
				</td>
			`;
			tbody.appendChild(tr);

			if (data) {
				updateProductList(tr.querySelector('.row-category'), data.idsanpham || data.ids·∫£nph·∫©m);
			} else {
				if (categories.length === 1) {
					tr.querySelector('.row-category').value = categories[0];
					updateProductList(tr.querySelector('.row-category'));
				}
			}
			calculateOrderTotal();
		}

		function updateProductList(catSelect, selectedProdId = null) {
			const tr = catSelect.parentElement.parentElement;
			const category = catSelect.value;
			const prodSelect = tr.querySelector('.row-product');
			const filteredProducts = currentProducts.filter(p => (p.ten_nganh_hang || p['t√™n ng√†nh h√†ng'] || 'Kh√°c') === category);

			prodSelect.innerHTML = '<option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>' +
				filteredProducts.map(p => `<option value="${p.id_san_pham}" ${selectedProdId === p.id_san_pham ? 'selected' : ''}>${p.ten_san_pham}</option>`).join('');

			if (!selectedProdId) updateRowInfo(prodSelect);
		}

		function updateRowInfo(select) {
			const tr = select.parentElement.parentElement;
			const productId = select.value;
			const product = currentProducts.find(p => p.id_san_pham === productId);
			if (product) {
				tr.querySelector('.row-price').value = formatCurrencyNoSymbol(product.gia_san_pham);
			}
			calculateOrderTotal();
		}

		function calculateOrderTotal() {
			let subtotal = 0;
			document.querySelectorAll('#orderItemsBody tr').forEach(tr => {
				const priceRaw = tr.querySelector('.row-price').value.replace(/\./g, '');
				const price = parseFloat(priceRaw) || 0;
				const qty = parseFloat(tr.querySelector('.row-qty').value) || 0;
				const total = price * qty;
				tr.querySelector('.row-total').innerText = formatCurrency(total);
				subtotal += total;
			});

			const serviceFeeRaw = document.getElementById('orderServiceFee').value.replace(/\./g, '');
			const serviceFee = parseFloat(serviceFeeRaw) || 0;
			const serviceType = document.getElementById('orderServiceType').value;

			let grandTotal = subtotal;
			if (serviceType === 'chi·∫øt kh·∫•u') {
				grandTotal -= serviceFee;
			} else {
				grandTotal += serviceFee;
			}

			document.getElementById('orderFinalTotal').innerText = formatCurrency(grandTotal);
		}

		document.getElementById('addRowButton').onclick = () => addOrderRow();

		async function saveOrder() {
			const custId = document.getElementById('orderCustSelect').value;
			if (!custId) { alert("Vui l√≤ng ch·ªçn kh√°ch h√†ng"); return; }

			const customerObj = currentCustomers.find(c => (c.idkhachhang || c.idkh√°chh√†ng) === custId);
			const customerName = document.getElementById('orderCustSelect').selectedOptions[0].text.split(' (')[0];

			const serviceType = document.getElementById('orderServiceType').value;
			const serviceFeeRaw = document.getElementById('orderServiceFee').value.replace(/\./g, '');
			let serviceFee = parseFloat(serviceFeeRaw) || 0;
			if (serviceType === 'chi·∫øt kh·∫•u') serviceFee = -serviceFee;

			const status = document.getElementById('orderStatus').value;
			const finalTotalText = document.getElementById('orderFinalTotal').innerText.replace(/[^\d]/g, '');
			const finalTotal = parseFloat(finalTotalText) || 0;

			const items = [];
			let hasError = false;
			document.querySelectorAll('#orderItemsBody tr').forEach(tr => {
				const prodId = tr.querySelector('.row-product').value;
				if (!prodId) hasError = true;
				const product = currentProducts.find(p => p.id_san_pham === prodId);
				const priceText = tr.querySelector('.row-price').value.replace(/\./g, '');
				const qty = parseFloat(tr.querySelector('.row-qty').value) || 0;

				items.push({
					'ph√¢n lo·∫°i kh√°ch h√†ng': customerObj ? (customerObj.phanloaikhachhang || customerObj.phanloaikhahhang || 'Kh√°ch m·ªõi') : 'Kh√°ch m·ªõi',
					't√™n kh√°ch h√†ng': customerName,
					'id kh√°ch h√†ng': custId,
					't√™n ng√†nh h√†ng': product && (product.ten_nganh_hang || product['t√™n ng√†nh h√†ng']) ? (product.ten_nganh_hang || product['t√™n ng√†nh h√†ng']) : 'T·ªïng h·ª£p',
					't√™n s·∫£n ph·∫©m': product ? product.ten_san_pham : 'S·∫£n ph·∫©m kh√¥ng t√™n',
					'id s·∫£n ph·∫©m': prodId,
					'gi√° s·∫£n ph·∫©m': parseFloat(priceText) || 0,
					's·ªë l∆∞·ª£ng': qty,
					'th√†nh ti·ªÅn': (parseFloat(priceText) || 0) * qty,
					't·ªïng ti·ªÅn h√†ng': 0, // Will fill below
					'd·ªãch v·ª• th√™m trong ƒë∆°n': serviceFee,
					't·ªïng ti·ªÅn trong ƒë∆°n': finalTotal,
					'ghi ch√∫': document.getElementById('orderGlobalNote').value,
					'mail ƒëƒÉng nh·∫≠p': userData.email,
					'tr·∫°ng th√°i x√≥a': 'ACTIVE',
					'ng√†y t·∫°o': new Date().toLocaleString('vi-VN'),
					'tr·∫°ng th√°i ƒë∆°n h√†ng': status
				});
			});

			// Calculate total item sum for 't·ªïng ti·ªÅn h√†ng'
			const totalItemSum = items.reduce((sum, item) => sum + item['th√†nh ti·ªÅn'], 0);
			items.forEach(item => item['t·ªïng ti·ªÅn h√†ng'] = totalItemSum);

			if (hasError || items.length === 0) { alert("Vui l√≤ng ch·ªçn s·∫£n ph·∫©m cho t·∫•t c·∫£ c√°c d√≤ng"); return; }

			if (!confirm(`X√°c nh·∫≠n l∆∞u ƒë∆°n h√†ng? \nT·ªïng c·ªông: ${formatCurrency(finalTotal)}`)) return;

			document.getElementById('loader').style.display = 'flex';
			try {
				const action = editOrderId ? 'update_order' : 'create_order';
				const payload = {
					action,
					data: items,
					id: editOrderId
				};

				const res = await fetch(ORDER_SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify(payload)
				});
				const result = await res.json();
				if (result.success) {
					// N·∫øu Ch·ªët ƒë∆°n, t·∫°o b·∫£n ghi t·ªìn kho t∆∞∆°ng ·ª©ng cho t·ª´ng s·∫£n ph·∫©m
					if (status === 'Ch·ªët') {
						updateLoader('ƒêang ƒë·ªìng b·ªô t·ªìn kho...');
						for (const item of items) {
							const invPayload = {
								action: 'createInventory',
								data: {
									date: new Date().toISOString().split('T')[0],
									't√™n s·∫£n ph·∫©m': item['t√™n s·∫£n ph·∫©m'],
									'id s·∫£n ph·∫©m': item['id s·∫£n ph·∫©m'],
									's·ªë l∆∞·ª£ng': item['s·ªë l∆∞·ª£ng'],
									'tr·∫°ng th√°i': 'xu·∫•t',
									'ten_dang_nhap': userData.email,
									'ghi ch√∫': 'Xu·∫•t t·ª´ ƒë∆°n h√†ng ' + (result.orderId || editOrderId)
								}
							};
							const fd = new URLSearchParams();
							fd.append('payload', JSON.stringify(invPayload));
							await fetch(SCRIPT_URL, { method: 'POST', body: fd });
						}
					}

					alert("L∆∞u ƒë∆°n h√†ng th√†nh c√¥ng!");
					await fetchOrders();
					renderDetailedOrders();
					closeOrderModal();
				} else {
					alert("L·ªói: " + result.message);
				}
			} catch (e) {
				console.error(e);
				alert("L·ªói khi k·∫øt n·ªëi server");
			}
			finally { document.getElementById('loader').style.display = 'none'; }
		}

		async function deleteOrder(id) {
			if (!confirm("X√≥a ƒë∆°n h√†ng n√†y?")) return;
			document.getElementById('loader').style.display = 'flex';
			try {
				const res = await fetch(ORDER_SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({ action: 'delete_order', id })
				});
				if ((await res.json()).success) {
					await fetchOrders();
					renderDetailedOrders();
				}
			} finally { document.getElementById('loader').style.display = 'none'; }
		}

		function viewInvoice(id) {
			const orderRows = currentOrders.filter(r => (getVal(r, 'id ƒë∆°n h√†ng') || getVal(r, 'm√£ ƒë∆°n')) === id);
			if (orderRows.length === 0) return;

			const first = orderRows[0];
			let totalMoney = 0;
			const rowsHtml = orderRows.map((r, index) => {
				const price = parseFloat(getVal(r, 'gi√° s·∫£n ph·∫©m')) || 0;
				const qty = parseFloat(getVal(r, 's·ªë l∆∞·ª£ng')) || 0;
				const sub = parseFloat(getVal(r, 'th√†nh ti·ªÅn')) || (price * qty);
				totalMoney += sub;
				return `
					<tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
						<td style="padding:12px; text-align:center; color:#888;">${index + 1}</td>
						<td style="padding:12px; text-align:left;">${getVal(r, 't√™n s·∫£n ph·∫©m')}</td>
						<td style="padding:12px; text-align:right;">${formatCurrency(price)}</td>
						<td style="padding:12px; text-align:center;">${qty}</td>
						<td style="padding:12px; text-align:right; font-weight:700;">${formatCurrency(sub)}</td>
					</tr>
				`;
			}).join('');

			const extraFee = parseFloat(getVal(first, 'd·ªãch v·ª• th√™m trong ƒë∆°n')) || 0;
			const finalTotal = parseFloat(getVal(first, 't·ªïng ti·ªÅn trong ƒë∆°n')) || (totalMoney + extraFee);
			const dateStr = getVal(first, 'ng√†y t·∫°o') || new Date().toLocaleDateString('vi-VN');

			const html = `
				<div class="invoice-header" style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:25px;">
					<div>
						<h1 class="invoice-title" style="margin:0; font-size:1.8rem;">PHI·∫æU ƒê∆†N H√ÄNG</h1>
						<p style="color:var(--text-gray); margin-top:5px;">M√£ ƒë∆°n: <span style="color:var(--primary); font-weight:700;">${id}</span></p>
					</div>
					<div style="text-align:right;">
						<p style="font-weight:700; font-size:1.1rem; margin:0;">${userData.name}</p>
						<p style="font-size:0.85rem; color:var(--text-gray); margin-top:3px;">${dateStr}</p>
					</div>
				</div>
                
				<div class="invoice-info-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:25px; padding:15px; background:rgba(255,255,255,0.03); border-radius:12px;">
					<div class="info-item">
						<label style="display:block; font-size:0.75rem; color:#888; text-transform:uppercase; margin-bottom:5px;">KH√ÅCH H√ÄNG</label>
						<p style="font-size:1.1rem; color:var(--highlight); font-weight:600; margin:0;">${getVal(first, 't√™n kh√°ch h√†ng')}</p>
						<p style="font-size:0.85rem; color:var(--text-gray); margin-top:3px;">M√£ KH: ${getVal(first, 'id kh√°ch h√†ng')}</p>
					</div>
					<div class="info-item" style="text-align:right;">
						<label style="display:block; font-size:0.75rem; color:#888; text-transform:uppercase; margin-bottom:5px;">GHI CH√ö</label>
						<p style="font-style:italic; margin:0;">${getVal(first, 'ghi ch√∫') || 'Kh√¥ng c√≥ ghi ch√∫'}</p>
					</div>
				</div>

				<div class="invoice-table-wrapper">
					<table class="invoice-table">
						<thead>
							<tr>
								<th style="width:50px; text-align:center;">STT</th>
								<th style="text-align:left;">S·∫¢N PH·∫®M</th>
								<th style="width:120px; text-align:right;">ƒê∆†N GI√Å</th>
								<th style="width:80px; text-align:center;">SL</th>
								<th style="width:140px; text-align:right;">TH√ÄNH TI·ªÄN</th>
							</tr>
						</thead>
						<tbody>${rowsHtml}</tbody>
					</table>
				</div>

				<div class="invoice-summary">
					<div class="summary-row">
						<span class="summary-label">T·∫°m t√≠nh h√†ng h√≥a:</span>
						<span class="summary-value">${formatCurrency(totalMoney)}</span>
					</div>
					<div class="summary-row">
						<span class="summary-label">V·∫≠n chuy·ªÉn / Ph√≠ kh√°c (+):</span>
						<span class="summary-value">${formatCurrency(extraFee)}</span>
					</div>
					<div class="summary-row grand-total">
						<span class="summary-label-total">T·ªîNG C·ªòNG:</span>
						<span class="summary-value-total">${formatCurrency(finalTotal)}</span>
					</div>
				</div>

                <div class="invoice-signatures" style="display:flex; justify-content:space-between; margin-top:60px; text-align:center;">
                    <div style="width:45%;">
                        <p style="font-weight:700; text-transform:uppercase; margin-bottom:5px;">Ng∆∞·ªùi mua h√†ng</p>
                        <p style="font-size:0.8rem; color:#888; font-style:italic; margin-bottom:60px;">(K√Ω, ghi r√µ h·ªç t√™n)</p>
                        <div style="border-bottom:1px dashed #555; width:70%; margin:0 auto;"></div>
                    </div>
                    <div style="width:45%;">
                        <p style="font-weight:700; text-transform:uppercase; margin-bottom:5px;">Ng∆∞·ªùi l√™n ƒë∆°n</p>
                        <p style="font-size:0.8rem; color:#888; font-style:italic; margin-bottom:10px;">(K√Ω, ghi r√µ h·ªç t√™n)</p>
                        <div style="height:50px; display:flex; align-items:center; justify-content:center; margin-bottom:5px;">
                            <span style="font-family:'Dancing Script', cursive, 'Brush Script MT'; font-size:1.8rem; color:#0033cc; transform:rotate(-5deg); opacity:0.8;">${userData.name}</span>
                        </div>
                        <div style="border-bottom:1px dashed #555; width:70%; margin:0 auto;"></div>
                    </div>
                </div>
			`;
			document.getElementById('invoiceContent').innerHTML = html;
			document.getElementById('invoiceModal').classList.add('active');
		}

		function closeInvoiceModal() { document.getElementById('invoiceModal').classList.remove('active'); }

		function formatCurrencyNoSign(val) {
			if (!val) return '0';
			return parseFloat(val).toLocaleString('vi-VN');
		}

		function formatCurrencyInput(input) {
			let value = input.value.replace(/\./g, '');
			if (!isNaN(value) && value !== "") {
				input.value = parseFloat(value).toLocaleString('vi-VN');
			}
		}

		function filterOrders() {
			const query = document.getElementById('orderSearch').value.toLowerCase();
			const filtered = currentOrders.filter(o => {
				const id = getVal(o, 'id ƒë∆°n h√†ng').toLowerCase();
				const cust = getVal(o, 't√™n kh√°ch h√†ng').toLowerCase();
				return id.includes(query) || cust.includes(query);
			});
			const original = currentOrders;
			currentOrders = filtered;
			renderDetailedOrders();
			currentOrders = original;
		}

		function filterCustomers() {
			const query = document.getElementById('customerSearch').value.toLowerCase();
			const filtered = currentCustomers.filter(c => {
				const name = getVal(c, 't√™n kh√°ch h√†ng').toLowerCase();
				const phone = (getVal(c, 'phone') || '').toLowerCase();
				return name.includes(query) || phone.includes(query);
			});
			const original = currentCustomers;
			currentCustomers = filtered;
			renderCustomers();
			currentCustomers = original;
		}

		async function loadProducts() {
			const grid = document.getElementById('productGrid');
			try {
				// In real use, we need the SCRIPT_URL to be set correctly.
				// For demonstration, if SCRIPT_URL is placeholder, we show empty
				if (SCRIPT_URL.includes('AKfycbxoK')) {
					console.warn("Vui l√≤ng c·∫≠p nh·∫≠t SCRIPT_URL trong file san-pham-khach.html");
					grid.innerHTML = `
                        <div class="empty-state">
                            <h2>Ch∆∞a c·∫•u h√¨nh Script k·∫øt n·ªëi Sheet</h2>
                            <p style="margin-top:10px;">Vui l√≤ng tri·ªÉn khai m√£ GAS v√† d√°n URL v√†o file HTML.</p>
                        </div>
                    `;
					return;
				}

				// 1. Fetch JSON data
				let jsonData = [];
				try {
					const jsonRes = await fetch('data/data_san_pham_kh.json');
					if (jsonRes.ok) {
						const rawJson = await jsonRes.json();
						jsonData = rawJson.map(item => {
							const newItem = {};
							Object.keys(item).forEach(key => {
								const normKey = key.toLowerCase().replace(/[^a-z0-9]/g, '');
								if (normKey === 'idsanpham') newItem.id_san_pham = item[key];
								else if (normKey === 'tennghanhhang' || normKey === 'tennganhhang' || normKey === 'nganhhang') newItem.ten_nganh_hang = item[key];
								else if (normKey === 'tensanpham') newItem.ten_san_pham = item[key];
								else if (normKey === 'giasanpham') newItem.gia_san_pham = item[key];
								else if (normKey === 'imagesanpham') newItem.image_san_pham = item[key];
								else if (normKey === 'tendangnhap') newItem.ten_dang_nhap = item[key];
								else newItem[key] = item[key];
							});
							return newItem;
						}).filter(item => item.ten_dang_nhap === userData.email);
					}
				} catch (e) { console.warn("Kh√¥ng t√¨m th·∫•y file JSON ho·∫∑c l·ªói ƒë·ªçc file", e); }

				// 2. Fetch Sheet data
				const response = await fetch(`${SCRIPT_URL}?action=read&username=${encodeURIComponent(userData.email)}`);
				const result = await response.json();

				if (result.success) {
					const sheetData = result.data.map(item => {
						const newItem = {};
						Object.keys(item).forEach(key => {
							const normKey = key.toLowerCase().replace(/[^a-z0-9]/g, '');
							if (normKey === 'idsanpham') newItem.id_san_pham = item[key];
							else if (normKey === 'tennganhhang' || normKey === 'tennghanhhang' || normKey === 'nganhhang') newItem.ten_nganh_hang = item[key];
							else if (normKey === 'tensanpham') newItem.ten_san_pham = item[key];
							else if (normKey === 'giasanpham') newItem.gia_san_pham = item[key];
							else if (normKey === 'imagesanpham') newItem.image_san_pham = item[key];
							else if (normKey === 'tendangnhap') newItem.ten_dang_nhap = item[key];
							else newItem[key] = item[key];
						});
						return newItem;
					});

					// 3. Merging logic
					const merged = [];
					const sheetIds = new Set(sheetData.map(s => s.id_san_pham));

					// ∆Øu ti√™n Sheet data cho c√°c s·∫£n ph·∫©m ƒë√£ c√≥ ID trong JSON
					jsonData.forEach(j => {
						const fromSheet = sheetData.find(s => s.id_san_pham === j.id_san_pham);
						if (fromSheet) {
							if (fromSheet.trang_thai_xoa_sp !== 'DELETED') {
								merged.push(fromSheet);
							}
							// N·∫øu DELETED th√¨ b·ªè qua
						} else {
							merged.push(j);
						}
					});

					// Th√™m c√°c s·∫£n ph·∫©m m·ªõi ch·ªâ c√≥ ·ªü Sheet
					sheetData.forEach(s => {
						const inJson = jsonData.find(j => j.id_san_pham === s.id_san_pham);
						if (!inJson && s.trang_thai_xoa_sp !== 'DELETED') {
							merged.push(s);
						}
					});

					currentProducts = merged;
					renderProducts(currentProducts);
					updateCategoryDatalist(currentProducts);
				} else {
					grid.innerHTML = `<div class="empty-state"><h2>L·ªói: ${result.message}</h2></div>`;
				}
			} catch (err) {
				console.error("Load failed", err);
				grid.innerHTML = `<div class="empty-state"><h2>Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi h·ªá th·ªëng</h2></div>`;
			}
		}

		function renderProducts(products) {
			const grid = document.getElementById('productGrid');
			if (products.length === 0) {
				grid.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="15"></line><line x1="15" y1="9" x2="9" y2="15"></line></svg>
                        <h2>B·∫°n ch∆∞a c√≥ s·∫£n ph·∫©m n√†o</h2>
                        <p style="color: var(--text-gray); margin-top: 10px;">Nh·∫•n n√∫t "Th√™m s·∫£n ph·∫©m m·ªõi" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
                    </div>
                `;
				return;
			}

			grid.innerHTML = products.map(p => {
				// Debug d·ªØ li·ªáu
				console.log('Product data:', p);

				// T√¨m link ·∫£nh (x·ª≠ l√Ω c·∫£ tr∆∞·ªùng h·ª£p header b·ªã l·ªách)
				let imgUrl = p.image_san_pham || p.imagesanpham || '';

				// Chu·∫©n h√≥a link ·∫£nh Drive
				if (imgUrl && (imgUrl.includes('drive.google.com') || imgUrl.includes('docs.google.com'))) {
					const idMatch = imgUrl.match(/[-\w]{25,}/);
					if (idMatch) imgUrl = `https://lh3.googleusercontent.com/d/${idMatch[0]}`;
				}

				// ·∫¢nh m·∫∑c ƒë·ªãnh ch·∫•t l∆∞·ª£ng cao t·ª´ Unsplash n·∫øu kh√¥ng c√≥ ·∫£nh
				const fallbackImg = 'https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?auto=format&fit=crop&q=80&w=400';

				return `
                <div class="product-card">
                    <div class="product-badge">${p.id_san_pham || 'NEW'}</div>
                    <div class="product-img">
                        <img src="${imgUrl || fallbackImg}" 
                             alt="${p.ten_san_pham}" 
                             style="width: 100%; height: 100%; object-fit: cover;"
                             onerror="this.onerror=null; this.src='${fallbackImg}'; console.log('Image load failed, using fallback for:', '${p.ten_san_pham}')">
                    </div>
                    <div class="product-info">
                        <span class="category">${p.ten_nghanh_hang || 'Ch∆∞a ph√¢n lo·∫°i'}</span>
                        <h3>${p.ten_san_pham}</h3>
                        <div class="product-footer">
                            <div class="product-price">${formatCurrency(p.gia_san_pham)}</div>
                            <div class="product-actions">
                                <div class="action-btn btn-edit" title="Ch·ªânh s·ª≠a" onclick="openModal('edit', '${p.id_san_pham}')">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                </div>
                                <div class="action-btn btn-delete" title="X√≥a" onclick="deleteProduct('${p.id_san_pham}')">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
			}).join('');
		}
		function updateCategoryDatalist(products) {
			const datalist = document.getElementById('categoryList');
			const defaultCats = ["T·∫•m Pima", "Duraflex", "Weber", "Ph·ª• Ki·ªán"];
			const userCats = [...new Set(products.map(p => p.ten_nghanh_hang).filter(c => c))];

			// H·ª£p nh·∫•t danh s√°ch m·∫∑c ƒë·ªãnh v√† danh s√°ch t·ª´ user
			const allCats = [...new Set([...defaultCats, ...userCats])];

			datalist.innerHTML = allCats.map(cat => `<option value="${cat}">`).join('');
		}

		function filterProducts() {
			const query = document.getElementById('searchInput').value.toLowerCase();
			const filtered = currentProducts.filter(p =>
				p.ten_san_pham.toLowerCase().includes(query) ||
				p.ten_nghanh_hang.toLowerCase().includes(query)
			);
			renderProducts(filtered);
		}

		// --- CORE CRUD ---

		function openModal(mode, id = null) {
			const modal = document.getElementById('productModal');
			const form = document.getElementById('productForm');
			const title = document.getElementById('modalTitle');
			const submitText = document.getElementById('submitBtnText');

			form.reset();
			document.getElementById('imagePreview').style.display = 'none';
			document.getElementById('uploadPlaceholder').style.display = 'block';
			document.getElementById('editId').value = '';

			if (mode === 'edit') {
				title.innerText = 'Ch·ªânh S·ª≠a S·∫£n Ph·∫©m';
				submitText.innerText = 'C·∫¨P NH·∫¨T TH√îNG TIN';
				const p = currentProducts.find(item => item.id_san_pham === id);
				if (p) {
					document.getElementById('editId').value = p.id_san_pham;
					document.getElementById('productName').value = p.ten_san_pham;
					document.getElementById('productCategory').value = p.ten_nghanh_hang;
					document.getElementById('productPrice').value = formatCurrencyNoSymbol(p.gia_san_pham);

					if (p.image_san_pham) {
						const preview = document.getElementById('imagePreview');
						preview.src = p.image_san_pham;
						preview.style.display = 'block';
						document.getElementById('uploadPlaceholder').style.display = 'none';
					}
				}
			} else {
				title.innerText = 'Th√™m S·∫£n Ph·∫©m M·ªõi';
				submitText.innerText = 'L∆ØU S·∫¢N PH·∫®M';
			}

			modal.classList.add('active');
			document.body.style.overflow = 'hidden';
		}

		function closeModal() {
			document.getElementById('productModal').classList.remove('active');
			document.body.style.overflow = 'auto';
		}

		function previewImage(event) {
			const file = event.target.files[0];
			if (!file) return;

			const reader = new FileReader();
			reader.onload = function (e) {
				const preview = document.getElementById('imagePreview');
				preview.src = e.target.result;
				preview.style.display = 'block';
				document.getElementById('uploadPlaceholder').style.display = 'none';
			};
			reader.readAsDataURL(file);
		}

		document.getElementById('productForm').addEventListener('submit', async (e) => {
			e.preventDefault();


			updateLoader('ƒêang chu·∫©n b·ªã d·ªØ li·ªáu...');

			try {
				let imageUrl = document.getElementById('imagePreview').src;
				const fileInput = document.getElementById('fileInput');
				const editId = document.getElementById('editId').value;

				// 1. Upload image if new file selected
				if (fileInput.files.length > 0) {
					updateLoader('ƒêang t·∫£i h√¨nh ·∫£nh l√™n h·ªá th·ªëng... (Vui l√≤ng ƒë·ª£i)');
					const file = fileInput.files[0];
					const base64 = await toBase64(file);

					const uploadRes = await fetch(SCRIPT_URL, {
						method: 'POST',
						body: JSON.stringify({
							action: 'upload',
							file: base64.split(',')[1],
							mimeType: file.type,
							filename: file.name
						})
					});

					if (!uploadRes.ok) throw new Error('Kh√¥ng th·ªÉ k·∫øt n·ªëi m√°y ch·ªß ·∫£nh');

					const uploadData = await uploadRes.json();
					if (uploadData.success) {
						imageUrl = uploadData.url;
					} else {
						throw new Error('L·ªói t·∫£i ·∫£nh: ' + uploadData.message);
					}
				} else if (imageUrl.startsWith('data:')) {
					imageUrl = '';
				}

				updateLoader('ƒêang l∆∞u th√¥ng tin s·∫£n ph·∫©m v√†o Sheet...');

				// 2. Prepare Data
				const pData = {
					id_san_pham: editId || '', // ƒê·∫∂C BI·ªÜT QUAN TR·ªåNG: G·ª≠i ID v·ªÅ ƒë·ªÉ Sheet nh·∫≠n di·ªán
					ten_san_pham: document.getElementById('productName').value,
					ten_nghanh_hang: document.getElementById('productCategory').value,
					gia_san_pham: parsePrice(document.getElementById('productPrice').value),
					image_san_pham: imageUrl,
					ten_dang_nhap: userData.email,
					trang_thai_xoa_sp: 'ACTIVE'
				};

				const payload = {
					action: editId ? 'update' : 'create',
					idValue: editId,
					data: pData
				};

				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify(payload)
				});

				const result = await response.json();
				if (result.success) {
					closeModal();
					await loadProducts();
					alert(editId ? "C·∫≠p nh·∫≠t th√†nh c√¥ng!" : "Th√™m s·∫£n ph·∫©m th√†nh c√¥ng!");
				} else {
					alert("L·ªói t·ª´ server: " + result.message);
				}
			} catch (err) {
				console.error('Error detail:', err);
				alert("L·ªói: " + err.message + "\n\nL∆∞u √Ω: B·∫°n h√£y ki·ªÉm tra xem ƒë√£ ph√¢n quy·ªÅn Apps Script l√† 'Anyone' ch∆∞a nh√©.");
			} finally {
				hideLoader();
			}
		});

		async function deleteProduct(id) {
			if (!id) {
				alert("L·ªói: Kh√¥ng t√¨m th·∫•y m√£ s·∫£n ph·∫©m ƒë·ªÉ x√≥a. (C√≥ th·ªÉ s·∫£n ph·∫©m n√†y ch∆∞a c√≥ ID trong Sheet)");
				return;
			}

			const product = currentProducts.find(p => p.id_san_pham === id);
			if (!product) {
				alert("L·ªói: D·ªØ li·ªáu s·∫£n ph·∫©m kh√¥ng h·ª£p l·ªá.");
				return;
			}

			// Hi·ªán Modal x√°c nh·∫≠n thay v√¨ confirm() c·ªßa tr√¨nh duy·ªát
			const modal = document.getElementById('confirmModal');
			document.getElementById('confirmMessage').innerText = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m "${product.ten_san_pham}"?`;
			document.getElementById('confirmExecuteBtn').onclick = async () => {
				closeConfirmModal();
				await executeDelete(id, product);
			};
			modal.classList.add('active');
		}

		function closeConfirmModal() {
			document.getElementById('confirmModal').classList.remove('active');
		}

		async function executeDelete(id, product) {


			updateLoader('ƒêang th·ª±c hi·ªán x√≥a s·∫£n ph·∫©m...');

			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'delete',
						idValue: id,
						data: product
					})
				});
				const result = await response.json();
				if (result.success) {
					await loadProducts();
					alert("ƒê√£ x√≥a s·∫£n ph·∫©m th√†nh c√¥ng.");
				} else {
					alert("L·ªói: " + result.message);
				}
			} catch (err) {
				console.error(err);
				alert("Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m. L·ªói k·∫øt n·ªëi.");
			} finally {
				hideLoader();
			}
		}

		// --- TAB SWITCHING ---
		function switchTab(tabName) {
			// Hide all tabs
			document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
			document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

			// Show selected tab
			const activeTab = document.getElementById(tabName + 'Tab');
			if (activeTab) activeTab.classList.add('active');

			const activeBtn = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
			if (activeBtn) activeBtn.classList.add('active');

			if (tabName === 'inventory') {
				loadInventory();
			} else if (tabName === 'orders') {
				fetchOrders().then(() => renderDetailedOrders());
			} else if (tabName === 'customers') {
				fetchCustomers().then(() => renderCustomers());
			}
		}

		// --- INVENTORY MANAGEMENT ---
		async function loadInventory() {
			const tbody = document.getElementById('inventoryBody');
			try {
				// 1. Fetch JSON data
				let jsonData = [];
				try {
					const jsonRes = await fetch('data/data_ton_kho.json');
					if (jsonRes.ok) {
						const rawJson = await jsonRes.json();
						jsonData = rawJson.filter(item => item.ten_dang_nhap === userData.email);
					}
				} catch (e) {
					console.warn("Kh√¥ng t√¨m th·∫•y file data_ton_kho.json ho·∫∑c l·ªói ƒë·ªçc file", e);
				}

				// 2. Fetch Sheet data
				let sheetData = [];
				try {
					const url = `${SCRIPT_URL}?action=readInventory&username=${encodeURIComponent(userData.email)}`;
					const response = await fetch(url);
					const result = await response.json();
					if (result.success && result.data) {
						sheetData = result.data;
					}
				} catch (e) {
					console.error("Fetch Sheet inventory failed", e);
				}

				// 3. Merging (Simple concat for inventory history, similar products can exist)
				// For inventory, it's usually a log, so we just append unless we have a clear ID to de-duplicate.
				// However, if we want to de-duplicate based on some criteria, we could.
				// For now, let's just combine them and sort by date descending.
				const combined = [...sheetData, ...jsonData];

				// Sorting by date (assuming YYYY-MM-DD format or similar)
				combined.sort((a, b) => {
					const dateA = new Date(a.date || 0);
					const dateB = new Date(b.date || 0);
					return dateB - dateA;
				});

				currentInventory = combined;
				renderInventory(currentInventory);

				if (currentInventory.length === 0) {
					tbody.innerHTML = `
						<tr>
							<td colspan="9" style="text-align: center; padding: 40px; color: var(--text-gray);">
								Ch∆∞a c√≥ d·ªØ li·ªáu t·ªìn kho. Nh·∫•n "Nh·∫≠p T·ªìn Kho" ƒë·ªÉ b·∫Øt ƒë·∫ßu.
							</td>
						</tr>
					`;
				}
			} catch (err) {
				console.error('Load inventory failed:', err);
				tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 40px; color: var(--danger);">L·ªói h·ªá th·ªëng. Vui l√≤ng th·ª≠ l·∫°i.</td></tr>`;
			}
		}

		function renderInventory(data) {
			const tbody = document.getElementById('inventoryBody');
			if (!data || data.length === 0) {
				tbody.innerHTML = `
					<tr>
						<td colspan="9" style="text-align: center; padding: 40px; color: var(--text-gray);">
							Ch∆∞a c√≥ d·ªØ li·ªáu t·ªìn kho. Nh·∫•n "Nh·∫≠p T·ªìn Kho" ƒë·ªÉ b·∫Øt ƒë·∫ßu.
						</td>
					</tr>
				`;
				return;
			}

			tbody.innerHTML = data.map((item, index) => {
				let dateStr = getVal(item, 'date') || '';
				if (dateStr && dateStr.includes('T')) {
					dateStr = new Date(dateStr).toLocaleDateString('vi-VN');
				}
				const tenSP = getVal(item, 't√™n s·∫£n ph·∫©m') || '';
				const idSP = getVal(item, 'id s·∫£n ph·∫©m') || '';
				const displayNhap = parseFloat(getVal(item, 'nh·∫≠p')) || 0;
				const displayXuat = parseFloat(getVal(item, 'xu·∫•t')) || 0;

				const conLai = getVal(item, 'c√≤n l·∫°i') || 0;
				const ghiChu = getVal(item, 'ghi ch√∫') || '-';
				const rowDataJson = JSON.stringify(item).replace(/"/g, '&quot;');

				const isOut = displayXuat > 0;
				const actionButtons = isOut ? '<span style="color: var(--text-gray); font-style: italic; font-size: 0.8rem;">T·ª´ ƒê∆°n H√†ng</span>' : `
					<button class="action-btn btn-edit" title="Ch·ªânh s·ª≠a" onclick="editInventoryRecord('${index}', '${rowDataJson}')" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; border: 1px solid var(--glass-border); background: var(--glass); cursor: pointer; border-radius: 8px;">
						<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
					</button>
				`;

				return `
					<tr>
						<td>${dateStr}</td>
						<td style="text-align:left;">${tenSP}</td>
						<td><span style="color: var(--primary); font-weight: 600;">${idSP}</span></td>
						<td style="color: var(--success); font-weight: 600;">${displayNhap > 0 ? displayNhap : '-'}</td>
						<td style="color: var(--danger); font-weight: 600;">${displayXuat > 0 ? displayXuat : '-'}</td>
						<td><strong style="color: var(--primary);">${conLai}</strong></td>
						<td style="color: var(--text-gray); font-size: 0.85rem;">${getVal(item, 'ghi ch√∫') || getVal(item, 'ghi_chu') || '-'}</td>
						<td>
							<div style="display: flex; gap: 8px;">
								${actionButtons}
							</div>
						</td>
					</tr>
				`;
			}).join('');
		}

		function openInventoryModal() {
			const modal = document.getElementById('inventoryModal');
			const form = document.getElementById('inventoryForm');
			const productSelect = document.getElementById('invProduct');

			// Reset form
			form.reset();
			document.getElementById('invProductId').value = '';
			document.getElementById('invQuantityOut').value = '0';
			document.getElementById('invRemaining').value = '0';

			// Set today's date
			const today = new Date().toISOString().split('T')[0];
			document.getElementById('invDate').value = today;

			// Reset quantity input state (in case it was disabled by edit mode)
			const qtyInput = document.getElementById('invQuantityIn');
			qtyInput.readOnly = false;
			qtyInput.style.background = '';
			qtyInput.title = '';

			// Populate product dropdown
			productSelect.innerHTML = '<option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>' +
				currentProducts.map(p => `<option value="${p.id_san_pham}">${p.ten_san_pham}</option>`).join('');

			modal.classList.add('active');
			document.body.style.overflow = 'hidden';
		}

		function closeInventoryModal() {
			document.getElementById('inventoryModal').classList.remove('active');
			document.body.style.overflow = 'auto';
		}

		function getLocalStock(productId) {
			let total = 0;
			currentInventory.forEach(item => {
				if (getVal(item, 'id s·∫£n ph·∫©m') === productId) {
					const n = parseFloat(getVal(item, 'nh·∫≠p')) || 0;
					const x = parseFloat(getVal(item, 'xu·∫•t')) || 0;
					total += (n - x);
				}
			});
			return total;
		}

		async function updateProductInfo() {
			const productId = document.getElementById('invProduct').value;
			const product = currentProducts.find(p => p.id_san_pham === productId);

			if (product) {
				document.getElementById('invProductId').value = product.id_san_pham;

				// Fetch s·ªë l∆∞·ª£ng xu·∫•t t·ª´ ƒë∆°n h√†ng
				try {
					const url = `${ORDER_SCRIPT_URL}?action=getProductQuantity&productId=${encodeURIComponent(productId)}&customerName=${encodeURIComponent(userData.name)}&username=${encodeURIComponent(userData.email)}`;
					const response = await fetch(url);
					const result = await response.json();

					if (result.success) {
						document.getElementById('invQuantityOut').value = result.quantity || 0;
						calculateRemaining();
					}
				} catch (err) {
					console.error('Failed to fetch product quantity from orders:', err);
					document.getElementById('invQuantityOut').value = 0;
				}
			} else {
				document.getElementById('invProductId').value = '';
				document.getElementById('invQuantityOut').value = 0;
			}
			calculateRemaining();
		}

		function calculateRemaining() {
			const productId = document.getElementById('invProduct').value;
			const currentStock = getLocalStock(productId);
			const quantityIn = parseFloat(document.getElementById('invQuantityIn').value) || 0;
			const quantityOut = parseFloat(document.getElementById('invQuantityOut').value) || 0;

			// For a NEW entry, the balance will be (Current) + (In) - (Out)
			// Note: If we are EDITING an existing entry, we'd need more complex logic, 
			// but for now let's focus on new entries.
			const projected = currentStock + quantityIn - quantityOut;
			document.getElementById('invRemaining').value = projected;
		}

		// Handle inventory form submission
		document.getElementById('inventoryForm').addEventListener('submit', async (e) => {
			e.preventDefault();



			updateLoader('ƒêang l∆∞u th√¥ng tin t·ªìn kho...');

			try {
				const productId = document.getElementById('invProduct').value;
				const product = currentProducts.find(p => p.id_san_pham === productId);

				const invData = {
					date: document.getElementById('invDate').value,
					ten_san_pham: product ? product.ten_san_pham : '',
					id_san_pham: document.getElementById('invProductId').value,
					so_luong_nhap: parseFloat(document.getElementById('invQuantityIn').value) || 0,
					so_luong_xuat: parseFloat(document.getElementById('invQuantityOut').value) || 0,
					con_lai: parseFloat(document.getElementById('invRemaining').value) || 0,
					ghi_chu: document.getElementById('invNote').value,
					ten_dang_nhap: userData.email,
					trang_thai: 'nh·∫≠p'
				};

				// Note: we send only dedicated fields; backend will use `so_luong_xuat` from orders

				const payload = {
					action: 'upsert_inventory',
					data: invData
				};

				console.log('Sending inventory payload:', payload);

				// Use form-encoded 'payload' to bypass CORS issues
				const formData = new URLSearchParams();
				formData.append('payload', JSON.stringify(payload));

				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: formData
				});

				console.log('Response status:', response.status);
				const result = await response.json();
				console.log('Response JSON:', result);

				if (result.success) {
					closeInventoryModal();
					await loadInventory();
					alert('L∆∞u th√¥ng tin t·ªìn kho th√†nh c√¥ng!');
				} else {
					alert('L·ªói: ' + result.message);
				}
			} catch (err) {
				console.error('Error saving inventory:', err);
				alert('L·ªói khi l∆∞u t·ªìn kho: ' + err.message);
			} finally {
				hideLoader();
			}
		});

		// --- UTILS ---
		function formatCurrency(val) {
			if (!val) return '0 ƒë';
			return new Intl.NumberFormat('vi-VN').format(val) + ' ƒë';
		}

		function formatCurrencyNoSymbol(val) {
			if (!val) return '0';
			return new Intl.NumberFormat('vi-VN').format(val);
		}

		function parsePrice(str) {
			if (!str) return 0;
			return parseFloat(String(str).replace(/[^\d]/g, '')) || 0;
		}

		function formatPriceInput(input) {
			let value = input.value.replace(/\D/g, '');
			if (value) {
				input.value = new Intl.NumberFormat('vi-VN').format(value);
			}
		}

		function toBase64(file) {
			return new Promise((resolve, reject) => {
				const reader = new FileReader();
				reader.readAsDataURL(file);
				reader.onload = () => resolve(reader.result);
				reader.onerror = error => reject(error);
			});
		}

		// --- INVENTORY EDIT/DELETE ---
		let currentEditInventory = null;

		function editInventoryRecord(index, rowDataJson) {
			try {
				const rowData = JSON.parse(rowDataJson.replace(/&quot;/g, '"'));
				currentEditInventory = rowData;

				// Open edit modal
				const modal = document.getElementById('inventoryModal');
				const form = document.getElementById('inventoryForm');

				// Change modal title
				modal.querySelector('.modal-header h2').innerText = 'Ch·ªânh S·ª≠a T·ªìn Kho';

				// Set form values
				document.getElementById('invDate').value = rowData.date || '';

				// Find product by ID
				const product = currentProducts.find(p => p.id_san_pham === (rowData.idsanpham || rowData.id_san_pham));
				if (product) {
					document.getElementById('invProduct').value = product.id_san_pham;
					document.getElementById('invProductId').value = product.id_san_pham;
				}

				const status = String(rowData.trangthai || rowData.trang_thai || '').toLowerCase();
				const isXuat = status === 'xu·∫•t' || status.includes('xuat');

				const qtyValue = rowData.soluong || rowData.soluongnhap || rowData.so_luong_nhap || 0;
				document.getElementById('invQuantityIn').value = qtyValue;
				document.getElementById('invQuantityOut').value = rowData.soluongxuat || rowData.so_luong_xuat || 0;
				document.getElementById('invRemaining').value = rowData.conlai || rowData.con_lai || 0;
				document.getElementById('invNote').value = rowData.ghichu || rowData.ghi_chu || '';

				// Restrict editing if it's an 'xu·∫•t' record (comes from orders)
				const qtyInput = document.getElementById('invQuantityIn');
				if (isXuat) {
					qtyInput.readOnly = true;
					qtyInput.style.background = 'rgba(255,255,255,0.03)';
					qtyInput.title = 'B·∫£n ghi xu·∫•t t·ª´ ƒë∆°n h√†ng kh√¥ng th·ªÉ ch·ªânh s·ª≠a s·ªë l∆∞·ª£ng t·∫°i ƒë√¢y';
				} else {
					qtyInput.readOnly = false;
					qtyInput.style.background = '';
					qtyInput.title = '';
				}

				// Change submit button text and handler
				form.onsubmit = async (e) => {
					e.preventDefault();
					await updateInventoryRecord();
				};

				// Mark as edit mode
				form.setAttribute('data-edit-mode', 'true');

				modal.classList.add('active');
				document.body.style.overflow = 'hidden';
			} catch (err) {
				console.error('Error editing inventory:', err);
				alert('L·ªói khi m·ªü b·∫£n ghi ƒë·ªÉ ch·ªânh s·ª≠a');
			}
		}

		async function updateInventoryRecord() {


			updateLoader('ƒêang c·∫≠p nh·∫≠t t·ªìn kho...');

			try {
				const productId = document.getElementById('invProductId').value;
				const product = currentProducts.find(p => p.id_san_pham === productId);

				const currentStatus = String(currentEditInventory.trangthai || currentEditInventory.trang_thai || 'nh·∫≠p').toLowerCase();

				const invData = {
					date: document.getElementById('invDate').value,
					ten_san_pham: product ? product.ten_san_pham : '',
					id_san_pham: productId,
					soluong: parseFloat(document.getElementById('invQuantityIn').value) || 0,
					so_luong_nhap: parseFloat(document.getElementById('invQuantityIn').value) || 0,
					so_luong_xuat: parseFloat(document.getElementById('invQuantityOut').value) || 0,
					con_lai: parseFloat(document.getElementById('invRemaining').value) || 0,
					ghi_chu: document.getElementById('invNote').value,
					ten_dang_nhap: userData.email,
					trang_thai: currentStatus
				};

				const payload = {
					action: 'updateInventory',
					data: invData,
					oldData: currentEditInventory
				};

				console.log('Sending update inventory payload:', payload);

				const formData = new URLSearchParams();
				formData.append('payload', JSON.stringify(payload));

				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: formData
				});

				const result = await response.json();
				console.log('Update response:', result);

				if (result.success) {
					closeInventoryModal();
					await loadInventory();
					alert('C·∫≠p nh·∫≠t th√¥ng tin t·ªìn kho th√†nh c√¥ng!');
					// Reset edit mode
					document.getElementById('inventoryForm').removeAttribute('data-edit-mode');
					document.getElementById('inventoryForm').onsubmit = null;
					document.querySelector('.modal-header h2').innerText = 'Nh·∫≠p T·ªìn Kho';
				} else {
					alert('L·ªói: ' + result.message);
				}
			} catch (err) {
				console.error('Error updating inventory:', err);
				alert('L·ªói khi c·∫≠p nh·∫≠t t·ªìn kho: ' + err.message);
			} finally {
				hideLoader();
			}
		}

		async function deleteInventoryRecord(id_san_pham) {
			if (!id_san_pham) {
				alert('L·ªói: Kh√¥ng t√¨m th·∫•y m√£ s·∫£n ph·∫©m ƒë·ªÉ x√≥a');
				return;
			}

			// Show confirm modal
			const modal = document.getElementById('confirmModal');
			document.getElementById('confirmTitle').innerText = 'X√°c nh·∫≠n x√≥a t·ªìn kho';
			document.getElementById('confirmMessage').innerText = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi t·ªìn kho n√†y kh√¥ng? H√†nh ƒë·ªông n√†y s·∫Ω ƒë√°nh d·∫•u b·∫£n ghi l√† ƒë√£ x√≥a trong h·ªá th·ªëng.`;

			document.getElementById('confirmExecuteBtn').onclick = async () => {
				closeConfirmModal();
				await executeDeleteInventory(id_san_pham);
			};

			modal.classList.add('active');
		}

		async function executeDeleteInventory(id_san_pham) {


			updateLoader('ƒêang x√≥a b·∫£n ghi t·ªìn kho...');

			try {
				const payload = {
					action: 'deleteInventory',
					id_san_pham: id_san_pham,
					ten_dang_nhap: userData.email
				};

				console.log('Sending delete inventory payload:', payload);

				const formData = new URLSearchParams();
				formData.append('payload', JSON.stringify(payload));

				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: formData
				});

				const result = await response.json();
				console.log('Delete response:', result);

				if (result.success) {
					await loadInventory();
					alert('ƒê√£ x√≥a b·∫£n ghi t·ªìn kho th√†nh c√¥ng.');
				} else {
					alert('L·ªói: ' + result.message);
				}
			} catch (err) {
				console.error('Error deleting inventory:', err);
				alert('L·ªói khi x√≥a b·∫£n ghi: ' + err.message);
			} finally {
				hideLoader();
			}
		}
	</script>
</body>

</html>
```