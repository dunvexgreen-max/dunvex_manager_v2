<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Master Control Panel | Dunvex Digital</title>
	<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<style>
		:root {
			--primary: #6366f1;
			--primary-glow: rgba(99, 102, 241, 0.4);
			--bg-dark: #0f172a;
			--card-bg: rgba(30, 41, 59, 0.7);
			--glass-border: rgba(255, 255, 255, 0.1);
			--text-main: #f8fafc;
			--text-muted: #94a3b8;
			--success: #22c55e;
			--danger: #ef4444;
			--warning: #f59e0b;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Outfit', sans-serif;
		}

		body {
			background: var(--bg-dark);
			color: var(--text-main);
			min-height: 100vh;
			background-image:
				radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
				radial-gradient(at 100% 100%, rgba(192, 132, 252, 0.15) 0px, transparent 50%);
			padding: 20px;
		}

		.container {
			max-width: 1400px;
			margin: 0 auto;
		}

		/* Top Header */
		header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 40px;
			padding: 20px;
			background: var(--card-bg);
			backdrop-filter: blur(12px);
			border: 1px solid var(--glass-border);
			border-radius: 20px;
		}

		.logo-info {
			display: flex;
			align-items: center;
			gap: 15px;
		}

		.logo-icon {
			width: 50px;
			height: 50px;
			background: var(--primary);
			border-radius: 12px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 800;
			font-size: 1.5rem;
			box-shadow: 0 0 20px var(--primary-glow);
		}

		.header-text h1 {
			font-size: 1.4rem;
			font-weight: 800;
			letter-spacing: -0.5px;
		}

		.header-text p {
			font-size: 0.85rem;
			color: var(--text-muted);
		}

		/* Stats Row */
		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
			gap: 20px;
			margin-bottom: 30px;
		}

		.stat-card {
			background: var(--card-bg);
			padding: 24px;
			border-radius: 20px;
			border: 1px solid var(--glass-border);
			display: flex;
			align-items: center;
			gap: 20px;
		}

		.stat-icon {
			width: 55px;
			height: 55px;
			border-radius: 14px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.4rem;
		}

		.stat-info h3 {
			font-size: 0.85rem;
			color: var(--text-muted);
			text-transform: uppercase;
			letter-spacing: 1px;
		}

		.stat-info p {
			font-size: 1.8rem;
			font-weight: 800;
		}

		/* Main Table Section */
		.main-card {
			background: var(--card-bg);
			border-radius: 24px;
			border: 1px solid var(--glass-border);
			overflow: hidden;
			backdrop-filter: blur(12px);
		}

		.card-header {
			padding: 25px;
			border-bottom: 1px solid var(--glass-border);
			display: flex;
			justify-content: space-between;
			align-items: center;
			background: rgba(255, 255, 255, 0.02);
		}

		.card-title {
			display: flex;
			align-items: center;
			gap: 12px;
			font-size: 1.1rem;
			font-weight: 700;
		}

		.search-box {
			position: relative;
			width: 300px;
		}

		.search-box input {
			width: 100%;
			padding: 10px 15px 10px 40px;
			background: rgba(0, 0, 0, 0.2);
			border: 1px solid var(--glass-border);
			border-radius: 10px;
			color: white;
			outline: none;
		}

		.search-box i {
			position: absolute;
			left: 15px;
			top: 50%;
			transform: translateY(-50%);
			color: var(--text-muted);
		}

		/* Table */
		.table-container {
			overflow-x: auto;
		}

		table {
			width: 100%;
			border-collapse: collapse;
		}

		th {
			padding: 18px 25px;
			text-align: left;
			font-size: 0.8rem;
			font-weight: 600;
			color: var(--text-muted);
			text-transform: uppercase;
			letter-spacing: 1px;
			background: rgba(0, 0, 0, 0.1);
		}

		td {
			padding: 20px 25px;
			border-bottom: 1px solid var(--glass-border);
			font-size: 0.95rem;
		}

		tr:hover {
			background: rgba(255, 255, 255, 0.03);
		}

		.user-cell {
			display: flex;
			align-items: center;
			gap: 12px;
		}

		.user-avatar {
			width: 36px;
			height: 36px;
			background: var(--primary);
			border-radius: 10px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 700;
			font-size: 0.9rem;
		}

		.badge {
			padding: 4px 10px;
			border-radius: 6px;
			font-size: 0.75rem;
			font-weight: 700;
			text-transform: uppercase;
		}

		.badge-free {
			background: rgba(148, 163, 184, 0.15);
			color: #94a3b8;
		}

		.badge-basic {
			background: rgba(34, 197, 94, 0.15);
			color: #22c55e;
		}

		.badge-pro {
			background: rgba(99, 102, 241, 0.15);
			color: #6366f1;
		}

		.badge-active {
			background: rgba(34, 197, 94, 0.1);
			color: #22c55e;
			border: 1px solid rgba(34, 197, 94, 0.2);
		}

		.progress-mini {
			width: 100px;
			height: 6px;
			background: rgba(255, 255, 255, 0.05);
			border-radius: 3px;
			margin-top: 5px;
			overflow: hidden;
		}

		.progress-bar {
			height: 100%;
			background: var(--primary);
		}

		.btn-action {
			width: 32px;
			height: 32px;
			border-radius: 8px;
			border: 1px solid var(--glass-border);
			background: rgba(255, 255, 255, 0.05);
			color: white;
			cursor: pointer;
			transition: 0.2s;
		}

		.btn-action:hover {
			background: var(--primary);
			border-color: var(--primary);
		}

		.btn-edit {
			color: var(--warning);
		}

		.btn-lock {
			color: var(--danger);
		}

		/* Modal Settings */
		.modal {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.85);
			backdrop-filter: blur(8px);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 1000;
			padding: 20px;
		}

		.modal.active {
			display: flex;
		}

		.modal-content {
			background: #1e293b;
			width: 100%;
			max-width: 600px;
			border-radius: 24px;
			border: 1px solid var(--glass-border);
			padding: 30px;
			position: relative;
		}

		.form-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 20px;
			margin-top: 20px;
		}

		.form-group {
			margin-bottom: 20px;
		}

		.form-group label {
			display: block;
			font-size: 0.8rem;
			color: var(--text-muted);
			margin-bottom: 8px;
			text-transform: uppercase;
			letter-spacing: 1px;
		}

		.form-group input,
		.form-group select {
			width: 100%;
			padding: 12px;
			background: rgba(0, 0, 0, 0.2);
			border: 1px solid var(--glass-border);
			border-radius: 12px;
			color: white;
			outline: none;
		}

		.btn-submit {
			width: 100%;
			padding: 14px;
			background: var(--primary);
			color: white;
			border: none;
			border-radius: 12px;
			font-weight: 700;
			cursor: pointer;
			transition: 0.3s;
			margin-top: 10px;
			box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
		}

		.btn-submit:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
		}

		/* Loader */
		#loader {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: var(--bg-dark);
			z-index: 2000;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
		}

		.pulse {
			width: 60px;
			height: 60px;
			background: var(--primary);
			border-radius: 50%;
			animation: pulse 1.5s infinite;
		}

		@keyframes pulse {
			0% {
				transform: scale(0.8);
				opacity: 0.5;
				box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7);
			}

			70% {
				transform: scale(1.1);
				opacity: 0.8;
				box-shadow: 0 0 0 20px rgba(99, 102, 241, 0);
			}

			100% {
				transform: scale(0.8);
				opacity: 0.5;
				box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
			}
		}

		.forbidden {
			height: 100vh;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			text-align: center;
			padding: 20px;
		}

		.forbidden i {
			font-size: 5rem;
			color: var(--danger);
			margin-bottom: 20px;
		}
	</style>
</head>

<body>

	<div id="loader">
		<div class="pulse"></div>
		<p style="margin-top: 20px; letter-spacing: 2px;">AUTHENTICATING MASTER KEY...</p>
	</div>

	<div id="app" style="display: none;">
		<div class="container" id="adminContent">
			<header>
				<div class="logo-info">
					<div class="logo-icon">DV</div>
					<div class="header-text">
						<h1>Master Control Panel</h1>
						<p>Hệ thống Quản lý Tài khoản & Phân quyền Toàn cầu</p>
					</div>
				</div>
				<div style="display: flex; gap: 15px;">
					<button class="btn-action" title="Refresh" onclick="loadAdminData()"><i
							class="fas fa-sync-alt"></i></button>
					<a href="index.html" class="btn-action" title="Exit"
						style="display: flex; align-items: center; justify-content: center; text-decoration: none;"><i
							class="fas fa-sign-out-alt"></i></a>
				</div>
			</header>

			<div class="stats-grid">
				<div class="stat-card">
					<div class="stat-icon" style="background: rgba(99, 102, 241, 0.1); color: var(--primary);"><i
							class="fas fa-users-cog"></i></div>
					<div class="stat-info">
						<h3>Tổng Admin</h3>
						<p id="stat_admins">0</p>
					</div>
				</div>
				<div class="stat-card">
					<div class="stat-icon" style="background: rgba(34, 197, 94, 0.1); color: var(--success);"><i
							class="fas fa-id-card"></i></div>
					<div class="stat-info">
						<h3>Gói Premium</h3>
						<p id="stat_pro">0</p>
					</div>
				</div>
				<div class="stat-card">
					<div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: var(--warning);"><i
							class="fas fa-chart-line"></i></div>
					<div class="stat-info">
						<h3>Đang Dùng Thử</h3>
						<p id="stat_trial">0</p>
					</div>
				</div>
				<div class="stat-card">
					<div class="stat-icon" style="background: rgba(239, 68, 68, 0.1); color: var(--danger);"><i
							class="fas fa-shield-alt"></i></div>
					<div class="stat-info">
						<h3>Bị Khóa</h3>
						<p id="stat_locked">0</p>
					</div>
				</div>
			</div>

			<div class="main-card">
				<div class="card-header">
					<div class="card-title"><i class="fas fa-list-check" style="color: var(--primary);"></i> Danh sách
						Quản trị viên (Admins)</div>
					<div class="search-box">
						<i class="fas fa-search"></i>
						<input type="text" id="adminSearch" placeholder="Tìm email hoặc gói cước..."
							oninput="filterTable()">
					</div>
				</div>
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>QUẢN TRỊ VIÊN</th>
								<th>NGÀY ĐĂNG KÝ</th>
								<th>GÓI CƯỚC</th>
								<th>NHÂN VIÊN (MAX)</th>
								<th>HẠN BÁO CÁO</th>
								<th>TRẠNG THÁI</th>
								<th style="text-align: center;">HÀNH ĐỘNG</th>
							</tr>
						</thead>
						<tbody id="adminTableBody">
							<!-- Dữ liệu render tại đây -->
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>

	<!-- MODAL EDIT ADMIN SETTINGS -->
	<div id="editModal" class="modal">
		<div class="modal-content">
			<h2 style="margin-bottom: 5px;">Thiết lập Tài khoản Admin</h2>
			<p id="editEmailDisplay" style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px;"></p>

			<form id="editForm">
				<input type="hidden" id="edit_email">
				<div class="form-grid">
					<div class="form-group">
						<label>Gói Cước</label>
						<select id="edit_package">
							<option value="Free">Miễn phí (Free)</option>
							<option value="Basic">Cơ bản (Basic)</option>
							<option value="Premium">Cao cấp (Premium)</option>
						</select>
					</div>
					<div class="form-group">
						<label>Giới hạn Nhân viên</label>
						<input type="number" id="edit_max_employees" value="5">
					</div>
					<div class="form-group">
						<label>Hạn Báo cáo Doanh thu</label>
						<input type="date" id="edit_report_expiry">
					</div>
					<div class="form-group">
						<label>Trạng thái</label>
						<select id="edit_status">
							<option value="Hoạt động">Hoạt động</option>
							<option value="Tạm khóa">Tạm khóa</option>
						</select>
					</div>
				</div>

				<div
					style="margin: 20px 0; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px; border: 1px solid var(--glass-border);">
					<p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 10px;">CÀI ĐẶT NÂNG CAO</p>
					<label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
						<input type="checkbox" id="edit_feature_crm" checked> Cho phép CRM & Sales Check-in
					</label>
					<label style="display: flex; align-items: center; gap: 10px; margin-top: 10px; cursor: pointer;">
						<input type="checkbox" id="edit_feature_order" checked> Cho phép Quản lý Đơn hàng
					</label>
				</div>

				<div style="display: flex; gap: 15px;">
					<button type="submit" class="btn-submit">LƯU THAY ĐỔI</button>
					<button type="button" class="btn-submit" style="background: rgba(255,255,255,0.05); color: white;"
						onclick="closeModal()">HỦY</button>
				</div>
			</form>
		</div>
	</div>

	<script>
		const MASTER_EMAIL = 'dunvex.green@gmail.com';
		const MASTER_API = 'https://script.google.com/macros/s/AKfycbwM9Yxu6WpjxuHKYKb0/exec';

		let allAdmins = [];

		window.onload = function () {
			const user = JSON.parse(localStorage.getItem('user'));

			setTimeout(() => {
				document.getElementById('loader').style.display = 'none';
				if (!user || user.email !== MASTER_EMAIL) {
					document.body.innerHTML = `
                        <div class="forbidden">
                            <i class="fas fa-shield-slash"></i>
                            <h1>TRUY CẬP BỊ TỪ CHỐI</h1>
                            <p style="margin-top: 15px; color: var(--text-muted);">Trang quản trị Master dành riêng cho hệ thống Dunvex.<br>Tài khoản của bạn (${user ? user.email : 'Ẩn danh'}) không có quyền sở hữu Master Key.</p>
                            <a href="index.html" class="btn-submit" style="max-width: 200px; text-decoration: none; display: inline-block; text-align: center; margin-top: 30px;">TRỞ VỀ TRANG CHỦ</a>
                        </div>
                    `;
					return;
				}
				document.getElementById('app').style.display = 'block';
				loadAdminData();
			}, 1000);
		};

		async function loadAdminData() {
			try {
				const res = await fetch(MASTER_API, {
					method: 'POST',
					body: JSON.stringify({ action: 'getAllAdmins' })
				});
				const data = await res.json();
				if (data.success) {
					allAdmins = data.admins;
					renderTable(allAdmins);
					updateStats();
				} else {
					showToast("Lỗi tải dữ liệu: " + data.message, true);
				}
			} catch (e) {
				console.error(e);
				showToast("Không thể kết nối Master API", true);
			}
		}

		function renderTable(data) {
			const body = document.getElementById('adminTableBody');
			body.innerHTML = data.map(adm => {
				const badgeClass = `badge-${adm.package.toLowerCase()}`;
				const progress = (adm.currentEmployees / adm.maxEmployees) * 100;
				const statusColor = adm.status === 'Hoạt động' ? 'var(--success)' : 'var(--danger)';

				return `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <div class="user-avatar">${adm.email.charAt(0).toUpperCase()}</div>
                                <div>
                                    <div style="font-weight: 600;">${adm.email}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">ID: AD-${adm.email.split('@')[0].toUpperCase()}</div>
                                </div>
                            </div>
                        </td>
                        <td>${formatDate(adm.regDate)}</td>
                        <td><span class="badge ${badgeClass}">${adm.package}</span></td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-weight: 700;">${adm.currentEmployees}/${adm.maxEmployees}</span>
                                <div class="progress-mini">
                                    <div class="progress-bar" style="width: ${Math.min(progress, 100)}%; background: ${progress >= 100 ? 'var(--danger)' : 'var(--primary)'}"></div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div style="color: ${isExpired(adm.reportExpiry) ? 'var(--danger)' : 'var(--text-muted)'}; font-size: 0.85rem;">
                                ${formatDate(adm.reportExpiry)}
                            </div>
                        </td>
                        <td><span class="badge badge-active" style="color: ${statusColor}; border-color: ${statusColor}22; background: ${statusColor}11;">${adm.status}</span></td>
                        <td style="text-align: center;">
                            <button class="btn-action btn-edit" title="Cấu hình tính năng & Giới hạn" onclick="editAdmin('${adm.email}')"><i class="fas fa-cog"></i></button>
                            <button class="btn-action btn-lock" title="Khóa/Mở khóa" onclick="toggleLock('${adm.email}')"><i class="fas fa-shield-alt"></i></button>
                        </td>
                    </tr>
                `;
			}).join('');
		}

		function updateStats() {
			document.getElementById('stat_admins').innerText = allAdmins.length;
			document.getElementById('stat_pro').innerText = allAdmins.filter(a => a.package === 'Premium').length;
			document.getElementById('stat_trial').innerText = allAdmins.filter(a => a.package === 'Free').length;
			document.getElementById('stat_locked').innerText = allAdmins.filter(a => a.status !== 'Hoạt động').length;
		}

		function editAdmin(email) {
			const adm = allAdmins.find(a => a.email === email);
			if (!adm) return;

			document.getElementById('edit_email').value = email;
			document.getElementById('editEmailDisplay').innerText = `Cấu hình cho: ${email}`;
			document.getElementById('edit_package').value = adm.package;
			document.getElementById('edit_max_employees').value = adm.maxEmployees;

			if (adm.reportExpiry) {
				const date = new Date(adm.reportExpiry);
				const dateStr = date.toISOString().split('T')[0];
				document.getElementById('edit_report_expiry').value = dateStr;
			}

			document.getElementById('edit_status').value = adm.status;

			const f = adm.features || {};
			document.getElementById('edit_feature_crm').checked = f.crm !== false;
			document.getElementById('edit_feature_order').checked = f.order !== false;

			document.getElementById('editModal').classList.add('active');
		}

		function closeModal() {
			document.getElementById('editModal').classList.remove('active');
		}

		document.getElementById('editForm').onsubmit = async function (e) {
			e.preventDefault();
			const btn = e.target.querySelector('button[type="submit"]');
			const originalText = btn.innerText;
			btn.disabled = true;
			btn.innerText = "ĐANG LƯU...";

			const payload = {
				action: 'updateAdminConfig',
				adminEmail: document.getElementById('edit_email').value,
				package: document.getElementById('edit_package').value,
				max_staff: parseInt(document.getElementById('edit_max_employees').value),
				report_expiry: document.getElementById('edit_report_expiry').value,
				status: document.getElementById('edit_status').value,
				features: {
					crm: document.getElementById('edit_feature_crm').checked,
					order: document.getElementById('edit_feature_order').checked
				}
			};

			try {
				const res = await fetch(MASTER_API, {
					method: 'POST',
					body: JSON.stringify(payload)
				});
				const data = await res.json();
				if (data.success) {
					showToast("✅ Đã cập nhật cấu hình Admin!");
					closeModal();
					loadAdminData();
				} else {
					showToast("❌ Lỗi: " + data.message, true);
				}
			} catch (e) {
				showToast("❌ Lỗi kết nối API", true);
			} finally {
				btn.disabled = false;
				btn.innerText = originalText;
			}
		};

		async function toggleLock(email) {
			const adm = allAdmins.find(a => a.email === email);
			if (!adm) return;
			const newStatus = adm.status === 'Hoạt động' ? 'Tạm khóa' : 'Hoạt động';
			if (!confirm(`Bạn có chắc muốn ${newStatus === 'Hoạt động' ? 'Mở khóa' : 'Khóa'} tài khoản ${email}?`)) return;

			try {
				const res = await fetch(MASTER_API, {
					method: 'POST',
					body: JSON.stringify({ action: 'updateAdminConfig', adminEmail: email, status: newStatus })
				});
				const data = await res.json();
				if (data.success) {
					showToast(`✅ Đã cập nhật trạng thái mới cho Admin!`);
					loadAdminData();
				}
			} catch (e) { showToast("Lỗi kết nối", true); }
		}

		function filterTable() {
			const q = document.getElementById('adminSearch').value.toLowerCase();
			const filtered = allAdmins.filter(a =>
				a.email.toLowerCase().includes(q) ||
				a.package.toLowerCase().includes(q)
			);
			renderTable(filtered);
		}

		function formatDate(dStr) {
			if (!dStr) return "N/A";
			const d = new Date(dStr);
			return d.toLocaleDateString('vi-VN');
		}

		function isExpired(dStr) {
			if (!dStr) return false;
			return new Date(dStr) < new Date();
		}

		function showToast(msg, isError = false) {
			// Using alert for now as a fallback, but can be a toast element
			console.log(msg);
			alert(msg);
		}
	</script>
</body>

</html>