<!DOCTYPE html>
<html lang="vi">

<head>
	<!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-QFQ2HMYTDH"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag() { dataLayer.push(arguments); }
		gtag('js', new Date());

		gtag('config', 'G-QFQ2HMYTDH');
	</script>

	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Qu·∫£n Tr·ªã H·ªá Th·ªëng | Dunvex Global</title>
	<link rel="icon" type="image/svg+xml"
		href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%236366f1'/><text x='50%' y='50%' dominant-baseline='central' text-anchor='middle' fill='white' font-size='60' font-family='sans-serif' font-weight='800'>DV</text></svg>">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link
		href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@600;800&display=swap"
		rel="stylesheet">
	<style>
		.ad-form-grid {
			display: grid;
			grid-template-columns: 1.2fr 1fr;
			gap: 30px;
		}

		@media (max-width: 768px) {
			.ad-form-grid {
				grid-template-columns: 1fr;
				gap: 20px;
			}
		}

		:root {
			--primary: #6366f1;
			--primary-hover: #4f46e5;
			--bg-dark: #0f172a;
			--card-bg: rgba(30, 41, 59, 0.7);
			--glass-border: rgba(255, 255, 255, 0.1);
			--text-main: #ffffff;
			--text-muted: #cbd5e1;
			--success: #22c55e;
			--warning: #f59e0b;
			--danger: #ef4444;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
			text-rendering: optimizeLegibility;
			-webkit-font-smoothing: antialiased;
			-moz-osx-font-smoothing: grayscale;
		}

		body {
			background: var(--bg-dark);
			color: var(--text-main);
			line-height: 1.6;
			overflow-x: hidden;
			-webkit-text-size-adjust: 100%;
		}

		/* Loader */
		#loader {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: var(--bg-dark);
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			z-index: 9999;
		}

		.spinner {
			width: 50px;
			height: 50px;
			border: 5px solid rgba(99, 102, 241, 0.1);
			border-top-color: var(--primary);
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			to {
				transform: rotate(360deg);
			}
		}

		/* Forbidden Screen */
		.forbidden {
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			height: 100vh;
			text-align: center;
			padding: 20px;
		}

		.forbidden i {
			font-size: 5rem;
			color: var(--danger);
			margin-bottom: 20px;
		}

		/* App Container */
		#app {
			display: none;
			padding: 40px 20px;
			max-width: 1400px;
			margin: 0 auto;
		}

		header {
			margin-bottom: 40px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.logo-area h1 {
			font-size: 1.8rem;
			font-weight: 800;
			letter-spacing: -1px;
			background: linear-gradient(to right, #fff, var(--primary));
			-webkit-background-clip: text;
			background-clip: text;
			-webkit-text-fill-color: transparent;
		}

		/* Stats Grid */
		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
			gap: 20px;
			margin-bottom: 30px;
		}

		.stat-card {
			background: var(--card-bg);
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			padding: 25px;
			display: flex;
			align-items: center;
			gap: 20px;
			backdrop-filter: blur(10px);
		}

		.stat-icon {
			width: 60px;
			height: 60px;
			border-radius: 15px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.5rem;
		}

		/* Main Table Card */
		.main-card {
			background: var(--card-bg);
			border: 1px solid var(--glass-border);
			border-radius: 24px;
			overflow: hidden;
			backdrop-filter: blur(12px);
			box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
		}

		.card-header {
			padding: 25px;
			border-bottom: 1px solid var(--glass-border);
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.search-box {
			position: relative;
			width: 100%;
			max-width: 350px;
		}

		.search-box input {
			width: 100%;
			padding: 12px 15px 12px 45px;
			background: rgba(0, 0, 0, 0.3);
			border: 1px solid var(--glass-border);
			border-radius: 12px;
			color: white;
			outline: none;
		}

		.search-box i {
			position: absolute;
			left: 18px;
			top: 50%;
			transform: translateY(-50%);
			color: var(--text-muted);
		}

		/* Table Styles */
		.table-container {
			overflow-x: auto;
		}

		table {
			width: 100%;
			border-collapse: collapse;
		}

		th {
			padding: 20px 25px;
			text-align: left;
			background: rgba(255, 255, 255, 0.03);
			font-size: 0.8rem;
			text-transform: uppercase;
			letter-spacing: 1px;
			color: var(--text-muted);
		}

		td {
			padding: 20px 25px;
			border-bottom: 1px solid var(--glass-border);
			vertical-align: middle;
		}

		tr:hover {
			background: rgba(255, 255, 255, 0.02);
		}

		/* User Cell */
		.user-cell {
			display: flex;
			align-items: center;
			gap: 15px;
		}

		.user-avatar {
			width: 45px;
			height: 45px;
			border-radius: 12px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 700;
			color: white;
			background: var(--primary);
		}

		/* Badges */
		.badge {
			padding: 4px 10px;
			border-radius: 6px;
			font-size: 0.75rem;
			font-weight: 700;
		}

		.badge-pro {
			background: rgba(99, 102, 241, 0.15);
			color: var(--primary);
			border: 1px solid rgba(99, 102, 241, 0.3);
		}

		.badge-free {
			background: rgba(148, 163, 184, 0.1);
			color: var(--text-muted);
			border: 1px solid rgba(148, 163, 184, 0.2);
		}

		.badge-basic {
			background: rgba(34, 197, 94, 0.15);
			color: var(--success);
			border: 1px solid rgba(34, 197, 94, 0.3);
		}

		/* Buttons */
		.btn-action {
			width: 38px;
			height: 38px;
			border-radius: 10px;
			border: none;
			cursor: pointer;
			transition: 0.2s;
			background: rgba(255, 255, 255, 0.05);
			color: white;
			margin: 0 2px;
		}

		.btn-edit:hover {
			background: var(--primary);
		}

		.btn-lock:hover {
			background: var(--danger);
		}

		.btn-ad:hover {
			background: #a855f7;
		}

		.btn-bulk-ad {
			background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
			color: white;
			border: none;
			padding: 10px 20px;
			border-radius: 12px;
			font-weight: 700;
			cursor: pointer;
			display: flex;
			align-items: center;
			gap: 8px;
			transition: 0.3s;
			box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
		}

		.btn-bulk-ad:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 20px rgba(168, 85, 247, 0.4);
		}

		/* Checkbox custom */
		.checkbox-wrapper {
			display: flex;
			align-items: center;
			justify-content: center;
		}

		input[type="checkbox"] {
			width: 18px;
			height: 18px;
			cursor: pointer;
			accent-color: var(--primary);
		}

		.btn-submit {
			background: var(--primary);
			color: white;
			border: none;
			padding: 12px 25px;
			border-radius: 12px;
			font-weight: 700;
			cursor: pointer;
			width: 100%;
		}

		/* Modal */
		.modal {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 1000;
			padding: 20px;
		}

		.modal.active {
			display: flex;
		}

		.modal-content {
			background: #1e293b;
			width: 100%;
			max-width: 500px;
			border-radius: 24px;
			padding: 30px 20px;
			border: 1px solid var(--glass-border);
			position: relative;
		}

		.form-group {
			margin-bottom: 20px;
		}

		.form-group label {
			display: block;
			font-size: 0.85rem;
			color: var(--text-muted);
			margin-bottom: 8px;
		}

		select,
		input {
			width: 100%;
			padding: 12px 18px;
			border-radius: 10px;
			background: rgba(0, 0, 0, 0.2);
			border: 1px solid var(--glass-border);
			color: white;
			outline: none;
		}

		/* Toggle Switch */
		.switch {
			position: relative;
			display: inline-block;
			width: 44px;
			height: 22px;
			cursor: pointer;
		}

		.switch input {
			position: absolute;
			opacity: 0;
			width: 100%;
			height: 100%;
			top: 0;
			left: 0;
			margin: 0;
			cursor: pointer;
			z-index: 2;
		}

		.slider {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: rgba(255, 255, 255, 0.1);
			transition: .4s;
			border-radius: 34px;
			border: 1px solid var(--glass-border);
			z-index: 1;
		}

		.slider:before {
			position: absolute;
			content: "";
			height: 16px;
			width: 16px;
			left: 3px;
			bottom: 2px;
			background-color: white;
			transition: .4s;
			border-radius: 50%;
		}

		input:checked+.slider {
			background-color: var(--primary);
		}

		input:checked+.slider:before {
			transform: translateX(22px);
		}

		.switch.updating {
			opacity: 0.5;
			pointer-events: none;
		}

		/* Timer Input */
		.timer-input {
			background: rgba(0, 0, 0, 0.3) !important;
			border: 1px solid var(--glass-border) !important;
			border-radius: 8px !important;
			padding: 4px 8px !important;
			font-size: 0.75rem !important;
			width: 110px !important;
			margin-left: 10px;
			color: var(--text-muted);
		}

		.timer-input:focus {
			border-color: var(--primary) !important;
			color: white;
		}

		/* Master Tabs */
		.tab-btn-master {
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid var(--glass-border);
			color: var(--text-muted);
			padding: 10px 20px;
			border-radius: 12px;
			cursor: pointer;
			font-weight: 700;
			transition: 0.3s;
		}

		.tab-btn-master.active {
			background: var(--primary);
			color: white;
			border-color: var(--primary);
			box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
		}

		.master-tab-content {
			display: none;
			animation: fadeIn 0.4s ease-out;
		}

		.master-tab-content.active {
			display: block;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(10px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		@media (max-width: 768px) {
			header {
				flex-direction: column;
				gap: 20px;
				text-align: center;
			}

			header div[style*="display: flex"] {
				flex-direction: column;
				width: 100%;
			}

			.card-header {
				flex-direction: column;
				gap: 15px;
				align-items: stretch;
			}

			.search-box {
				max-width: none;
			}

			.stat-card {
				padding: 15px;
				gap: 15px;
			}

			.stat-icon {
				width: 45px;
				height: 45px;
				font-size: 1.2rem;
			}

			th,
			td {
				padding: 12px 10px;
				font-size: 0.8rem;
			}

			#app {
				padding: 20px 10px;
			}
		}

		.feature-th {
			font-size: 0.65rem !important;
			padding: 10px 5px !important;
			text-align: center !important;
		}

		/* Chat Master Styles */
		.convo-item {
			padding: 15px 20px;
			cursor: pointer;
			display: flex;
			align-items: center;
			gap: 15px;
			transition: 0.2s;
			border-bottom: 1px solid rgba(255, 255, 255, 0.03);
		}

		.convo-item:hover {
			background: rgba(99, 102, 241, 0.05);
		}

		.convo-item.active {
			background: rgba(99, 102, 241, 0.1);
			border-left: 4px solid var(--primary);
		}

		.convo-info {
			flex: 1;
			overflow: hidden;
		}

		.convo-email {
			font-weight: 700;
			font-size: 0.9rem;
			margin-bottom: 4px;
			color: #fff;
		}

		.convo-last {
			font-size: 0.75rem;
			color: var(--text-muted);
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.msg-bubble {
			padding: 12px 18px;
			border-radius: 18px;
			font-size: 0.9rem;
			max-width: 70%;
			position: relative;
			animation: slideUp 0.3s ease-out;
		}

		.msg-bubble.user {
			background: #334155;
			align-self: flex-start;
			border-bottom-left-radius: 4px;
		}

		.msg-bubble.admin {
			background: var(--primary);
			align-self: flex-end;
			border-bottom-right-radius: 4px;
		}

		.msg-bubble img {
			max-width: 100%;
			border-radius: 10px;
			margin-bottom: 8px;
			display: block;
		}

		.msg-bubble .msg-actions {
			position: absolute;
			top: -10px;
			right: -10px;
			display: none;
			gap: 5px;
		}

		.msg-bubble:hover .msg-actions {
			display: flex;
		}

		.btn-msg-sub {
			width: 24px;
			height: 24px;
			border-radius: 50%;
			border: none;
			background: #1e293b;
			color: white;
			cursor: pointer;
			font-size: 0.7rem;
			display: flex;
			align-items: center;
			justify-content: center;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
		}

		.btn-msg-sub:hover {
			background: var(--danger);
		}
	</style>
</head>

<body>

	<div id="loader">
		<div class="spinner"></div>
		<p style="margin-top: 20px; color: var(--text-muted);">ƒêang k·∫øt n·ªëi Master Core...</p>
	</div>

	<div id="app">
		<header>
			<div class="logo-area">
				<h1>Qu·∫£n Tr·ªã H·ªá Th·ªëng</h1>
				<p style="color: var(--text-muted);">H·ªá th·ªëng Qu·∫£n l√Ω T√†i kho·∫£n To√†n c·∫ßu</p>
			</div>
			<div style="display: flex; gap: 10px; align-items: center;">
				<div class="tabs-header" style="display: flex; gap: 10px; margin-right: 20px;">
					<button class="tab-btn-master active" onclick="switchMasterTab('users', event)">üë• Qu·∫£n l√Ω Ng∆∞·ªùi
						d√πng</button>
					<button class="tab-btn-master" onclick="switchMasterTab('chat', event)">üí¨ H·ªó tr·ª£ tr·ª±c
						tuy·∫øn</button>
				</div>
				<button class="btn-action" onclick="loadAdminData()" title="L√†m m·ªõi"><i
						class="fas fa-sync-alt"></i></button>
				<button class="btn-action" onclick="location.href='index.html'" title="V·ªÅ trang ch·ªß"><i
						class="fas fa-sign-out-alt"></i></button>
			</div>
		</header>

		<div class="stats-grid">
			<div class="stat-card">
				<div class="stat-icon" style="background: rgba(99, 102, 241, 0.1); color: var(--primary);"><i
						class="fas fa-users"></i></div>
				<div class="stat-info">
					<h3>T·ªïng T√†i Kho·∫£n</h3>
					<p id="stat_total" style="font-size: 1.5rem; font-weight: 800;">0</p>
				</div>
			</div>
			<div class="stat-card">
				<div class="stat-icon" style="background: rgba(34, 197, 94, 0.1); color: var(--success);"><i
						class="fas fa-user-tie"></i></div>
				<div class="stat-info">
					<h3>Qu·∫£n tr·ªã (Admin)</h3>
					<p id="stat_admins" style="font-size: 1.5rem; font-weight: 800;">0</p>
				</div>
			</div>
			<div class="stat-card">
				<div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: var(--warning);"><i
						class="fas fa-user-tag"></i></div>
				<div class="stat-info">
					<h3>Nh√¢n s·ª± / M·ªì c√¥i</h3>
					<p id="stat_staff" style="font-size: 1.5rem; font-weight: 800;">0</p>
				</div>
			</div>
			<div class="stat-card">
				<div class="stat-icon" style="background: rgba(239, 68, 68, 0.1); color: var(--danger);"><i
						class="fas fa-user-slash"></i></div>
				<div class="stat-info">
					<h3>B·ªã Kh√≥a</h3>
					<p id="stat_locked" style="font-size: 1.5rem; font-weight: 800;">0</p>
				</div>
			</div>
		</div>

	</div>

	<div id="tab-users" class="master-tab-content active">
		<div class="main-card">
			<div class="card-header">
				<div style="font-weight: 700; font-size: 1.1rem;"><i class="fas fa-list-ul"
						style="color: var(--primary); margin-right: 10px;"></i> Danh s√°ch Ng∆∞·ªùi d√πng</div>
				<div style="display: flex; gap: 15px; align-items: center;">
					<button class="btn-bulk-ad" onclick="openBulkAdModal()">
						<i class="fas fa-bullhorn"></i> Marketing H√†ng Lo·∫°t
					</button>
					<div class="search-box">
						<i class="fas fa-search"></i>
						<input type="text" id="masterSearch" placeholder="T√¨m email, ID, ho·∫∑c ch·ªß qu·∫£n..."
							oninput="filterTable()">
					</div>
				</div>
			</div>
			<div class="table-container">
				<table>
					<thead>
						<tr>
							<th width="40">
								<div class="checkbox-wrapper">
									<input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)">
								</div>
							</th>
							<th>T√ÄI KHO·∫¢N & ID</th>
							<th>LO·∫†I TK</th>
							<th>CH·ª¶ QU·∫¢N</th>
							<th>VAI TR√í / G√ìI</th>
							<th>NG√ÄY T·∫†O</th>
							<th>TR·∫†NG TH√ÅI</th>
							<th style="text-align: center;">M·ªû KH√ìA CHECK-IN</th>
							<th style="text-align: center;">M·ªû KH√ìA MAIL NV</th>
							<th style="text-align: center;">M·ªû KH√ìA MAIL ADMIN</th>
							<th style="text-align: center;">M·ªû KH√ìA C√îNG N·ª¢</th>
							<th style="text-align: center;">M·ªû KH√ìA T·∫†O SP</th>
							<th style="text-align: center;">M·ªû KH√ìA NH·∫¨P KHO</th>
							<th style="text-align: center;">M·ªû KH√ìA XU·∫§T KHO</th>
							<th style="text-align: center;">M·ªû KH√ìA GIAO H√ÄNG</th>
							<th style="text-align: center;">M·ªû KH√ìA QU·∫¢N L√ù NS</th>
							<th style="text-align: center; color: #a855f7;">M·ªû KH√ìA PH√ÇN T√çCH GI√Å</th>
							<th style="text-align: center; color: #22c55e;">M·ªû KH√ìA B√ÅO C√ÅO L·ª¢I NHU·∫¨N</th>
							<th style="text-align: center;">NG·∫ÆT K·∫æT N·ªêI</th>
							<th style="text-align: center; white-space: nowrap;">H·∫†N CH·∫æ B√ÅO C√ÅO</th>
						</tr>
					</thead>
					<tbody id="masterTableBody">
						<!-- Render results here -->
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<div id="tab-chat" class="master-tab-content">
		<div class="main-card chat-master-container" style="height: calc(100vh - 250px); display: flex;">
			<!-- Sidebar: Convo List -->
			<div class="chat-sidebar"
				style="width: 320px; border-right: 1px solid var(--glass-border); display: flex; flex-direction: column;">
				<div style="padding: 20px; border-bottom: 1px solid var(--glass-border);">
					<div class="search-box" style="max-width: none;">
						<i class="fas fa-search"></i>
						<input type="text" placeholder="T√¨m h·ªôi tho·∫°i..." oninput="filterConvos(this.value)">
					</div>
				</div>
				<div id="convoList" style="flex: 1; overflow-y: auto;">
					<!-- Convo items -->
				</div>
			</div>

			<!-- Main: Chat Window -->
			<div class="chat-main" style="flex: 1; display: flex; flex-direction: column; background: rgba(0,0,0,0.1);">
				<div id="chatDefaultMsg"
					style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted);">
					<i class="fas fa-comments" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.2;"></i>
					<p>Ch·ªçn m·ªôt h·ªôi tho·∫°i ƒë·ªÉ b·∫Øt ƒë·∫ßu h·ªó tr·ª£</p>
				</div>

				<div id="chatContentArea" style="display: none; flex: 1; flex-direction: column; overflow: hidden;">
					<div class="chat-header"
						style="padding: 15px 25px; background: rgba(255,255,255,0.02); border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
						<div style="display: flex; align-items: center; gap: 15px;">
							<div id="activeUserAvatar" class="user-avatar" style="width: 40px; height: 40px;">?</div>
							<div>
								<div id="activeUserEmail" style="font-weight: 700; font-size: 0.95rem;">
									email@example.com</div>
								<div style="font-size: 0.75rem; color: var(--success);">ƒêang k·∫øt n·ªëi</div>
							</div>
						</div>
						<button class="btn-action" onclick="loadAllConversations()" title="L√†m m·ªõi"><i
								class="fas fa-sync-alt"></i></button>
					</div>

					<div id="masterChatBody"
						style="flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 15px;">
						<!-- Messages load here -->
					</div>

					<!-- Image Preview -->
					<div id="masterImgPreview"
						style="display: none; padding: 10px 25px; background: rgba(0,0,0,0.2); border-top: 1px solid var(--glass-border); position: relative;">
						<img src="" style="height: 80px; border-radius: 8px;">
						<button onclick="removeMasterSelectedImg()"
							style="position: absolute; top: 5px; right: 25px; background: var(--danger); border: none; color: white; border-radius: 50%; width: 22px; height: 22px; cursor: pointer;">√ó</button>
					</div>

					<div class="chat-footer" style="padding: 20px 25px; border-top: 1px solid var(--glass-border);">
						<div style="display: flex; gap: 15px; align-items: center;">
							<button class="btn-action" onclick="document.getElementById('masterImgUpload').click()">
								<i class="fas fa-image"></i>
							</button>
							<input type="file" id="masterImgUpload" hidden accept="image/*"
								onchange="previewMasterImg(this)">

							<div style="flex: 1; position: relative;">
								<input type="text" id="masterChatInput" placeholder="Nh·∫≠p tin nh·∫Øn ph·∫£n h·ªìi..."
									style="padding-right: 50px;" onkeypress="if(event.key==='Enter') sendMasterReply()">
							</div>

							<button class="btn-bulk-ad" onclick="sendMasterReply()" style="padding: 10px 25px;">
								G·ª¨I <i class="fas fa-paper-plane" style="margin-left: 8px;"></i>
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	</div>
	</div>
	</div>

	<div id="editModal" class="modal">
		<div class="modal-content">
			<h2 style="margin-bottom: 10px;">C·∫•u h√¨nh T√†i kho·∫£n</h2>
			<p id="editDisplay" style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 25px;"></p>
			<form id="editForm">
				<input type="hidden" id="edit_email">
				<div class="form-group">
					<label>G√≥i C∆∞·ªõc / Ph√¢n h·∫°ng</label>
					<select id="edit_package">
						<option value="Free">Mi·ªÖn ph√≠ (Free)</option>
						<option value="Basic">C∆° b·∫£n (Basic)</option>
						<option value="Premium">Cao c·∫•p (Premium)</option>
					</select>
				</div>
				<div class="form-group">
					<label>H·∫°n B√°o c√°o Doanh thu</label>
					<input type="date" id="edit_expiry">
				</div>
				<div class="form-group">
					<label>Tr·∫°ng th√°i</label>
					<select id="edit_status">
						<option value="Ho·∫°t ƒë·ªông">Ho·∫°t ƒë·ªông</option>
						<option value="T·∫°m kh√≥a">T·∫°m kh√≥a</option>
					</select>
				</div>
				<div style="display: flex; gap: 10px; margin-top: 30px;">
					<button type="submit" class="btn-submit">L∆ØU C·∫§U H√åNH</button>
					<button type="button" class="btn-submit" style="background: rgba(255,255,255,0.05);"
						onclick="closeModal()">ƒê√ìNG</button>
				</div>
			</form>
		</div>
	</div>

	<!-- MODAL QU·∫¢NG C√ÅO N√ÇNG C·∫§P -->
	<div id="adModal" class="modal">
		<div class="modal-content"
			style="max-width: 800px; padding: 0; background: #1e293b; border: 1px solid rgba(168, 85, 247, 0.3);">
			<div
				style="padding: 30px; background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%); border-bottom: 1px solid rgba(255,255,255,0.05);">
				<h2 id="adDisplay" style="color: #a855f7; display: flex; align-items: center; gap: 15px;">
					<div
						style="width: 50px; height: 50px; background: #a855f722; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
						<i class="fas fa-bullhorn"></i>
					</div>
					G·ª≠i Chi·∫øn D·ªãch Marketing
				</h2>
			</div>

			<form id="adForm" style="padding: 20px;">
				<div class="ad-form-grid">
					<!-- C·ªôt tr√°i: N·ªôi dung -->
					<div>
						<input type="hidden" id="ad_emails">
						<div class="form-group">
							<label>G·ª≠i ƒë·∫øn:</label>
							<div id="targetEmailsList"
								style="font-size: 0.8rem; color: #a855f7; background: #00000033; padding: 10px; border-radius: 8px; max-height: 100px; overflow-y: auto;">
							</div>
						</div>
						<div class="form-group">
							<label>Ti√™u ƒë·ªÅ Email Marketing</label>
							<input type="text" id="ad_title"
								placeholder="V√≠ d·ª•: üî• [SI√äU ∆ØU ƒê√ÉI] N√¢ng c·∫•p Premium ch·ªâ 99k/th√°ng!" required>
						</div>
						<div class="form-group">
							<label>N·ªôi dung thuy·∫øt ph·ª•c ng∆∞·ªùi d√πng</label>
							<textarea id="ad_content" rows="8"
								placeholder="So·∫°n n·ªôi dung t·∫°i ƒë√¢y. H·ªá th·ªëng t·ª± ƒë·ªông k√®m n√∫t 'N√ÇNG C·∫§P' v√† banner b√™n d∆∞·ªõi..."
								required></textarea>
						</div>
					</div>

					<!-- C·ªôt ph·∫£i: H√¨nh ·∫£nh & H·∫πn gi·ªù -->
					<div>
						<div class="form-group">
							<label>H√¨nh ·∫£nh Banner (T·∫£i tr·ª±c ti·∫øp)</label>
							<div
								style="background: rgba(255,255,255,0.02); border: 2px dashed rgba(168, 85, 247, 0.3); border-radius: 15px; padding: 20px; text-align: center;">
								<input type="file" id="ad_file" accept="image/*" style="display: none;"
									onchange="handleAdFileSelect(this)">
								<div id="ad_preview_container" style="display: none; margin-bottom: 15px;">
									<img id="ad_preview"
										style="width: 100%; height: 180px; object-fit: cover; border-radius: 10px; border: 1px solid #a855f755;">
								</div>
								<button type="button" class="btn-bulk-ad"
									onclick="document.getElementById('ad_file').click()"
									style="width: 100%; justify-content: center;">
									<i class="fas fa-image"></i> Ch·ªçn H√¨nh ·∫¢nh
								</button>
								<p id="ad_fileName"
									style="font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">∆Øu ti√™n ·∫£nh
									t·ª∑ l·ªá 16:9</p>
							</div>
						</div>

						<div
							style="background: rgba(255,255,255,0.03); border-radius: 15px; padding: 20px; border: 1px solid rgba(255,255,255,0.05);">
							<label
								style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px; font-weight: 700; color: #22c55e;">
								<i class="fas fa-clock"></i> Ch·∫ø ƒë·ªô g·ª≠i b√†i
							</label>
							<div class="form-group">
								<select id="send_mode" onchange="toggleSchedule(this.value)">
									<option value="now">G·ª≠i ngay b√¢y gi·ªù</option>
									<option value="schedule">H·∫πn gi·ªù t·ª± ƒë·ªông</option>
								</select>
							</div>
							<div id="schedule_inputs" style="display: none; grid-template-columns: 1fr 1fr; gap: 10px;">
								<div class="form-group" style="margin: 0;">
									<input type="date" id="schedule_date">
								</div>
								<div class="form-group" style="margin: 0;">
									<input type="time" id="schedule_time">
								</div>
							</div>
						</div>
					</div>
				</div>

				<div
					style="display: flex; gap: 15px; margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 25px;">
					<button type="button" class="btn-submit" onclick="closeAdModal()"
						style="background: rgba(255,255,255,0.05); flex: 1;">H·ª¶Y B·ªé</button>
					<button type="submit" class="btn-submit"
						style="background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%); flex: 2; height: 50px; font-size: 1.1rem;">
						<i class="fas fa-paper-plane" style="margin-right: 10px;"></i> X√ÅC NH·∫¨N CHI·∫æN D·ªäCH
					</button>
				</div>
			</form>
		</div>
	</div>

	<script>
		// ƒê√É ƒê·ªíNG B·ªò URL V·ªöI H·ªÜ TH·ªêNG AUTH (S·ª≠a l·ªói 404 & CORS)
		const MASTER_API = 'https://script.google.com/macros/s/AKfycbz2FpV9hWeZKzBJyS636Hlf7JrM8bfA03YbH9xF3KYqdHJXcpgvCLoD2xjOGCDKzpfj/exec';
		const MASTER_EMAIL = 'dunvex.green@gmail.com';
		let clientIP = 'N/A';

		async function fetchIP() {
			try {
				const res = await fetch('https://api.ipify.org?format=json');
				const data = await res.json();
				clientIP = data.ip;
			} catch (e) { console.warn("Kh√¥ng th·ªÉ l·∫•y IP"); }
		}

		let allUsers = [];

		window.onload = function () {
			fetchIP();
			const user = JSON.parse(localStorage.getItem('user'));
			setTimeout(() => {
				document.getElementById('loader').style.display = 'none';
				if (!user || user.email !== MASTER_EMAIL) {
					document.body.innerHTML = `
                        <div class="forbidden">
                            <i class="fas fa-shield-slash"></i>
                            <h1>TRUY C·∫¨P B·ªä T·ª™ CH·ªêI</h1>
                            <p style="margin-top: 15px; color: var(--text-muted);">T√†i kho·∫£n c·ªßa b·∫°n (${user ? user.email : 'Guest'}) kh√¥ng c√≥ quy·ªÅn s·ªü h·ªØu Master Key.</p>
                            <a href="index.html" class="btn-submit" style="max-width: 200px; text-decoration: none; margin-top: 30px;">V·ªÄ TRANG CH·ª¶</a>
                        </div>
                    `;
					return;
				}
				document.getElementById('app').style.display = 'block';
				loadAdminData();
			}, 800);
		};

		async function loadAdminData() {
			try {
				const res = await fetch(MASTER_API, {
					method: 'POST',
					body: JSON.stringify({ action: 'getMasterAllAccounts' })
				});
				const data = await res.json();
				if (data.success) {
					allUsers = data.users;
					renderTable(allUsers);
					updateStats();
				} else {
					alert("L·ªói Backend: " + data.message);
				}
			} catch (e) {
				console.error(e);
				alert("L·ªñI K·∫æT N·ªêI (CORS):\n1. Vui l√≤ng ki·ªÉm tra l·∫°i URL MASTER_API trong m√£ ngu·ªìn.\n2. ƒê·∫£m b·∫£o Google Apps Script ƒë√£ ƒë∆∞·ª£c Deploy ch√≠nh x√°c (Anyone has access).\n3. N·∫øu ƒëang ph√°t tri·ªÉn, h√£y ƒë·∫£m b·∫£o URL Script kh√¥ng b·ªã ch·∫∑n.");
			}
		}

		function renderTable(data) {
			const body = document.getElementById('masterTableBody');

			// Render User Table
			body.innerHTML = data.map(u => {
				const f = u.features || {};
				const typeBadge = u.type === 'ADMIN' ? 'badge-pro' : (u.type === 'STAFF' ? 'badge-basic' : 'badge-free');
				const statusColor = u.status === 'Ho·∫°t ƒë·ªông' ? 'var(--success)' : 'var(--danger)';
				const roleDisplay = u.type === 'ADMIN' ? u.package : u.roleId;

				return `
                    <tr>
						<td>
							<div class="checkbox-wrapper">
								<input type="checkbox" class="user-select" value="${u.email}">
							</div>
						</td>
                        <td>
                            <div class="user-cell">
                                <div class="user-avatar" style="background: ${u.type === 'ADMIN' ? 'var(--primary)' : '#475569'}">${u.email.charAt(0).toUpperCase()}</div>
                                <div>
                                    <div style="font-weight: 700;">${u.email}</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">${u.fullName} | ID: ${u.id}</div>
                                </div>
                            </div>
                        </td>
                        <td><span class="badge ${typeBadge}">${u.type}</span></td>
                        <td>
                            <div style="font-size: 0.8rem; color: ${u.owner.includes('@') ? 'var(--primary)' : 'var(--danger)'}">
                                ${u.owner}
                            </div>
                        </td>
                        <td><span style="font-weight: 600; color: var(--text-muted);">${roleDisplay}</span></td>
                        <td><span style="font-size: 0.85rem;">${new Date(u.regDate).toLocaleDateString('vi-VN')}</span></td>
                        <td><span class="badge" style="color: ${statusColor}; border: 1px solid ${statusColor}33; background: ${statusColor}11;">${u.status}</span></td>
                        <td style="text-align: center;">
							<label class="switch">
								<input type="checkbox" ${f.checkinMaster === true ? 'checked' : ''} onchange="updateFeatureLock('${u.email}', 'checkinMaster', this)">
								<span class="slider"></span>
							</label>
                        </td>
                        <td style="text-align: center;">
							<label class="switch">
								<input type="checkbox" ${f.mailStaff === true ? 'checked' : ''} onchange="updateFeatureLock('${u.email}', 'mailStaff', this)">
								<span class="slider"></span>
							</label>
                        </td>
                        <td style="text-align: center;">
							<label class="switch">
								<input type="checkbox" ${f.mailAdmin === true ? 'checked' : ''} onchange="updateFeatureLock('${u.email}', 'mailAdmin', this)">
								<span class="slider"></span>
							</label>
                        </td>
                        <td style="text-align: center;">
							<label class="switch">
								<input type="checkbox" ${f.debtMaster === true ? 'checked' : ''} onchange="updateFeatureLock('${u.email}', 'debtMaster', this)">
								<span class="slider"></span>
							</label>
                        </td>
                        <td style="text-align: center;">
							<label class="switch">
								<input type="checkbox" ${f.productCreateMaster === true ? 'checked' : ''} onchange="updateFeatureLock('${u.email}', 'productCreateMaster', this)">
								<span class="slider"></span>
							</label>
                        </td>
                        <td style="text-align: center;">
							<label class="switch">
								<input type="checkbox" ${f.inventoryMaster === true ? 'checked' : ''} onchange="updateFeatureLock('${u.email}', 'inventoryMaster', this)">
								<span class="slider"></span>
							</label>
                        </td>
                        <td style="text-align: center;">
							<label class="switch">
								<input type="checkbox" ${f.warehouseMaster === true ? 'checked' : ''} onchange="updateFeatureLock('${u.email}', 'warehouseMaster', this)">
								<span class="slider"></span>
							</label>
                        </td>
						<td style="text-align: center;">
							<label class="switch">
								<input type="checkbox" ${f.deliveryMaster === true ? 'checked' : ''} onchange="updateFeatureLock('${u.email}', 'deliveryMaster', this)">
								<span class="slider"></span>
							</label>
                        </td>
						<td style="text-align: center;">
							<label class="switch">
								<input type="checkbox" ${f.hrMaster === true ? 'checked' : ''} onchange="updateFeatureLock('${u.email}', 'hrMaster', this)">
								<span class="slider"></span>
							</label>
                        </td>
						<td style="text-align: center;">
							<label class="switch">
								<input type="checkbox" ${f.priceAnalysisMaster === true ? 'checked' : ''} onchange="updateFeatureLock('${u.email}', 'priceAnalysisMaster', this)">
								<span class="slider"></span>
							</label>
                        </td>
						<td style="text-align: center;">
							<label class="switch">
								<input type="checkbox" ${f.profitMaster === true ? 'checked' : ''} onchange="updateFeatureLock('${u.email}', 'profitMaster', this)">
								<span class="slider"></span>
							</label>
                        </td>
                         <td style="text-align: center;">
                            <button class="btn-action btn-lock" title="Kh√≥a/M·ªü Truy C·∫≠p" onclick="toggleLock('${u.email}')" style="width: 45px; height: 45px; font-size: 1.1rem;">
								<i class="fas fa-power-off"></i>
							</button>
                        </td>
						<td style="text-align: center;">
							<div style="display: flex; align-items: center; justify-content: center;">
								<label class="switch">
									<input type="checkbox" ${u.salesRestrict === 'ON' ? 'checked' : ''} 
										onchange="updateRestriction('${u.email}', this)">
									<span class="slider"></span>
								</label>
								<input type="date" class="timer-input" 
									value="${u.restrictTimer ? u.restrictTimer.substring(0, 10) : ''}" 
									onchange="updateRestrictionTimer('${u.email}', this)"
									title="H·∫πn gi·ªù t·ª± ƒë·ªông b·∫≠t/t·∫Øt">
							</div>
						</td>
                    </tr>
                `;
			}).join('');
		}

		function renderFeatureToggle(email, key, val) {
			return `
				<td style="text-align: center;">
					<label class="switch">
						<input type="checkbox" ${val === true ? 'checked' : ''} onchange="updateFeatureLock('${email}', '${key}', this)">
						<span class="slider"></span>
					</label>
				</td>
			`;
		}

		async function updateFeatureLock(email, key, cb) {
			const label = cb.parentElement;
			label.classList.add('updating');
			const state = cb.checked;
			const payload = {
				action: 'updateAdminConfig',
				adminEmail: email,
				features: { [key]: state },
				ip: clientIP
			};
			try {
				const res = await fetch(MASTER_API, { method: 'POST', body: JSON.stringify(payload) });
				const data = await res.json();
				if (!data.success) {
					alert("‚ùå L·ªói: " + data.message);
					cb.checked = !cb.checked;
				}
			} catch (e) {
				alert("‚ùå L·ªói k·∫øt n·ªëi API Master");
				cb.checked = !cb.checked;
			} finally {
				label.classList.remove('updating');
			}
		}

		function switchMasterTab(tabId, e) {
			document.querySelectorAll('.master-tab-content').forEach(el => el.classList.remove('active'));
			document.querySelectorAll('.tab-btn-master').forEach(el => el.classList.remove('active'));
			document.getElementById('tab-' + tabId).classList.add('active');
			if (e) e.currentTarget.classList.add('active');
		}

		function updateStats() {
			document.getElementById('stat_total').innerText = allUsers.length;
			document.getElementById('stat_admins').innerText = allUsers.filter(u => u.type === 'ADMIN').length;
			document.getElementById('stat_staff').innerText = allUsers.filter(u => u.type !== 'ADMIN').length;
			document.getElementById('stat_locked').innerText = allUsers.filter(u => u.status !== 'Ho·∫°t ƒë·ªông').length;
		}

		function filterTable() {
			const q = document.getElementById('masterSearch').value.toLowerCase();
			const filtered = allUsers.filter(u =>
				u.email.toLowerCase().includes(q) ||
				u.fullName.toLowerCase().includes(q) ||
				u.owner.toLowerCase().includes(q)
			);
			renderTable(filtered);
		}

		function editAccount(email) {
			const u = allUsers.find(x => x.email === email);
			if (!u) return;
			document.getElementById('edit_email').value = email;
			document.getElementById('editDisplay').innerText = `Tu·ª≥ ch·ªânh t√†i kho·∫£n: ${email} (${u.type})`;
			document.getElementById('edit_status').value = u.status;
			document.getElementById('edit_package').value = u.package || 'Free';

			// Format date cho input type="date"
			let expiryVal = '';
			if (u.expiry) {
				const d = new Date(u.expiry);
				if (!isNaN(d)) {
					expiryVal = d.toISOString().split('T')[0];
				}
			}
			document.getElementById('edit_expiry').value = expiryVal;

			document.getElementById('editModal').classList.add('active');
		}

		function closeModal() { document.getElementById('editModal').classList.remove('active'); }

		document.getElementById('editForm').onsubmit = async function (e) {
			e.preventDefault();
			const btn = e.target.querySelector('button[type="submit"]');
			btn.innerText = "ƒêANG L∆ØU...";

			const payload = {
				action: 'updateAdminConfig',
				adminEmail: document.getElementById('edit_email').value,
				package: document.getElementById('edit_package').value,
				expiry: document.getElementById('edit_expiry').value,
				status: document.getElementById('edit_status').value,
				ip: clientIP
			};

			try {
				const res = await fetch(MASTER_API, { method: 'POST', body: JSON.stringify(payload) });
				const data = await res.json();
				if (data.success) {
					alert("‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!");
					closeModal();
					loadAdminData();
				} else {
					alert("‚ùå L·ªói: " + data.message);
				}
			} catch (e) { alert("L·ªói k·∫øt n·ªëi API"); }
			btn.innerText = "L∆ØU C·∫§U H√åNH";
		};

		async function toggleLock(email) {
			const u = allUsers.find(x => x.email === email);
			if (!u) return;
			const newStatus = u.status === 'Ho·∫°t ƒë·ªông' ? 'T·∫°m kh√≥a' : 'Ho·∫°t ƒë·ªông';
			if (!confirm(`Chuy·ªÉn tr·∫°ng th√°i ${email} sang: ${newStatus}?`)) return;

			try {
				const res = await fetch(MASTER_API, {
					method: 'POST',
					body: JSON.stringify({ action: 'updateAdminConfig', adminEmail: email, status: newStatus, ip: clientIP })
				});
				const data = await res.json();
				if (data.success) loadAdminData();
			} catch (e) { alert("L·ªói k·∫øt n·ªëi"); }
		}

		async function updateRestriction(email, cb) {
			const state = cb.checked ? 'ON' : 'OFF';
			try {
				const res = await fetch(MASTER_API, {
					method: 'POST',
					body: JSON.stringify({
						action: 'updateAdminConfig',
						adminEmail: email,
						salesRestrict: state,
						ip: clientIP
					})
				});
				const data = await res.json();
				if (!data.success) {
					alert("L·ªói: " + data.message);
					cb.checked = !cb.checked;
				}
			} catch (e) {
				alert("L·ªói k·∫øt n·ªëi");
				cb.checked = !cb.checked;
			}
		}

		async function updateRestrictionTimer(email, input) {
			const timer = input.value;
			try {
				const res = await fetch(MASTER_API, {
					method: 'POST',
					body: JSON.stringify({
						action: 'updateAdminConfig',
						adminEmail: email,
						restrictTimer: timer,
						ip: clientIP
					})
				});
				const data = await res.json();
				if (!data.success) {
					alert("L·ªói: " + data.message);
				}
			} catch (e) {
				alert("L·ªói k·∫øt n·ªëi");
			}
		}

		// MARKETING FUNCTIONS
		let selectedAdFile = null;

		function toggleSelectAll(master) {
			const cbs = document.querySelectorAll('.user-select');
			cbs.forEach(cb => cb.checked = master.checked);
		}

		function openAdModal(email) {
			openBulkAdModal([email]);
		}

		function openBulkAdModal(emails = null) {
			if (!emails) {
				const selected = Array.from(document.querySelectorAll('.user-select:checked')).map(cb => cb.value);
				if (selected.length === 0) {
					alert("Vui l√≤ng t√≠ch ch·ªçn √≠t nh·∫•t m·ªôt ng∆∞·ªùi d√πng!");
					return;
				}
				emails = selected;
			}

			document.getElementById('ad_emails').value = emails.join(',');
			document.getElementById('targetEmailsList').innerText = emails.join(', ');
			document.getElementById('adDisplay').innerHTML = `
				<div style="width: 50px; height: 50px; background: #a855f722; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
					<i class="fas fa-bullhorn"></i>
				</div>
				Chi·∫øn D·ªãch: ${emails.length} T√†i kho·∫£n`;

			document.getElementById('ad_preview_container').style.display = 'none';
			document.getElementById('ad_fileName').innerText = '∆Øu ti√™n ·∫£nh t·ª∑ l·ªá 16:9';
			selectedAdFile = null;
			document.getElementById('adForm').reset();
			toggleSchedule('now');
			document.getElementById('adModal').classList.add('active');
		}

		function closeAdModal() { document.getElementById('adModal').classList.remove('active'); }

		function toggleSchedule(mode) {
			document.getElementById('schedule_inputs').style.display = (mode === 'schedule') ? 'grid' : 'none';
		}

		function handleAdFileSelect(input) {
			const file = input.files[0];
			if (file) {
				selectedAdFile = file;
				document.getElementById('ad_fileName').innerText = file.name;
				const reader = new FileReader();
				reader.onload = function (e) {
					const img = document.getElementById('ad_preview');
					img.src = e.target.result;
					document.getElementById('ad_preview_container').style.display = 'block';
				};
				reader.readAsDataURL(file);
			}
		}

		document.getElementById('adForm').onsubmit = async function (e) {
			e.preventDefault();
			const btn = e.target.querySelector('button[type="submit"]');
			const originalBtnText = btn.innerHTML;
			btn.innerHTML = '<i class="fas fa-sync fa-spin"></i> ƒêANG X·ª¨ L√ù...';
			btn.disabled = true;

			try {
				let finalImageUrl = "";
				if (selectedAdFile) {
					btn.innerHTML = '<i class="fas fa-cloud-upload-alt fa-spin"></i> ƒêANG T·∫¢I ·∫¢NH...';
					const base64 = await toBase64(selectedAdFile);
					const uploadRes = await fetch(MASTER_API, {
						method: 'POST',
						body: JSON.stringify({
							action: 'uploadAdImage',
							fileName: selectedAdFile.name,
							mimeType: selectedAdFile.type,
							base64Data: base64.split(',')[1]
						})
					});
					const uploadData = await uploadRes.json();
					if (uploadData.success) finalImageUrl = uploadData.url;
					else throw new Error("L·ªói t·∫£i ·∫£nh: " + uploadData.message);
				}

				const mode = document.getElementById('send_mode').value;
				const payload = {
					action: mode === 'now' ? 'sendPromotion' : 'schedulePromotion',
					targetEmails: document.getElementById('ad_emails').value.split(','),
					adTitle: document.getElementById('ad_title').value,
					adImage: finalImageUrl,
					adContent: document.getElementById('ad_content').value
				};

				if (mode === 'schedule') {
					const date = document.getElementById('schedule_date').value;
					const time = document.getElementById('schedule_time').value;
					if (!date || !time) throw new Error("Vui l√≤ng ch·ªçn th·ªùi gian h·∫πn gi·ªù!");
					payload.scheduledTime = `${date}T${time}`;
				}

				btn.innerHTML = '<i class="fas fa-paper-plane fa-spin"></i> ƒêANG TH·ª∞C THI...';
				const res = await fetch(MASTER_API, { method: 'POST', body: JSON.stringify(payload) });
				const data = await res.json();

				if (data.success) {
					alert(mode === 'now' ? "üöÄ ƒê√£ g·ª≠i th√†nh c√¥ng!" : "‚è∞ ƒê√£ h·∫πn gi·ªù th√†nh c√¥ng!");
					closeAdModal();
				} else {
					alert("‚ùå L·ªói: " + data.message);
				}
			} catch (e) {
				alert("‚ùå L·ªói: " + e.message);
			} finally {
				btn.innerHTML = originalBtnText;
				btn.disabled = false;
			}
		};

		const toBase64 = file => new Promise((resolve, reject) => {
			const reader = new FileReader();
			reader.readAsDataURL(file);
			reader.onload = () => resolve(reader.result);
			reader.onerror = error => reject(error);
		});

		// --- CHAT SYSTEM LOGIC ---
		const CHAT_BACKEND = 'https://script.google.com/macros/s/AKfycbw8gn4XKtN7XquKSEH0fDwEm2QU3PkL41kDbNZoYKcY4rQoPqkDPgq95zZl3WtLm_HjGg/exec';
		let allConvos = [];
		let activeConvo = null;
		let selectedMasterImg = null;

		function switchMasterTab(tabId, e) {
			document.querySelectorAll('.master-tab-content').forEach(el => el.classList.remove('active'));
			document.querySelectorAll('.tab-btn-master').forEach(el => el.classList.remove('active'));
			const targetTab = document.getElementById('tab-' + tabId);
			if (targetTab) targetTab.classList.add('active');
			if (e) e.currentTarget.classList.add('active');

			if (tabId === 'chat') {
				loadAllConversations();
				// B·∫Øt ƒë·∫ßu t·ª± ƒë·ªông l√†m m·ªõi m·ªói 5 gi√¢y
				if (!window.chatPollInterval) {
					window.chatPollInterval = setInterval(() => {
						const chatTab = document.getElementById('tab-chat');
						if (chatTab && chatTab.classList.contains('active')) {
							loadAllConversations();
						}
					}, 5000);
				}
			}
		}

		async function loadAllConversations() {
			try {
				const res = await fetch(CHAT_BACKEND, {
					method: 'POST',
					body: JSON.stringify({ action: 'master_get_all' })
				});
				const data = await res.json();
				if (data.success) {
					allConvos = data.conversations.sort((a, b) => new Date(b.lastTime) - new Date(a.lastTime));
					renderConvoList(allConvos);
					if (activeConvo) {
						activeConvo = allConvos.find(c => c.email === activeConvo.email);
						renderMessages();
					}
				}
			} catch (e) { console.error("Could not fetch convos", e); }
		}

		function renderConvoList(list) {
			const container = document.getElementById('convoList');
			if (!container) return;

			// L∆∞u l·∫°i tr·∫°ng th√°i c·ªßa √¥ t√¨m ki·∫øm ƒë·ªÉ tr√°nh b·ªã m·∫•t focus khi render l·∫°i
			const searchInput = document.querySelector('.chat-sidebar input');
			const query = searchInput ? searchInput.value.toLowerCase() : "";

			const filtered = list.filter(c => c.email.toLowerCase().includes(query));

			container.innerHTML = filtered.map(c => `
				<div class="convo-item ${activeConvo && activeConvo.email === c.email ? 'active' : ''}" onclick="selectConvo('${c.email}')">
					<div class="user-avatar" style="width: 45px; height: 45px; background: #6366f122">${c.email.charAt(0).toUpperCase()}</div>
					<div class="convo-info">
						<div class="convo-email">${c.email}</div>
						<div class="convo-last">${c.lastMsg}</div>
					</div>
					<div style="font-size: 0.65rem; color: var(--text-muted);">${new Date(c.lastTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
				</div>
			`).join('');
		}

		function filterConvos(q) {
			renderConvoList(allConvos);
		}

		function selectConvo(email) {
			activeConvo = allConvos.find(c => c.email === email);
			if (!activeConvo) return;

			document.getElementById('chatDefaultMsg').style.display = 'none';
			document.getElementById('chatContentArea').style.display = 'flex';
			document.getElementById('activeUserEmail').innerText = email;
			document.getElementById('activeUserAvatar').innerText = email.charAt(0).toUpperCase();

			renderMessages();
			renderConvoList(allConvos); // refresh active state
		}

		let lastConvoMsgCount = 0;
		function renderMessages() {
			if (!activeConvo) return;
			// Ch·ªâ re-render n·∫øu s·ªë l∆∞·ª£ng tin nh·∫Øn c·ªßa h·ªôi tho·∫°i hi·ªán t·∫°i thay ƒë·ªïi
			if (activeConvo.messages.length === lastConvoMsgCount) return;

			const body = document.getElementById('masterChatBody');
			if (!body) return;
			body.innerHTML = activeConvo.messages.map(m => `
				<div class="msg-bubble ${m.type === 'admin' ? 'admin' : 'user'}">
					${m.image ? `<img src="${m.image}" onclick="window.open(this.src)">` : ''}
					${m.text ? `<div>${m.text}</div>` : ''}
					<div style="font-size: 0.6rem; opacity: 0.5; margin-top: 5px; text-align: ${m.type === 'admin' ? 'right' : 'left'}">
						${new Date(m.timestamp).toLocaleString('vi-VN')} ${m.isEdited ? '(ƒë√£ ch·ªânh s·ª≠a)' : ''}
					</div>
					${m.type === 'admin' ? `
						<div class="msg-actions">
							<button class="btn-msg-sub" onclick="editMsgUI('${m.id}', \`${m.text}\`)" title="S·ª≠a"><i class="fas fa-edit"></i></button>
							<button class="btn-msg-sub" onclick="deleteMsg('${m.id}')" title="X√≥a"><i class="fas fa-trash"></i></button>
						</div>
					` : ''}
				</div>
			`).join('');
			body.scrollTop = body.scrollHeight;
			lastConvoMsgCount = activeConvo.messages.length;
		}

		async function sendMasterReply() {
			const input = document.getElementById('masterChatInput');
			const text = input.value.trim();
			const sendBtn = document.querySelector('.chat-footer .btn-bulk-ad');

			if ((!text && !selectedMasterImg) || sendBtn.disabled) return;

			// Kh√≥a n√∫t g·ª≠i
			const originalContent = sendBtn.innerHTML;
			sendBtn.disabled = true;
			sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> G·ª¨I...';

			const payload = {
				action: 'master_reply',
				userEmail: activeConvo.email,
				text: text,
				image: ""
			};

			try {
				if (selectedMasterImg) {
					const base64 = await toBase64(selectedMasterImg);
					const uploadRes = await fetch(MASTER_API, {
						method: 'POST', body: JSON.stringify({
							action: 'uploadAdImage',
							fileName: selectedMasterImg.name,
							mimeType: selectedMasterImg.type,
							base64Data: base64.split(',')[1]
						})
					});
					const uploadData = await uploadRes.json();
					if (uploadData.success) payload.image = uploadData.url;
				}

				input.value = '';
				removeMasterSelectedImg();

				const res = await fetch(CHAT_BACKEND, { method: 'POST', body: JSON.stringify(payload) });
				const data = await res.json();
				if (data.success) {
					loadAllConversations();
				}
			} catch (e) {
				alert("L·ªói g·ª≠i tin nh·∫Øn");
			} finally {
				sendBtn.disabled = false;
				sendBtn.innerHTML = originalContent;
			}
		}

		async function deleteMsg(id) {
			if (!confirm("X√≥a tin nh·∫Øn n√†y?")) return;
			try {
				await fetch(CHAT_BACKEND, { method: 'POST', body: JSON.stringify({ action: 'delete_msg', msgId: id }) });
				loadAllConversations();
			} catch (e) { }
		}

		function editMsgUI(id, oldText) {
			const newText = prompt("Nh·∫≠p n·ªôi dung m·ªõi:", oldText);
			if (newText === null || newText === oldText) return;
			editMsg(id, newText);
		}

		async function editMsg(id, text) {
			try {
				await fetch(CHAT_BACKEND, { method: 'POST', body: JSON.stringify({ action: 'edit_msg', msgId: id, newText: text }) });
				loadAllConversations();
			} catch (e) { }
		}

		function previewMasterImg(input) {
			if (input.files[0]) {
				selectedMasterImg = input.files[0];
				const reader = new FileReader();
				reader.onload = e => {
					const previewImg = document.querySelector('#masterImgPreview img');
					if (previewImg) previewImg.src = e.target.result;
					document.getElementById('masterImgPreview').style.display = 'block';
				};
				reader.readAsDataURL(input.files[0]);
			}
		}

		function removeMasterSelectedImg() {
			selectedMasterImg = null;
			document.getElementById('masterImgUpload').value = '';
			document.getElementById('masterImgPreview').style.display = 'none';
		}
	</script>
</body>

</html>