<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Qu·∫£n L√Ω Nh√¢n Vi√™n | Dunvex Admin</title>
	<link rel="icon" type="image/svg+xml"
		href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%236366f1'/><text x='50%' y='50%' dominant-baseline='central' text-anchor='middle' fill='white' font-size='60' font-family='sans-serif' font-weight='800'>DV</text></svg>">
	<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
	<style>
		:root {
			--primary: #6366f1;
			--bg-dark: #0f172a;
			--card-bg: rgba(30, 41, 59, 0.7);
			--glass-border: rgba(255, 255, 255, 0.1);
			--text-main: #f8fafc;
			--text-muted: #94a3b8;
			--accent-purple: #c084fc;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Outfit', sans-serif;
		}

		body {
			background-color: var(--bg-dark);
			color: var(--text-main);
			min-height: 100vh;
			padding: 40px 20px;
			background-image:
				radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
				radial-gradient(at 100% 100%, rgba(192, 132, 252, 0.15) 0px, transparent 50%);
		}

		.container {
			max-width: 1000px;
			margin: 0 auto;
		}

		/* Top Bar */
		.top-bar {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 40px;
		}

		.user-info {
			display: flex;
			align-items: center;
			gap: 12px;
			background: var(--card-bg);
			padding: 8px 16px;
			border-radius: 99px;
			border: 1px solid var(--glass-border);
		}

		.avatar {
			width: 32px;
			height: 32px;
			background: linear-gradient(135deg, var(--primary), var(--accent-purple));
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 800;
			font-size: 0.8rem;
		}

		.btn-logout {
			background: transparent;
			border: 1px solid var(--glass-border);
			color: var(--text-muted);
			padding: 8px 16px;
			border-radius: 12px;
			cursor: pointer;
			transition: all 0.3s ease;
		}

		.btn-logout:hover {
			background: rgba(239, 68, 68, 0.1);
			color: #ef4444;
			border-color: rgba(239, 68, 68, 0.2);
		}

		.admin-section {
			background: var(--card-bg);
			backdrop-filter: blur(10px);
			border: 1px solid var(--glass-border);
			border-radius: 24px;
			padding: 32px;
			margin-bottom: 32px;
		}

		.admin-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 24px;
			margin-bottom: 32px;
		}

		@media (max-width: 900px) {
			.admin-grid {
				grid-template-columns: 1fr;
			}
		}

		h2 {
			font-size: 1.25rem;
			margin-bottom: 20px;
			display: flex;
			align-items: center;
			gap: 12px;
			color: var(--accent-purple);
		}

		.role-form {
			display: flex;
			flex-direction: column;
			gap: 16px;
		}

		.form-row {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 12px;
		}

		.form-group label {
			display: block;
			font-size: 0.8rem;
			color: var(--text-muted);
			margin-bottom: 6px;
		}

		input,
		select {
			width: 100%;
			background: rgba(15, 23, 42, 0.5);
			border: 1px solid var(--glass-border);
			border-radius: 12px;
			padding: 10px 14px;
			color: white;
			outline: none;
			transition: all 0.3s ease;
			font-size: 0.9rem;
		}

		input:focus,
		select:focus {
			border-color: var(--primary);
			box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
		}

		.btn-action {
			background: var(--primary);
			color: white;
			border: none;
			padding: 10px 20px;
			border-radius: 10px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.3s ease;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 8px;
		}

		.btn-action:hover {
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3);
		}

		.btn-secondary-action {
			background: rgba(192, 132, 252, 0.15);
			color: var(--accent-purple);
		}

		.btn-action:disabled {
			background: #334155 !important;
			color: #64748b !important;
			cursor: not-allowed !important;
			opacity: 0.7;
			transform: none !important;
			box-shadow: none !important;
		}

		.btn-edit {
			padding: 4px 10px;
			font-size: 0.75rem;
			border-radius: 4px;
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid var(--glass-border);
			color: var(--text-main);
			cursor: pointer;
		}

		.btn-edit:hover {
			background: var(--primary);
			color: white;
		}

		/* Sub-tabs for Report */
		.sub-tab-content {
			display: none;
		}

		.sub-tab-content.active {
			display: block;
			animation: fadeIn 0.3s ease-in-out;
		}

		.sub-tabs-nav {
			display: flex;
			gap: 12px;
			margin: 32px 0 16px;
			padding: 0 4px;
		}

		.sub-tab-btn {
			padding: 8px 16px;
			background: rgba(255, 255, 255, 0.03);
			border: 1px solid var(--glass-border);
			color: var(--text-muted);
			border-radius: 10px;
			cursor: pointer;
			font-size: 0.85rem;
			font-weight: 500;
			transition: all 0.3s ease;
		}

		.sub-tab-btn.active {
			background: var(--primary);
			color: white;
			border-color: var(--primary);
			box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
		}

		/* Table Section */
		.user-list-container {
			overflow-x: auto;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 10px;
		}

		th {
			text-align: left;
			padding: 16px;
			color: var(--text-muted);
			font-weight: 500;
			font-size: 0.8rem;
			text-transform: uppercase;
			letter-spacing: 0.05em;
			border-bottom: 1px solid var(--glass-border);
			white-space: normal;
			line-height: 1.2;
		}

		td {
			padding: 16px;
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
			font-size: 0.95rem;
		}

		.role-badge {
			padding: 4px 10px;
			border-radius: 6px;
			font-size: 0.75rem;
			font-weight: 600;
		}

		.badge-admin {
			background: rgba(99, 102, 241, 0.15);
			color: #818cf8;
		}

		.badge-user {
			background: rgba(34, 197, 94, 0.15);
			color: #4ade80;
		}

		.status-dot {
			display: inline-block;
			width: 8px;
			height: 8px;
			border-radius: 50%;
			margin-right: 6px;
		}

		.status-active {
			background: #22c55e;
		}

		.status-locked {
			background: #ef4444;
		}

		.loading-overlay {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(15, 23, 42, 0.8);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 1000;
		}

		.loader {
			width: 48px;
			height: 48px;
			border: 5px solid #FFF;
			border-bottom-color: var(--primary);
			border-radius: 50%;
			animation: rotation 1s linear infinite;
		}

		@keyframes rotation {
			0% {
				transform: rotate(0deg);
			}

			100% {
				transform: rotate(360deg);
			}
		}

		#toast {
			position: fixed;
			bottom: 20px;
			right: 20px;
			padding: 16px 24px;
			border-radius: 12px;
			background: #1e293b;
			color: white;
			box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
			transform: translateY(100px);
			transition: transform 0.3s ease;
			z-index: 1001;
		}

		#toast.show {
			transform: translateY(0);
		}

		/* Tabs */
		.tabs-nav {
			display: flex;
			gap: 8px;
			margin-bottom: 30px;
			border-bottom: 1px solid var(--glass-border);
			padding-bottom: 12px;
		}

		.tab-btn {
			padding: 10px 24px;
			background: transparent;
			border: 1px solid transparent;
			color: var(--text-muted);
			border-radius: 12px;
			cursor: pointer;
			font-weight: 600;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		}

		.tab-btn.active {
			background: rgba(99, 102, 241, 0.1);
			color: var(--primary);
			border-color: rgba(99, 102, 241, 0.2);
		}

		.tab-content {
			display: none;
		}

		.tab-content.active {
			display: block;
			animation: fadeIn 0.4s ease-out;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(10px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.filter-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
			gap: 16px;
			align-items: flex-end;
		}

		.report-summary {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 20px;
			margin-top: 30px;
		}

		.summary-card {
			background: rgba(255, 255, 255, 0.03);
			border: 1px solid var(--glass-border);
			padding: 20px;
			border-radius: 16px;
			text-align: center;
		}

		.summary-card h4 {
			font-size: 0.8rem;
			color: var(--text-muted);
			margin-bottom: 8px;
		}

		.summary-card .value {
			font-size: 1.5rem;
			font-weight: 800;
			color: var(--primary);
		}

		@media (max-width: 768px) {
			.role-form {
				grid-template-columns: 1fr;
			}

			.btn-update {
				width: 100%;
			}
		}
	</style>
</head>

<body>
	<div class="loading-overlay" id="loader">
		<div class="loader"></div>
	</div>

	<div class="container">
		<div class="top-bar">
			<h1>Dunvex Admin</h1>
			<div style="display: flex; gap: 12px; align-items: center;">
				<button class="btn-logout"
					style="background: rgba(192, 132, 252, 0.1); color: var(--accent-purple); border-color: rgba(192, 132, 252, 0.2);"
					onclick="window.location.href='index.html'">üè† Trang Ch·ªß</button>
				<button class="btn-logout"
					style="background: rgba(34, 197, 94, 0.1); color: #22c55e; border-color: rgba(34, 197, 94, 0.2);"
					onclick="syncSystem()">‚öôÔ∏è ƒê·ªìng B·ªô</button>
				<div class="user-info">
					<div class="avatar" id="avatarLetter">A</div>
					<span id="adminName">Admin</span>
				</div>
				<button class="btn-logout" onclick="logout()">Tho√°t</button>
			</div>
		</div>

		<div class="tabs-nav">
			<button class="tab-btn active" onclick="switchTab('hr')">üë• Qu·∫£n L√Ω Nh√¢n S·ª±</button>
			<button class="tab-btn" onclick="switchTab('report')">üìä B√°o C√°o Doanh Thu</button>
		</div>

		<!-- HR MANAGEMENT TAB -->
		<div id="tab-hr" class="tab-content active">
			<div class="admin-grid">
				<!-- CREATE NEW USER -->
				<div class="admin-section">
					<h2>‚ûï T·∫°o Nh√¢n Vi√™n M·ªõi</h2>
					<form class="role-form" id="createUserForm">
						<div class="form-group">
							<label>H·ªç v√† T√™n</label>
							<input type="text" id="newFullName" placeholder="Nguy·ªÖn VƒÉn B" required>
						</div>
						<div class="form-row">
							<div class="form-group">
								<label>Email (ƒêƒÉng nh·∫≠p)</label>
								<input type="email" id="newEmail" placeholder="nv@gmail.com" required>
							</div>
							<div class="form-group">
								<label>Vai Tr√≤ Ban ƒê·∫ßu</label>
								<select class="role-select-list" id="newRoleSelect">
									<option value="">-- ƒêang t·∫£i vai tr√≤ --</option>
									<option value="R002">Sale</option>
									<option value="R003">Kho</option>
									<option value="R004">K·∫ø to√°n</option>
									<option value="R005">Kh√°ch h√†ng</option>
								</select>
							</div>
						</div>
						<p style="font-size: 0.7rem; color: var(--text-muted);">* M·∫≠t kh·∫©u m·∫∑c ƒë·ªãnh: <b>123456</b></p>
						<button type="submit" class="btn-action">T·∫°o T√†i Kho·∫£n</button>
					</form>
				</div>

				<!-- UPDATE EXISTING USER -->
				<div class="admin-section">
					<h2>‚ö° G√°n L·∫°i Vai Tr√≤</h2>
					<form class="role-form" id="updateRoleForm">
						<div class="form-group">
							<label>Email Nh√¢n Vi√™n</label>
							<input type="email" id="targetEmail" placeholder="Ch·ªçn t·ª´ b·∫£ng b√™n d∆∞·ªõi" required>
						</div>
						<div class="form-group">
							<label>Vai Tr√≤ M·ªõi</label>
							<select class="role-select-list" id="roleSelect">
								<option value="">-- ƒêang t·∫£i vai tr√≤ --</option>
								<option value="R001">Admin</option>
								<option value="R002">Sale</option>
								<option value="R003">Kho</option>
								<option value="R004">K·∫ø to√°n</option>
								<option value="R005">Kh√°ch h√†ng</option>
							</select>
						</div>
						<div style="height: 14px;"></div>
						<button type="submit" class="btn-action btn-secondary-action">C·∫≠p Nh·∫≠t Quy·ªÅn</button>
					</form>
				</div>
			</div>

			<div class="admin-section">
				<h2>üõ°Ô∏è C·∫•u H√¨nh Quy·ªÅn Truy C·∫≠p</h2>
				<p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 20px;">* Ch·ªânh s·ª≠a quy·ªÅn tr·ª±c ti·∫øp
					cho
					t·ª´ng Vai tr√≤. C√°c thay ƒë·ªïi s·∫Ω c√≥ hi·ªáu l·ª±c ngay khi ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p l·∫°i.</p>
				<div class="user-list-container">
					<table id="permissionTable">
						<thead>
							<tr>
								<th>Vai Tr√≤</th>
								<th style="min-width: 100px;">Qu·∫£n l√Ω b·ªüi</th>
								<th style="text-align:center">üìä CRM &<br>Sales</th>
								<th style="text-align:center">Qu·∫£n l√Ω<br>S·∫£n ph·∫©m</th>
								<th style="text-align:center">Danh s√°ch<br>ƒë∆°n h√†ng</th>
								<th style="text-align:center">Qu·∫£n l√Ω<br>nh√¢n vi√™n</th>
								<th style="text-align:center">Xem<br>B·∫£ng gi√°</th>
								<th style="text-align:center">Qu·∫£n l√Ω<br>Kho v·∫≠n</th>
								<th style="text-align:center; color: #4ade80;">üì© Mail<br>Nh√¢n vi√™n</th>
								<th style="text-align:center; color: #818cf8;">üì© Mail<br>Admin</th>
								<th style="text-align:center">Thao t√°c</th>
							</tr>
						</thead>
						<tbody id="permissionTableBody">
							<!-- Data will be loaded here -->
						</tbody>
					</table>
				</div>
			</div>

			<div class="admin-section">
				<h2>üë• Danh S√°ch T√†i Kho·∫£n</h2>
				<div class="user-list-container">
					<table id="userTable">
						<thead>
							<tr>
								<th>ID</th>
								<th>H·ªç v√† T√™n</th>
								<th>Email (ƒêƒÉng nh·∫≠p)</th>
								<th>Vai Tr√≤</th>
								<th>Tr·∫°ng Th√°i</th>
								<th>Thao T√°c</th>
							</tr>
						</thead>
						<tbody id="userTableBody">
							<!-- Data will be loaded here -->
						</tbody>
					</table>
				</div>
			</div>
		</div> <!-- End tab-hr -->

		<!-- REPORT TAB -->
		<div id="tab-report" class="tab-content">
			<div class="admin-section">
				<h2>üìà L·ªçc D·ªØ Li·ªáu Doanh Thu</h2>
				<div class="filter-grid">
					<div class="form-group">
						<label>T·ª´ ng√†y</label>
						<input type="date" id="reportStart">
					</div>
					<div class="form-group">
						<label>ƒê·∫øn ng√†y</label>
						<input type="date" id="reportEnd">
					</div>
					<div class="form-group">
						<label>Nh√¢n vi√™n</label>
						<select id="reportStaffSelect">
							<option value="ALL">-- T·∫•t c·∫£ nh√¢n vi√™n --</option>
						</select>
					</div>
					<div class="form-group">
						<label>Tr·∫°ng th√°i</label>
						<select id="reportStatusSelect">
							<option value="ALL">-- T·∫•t c·∫£ tr·∫°ng th√°i --</option>
							<option value="ƒë∆°n ch·ªët">ƒê∆°n ch·ªët</option>
							<option value="ho√†n th√†nh" selected>Ho√†n th√†nh</option>
							<option value="ƒëang x·ª≠ l√Ω">ƒêang x·ª≠ l√Ω</option>
							<option value="ƒë∆°n nh√°p">ƒê∆°n nh√°p</option>
							<option value="ƒë√£ h·ªßy">ƒê√£ h·ªßy</option>
						</select>
					</div>
					<button class="btn-action" id="btnFilterReport" onclick="fetchRevenueReport()">üîç L·ªçc D·ªØ
						Li·ªáu</button>
				</div>
			</div>

			<div class="report-summary" id="revenueSummary" style="display:none;">
				<div class="summary-card">
					<h4>T·ªïng S·ªë ƒê∆°n</h4>
					<div class="value" id="sumOrderCount">0</div>
				</div>
				<div class="summary-card">
					<h4>T·ªïng Doanh Thu</h4>
					<div class="value" id="sumTotalRevenue">0 ‚Ç´</div>
				</div>
				<div class="summary-card">
					<h4>Kh√°ch H√†ng M·ªõi</h4>
					<div class="value" id="sumNewCustomers">0</div>
				</div>
				<button class="btn-action btn-secondary-action" id="btnSendReport" style="grid-column: span 1;"
					onclick="sendReport()">üì§
					G·ª≠i Report Email</button>
			</div>

			<div class="admin-section" style="margin-top: 32px; padding-top: 20px;">
				<div class="sub-tabs-nav">
					<button class="sub-tab-btn active" id="btnSubOrders" onclick="switchSubTab('orders')">üìã ƒê∆°n
						H√†ng</button>
					<button class="sub-tab-btn" id="btnSubCustomers" onclick="switchSubTab('customers')">üë• Kh√°ch H√†ng
						M·ªõi</button>
				</div>

				<!-- SUB TAB: ORDERS -->
				<div id="sub-tab-orders" class="sub-tab-content active">
					<div class="user-list-container">
						<table id="reportTable">
							<thead>
								<tr>
									<th>Th·ªùi Gian</th>
									<th>Kh√°ch H√†ng</th>
									<th>Nh√¢n Vi√™n</th>
									<th>T·ªïng Ti·ªÅn</th>
									<th>Tr·∫°ng Th√°i</th>
								</tr>
							</thead>
							<tbody id="reportTableBody">
								<tr>
									<td colspan="5" style="text-align:center; padding: 40px; color: var(--text-muted);">
										Vui l√≤ng ch·ªçn th·ªùi gian v√† b·∫•m L·ªçc.</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>

				<!-- SUB TAB: CUSTOMERS -->
				<div id="sub-tab-customers" class="sub-tab-content">
					<div class="user-list-container">
						<table id="customerReportTable">
							<thead>
								<tr>
									<th>Ng√†y T·∫°o</th>
									<th>ID</th>
									<th>T√™n Kh√°ch H√†ng</th>
									<th>Khu V·ª±c</th>
									<th>Nh√¢n Vi√™n</th>
								</tr>
							</thead>
							<tbody id="customerReportTableBody">
								<tr>
									<td colspan="5" style="text-align:center; padding: 40px; color: var(--text-muted);">
										Vui l√≤ng ch·ªçn th·ªùi gian v√† b·∫•m L·ªçc.</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div id="toast"></div>

	<script>
		const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyaz_6xI3Nz0FHnNgr9qEcPuOUGf4OY53l8x1ofSoh_LIGozbKmpSJNAwpq8U6ygpPNHw/exec';
		const REPORT_URL = 'https://script.google.com/macros/s/AKfycbzUfmgFXDKg4TCwEvotTAmILCu7ZZJFSPtimQ7hHVzO5C9JZqfzxeGGSRSTzkSCPHGT4w/exec';
		const MASTER_URL = 'https://script.google.com/macros/s/AKfycbyt-O7k0vT8U0vOa-H8o7I3U1v0vOa-H8o7I3U1v0vOa-H8o7I3U1/exec'; // Web app URL c·ªßa GAS_Master_Script
		let currentUser = null;

		window.onload = function () {
			const savedUser = localStorage.getItem('user');
			if (!savedUser) {
				window.location.href = 'auth.html';
				return;
			}
			currentUser = JSON.parse(savedUser);
			document.getElementById('adminName').innerText = currentUser.fullName;
			document.getElementById('avatarLetter').innerText = currentUser.fullName.charAt(0).toUpperCase();

			// Hi·ªÉn th·ªã huy hi·ªáu Premium n·∫øu c√≥
			if (currentUser.package === 'Premium') {
				const badge = document.createElement('span');
				badge.innerHTML = 'üíé PREMIUM';
				badge.style.cssText = 'background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%); color: white; font-size: 0.65rem; padding: 2px 8px; border-radius: 6px; font-weight: 800; margin-left: 8px; border: 1px solid rgba(255,255,255,0.2);';
				document.getElementById('adminName').parentElement.appendChild(badge);
			}

			loadRoles();
			loadPermissions();
			loadUsers();
		};


		function switchTab(tabId) {
			document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
			document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

			document.getElementById('tab-' + tabId).classList.add('active');
			event.currentTarget.classList.add('active');

			if (tabId === 'report') {
				// Default dates
				const now = new Date();
				const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
				const today = now.toISOString().split('T')[0];
				if (!document.getElementById('reportStart').value) document.getElementById('reportStart').value = firstDay;
				if (!document.getElementById('reportEnd').value) document.getElementById('reportEnd').value = today;

				// Populate staff select if empty
				populateReportStaff();

				// NEW: Check for Sales Report Restriction
				if (currentUser.salesRestrict === 'ON') {
					const btnSend = document.getElementById('btnSendReport');
					if (btnSend) {
						btnSend.disabled = true;
						btnSend.innerHTML = "üîí T√≠nh nƒÉng b·ªã kh√≥a b·ªüi Super Admin";
						btnSend.title = "Vui l√≤ng li√™n h·ªá Super Admin ƒë·ªÉ m·ªü quy·ªÅn g·ª≠i b√°o c√°o.";
					}
				}
			}
		}

		function switchSubTab(subTabId) {
			document.querySelectorAll('.sub-tab-content').forEach(el => el.classList.remove('active'));
			document.querySelectorAll('.sub-tab-btn').forEach(el => el.classList.remove('active'));

			document.getElementById('sub-tab-' + subTabId).classList.add('active');
			// Find button by ID or text depending on call
			if (subTabId === 'orders') document.getElementById('btnSubOrders').classList.add('active');
			else document.getElementById('btnSubCustomers').classList.add('active');
		}

		let allUsersCache = [];
		function populateReportStaff() {
			const select = document.getElementById('reportStaffSelect');
			if (select.options.length > 1) return; // Already populated

			allUsersCache.forEach(u => {
				if (u.roleId === 'R002' || u.roleId === 'R001') {
					const opt = document.createElement('option');
					opt.value = u.email;
					opt.innerText = u.fullName + " (" + u.email + ")";
					select.appendChild(opt);
				}
			});
		}

		async function fetchRevenueReport() {
			const start = document.getElementById('reportStart').value;
			const end = document.getElementById('reportEnd').value;
			const staff = document.getElementById('reportStaffSelect').value;
			const status = document.getElementById('reportStatusSelect').value;

			if (!start || !end) return showToast("Vui l√≤ng ch·ªçn ng√†y", "error");

			const btn = document.getElementById('btnFilterReport');
			btn.disabled = true;
			btn.innerHTML = "‚åõ ƒêang l·ªçc...";

			try {
				const res = await fetch(REPORT_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'getRevenueData', // We'll add this to the Report Utility
						startDate: start,
						endDate: end,
						staffEmail: staff,
						status: status,
						requesterEmail: currentUser.email
					})
				});
				const data = await res.json();
				if (data.success) {
					renderRevenueReport(data);
				} else {
					showToast('‚ùå L·ªói: ' + data.message, 'error');
				}
			} catch (e) {
				showToast('‚ùå L·ªói k·∫øt n·ªëi!', 'error');
			} finally {
				btn.disabled = false;
				btn.innerHTML = "üîç L·ªçc D·ªØ Li·ªáu";
			}
		}

		function renderRevenueReport(result) {
			document.getElementById('revenueSummary').style.display = 'grid';
			document.getElementById('sumOrderCount').innerText = result.summary.orderCount;
			document.getElementById('sumTotalRevenue').innerText = result.summary.totalRevenue.toLocaleString() + " ‚Ç´";
			document.getElementById('sumNewCustomers').innerText = result.summary.newCustomers;

			const tbody = document.getElementById('reportTableBody');
			if (!result.orders || result.orders.length === 0) {
				tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px; color: var(--text-muted);">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o trong kho·∫£ng th·ªùi gian n√†y.</td></tr>';
			} else {
				tbody.innerHTML = result.orders.map(o => {
					const displayTotal = (typeof o.total === 'number') ? o.total.toLocaleString() : '0';
					const displayStatus = o.status || 'N/A';
					const statusColor = (typeof getStatusColor === 'function') ? getStatusColor(displayStatus) : '#64748b';

					return `
					<tr>
						<td style="font-size: 0.85rem; color: var(--text-muted);">${o.date || '-'}</td>
						<td style="font-weight: 600;">${o.customerName || 'N/A'}</td>
						<td>${o.staffName || '-'}</td>
						<td style="font-weight: 800; color: var(--primary);">${displayTotal} ‚Ç´</td>
						<td>
							<span class="status-dot" style="background: ${statusColor}"></span>
							${displayStatus}
						</td>
					</tr>
				`}).join('');
			}

			// Render Customers Table
			const custTbody = document.getElementById('customerReportTableBody');
			if (!result.customers || result.customers.length === 0) {
				custTbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px; color: var(--text-muted);">Kh√¥ng c√≥ kh√°ch h√†ng m·ªõi n√†o ƒë∆∞·ª£c t·∫°o trong kho·∫£ng th·ªùi gian n√†y.</td></tr>';
			} else {
				custTbody.innerHTML = result.customers.map(c => `
					<tr>
						<td style="font-size: 0.85rem; color: var(--text-muted);">${c.dateStr || '-'}</td>
						<td style="color: var(--accent-purple); font-weight: bold; font-size: 0.8rem;">${c.id || '-'}</td>
						<td style="font-weight: 600;">${c.name || 'N/A'}</td>
						<td>${c.area || '-'}</td>
						<td>${c.staffName || '-'}</td>
					</tr>
				`).join('');
			}
		}

		function getStatusColor(status) {
			switch (status.toLowerCase()) {
				case 'ho√†n th√†nh': return '#22c55e';
				case 'ƒë∆°n ch·ªët': return '#6366f1';
				case 'ƒëang x·ª≠ l√Ω': return '#fbbf24';
				case 'ƒë√£ h·ªßy': return '#ef4444';
				default: return '#94a3b8';
			}
		}

		async function sendReport() {
			const start = document.getElementById('reportStart').value;
			const end = document.getElementById('reportEnd').value;
			if (!start || !end) return showToast("Vui l√≤ng ch·ªçn ng√†y", "error");

			if (!confirm("H·ªá th·ªëng s·∫Ω t·ªïng h·ª£p b√°o c√°o chi ti·∫øt v√† g·ª≠i email cho b·∫°n. X√°c nh·∫≠n?")) return;

			const btn = document.getElementById('btnSendReport');
			const originalHTML = btn.innerHTML;
			btn.disabled = true;
			btn.innerHTML = "‚åõ ƒêang g·ª≠i...";

			try {
				const res = await fetch(REPORT_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'sendReportByDate',
						startDate: start,
						endDate: end,
						requesterEmail: currentUser.email
					})
				});
				const data = await res.json();
				if (data.success) {
					showToast('‚úÖ ' + data.message, 'success');
				} else {
					showToast('‚ùå L·ªói: ' + data.message, 'error');
				}
			} catch (e) {
				showToast('‚ùå L·ªói k·∫øt n·ªëi!', 'error');
			} finally {
				btn.disabled = false;
				btn.innerHTML = originalHTML;
			}
		}
		// ...

		async function loadPermissions() {
			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({ action: 'get_phan_quyen' })
				});
				const data = await response.json();
				if (data.success) {
					renderPermissions(data.data);
				}
			} catch (err) {
				console.error("Failed to load permissions", err);
			}
		}

		function renderPermissions(perms) {
			const tbody = document.getElementById('permissionTableBody');
			tbody.innerHTML = perms.map(p => `
				<tr>
					<td>
						<div style="font-weight: 600;">${p.ten_vai_tro}</div>
						<div style="font-size: 0.75rem; color: var(--accent-purple);">${p.id_vai_tro}</div>
					</td>
					<td style="font-size: 0.8rem; color: var(--text-muted);">${p.email_quan_ly}</td>
					<td style="text-align:center"><input type="checkbox" id="v_${p.id_vai_tro}_${p.email_quan_ly}" ${p.checkin_sales === true ? 'checked' : ''} style="width:16px;height:16px;cursor:pointer"></td>
					<td style="text-align:center"><input type="checkbox" id="c_${p.id_vai_tro}_${p.email_quan_ly}" ${p.quan_ly_san_pham === true ? 'checked' : ''} style="width:16px;height:16px;cursor:pointer"></td>
					<td style="text-align:center"><input type="checkbox" id="d_${p.id_vai_tro}_${p.email_quan_ly}" ${p.danh_sach_don_hang === true ? 'checked' : ''} style="width:16px;height:16px;cursor:pointer"></td>
					<td style="text-align:center"><input type="checkbox" id="m_${p.id_vai_tro}_${p.email_quan_ly}" ${p.quan_ly_nhan_vien === true ? 'checked' : ''} style="width:16px;height:16px;cursor:pointer"></td>
					<td style="text-align:center"><input type="checkbox" id="x_${p.id_vai_tro}_${p.email_quan_ly}" ${p.xem_bang_gia === true ? 'checked' : ''} style="width:16px;height:16px;cursor:pointer"></td>
					<td style="text-align:center"><input type="checkbox" id="k_${p.id_vai_tro}_${p.email_quan_ly}" ${p.quan_ly_kho === true ? 'checked' : ''} style="width:16px;height:16px;cursor:pointer"></td>
					<td style="text-align:center"><input type="checkbox" id="ns_${p.id_vai_tro}_${p.email_quan_ly}" ${p.notify_staff === true ? 'checked' : ''} style="width:16px;height:16px;cursor:pointer"></td>
					<td style="text-align:center"><input type="checkbox" id="na_${p.id_vai_tro}_${p.email_quan_ly}" ${p.notify_admin === true ? 'checked' : ''} style="width:16px;height:16px;cursor:pointer"></td>
					<td style="text-align:center">
						<button class="btn-edit" onclick="savePerm('${p.id_vai_tro}', '${p.ten_vai_tro}', '${p.email_quan_ly}')">L∆ØU</button>
					</td>
				</tr>
			`).join('');
		}

		async function savePerm(id, name, email) {
			const payload = {
				action: 'save_phan_quyen',
				id_vai_tro: id,
				ten_vai_tro: name,
				email_quan_ly: email,
				checkin_sales: document.getElementById(`v_${id}_${email}`).checked,
				quan_ly_san_pham: document.getElementById(`c_${id}_${email}`).checked,
				danh_sach_don_hang: document.getElementById(`d_${id}_${email}`).checked,
				quan_ly_nhan_vien: document.getElementById(`m_${id}_${email}`).checked,
				xem_bang_gia: document.getElementById(`x_${id}_${email}`).checked,
				quan_ly_kho: document.getElementById(`k_${id}_${email}`).checked,
				notify_staff: document.getElementById(`ns_${id}_${email}`).checked,
				notify_admin: document.getElementById(`na_${id}_${email}`).checked
			};

			showLoader(true);
			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify(payload)
				});
				const data = await response.json();
				if (data.success) {
					showToast('ƒê√£ l∆∞u quy·ªÅn th√†nh c√¥ng!', 'success');
					// N·∫øu Admin ƒëang s·ª≠a cho ch√≠nh Role c·ªßa m√¨nh, h√£y c·∫≠p nh·∫≠t LocalStorage ngay ƒë·ªÉ th·∫•y thay ƒë·ªïi ·ªü Menu
					if (id === currentUser.roleId) {
						const updatedPerms = {
							checkinSales: payload.checkin_sales,
							quanLySanPham: payload.quan_ly_san_pham,
							danhSachDonHang: payload.danh_sach_don_hang,
							quanLyNhanVien: payload.quan_ly_nhan_vien,
							xemBangGia: payload.xem_bang_gia,
							quanLyKho: payload.quan_ly_kho
						};
						localStorage.setItem('permissions', JSON.stringify(updatedPerms));
					}
				} else {
					showToast(data.message, 'error');
				}
			} catch (err) {
				showToast('L·ªói k·∫øt n·ªëi', 'error');
			} finally {
				showLoader(false);
			}
		}

		async function loadRoles() {
			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({ action: 'getRoles' })
				});
				const data = await response.json();
				if (data.success && data.roles && data.roles.length > 0) {
					const options = data.roles.map(r =>
						`<option value="${r.id}">${r.name}</option>`
					).join('');

					document.getElementById('roleSelect').innerHTML = options;
					document.getElementById('newRoleSelect').innerHTML = options;
				} else {
					console.warn("No roles found in sheet, using default list.");
				}
			} catch (err) {
				console.error("Failed to load roles from API", err);
			}
		}

		async function syncSystem() {
			if (!confirm("B·∫°n c√≥ mu·ªën ƒë·ªìng b·ªô l·∫°i c·∫•u tr√∫c Sheet v√† c√°c vai tr√≤ m·∫∑c ƒë·ªãnh kh√¥ng?")) return;
			showLoader(true);
			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({ action: 'setup' })
				});
				const data = await response.json();
				if (data.success) {
					showToast('ƒê√£ ƒë·ªìng b·ªô h·ªá th·ªëng th√†nh c√¥ng!', 'success');
					loadRoles(); // Reload list
				}
			} catch (err) {
				showToast('L·ªói ƒë·ªìng b·ªô', 'error');
			} finally {
				showLoader(false);
			}
		}

		async function loadUsers() {
			showLoader(true);
			try {
				const isDunvexMaster = currentUser.email.toLowerCase().includes('dunvex');
				const targetUrl = isDunvexMaster ? MASTER_URL : SCRIPT_URL;
				const action = isDunvexMaster ? 'getMasterAllAccounts' : 'getUsers';

				const response = await fetch(targetUrl, {
					method: 'POST',
					body: JSON.stringify({
						action: action,
						adminEmail: currentUser.email
					})
				});
				const data = await response.json();

				if (data.success) {
					allUsersCache = data.users; // Save for report filter
					renderUsers(data.users);
				} else {
					showToast('L·ªói t·∫£i danh s√°ch ng∆∞·ªùi d√πng', 'error');
				}
			} catch (err) {
				showToast('L·ªói k·∫øt n·ªëi m√°y ch·ªß', 'error');
			} finally {
				showLoader(false);
			}
		}

		function renderUsers(users) {
			const tbody = document.getElementById('userTableBody');
			const isDunvexMaster = currentUser.email.toLowerCase().includes('dunvex');

			// C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ b·∫£ng n·∫øu l√† Admin Master ƒë·ªÉ xem ƒë∆∞·ª£c c·ªôt Owner
			if (isDunvexMaster) {
				const userHead = document.querySelector('#userTable thead tr');
				if (userHead && !userHead.innerHTML.includes('Qu·∫£n l√Ω')) {
					userHead.innerHTML = '<th>ID</th><th>H·ªç v√† T√™n</th><th>Email</th><th>Vai Tr√≤</th><th>Qu·∫£n l√Ω</th><th>Tr·∫°ng Th√°i</th><th>Thao T√°c</th>';
				}
			}

			if (!users || users.length === 0) {
				tbody.innerHTML = `<tr><td colspan="${isDunvexMaster ? 7 : 6}" style="text-align:center; padding: 40px; color: var(--text-muted);">Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n n√†o.</td></tr>`;
				return;
			}

			tbody.innerHTML = users.map(user => `
                <tr>
                    <td style="color: var(--accent-purple); font-weight: bold; font-size: 0.8rem;">${user.id || '...'}</td>
                    <td style="font-weight: 600;">${user.fullName}</td>
                    <td style="color: var(--text-muted); font-size: 0.85rem;">${user.email}</td>
                    <td>
                        <span class="role-badge ${user.roleId === 'R001' ? 'badge-admin' : 'badge-user'}">
                            ${getRoleDisplayName(user.roleId)}
                        </span>
                    </td>
                    ${isDunvexMaster ? `<td><small style="color:${user.owner === 'M·ªí C√îI (CH∆ØA G√ÅN)' ? 'var(--danger)' : 'var(--text-muted)'}">${user.owner}</small></td>` : ''}
                    <td>
                        <span class="status-dot ${user.status === 'Ho·∫°t ƒë·ªông' ? 'status-active' : 'status-locked'}"></span>
                        ${user.status}
                    </td>
                    <td>
                        ${user.email !== currentUser.email ? `
                            <button class="btn-edit" onclick="quickEdit('${user.email}', '${user.roleId}')">S·ª≠a Quy·ªÅn</button>
                            <button class="btn-edit" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border-color: rgba(239, 68, 68, 0.2); margin-left: 5px;" onclick="deleteUser('${user.email}')">X√≥a</button>
                        ` : '<span style="color: var(--text-muted); font-size: 0.8rem; font-style: italic;">(T√†i kho·∫£n c·ªßa b·∫°n)</span>'}
                    </td>
                </tr>
            `).join('');
		}

		function getRoleDisplayName(roleId) {
			const names = {
				'R001': 'ADMIN',
				'R002': 'SALE',
				'R003': 'KHO',
				'R004': 'K·∫æ TO√ÅN',
				'R005': 'GUEST'
			};
			return names[roleId] || roleId;
		}

		function quickEdit(email, roleId) {
			document.getElementById('targetEmail').value = email;
			document.getElementById('roleSelect').value = roleId;
			// Scroll to the update form
			document.getElementById('updateRoleForm').scrollIntoView({ behavior: 'smooth' });
			// Highlight the input briefly
			const input = document.getElementById('targetEmail');
			input.style.borderColor = 'var(--primary)';
			setTimeout(() => input.style.borderColor = '', 1000);
		}

		document.getElementById('createUserForm').addEventListener('submit', async (e) => {
			e.preventDefault();
			const fullName = document.getElementById('newFullName').value;
			const email = document.getElementById('newEmail').value;
			const roleId = document.getElementById('newRoleSelect').value;

			showLoader(true);
			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'createUser',
						fullName: fullName,
						email: email,
						roleId: roleId,
						adminEmail: currentUser.email
					})
				});
				const data = await response.json();

				if (data.success) {
					showToast('ƒê√£ t·∫°o nh√¢n vi√™n th√†nh c√¥ng!', 'success');
					loadUsers();
					document.getElementById('createUserForm').reset();
				} else {
					showToast(data.message, 'error');
				}
			} catch (err) {
				showToast('L·ªói k·∫øt n·ªëi m√°y ch·ªß', 'error');
			} finally {
				showLoader(false);
			}
		});

		document.getElementById('updateRoleForm').addEventListener('submit', async (e) => {
			e.preventDefault();
			const targetEmail = document.getElementById('targetEmail').value;
			const newRoleId = document.getElementById('roleSelect').value;

			showLoader(true);
			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'updateRole',
						userEmail: targetEmail,
						newRoleId: newRoleId,
						adminEmail: currentUser.email
					})
				});
				const data = await response.json();

				if (data.success) {
					showToast('ƒê√£ c·∫≠p nh·∫≠t vai tr√≤ th√†nh c√¥ng', 'success');
					loadUsers(); // Refresh list
					document.getElementById('updateRoleForm').reset();
				} else {
					showToast(data.message, 'error');
				}
			} catch (err) {
				showToast('L·ªói k·∫øt n·ªëi m√°y ch·ªß', 'error');
			} finally {
				showLoader(false);
			}
		});

		async function deleteUser(email) {
			if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA nh√¢n vi√™n ${email} kh·ªèi h·ªá th·ªëng? \nD·ªØ li·ªáu n√†y kh√¥ng th·ªÉ kh√¥i ph·ª•c v√† t√†i kho·∫£n n√†y s·∫Ω m·∫•t quy·ªÅn truy c·∫≠p ngay l·∫≠p t·ª©c.`)) return;

			showLoader(true);
			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'deleteUser',
						userEmail: email,
						adminEmail: currentUser.email
					})
				});
				const data = await response.json();
				if (data.success) {
					showToast('ƒê√£ x√≥a nh√¢n vi√™n th√†nh c√¥ng!', 'success');
					loadUsers();
				} else {
					showToast(data.message, 'error');
				}
			} catch (err) {
				showToast('L·ªói k·∫øt n·ªëi', 'error');
			} finally {
				showLoader(false);
			}
		}

		function showToast(msg, type) {
			const toast = document.getElementById('toast');
			toast.innerText = msg;
			toast.style.borderLeft = type === 'success' ? '4px solid #22c55e' : '4px solid #ef4444';
			toast.classList.add('show');
			setTimeout(() => toast.classList.remove('show'), 3000);
		}

		function showLoader(show) {
			document.getElementById('loader').style.display = show ? 'flex' : 'none';
		}

		function logout() {
			localStorage.clear();
			window.location.href = 'auth.html';
		}
	</script>
	<script src="chatbot.js"></script>
	<script src="floating-menu.js"></script>
</body>

</html>