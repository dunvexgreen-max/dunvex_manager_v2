/**
 * DUNVEX CRM & SALES CHECK-IN SYSTEM
 * Spreadsheet ID: 15niaoQ7FozkRCushPGNtq4zj6pwA0UQ5Wel61ksv8L8
 */

const CRM_SS_ID = '15niaoQ7FozkRCushPGNtq4zj6pwA0UQ5Wel61ksv8L8';

function doPost(e) {
  let result;
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;

    switch (action) {
      case 'setup': result = initCRM(); break;
      case 'getCustomers': result = getCustomers(data); break;
      case 'getAreas': result = getAreas(data); break;
      case 'createCustomer': result = handleCreateCustomer(data); break;
      case 'updateCustomer': result = handleUpdateCustomer(data); break;
      case 'deleteCustomer': result = handleDeleteCustomer(data); break;
      case 'handleCheckin': result = handleCheckin(data); break;
      case 'getCheckinHistory': result = getCheckinHistory(data); break;
      case 'addDoc': result = handleAddDoc(data); break;
      case 'uploadFile': result = handleFileUpload(data); break;
      case 'sendMonthlyReport': result = sendMonthlyAdminReport(); break;
      default: result = { success: false, message: 'Hành động không hợp lệ' };
    }
  } catch (error) {
    result = { success: false, message: 'Lỗi CRM: ' + error.toString() };
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

function getSheet(name) {
  const ss = SpreadsheetApp.openById(CRM_SS_ID);
  return ss.getSheetByName(name) || ss.insertSheet(name);
}

/**
 * KHỞI TẠO CẤU TRÚC 3 BẢNG + BẢNG CẤU HÌNH KHU VỰC
 */
function initCRM() {
  const ss = SpreadsheetApp.openById(CRM_SS_ID);
  const configs = {
    'data_khach_hang': ['customer_id', 'ten_khach_hang', 'nguoi_lien_he_chinh', 'so_dien_thoai', 'email', 'dia_chi_kho_cua_hang', 'vi_tri', 'ma_sales_phu_trach', 'khu_vuc_thi_truong', 'ngay_tao', 'trang_thai'],
    'data_checkin': ['checkin_id', 'customer_id', 'ma_sales_checkin', 'thoi_gian_checkin', 'vi_tri_checkin', 'khoang_cach', 'muc_dich_gap_mat', 'ghi_chu_ket_qua', 'anh_minh_chung'],
    'thong_tin_khach': ['customer_id', 'ten_tai_lieu', 'loai_tai_lieu', 'link_file', 'ngay_cap_nhat', 'ghi_chu'],
    'config_khu_vuc': ['TÊN KHU VỰC', 'EMAIL SALES', 'MÔ TẢ']
  };
  for (let name in configs) {
    let sheet = ss.getSheetByName(name);
    if (!sheet) sheet = ss.insertSheet(name);
    sheet.getRange(1, 1, 1, configs[name].length).setValues([configs[name]]);
    
    // Thêm dữ liệu mẫu cho khu vực nếu bảng trống
    if (name === 'config_khu_vuc' && sheet.getLastRow() < 2) {
      sheet.appendRow(['Miền Nam', 'ALL', 'Khu vực phía Nam']);
      sheet.appendRow(['Miền Trung', 'ALL', 'Khu vực Miền Trung']);
      sheet.appendRow(['Miền Bắc', 'ALL', 'Khu vực phía Bắc']);
    }
  }
  return { success: true, message: 'Hệ thống CRM & Cấu hình khu vực đã sẵn sàng!' };
}

/**
 * Hàm hỗ trợ xóa cột theo tên (Dùng để dọn dẹp sheet theo yêu cầu)
 */
function removeColumnsByName(sheetName, columnNames) {
  const sheet = getSheet(sheetName);
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  
  // Xóa từ phải sang trái để tránh lệch index
  for (let i = headers.length - 1; i >= 0; i--) {
    if (columnNames.includes(headers[i])) {
      sheet.deleteColumn(i + 1);
    }
  }
}

function getAreas(data) {
  const sheet = getSheet('config_khu_vuc');
  const rows = sheet.getDataRange().getValues();
  const salesEmail = (data.salesId || "").toLowerCase();
  const isAdmin = data.isAdmin === true;
  const areas = [];
  for (let i = 1; i < rows.length; i++) {
    const assignedSales = (rows[i][1] || "").toString().toLowerCase();
    if (isAdmin || assignedSales === 'all' || assignedSales === salesEmail) {
      if (rows[i][0]) areas.push(rows[i][0]);
    }
  }
  return { success: true, areas: areas };
}

function handleCreateCustomer(data) {
  const sheet = getSheet('data_khach_hang');
  const id = "KH" + (sheet.getLastRow()).toString().padStart(5, '0');
  
  // Tự động thêm khu vực mới
  const areaSheet = getSheet('config_khu_vuc');
  const existingAreas = areaSheet.getDataRange().getValues().map(r => r[0].toString().toLowerCase());
  if (!existingAreas.includes(data.area.toLowerCase())) {
     areaSheet.appendRow([data.area, data.salesId, 'Tự động tạo từ Form']);
  }

  const row = [
    id, data.name, data.contact, data.phone, data.email, 
    data.address, data.location, data.salesId, data.area, 
    new Date(), 'Đang hoạt động'
  ];
  sheet.appendRow(row);
  return { success: true, customerId: id };
}

function handleUpdateCustomer(data) {
  const sheet = getSheet('data_khach_hang');
  const rows = sheet.getDataRange().getValues();
  for (let i = 1; i < rows.length; i++) {
    if (rows[i][0] === data.id) {
      const rowNum = i + 1;
      const updatedRow = [
        data.id, data.name, data.contact, data.phone, data.email, 
        data.address, data.location, rows[i][7], data.area, 
        rows[i][9], rows[i][10]
      ];
      sheet.getRange(rowNum, 1, 1, updatedRow.length).setValues([updatedRow]);
      return { success: true };
    }
  }
  return { success: false, message: 'Không tìm thấy khách hàng' };
}

function handleDeleteCustomer(data) {
  const sheet = getSheet('data_khach_hang');
  const rows = sheet.getDataRange().getValues();
  for (let i = 1; i < rows.length; i++) {
    if (rows[i][0] === data.id) {
      sheet.deleteRow(i + 1);
      return { success: true };
    }
  }
  return { success: false, message: 'Không tìm thấy khách hàng' };
}

function handleCheckin(data) {
  const sheet = getSheet('data_checkin');
  const checkinId = "CI" + new Date().getTime();
  
  // Tính khoảng cách nếu có tọa độ khách hàng (Tùy chọn backend hoặc frontend)
  let distance = calculateDistance(data.customerLocation, data.checkinLocation);
  
  const row = [
    checkinId, data.customerId, data.salesId, new Date(), 
    data.checkinLocation, distance, data.purpose, 
    data.note, data.imageUrl || ''
  ];
  sheet.appendRow(row);
  return { success: true, checkinId: checkinId, distance: distance };
}

function getCheckinHistory(data) {
  try {
    // 1. Tự động dọn dẹp cột thừa nếu còn tồn tại
    removeColumnsByName('data_checkin', ['thoi_gian_checkout', 'da_duyet']);

    const sheet = getSheet('data_checkin');
    const custSheet = getSheet('data_khach_hang');
    if (sheet.getLastRow() < 2) return { success: true, history: [] };
    
    const rows = sheet.getDataRange().getValues();
    const headers = rows[0];
    const custRows = custSheet.getDataRange().getValues();
    const salesId = (data.salesId || "").toLowerCase();
    const isAdmin = data.isAdmin === true;
    
    // Tìm index cột để đảm bảo lấy đúng data kể cả khi sheet bị xáo trộn
    const idx = {
      id: headers.indexOf('checkin_id'),
      custId: headers.indexOf('customer_id'),
      salesId: headers.indexOf('ma_sales_checkin'),
      time: headers.indexOf('thoi_gian_checkin'),
      location: headers.indexOf('vi_tri_checkin'),
      dist: headers.indexOf('khoang_cach'),
      purpose: headers.indexOf('muc_dich_gap_mat'),
      note: headers.indexOf('ghi_chu_ket_qua'),
      image: headers.indexOf('anh_minh_chung')
    };

    const custMap = {};
    for (let j = 1; j < custRows.length; j++) {
      custMap[custRows[j][0]] = custRows[j][1];
    }

    const history = [];
    for (let i = 1; i < rows.length; i++) {
      const assignedSales = (rows[i][idx.salesId] || "").toString().toLowerCase();
      // CHỈ NGƯỜI NHẬP MỚI XEM ĐƯỢC (Strict Personal Privacy)
      if (assignedSales === salesId) {
        history.push({
          id: rows[i][idx.id],
          customerId: rows[i][idx.custId],
          customerName: custMap[rows[i][idx.custId]] || 'N/A',
          salesId: rows[i][idx.salesId],
          time: rows[i][idx.time],
          location: rows[i][idx.location],
          distance: rows[i][idx.dist],
          purpose: rows[i][idx.purpose],
          note: rows[i][idx.note],
          image: rows[i][idx.image]
        });
      }
    }
    return { success: true, history: history.reverse() };
  } catch (e) { return { success: false, message: e.toString() }; }
}

function handleAddDoc(data) {
  const sheet = getSheet('thong_tin_khach');
  sheet.appendRow([data.customerId, data.docName, data.type, data.fileUrl, new Date(), data.note]);
  return { success: true };
}

function getCustomers(data) {
  const sheet = getSheet('data_khach_hang');
  if (sheet.getLastRow() < 2) return { success: true, customers: [] };
  const rows = sheet.getDataRange().getValues();
  const salesId = (data.salesId || "").toLowerCase();
  const isAdmin = data.isAdmin === true;
  const customers = [];
  for (let i = 1; i < rows.length; i++) {
    const assignedSales = (rows[i][7] || "").toString().toLowerCase();
    if (isAdmin || assignedSales === "all" || assignedSales === salesId) {
      customers.push({ 
        id: rows[i][0], 
        name: rows[i][1], 
        contact: rows[i][2],
        phone: rows[i][3],
        location: rows[i][6],
        area: rows[i][8],
        address: rows[i][5],
        status: rows[i][10]
      });
    }
  }
  return { success: true, customers: customers };
}

/**
 * TÍNH KHOẢNG CÁCH GIỮA 2 TỌA ĐỘ (HA VERSINE FORMULA)
 */
function calculateDistance(loc1, loc2) {
  if (!loc1 || !loc2) return 0;
  try {
    const [lat1, lon1] = loc1.split(',').map(Number);
    const [lat2, lon2] = loc2.split(',').map(Number);
    const R = 6371e3; // metres
    const φ1 = lat1 * Math.PI/180;
    const φ2 = lat2 * Math.PI/180;
    const Δφ = (lat2-lat1) * Math.PI/180;
    const Δλ = (lon2-lon1) * Math.PI/180;
    const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return Math.round(R * c);
  } catch(e) { return 0; }
}

function handleFileUpload(data) {
  try {
    // Phân loại folder theo loại file
    let folderId = '1dGFgw96a6gWVdHMq6rkk4fFRpDJqi5cG'; // Mặc định là Folder Image
    if (data.type === 'pdf' || (data.filename && data.filename.toLowerCase().endsWith('.pdf'))) {
      folderId = '1-XEQxyPtq8taCW8g7q-PWtJdKlNO3t4_'; // Folder PDF
    }
    
    const folder = DriveApp.getFolderById(folderId);
    const contentType = data.mimetype;
    const byteCharacters = Utilities.base64Decode(data.base64);
    const blob = Utilities.newBlob(byteCharacters, contentType, data.filename);
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    // Trả về link view trực tiếp lh3 nếu là ảnh, hoặc link drive nếu là pdf
    let fileUrl = file.getUrl();
    if (folderId === '1dGFgw96a6gWVdHMq6rkk4fFRpDJqi5cG') {
      fileUrl = "https://lh3.googleusercontent.com/d/" + file.getId();
    }
    
    return { success: true, url: fileUrl };
  } catch (e) {
    return { success: false, message: e.toString() };
  }
}
/**
 * GAS_MonthlyReport_Utility.txt
 * Hệ thống tổng hợp báo cáo tháng và gửi mail cho Admin quản lý
 */

const REPORT_CRM_SS_ID = '15niaoQ7FozkRCushPGNtq4zj6pwA0UQ5Wel61ksv8L8';
const REPORT_AUTH_SS_ID = '1rhP1UCiMLi8yNVvcd56SsZIJAm09Yxu6WpjxuHKYKb0';
const REPORT_DATA_FOLDER_ID = '1_LT4rzVui2E3BgfcwUSfMsUGQMN9NRTs';
const REPORT_ORDER_HEADER_FILE = 'order.json';

/**
 * Hàm chính thực hiện gửi báo cáo tháng cho các Admin
 * @param {number} month - Tháng cần báo cáo (1-12), mặc định là tháng hiện tại
 * @param {number} year - Năm cần báo cáo, mặc định năm hiện tại
 */
function sendMonthlyAdminReport(month, year) {
  const now = new Date();
  const targetMonth = month || (now.getMonth() + 1);
  const targetYear = year || now.getFullYear();
  
  console.log(`Bắt đầu tạo báo cáo tháng ${targetMonth}/${targetYear}`);

  // 1. Lấy danh sách quan hệ Admin - Sales
  const hierarchy = getAdminSalesHierarchy();
  
  // 2. Lấy dữ liệu Khách hàng từ CRM
  const allCustomers = getMonthlyCustomers(targetMonth, targetYear);
  
  // 3. Lấy dữ liệu Đơn hàng từ Drive JSON
  const allOrders = getMonthlyOrders(targetMonth, targetYear);

  // 4. Duyệt qua từng Admin và gửi mail
  for (let adminEmail in hierarchy) {
    const subordinates = hierarchy[adminEmail]; // Danh sách email nhân viên
    const staffReports = [];
    let adminTotalRevenue = 0;
    let adminTotalCustomers = 0;

    subordinates.forEach(staffEmail => {
      const staffEmailLower = staffEmail.toLowerCase();
      
      // Lọc khách hàng của nhân viên này
      const staffCustomers = allCustomers.filter(c => c.salesId.toLowerCase() === staffEmailLower);
      
      // Lọc đơn hàng của nhân viên này
      const staffOrders = allOrders.filter(o => o.salesId.toLowerCase() === staffEmailLower);
      
      const staffRevenue = staffOrders.reduce((sum, o) => sum + (o.value || 0), 0);
      
      staffReports.push({
        email: staffEmail,
        name: getStaffName(staffEmail),
        customerCount: staffCustomers.length,
        orderCount: staffOrders.length,
        revenue: staffRevenue,
        customers: staffCustomers,
        orders: staffOrders
      });

      adminTotalRevenue += staffRevenue;
      adminTotalCustomers += staffCustomers.length;
    });

    if (staffReports.length > 0) {
      sendEmailToAdmin(adminEmail, staffReports, adminTotalRevenue, targetMonth, targetYear);
    }
  }

  return { success: true, message: `Đã gửi báo cáo tháng ${targetMonth}/${targetYear}` };
}

/**
 * Lấy cấu trúc Admin và danh sách Sales phụ trách từ Auth SS
 */
function getAdminSalesHierarchy() {
  const ss = SpreadsheetApp.openById(REPORT_AUTH_SS_ID);
  const useSheet = ss.getSheetByName('use');
  const data = useSheet.getDataRange().getValues();
  const hierarchy = {};

  for (let i = 1; i < data.length; i++) {
    const staffEmail = data[i][1];
    const adminEmail = data[i][5]; // Cột GÁN AD MIND
    if (adminEmail && adminEmail !== 'N/A') {
      if (!hierarchy[adminEmail]) hierarchy[adminEmail] = [];
      hierarchy[adminEmail].push(staffEmail);
    }
  }
  return hierarchy;
}

/**
 * Lấy tên nhân viên dựa trên email
 */
function getStaffName(email) {
  const ss = SpreadsheetApp.openById(REPORT_AUTH_SS_ID);
  const useSheet = ss.getSheetByName('use');
  const data = useSheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][1].toLowerCase() === email.toLowerCase()) return data[i][3];
  }
  return email;
}

/**
 * Lọc khách hàng mới tạo trong tháng
 */
function getMonthlyCustomers(month, year) {
  const ss = SpreadsheetApp.openById(REPORT_CRM_SS_ID);
  const sheet = ss.getSheetByName('data_khach_hang');
  const data = sheet.getDataRange().getValues();
  const results = [];

  for (let i = 1; i < data.length; i++) {
    const createdDate = new Date(data[i][9]); // ngay_tao
    if (createdDate.getMonth() + 1 === month && createdDate.getFullYear() === year) {
      results.push({
        id: data[i][0],
        name: data[i][1],
        salesId: data[i][7], // ma_sales_phu_trach
        area: data[i][8]
      });
    }
  }
  return results;
}

/**
 * Lọc đơn hàng thỏa mãn điều kiện trong tháng
 */
function getMonthlyOrders(month, year) {
  const folder = DriveApp.getFolderById(REPORT_DATA_FOLDER_ID);
  const files = folder.getFilesByName(REPORT_ORDER_HEADER_FILE);
  if (!files.hasNext()) return [];
  
  const content = JSON.parse(files.next().getBlob().getDataAsString() || '[]');
  const results = [];
  const finalizedStatuses = ['đơn chốt', 'hoàn thành'];

  content.forEach(o => {
    const status = (o.trang_thai_don_hang || "").toLowerCase();
    if (!finalizedStatuses.includes(status)) return;

    // "HH:mm:ss dd/MM/yyyy"
    const parts = o.ngay_len_don.split(' ');
    if (parts.length < 2) return;
    const dateParts = parts[1].split('/');
    const d = parseInt(dateParts[0]);
    const m = parseInt(dateParts[1]);
    const y = parseInt(dateParts[2]);

    if (m === month && y === year) {
      results.push({
        id: o.id_don_hang,
        salesId: (o.nguoi_len_don || "").toLowerCase(),
        value: parseMoney(o.so_tien_con_lai || o.tong_gia_tri || 0)
      });
    }
  });
  return results;
}

function parseMoney(val) {
  if (typeof val === 'number') return val;
  if (!val) return 0;
  return parseFloat(val.toString().replace(/[^\d]/g, '') || 0);
}

/**
 * Gửi email báo cáo cho Admin
 */
function sendEmailToAdmin(adminEmail, staffReports, totalRevenue, month, year) {
  const fmt = (num) => num.toLocaleString('vi-VN') + " đ";
  
  let staffRowsHtml = "";
  staffReports.forEach(s => {
    staffRowsHtml += `
      <tr>
        <td style="padding: 10px; border-bottom: 1px solid #eee;"><b>${s.name}</b><br><small>${s.email}</small></td>
        <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: center;">${s.customerCount}</td>
        <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: center;">${s.orderCount}</td>
        <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: right; color: #6366f1; font-weight: bold;">${fmt(s.revenue)}</td>
      </tr>
    `;
  });

  const htmlBody = `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: auto; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden;">
      <div style="background: #1e1b4b; color: white; padding: 25px; text-align: center;">
        <h2 style="margin:0;">BÁO CÁO DOANH SỐ THÁNG ${month}/${year}</h2>
        <p style="margin:5px 0 0; opacity: 0.8;">Hệ thống Quản lý Dunvex Green</p>
      </div>
      <div style="padding: 20px;">
        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #6366f1;">
          <div style="font-size: 13px; color: #64748b; font-weight: bold;">TỔNG DOANH THU NHÂN VIÊN PHỤ TRÁCH</div>
          <div style="font-size: 24px; font-weight: 800; color: #1e1b4b;">${fmt(totalRevenue)}</div>
        </div>

        <h3 style="font-size: 16px; color: #1e293b;">Chi tiết hiệu suất nhân viên:</h3>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #f1f5f9; text-align: left; font-size: 12px;">
              <th style="padding: 10px;">NHÂN VIÊN</th>
              <th style="padding: 10px; text-align: center;">KH MỚI</th>
              <th style="padding: 10px; text-align: center;">ĐƠN CHỐT</th>
              <th style="padding: 10px; text-align: right;">DOANH SỐ</th>
            </tr>
          </thead>
          <tbody>
            ${staffRowsHtml}
          </tbody>
        </table>

        <div style="margin-top: 30px; padding: 15px; background: #fffbeb; border-radius: 8px; border: 1px solid #fde68a; font-size: 13px;">
          <b>Ghi chú:</b> Báo cáo bao gồm các khách hàng được tạo mới và các đơn hàng có trạng thái "Đơn chốt" hoặc "Hoàn thành" trong tháng này.
        </div>
      </div>
      <div style="background: #f1f5f9; padding: 15px; text-align: center; font-size: 11px; color: #94a3b8;">
        Email được tạo tự động. Vui lòng không trả lời email này.<br>
        Thời gian xuất: ${Utilities.formatDate(new Date(), "GMT+7", "HH:mm dd/MM/yyyy")}
      </div>
    </div>
  `;

  MailApp.sendEmail({
    to: adminEmail,
    subject: `[BÁO CÁO THÁNG] Doanh số Nhân viên Tháng ${month}/${year} - Dunvex`,
    htmlBody: htmlBody
  });
}

/**
 * Hàm thiết lập Trigger chạy vào ngày 1 hàng tháng để báo cáo tháng trước
 */
function initMonthlyTrigger() {
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(t => {
    if (t.getHandlerFunction() === 'sendReportForPreviousMonth') ScriptApp.deleteTrigger(t);
  });

  ScriptApp.newTrigger('sendReportForPreviousMonth')
    .timeBased()
    .onMonthDay(1)
    .atHour(8)
    .create();
    
  return "Đã thiết lập báo cáo tự động vào 8h sáng ngày 1 hàng tháng.";
}

function sendReportForPreviousMonth() {
  const now = new Date();
  let m = now.getMonth(); // Tháng trước (0-11)
  let y = now.getFullYear();
  if (m === 0) { m = 12; y--; }
  else { m++; }
  return sendMonthlyAdminReport(m, y);
}
