/**
 * DUNVEX CRM & SALES CHECK-IN SYSTEM
 * Spreadsheet ID: 15niaoQ7FozkRCushPGNtq4zj6pwA0UQ5Wel61ksv8L8
 */

const CRM_SS_ID = '15niaoQ7FozkRCushPGNtq4zj6pwA0UQ5Wel61ksv8L8';




function doPost(e) {
  let result;
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;

    switch (action) {
      case 'setup': result = initCRM(); break;
      case 'getCustomers': result = getCustomers(data); break;
      case 'getAreas': result = getAreas(data); break;
      case 'createCustomer': result = handleCreateCustomer(data); break;
      case 'updateCustomer': result = handleUpdateCustomer(data); break;
      case 'deleteCustomer': result = handleDeleteCustomer(data); break;
      case 'handleCheckin': result = handleCheckin(data); break;
      case 'getCheckinHistory': result = getCheckinHistory(data); break;
      case 'addDoc': result = handleAddDoc(data); break;
      case 'uploadFile': result = handleFileUpload(data); break;
      case 'updateCustomerLocation': result = handleUpdateCustomerLocation(data); break;
      case 'sendMonthlyReport': result = sendMonthlyAdminReport(); break;
      default: result = { success: false, message: 'Hành động không hợp lệ' };
    }
  } catch (error) {
    result = { success: false, message: 'Lỗi CRM: ' + error.toString() };
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

// --- SECURITY CONFIG ---
const CIPHER_KEY = PropertiesService.getScriptProperties().getProperty('CRM_SECRET') || 'dv_secure_fallback_2024';

function encryptData(text) {
  if (!text) return "";
  try {
    const blob = Utilities.newBlob(text.toString());
    const encrypted = Utilities.encrypt(Utilities.CipherAlgorithm.AES_128, CIPHER_KEY, blob);
    return Utilities.base64Encode(encrypted);
  } catch (e) { return text; }
}

function decryptData(base64Text) {
  if (!base64Text || base64Text.length < 10) return base64Text;
  try {
    const decoded = Utilities.base64Decode(base64Text);
    const decrypted = Utilities.decrypt(Utilities.CipherAlgorithm.AES_128, CIPHER_KEY, decoded);
    return decrypted.getDataAsString();
  } catch (e) { return base64Text; }
}

function getSheet(name) {
  const ss = SpreadsheetApp.openById(CRM_SS_ID);
  return ss.getSheetByName(name) || ss.insertSheet(name);
}

/**
 * KHỞI TẠO CẤU TRÚC 3 BẢNG + BẢNG CẤU HÌNH KHU VỰC
 */
function initCRM() {
  const ss = SpreadsheetApp.openById(CRM_SS_ID);
  const configs = {
    'data_khach_hang': ['customer_id', 'ten_khach_hang', 'nguoi_lien_he_chinh', 'so_dien_thoai', 'email', 'dia_chi_kho_cua_hang', 'vi_tri', 'ma_sales_phu_trach', 'khu_vuc_thi_truong', 'ngay_tao', 'trang_thai'],
    'data_checkin': ['checkin_id', 'customer_id', 'ma_sales_checkin', 'thoi_gian_checkin', 'vi_tri_checkin', 'khoang_cach', 'muc_dich_gap_mat', 'ghi_chu_ket_qua', 'anh_minh_chung'],
    'thong_tin_khach': ['customer_id', 'ten_tai_lieu', 'loai_tai_lieu', 'link_file', 'ngay_cap_nhat', 'ghi_chu'],
    'config_khu_vuc': ['TÊN KHU VỰC', 'EMAIL SALES', 'MÔ TẢ']
  };
  for (let name in configs) {
    let sheet = ss.getSheetByName(name);
    if (!sheet) sheet = ss.insertSheet(name);
    sheet.getRange(1, 1, 1, configs[name].length).setValues([configs[name]]);
    
    // Thêm dữ liệu mẫu cho khu vực nếu bảng trống
    if (name === 'config_khu_vuc' && sheet.getLastRow() < 2) {
      sheet.appendRow(['Miền Nam', 'ALL', 'Khu vực phía Nam']);
      sheet.appendRow(['Miền Trung', 'ALL', 'Khu vực Miền Trung']);
      sheet.appendRow(['Miền Bắc', 'ALL', 'Khu vực phía Bắc']);
    }
  }
  return { success: true, message: 'Hệ thống CRM & Cấu hình khu vực đã sẵn sàng!' };
}

/**
 * Hàm hỗ trợ xóa cột theo tên (Dùng để dọn dẹp sheet theo yêu cầu)
 */
function removeColumnsByName(sheetName, columnNames) {
  const sheet = getSheet(sheetName);
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  
  // Xóa từ phải sang trái để tránh lệch index
  for (let i = headers.length - 1; i >= 0; i--) {
    if (columnNames.includes(headers[i])) {
      sheet.deleteColumn(i + 1);
    }
  }
}

function getAreas(data) {
  const sheet = getSheet('config_khu_vuc');
  const rows = sheet.getDataRange().getValues();
  const salesEmail = (data.salesId || "").toLowerCase().trim();
  const isAdmin = data.isAdmin === true;
  const viewAll = data.viewAll === true;
  
  const areas = [];
  for (let i = 1; i < rows.length; i++) {
    const assignedSales = (rows[i][1] || "").toString().toLowerCase().trim();
    
    let hasAccess = (assignedSales === 'all' || assignedSales === salesEmail);
    if (isAdmin && viewAll) hasAccess = true;

    if (hasAccess) {
      if (rows[i][0]) areas.push(rows[i][0]);
    }
  }
  return { success: true, areas: areas };
}

/**
 * HELPER: Lấy map index cột dựa trên header (Case-insensitive)
 */
function getColumnIndexMap(sheet) {
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const map = {};
  const searchKeys = {
    id: 'customer_id',
    name: 'ten_khach_hang',
    contact: 'nguoi_lien_he_chinh',
    phone: 'so_dien_thoai',
    email: 'email',
    address: 'dia_chi_kho_cua_hang',
    location: 'vi_tri',
    sales: 'ma_sales_phu_trach',
    area: 'khu_vuc_thi_truong',
    date: 'ngay_tao',
    status: 'trang_thai'
  };

  for (let key in searchKeys) {
    const target = searchKeys[key].toLowerCase();
    map[key] = headers.findIndex(h => h.toString().toLowerCase().trim() === target);
  }
  return map;
}

function handleCreateCustomer(data) {
  const sheet = getSheet('data_khach_hang');
  const idx = getColumnIndexMap(sheet);
  
  // ROBUST ID GENERATION
  const rows = sheet.getDataRange().getValues();
  let maxId = 0;
  for (let i = 1; i < rows.length; i++) {
    const currentId = (rows[i][idx.id] || "").toString();
    if (currentId.startsWith("KH")) {
      const num = parseInt(currentId.substring(2)) || 0;
      if (num > maxId) maxId = num;
    }
  }
  const id = "KH" + (maxId + 1).toString().padStart(5, '0');
  
  // Tự động thêm khu vực mới
  const areaSheet = getSheet('config_khu_vuc');
  const existingAreas = areaSheet.getDataRange().getValues().map(r => r[0].toString().toLowerCase());
  if (!existingAreas.includes(data.area.toLowerCase())) {
     areaSheet.appendRow([data.area, data.salesId, 'Tự động tạo từ Form']);
  }

  // Chuẩn bị hàng dữ liệu theo đúng thứ tự index
  const lastCol = sheet.getLastColumn();
  const newRowData = new Array(lastCol).fill("");
  
  if (idx.id !== -1) newRowData[idx.id] = id;
  if (idx.name !== -1) newRowData[idx.name] = data.name;
  if (idx.contact !== -1) newRowData[idx.contact] = data.contact;
  if (idx.phone !== -1) newRowData[idx.phone] = encryptData(data.phone);
  if (idx.email !== -1) newRowData[idx.email] = encryptData(data.email);
  if (idx.address !== -1) newRowData[idx.address] = data.address;
  if (idx.location !== -1) newRowData[idx.location] = data.location;
  if (idx.sales !== -1) newRowData[idx.sales] = data.salesId; // LƯU EMAIL NGƯỜI TẠO
  if (idx.area !== -1) newRowData[idx.area] = data.area;
  if (idx.date !== -1) newRowData[idx.date] = new Date();
  if (idx.status !== -1) newRowData[idx.status] = 'Đang hoạt động';

  sheet.appendRow(newRowData);
  return { success: true, customerId: id };
}

function handleUpdateCustomer(data) {
  const sheet = getSheet('data_khach_hang');
  const rows = sheet.getDataRange().getValues();
  const idx = getColumnIndexMap(sheet);
  
  if (idx.id === -1) return { success: false, message: 'Lỗi cấu trúc file (Thiếu customer_id)' };

  for (let i = 1; i < rows.length; i++) {
    if (rows[i][idx.id] === data.id) {
      const rowNum = i + 1;
      
      if (idx.name !== -1) sheet.getRange(rowNum, idx.name + 1).setValue(data.name);
      if (idx.contact !== -1) sheet.getRange(rowNum, idx.contact + 1).setValue(data.contact);
      if (idx.phone !== -1) sheet.getRange(rowNum, idx.phone + 1).setValue(encryptData(data.phone));
      if (idx.email !== -1) sheet.getRange(rowNum, idx.email + 1).setValue(encryptData(data.email));
      if (idx.address !== -1) sheet.getRange(rowNum, idx.address + 1).setValue(data.address);
      if (idx.location !== -1) sheet.getRange(rowNum, idx.location + 1).setValue(data.location);
      if (idx.area !== -1) sheet.getRange(rowNum, idx.area + 1).setValue(data.area);
      
      // Không ghi đè ma_sales_phu_trach, ngay_tao, trang_thai trừ khi cần thiết
      return { success: true };
    }
  }
  return { success: false, message: 'Không tìm thấy khách hàng' };
}

function handleUpdateCustomerLocation(data) {
  const sheet = getSheet('data_khach_hang');
  const rows = sheet.getDataRange().getValues();
  for (let i = 1; i < rows.length; i++) {
    if (rows[i][0] === data.id) {
      // Column 7 (Index 6) is 'vi_tri'
      sheet.getRange(i + 1, 7).setValue(data.location); 
      return { success: true };
    }
  }
  return { success: false, message: 'Không tìm thấy khách hàng' };
}

function handleDeleteCustomer(data) {
  const sheet = getSheet('data_khach_hang');
  const rows = sheet.getDataRange().getValues();
  for (let i = 1; i < rows.length; i++) {
    if (rows[i][0] === data.id) {
      sheet.deleteRow(i + 1);
      return { success: true };
    }
  }
  return { success: false, message: 'Không tìm thấy khách hàng' };
}

function handleCheckin(data) {
  const sheet = getSheet('data_checkin');
  const checkinId = "CI" + new Date().getTime();
  
  // Tính khoảng cách nếu có tọa độ khách hàng (Tùy chọn backend hoặc frontend)
  let distance = calculateDistance(data.customerLocation, data.checkinLocation);
  
  const row = [
    checkinId, data.customerId, data.salesId, new Date(), 
    data.checkinLocation, distance, data.purpose, 
    data.note, data.imageUrl || ''
  ];
  sheet.appendRow(row);
  return { success: true, checkinId: checkinId, distance: distance };
}

function getCheckinHistory(data) {
  try {
    // 1. Tự động dọn dẹp cột thừa nếu còn tồn tại
    removeColumnsByName('data_checkin', ['thoi_gian_checkout', 'da_duyet']);

    const sheet = getSheet('data_checkin');
    const custSheet = getSheet('data_khach_hang');
    if (sheet.getLastRow() < 2) return { success: true, history: [] };
    
    const rows = sheet.getDataRange().getValues();
    const headers = rows[0];
    const custRows = custSheet.getDataRange().getValues();
    const salesId = (data.salesId || "").toLowerCase().trim();
    const isAdmin = data.isAdmin === true;
    const viewAll = data.viewAll === true;
    
    // Tìm index cột để đảm bảo lấy đúng data kể cả khi sheet bị xáo trộn
    const idx = {
      id: headers.findIndex(h => h.toString().toLowerCase().trim() === 'checkin_id'),
      custId: headers.findIndex(h => h.toString().toLowerCase().trim() === 'customer_id'),
      salesId: headers.findIndex(h => h.toString().toLowerCase().trim() === 'ma_sales_checkin'),
      time: headers.findIndex(h => h.toString().toLowerCase().trim() === 'thoi_gian_checkin'),
      location: headers.findIndex(h => h.toString().toLowerCase().trim() === 'vi_tri_checkin'),
      dist: headers.findIndex(h => h.toString().toLowerCase().trim() === 'khoang_cach'),
      purpose: headers.findIndex(h => h.toString().toLowerCase().trim() === 'muc_dich_gap_mat'),
      note: headers.findIndex(h => h.toString().toLowerCase().trim() === 'ghi_chu_ket_qua'),
      image: headers.findIndex(h => h.toString().toLowerCase().trim() === 'anh_minh_chung')
    };

    const custMap = {};
    for (let j = 1; j < custRows.length; j++) {
      custMap[custRows[j][0]] = custRows[j][1];
    }

    const history = [];
    for (let i = 1; i < rows.length; i++) {
      const assignedSales = (rows[i][idx.salesId] || "").toString().toLowerCase().trim();
      
      // Strict filtering logic
      let hasAccess = (assignedSales === salesId);
      if (isAdmin && viewAll) hasAccess = true;

      if (hasAccess) {
        history.push({
          id: rows[i][idx.id],
          customerId: rows[i][idx.custId],
          customerName: custMap[rows[i][idx.custId]] || 'N/A',
          salesId: rows[i][idx.salesId],
          time: rows[i][idx.time],
          location: rows[i][idx.location],
          distance: rows[i][idx.dist],
          purpose: rows[i][idx.purpose],
          note: rows[i][idx.note],
          image: rows[i][idx.image]
        });
      }
    }
    return { success: true, history: history.reverse() };
  } catch (e) { return { success: false, message: e.toString() }; }
}

function handleAddDoc(data) {
  const sheet = getSheet('thong_tin_khach');
  sheet.appendRow([data.customerId, data.docName, data.type, data.fileUrl, new Date(), data.note]);
  return { success: true };
}

function getCustomers(data) {
  try {
    const sheet = getSheet('data_khach_hang');
    if (sheet.getLastRow() < 2) return { success: true, customers: [] };
    
    const rows = sheet.getDataRange().getValues();
    const headers = rows[0];
    const salesId = (data.salesId || "").toLowerCase().trim();
    const isAdmin = data.isAdmin === true;

    // Sử dụng helper để lấy index chính xác, không phân biệt hoa thường
    const idx = getColumnIndexMap(sheet);

    if (idx.id === -1) return { success: false, message: "Không tìm thấy cột customer_id trong bảng khách hàng." };

    const customers = [];
    for (let i = 1; i < rows.length; i++) {
      const assignedSales = idx.sales !== -1 ? (rows[i][idx.sales] || "").toString().toLowerCase().trim() : "";
      const viewAll = data.viewAll === true;
      
      // Strict Personal Filtering Logic:
      // 1. If it's public ('all'), everyone sees it
      // 2. If it matches current sales email, they see it
      // 3. If Admin AND 'viewAll' is explicitly requested, they see everything
      let hasAccess = (assignedSales === "all") || (assignedSales === salesId);
      if (isAdmin && viewAll) hasAccess = true;

      if (hasAccess) {
        customers.push({ 
          id: rows[i][idx.id], 
          name: idx.name !== -1 ? rows[i][idx.name] : "N/A", 
          contact: idx.contact !== -1 ? rows[i][idx.contact] : "",
          phone: idx.phone !== -1 ? decryptData(rows[i][idx.phone]) : "",
          email: idx.email !== -1 ? decryptData(rows[i][idx.email]) : "",
          location: idx.location !== -1 ? rows[i][idx.location] : "",
          address: idx.address !== -1 ? rows[i][idx.address] : "",
          area: idx.area !== -1 ? rows[i][idx.area] : "",
          salesOwner: assignedSales || "N/A",
          status: idx.status !== -1 ? rows[i][idx.status] : "N/A",
          ngay_tao: idx.date !== -1 ? rows[i][idx.date] : ""
        });
      }
    }
    return { success: true, customers: customers };
  } catch (e) {
    return { success: false, message: "Lỗi getCustomers: " + e.toString() };
  }
}

/**
 * TÍNH KHOẢNG CÁCH GIỮA 2 TỌA ĐỘ (HA VERSINE FORMULA)
 */
function calculateDistance(loc1, loc2) {
  if (!loc1 || !loc2) return 0;
  try {
    const [lat1, lon1] = loc1.split(',').map(Number);
    const [lat2, lon2] = loc2.split(',').map(Number);
    const R = 6371e3; // metres
    const φ1 = lat1 * Math.PI/180;
    const φ2 = lat2 * Math.PI/180;
    const Δφ = (lat2-lat1) * Math.PI/180;
    const Δλ = (lon2-lon1) * Math.PI/180;
    const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return Math.round(R * c);
  } catch(e) { return 0; }
}

function handleFileUpload(data) {
  try {
    // Phân loại folder theo loại file
    let folderId = '1dGFgw96a6gWVdHMq6rkk4fFRpDJqi5cG'; // Mặc định là Folder Image
    if (data.type === 'pdf' || (data.filename && data.filename.toLowerCase().endsWith('.pdf'))) {
      folderId = '1-XEQxyPtq8taCW8g7q-PWtJdKlNO3t4_'; // Folder PDF
    }
    
    const folder = DriveApp.getFolderById(folderId);
    const byteCharacters = Utilities.base64Decode(data.base64);
    const mimeType = data.type === 'pdf' ? MimeType.PDF : MimeType.JPEG;
    const blob = Utilities.newBlob(byteCharacters, mimeType, data.filename);
    const file = folder.createFile(blob).setName(data.filename);
    
    if (data.type !== 'pdf') {
       file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    }
    
    return { success: true, url: file.getUrl() };
  } catch (e) {
    return { success: false, message: e.toString() };
  }
}



