/**
 * GAS SCRIPT QUẢN LÝ SẢN PHẨM KHÁCH HÀNG
 * Phiên bản: 1.0.4 (HỖ TRỢ ĐỌC JSON TỪ DRIVE ĐỂ TRÁNH LỖI CORS)
 * Cập nhật: 30/12/2025 - Thêm logic đọc file JSON từ Drive
 */

const SPREADSHEET_ID = '1x_DgdgVJVjkzZt8_e7Zg0gqDnG7oHmV0H7DgebVzD3E';
const SHEET_NAME = 'tao_san_pham';
const IMAGE_FOLDER_ID = '1iIG2DNVH7hYKG0z74oDGaY3ndGWLqu_S';
const LEGACY_JSON_ID = '1Gt36oOwInVsa2VJXepZicTNQoQWJKT5A'; // ID file JSON trên Drive của bạn

function doGet(e) {
  try {
    const action = e.parameter.action;
    const email = e.parameter.username || e.parameter.email; 

    if (action === 'read') return readData(email);
    
    return jsonResponse({success: false, message: 'Invalid GET action: ' + action});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

function doPost(e) {
  let payload = null;
  try {
    if (e.postData && e.postData.contents) {
      payload = JSON.parse(e.postData.contents);
    }
  } catch (err) { payload = null; }

  if (!payload && e.parameter && e.parameter.payload) {
    try {
      payload = JSON.parse(e.parameter.payload);
    } catch (err) {
      return jsonResponse({success: false, message: 'Invalid payload: ' + err.toString()});
    }
  }

  if (!payload) return jsonResponse({success: false, message: 'No payload found'});

  try {
    const action = String(payload.action || '').trim().toLowerCase();

    if (action === 'upload') return uploadFile(payload);
    if (action === 'create' || action === 'update') return upsertProduct(payload.data, payload.idValue);
    if (action === 'delete') return deleteProduct(payload.idValue);

    return jsonResponse({success: false, message: 'Invalid POST action: ' + action});
  } catch (err) {
    return jsonResponse({success: false, message: 'System Error: ' + err.toString()});
  }
}

function readData(email) {
  try {
    // 1. Đọc dữ liệu từ Google Sheet
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = ss.getSheetByName(SHEET_NAME);
    
    if (!sheet) {
      sheet = ss.insertSheet(SHEET_NAME);
      sheet.appendRow(['id_san_pham', 'image_san_pham', 'ten_nghanh_hang', 'ten_san_pham', 'gia_san_pham', 'ten_dang_nhap', 'trang_thai_xoa_sp']);
    }

    const values = sheet.getDataRange().getValues();
    const sheetData = [];
    if (values.length >= 2) {
      const rawHeaders = values[0];
      const headers = rawHeaders.map(normalizeHeader);
      let emailIdx = getColIdx(headers, 'tendangnhap');
      if (emailIdx === -1) emailIdx = getColIdx(headers, 'maildangnhap');

      for (let i = 1; i < values.length; i++) {
          const row = values[i];
          if (!row.join('').trim()) continue;

          let obj = {};
          rawHeaders.forEach((h, index) => {
             const val = row[index];
             const normH = normalizeHeader(h);
             obj[normH] = val;                          
             obj[h] = val;                              
             if (normH === 'idsanpham') obj['id_san_pham'] = val; 
          });

          const itemEmail = emailIdx !== -1 ? String(row[emailIdx]).trim() : '';
          if (!email || emailIdx === -1 || itemEmail.toLowerCase() === email.toLowerCase()) {
            sheetData.push(obj);
          }
      }
    }

    // 2. Đọc dữ liệu từ file JSON trên Drive (Tránh lỗi CORS)
    let legacyData = [];
    try {
      const file = DriveApp.getFileById(LEGACY_JSON_ID);
      const content = file.getBlob().getDataAsString();
      legacyData = JSON.parse(content);
    } catch (e) {
      Logger.log("Legacy JSON load failed: " + e.toString());
    }

    return jsonResponse({
      success: true, 
      data: sheetData,
      legacyData: legacyData
    });
  } catch (err) { 
    return jsonResponse({success: false, message: err.toString()}); 
  }
}

function upsertProduct(data, idValue) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = ss.getSheetByName(SHEET_NAME);
    const values = sheet.getDataRange().getValues();
    const rawHeaders = values[0];
    const headers = rawHeaders.map(normalizeHeader);

    let idIdx = headers.indexOf('idsanpham');
    let currentId = idValue || data['id_san_pham'] || data['idsanpham'] || '';
    
    if (!currentId && idIdx !== -1) {
       let maxNum = 0;
       if (values.length > 1) {
         values.slice(1).forEach(r => {
            const val = String(r[idIdx]);
            const m = val.match(/S(\d+)/);
            if (m) {
               const num = parseInt(m[1]);
               if (num > maxNum) maxNum = num;
            }
         });
       }
       currentId = 'S' + String(maxNum + 1).padStart(3, '0');
       data['id_san_pham'] = currentId;
    }

    let rowIndex = -1;
    if (currentId && idIdx !== -1) {
      for (let i = 1; i < values.length; i++) {
         if (String(values[i][idIdx]).trim() === String(currentId).trim()) {
            rowIndex = i + 1;
            break;
         }
      }
    }

    const newRow = rawHeaders.map(h => {
       const normH = normalizeHeader(h);
       let val = data[h] !== undefined ? data[h] : data[normH];
       if (val === undefined) {
          const key = Object.keys(data).find(k => normalizeHeader(k) === normH);
          if (key) val = data[key];
       }
       return val !== undefined ? val : '';
    });

    if (rowIndex !== -1) {
       sheet.getRange(rowIndex, 1, 1, newRow.length).setValues([newRow]);
    } else {
       sheet.appendRow(newRow);
    }
    return jsonResponse({success: true, id: currentId});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

function deleteProduct(idValue) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(SHEET_NAME);
    const values = sheet.getDataRange().getValues();
    const headers = values[0].map(normalizeHeader);
    
    let idIdx = headers.indexOf('idsanpham');
    let deleteIdx = headers.indexOf('trangthaixoasp');
    if (deleteIdx === -1) deleteIdx = headers.indexOf('trangthaixoa');

    let found = false;
    for (let i = 1; i < values.length; i++) {
       if (String(values[i][idIdx]).trim() === String(idValue).trim()) {
          sheet.getRange(i + 1, deleteIdx + 1).setValue('DELETED');
          found = true;
          break;
       }
    }

    return jsonResponse({success: true, found: found});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

function uploadFile(payload) {
  try {
    const folder = DriveApp.getFolderById(IMAGE_FOLDER_ID);
    const blob = Utilities.newBlob(Utilities.base64Decode(payload.file), payload.mimeType, payload.filename);
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    return jsonResponse({success: true, url: 'https://lh3.googleusercontent.com/d/' + file.getId()});
  } catch (err) { return jsonResponse({success: false, message: err.toString()}); }
}

function normalizeHeader(h) {
  if (!h) return '';
  return String(h).trim()
    .replace(/đ/g, 'd').replace(/Đ/g, 'd')
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
    .replace(/[\s_]+/g, '').toLowerCase();
}

function getColIdx(headers, searchName) {
  return headers.indexOf(normalizeHeader(searchName));
}

function jsonResponse(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
}
