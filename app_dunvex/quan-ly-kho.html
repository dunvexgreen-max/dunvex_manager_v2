<!DOCTYPE html>
<html lang="vi">

<head>
	<!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-QFQ2HMYTDH"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag() { dataLayer.push(arguments); }
		gtag('js', new Date());

		gtag('config', 'G-QFQ2HMYTDH');
	</script>

	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Qu·∫£n L√Ω T·ªìn Kho | Dunvex Digital</title>
	<link rel="icon" type="image/svg+xml"
		href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%236366f1'/><text x='50%' y='50%' dominant-baseline='central' text-anchor='middle' fill='white' font-size='60' font-family='sans-serif' font-weight='800'>DV</text></svg>">
	<link
		href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@600;800&display=swap"
		rel="stylesheet">
	<style>
		:root {
			--primary: #6366f1;
			--accent: #c084fc;
			--bg-dark: #0f172a;
			--card-bg: rgba(30, 41, 59, 0.7);
			--glass-border: rgba(255, 255, 255, 0.1);
			--text-main: #ffffff;
			--text-muted: #cbd5e1;
			--danger: #ef4444;
			--success: #22c55e;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
			text-rendering: optimizeLegibility;
			-webkit-font-smoothing: antialiased;
			-moz-osx-font-smoothing: grayscale;
		}

		body {
			background-color: var(--bg-dark);
			color: var(--text-main);
			min-height: 100vh;
			padding: 40px 20px;
			background-image: radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%), radial-gradient(at 100% 100%, rgba(192, 132, 252, 0.15) 0px, transparent 50%);
			-webkit-text-size-adjust: 100%;
		}

		.container {
			max-width: 1100px;
			margin: 0 auto;
		}

		.header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
		}

		.header h1 {
			font-size: 2rem;
			font-weight: 800;
			background: linear-gradient(135deg, #fff, var(--primary));
			-webkit-background-clip: text;
			background-clip: text;
			-webkit-text-fill-color: transparent;
		}



		/* Tabs */
		.tabs {
			display: flex;
			gap: 10px;
			margin-bottom: 30px;
			background: var(--card-bg);
			padding: 6px;
			border-radius: 16px;
			width: fit-content;
		}

		.tab-btn {
			padding: 10px 24px;
			border-radius: 12px;
			border: none;
			background: transparent;
			color: var(--text-muted);
			font-weight: 600;
			cursor: pointer;
			transition: 0.3s;
		}

		.tab-btn.active {
			background: var(--primary);
			color: white;
			box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
		}

		/* View Content */
		.view-content {
			display: none;
			animation: fadeIn 0.4s ease;
		}

		.view-content.active {
			display: block;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(10px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		/* Cards/Table */
		.stock-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
			gap: 20px;
		}

		.stock-card {
			background: var(--card-bg);
			backdrop-filter: blur(10px);
			border: 1px solid var(--glass-border);
			padding: 24px;
			border-radius: 20px;
			position: relative;
			transition: 0.3s;
		}

		.stock-card:hover {
			border-color: var(--primary);
			transform: translateY(-5px);
		}

		.stock-name {
			font-weight: 800;
			font-size: 1.1rem;
			margin-bottom: 5px;
		}

		.stock-id {
			font-size: 0.75rem;
			color: var(--text-muted);
			margin-bottom: 15px;
		}

		.stock-value {
			font-size: 1.8rem;
			font-weight: 800;
			color: var(--primary);
		}

		.stock-unit {
			font-size: 0.9rem;
			color: var(--text-muted);
			margin-left: 5px;
		}

		.status-tag {
			position: absolute;
			top: 20px;
			right: 20px;
			padding: 4px 10px;
			border-radius: 8px;
			font-size: 0.7rem;
			font-weight: 800;
		}

		.status-low {
			background: rgba(239, 68, 68, 0.1);
			color: var(--danger);
		}

		.status-ok {
			background: rgba(34, 197, 94, 0.1);
			color: var(--success);
		}

		/* Form */
		.form-card {
			background: var(--card-bg);
			padding: 30px;
			border-radius: 24px;
			max-width: 600px;
			margin: 0 auto;
			border: 1px solid var(--glass-border);
		}

		.form-group {
			margin-bottom: 20px;
		}

		label {
			display: block;
			margin-bottom: 8px;
			font-weight: 600;
			color: var(--text-muted);
		}

		select,
		input,
		textarea {
			width: 100%;
			padding: 14px;
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid var(--glass-border);
			border-radius: 12px;
			color: white;
			outline: none;
			transition: 0.3s;
		}

		select:focus,
		input:focus {
			border-color: var(--primary);
			background: rgba(255, 255, 255, 0.1);
		}

		.btn-submit {
			width: 100%;
			padding: 16px;
			background: var(--primary);
			color: white;
			border: none;
			border-radius: 12px;
			font-size: 1rem;
			font-weight: 800;
			cursor: pointer;
			transition: 0.3s;
		}

		.btn-submit:hover {
			box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
			transform: translateY(-2px);
		}

		/* Loader */
		#loader {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(15, 23, 42, 0.8);
			z-index: 9999;
			justify-content: center;
			align-items: center;
		}

		.spinner {
			width: 40px;
			height: 40px;
			border: 4px solid rgba(255, 255, 255, 0.1);
			border-top-color: var(--primary);
			border-radius: 50%;
			animation: spin 1s infinite linear;
		}

		@keyframes spin {
			to {
				transform: rotate(360deg);
			}
		}

		/* Toast */
		#toast {
			position: fixed;
			bottom: 30px;
			left: 50%;
			transform: translateX(-50%) translateY(100px);
			padding: 15px 30px;
			border-radius: 50px;
			background: var(--primary);
			color: white;
			font-weight: 700;
			transition: 0.5s;
			z-index: 10000;
		}

		#toast.show {
			transform: translateX(-50%) translateY(0);
		}

		/* Floating Menu Style */
		.floating-actions {
			position: fixed;
			bottom: 30px;
			right: 30px;
			display: flex;
			flex-direction: column;
			gap: 12px;
			z-index: 1000;
		}

		.float-btn {
			width: 56px;
			height: 56px;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: 0.3s;
			box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
			border: 1px solid var(--glass-border);
			text-decoration: none;
		}

		.float-btn-main {
			background: var(--primary);
			color: white;
		}

		.float-btn:hover {
			transform: scale(1.1);
		}

		.menu-overlay {
			position: fixed;
			bottom: 100px;
			right: 30px;
			background: var(--card-bg);
			backdrop-filter: blur(20px);
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			width: 280px;
			padding: 12px;
			display: none;
			box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
			z-index: 1001;
		}

		.menu-overlay.active {
			display: block;
			animation: fadeInUp 0.3s ease;
		}

		@keyframes fadeInUp {
			from {
				opacity: 0;
				transform: translateY(20px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.menu-link {
			display: flex;
			align-items: center;
			gap: 12px;
			padding: 14px 16px;
			color: var(--text-main);
			text-decoration: none;
			border-radius: 12px;
			transition: 0.2s;
			font-weight: 600;
		}

		.menu-link:hover {
			background: rgba(255, 255, 255, 0.05);
			color: var(--accent-purple);
		}

		.menu-header {
			padding: 10px 16px;
			font-size: 0.75rem;
			text-transform: uppercase;
			letter-spacing: 1px;
			color: var(--text-muted);
			font-weight: 800;
		}

		.hidden {
			display: none !important;
		}

		.btn {
			padding: 10px 20px;
			border-radius: 12px;
			font-weight: 600;
			cursor: pointer;
			transition: 0.3s;
			border: none;
			font-size: 0.9rem;
			text-decoration: none;
		}

		/* History Table */
		.history-container {
			background: var(--card-bg);
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			overflow: hidden;
			margin-top: 20px;
		}

		.history-table {
			width: 100%;
			border-collapse: collapse;
			color: var(--text-main);
			font-size: 0.9rem;
		}

		.history-table th {
			background: rgba(255, 255, 255, 0.05);
			padding: 15px;
			text-align: left;
			font-weight: 700;
			color: var(--text-muted);
			text-transform: uppercase;
			font-size: 0.75rem;
			letter-spacing: 1px;
		}

		.history-table td {
			padding: 15px;
			border-bottom: 1px solid var(--glass-border);
		}

		.type-badge {
			padding: 4px 10px;
			border-radius: 8px;
			font-size: 0.7rem;
			font-weight: 800;
		}

		.type-nhap {
			background: rgba(34, 197, 94, 0.1);
			color: var(--success);
		}

		.type-xuat {
			background: rgba(239, 68, 68, 0.1);
			color: var(--danger);
		}

		.action-btns {
			display: flex;
			gap: 8px;
		}

		.btn-mini {
			padding: 6px 10px;
			border-radius: 8px;
			font-size: 0.75rem;
			cursor: pointer;
			border: none;
			color: white;
		}

		.btn-edit {
			background: var(--primary);
		}

		.btn-delete {
			background: var(--danger);
		}

		/* Modal Styles */
		.modal {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(15, 23, 42, 0.9);
			backdrop-filter: blur(5px);
			z-index: 10000;
			justify-content: center;
			align-items: center;
		}

		.modal.active {
			display: flex;
		}

		.modal-content {
			background: var(--bg-dark);
			border: 1px solid var(--glass-border);
			border-radius: 24px;
			width: 90%;
			max-width: 500px;
			padding: 30px;
			position: relative;
		}

		.modal-header {
			margin-bottom: 25px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.modal-close {
			cursor: pointer;
			color: var(--text-muted);
		}

		/* Responsive adjustments */
		@media (max-width: 768px) {
			body {
				padding: 20px 15px;
			}

			.header h1 {
				font-size: 1.5rem;
			}

			.tabs {
				width: 100%;
				overflow-x: auto;
				flex-wrap: nowrap;
				padding: 4px;
				scrollbar-width: none;
			}

			.tabs::-webkit-scrollbar {
				display: none;
			}

			.tab-btn {
				padding: 8px 16px;
				font-size: 0.85rem;
				white-space: nowrap;
			}

			.history-table th:nth-child(5),
			.history-table td:nth-child(5),
			.history-table th:nth-child(6),
			.history-table td:nth-child(6) {
				display: none;
				/* Hide Performer and Note on mobile */
			}

			.history-table th,
			.history-table td {
				padding: 10px 8px;
				font-size: 0.85rem;
			}

			.history-container {
				overflow-x: auto;
			}

			.stock-grid {
				grid-template-columns: 1fr;
			}
		}

		@media (max-width: 480px) {

			.history-table th:nth-child(1),
			.history-table td:nth-child(1) {
				display: none;
				/* Hide Date on very small screens to keep Product and Qty */
			}
		}
	</style>
</head>

<body>
	<div id="loader">
		<div class="spinner"></div>
	</div>
	<div id="toast">Th√¥ng b√°o!</div>

	<div class="container">
		<div class="header">
			<div>
				<h1 style="margin-top: 5px;">H·ªá Th·ªëng Kho V·∫≠n</h1>
			</div>
			<div style="display: flex; gap: 10px;">
				<button onclick="testEmailAlert()" class="btn"
					style="background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger);">üß™
					Test Mail</button>
				<a href="index.html" class="btn"
					style="background: var(--card-bg); color: white; border: 1px solid var(--glass-border);">üè† Trang
					ch·ªß</a>
			</div>
		</div>

		<div class="tabs">
			<button class="tab-btn active" onclick="switchTab('report')">üìä B√°o C√°o T·ªìn</button>
			<button class="tab-btn" onclick="switchTab('input')">‚ûï Nh·∫≠p Kho</button>
			<button class="tab-btn" onclick="switchTab('history')">üìú L·ªãch S·ª≠</button>
		</div>

		<!-- B√ÅO C√ÅO T·ªíN -->
		<div id="reportView" class="view-content active">
			<div id="stockGrid" class="stock-grid">
				<!-- Stock cards will load here -->
			</div>
		</div>

		<div id="inputView" class="view-content">
			<div class="form-card">
				<div class="form-group">
					<label>Lo·∫°i giao d·ªãch</label>
					<select id="invType" onchange="updateFormUI()">
						<option value="NHAP">‚ûï Nh·∫≠p Kho (TƒÉng s·ªë l∆∞·ª£ng)</option>
						<option value="XUAT">‚ûñ Xu·∫•t Kho (Gi·∫£m s·ªë l∆∞·ª£ng)</option>
					</select>
				</div>
				<div class="form-group">
					<label>Ch·ªçn s·∫£n ph·∫©m</label>
					<select id="prodSelect">
						<option value="">-- Click ƒë·ªÉ ch·ªçn s·∫£n ph·∫©m --</option>
					</select>
				</div>
				<div class="form-group">
					<label id="qtyLabel">S·ªë l∆∞·ª£ng nh·∫≠p</label>
					<input type="number" id="inpQty" placeholder="0">
				</div>
				<div class="form-group">
					<label>Ghi ch√∫</label>
					<textarea id="inpNote" placeholder="V√≠ d·ª•: L√¥ h√†ng m·ªõi t·ª´ nh√† m√°y..."></textarea>
				</div>
				<button class="btn-submit" id="btnInvSubmit" onclick="submitInventory()">X√°c Nh·∫≠n Nh·∫≠p Kho</button>
			</div>
		</div>

		<div id="historyView" class="view-content">
			<div class="history-container">
				<table class="history-table">
					<thead>
						<tr>
							<th>Ng√†y</th>
							<th>Lo·∫°i</th>
							<th>S·∫£n ph·∫©m</th>
							<th>S.L∆∞·ª£ng</th>
							<th>Ng∆∞·ªùi th·ª±c hi·ªán</th>
							<th>Ghi ch√∫</th>
							<th>H√†nh ƒë·ªông</th>
						</tr>
					</thead>
					<tbody id="historyBody">
						<!-- logs will load here -->
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<!-- Modal S·ª≠a B·∫£n Ghi -->
	<div class="modal" id="editModal">
		<div class="modal-content">
			<div class="modal-header">
				<h2 style="font-weight: 800;">S·ª≠a B·∫£n Ghi Kho</h2>
				<span class="modal-close" onclick="closeModal()">‚úï</span>
			</div>
			<input type="hidden" id="edit_log_id">
			<div class="form-group">
				<label>S·ªë l∆∞·ª£ng</label>
				<input type="number" id="edit_qty">
			</div>
			<div class="form-group">
				<label>Ghi ch√∫</label>
				<textarea id="edit_note" rows="3"></textarea>
			</div>
			<button class="btn-submit" onclick="saveEdit()">C·∫≠p Nh·∫≠t Thay ƒê·ªïi</button>
		</div>
	</div>

	<!-- Floating Actions Container -->
	<div class="floating-actions" id="mainFloatingActions">
		<div class="menu-overlay" id="menuOverlay">
			<div id="staffMenu" class="hidden">
				<div class="menu-header">Kinh Doanh & Kho</div>
				<a href="crm-sales.html" id="menu_checkin" class="menu-link hidden"
					style="color: var(--accent-purple); font-weight: 800;">üìç Check-in Sales</a>
				<a href="quan-ly-san-pham.html" id="menu_products" class="menu-link hidden"
					style="color: var(--primary); font-weight: 800;">üì¶ Qu·∫£n l√Ω S·∫£n ph·∫©m</a>
				<a href="len-don-hang.html" id="menu_create" class="menu-link hidden">üìù L√™n ƒë∆°n m·ªõi</a>
				<a href="danh-sach-don-hang.html" id="menu_list" class="menu-link hidden">üìã Danh s√°ch ƒë∆°n h√†ng</a>
				<a href="tao-bang-gia.html" id="menu_create_pl" class="menu-link hidden" style="color: #fbbf24;">üìù T·∫°o
					b·∫£ng gi√° m·ªõi</a>
				<a href="danh-sach-bang-gia.html" id="menu_list_pl" class="menu-link hidden" style="color: #fbbf24;">üè∑Ô∏è
					Danh s√°ch b·∫£ng gi√°</a>
				<a href="quan-ly-kho.html" id="menu_inventory" class="menu-link hidden" style="color: #22c55e;">üìä Qu·∫£n
					l√Ω kho v·∫≠n</a>
			</div>

			<div id="adminMenu" class="hidden">
				<div class="menu-header">Qu·∫£n Tr·ªã H·ªá Th·ªëng</div>
				<a href="admin-users.html" id="menu_admin" class="menu-link hidden"
					style="color: var(--accent-purple);">üîê C·∫•p quy·ªÅn nh√¢n vi√™n</a>
			</div>

			<div class="menu-link" onclick="logout()"
				style="color: #ef4444; border-top: 1px solid var(--glass-border); margin-top: 8px;">üö™ ƒêƒÉng xu·∫•t</div>
		</div>

		<div class="float-btn float-btn-main" onclick="toggleMenu()" id="menuTriggerBtn">
			<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<line x1="3" y1="12" x2="21" y2="12"></line>
				<line x1="3" y1="6" x2="21" y2="6"></line>
				<line x1="3" y1="18" x2="21" y2="18"></line>
			</svg>
		</div>
	</div>

	<script>
		const INV_URL = 'https://script.google.com/macros/s/AKfycbxhXNBpF0lgvQg-EQ-Y5GpBIfGl7orPeIZdkVIOo3BoJmvJpdqHvSnvrMQOtOzGZh_u/exec';
		const PROD_URL = 'https://script.google.com/macros/s/AKfycbw-iU2IYU1yHpybQ308SsY8QWJfp-zxJ9oZSfFJniREfctsbhCLy_7Rc-Ns0CFM8xDehg/exec';

		let currentUser = JSON.parse(localStorage.getItem('user'));
		if (!currentUser) window.location.href = 'auth.html';

		// X√°c ƒë·ªãnh email Admin qu·∫£n l√Ω (N·∫øu l√† Admin th√¨ l√† ch√≠nh m√¨nh, n·∫øu l√† NV th√¨ l·∫•y t·ª´ th√¥ng tin g√°n)
		const currentAdminEmail = currentUser.roleId === 'R001' ? currentUser.email : (currentUser.managerEmail || currentUser.email);

		let products = [];

		async function init() {
			checkAccessControl();
			updateFloatingMenuUI();
			// Ch·∫°y song song c·∫£ 2 t√°c v·ª• ƒë·ªÉ gi·∫£m th·ªùi gian ch·ªù
			Promise.all([
				loadProducts(),
				loadStockReport()
			]);
		}

		function checkAccessControl() {
			const perms = JSON.parse(localStorage.getItem('permissions') || '{}');
			// N·∫øu kh√¥ng c√≥ quy·ªÅn Nh·∫≠p Kho, h√£y ·∫©n tab v√† form
			if (perms.nhapKho === false) {
				const tabs = document.querySelectorAll('.tab-btn');
				if (tabs[1]) tabs[1].style.display = 'none'; // ·∫®n tab "Nh·∫≠p Kho"

				const btnSub = document.getElementById('btnInvSubmit');
				if (btnSub) {
					btnSub.disabled = true;
					btnSub.innerText = "B·∫†N KH√îNG C√ì QUY·ªÄN THAO T√ÅC";
					btnSub.style.opacity = "0.5";
					btnSub.style.cursor = "not-allowed";
				}
			}
		}

		function updateFloatingMenuUI() {
			const perms = JSON.parse(localStorage.getItem('permissions'));
			if (currentUser.roleId === 'R001') document.getElementById('adminMenu').classList.remove('hidden');
			document.getElementById('staffMenu').classList.remove('hidden');

			if (perms) {
				if (perms.checkinSales) document.getElementById('menu_checkin').classList.remove('hidden');
				if (perms.quanLySanPham) document.getElementById('menu_products').classList.remove('hidden');
				if (perms.lenDonMoi) document.getElementById('menu_create').classList.remove('hidden');
				if (perms.danhSachDonHang) document.getElementById('menu_list').classList.remove('hidden');
				if (perms.quanLyNhanVien) document.getElementById('menu_admin').classList.remove('hidden');
				if (perms.taoBangGia) document.getElementById('menu_create_pl').classList.remove('hidden');
				if (perms.xemBangGia) document.getElementById('menu_list_pl').classList.remove('hidden');
				if (perms.quanLyKho) document.getElementById('menu_inventory').classList.remove('hidden');
			}
		}

		function toggleMenu() {
			document.getElementById('menuOverlay').classList.toggle('active');
		}

		function logout() {
			localStorage.clear();
			window.location.href = 'auth.html';
		}

		// Close menu on outside click
		window.onclick = function (event) {
			const overlay = document.getElementById('menuOverlay');
			const trigger = document.getElementById('menuTriggerBtn');
			if (overlay && overlay.classList.contains('active') && !overlay.contains(event.target) && !trigger.contains(event.target)) {
				overlay.classList.remove('active');
			}
		}

		async function loadProducts() {
			try {
				const resProd = await fetch(PROD_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'get_products',
						userEmail: currentUser.email,
						isAdmin: currentUser.roleId === 'R001',
						adminEmail: currentUser.adminEmail
					})
				});
				const data = await resProd.json();
				if (data.success) {
					products = data.products;
					const select = document.getElementById('prodSelect');
					products.forEach(p => {
						const displayId = p.id_san_pham || 'Kh√¥ng ID';
						select.innerHTML += `<option value="${displayId}">${p.ten_san_pham} (${displayId})</option>`;
					});
				}
			} catch (e) {
				console.error(e);
			}
		}

		async function loadStockReport() {
			toggleLoader(true);
			try {
				const res = await fetch(INV_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'get_inventory_report',
						adminEmail: currentAdminEmail
					})
				});
				const data = await res.json();
				if (data.success) {
					renderStock(data.data);
				} else {
					console.error("Backend Error:", data.message);
					showToast("L·ªói t·ª´ h·ªá th·ªëng: " + data.message, true);
					document.getElementById('stockGrid').innerHTML = `<p style="grid-column: 1/-1; text-align: center; color: var(--danger); padding: 50px;">L·ªói t·∫£i d·ªØ li·ªáu: ${data.message}</p>`;
				}
			} catch (e) {
				console.error(e);
				showToast("L·ªói k·∫øt n·ªëi m√°y ch·ªß!", true);
				document.getElementById('stockGrid').innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--danger); padding: 50px;">Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi Script. Vui l√≤ng ki·ªÉm tra l·∫°i URL ho·∫∑c quy·ªÅn truy c·∫≠p.</p>';
			} finally {
				toggleLoader(false);
			}
		}

		function renderStock(list) {
			const grid = document.getElementById('stockGrid');
			if (!list || list.length === 0) {
				grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-muted); padding: 50px;">Ch∆∞a c√≥ d·ªØ li·ªáu t·ªìn kho cho doanh nghi·ªáp c·ªßa b·∫°n.</p>';
				return;
			}

			grid.innerHTML = list.map(item => `
				<div class="stock-card">
					<div class="status-tag ${item.tonKho < 10 ? 'status-low' : 'status-ok'}">
						${item.tonKho < 10 ? 'S·∫ÆP H·∫æT' : 'S·∫¥N H√ÄNG'}
					</div>
					<div class="stock-name">${item.name}</div>
					<div class="stock-id">${item.id}</div>
					<div class="stock-value">${item.tonKho.toLocaleString('vi-VN')}</div>
					<span class="stock-unit">${item.unit}</span>
					<div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 15px;">
						ƒê√£ nh·∫≠p: ${item.tongNhap} | ƒê√£ xu·∫•t: ${item.tongXuat}
					</div>
				</div>
			`).join('');
		}

		function updateFormUI() {
			const type = document.getElementById('invType').value;
			const label = document.getElementById('qtyLabel');
			const btn = document.getElementById('btnInvSubmit');

			if (type === 'NHAP') {
				label.innerText = "S·ªë l∆∞·ª£ng nh·∫≠p";
				btn.innerText = "X√°c Nh·∫≠n Nh·∫≠p Kho";
				btn.style.background = "var(--primary)";
			} else {
				label.innerText = "S·ªë l∆∞·ª£ng xu·∫•t";
				btn.innerText = "X√°c Nh·∫≠n Xu·∫•t Kho";
				btn.style.background = "var(--danger)";
			}
		}

		async function submitInventory() {
			const perms = JSON.parse(localStorage.getItem('permissions') || '{}');
			if (perms.nhapKho === false) {
				showToast("B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y!", true);
				return;
			}

			const type = document.getElementById('invType').value;
			const maSP = document.getElementById('prodSelect').value;
			const qty = document.getElementById('inpQty').value;
			const note = document.getElementById('inpNote').value;

			if (!maSP || !qty) {
				showToast("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!", true);
				return;
			}

			const prod = products.find(p => (p.id_san_pham || p.ma_san_pham) === maSP);
			if (!prod) {
				showToast("Kh√¥ng t√¨m th·∫•y th√¥ng tin s·∫£n ph·∫©m!", true);
				return;
			}

			toggleLoader(true);
			try {
				const res = await fetch(INV_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'save_inventory_entry',
						type: type, // NHAP ho·∫∑c XUAT
						productId: maSP,
						productName: prod.ten_san_pham,
						unit: prod.don_vi_tinh || 'C√°i',
						quantity: qty,
						userEmail: currentUser.email,
						adminEmail: currentAdminEmail,
						note: note
					})
				});
				const data = await res.json();
				if (data.success) {
					showToast(type === 'NHAP' ? "Nh·∫≠p kho th√†nh c√¥ng!" : "Xu·∫•t kho th√†nh c√¥ng!");
					document.getElementById('inpQty').value = '';
					document.getElementById('inpNote').value = '';
					switchTab('report');
					loadStockReport();
				} else {
					showToast("L·ªói: " + (data.message || "Kh√¥ng x√°c ƒë·ªãnh"), true);
				}
			} catch (e) {
				showToast("L·ªói k·∫øt n·ªëi ho·∫∑c Script ch∆∞a ƒë∆∞·ª£c c·∫•p quy·ªÅn!", true);
				console.error("Fetch Error:", e);
			} finally {
				toggleLoader(false);
			}
		}

		async function loadInventoryHistory() {
			toggleLoader(true);
			try {
				const res = await fetch(INV_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'get_inventory_logs',
						adminEmail: currentAdminEmail
					})
				});
				const data = await res.json();
				if (data.success) {
					renderHistory(data.data);
				}
			} catch (e) {
				console.error(e);
				showToast("L·ªói t·∫£i l·ªãch s·ª≠!", true);
			} finally {
				toggleLoader(false);
			}
		}

		function renderHistory(list) {
			const body = document.getElementById('historyBody');
			if (!list || list.length === 0) {
				body.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:50px; color:var(--text-muted);">Ch∆∞a c√≥ l·ªãch s·ª≠ giao d·ªãch.</td></tr>';
				return;
			}

			body.innerHTML = list.map(l => {
				const date = new Date(l.date).toLocaleString('vi-VN');
				const isAuto = l.id.startsWith("SYNC-");
				return `
					<tr>
						<td>${date}</td>
						<td><span class="type-badge ${l.type === 'NHAP' ? 'type-nhap' : 'type-xuat'}">${l.type === 'NHAP' ? 'NH·∫¨P' : 'XU·∫§T'}</span></td>
						<td><b>${l.productName}</b><br><small>${l.productId}</small></td>
						<td style="font-weight:700;">${l.quantity} ${l.unit}</td>
						<td><small>${l.user}</small></td>
						<td><small>${l.note || '-'}</small></td>
						<td class="action-btns">
							${isAuto ? '<span style="font-size:0.7rem; color:var(--text-muted);">T·ª± ƒë·ªông</span>' : `
								<button class="btn-mini btn-edit" onclick="openEditModal('${l.id}', ${l.quantity}, '${l.note || ""}')">S·ª≠a</button>
								<button class="btn-mini btn-delete" onclick="deleteLog('${l.id}')">X√≥a</button>
							`}
						</td>
					</tr>
				`;
			}).join('');
		}

		async function deleteLog(id) {
			if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi n√†y? T·ªìn kho s·∫Ω ƒë∆∞·ª£c t√≠nh to√°n l·∫°i.")) return;
			toggleLoader(true);
			try {
				const res = await fetch(INV_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'delete_inventory_entry',
						id: id,
						adminEmail: currentAdminEmail
					})
				});
				const data = await res.json();
				if (data.success) {
					showToast("ƒê√£ x√≥a b·∫£n ghi!");
					loadInventoryHistory();
					loadStockReport();
				} else {
					showToast(data.message, true);
				}
			} catch (e) {
				showToast("L·ªói k·∫øt n·ªëi", true);
			} finally {
				toggleLoader(false);
			}
		}

		function openEditModal(id, qty, note) {
			document.getElementById('edit_log_id').value = id;
			document.getElementById('edit_qty').value = qty;
			document.getElementById('edit_note').value = note;
			document.getElementById('editModal').classList.add('active');
		}

		function closeModal() {
			document.getElementById('editModal').classList.remove('active');
		}

		async function saveEdit() {
			const id = document.getElementById('edit_log_id').value;
			const qty = document.getElementById('edit_qty').value;
			const note = document.getElementById('edit_note').value;
			const btn = document.querySelector('#editModal .btn-submit');

			if (!qty) return showToast("Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng", true);

			// Disable button
			btn.disabled = true;
			btn.innerText = "ƒêang x·ª≠ l√Ω...";
			btn.style.opacity = "0.7";
			btn.style.cursor = "not-allowed";

			toggleLoader(true);
			try {
				const res = await fetch(INV_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'update_inventory_entry',
						id: id,
						quantity: qty,
						note: note,
						adminEmail: currentAdminEmail
					})
				});
				const data = await res.json();
				if (data.success) {
					showToast("ƒê√£ c·∫≠p nh·∫≠t b·∫£n ghi!");
					closeModal();
					loadInventoryHistory();
					loadStockReport();
				} else {
					showToast(data.message, true);
				}
			} catch (e) {
				showToast("L·ªói k·∫øt n·ªëi", true);
			} finally {
				toggleLoader(false);
				// Re-enable button
				btn.disabled = false;
				btn.innerText = "C·∫≠p Nh·∫≠t Thay ƒê·ªïi";
				btn.style.opacity = "1";
				btn.style.cursor = "pointer";
			}
		}

		function switchTab(tab) {
			document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
			document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));

			const view = document.getElementById(tab + 'View');
			if (view) view.classList.add('active');

			const btnMap = { 'report': 0, 'input': 1, 'history': 2 };
			const targetBtn = document.querySelectorAll('.tab-btn')[btnMap[tab]];
			if (targetBtn) targetBtn.classList.add('active');

			if (tab === 'history') loadInventoryHistory();
			if (tab === 'report') loadStockReport();
		}

		function toggleLoader(show) {
			document.getElementById('loader').style.display = show ? 'flex' : 'none';
		}

		function showToast(msg, isError = false) {
			const t = document.getElementById('toast');
			t.innerText = msg;
			t.style.background = isError ? 'var(--danger)' : 'var(--primary)';
			t.classList.add('show');
			setTimeout(() => t.classList.remove('show'), 3000);
		}

		async function testEmailAlert() {
			if (!confirm("H·ªá th·ªëng s·∫Ω g·ª≠i m·ªôt email c·∫£nh b√°o m·∫´u ƒë·∫øn: " + currentAdminEmail + "\nB·∫°n c√≥ mu·ªën th·ª±c hi·ªán kh√¥ng?")) return;
			toggleLoader(true);
			try {
				const res = await fetch(INV_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'test_email_alert',
						adminEmail: currentAdminEmail
					})
				});
				const data = await res.json();
				if (data.success) {
					showToast("ƒê√£ g·ª≠i email test th√†nh c√¥ng!");
				} else {
					showToast("L·ªói: " + data.message, true);
				}
			} catch (e) {
				showToast("L·ªói k·∫øt n·ªëi", true);
			} finally {
				toggleLoader(false);
			}
		}

		init();
	</script>
	<script src="chatbot.js"></script>
	<script src="floating-menu.js"></script>
</body>

</html>