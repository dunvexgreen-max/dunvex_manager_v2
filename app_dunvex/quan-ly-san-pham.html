<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Qu·∫£n l√Ω S·∫£n ph·∫©m | Dunvex Digital</title>
	<link rel="icon" type="image/svg+xml"
		href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%236366f1'/><text x='50%' y='50%' dominant-baseline='central' text-anchor='middle' fill='white' font-size='60' font-family='sans-serif' font-weight='800'>DV</text></svg>">
	<link
		href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@600;800&display=swap"
		rel="stylesheet">
	<style>
		:root {
			--primary: #6366f1;
			--bg-dark: #0f172a;
			--card-bg: rgba(30, 41, 59, 0.7);
			--glass-border: rgba(255, 255, 255, 0.1);
			--text-main: #ffffff;
			--text-muted: #cbd5e1;
			--accent-purple: #c084fc;
			--danger: #ef4444;
			--success: #22c55e;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
			text-rendering: optimizeLegibility;
			-webkit-font-smoothing: antialiased;
			-moz-osx-font-smoothing: grayscale;
		}

		body {
			background-color: var(--bg-dark);
			color: var(--text-main);
			min-height: 100vh;
			background-image: radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
				radial-gradient(at 100% 100%, rgba(192, 132, 252, 0.15) 0px, transparent 50%);
			padding: 20px;
			-webkit-text-size-adjust: 100%;
		}

		.container {
			max-width: 1100px;
			margin: 0 auto;
		}

		/* Top Bar */
		.top-bar {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 40px;
			padding: 20px 0;
		}

		.top-bar h1 {
			font-size: 2rem;
			font-weight: 800;
			background: linear-gradient(135deg, #fff, var(--primary));
			-webkit-background-clip: text;
			background-clip: text;
			-webkit-text-fill-color: transparent;
		}

		.actions {
			display: flex;
			gap: 15px;
		}

		/* Buttons */
		.btn {
			padding: 10px 20px;
			border-radius: 12px;
			font-weight: 600;
			cursor: pointer;
			transition: 0.3s;
			border: 1px solid var(--glass-border);
			display: flex;
			align-items: center;
			gap: 8px;
			text-decoration: none;
			font-size: 0.9rem;
		}

		.btn-primary {
			background: var(--primary);
			color: white;
			border: none;
		}

		.btn-primary:hover {
			background: #4f46e5;
			transform: translateY(-2px);
		}

		.btn-glass {
			background: rgba(255, 255, 255, 0.05);
			color: white;
		}

		.btn-glass:hover {
			background: rgba(255, 255, 255, 0.1);
		}

		/* Search Box */
		.search-box {
			position: relative;
			flex: 1;
			max-width: 400px;
		}

		.search-box input {
			width: 100%;
			padding: 12px 15px 12px 40px;
			background: rgba(0, 0, 0, 0.2);
			border: 1px solid var(--glass-border);
			border-radius: 12px;
			color: white;
			outline: none;
		}

		/* Filter Tabs */
		.filter-tabs {
			display: flex;
			gap: 10px;
			margin-bottom: 20px;
		}

		.filter-tab {
			padding: 8px 16px;
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			color: var(--text-muted);
			font-size: 0.8rem;
			font-weight: 600;
			cursor: pointer;
			transition: 0.3s;
		}

		.filter-tab.active {
			background: var(--primary);
			color: white;
			border-color: var(--primary);
		}

		/* Product Grid */
		.product-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
			gap: 30px;
		}

		.product-card {
			background: var(--card-bg);
			backdrop-filter: blur(10px);
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			overflow: hidden;
			transition: 0.3s;
			position: relative;
		}

		.product-card:hover {
			transform: translateY(-5px);
			border-color: var(--primary);
		}

		.image-container {
			width: 100%;
			height: 200px;
			background: #1e293b;
			display: flex;
			align-items: center;
			justify-content: center;
			overflow: hidden;
		}

		.image-container img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.product-info {
			padding: 20px;
		}

		.product-category {
			font-size: 0.75rem;
			color: var(--accent-purple);
			text-transform: uppercase;
			font-weight: 700;
			margin-bottom: 5px;
		}

		.product-title {
			font-size: 1.1rem;
			font-weight: 600;
			margin-bottom: 15px;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		.product-meta {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 10px;
			font-size: 0.85rem;
			color: var(--text-muted);
			margin-bottom: 20px;
		}

		.product-price {
			font-size: 1.25rem;
			font-weight: 800;
			color: var(--primary);
		}

		.card-actions {
			display: flex;
			gap: 10px;
		}

		.card-actions button {
			flex: 1;
			padding: 8px;
			font-size: 0.8rem;
		}

		/* Modal */
		.modal {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			backdrop-filter: blur(5px);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 1000;
			padding: 20px;
		}

		.modal.active {
			display: flex;
		}

		.modal-content {
			background: #1e293b;
			width: 100%;
			max-width: 600px;
			border-radius: 24px;
			padding: 30px;
			position: relative;
			max-height: 90vh;
			overflow-y: auto;
		}

		.form-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 15px;
		}

		.full-width {
			grid-column: span 2;
		}

		.form-group {
			margin-bottom: 20px;
		}

		label {
			display: block;
			font-size: 0.8rem;
			color: var(--text-muted);
			margin-bottom: 8px;
			text-transform: uppercase;
		}

		input,
		select {
			width: 100%;
			padding: 12px;
			background: rgba(0, 0, 0, 0.2);
			border: 1px solid var(--glass-border);
			border-radius: 10px;
			color: white;
			outline: none;
		}

		.image-upload-preview {
			width: 100px;
			height: 100px;
			background: rgba(0, 0, 0, 0.2);
			border-radius: 10px;
			margin-bottom: 10px;
			display: flex;
			align-items: center;
			justify-content: center;
			overflow: hidden;
			border: 1px dashed var(--glass-border);
		}

		.image-upload-preview img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		/* Toast */
		#toast {
			position: fixed;
			bottom: 30px;
			right: 30px;
			padding: 15px 25px;
			border-radius: 12px;
			background: var(--success);
			color: white;
			font-weight: 600;
			transform: translateY(150%);
			transition: 0.4s;
			z-index: 2000;
		}

		#toast.active {
			transform: translateY(0);
		}

		.loader {
			display: none;
			text-align: center;
			padding: 50px;
			font-size: 1.2rem;
			color: var(--text-muted);
		}

		/* Detail Modal (Iframe) */
		#viewModal .modal-content {
			max-width: 900px;
			padding: 0;
			overflow: hidden;
			background: transparent;
			height: 80vh;
		}

		#viewModal iframe {
			width: 100%;
			height: 100%;
			border: none;
			border-radius: 24px;
		}

		.close-view {
			position: absolute;
			top: 15px;
			right: 15px;
			background: rgba(0, 0, 0, 0.5);
			color: white;
			border: 1px solid var(--glass-border);
			width: 36px;
			height: 36px;
			border-radius: 50%;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 1010;
		}
	</style>
</head>

<body>

	<div id="toast">Th√¥ng b√°o!</div>

	<div class="container">
		<div class="top-bar">
			<div>
				<h1>üì¶ Shop Manager</h1>
				<p id="userStatus" style="color: var(--text-muted); font-size: 0.9rem;">ƒêang ƒëƒÉng nh·∫≠p: ...</p>
			</div>
			<div class="actions">
				<button class="btn btn-primary" onclick="openModal()">+ Th√™m S·∫£n Ph·∫©m</button>
				<a href="index.html" class="btn btn-glass">Tho√°t</a>
			</div>
		</div>

		<div style="margin-bottom: 30px;">
			<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
				<div class="search-box">
					<input type="text" id="searchInput" placeholder="T√¨m ki·∫øm trong danh m·ª•c c·ªßa b·∫°n..."
						oninput="applyFilters()">
				</div>
				<p id="stats" style="color: var(--text-muted); font-size: 0.9rem;">ƒêang t·∫£i...</p>
			</div>
		</div>

		<div id="loading" class="loader">üöÄ ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Drive...</div>
		<div id="productGrid" class="product-grid"></div>
	</div>

	<!-- VIEW DETAIL MODAL -->
	<div id="viewModal" class="modal">
		<div class="modal-content">
			<button class="close-view" onclick="closeViewModal()">&times;</button>
			<iframe src="" id="viewIframe"></iframe>
		</div>
	</div>

	<!-- MODAL FORM -->
	<div id="productModal" class="modal">
		<div class="modal-content">
			<h2 id="modalTitle" style="margin-bottom: 25px;">Th√™m S·∫£n Ph·∫©m M·ªõi</h2>
			<form id="productForm">
				<input type="hidden" id="edit_id">
				<div class="form-group">
					<label>·∫¢nh s·∫£n ph·∫©m</label>
					<div class="image-upload-preview" id="previewContainer">
						<img src="" id="imgPreview" style="display:none;">
						<span id="previewLabel">Ch∆∞a c√≥ ·∫£nh</span>
					</div>
					<input type="file" id="file_loader_anh" accept="image/*" onchange="previewImage(this)">
				</div>

				<div class="form-grid">
					<div class="form-group full-width">
						<label>T√™n S·∫£n Ph·∫©m *</label>
						<input type="text" id="ten_san_pham" required placeholder="T√™n s·∫£n ph·∫©m...">
					</div>
					<div class="form-group">
						<label>Ng√†nh H√†ng</label>
						<input type="text" id="ten_nghanh_hang" list="categoryList" placeholder="Pima, Duraflex...">
						<datalist id="categoryList"></datalist>
					</div>
					<div class="form-group">
						<label>Gi√° (VNƒê) *</label>
						<input type="number" id="gia_san_pham" required placeholder="0">
					</div>
					<div class="form-group">
						<label>Quy c√°ch</label>
						<input type="text" id="quy_cach" placeholder="1220x2440...">
					</div>
					<div class="form-group">
						<label>ƒê√≥ng ki·ªán</label>
						<input type="text" id="dong_kien" placeholder="V√≠ d·ª•: 20">
					</div>
					<div class="form-group">
						<label>Tr·ªçng l∆∞·ª£ng ri√™ng (kg)</label>
						<input type="text" id="trong_luong_rieng" placeholder="V√≠ d·ª•: 2.2 ho·∫∑c 2,2">
					</div>
				</div>

				<div style="display: flex; gap: 15px; margin-top: 20px;">
					<button type="submit" class="btn btn-primary" style="flex:2" id="btnSave">L∆ØU S·∫¢N PH·∫®M</button>
					<button type="button" class="btn btn-glass" style="flex:1" onclick="closeModal()">H·ª¶Y</button>
				</div>
			</form>
		</div>
	</div>

	<script>
		// C·∫§U H√åNH URL SCRIPT
		const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw-iU2IYU1yHpybQ308SsY8QWJfp-zxJ9oZSfFJniREfctsbhCLy_7Rc-Ns0CFM8xDehg/exec';

		let allProducts = [];
		let currentUser = JSON.parse(localStorage.getItem('user')) || { email: 'guest', roleId: 'guest' };

		// 1. T·∫£i d·ªØ li·ªáu
		async function loadData() {
			document.getElementById('loading').style.display = 'block';
			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'get_products',
						userEmail: currentUser.email,
						isAdmin: currentUser.roleId === 'R001',
						adminEmail: currentUser.adminEmail
					})
				});
				const data = await response.json();
				if (data.success) {
					allProducts = data.products;
					localStorage.setItem('last_loaded_products', JSON.stringify(allProducts));

					// C·∫≠p nh·∫≠t datalist ng√†nh h√†ng t·ª´ d·ªØ li·ªáu th·ª±c t·∫ø c·ªßa t·ªï ch·ª©c
					const cats = [...new Set(allProducts.map(p => p.ten_nghanh_hang || ''))].filter(c => c).sort();
					const dl = document.getElementById('categoryList');
					if (dl) {
						dl.innerHTML = cats.map(c => `<option value="${c}">`).join('');
					}

					applyFilters();
				} else {
					showToast("L·ªói: " + data.message, true);
				}
			} catch (e) {
				console.error(e);
				showToast("Kh√¥ng th·ªÉ k·∫øt n·ªëi Backend", true);
			}
			document.getElementById('loading').style.display = 'none';

			// Ki·ªÉm tra quy·ªÅn t·∫°o s·∫£n ph·∫©m
			const perms = JSON.parse(localStorage.getItem('permissions')) || {};
			const btnAdd = document.querySelector('button[onclick="openModal()"]');
			if (btnAdd) {
				// ƒê·ªÉ Admin (R001) c≈©ng b·ªã ch·∫∑n n·∫øu t·∫Øt Nh·∫≠p Kho trong sheet (nh∆∞ user y√™u c·∫ßu cho Nh·∫≠p Kho)
				const canCreate = (perms.taoSanPham !== false);
				btnAdd.style.display = canCreate ? 'block' : 'none';
			}

			const roleName = currentUser.roleId === 'R001' ? 'Qu·∫£n tr·ªã vi√™n' : 'Nh√¢n vi√™n';
			document.getElementById('userStatus').innerText = `${roleName}: ${currentUser.email}`;
		}

		// 2. Hi·ªÉn th·ªã danh s√°ch
		function renderProducts(products) {
			const grid = document.getElementById('productGrid');
			grid.innerHTML = products.map(p => `
                <div class="product-card">
                    <div class="image-container">
                        <img src="${convertDriveLink(p.image_san_pham) || 'https://placehold.co/300x200/1e293b/white?text=No+Image'}" 
                             onerror="this.src='https://placehold.co/300x200/1e293b/white?text=Error'">
                    </div>
                    <div class="product-info">
                        <div class="product-category">${p.ten_nghanh_hang || 'S·∫¢N PH·∫®M'}</div>
                        <div class="product-title" title="${p.ten_san_pham}">${p.ten_san_pham}</div>
                        <div class="product-meta">
                            <span>Quy c√°ch: ${p.quy_cach || '-'}</span>
                            <span>ƒê√≥ng ki·ªán: ${p.dong_kien || '-'}</span>
                            <span>Tr·ªçng l∆∞·ª£ng: ${p.trong_luong_rieng || '-'} kg</span>
                            <span class="full-width" style="grid-column: span 1; color: var(--accent-purple); font-size: 0.75rem;">üë§ Ng∆∞·ªùi t·∫°o: ${p.ten_dang_nhap ? p.ten_dang_nhap.split('@')[0] : 'H·ªá th·ªëng'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:15px;">
                            <div class="product-price">${formatPrice(p.gia_san_pham)} ƒë</div>
                            <span style="font-size: 0.7rem; color: var(--text-muted)">ID: ${p.id_san_pham}</span>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-primary" onclick="viewProductDetail('${p.id_san_pham}')">XEM</button>
                            <button class="btn btn-glass" onclick="editProduct('${p.id_san_pham}')">S·ª¨A</button>
                            <button class="btn btn-glass" style="color: var(--danger)" onclick="deleteProduct('${p.id_san_pham}')">X√ìA</button>
                        </div>
                    </div>
                </div>
            `).join('');
		}

		function convertDriveLink(url) {
			if (!url) return '';
			if (url.includes('drive.google.com')) {
				const id = url.split('/d/')[1]?.split('/')[0] || url.split('id=')[1]?.split('&')[0];
				return id ? `https://lh3.googleusercontent.com/d/${id}` : url;
			}
			return url;
		}

		// 3. X·ª≠ l√Ω Form L∆∞u
		document.getElementById('productForm').onsubmit = async (e) => {
			e.preventDefault();
			const perms = JSON.parse(localStorage.getItem('permissions') || '{}');
			if (perms.taoSanPham === false) {
				showToast("B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y!", true);
				return;
			}
			const btn = document.getElementById('btnSave');
			btn.disabled = true;
			btn.innerText = "ƒêANG X·ª¨ L√ù...";

			const id = document.getElementById('edit_id').value;
			const fileInput = document.getElementById('file_loader_anh');

			let imageData = null;
			if (fileInput.files[0]) {
				imageData = {
					filename: fileInput.files[0].name,
					mimetype: fileInput.files[0].type,
					base64: await fileToBase64(fileInput.files[0])
				};
			}

			const product = {
				id_san_pham: id,
				ten_san_pham: document.getElementById('ten_san_pham').value,
				ten_nghanh_hang: document.getElementById('ten_nghanh_hang').value,
				gia_san_pham: document.getElementById('gia_san_pham').value,
				quy_cach: document.getElementById('quy_cach').value,
				dong_kien: document.getElementById('dong_kien').value,
				trong_luong_rieng: document.getElementById('trong_luong_rieng').value.replace(',', '.'),
				ten_dang_nhap: currentUser.email,
				adminEmail: currentUser.adminEmail,
				image_san_pham: id ? allProducts.find(p => p.id_san_pham === id).image_san_pham : ""
			};

			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'save_product',
						product: product,
						image_data: imageData
					})
				});
				const data = await response.json();
				if (data.success) {
					showToast("ƒê√£ l∆∞u s·∫£n ph·∫©m th√†nh c√¥ng!");
					closeModal();
					loadData();
				} else {
					showToast("L·ªói l∆∞u: " + data.message, true);
				}
			} catch (e) {
				showToast("L·ªói k·∫øt n·ªëi", true);
			}
			btn.disabled = false;
			btn.innerText = "L∆ØU S·∫¢N PH·∫®M";
		};

		// 4. X√≥a
		async function deleteProduct(id) {
			if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m " + id + "?")) return;

			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({ action: 'delete_product', id_san_pham: id })
				});
				const data = await response.json();
				if (data.success) {
					showToast("ƒê√£ x√≥a s·∫£n ph·∫©m");
					loadData();
				}
			} catch (e) { showToast("L·ªói x√≥a", true); }
		}

		// 5. Xem chi ti·∫øt (Modal Iframe)
		function viewProductDetail(id) {
			localStorage.setItem('last_selected_product_id', id);
			localStorage.setItem('userLoggedIn', 'true');

			const iframe = document.getElementById('viewIframe');
			// ƒê·ªîI SANG CHI-TIET-SAN-PHAM.HTML THEO Y√äU C·∫¶U
			iframe.src = `chi-tiet-san-pham.html?id=${id}`;
			document.getElementById('viewModal').classList.add('active');
		}

		function closeViewModal() {
			document.getElementById('viewModal').classList.remove('active');
			document.getElementById('viewIframe').src = "";
		}

		// Ph·ª• tr·ª£
		function editProduct(id) {
			const p = allProducts.find(x => x.id_san_pham === id);
			if (!p) return;

			document.getElementById('edit_id').value = p.id_san_pham;
			document.getElementById('ten_san_pham').value = p.ten_san_pham;
			document.getElementById('ten_nghanh_hang').value = p.ten_nghanh_hang;
			document.getElementById('gia_san_pham').value = p.gia_san_pham;
			document.getElementById('quy_cach').value = p.quy_cach;
			document.getElementById('dong_kien').value = p.dong_kien;
			document.getElementById('trong_luong_rieng').value = p.trong_luong_rieng || '';

			document.getElementById('imgPreview').src = convertDriveLink(p.image_san_pham);
			document.getElementById('imgPreview').style.display = p.image_san_pham ? 'block' : 'none';
			document.getElementById('previewLabel').style.display = p.image_san_pham ? 'none' : 'block';

			document.getElementById('modalTitle').innerText = "S·ª≠a S·∫£n Ph·∫©m: " + id;
			openModal();
		}

		function previewImage(input) {
			if (input.files && input.files[0]) {
				const reader = new FileReader();
				reader.onload = function (e) {
					document.getElementById('imgPreview').src = e.target.result;
					document.getElementById('imgPreview').style.display = 'block';
					document.getElementById('previewLabel').style.display = 'none';
				}
				reader.readAsDataURL(input.files[0]);
			}
		}

		function fileToBase64(file) {
			return new Promise((resolve, reject) => {
				const reader = new FileReader();
				reader.readAsDataURL(file);
				reader.onload = () => resolve(reader.result.split(',')[1]);
				reader.onerror = error => reject(error);
			});
		}

		function applyFilters() {
			const q = document.getElementById('searchInput').value.toLowerCase();
			// Hi·ªÉn th·ªã to√†n b·ªô s·∫£n ph·∫©m c·ªßa t·ªï ch·ª©c (ƒë√£ ƒë∆∞·ª£c l·ªçc ·ªü Backend theo adminEmail)
			const filtered = allProducts.filter(p => {
				return p.ten_san_pham.toLowerCase().includes(q) ||
					p.ten_nghanh_hang.toLowerCase().includes(q) ||
					p.id_san_pham.toLowerCase().includes(q);
			});

			renderProducts(filtered);
			document.getElementById('stats').innerText = `T·ªïng c·ªông: ${filtered.length} s·∫£n ph·∫©m c·ªßa t·ªï ch·ª©c`;
		}

		function filterProducts() {
			applyFilters();
		}

		function formatPrice(num) {
			return Number(num).toLocaleString('vi-VN');
		}

		function updateStats() {
			document.getElementById('stats').innerText = `T·ªïng c·ªông: ${allProducts.length} s·∫£n ph·∫©m`;
		}

		function openModal() {
			document.getElementById('productModal').classList.add('active');
		}

		function closeModal() {
			document.getElementById('productModal').classList.remove('active');
			document.getElementById('productForm').reset();
			document.getElementById('edit_id').value = "";
			document.getElementById('imgPreview').style.display = 'none';
			document.getElementById('previewLabel').style.display = 'block';
		}

		function showToast(msg, isError = false) {
			const t = document.getElementById('toast');
			t.innerText = msg;
			t.style.background = isError ? 'var(--danger)' : 'var(--success)';
			t.classList.add('active');
			setTimeout(() => t.classList.remove('active'), 3000);
		}

		window.onload = loadData;
	</script>
	<script src="floating-menu.js"></script>
</body>

</html>