/**
 * GAS_Master_Script.txt
 * Script chuy√™n d·ª•ng cho Master Control Panel (Super Admin)
 * T√°ch bi·ªát kh·ªèi h·ªá th·ªëng Authentication ch√≠nh ƒë·ªÉ d·ªÖ d√†ng qu·∫£n l√Ω v√† n√¢ng c·∫•p.
 * 
 * PH·∫†M VI QUY·ªÄN: DriveApp, SpreadsheetApp, MailApp
 */

// --- C·∫§U H√åNH H·ªÜ TH·ªêNG MASTER ---
const MAIN_SPREADSHEET_ID = '1rhP1UCiMLi8yNVvcd56SsZIJAm09Yxu6WpjxuHKYKb0'; // Sheet ch·ª©a Auth
const MASTER_SPREADSHEET_ID = '1SiB4k-T7HoT9cNv-Q8KPIS3AnA6C_8HAX0hFyR3ZWOc'; // Sheet Master m·ªõi t·∫°o
const MASTER_SHEET_NAME = 'menu'; // T√™n sheet b·∫°n v·ª´a t·∫°o
const SCHEDULE_SHEET_NAME = 'ad_schedule'; // T√™n sheet l∆∞u l·ªãch h·∫πn
const MASTER_EMAIL = 'dunvex.green@gmail.com';
const AD_FOLDER_ID = '1SZTs8VvEKLIXPiKn7CA-OpmHIFXOzws5'; // Th∆∞ m·ª•c l∆∞u h√¨nh qu·∫£ng c√°o
const XOR_SECRET = 'dunvex_secure_key_2025_custom'; // ƒê√É ƒê·ªíNG B·ªò V·ªöI AUTH SCRIPT

// --- ENTRY POINT ---
function doPost(e) {
  let result;
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;

    // T·ª± ƒë·ªông ki·ªÉm tra v√† kh·ªüi t·∫°o ti√™u ƒë·ªÅ n·∫øu c·∫ßn
    initMasterSheetHeaders();
    
    switch (action) {
      case 'getMasterAllAccounts': result = getMasterAllAccounts(); break;
      case 'updateAdminConfig': result = updateAdminConfig(data); break;
      case 'checkAdminLimit': result = checkAdminLimit(data); break;
      case 'sendPromotion': result = handleSendPromotion(data); break;
      case 'schedulePromotion': result = handleSchedulePromotion(data); break;
      case 'uploadAdImage': result = handleUploadAdImage(data); break;
      case 'processScheduledAds': result = processScheduledAds(); break;
      default: 
        result = { success: false, message: 'H√†nh ƒë·ªông kh√¥ng h·ª£p l·ªá t·∫°i Master Script' };
    }
  } catch (error) {
    result = { success: false, message: 'L·ªói Master Backend: ' + error.toString() };
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

// --- CORE FUNCTIONS ---

function getMasterAllAccounts() {
  try {
    const mainSS = SpreadsheetApp.openById(MAIN_SPREADSHEET_ID);
    const adminSheet = mainSS.getSheetByName('admin');
    const useSheet = mainSS.getSheetByName('use');
    
    const masterSS = SpreadsheetApp.openById(MASTER_SPREADSHEET_ID);
    const masterSheet = masterSS.getSheetByName(MASTER_SHEET_NAME);
    
    const adminData = adminSheet.getDataRange().getValues();
    const useData = useSheet ? useSheet.getDataRange().getValues() : [];
    const configData = masterSheet.getDataRange().getValues();
    
    const allUsers = [];

    // 1. Qu√©t Admin Sheet
    for (let i = 1; i < adminData.length; i++) {
        const email = decryptData(adminData[i][1]).toLowerCase();
        const conf = configData.find(r => r[0].toString().toLowerCase() === email);
        
        allUsers.push({
            id: adminData[i][0], email: email, fullName: adminData[i][3],
            roleId: 'R001', owner: 'SYSTEM (ROOT)', status: adminData[i][5] || 'Ho·∫°t ƒë·ªông',
            package: conf ? conf[1] : 'Free', 
            expiry: conf ? conf[3] : '',
            regDate: adminData[i][6] || new Date(), type: 'ADMIN'
        });
    }

    // 2. Qu√©t Use Sheet
    for (let i = 1; i < useData.length; i++) {
        const email = decryptData(useData[i][1]).toLowerCase();
        const ownerEmail = decryptData(useData[i][5]) || '';
        allUsers.push({
            id: useData[i][0], email: email, fullName: useData[i][3],
            roleId: useData[i][4], owner: (!ownerEmail || ownerEmail === 'n/a') ? 'M·ªí C√îI (CH∆ØA G√ÅN)' : ownerEmail,
            status: useData[i][6] || 'Ho·∫°t ƒë·ªông', package: 'N/A', regDate: useData[i][7] || new Date(),
            type: (!ownerEmail || ownerEmail === 'n/a') ? 'ORPHAN' : 'STAFF'
        });
    }
    return { success: true, users: allUsers };
  } catch (e) { return { success: false, message: e.toString() }; }
}

function updateAdminConfig(data) {
  try {
    const email = (data.adminEmail || "").toLowerCase().trim();
    const mainSS = SpreadsheetApp.openById(MAIN_SPREADSHEET_ID);
    const masterSS = SpreadsheetApp.openById(MASTER_SPREADSHEET_ID);
    let updated = false;
    let oldStatus = "";

    // 1. C·∫≠p nh·∫≠t v√†o sheet Master 
    const masterSheet = masterSS.getSheetByName(MASTER_SHEET_NAME);
    const mRows = masterSheet.getDataRange().getValues();
    let rowIndex = -1;

    for (let i = 1; i < mRows.length; i++) {
      if (mRows[i][0].toString().toLowerCase() === email) {
        rowIndex = i + 1;
        oldStatus = mRows[i][5];
        break;
      }
    }

    if (rowIndex !== -1) {
      const oldPackage = mRows[rowIndex - 1][1];
      if (data.package) masterSheet.getRange(rowIndex, 2).setValue(data.package);
      
      // T·ª± ƒë·ªông n√¢ng c·∫•p l√™n 50 mail n·∫øu l√† Premium
      let finalMaxStaff = data.max_staff !== undefined ? data.max_staff : mRows[rowIndex - 1][2];
      if (data.package === 'Premium' && finalMaxStaff < 50) finalMaxStaff = 50;
      masterSheet.getRange(rowIndex, 3).setValue(finalMaxStaff);

      if (data.expiry) masterSheet.getRange(rowIndex, 4).setValue(data.expiry);
      if (data.status) masterSheet.getRange(rowIndex, 6).setValue(data.status);
      updated = true;

      // Ki·ªÉm tra n√¢ng c·∫•p l√™n Premium
      if (data.package === 'Premium' && oldPackage !== 'Premium') {
        sendPremiumUpgradeEmail(email, data.expiry || mRows[rowIndex - 1][3]);
      }
    } else {
      let finalMaxStaff = data.max_staff || 5;
      if (data.package === 'Premium') finalMaxStaff = 50;
      
      masterSheet.appendRow([
        email, data.package || 'Free', finalMaxStaff, data.expiry || '', '{}', 
        data.status || 'Ho·∫°t ƒë·ªông', new Date(), new Date(), '', ''
      ]);
      updated = true;
      if (data.package === 'Premium') {
        sendPremiumUpgradeEmail(email, data.expiry || '');
      }
    }

    // 2. ƒê·ªìng b·ªô Admin Sheet
    const adminSheet = mainSS.getSheetByName('admin');
    const aRows = adminSheet.getDataRange().getValues();
    for (let i = 1; i < aRows.length; i++) {
       if (decryptData(aRows[i][1]).toLowerCase() === email) {
         if (data.status) adminSheet.getRange(i + 1, 6).setValue(data.status);
         updated = true; break;
       }
    }

    // 3. ƒê·ªìng b·ªô Use Sheet
    const useSheet = mainSS.getSheetByName('use');
    if (useSheet) {
      const uRows = useSheet.getDataRange().getValues();
      for (let i = 1; i < uRows.length; i++) {
         if (decryptData(uRows[i][1]).toLowerCase() === email) {
           if (data.status) useSheet.getRange(i + 1, 7).setValue(data.status);
           updated = true; break;
         }
      }
    }

    if (updated && data.status && data.status !== oldStatus) {
      sendAccountStatusEmail(email, data.status);
    }

    return updated ? { success: true } : { success: false, message: 'Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n ƒë·ªÉ c·∫≠p nh·∫≠t' };
  } catch (e) { return { success: false, message: e.toString() }; }
}

/**
 * G·ª≠i qu·∫£ng c√°o/khuy·∫øn m√£i thuy·∫øt ph·ª•c n√¢ng c·∫•p g√≥i (H·ªó tr·ª£ nhi·ªÅu email)
 */
function handleSendPromotion(data) {
  try {
    const emails = Array.isArray(data.targetEmails) ? data.targetEmails : [data.targetEmail];
    const title = data.adTitle || "üî• ∆ØU ƒê√ÉI ƒê·∫∂C BI·ªÜT D√ÄNH RI√äNG CHO B·∫†N - DUNVEX";
    const content = data.adContent || "";
    const imageUrl = data.adImage || "";
    
    const htmlBody = `
      <div style="font-family: 'Segoe UI', Arial, sans-serif; max-width: 600px; margin: 0 auto; border: 1px solid #e0e7ff; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);">
        ${imageUrl ? `<img src="${imageUrl}" style="width: 100%; height: auto; display: block;" alt="Promotion">` : ''}
        <div style="padding: 40px; background: #ffffff;">
          <h2 style="color: #4f46e5; margin-top: 0; font-size: 24px; line-height: 1.3;">${title}</h2>
          <div style="color: #475569; font-size: 16px; line-height: 1.6; margin: 20px 0;">
            ${content.replace(/\n/g, '<br>')}
          </div>
          <div style="text-align: center; margin-top: 35px;">
            <a href="https://dunvex.com/upgrade" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; padding: 16px 32px; text-decoration: none; border-radius: 12px; font-weight: bold; display: inline-block; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);">N√ÇNG C·∫§P NGAY H√îM NAY</a>
          </div>
          <p style="text-align: center; font-size: 13px; color: #94a3b8; margin-top: 30px;">
            H·ªá th·ªëng Dunvex - Gi·∫£i ph√°p qu·∫£n tr·ªã doanh nghi·ªáp to√†n di·ªán.<br>
            B·∫°n nh·∫≠n ƒë∆∞·ª£c email n√†y v√¨ l√† th√†nh vi√™n c·ªßa Dunvex.
          </p>
        </div>
      </div>
    `;

    const masterSS = SpreadsheetApp.openById(MASTER_SPREADSHEET_ID);
    const sheet = masterSS.getSheetByName(MASTER_SHEET_NAME);

    emails.forEach(email => {
      const target = email.toLowerCase().trim();
      if (!target) return;

      MailApp.sendEmail({
        to: target,
        subject: title,
        htmlBody: htmlBody
      });

      // Ghi l·∫°i l·ªãch s·ª≠
      const rows = sheet.getDataRange().getValues();
      for (let i = 1; i < rows.length; i++) {
        if (rows[i][0].toString().toLowerCase() === target) {
          const history = rows[i][9] || "";
          const newHistory = (history ? history + "\n" : "") + "[" + new Date().toLocaleDateString() + "] ƒê√£ g·ª≠i: " + title;
          sheet.getRange(i + 1, 10).setValue(newHistory);
          break;
        }
      }
    });

    return { success: true, message: `ƒê√£ g·ª≠i th√†nh c√¥ng cho ${emails.length} t√†i kho·∫£n!` };
  } catch (e) {
    return { success: false, message: 'L·ªói g·ª≠i qu·∫£ng c√°o: ' + e.toString() };
  }
}

/**
 * H·∫πn gi·ªù g·ª≠i qu·∫£ng c√°o
 */
function handleSchedulePromotion(data) {
  try {
    const masterSS = SpreadsheetApp.openById(MASTER_SPREADSHEET_ID);
    let schedSheet = masterSS.getSheetByName(SCHEDULE_SHEET_NAME);
    if (!schedSheet) {
      schedSheet = masterSS.insertSheet(SCHEDULE_SHEET_NAME);
      schedSheet.appendRow(['Scheduled Time', 'Emails', 'Title', 'Content', 'Image', 'Status']);
    }

    const emails = Array.isArray(data.targetEmails) ? data.targetEmails.join(',') : data.targetEmail;
    schedSheet.appendRow([
      data.scheduledTime, // YYYY-MM-DDTHH:mm
      emails,
      data.adTitle,
      data.adContent,
      data.adImage,
      'PENDING'
    ]);

    // T·∫°o trigger n·∫øu ch∆∞a c√≥ (ch·∫°y m·ªói ph√∫t)
    ensureMinuteTrigger();

    return { success: true, message: 'ƒê√£ l·∫≠p l·ªãch th√†nh c√¥ng!' };
  } catch (e) {
    return { success: false, message: 'L·ªói l·∫≠p l·ªãch: ' + e.toString() };
  }
}

function ensureMinuteTrigger() {
  const triggers = ScriptApp.getProjectTriggers();
  const hasTrigger = triggers.some(t => t.getHandlerFunction() === 'processScheduledAds');
  if (!hasTrigger) {
    ScriptApp.newTrigger('processScheduledAds').timeBased().everyMinutes(1).create();
  }
}

/**
 * H√†m qu√©t v√† g·ª≠i qu·∫£ng c√°o ƒë√£ h·∫πn gi·ªù (Trigger m·ªói ph√∫t)
 */
function processScheduledAds() {
  try {
    const masterSS = SpreadsheetApp.openById(MASTER_SPREADSHEET_ID);
    const sheet = masterSS.getSheetByName(SCHEDULE_SHEET_NAME);
    if (!sheet) return;

    const rows = sheet.getDataRange().getValues();
    const now = new Date();

    for (let i = 1; i < rows.length; i++) {
      const status = rows[i][5];
      if (status !== 'PENDING') continue;

      const schedTime = new Date(rows[i][0]);
      if (schedTime <= now) {
        // G·ª≠i qu·∫£ng c√°o
        handleSendPromotion({
          targetEmails: rows[i][1].split(','),
          adTitle: rows[i][2],
          adContent: rows[i][3],
          adImage: rows[i][4]
        });

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i
        sheet.getRange(i + 1, 6).setValue('SENT');
      }
    }
  } catch (e) {
    Logger.log("L·ªói g·ª≠i b√†i h·∫πn gi·ªù: " + e.toString());
  }
}

/**
 * X·ª≠ l√Ω t·∫£i l√™n h√¨nh ·∫£nh qu·∫£ng c√°o v√†o Drive
 */
function handleUploadAdImage(data) {
  try {
    const folder = DriveApp.getFolderById(AD_FOLDER_ID);
    const contentType = data.mimeType || "image/jpeg";
    const base64Data = data.base64Data;
    const fileName = "AD_" + new Date().getTime() + "_" + data.fileName;
    
    // Gi·∫£i m√£ Base64 sang Blob
    const decodedData = Utilities.base64Decode(base64Data);
    const blob = Utilities.newBlob(decodedData, contentType, fileName);
    
    // L∆∞u v√†o Drive
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    // Tr·∫£ v·ªÅ link lh3 ƒë·ªÉ hi·ªÉn th·ªã tr·ª±c ti·∫øp trong email
    const viewUrl = "https://lh3.googleusercontent.com/d/" + file.getId();
    
    return { success: true, url: viewUrl };
  } catch (e) {
    return { success: false, message: "L·ªói Upload Drive: " + e.toString() };
  }
}

/**
 * Ki·ªÉm tra gi·ªõi h·∫°n nh√¢n s·ª± cho Admin
 */
function checkAdminLimit(data) {
  try {
    const email = (data.adminEmail || "").toLowerCase().trim();
    const masterSS = SpreadsheetApp.openById(MASTER_SPREADSHEET_ID);
    const mSheet = masterSS.getSheetByName(MASTER_SHEET_NAME);
    const rows = mSheet.getDataRange().getValues();
    const config = rows.find(r => r[0].toString().toLowerCase() === email);
    
    // Default limit
    let limit = 5;
    let pkg = 'Free';
    
    if (config) {
      pkg = config[1];
      limit = parseInt(config[2]) || (pkg === 'Premium' ? 50 : 5);
    }
    
    const mainSS = SpreadsheetApp.openById(MAIN_SPREADSHEET_ID);
    const useSheet = mainSS.getSheetByName('use');
    const useData = useSheet ? useSheet.getDataRange().getValues() : [];
    let current = 0;
    for (let i = 1; i < useData.length; i++) {
      if (decryptData(useData[i][5]).toLowerCase() === email) current++;
    }
    return { canCreate: current < limit, current: current, limit: limit, package: pkg };
  } catch (e) { return { success: false, message: e.toString() }; }
}

/**
 * L·∫•y th√¥ng tin g√≥i c∆∞·ªõc c·ªßa Admin
 */
function getAdminPackage(email) {
  try {
    const ss = SpreadsheetApp.openById(MASTER_SPREADSHEET_ID);
    const sheet = ss.getSheetByName(MASTER_SHEET_NAME);
    const rows = sheet.getDataRange().getValues();
    const config = rows.find(r => r[0].toString().toLowerCase() === email.toLowerCase());
    return config ? { package: config[1], expiry: config[3] } : { package: 'Free', expiry: '' };
  } catch (e) { return { package: 'Free', expiry: '' }; }
}

// --- TI·ªÜN √çCH KH·ªûI T·∫†O ---

function initMasterSheetHeaders() {
  const ss = SpreadsheetApp.openById(MASTER_SPREADSHEET_ID);
  let sheet = ss.getSheetByName(MASTER_SHEET_NAME);
  if (!sheet) {
    sheet = ss.insertSheet(MASTER_SHEET_NAME);
  }
  
  if (sheet.getLastRow() === 0) {
    sheet.appendRow([
      'admin_email', 
      'package', 
      'max_staff', 
      'report_expiry', 
      'features_json', 
      'status', 
      'created_date',
      'last_active',
      'notes',
      'ad_history'
    ]);
    sheet.setFrozenRows(1);
    // Format header ƒë·∫πp
    sheet.getRange(1, 1, 1, 10).setBackground('#ef4444').setFontColor('#ffffff').setFontWeight('bold');
  }
}

// --- TI·ªÜN √çCH G·ª¨I EMAIL ---

function sendAccountStatusEmail(email, status) {
  const isLocked = status === 'T·∫°m kh√≥a';
  const subject = isLocked ? "‚ö†Ô∏è TH√îNG B√ÅO T·∫†M KH√ìA T√ÄI KHO·∫¢N - DUNVEX" : "‚úÖ TH√îNG B√ÅO M·ªû KH√ìA T√ÄI KHO·∫¢N - DUNVEX";
  const statusHtml = isLocked ? 
    `<span style="color: #ef4444; font-weight: bold;">T·∫†M KH√ìA</span>` : 
    `<span style="color: #22c55e; font-weight: bold;">ƒêANG HO·∫†T ƒê·ªòNG</span>`;
  
  const body = `
    <div style="font-family: sans-serif; max-width: 600px; margin: 0 auto; border: 1px solid #e2e8f0; border-radius: 16px; padding: 40px; line-height: 1.6;">
      <h2 style="color: #1e293b; border-bottom: 2px solid #6366f1; padding-bottom: 10px;">C·∫≠p nh·∫≠t tr·∫°ng th√°i T√†i kho·∫£n</h2>
      <p>Ch√†o b·∫°n,</p>
      <p>Ch√∫ng t√¥i xin th√¥ng b√°o tr·∫°ng th√°i t√†i kho·∫£n Dunvex c·ªßa b·∫°n (<b>${email}</b>) ƒë√£ ƒë∆∞·ª£c thay ƒë·ªïi th√†nh: ${statusHtml}</p>
      
      ${isLocked ? `
        <div style="background: #fff1f2; border-left: 4px solid #ef4444; padding: 20px; margin: 25px 0;">
          <p style="margin: 0; color: #991b1b;"><b>L√Ω do:</b> T√†i kho·∫£n hi·ªán ƒëang b·ªã ƒë√¨nh ch·ªâ quy·ªÅn truy c·∫≠p t·∫°m th·ªùi.</p>
          <p style="margin: 10px 0 0 0; color: #991b1b;">Vui l√≤ng li√™n h·ªá Admin qua email: <a href="mailto:${MASTER_EMAIL}">${MASTER_EMAIL}</a> ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£ m·ªü l·∫°i t√†i kho·∫£n.</p>
        </div>
      ` : `
        <div style="background: #f0fdf4; border-left: 4px solid #22c55e; padding: 20px; margin: 25px 0;">
          <p style="margin: 0; color: #166534;">T√†i kho·∫£n c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t tr·ªü l·∫°i. B√¢y gi·ªù b·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p v√†o h·ªá th·ªëng b√¨nh th∆∞·ªùng.</p>
        </div>
      `}
      
      <p style="font-size: 0.85rem; color: #64748b; margin-top: 40px; border-top: 1px solid #f1f5f9; padding-top: 20px;">
        Tr√¢n tr·ªçng,<br><b>Dunvex Digital Team</b>
      </p>
    </div>
  `;

  try {
    MailApp.sendEmail({
      to: email,
      subject: subject,
      htmlBody: body
    });
  } catch (e) {
    console.error("L·ªói g·ª≠i mail: " + e.toString());
  }
}

/**
 * G·ª≠i email ch√∫c m·ª´ng n√¢ng c·∫•p Premium
 */
function sendPremiumUpgradeEmail(email, expiryDate) {
  const expiryStr = expiryDate ? new Date(expiryDate).toLocaleDateString('vi-VN') : "V√¥ th·ªùi h·∫°n";
  const subject = "üíé CH√öC M·ª™NG! B·∫†N ƒê√É TR·ªû TH√ÄNH TH√ÄNH VI√äN PREMIUM - DUNVEX";
  
  const body = `
    <div style="font-family: 'Segoe UI', Arial, sans-serif; max-width: 600px; margin: 0 auto; border: 2px solid #a855f7; border-radius: 20px; overflow: hidden;">
      <div style="background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%); padding: 40px; text-align: center; color: white;">
        <div style="font-size: 50px; margin-bottom: 20px;">üíé</div>
        <h1 style="margin: 0; font-size: 28px; letter-spacing: 1px;">X√ÅC NH·∫¨N N√ÇNG C·∫§P</h1>
        <p style="opacity: 0.9; margin-top: 10px;">Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi ƒë·∫∑c quy·ªÅn Premium</p>
      </div>
      
      <div style="padding: 40px; background: white; color: #1e293b;">
        <p style="font-size: 18px;">Ch√†o b·∫°n, <b>${email}</b></p>
        <p style="line-height: 1.6;">Ch√∫ng t√¥i v√¥ c√πng vui m·ª´ng th√¥ng b√°o r·∫±ng t√†i kho·∫£n c·ªßa b·∫°n ƒë√£ ch√≠nh th·ª©c ƒë∆∞·ª£c n√¢ng c·∫•p l√™n h·∫°ng <b>Cao c·∫•p (Premium)</b>.</p>
        
        <div style="background: #f5f3ff; border-radius: 12px; padding: 25px; margin: 30px 0; border: 1px dashed #a855f7;">
          <p style="margin: 0; color: #7c3aed; font-weight: bold; font-size: 1.1rem;">üåü Tr·∫°ng th√°i VIP: ƒê√É K√çCH HO·∫†T</p>
          <p style="margin: 10px 0 0 0; color: #4b5563;">H·∫°n m·ª©c b·∫£n quy·ªÅn: <span style="color: #ef4444; font-weight: 700;">${expiryStr}</span></p>
          <p style="margin: 10px 0 0 0; font-size: 0.9rem; color: #6b7280;"><i>(Sau ng√†y n√†y, c√°c b√°o c√°o n√¢ng cao s·∫Ω t·∫°m ng∆∞ng cho ƒë·∫øn khi ƒë∆∞·ª£c gia h·∫°n)</i></p>
        </div>

        <p>B√¢y gi·ªù b·∫°n ƒë√£ c√≥ ƒë·∫ßy ƒë·ªß quy·ªÅn l·ª£i:</p>
        <ul style="color: #4b5563; padding-left: 20px;">
          <li>M·ªü kh√≥a to√†n b·ªô t√≠nh nƒÉng B√°o c√°o doanh thu chuy√™n s√¢u.</li>
          <li>Qu·∫£n l√Ω nh√¢n s·ª± kh√¥ng gi·ªõi h·∫°n (t√πy theo g√≥i).</li>
          <li>∆Øu ti√™n h·ªó tr·ª£ k·ªπ thu·∫≠t 24/7.</li>
        </ul>

        <div style="text-align: center; margin-top: 40px;">
          <a href="https://dunvex.com" style="background: #a855f7; color: white; padding: 15px 35px; text-decoration: none; border-radius: 10px; font-weight: bold; display: inline-block; box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);">TRUY C·∫¨P H·ªÜ TH·ªêNG NGAY</a>
        </div>
      </div>
      
      <div style="background: #f9fafb; padding: 20px; text-align: center; color: #9ca3af; font-size: 12px;">
        ƒê√¢y l√† email t·ª± ƒë·ªông t·ª´ h·ªá th·ªëng qu·∫£n tr·ªã Dunvex. Vui l√≤ng kh√¥ng tr·∫£ l·ªùi email n√†y.
      </div>
    </div>
  `;

  try {
    MailApp.sendEmail({
      to: email,
      subject: subject,
      htmlBody: body
    });
  } catch (e) {
    console.error("L·ªói g·ª≠i mail Premium: " + e.toString());
  }
}

// --- TI·ªÜN √çCH M√É H√ìA (ƒê·ªíNG B·ªò V·ªöI AUTH SCRIPT) ---

function encryptData(text) {
  if (!text) return "";
  const inputBytes = Utilities.newBlob(text.toString()).getBytes();
  const keyBytes = Utilities.newBlob(XOR_SECRET).getBytes();
  const outputBytes = inputBytes.map((b, i) => b ^ keyBytes[i % keyBytes.length]);
  return Utilities.base64Encode(outputBytes);
}

function decryptData(base64Text) {
  if (!base64Text || base64Text.length < 5) return base64Text;
  try {
    const inputBytes = Utilities.base64Decode(base64Text);
    const keyBytes = Utilities.newBlob(XOR_SECRET).getBytes();
    const xorBytes = inputBytes.map((b, i) => b ^ keyBytes[i % keyBytes.length]);
    return Utilities.newBlob(xorBytes).getDataAsString();
  } catch (e) { return base64Text; }
}
