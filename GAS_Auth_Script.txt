/**
 * GOOGLE APPS SCRIPT - AUTHENTICATION SYSTEM (XOR SECURE)
 */

const SPREADSHEET_ID = '1rhP1UCiMLi8yNVvcd56SsZIJAm09Yxu6WpjxuHKYKb0';

function doPost(e) {
  let result;
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;

    switch (action) {
      case 'sendOTP': result = handleSendOTP(data); break;
      case 'verifyOTP': result = handleVerifyOTP(data); break;
      case 'register': result = handleRegister(data); break;
      case 'login': result = handleLogin(data); break;
      case 'getUsers': result = getUsers(data); break;
      case 'createUser': result = handleCreateUser(data); break;
      case 'updateRole': result = handleUpdateRole(data); break;
      case 'resetPassword': result = handleResetPassword(data); break;
      case 'get_phan_quyen': result = getPhanQuyen(); break;
      case 'save_phan_quyen': result = savePhanQuyen(data); break;
      case 'getRoles': result = getRoles(); break;
      case 'setup': result = initSystem(); break;
      default: 
        result = { success: false, message: 'Hành động không hợp lệ' };
    }
  } catch (error) {
    result = { success: false, message: 'Lỗi hệ thống: ' + error.toString() };
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

// --- CONFIG & UTILS ---
function getSheet(name) { return SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(name); }
function hashPassword(p) { return Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_256, p).map(b => ('0' + (b & 0xFF).toString(16)).slice(-2)).join(''); }

const XOR_SECRET = 'dunvex_secure_key_2025_custom';
const AES_KEY = Utilities.newBlob('dunvex_secure_16').getBytes();

function encryptData(text) {
  if (!text) return "";
  const inputBytes = Utilities.newBlob(text.toString()).getBytes();
  const keyBytes = Utilities.newBlob(XOR_SECRET).getBytes();
  const outputBytes = inputBytes.map((b, i) => b ^ keyBytes[i % keyBytes.length]);
  return Utilities.base64Encode(outputBytes);
}

function decryptData(base64Text) {
  if (!base64Text || base64Text.length < 5) return base64Text;
  try {
    // Try XOR first
    const inputBytes = Utilities.base64Decode(base64Text);
    const keyBytes = Utilities.newBlob(XOR_SECRET).getBytes();
    const xorBytes = inputBytes.map((b, i) => b ^ keyBytes[i % keyBytes.length]);
    const dec = Utilities.newBlob(xorBytes).getDataAsString();
    if (dec && (dec.includes('@') || dec.length > 0)) return dec;
  } catch (e) {
    // Try AES as fallback
    try {
      const decoded = Utilities.base64Decode(base64Text);
      return Utilities.decrypt(Utilities.CipherAlgorithm.AES_128, AES_KEY, decoded).getDataAsString();
    } catch (e2) { return base64Text; }
  }
  return base64Text;
}

// --- CORE FUNCTIONS ---
function findUserInSheet(sName, email, hashedPass, isUseSheet = false) {
  const sheet = getSheet(sName);
  if (!sheet || sheet.getLastRow() <= 1) return null;
  const rows = sheet.getDataRange().getValues();
  const searchEmail = email.toLowerCase().trim();

  for (let i = 1; i < rows.length; i++) {
    const rowEmail = decryptData(rows[i][1]).toLowerCase();
    const rowPass = (rows[i][2] || "").toString().trim();
    if (rowEmail === searchEmail && (hashedPass === null || rowPass === hashedPass)) {
      return {
        id: rows[i][0],
        email: rowEmail,
        fullName: rows[i][3],
        roleId: rows[i][4],
        status: isUseSheet ? rows[i][6] : rows[i][5]
      };
    }
  }
  return null;
}

function handleLogin(d) {
  const email = (d.email || "").toLowerCase().trim();
  const hashedPass = hashPassword(d.password || "");
  const user = findUserInSheet('admin', email, hashedPass) || findUserInSheet('use', email, hashedPass, true);
  
  if (!user) {
    logAction('Đăng nhập', email, 'Thất bại', 'Guest');
    return { success: false, message: 'Sai thông tin đăng nhập' };
  }

  let adminEmail = email; 
  if (user.id.startsWith('US')) {
    const rows = getSheet('use').getDataRange().getValues();
    const row = rows.find(r => decryptData(r[1]).toLowerCase() === email);
    if (row) adminEmail = decryptData(row[5]);
  }
  
  logAction('Đăng nhập', email, 'Thành công', email);
  return { success: true, user: user, permissions: getPermissions(user.roleId, adminEmail) };
}

// --- OTP & REGISTRATION ---
function handleSendOTP(data) {
  const email = (data.email || "").toString().trim().toLowerCase();
  const otp = Math.floor(100000 + Math.random() * 900000).toString();
  const expire = new Date(new Date().getTime() + 5 * 60000); // 5 mins
  const sheet = getSheet('otps');
  
  // Clean old OTPs
  if(sheet.getLastRow() > 0) {
    const rows = sheet.getDataRange().getValues();
    for (let i = rows.length - 1; i >= 1; i--) {
        if (rows[i][0] && decryptData(rows[i][0]) === email) sheet.deleteRow(i + 1);
    }
  }
  
  // Save new OTP
  const encEmail = encryptData(email);
  sheet.appendRow([encEmail, otp, expire]);
  
  try {
    MailApp.sendEmail({
      to: email,
      subject: "Mã xác thực Dunvex Account: " + otp,
      htmlBody: `
        <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 20px auto; border: 1px solid #6366f1; border-radius: 16px; padding: 40px 20px; box-sizing: border-box;">
          <h2 style="color: #6366f1; text-align: center; font-size: 24px; margin-bottom: 20px; font-weight: 800;">Xác thực OTP</h2>
          <p style="text-align: center; color: #475569; font-size: 15px; margin-bottom: 30px;">
            Chào bạn, đây là mã xác thực để bạn thực hiện thay đối trên hệ thống Dunvex:
          </p>
          <div style="background: #f0f7ff; border: 1px solid #6366f1; padding: 25px; text-align: center; border-radius: 12px; margin: 20px 0;">
            <span style="font-size: 48px; font-weight: 900; letter-spacing: 12px; color: #1e1b4b; display: block;">${otp}</span>
          </div>
          <p style="text-align: center; font-size: 12px; color: #94a3b8; margin-top: 30px;">
            Mã có hiệu lực trong 5 phút. Vui lòng bảo mật mã này.
          </p>
        </div>
      `
    });
    return { success: true, message: 'Đã gửi mã xác thực!' };
  } catch (e) { return { success: false, message: e.toString() }; }
}

function handleVerifyOTP(data) {
  const success = verifyOTP(data.email, data.otp);
  return { success: success, message: success ? "Xác thực thành công" : "Mã OTP không đúng hoặc hết hạn" };
}

function verifyOTP(email, otp) {
  const sheet = getSheet('otps');
  if(sheet.getLastRow() <= 1) return false;
  const rows = sheet.getDataRange().getValues();
  const now = new Date().getTime();
  const lowerEmail = email.toLowerCase();
  
  for (let i = 1; i < rows.length; i++) {
    const rowEmail = decryptData(rows[i][0]);
    if (rowEmail === lowerEmail && rows[i][1].toString() === otp.toString()) {
      if (now < new Date(rows[i][2]).getTime()) { 
        sheet.deleteRow(i + 1); 
        return true; 
      }
    }
  }
  return false;
}

function handleRegister(data) {
  const email = (data.email || "").toLowerCase().trim();
  if (!verifyOTP(email, data.otp)) return { success: false, message: 'OTP sai hoặc hết hạn' };
  
  const roleId = data.roleId || 'R005';
  const prefix = (roleId === 'R001' ? 'AD' : 'US');
  const sheetName = (roleId === 'R001' ? 'admin' : 'use');
  const id = generateNextId(sheetName, prefix);
  const encEmail = encryptData(email);
  
  const sheet = getSheet(sheetName);
  if (roleId === 'R001') {
    sheet.appendRow([id, encEmail, hashPassword(data.password), data.fullName, 'R001', 'Hoạt động', new Date()]);
  } else {
    sheet.appendRow([id, encEmail, hashPassword(data.password), data.fullName, 'R005', encryptData('n/a'), 'Hoạt động', new Date()]);
  }
  return { success: true };
}

function handleResetPassword(d) {
  const email = (d.email || "").toString().trim().toLowerCase();
  const newPass = (d.newPassword || "").toString().trim();
  
  if (!verifyOTP(email, d.otp)) return { success: false, message: 'OTP sai hoặc hết hạn' };
  
  for (let name of ['admin', 'use']) {
    const sheet = getSheet(name);
    if (!sheet || sheet.getLastRow() <= 1) continue;
    const rows = sheet.getDataRange().getValues();
    for (let i = 1; i < rows.length; i++) {
      const rowEmail = decryptData(rows[i][1]).toLowerCase();
      if (rowEmail === email) {
        sheet.getRange(i + 1, 3).setValue(hashPassword(newPass));
        return { success: true };
      }
    }
  }
  return { success: false, message: 'Không tìm thấy tài khoản với email này' };
}

function getUsers(d) {
  const sheet = getSheet('use');
  if (sheet.getLastRow() <= 1) return { success: true, users: [] };
  const rows = sheet.getDataRange().getValues();
  const adminEmail = (d.adminEmail || "").toLowerCase().trim();

  // Check Root Admin
  const roots = getSheet('admin').getDataRange().getValues();
  const isRoot = roots.some((r, i) => i > 0 && decryptData(r[1]).toLowerCase() === adminEmail);

  const users = [];
  for (let i = 1; i < rows.length; i++) {
    const assigned = (decryptData(rows[i][5]) || "").toLowerCase().trim();
    // Logic: Show if Root OR assigned matches OR is orphan (N/A)
    if (isRoot || assigned === adminEmail || !assigned || assigned === 'n/a') {
      users.push({
        id: rows[i][0],
        email: decryptData(rows[i][1]),
        fullName: rows[i][3],
        roleId: rows[i][4],
        status: rows[i][6]
      });
    }
  }
  return { success: true, users: users };
}

function handleCreateUser(d) {
  const email = d.email.toLowerCase().trim();
  const sheet = getSheet('use');
  const rows = sheet.getDataRange().getValues();

  for (let i = 1; i < rows.length; i++) {
    if (decryptData(rows[i][1]).toLowerCase() === email) {
      const assigned = (decryptData(rows[i][5]) || "").toLowerCase().trim();
      if (!assigned || assigned === 'n/a') {
        sheet.getRange(i + 1, 6).setValue(encryptData(d.adminEmail));
        return { success: true, message: 'Đã kết nối tài khoản cũ vào danh sách của bạn!' };
      }
      return { success: false, message: 'Email đã thuộc Admin khác' };
    }
  }

  const id = generateNextId('use', 'US');
  sheet.appendRow([id, encryptData(email), hashPassword(d.password || '123456'), d.fullName, d.roleId, encryptData(d.adminEmail), 'Hoạt động', new Date()]);
  return { success: true };
}

function handleUpdateRole(d) {
  const sheet = getSheet('use');
  const rows = sheet.getDataRange().getValues();
  const email = d.userEmail.toLowerCase().trim();
  for (let i = 1; i < rows.length; i++) {
    if (decryptData(rows[i][1]).toLowerCase() === email) {
      sheet.getRange(i+1, 5).setValue(d.newRoleId);
      sheet.getRange(i+1, 2).setValue(encryptData(email)); // Force re-encrypt to XOR
      return { success: true };
    }
  }
  return { success: false };
}

function getPermissions(roleId, adminEmail = "ALL") {
  const sheet = getSheet('phan_quyen');
  if (!sheet || sheet.getLastRow() <= 1) return null;
  const rows = sheet.getDataRange().getValues();
  const targetAdmin = adminEmail.toLowerCase().trim();
  let specific = null, general = null;

  for (let i = 1; i < rows.length; i++) {
    if (rows[i][0] == roleId) {
      const p = { checkinSales:!!rows[i][3], quanLySanPham:!!rows[i][4], danhSachDonHang:!!rows[i][5], quanLyNhanVien:!!rows[i][6], xemBangGia:!!rows[i][7], quanLyKho:!!rows[i][8] };
      const rowAdmin = decryptData(rows[i][2]).toLowerCase();
      if (rowAdmin === targetAdmin) specific = p;
      if (rowAdmin === 'all') general = p;
    }
  }
  return specific || general;
}

function getPhanQuyen() {
  const sheet = getSheet('phan_quyen');
  if (!sheet || sheet.getLastRow() <= 1) return { success: true, data: [] };
  const rows = sheet.getDataRange().getValues();
  return { 
    success: true, 
    data: rows.slice(1).map(r => ({
      id_vai_tro: r[0], ten_vai_tro: r[1], email_quan_ly: decryptData(r[2]),
      checkin_sales: !!r[3], quan_ly_san_pham: !!r[4], danh_sach_don_hang: !!r[5],
      quan_ly_nhan_vien: !!r[6], xem_bang_gia: !!r[7], quan_ly_kho: !!r[8]
    }))
  };
}

function savePhanQuyen(d) {
  const sheet = getSheet('phan_quyen');
  const rows = sheet.getDataRange().getValues();
  const adminEnc = encryptData(d.email_quan_ly.toLowerCase());
  const adminPlain = d.email_quan_ly.toLowerCase();

  for (let i = 1; i < rows.length; i++) {
    if (rows[i][0] == d.id_vai_tro && decryptData(rows[i][2]).toLowerCase() === adminPlain) {
      sheet.getRange(i+1, 4, 1, 6).setValues([[d.checkin_sales, d.quan_ly_san_pham, d.danh_sach_don_hang, d.quan_ly_nhan_vien, d.xem_bang_gia, d.quan_ly_kho]]);
      return { success: true };
    }
  }
  sheet.appendRow([d.id_vai_tro, d.ten_vai_tro, adminEnc, d.checkin_sales, d.quan_ly_san_pham, d.danh_sach_don_hang, d.quan_ly_nhan_vien, d.xem_bang_gia, d.quan_ly_kho]);
  return { success: true };
}

function getRoles() {
  const rows = getSheet('roles_lookup').getDataRange().getValues();
  return { success: true, roles: rows.filter((r, i) => i > 0 && r[0]).map(r => ({ id: r[0], name: r[1] })) };
}

function generateNextId(sName, prefix) {
  const sheet = getSheet(sName);
  const lastRow = sheet.getLastRow();
  if (lastRow <= 1) return prefix + '-001';
  const ids = sheet.getRange("A2:A" + lastRow).getValues().flat();
  const max = ids.reduce((m, id) => {
    const n = parseInt(id.toString().split('-').pop());
    return isNaN(n) ? m : Math.max(m, n);
  }, 0);
  return prefix + '-' + (max + 1).toString().padStart(3, '0');
}

function logAction(action, target, result, performer) {
  const sheet = getSheet('logs');
  if (!sheet) return;
  const now = new Date();
  const id = "L" + Utilities.formatDate(now, "GMT+7", "yyyyMMddHHmmss");
  sheet.appendRow([id, Utilities.formatDate(now, "GMT+7", "dd/MM/yyyy HH:mm:ss"), action, encryptData(target), result, encryptData(performer), "System"]);
}

function initSystem() {
  migrateAuthEmailsToEncrypted();
  return { success: true, message: 'Đã nâng cấp mã hóa XOR thành công!' };
}

function migrateAuthEmailsToEncrypted() {
  const configs = [
    { sheet: 'admin', cols: [1] },
    { sheet: 'use', cols: [1, 5] },
    { sheet: 'phan_quyen', cols: [2] },
    { sheet: 'logs', cols: [3, 5] }
  ];
  configs.forEach(c => {
    const s = getSheet(c.sheet); if (!s || s.getLastRow() < 2) return;
    const data = s.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      c.cols.forEach(col => {
        const val = (data[i][col] || "").toString();
        if (val.includes('@') && val.length < 50) s.getRange(i+1, col+1).setValue(encryptData(val.toLowerCase()));
      });
    }
  });
}
