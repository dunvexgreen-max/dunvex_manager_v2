/**
 * GOOGLE APPS SCRIPT - OTP SYSTEM (FULLY AUTHENTICATED)
 * Spreadsheet ID: 1rhP1UCiMLi8yNVvcd56SsZIJAm09Yxu6WpjxuHKYKb0
 */

const SPREADSHEET_ID = '1rhP1UCiMLi8yNVvcd56SsZIJAm09Yxu6WpjxuHKYKb0';

/**
 * HÀM TEST GỬI MAIL TRỰC TIẾP
 */
function testSendMail() {
  const myEmail = Session.getActiveUser().getEmail();
  try {
    MailApp.sendEmail({
      to: myEmail,
      subject: "Test xác thực từ Dunvex",
      body: "Chúc mừng! Tài khoản " + myEmail + " đã cấp quyền gửi mail thành công."
    });
    Logger.log("Thành công! Kiểm tra mail: " + myEmail);
  } catch(e) {
    Logger.log("Lỗi: " + e.toString());
  }
}

function doPost(e) {
  let result;
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;

    switch (action) {
      case 'setup': result = initSystem(); break;
      case 'sendOTP': result = handleSendOTP(data); break;
      case 'register': result = handleRegister(data); break;
      case 'login': result = handleLogin(data); break;
      case 'getRoles': result = getRoles(); break;
      case 'getUsers': result = getUsers(data); break;
      case 'updateRole': result = handleUpdateRole(data); break;
      case 'createUser': result = handleCreateUser(data); break;
      case 'resetPassword': result = handleResetPassword(data); break;
      case 'getPhanQuyen': result = getPhanQuyen(); break;
      case 'savePhanQuyen': result = savePhanQuyen(data); break;
      default: result = { success: false, message: 'Hành động không hợp lệ' };
    }
  } catch (error) {
    result = { success: false, message: 'Lỗi hệ thống: ' + error.toString() };
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

/**
 * HÀM KHỞI TẠO (GIÚP KÍCH HOẠT QUYỀN GỬI MAIL)
 */
function initSystem() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  
  // Lệnh này ép Google phải hỏi quyền gửi Mail khi bạn bấm Chạy
  const quota = MailApp.getRemainingDailyQuota();

  const configs = {
    'admin': ['ID', 'Email', 'MẬT KHẨU', 'HỌ VÀ TÊN', 'ID VAI TRÒ', 'TRẠNG THÁI', 'NGÀY ĐĂNG KÝ'],
    'use': ['ID', 'Email', 'MẬT KHẨU', 'HỌ VÀ TÊN', 'ID VAI TRÒ', 'GÁN AD MIND', 'TRẠNG THÁI', 'NGÀY ĐĂNG KÝ'],
    'roles_lookup': ['ID VAI TRÒ', 'TÊN VAI TRÒ', 'MÔ TẢ VAI TRÒ', 'DANH MỤC TRẠNG THÁI', 'DANH MỤC KẾT QUẢ LOG'],
    'otps': ['EMAIL', 'OTP', 'EXPIRE_TIME'],
    'phan_quyen': ['ID VAI TRÒ', 'TÊN VAI TRÒ', 'EMAIL QUẢN LÝ', 'CHECKIN_SALES', 'QUAN_LY_SAN_PHAM', 'DANH_SACH_DON_HANG', 'QUAN_LY_NHAN_VIEN', 'XEM_BANG_GIA', 'QUAN_LY_KHO']
  };

  for (let name in configs) {
    let sheet = ss.getSheetByName(name);
    if (!sheet) sheet = ss.insertSheet(name);
    sheet.getRange(1, 1, 1, configs[name].length).setValues([configs[name]]);
  }
  
  return { success: true, message: 'Đã sẵn sàng trên mail mới! Quota còn lại: ' + quota };
}

function getSheet(name) { return SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(name); }
function hashPassword(p) { return Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_256, p).map(b => ('0' + (b & 0xFF).toString(16)).slice(-2)).join(''); }

// --- SECURITY CONFIG ---
const CIPHER_KEY = PropertiesService.getScriptProperties().getProperty('AUTH_SECRET') || 'dv_auth_secure_2024';

function encryptData(text) {
  if (!text) return "";
  try {
    const blob = Utilities.newBlob(text.toString().trim().toLowerCase());
    const encrypted = Utilities.encrypt(Utilities.CipherAlgorithm.AES_128, CIPHER_KEY, blob);
    return Utilities.base64Encode(encrypted);
  } catch (e) { return text; }
}

function decryptData(base64Text) {
  if (!base64Text || base64Text.length < 10) return base64Text;
  try {
    const decoded = Utilities.base64Decode(base64Text);
    const decrypted = Utilities.decrypt(Utilities.CipherAlgorithm.AES_128, CIPHER_KEY, decoded);
    return decrypted.getDataAsString();
  } catch (e) { return base64Text; }
}

function handleSendOTP(data) {
  const email = (data.email || "").toString().trim().toLowerCase();
  const otp = Math.floor(100000 + Math.random() * 900000).toString();
  const expire = new Date(new Date().getTime() + 5 * 60000);
  const sheet = getSheet('otps');
  const encEmail = encryptData(email);
  if(sheet.getLastRow() > 0) {
    const rows = sheet.getDataRange().getValues();
    for (let i = rows.length - 1; i >= 1; i--) if (rows[i][0] && rows[i][0].toString() === encEmail) sheet.deleteRow(i + 1);
  }
  sheet.appendRow([encEmail, otp, expire]);
  try {
    MailApp.sendEmail({
      to: email,
      subject: "Mã xác thực Dunvex Account: " + otp,
      htmlBody: `
        <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 500px; margin: 20px auto; border: 1px solid #6366f1; border-radius: 16px; padding: 40px 20px; box-sizing: border-box;">
          <h2 style="color: #6366f1; text-align: center; font-size: 24px; margin-bottom: 20px; font-weight: 800;">Xác thực OTP</h2>
          <p style="text-align: center; color: #475569; font-size: 15px; margin-bottom: 30px;">
            Chào bạn, đây là mã xác thực để bạn thực hiện thay đối trên hệ thống Dunvex:
          </p>
          <div style="background: #f0f7ff; border: 1px solid #6366f1; padding: 25px; text-align: center; border-radius: 12px; margin: 20px 0;">
            <span style="font-size: 48px; font-weight: 900; letter-spacing: 12px; color: #1e1b4b; display: block;">${otp}</span>
          </div>
          <p style="text-align: center; font-size: 12px; color: #94a3b8; margin-top: 30px;">
            Mã có hiệu lực trong 5 phút. Vui lòng bảo mật mã này.
          </p>
        </div>
      `
    });
    return { success: true, message: 'Đã gửi mã xác thực!' };
  } catch (e) { return { success: false, message: e.toString() }; }
}

function verifyOTP(email, otp) {
  const sheet = getSheet('otps');
  if(sheet.getLastRow() <= 1) return false;
  const rows = sheet.getDataRange().getValues();
  const now = new Date().getTime();
  const encEmail = encryptData(email);
  for (let i = 1; i < rows.length; i++) {
    if (rows[i][0] && rows[i][0].toString() === encEmail && rows[i][1].toString() === otp.toString()) {
      if (now < new Date(rows[i][2]).getTime()) { sheet.deleteRow(i + 1); return true; }
    }
  }
  return false;
}

function handleRegister(data) {
  const email = data.email.toLowerCase();
  if (!verifyOTP(email, data.otp)) return { success: false, message: 'OTP sai' };
  const roleId = data.roleId || 'R005';
  const prefix = (roleId === 'R001' ? 'AD' : 'US');
  const sheetName = (roleId === 'R001' ? 'admin' : 'use');
  const id = generateNextId(sheetName, prefix);
  const encEmail = encryptData(email);
  if (roleId === 'R001') getSheet('admin').appendRow([id, encEmail, hashPassword(data.password), data.fullName, 'R001', 'Hoạt động', new Date()]);
  else getSheet('use').appendRow([id, encEmail, hashPassword(data.password), data.fullName, 'R005', 'N/A', 'Hoạt động', new Date()]);
  return { success: true };
}

function generateNextId(s, p) {
  const sheet = getSheet(s);
  if (sheet.getLastRow() <= 1) return p + '-001';
  const data = sheet.getRange("A:A").getValues();
  let max = 0;
  for (let i = 1; i < data.length; i++) {
    const val = data[i][0].toString();
    if (val.includes('-')) {
      const n = parseInt(val.split('-').pop());
      if (n > max) max = n;
    }
  }
  return p + '-' + (max + 1).toString().padStart(3, '0');
}

function isEmailExists(e) {
  const encEmail = encryptData(e);
  for (let s of ['admin', 'use']) {
    const sheet = getSheet(s);
    if (sheet.getLastRow() <= 1) continue;
    const rows = sheet.getDataRange().getValues();
    for (let i = 1; i < rows.length; i++) if (rows[i][1] && rows[i][1].toString() === encEmail) return true;
  }
  return false;
}

function handleLogin(data) {
  const email = (data.email || "").toString().trim().toLowerCase();
  const password = (data.password || "").toString().trim();
  const hashedPassword = hashPassword(password);
  let user = findUserInSheet('admin', email, hashedPassword) || findUserInSheet('use', email, hashedPassword, true);
  if (!user) return { success: false, message: 'Sai thông tin (Email/Mật khẩu)' };

  let adminOfThisUser = email; // Default for Admins (plain email for memory)
  if (user.id.startsWith('US')) {
     const encEmail = encryptData(email);
     const useRow = getSheet('use').getDataRange().getValues().find(r => r[1].toString() === encEmail);
     if (useRow) adminOfThisUser = decryptData(useRow[5]); // Decrypt the assigned admin email
  }
  user.adminEmail = adminOfThisUser;
  return { success: true, user: user, permissions: getPermissions(user.roleId, adminOfThisUser) };
}

function getPermissions(roleId, adminEmail = "ALL") {
  const sheet = getSheet('phan_quyen');
  if(!sheet || sheet.getLastRow() <= 1) return null;
  const rows = sheet.getDataRange().getValues();
  let pRes = null;
  let gRes = null;
  const encAdmin = encryptData(adminEmail);
  const encAll = encryptData('all');
  for (let i = 1; i < rows.length; i++) {
    if (rows[i][0] == roleId) {
      const p = { 
        checkinSales: !!rows[i][3], 
        quanLySanPham: !!rows[i][4], 
        danhSachDonHang: !!rows[i][5],
        quanLyNhanVien: !!rows[i][6],
        xemBangGia: !!rows[i][7],
        quanLyKho: !!rows[i][8]
      };
      const rowAdminEnc = rows[i][2].toString();
      if (rowAdminEnc === encAdmin) pRes = p;
      if (rowAdminEnc === encAll) gRes = p;
    }
  }
  return pRes || gRes;
}

function findUserInSheet(sName, e, h, isU = false) {
  const sheet = getSheet(sName);
  if (sheet.getLastRow() <= 1) return null;
  const rows = sheet.getDataRange().getValues();
  const searchEmail = e.toString().trim().toLowerCase();
  
  for (let i = 1; i < rows.length; i++) {
    const rowEmail = (rows[i][1] || "").toString().trim();
    const rowPass = (rows[i][2] || "").toString().trim();
    const encEmail = encryptData(e);
    
    if (rowEmail === encEmail && rowPass === h) {
      return { 
        id: rows[i][0], 
        email: decryptData(rows[i][1]), 
        fullName: rows[i][3], 
        roleId: rows[i][4], 
        status: isU ? rows[i][6] : rows[i][5] 
      };
    }
  }
  return null;
}

function getRoles() {
  const sheet = getSheet('roles_lookup');
  if (sheet.getLastRow() <= 1) return { success: true, roles: [] };
  const rows = sheet.getDataRange().getValues();
  const roles = [];
  for (let i = 1; i < rows.length; i++) if (rows[i][0]) roles.push({ id: rows[i][0], name: rows[i][1] });
  return { success: true, roles: roles };
}

function getUsers(d) {
  const sheet = getSheet('use');
  if (sheet.getLastRow() <= 1) return { success:true, users:[] };
  const rows = sheet.getDataRange().getValues();
  const adminEmail = d.adminEmail.toLowerCase();
  const users = [];
  const encAdmin = encryptData(d.adminEmail);
  for (let i = 1; i < rows.length; i++) {
    if (rows[i][5] && rows[i][5].toString() === encAdmin) {
      users.push({ 
        id: rows[i][0], 
        email: decryptData(rows[i][1]), 
        fullName: rows[i][3], 
        roleId: rows[i][4], 
        status: rows[i][6] 
      });
    }
  }
  return { success: true, users: users };
}

function handleUpdateRole(d) {
  const s = getSheet('use');
  const rows = s.getDataRange().getValues();
  const encEmail = encryptData(d.userEmail);
  for (let i = 1; i < rows.length; i++) if (rows[i][1] && rows[i][1].toString() === encEmail) { s.getRange(i + 1, 5).setValue(d.newRoleId); return { success: true }; }
  return { success: false };
}

function handleCreateUser(d) {
  if (isEmailExists(d.email)) return { success: false, message: 'Đã tồn tại' };
  const id = generateNextId('use', 'US');
  const encEmail = encryptData(d.email);
  const encAdmin = encryptData(d.adminEmail);
  getSheet('use').appendRow([id, encEmail, hashPassword(d.password || '123456'), d.fullName, d.roleId, encAdmin, 'Hoạt động', new Date()]);
  return { success: true };
}

function handleResetPassword(d) {
  const email = (d.email || "").toString().trim().toLowerCase();
  const newPass = (d.newPassword || "").toString().trim();
  
  if (!verifyOTP(email, d.otp)) return { success: false, message: 'OTP sai hoặc hết hạn' };
  
  const encEmail = encryptData(email);
  for (let name of ['admin', 'use']) {
    const sheet = getSheet(name);
    if (sheet.getLastRow() <= 1) continue;
    const rows = sheet.getDataRange().getValues();
    for (let i = 1; i < rows.length; i++) {
      const rowEmail = (rows[i][1] || "").toString().trim();
      if (rowEmail === encEmail) {
        sheet.getRange(i + 1, 3).setValue(hashPassword(newPass));
        return { success: true };
      }
    }
  }
  return { success: false, message: 'Không tìm thấy tài khoản với email này' };
}
function getPhanQuyen() {
  try {
    const sheet = getSheet('phan_quyen');
    if (!sheet) return { success: false, message: 'Sheet phan_quyen không tồn tại' };
    const rows = sheet.getDataRange().getValues();
    const data = [];
    const headers = ['id_vai_tro', 'ten_vai_tro', 'email_quan_ly', 'checkin_sales', 'quan_ly_san_pham', 'danh_sach_don_hang', 'quan_ly_nhan_vien', 'xem_bang_gia', 'quan_ly_kho'];
    
    for (let i = 1; i < rows.length; i++) {
      let obj = {};
      headers.forEach((h, idx) => {
        let val = rows[i][idx];
        if (h === 'email_quan_ly') {
          val = decryptData(val);
        }
        obj[h] = val;
      });
      data.push(obj);
    }
    return { success: true, data: data };
  } catch (e) {
    return { success: false, message: e.toString() };
  }
}

function savePhanQuyen(d) {
  try {
    const sheet = getSheet('phan_quyen');
    const rows = sheet.getDataRange().getValues();
    const roleId = d.id_vai_tro;
    const adminEmail = d.email_quan_ly || 'ALL';
    const encAdmin = encryptData(adminEmail);
    for (let i = 1; i < rows.length; i++) {
      if (rows[i][0] == roleId && rows[i][2].toString() === encAdmin) {
        sheet.getRange(i + 1, 4, 1, 6).setValues([[
          d.checkin_sales === true,
          d.quan_ly_san_pham === true,
          d.danh_sach_don_hang === true,
          d.quan_ly_nhan_vien === true,
          d.xem_bang_gia === true,
          d.quan_ly_kho === true
        ]]);
        return { success: true };
      }
    }
    
    // Nếu chưa có thì thêm mới
    sheet.appendRow([
      roleId, 
      d.ten_vai_tro || 'Vai trò mới', 
      encAdmin, 
      d.checkin_sales === true,
      d.quan_ly_san_pham === true,
      d.danh_sach_don_hang === true,
      d.quan_ly_nhan_vien === true,
      d.xem_bang_gia === true,
      d.quan_ly_kho === true
    ]);
    return { success: true };
  } catch (e) {
    return { success: false, message: e.toString() };
  }
}

// --- MIGRATION UTILITY (RUN ONCE TO SECURE EXISTING DATA) ---
function migrateAuthEmailsToEncrypted() {
  const configs = [
    { sheet: 'admin', cols: [1] },
    { sheet: 'use', cols: [1, 5] },
    { sheet: 'otps', cols: [0] },
    { sheet: 'phan_quyen', cols: [2] }
  ];

  configs.forEach(conf => {
    const sheet = getSheet(conf.sheet);
    if (!sheet || sheet.getLastRow() < 2) return;
    const rows = sheet.getDataRange().getValues();

    for (let i = 1; i < rows.length; i++) {
      conf.cols.forEach(idx => {
        const val = (rows[i][idx] || "").toString();
        if (val && !val.includes('+') && (val.includes('@') || val === 'all' || val === 'ALL')) {
          sheet.getRange(i + 1, idx + 1).setValue(encryptData(val.toLowerCase()));
        }
      });
    }
  });
  return "Auth Migration Complete!";
}
