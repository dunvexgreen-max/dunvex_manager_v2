const DB_FILE_ID = '1vk_zb_HemLtOyZdU_d_AYByPCcYYEwLm'; 
const JSON_FOLDER_ID = '1_LT4rzVui2E3BgfcwUSfMsUGQMN9NRTs';
const IMG_FOLDER_ID = '1dGFgw96a6gWVdHMq6rkk4fFRpDJqi5cG';

function doPost(e) {
  let result;
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;

    switch (action) {
      case 'save_price_list':
        result = savePriceList(data);
        break;
      case 'get_price_lists':
        result = getPriceLists(data.userEmail, data.isAdmin);
        break;
      case 'get_price_list_detail':
        result = getPriceListDetail(data.fileId); 
        break;
      case 'delete_price_list':
        result = deletePriceList(data.fileId);
        break;
      default:
        result = { success: false, message: 'Hành động không hợp lệ' };
    }
  } catch (error) {
    result = { success: false, message: 'Lỗi hệ thống: ' + error.toString() };
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

function getDatabaseFile() {
  try {
    // Trỏ thẳng vào file ID bạn đã cung cấp
    return DriveApp.getFileById(DB_FILE_ID);
  } catch (e) {
    const folder = DriveApp.getFolderById(JSON_FOLDER_ID);
    const files = folder.getFilesByName('bang_gia.json');
    if (files.hasNext()) return files.next();
    return folder.createFile('bang_gia.json', '[]', MimeType.PLAIN_TEXT);
  }
}

function savePriceList(data) {
  try {
    const file = getDatabaseFile();
    let allLists = JSON.parse(file.getBlob().getDataAsString() || '[]');
    let payload;

    if (data.id) {
      // Chế độ Cập nhật
      const index = allLists.findIndex(l => l.id === data.id);
      if (index === -1) return { success: false, message: "Không tìm thấy bảng giá ID: " + data.id };
      
      payload = allLists[index];
      payload.title = data.title;
      payload.customerName = data.customerName;
      payload.columns = data.columns;
      payload.rows = data.rows;
      payload.notes = data.notes;
      payload.updatedAt = new Date().toISOString();

      if (data.logo_base64) {
        const imgFolder = DriveApp.getFolderById(IMG_FOLDER_ID);
        const blob = Utilities.newBlob(Utilities.base64Decode(data.logo_base64), data.logo_mimetype || 'image/png', `Logo_${data.customerName}.png`);
        const imgFile = imgFolder.createFile(blob);
        imgFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
        payload.logoUrl = `https://lh3.googleusercontent.com/d/${imgFile.getId()}`;
      } else if (data.logoUrl) {
        payload.logoUrl = data.logoUrl;
      }

      allLists[index] = payload;
    } else {
      // Chế độ Tạo mới
      const timestamp = new Date().getTime();
      const newId = "PL-" + timestamp;

      payload = {
        id: newId,
        title: data.title,
        customerName: data.customerName,
        columns: data.columns,
        rows: data.rows,
        createdAt: new Date().toISOString(),
        createdBy: data.userEmail,
        notes: data.notes
      };

      if (data.logo_base64) {
        const imgFolder = DriveApp.getFolderById(IMG_FOLDER_ID);
        const blob = Utilities.newBlob(Utilities.base64Decode(data.logo_base64), data.logo_mimetype || 'image/png', `Logo_${data.customerName}.png`);
        const imgFile = imgFolder.createFile(blob);
        imgFile.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
        payload.logoUrl = `https://lh3.googleusercontent.com/d/${imgFile.getId()}`;
      }
      
      allLists.push(payload);
    }

    // LƯU JSON ĐỊNH DẠNG ĐẸP (Prettify)
    file.setContent(JSON.stringify(allLists, null, 2));
    return { success: true, fileId: payload.id, logoUrl: payload.logoUrl };
  } catch (e) {
    return { success: false, message: e.toString() };
  }
}

function getPriceLists(userEmail, isAdmin) {
  try {
    const file = getDatabaseFile();
    const allLists = JSON.parse(file.getBlob().getDataAsString() || '[]');
    
    let filtered = allLists;
    if (!isAdmin) {
      filtered = allLists.filter(l => l.createdBy === userEmail);
    }
    
    const results = filtered.map(l => ({
      id: l.id,
      title: l.title || 'Không có tiêu đề',
      customer: l.customerName || 'Không có tên khách',
      createdBy: l.createdBy,
      createdAt: l.createdAt,
      logo: l.logoUrl
    }));

    results.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    return { success: true, lists: results };
  } catch (e) {
    return { success: false, message: e.toString() };
  }
}

function getPriceListDetail(id) {
  try {
    const file = getDatabaseFile();
    const allLists = JSON.parse(file.getBlob().getDataAsString() || '[]');
    const found = allLists.find(l => l.id === id);
    if (!found) return { success: false, message: "Không tìm thấy bảng giá ID: " + id };
    return { success: true, data: found };
  } catch (e) {
    return { success: false, message: e.toString() };
  }
}

function deletePriceList(id) {
  try {
    const file = getDatabaseFile();
    let allLists = JSON.parse(file.getBlob().getDataAsString() || '[]');
    const newList = allLists.filter(l => l.id !== id);
    file.setContent(JSON.stringify(newList, null, 2));
    return { success: true };
  } catch (e) {
    return { success: false, message: e.toString() };
  }
}
