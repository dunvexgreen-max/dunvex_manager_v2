<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Dunvex | Ph√¢n T√≠ch & ƒê·ªãnh Gi√° Th√¥ng Minh</title>
	<link rel="icon" type="image/svg+xml"
		href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%236366f1'/><text x='50%' y='50%' dominant-baseline='central' text-anchor='middle' fill='white' font-size='60' font-family='sans-serif' font-weight='800'>DV</text></svg>">
	<link
		href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@600;800&display=swap"
		rel="stylesheet">

	<!-- Libraries -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

	<style>
		:root {
			--primary: #6366f1;
			--primary-light: #818cf8;
			--bg-dark: #0f172a;
			--card-bg: rgba(30, 41, 59, 0.7);
			--glass-border: rgba(255, 255, 255, 0.1);
			--text-main: #ffffff;
			--text-muted: #cbd5e1;
			--accent-purple: #c084fc;
			--accent-blue: #38bdf8;
			--success: #10b981;
			--danger: #ef4444;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Inter', sans-serif;
		}

		body {
			background-color: var(--bg-dark);
			color: var(--text-main);
			min-height: 100vh;
			background-image:
				radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
				radial-gradient(at 100% 100%, rgba(192, 132, 252, 0.15) 0px, transparent 50%);
			padding-top: 80px;
			/* Space for fixed nav */
		}

		/* Reusing Nav from Index */
		nav {
			position: fixed;
			top: 0;
			width: 100%;
			padding: 20px 5%;
			display: flex;
			justify-content: space-between;
			align-items: center;
			z-index: 1000;
			backdrop-filter: blur(10px);
			border-bottom: 1px solid var(--glass-border);
			background: rgba(15, 23, 42, 0.8);
		}

		.logo-box {
			font-weight: 800;
			font-size: 1.5rem;
			letter-spacing: -1px;
			color: var(--text-main);
		}

		.logo-box span {
			background: linear-gradient(135deg, var(--primary), var(--accent-purple));
			background-clip: text;
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
		}

		.nav-actions .btn-glass {
			background: var(--card-bg);
			border: 1px solid var(--glass-border);
			color: var(--text-main);
			padding: 8px 20px;
			border-radius: 12px;
			text-decoration: none;
			font-weight: 600;
			font-size: 0.9rem;
			transition: 0.3s;
		}

		.nav-actions .btn-glass:hover {
			background: rgba(255, 255, 255, 0.1);
		}

		/* Main Config */
		.container {
			max-width: 1400px;
			margin: 40px auto;
			padding: 0 5%;
		}

		.section-header {
			margin-bottom: 30px;
			text-align: center;
		}

		.section-header h1 {
			font-size: 2.5rem;
			font-weight: 800;
			margin-bottom: 10px;
		}

		.section-header p {
			color: var(--text-muted);
		}

		/* Cards */
		.glass-card {
			background: var(--card-bg);
			border: 1px solid var(--glass-border);
			border-radius: 24px;
			padding: 30px;
			margin-bottom: 30px;
			backdrop-filter: blur(10px);
			transition: 0.3s;
		}

		.glass-card:hover {
			border-color: var(--primary-light);
		}

		/* Input Zone */
		.input-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 30px;
		}

		.drop-zone {
			border: 2px dashed var(--glass-border);
			border-radius: 16px;
			padding: 40px;
			text-align: center;
			color: var(--text-muted);
			cursor: pointer;
			transition: 0.3s;
			height: 100%;
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
		}

		.drop-zone:hover,
		.drop-zone.dragover {
			border-color: var(--primary);
			background: rgba(99, 102, 241, 0.1);
		}

		.drop-zone i {
			font-size: 3rem;
			margin-bottom: 15px;
			color: var(--primary);
		}

		.url-input-box {
			display: flex;
			flex-direction: column;
			gap: 15px;
			justify-content: center;
		}

		input[type="text"] {
			background: rgba(0, 0, 0, 0.3);
			border: 1px solid var(--glass-border);
			padding: 15px;
			border-radius: 12px;
			color: white;
			width: 100%;
			outline: none;
			transition: 0.3s;
			font-size: 1rem;
		}

		input[type="text"]:focus {
			border-color: var(--primary);
		}

		.btn-action {
			background: linear-gradient(135deg, var(--primary), var(--accent-purple));
			border: none;
			color: white;
			padding: 15px 30px;
			border-radius: 12px;
			font-weight: 700;
			cursor: pointer;
			transition: 0.3s;
			display: inline-flex;
			align-items: center;
			gap: 10px;
			justify-content: center;
		}

		.btn-action:hover {
			transform: translateY(-2px);
			box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
		}

		.btn-action:disabled {
			opacity: 0.6;
			cursor: not-allowed;
			transform: none;
		}

		/* Data Preview Table */
		.table-container {
			overflow-x: auto;
			max-height: 400px;
			margin-top: 20px;
			border-radius: 12px;
			border: 1px solid var(--glass-border);
		}

		table {
			width: 100%;
			border-collapse: collapse;
			font-size: 0.9rem;
		}

		th,
		td {
			padding: 12px 16px;
			text-align: left;
			border-bottom: 1px solid var(--glass-border);
			white-space: nowrap;
		}

		th {
			background: rgba(0, 0, 0, 0.5);
			position: sticky;
			top: 0;
			color: var(--primary-light);
			font-weight: 600;
		}

		tr:hover td {
			background: rgba(255, 255, 255, 0.05);
		}

		/* Controls */
		.controls-bar {
			display: flex;
			gap: 20px;
			flex-wrap: wrap;
			margin-bottom: 20px;
			align-items: center;
		}

		.toggle-label {
			display: flex;
			align-items: center;
			gap: 10px;
			color: var(--text-muted);
			cursor: pointer;
		}

		.toggle-switch {
			width: 40px;
			height: 20px;
			background: rgba(255, 255, 255, 0.1);
			border-radius: 20px;
			position: relative;
			transition: 0.3s;
		}

		.toggle-switch::after {
			content: '';
			position: absolute;
			left: 2px;
			top: 2px;
			width: 16px;
			height: 16px;
			background: white;
			border-radius: 50%;
			transition: 0.3s;
		}

		input[type="checkbox"]:checked+.toggle-switch::after {
			transform: translateX(20px);
		}

		/* Tabs Navigation */
		.tabs-nav {
			display: flex;
			gap: 10px;
			margin-bottom: 25px;
			background: rgba(0, 0, 0, 0.2);
			padding: 6px;
			border-radius: 14px;
			width: fit-content;
		}

		.tab-btn {
			padding: 10px 24px;
			border-radius: 10px;
			border: none;
			background: transparent;
			color: var(--text-muted);
			font-weight: 600;
			cursor: pointer;
			transition: 0.3s;
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.tab-btn.active {
			background: var(--primary);
			color: white;
			box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
		}

		.tab-btn:hover:not(.active) {
			background: rgba(255, 255, 255, 0.05);
			color: var(--text-main);
		}

		/* Price Actions Bar */
		.price-actions-bar {
			display: flex;
			gap: 10px;
			margin-bottom: 20px;
			flex-wrap: wrap;
		}

		.btn-price-type {
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid var(--glass-border);
			color: var(--text-main);
			padding: 10px 18px;
			border-radius: 12px;
			font-size: 0.9rem;
			font-weight: 600;
			cursor: pointer;
			transition: 0.2s;
		}

		.btn-price-type.active {
			background: var(--success);
			border-color: var(--success);
			color: white;
		}

		.btn-price-type:hover:not(.active) {
			border-color: var(--accent-blue);
		}

		/* Net Table Specifics */
		.net-table-container {
			max-height: 600px;
			overflow: auto;
			border-radius: 16px;
			border: 1px solid var(--glass-border);
		}

		.net-table th {
			background: #1e293b;
			font-size: 0.8rem;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}

		.price-cell {
			font-family: 'Outfit', sans-serif;
			font-weight: 700;
			color: var(--accent-blue);
			text-align: right;
		}

		.price-tag {
			background: rgba(16, 185, 129, 0.1);
			color: var(--success);
			padding: 2px 8px;
			border-radius: 6px;
			font-size: 0.75rem;
			margin-right: 5px;
		}

		/* Visualization Grid */
		.viz-grid {
			display: grid;
			grid-template-columns: 2.5fr 1fr;
			gap: 30px;
			margin-top: 30px;
		}

		.chart-box {
			height: 500px;
			position: relative;
		}

		.side-panel {
			display: flex;
			flex-direction: column;
			gap: 20px;
		}

		.stat-card {
			background: rgba(0, 0, 0, 0.3);
			padding: 20px;
			border-radius: 16px;
			border: 1px solid var(--glass-border);
		}

		.stat-val {
			font-size: 1.8rem;
			font-weight: 800;
			color: var(--accent-blue);
			margin: 5px 0;
		}

		.stat-label {
			font-size: 0.9rem;
			color: var(--text-muted);
		}

		.saved-list {
			max-height: 400px;
			overflow-y: auto;
		}

		.saved-item {
			padding: 15px;
			border-radius: 12px;
			background: rgba(0, 0, 0, 0.2);
			margin-bottom: 10px;
			cursor: pointer;
			transition: 0.2s;
			border: 1px solid transparent;
		}

		.saved-item:hover {
			border-color: var(--primary);
			background: rgba(0, 0, 0, 0.4);
		}

		.saved-item h4 {
			font-size: 0.95rem;
			margin-bottom: 4px;
		}

		.saved-item span {
			font-size: 0.8rem;
			color: var(--text-muted);
		}

		.loading-overlay {
			position: fixed;
			inset: 0;
			background: rgba(15, 23, 42, 0.9);
			display: flex;
			justify-content: center;
			align-items: center;
			z-index: 2000;
			flex-direction: column;
			gap: 20px;
		}

		.spinner {
			width: 50px;
			height: 50px;
			border: 4px solid var(--glass-border);
			border-top-color: var(--primary);
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			to {
				transform: rotate(360deg);
			}
		}

		.hidden {
			display: none !important;
		}

		@media (max-width: 900px) {

			.input-grid,
			.viz-grid {
				grid-template-columns: 1fr;
			}
		}

		/* Portfolio Summary Table */
		.summary-table-container {
			margin-top: 15px;
			max-height: 350px;
			overflow-y: auto;
		}

		.analysis-tag {
			padding: 4px 10px;
			border-radius: 6px;
			font-size: 0.7rem;
			font-weight: 700;
			text-transform: uppercase;
		}

		.tag-excel {
			background: rgba(16, 185, 129, 0.2);
			color: #10b981;
		}

		.tag-sheet {
			background: rgba(56, 189, 248, 0.2);
			color: #38bdf8;
		}

		.btn-view-sm {
			padding: 6px 14px;
			border-radius: 8px;
			font-size: 0.8rem;
			background: var(--primary);
			color: white;
			border: none;
			cursor: pointer;
			transition: 0.2s;
		}

		.btn-delete-sm {
			padding: 6px 14px;
			border-radius: 8px;
			font-size: 0.8rem;
			background: rgba(239, 68, 68, 0.1);
			color: #ef4444;
			border: 1px solid rgba(239, 68, 68, 0.2);
			cursor: pointer;
			transition: 0.2s;
			margin-left: 5px;
		}

		.btn-delete-sm:hover {
			background: rgba(239, 68, 68, 0.2);
			border-color: #ef4444;
		}
	</style>
</head>

<body>

	<nav>
		<div class="logo-box">
			<span>DUNVEX</span> PRICE ANALYZER
		</div>
		<div class="nav-actions">
			<a href="index.html" class="btn-glass">Trang Ch·ªß</a>
		</div>
	</nav>

	<div class="container">

		<header class="section-header">
			<h1>Ph√¢n T√≠ch & ƒê·ªãnh Gi√° Th√¥ng Minh</h1>
			<p>Nh·∫≠p d·ªØ li·ªáu t·ª´ Excel ho·∫∑c Google Sheet ƒë·ªÉ t·ª± ƒë·ªông ph√¢n t√≠ch v√† tr·ª±c quan h√≥a.</p>
		</header>

		<!-- SUMMARY PORTFOLIO (NEW) -->
		<div class="glass-card" id="summarPortfolio">
			<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
				<h2 style="display: flex; align-items: center; gap: 10px;">üóÇÔ∏è Danh M·ª•c Ph√¢n T√≠ch T·ªïng H·ª£p</h2>
				<button class="btn-glass" onclick="loadSavedAnalyses()" style="font-size: 0.8rem; padding: 6px 12px;">
					üîÑ L√†m m·ªõi
				</button>
			</div>
			<div class="summary-table-container">
				<table>
					<thead>
						<tr>
							<th>T√™n B·∫£n Ph√¢n T√≠ch</th>
							<th>Ng∆∞·ªùi T·∫°o</th>
							<th>Ng√†y Gi·ªù</th>
							<th>Ngu·ªìn</th>
							<th style="text-align: center;">Thao T√°c</th>
						</tr>
					</thead>
					<tbody id="summaryTableBody">
						<tr>
							<td colspan="5" style="text-align:center; padding: 40px; color: var(--text-muted);">ƒêang t·∫£i
								d·ªØ li·ªáu...</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>

		<!-- STEP 1: INPUT -->
		<div class="glass-card" id="stepInput">
			<h2 style="margin-bottom: 20px;">1. Nh·∫≠p D·ªØ Li·ªáu Ngu·ªìn</h2>
			<div class="input-grid">
				<div class="drop-zone" id="dropZone">
					<div style="font-size: 3rem;">üìÇ</div>
					<h3>K√®o th·∫£ file Excel v√†o ƒë√¢y</h3>
					<p>Ho·∫∑c click ƒë·ªÉ ch·ªçn file (.xlsx, .xls)</p>
					<input type="file" id="fileInput" accept=".xlsx, .xls" hidden>
				</div>
				<div class="url-input-box">
					<h3>Ho·∫∑c nh·∫≠p Link Google Sheet</h3>
					<p style="font-size: 0.85rem; color: var(--text-muted);">Y√™u c·∫ßu quy·ªÅn truy c·∫≠p Public ho·∫∑c chia s·∫ª
						quy·ªÅn cho Service Account.</p>
					<input type="text" id="sheetUrl" placeholder="https://docs.google.com/spreadsheets/d/...">
					<button class="btn-action" onclick="fetchFromSheet()">
						<span>T·∫£i D·ªØ Li·ªáu Cloud</span>
					</button>
				</div>
			</div>
		</div>

		<!-- STEP 2: CLEANING & PREVIEW -->
		<div class="glass-card hidden" id="stepCleaning">
			<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
				<h2>2. L√†m S·∫°ch & Chu·∫©n H√≥a</h2>
				<button class="btn-action" onclick="processAnalysis()">
					<span>Ph√¢n T√≠ch & V·∫Ω Bi·ªÉu ƒê·ªì ‚ûî</span>
				</button>
			</div>

			<div class="controls-bar">
				<label class="toggle-label">
					<input type="checkbox" id="checkHeader" checked onchange="previewData()">
					<div class="toggle-switch"></div> H√†ng ƒë·∫ßu ti√™n l√† ti√™u ƒë·ªÅ
				</label>
				<label class="toggle-label">
					<input type="checkbox" id="checkEmpty" checked onchange="previewData()">
					<div class="toggle-switch"></div> Lo·∫°i b·ªè d√≤ng tr·ªëng/Total
				</label>
				<label class="toggle-label">
					<input type="checkbox" id="checkCurrency" checked onchange="previewData()">
					<div class="toggle-switch"></div> Chu·∫©n h√≥a ti·ªÅn t·ªá (VNƒê)
				</label>
			</div>

			<div class="table-container" id="previewTable">
				<!-- Javascript will populate this -->
			</div>
		</div>

		<!-- STEP 3: VISUALIZATION & NET PRICE LIST -->
		<div class="glass-card hidden" id="stepViz">
			<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
				<h2>3. Tr√¨nh B√†y D·ªØ Li·ªáu</h2>
				<div style="display: flex; gap: 10px;">
					<button class="btn-glass" onclick="resetApp()">Nh·∫≠p l·∫°i</button>
					<button class="btn-action" onclick="saveToDrive()">L∆∞u v√†o Drive</button>
				</div>
			</div>

			<!-- Tabs Navigation -->
			<div class="tabs-nav">
				<button class="tab-btn active" onclick="switchVizTab('analysis')" id="tabBtnAnalysis">
					<span>üìä Bi·ªÉu ƒë·ªì Ph√¢n t√≠ch</span>
				</button>
				<button class="tab-btn" onclick="switchVizTab('netPrice')" id="tabBtnNet">
					<span>üí∞ B·∫£ng gi√° NET</span>
				</button>
			</div>

			<!-- Tab 1: Analysis Chart -->
			<div id="vizAnalysis">
				<div class="viz-grid">
					<div class="chart-box">
						<canvas id="mainChart"></canvas>
					</div>
					<div class="side-panel">
						<div class="stat-card">
							<div class="stat-label">T·ªïng D√≤ng D·ªØ Li·ªáu</div>
							<div class="stat-val" id="statRows">0</div>
						</div>
						<div class="stat-card">
							<div class="stat-label">C·ªôt Ph√¢n T√≠ch</div>
							<div class="stat-val" id="statCols">0</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Tab 2: Net Price List -->
			<div id="vizNetPrice" class="hidden">
				<div class="price-actions-bar" id="priceColumnSelectors">
					<!-- Dynamic Buttons -->
				</div>
				<div class="net-table-container">
					<table class="net-table">
						<thead id="netTableHeader"></thead>
						<tbody id="netTableBody"></tbody>
					</table>
				</div>
			</div>
		</div>

	</div>

	<!-- Loading -->
	<div class="loading-overlay hidden" id="loader">
		<div class="spinner"></div>
		<h3 id="loaderText">ƒêang x·ª≠ l√Ω...</h3>
	</div>

	<script>
		// CONFIG
		const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzKXXoAMmx2sz4QbFBwYt8gx7LB2LRQCYkcDIV4DtOJNU5Nsy5Bzw0lWGfgrkSZgI_2/exec";

		let RAW_DATA = [];
		let CLEAN_DATA = [];
		let CHART_INSTANCE = null;
		let CURRENT_HEADER = [];
		let RAW_FILE_DATA = null;
		let SOURCE_NAME = ""; // Filename or Sheet name

		const XOR_SECRET = 'dunvex_secure_key_2025_custom';

		function xorEncrypt(text) {
			if (!text) return "";
			const key = XOR_SECRET;
			let res = [];
			for (let i = 0; i < text.length; i++) {
				res.push(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
			}
			return btoa(String.fromCharCode.apply(null, res));
		}

		// --- DOM ELEMENTS ---
		const dropZone = document.getElementById('dropZone');
		const fileInput = document.getElementById('fileInput');
		const loader = document.getElementById('loader');

		// --- EVENT LISTENERS ---
		dropZone.addEventListener('click', () => fileInput.click());
		dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
		dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
		dropZone.addEventListener('drop', handleDrop);
		fileInput.addEventListener('change', handleFileSelect);

		// --- CORE FUNCTIONS ---

		function showLoader(msg) {
			document.getElementById('loaderText').innerText = msg;
			loader.classList.remove('hidden');
		}
		function hideLoader() { loader.classList.add('hidden'); }

		// 1. INPUT HANDLING
		function handleFileSelect(e) {
			const file = e.target.files[0];
			if (file) processExcelFile(file);
		}

		function handleDrop(e) {
			e.preventDefault();
			dropZone.classList.remove('dragover');
			const file = e.dataTransfer.files[0];
			if (file) processExcelFile(file);
		}

		function processExcelFile(file) {
			showLoader("ƒêang ƒë·ªçc file Excel...");
			const reader = new FileReader();
			reader.onload = (e) => {
				const data = new Uint8Array(e.target.result);
				const workbook = XLSX.read(data, { type: 'array' });
				const firstSheet = workbook.Sheets[workbook.SheetNames[0]];

				// Store base64 for upload later
				const binary = e.target.result;
				const bytes = new Uint8Array(binary);
				let binaryString = "";
				for (let i = 0; i < bytes.length; i++) {
					binaryString += String.fromCharCode(bytes[i]);
				}
				SOURCE_NAME = file.name;
				RAW_FILE_DATA = {
					fileName: file.name,
					base64: "data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64," + btoa(binaryString)
				};

				RAW_DATA = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
				if (RAW_DATA.length > 0) {
					showCleaningStep();
				} else {
					alert("File kh√¥ng c√≥ d·ªØ li·ªáu!");
				}
				hideLoader();
			};
			reader.readAsArrayBuffer(file);
		}

		async function fetchFromSheet() {
			const url = document.getElementById('sheetUrl').value.trim();
			if (!url) return alert("Vui l√≤ng nh·∫≠p Link Google Sheet");

			showLoader("ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Server...");
			RAW_FILE_DATA = null; // reset raw file if using sheet

			try {
				const res = await fetch(GAS_API_URL, {
					method: "POST",
					body: JSON.stringify({ action: "PA_fetchSheetData", url: url })
				});
				const json = await res.json();

				if (json.success) {
					RAW_DATA = json.data;
					SOURCE_NAME = json.name || "D·ªØ li·ªáu Cloud";
					showCleaningStep();
				} else {
					alert(json.message);
				}
			} catch (e) {
				alert("L·ªói k·∫øt n·ªëi: " + e.message);
			}
			hideLoader();
		}

		function showCleaningStep() {
			document.getElementById('stepInput').classList.add('hidden');
			document.getElementById('stepCleaning').classList.remove('hidden');
			previewData();
		}

		// 2. CLEANING LOGIC
		function previewData() {
			const useHeader = document.getElementById('checkHeader').checked;
			const removeEmpty = document.getElementById('checkEmpty').checked;
			const normalizeCurrency = document.getElementById('checkCurrency').checked;

			let data = [...RAW_DATA]; // Clone

			// A. Header Detection
			if (useHeader && data.length > 0) {
				CURRENT_HEADER = data[0].map(c => c ? c.toString().trim() : "Unknown");
				data = data.slice(1);
			} else {
				CURRENT_HEADER = data[0]?.map((_, i) => `Col ${i + 1}`) || [];
			}

			// B. Filter Empty & Total
			if (removeEmpty) {
				data = data.filter(row => {
					const str = row.join("").toLowerCase();
					// Basic heuristic: check if row is empty or contains "total"/"t·ªïng"
					if (str.trim() === "") return false;
					if (str.includes("total") || str.includes("t·ªïng")) return false;
					return true;
				});
			}

			// C. Normalize Data (Mutable) & Preview Generation
			let html = `<thead><tr>${CURRENT_HEADER.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;

			// Limit preview to 10 rows
			const previewLimit = Math.min(data.length, 100);

			// Prepare Clean Data for Viz
			CLEAN_DATA = [];

			for (let i = 0; i < data.length; i++) {
				let row = data[i];
				let cleanRow = {};

				// Map to Object based on Header
				for (let j = 0; j < CURRENT_HEADER.length; j++) {
					let val = row[j];
					const head = CURRENT_HEADER[j];

					if (normalizeCurrency && typeof val === 'string') {
						// Regex detect money: 1.200.000, 1,200,000, 500k
						if (val.match(/[0-9]+[.,][0-9]+/)) {
							let cleanVal = val.replace(/[^0-9]/g, ''); // Simple strip non-digits
							if (cleanVal) val = parseFloat(cleanVal);
						}
					}
					cleanRow[head] = val;
				}
				CLEAN_DATA.push(cleanRow);

				// Render Preview (only first 10)
				if (i < 10) {
					html += `<tr>${CURRENT_HEADER.map((_, j) => `<td>${row[j] || ''}</td>`).join('')}</tr>`;
				}
			}
			html += `</tbody>`;

			if (data.length > 10) {
				html += `<tfoot><tr><td colspan="${CURRENT_HEADER.length}" style="text-align:center; color: var(--text-muted);">... v√† ${data.length - 10} d√≤ng kh√°c ...</td></tr></tfoot>`;
			}

			document.getElementById('previewTable').innerHTML = `<table>${html}</table>`;
		}

		// 3. VISUALIZATION
		function processAnalysis() {
			// Hide Home & Pre-process
			document.getElementById('summarPortfolio')?.classList.add('hidden');
			document.getElementById('stepInput').classList.add('hidden');
			document.getElementById('stepCleaning').classList.add('hidden');

			// Show Results
			document.getElementById('stepViz').classList.remove('hidden');

			document.getElementById('statRows').innerText = CLEAN_DATA.length;
			document.getElementById('statCols').innerText = CURRENT_HEADER.length;

			renderChartAuto();
			initNetPriceList();
			switchVizTab('analysis');
			loadSavedAnalyses();
		}

		function switchVizTab(tab) {
			document.getElementById('vizAnalysis').classList.add('hidden');
			document.getElementById('vizNetPrice').classList.add('hidden');
			document.getElementById('tabBtnAnalysis').classList.remove('active');
			document.getElementById('tabBtnNet').classList.remove('active');

			if (tab === 'analysis') {
				document.getElementById('vizAnalysis').classList.remove('hidden');
				document.getElementById('tabBtnAnalysis').classList.add('active');
				if (CHART_INSTANCE) CHART_INSTANCE.resize();
			} else {
				document.getElementById('vizNetPrice').classList.remove('hidden');
				document.getElementById('tabBtnNet').classList.add('active');
				renderNetPriceTable();
			}
		}

		// --- NET PRICE LIST LOGIC ---
		let PRICE_COLUMNS = [];
		let ACTIVE_PRICE_COL = "";

		function initNetPriceList() {
			// Find all columns that look like prices
			const priceKeywords = ['gi√°', 'ph·ª• thu', 'ti·ªÅn', 'c∆∞·ªõc'];
			const negativeKeywords = ['ch√™nh l·ªách', '%', 's·ªë ti·ªÅn']; // Avoid calculation columns

			PRICE_COLUMNS = CURRENT_HEADER.filter(h => {
				const low = h.toLowerCase();
				return priceKeywords.some(k => low.includes(k)) && !negativeKeywords.some(nk => low.includes(nk));
			});

			if (PRICE_COLUMNS.length > 0) {
				ACTIVE_PRICE_COL = PRICE_COLUMNS.find(c => c.toLowerCase().includes('t·∫°i kho')) || PRICE_COLUMNS[0];
			}

			// Render selection buttons
			const container = document.getElementById('priceColumnSelectors');
			container.innerHTML = PRICE_COLUMNS.map(col => `
				<button class="btn-price-type ${col === ACTIVE_PRICE_COL ? 'active' : ''}" onclick="changeNetPriceCol('${col}')">
					${col}
				</button>
			`).join('');
		}

		function changeNetPriceCol(col) {
			ACTIVE_PRICE_COL = col;
			// Update active button
			document.querySelectorAll('.btn-price-type').forEach(btn => {
				btn.classList.toggle('active', btn.innerText.trim() === col);
			});
			renderNetPriceTable();
		}

		const INFO_KEYWORDS = ['stt', 't√™n', 'ph√¢n lo·∫°i', 'm√¥ t·∫£', 'k√≠ch th∆∞·ªõc', 'ƒë·ªô d√†y', 'ƒë√≥ng g√≥i', 'kh·ªëi l∆∞·ª£ng', 'm√£'];

		function renderNetPriceTable() {
			const headerEl = document.getElementById('netTableHeader');
			const bodyEl = document.getElementById('netTableBody');

			// Identify info columns
			const infoCols = CURRENT_HEADER.filter(h => INFO_KEYWORDS.some(k => h.toLowerCase().includes(k)));

			// Render Header
			let headerHtml = `<tr>`;
			infoCols.forEach(h => headerHtml += `<th>${h}</th>`);
			headerHtml += `<th style="text-align: right;">${ACTIVE_PRICE_COL}</th>`;
			headerHtml += `</tr>`;
			headerEl.innerHTML = headerHtml;

			// Render Body
			let bodyHtml = "";
			CLEAN_DATA.forEach(row => {
				bodyHtml += `<tr>`;
				infoCols.forEach(h => bodyHtml += `<td>${row[h] || '-'}</td>`);

				// Extract price value
				let rawPrice = row[ACTIVE_PRICE_COL];
				let formattedPrice = "-";
				if (rawPrice !== undefined && rawPrice !== null && rawPrice !== "") {
					let num = typeof rawPrice === 'string' ? parseFloat(rawPrice.replace(/[^0-9]/g, '')) : rawPrice;
					if (!isNaN(num)) {
						formattedPrice = new Intl.NumberFormat('vi-VN').format(num) + " ƒë";
					} else {
						formattedPrice = rawPrice;
					}
				}

				bodyHtml += `<td class="price-cell"><span class="price-tag">NET</span>${formattedPrice}</td>`;
				bodyHtml += `</tr>`;
			});
			bodyEl.innerHTML = bodyHtml;
		}

		function renderChartAuto() {
			const ctx = document.getElementById('mainChart').getContext('2d');

			// Heuristic to pick Axis
			// X-Axis: Look for "Date", "Th√°ng", "Ng√†y", "Name", "T√™n" OR First Column
			// Y-Axis: Look for "Price", "Ti·ªÅn", "Doanh thu", "Gi√°", "Value", "Quantity", "S·ªë l∆∞·ª£ng"

			let xKey = CURRENT_HEADER[0];
			let yKeys = [];

			// Try to find better X
			const timeKeywords = ['th√°ng', 'ng√†y', 'date', 'time', 'th·ªùi gian', 'nƒÉm', 'tu·∫ßn'];
			const nameKeywords = ['t√™n', 'name', 's·∫£n ph·∫©m', 'item', 'm·∫∑t h√†ng', 'kh√°ch'];

			const potentialX = CURRENT_HEADER.find(h => timeKeywords.some(k => h.toLowerCase().includes(k)))
				|| CURRENT_HEADER.find(h => nameKeywords.some(k => h.toLowerCase().includes(k)));
			if (potentialX) xKey = potentialX;

			// Try to find Y (Numeric columns)
			// Check first 5 rows to see if values are numbers
			const moneyKeywords = ['ti·ªÅn', 'price', 'gi√°', 'doanh thu', 'amount', 'cost', 'total', 'vnƒë'];
			const qtyKeywords = ['s·ªë l∆∞·ª£ng', 'quantity', 'sl', 't·ªìn'];

			CURRENT_HEADER.forEach(h => {
				if (h === xKey) return;
				// Check content logic
				const isNum = CLEAN_DATA.slice(0, 5).every(row => {
					const v = row[h];
					return !isNaN(parseFloat(v)) && isFinite(v);
				});
				if (isNum) yKeys.push(h);
			});

			// If no Y found, force 2nd col
			if (yKeys.length === 0 && CURRENT_HEADER.length > 1) yKeys.push(CURRENT_HEADER[1]);

			// Determine Chart Type
			let chartType = 'bar';
			if (timeKeywords.some(k => xKey.toLowerCase().includes(k))) chartType = 'line';
			if (yKeys.length === 1 && CURRENT_HEADER.length === 2 && nameKeywords.some(k => xKey.toLowerCase().includes(k))) chartType = 'pie';

			// Prepare Datasets
			const datasets = yKeys.map((key, index) => {
				const color = index === 0 ? '#6366f1' : (index === 1 ? '#c084fc' : '#38bdf8');
				return {
					label: key,
					data: CLEAN_DATA.map(r => typeof r[key] === 'string' ? parseFloat(r[key].replace(/[^0-9]/g, '')) : r[key]),
					backgroundColor: color,
					borderColor: color,
					borderWidth: 2,
					tension: 0.3
				};
			});

			if (CHART_INSTANCE) CHART_INSTANCE.destroy();

			CHART_INSTANCE = new Chart(ctx, {
				type: chartType,
				data: {
					labels: CLEAN_DATA.map(r => r[xKey]),
					datasets: datasets
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					plugins: {
						legend: { position: 'bottom', labels: { color: '#cbd5e1' } },
						title: { display: true, text: `Ph√¢n t√≠ch: ${xKey}`, color: '#fff' }
					},
					scales: {
						x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } },
						y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
					}
				}
			});
		}

		// 4. SAVE & LOAD
		async function saveToDrive() {
			// Find a descriptive mnemonic from data
			let mnemonic = "";
			if (CLEAN_DATA.length > 0) {
				// Search for a cell that looks like a product name (not too short, not just a number)
				const nameKeys = CURRENT_HEADER.filter(h =>
					h.toLowerCase().includes('t√™n') ||
					h.toLowerCase().includes('s·∫£n ph·∫©m') ||
					h.toLowerCase().includes('m√¥ t·∫£') ||
					h.toLowerCase().includes('ph√¢n lo·∫°i')
				);

				// Try first few rows for a good name
				for (let i = 0; i < Math.min(5, CLEAN_DATA.length); i++) {
					for (let key of nameKeys) {
						let val = CLEAN_DATA[i][key];
						if (val && val.toString().trim().length > 5) {
							mnemonic = val.toString().trim().substring(0, 25);
							break;
						}
					}
					if (mnemonic) break;
				}

				// Fallback to first cell if still empty
				if (!mnemonic) mnemonic = CLEAN_DATA[0][CURRENT_HEADER[0]] || "";

				// Clean mnemonic
				mnemonic = mnemonic.toString().replace(/[^a-zA-Z0-9√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒëƒê\s]/g, "").trim();
			}

			const dateStr = new Date().toLocaleDateString('vi-VN').replace(/\//g, '-');
			const base = SOURCE_NAME ? SOURCE_NAME.split('.')[0] : "Ph√¢n t√≠ch";
			const defaultName = (mnemonic ? mnemonic + " - " : "") + base + " (" + dateStr + ")";

			const name = prompt("Nh·∫≠p t√™n g·ª£i nh·ªõ cho b·∫£n ph√¢n t√≠ch n√†y:", defaultName);
			if (!name) return;

			showLoader("ƒêang l∆∞u ph√¢n t√≠ch...");
			const user = JSON.parse(localStorage.getItem('user') || '{}');

			try {
				let rawFileId = "";
				// Step A: Upload raw file if exists
				if (RAW_FILE_DATA) {
					const resRaw = await fetch(GAS_API_URL, {
						method: "POST",
						body: JSON.stringify({ action: "PA_uploadRawFile", ...RAW_FILE_DATA })
					});
					const jsonRaw = await resRaw.json();
					if (jsonRaw.success) rawFileId = jsonRaw.fileId;
				}

				// Step B: Save Analysis JSON
				const res = await fetch(GAS_API_URL, {
					method: "POST",
					body: JSON.stringify({
						action: "PA_saveAnalysis",
						name: name,
						userEmail: xorEncrypt(user.email || 'Anonymous'),
						adminEmail: xorEncrypt(user.adminEmail || user.email || 'Anonymous'),
						rawFileId: rawFileId,
						header: CURRENT_HEADER,
						content: CLEAN_DATA
					})
				});
				const json = await res.json();

				if (json.success) {
					alert("‚úÖ " + json.message);
					loadSavedAnalyses();
				} else {
					alert("‚ùå " + json.message);
				}
			} catch (e) {
				alert("L·ªói k·∫øt n·ªëi: " + e.message);
			}
			hideLoader();
		}

		async function loadSavedAnalyses() {
			const user = JSON.parse(localStorage.getItem('user') || '{}');
			try {
				const res = await fetch(GAS_API_URL, {
					method: "POST",
					body: JSON.stringify({
						action: "PA_listAnalyses",
						userEmail: xorEncrypt(user.email),
						adminEmail: xorEncrypt(user.adminEmail || user.email)
					})
				});
				const json = await res.json();
				if (json.success) {
					renderSummaryTable(json.list);
				}
			} catch (e) { console.error(e); }
		}

		function renderSummaryTable(list) {
			const tbody = document.getElementById('summaryTableBody');
			if (!list || list.length === 0) {
				tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px;">Ch∆∞a c√≥ d·ªØ li·ªáu n√†o ƒë∆∞·ª£c ph√¢n t√≠ch.</td></tr>';
				return;
			}

			tbody.innerHTML = list.map(f => {
				const date = new Date(f.created).toLocaleString('vi-VN');
				const tag = f.rawFile ? '<span class="analysis-tag tag-excel">EXCEL</span>' : '<span class="analysis-tag tag-sheet">SHEET</span>';

				return `
					<tr>
						<td style="font-weight: 600;">${f.name}</td>
						<td style="font-size: 0.85rem; color: var(--text-muted);">${f.createdBy}</td>
						<td style="font-size: 0.85rem;">${date}</td>
						<td>${tag}</td>
						<td style="text-align: center; display: flex; align-items: center; justify-content: center; gap: 5px;">
							<button class="btn-view-sm" onclick="openAnalysis('${f.id}')">üìÇ M·ªü</button>
							<button class="btn-delete-sm" onclick="deleteAnalysis('${f.id}')" title="X√≥a b·∫£n ph√¢n t√≠ch">üóëÔ∏è</button>
						</td>
					</tr>
				`;
			}).join('');
		}

		async function openAnalysis(fileId) {
			console.log("Opening Analysis ID:", fileId);
			showLoader("ƒêang t·∫£i d·ªØ li·ªáu l∆∞u tr·ªØ...");
			try {
				const res = await fetch(GAS_API_URL, {
					method: "POST",
					cache: "no-store", // Prevent caching
					body: JSON.stringify({ action: "PA_getAnalysis", fileId: fileId })
				});
				const json = await res.json();
				if (json.success && json.data) {
					console.log("Loaded Data Successfully. Name:", json.data.name);
					CURRENT_HEADER = json.data.header || [];
					CLEAN_DATA = json.data.data || [];

					if (CLEAN_DATA.length === 0) {
						alert("C·∫£nh b√°o: B·∫£n ph√¢n t√≠ch n√†y kh√¥ng c√≥ d·ªØ li·ªáu!");
					}

					processAnalysis();
				} else {
					alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu: " + (json.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh"));
				}
			} catch (e) {
				console.error("Open Error:", e);
				alert("L·ªói m·ªü file: " + e.message);
			}
			hideLoader();
		}

		async function deleteAnalysis(fileId) {
			if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ph√¢n t√≠ch n√†y kh√¥ng? D·ªØ li·ªáu g·ªëc (Excel) ƒëi k√®m c≈©ng s·∫Ω b·ªã x√≥a.")) return;

			showLoader("ƒêang x√≥a d·ªØ li·ªáu...");
			const user = JSON.parse(localStorage.getItem('user') || '{}');
			try {
				const res = await fetch(GAS_API_URL, {
					method: "POST",
					body: JSON.stringify({
						action: "PA_deleteAnalysis",
						fileId: fileId,
						userEmail: xorEncrypt(user.email),
						adminEmail: xorEncrypt(user.adminEmail || user.email)
					})
				});
				const json = await res.json();
				if (json.success) {
					alert("‚úÖ " + json.message);
					loadSavedAnalyses();
				} else {
					alert("‚ùå " + json.message);
				}
			} catch (e) { alert("L·ªói: " + e.message); }
			hideLoader();
		}

		function resetApp() {
			RAW_DATA = [];
			CLEAN_DATA = [];
			RAW_FILE_DATA = null;
			if (CHART_INSTANCE) CHART_INSTANCE.destroy();
			document.getElementById('summarPortfolio')?.classList.remove('hidden');
			document.getElementById('stepInput').classList.remove('hidden');
			document.getElementById('stepCleaning').classList.add('hidden');
			document.getElementById('stepViz').classList.add('hidden');
		}

		// Init
		window.onload = loadSavedAnalyses;
	</script>
</body>

</html>