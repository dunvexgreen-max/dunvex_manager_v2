<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Qu·∫£n L√Ω ƒê∆°n H√†ng - Premium</title>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
	<style>
		:root {
			--primary: #2d3436;
			--accent: #f1c40f;
			--success: #27ae60;
			--danger: #e74c3c;
			--bg: #f8f9fa;
			--card-bg: #ffffff;
			--border: #e9ecef;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Inter', sans-serif;
		}

		body {
			background: var(--bg);
			padding: 20px;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
		}

		header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
			border-bottom: 2px solid var(--accent);
			padding-bottom: 15px;
		}

		.btn {
			padding: 10px 20px;
			border-radius: 10px;
			cursor: pointer;
			font-weight: 600;
			border: none;
			transition: 0.3s;
			text-decoration: none;
			display: inline-flex;
			align-items: center;
			gap: 8px;
		}

		.btn-primary {
			background: var(--primary);
			color: var(--accent);
		}

		.btn-success {
			background: var(--success);
			color: white;
		}

		.form-card {
			background: white;
			padding: 25px;
			border-radius: 20px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
			margin-bottom: 25px;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 20px;
		}

		th {
			background: #f8f9fa;
			padding: 12px 10px;
			text-align: left;
			font-size: 0.8rem;
			text-transform: uppercase;
			color: #666;
			border-bottom: 2px solid var(--border);
			white-space: nowrap;
		}

		td {
			padding: 10px;
			border-bottom: 1px solid var(--border);
			vertical-align: middle;
			font-size: 0.85rem;
		}

		tr:hover {
			background: #fafafa;
		}

		.order-id {
			font-weight: 800;
			color: #2980b9;
		}

		.status-badge {
			padding: 4px 10px;
			border-radius: 6px;
			font-size: 0.75rem;
			font-weight: 700;
			background: #e3f2fd;
			color: #1976d2;
		}

		.loading {
			text-align: center;
			padding: 50px;
			font-weight: 700;
			color: #999;
		}

		.actions {
			display: flex;
			gap: 10px;
		}

		.modal {
			display: none;
			position: fixed;
			z-index: 100;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			align-items: center;
			justify-content: center;
			overflow-y: auto;
			padding: 20px;
		}

		.modal-content {
			background: white;
			width: 95%;
			max-width: 1000px;
			max-height: 95vh;
			overflow-y: auto;
			border-radius: 20px;
			box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
			position: relative;
			animation: modalSlideIn 0.3s ease-out;
		}

		@keyframes modalSlideIn {
			from {
				opacity: 0;
				transform: translateY(-30px) scale(0.95);
			}

			to {
				opacity: 1;
				transform: translateY(0) scale(1);
			}
		}

		.modal-close {
			position: absolute;
			top: 20px;
			right: 20px;
			width: 40px;
			height: 40px;
			background: rgba(0, 0, 0, 0.6);
			color: white;
			border: none;
			border-radius: 50%;
			font-size: 1.5rem;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: 0.3s;
			z-index: 101;
		}

		.modal-close:hover {
			background: rgba(0, 0, 0, 0.9);
			transform: rotate(90deg);
		}

		.cat-weber {
			border-left: 5px solid #000;
		}

		.cat-pima {
			border-left: 5px solid #f1c40f;
		}

		.cat-duraflex {
			border-left: 5px solid #27ae60;
		}

		/* Invoice Styles in Modal */
		.invoice-container {
			background: white;
		}

		.invoice-header {
			background: linear-gradient(135deg, #f1c40f, #f39c12);
			color: #000;
			padding: 40px;
			text-align: center;
			border-radius: 20px 20px 0 0;
		}

		.invoice-container.duraflex .invoice-header {
			background: linear-gradient(135deg, #2ecc71, #27ae60);
			color: #fff;
		}

		.invoice-container.weber .invoice-header {
			background: linear-gradient(135deg, #f39c12, #e67e22);
			color: #fff;
		}

		.invoice-container.pima .invoice-header {
			background: linear-gradient(135deg, #f1c40f, #f39c12);
			color: #000;
		}

		.invoice-header h1 {
			font-size: 2rem;
			font-weight: 800;
			margin-bottom: 10px;
		}

		.invoice-header .order-id {
			font-size: 1.1rem;
			font-weight: 600;
			opacity: 0.9;
		}

		.invoice-header div {
			margin-top: 10px;
			font-size: 0.95rem;
			opacity: 0.9;
		}

		.invoice-body {
			padding: 30px;
		}

		.section {
			margin-bottom: 25px;
		}

		.section-title {
			font-size: 1.1rem;
			font-weight: 700;
			color: #2d3436;
			margin-bottom: 15px;
			padding-bottom: 8px;
			border-bottom: 3px solid #f1c40f;
		}

		.invoice-container.duraflex .section-title {
			border-bottom-color: #2ecc71;
		}

		.invoice-container.weber .section-title {
			border-bottom-color: #f39c12;
		}

		.invoice-container.pima .section-title {
			border-bottom-color: #f1c40f;
		}

		.info-grid {
			display: grid;
			grid-template-columns: repeat(2, 1fr);
			gap: 15px;
			margin-bottom: 20px;
		}

		.info-item {
			display: flex;
			gap: 10px;
		}

		.info-label {
			font-weight: 700;
			color: #666;
			min-width: 140px;
		}

		.info-value {
			color: #2d3436;
			font-weight: 500;
		}

		.products-table {
			width: 100%;
			border-collapse: collapse;
			margin: 20px 0;
		}

		.products-table thead {
			background: #2d3436;
			color: white;
		}

		.products-table th {
			padding: 12px 10px;
			text-align: left;
			font-size: 0.85rem;
			font-weight: 700;
		}

		.products-table td {
			padding: 12px 10px;
			border-bottom: 1px solid #e9ecef;
			font-size: 0.9rem;
		}

		.products-table tbody tr:hover {
			background: #f8f9fa;
		}

		.delivery-badge {
			display: inline-block;
			padding: 4px 10px;
			background: #fff3cd;
			color: #856404;
			border-radius: 6px;
			font-weight: 600;
			font-size: 0.75rem;
		}

		.summary-box {
			background: #f8f9fa;
			padding: 25px;
			border-radius: 12px;
			margin-top: 25px;
		}

		.summary-row {
			display: flex;
			justify-content: space-between;
			padding: 10px 0;
			font-size: 1rem;
		}

		.summary-row.highlight {
			color: #e67e22;
			font-weight: 600;
		}

		.summary-row.total {
			font-size: 1.5rem;
			font-weight: 800;
			color: #2d3436;
			border-top: 3px solid #f1c40f;
			padding-top: 15px;
			margin-top: 10px;
		}

		.invoice-footer {
			padding: 25px;
			background: #2d3436;
			color: white;
			text-align: center;
			border-radius: 0 0 20px 20px;
		}

		.footer-actions {
			display: flex;
			justify-content: center;
			gap: 12px;
			margin-bottom: 15px;
		}

		.btn-print {
			background: #f1c40f;
			color: #000;
			padding: 10px 25px;
			border-radius: 8px;
			border: none;
			font-weight: 700;
			cursor: pointer;
			transition: 0.3s;
		}

		.btn-print:hover {
			background: #f39c12;
		}

		/* Responsive Design - Tablet */
		@media (max-width: 1024px) {
			.container {
				max-width: 95%;
			}

			header {
				flex-direction: column;
				align-items: flex-start;
				gap: 15px;
			}

			th,
			td {
				padding: 12px;
				font-size: 0.9rem;
			}

			.modal-content {
				max-width: 90%;
				padding: 0;
			}
		}

		/* Responsive Design - Mobile */
		@media (max-width: 768px) {
			body {
				padding: 10px;
			}

			.container {
				max-width: 100%;
			}

			header {
				flex-direction: column;
				align-items: flex-start;
				margin-bottom: 20px;
				padding-bottom: 10px;
			}

			.btn {
				padding: 8px 15px;
				font-size: 0.9rem;
			}

			table {
				font-size: 0.85rem;
			}

			th,
			td {
				padding: 10px 8px;
			}

			.status-badge {
				padding: 3px 8px;
				font-size: 0.7rem;
			}

			.actions {
				flex-direction: column;
				gap: 5px;
			}

			.actions .btn {
				width: 100%;
				justify-content: center;
				padding: 8px 10px;
				font-size: 0.8rem;
			}

			.modal-content {
				width: 98%;
				max-width: 100%;
				max-height: 90vh;
				border-radius: 12px;
			}

			.modal-close {
				width: 36px;
				height: 36px;
				font-size: 1.3rem;
				top: 10px;
				right: 10px;
			}

			.invoice-header {
				padding: 30px 20px;
			}

			.invoice-header h1 {
				font-size: 1.8rem;
			}

			.invoice-header .order-id {
				font-size: 0.95rem;
			}

			.invoice-body {
				padding: 20px;
			}

			.section-title {
				font-size: 1rem;
				margin-bottom: 15px;
			}

			.info-grid {
				gap: 10px;
				margin-bottom: 15px;
			}

			.info-label {
				min-width: 100px;
				font-size: 0.9rem;
			}

			.info-value {
				font-size: 0.9rem;
			}

			.products-table {
				margin: 15px 0;
				font-size: 0.8rem;
			}

			.products-table th,
			.products-table td {
				padding: 8px 6px;
			}

			.summary-box {
				padding: 15px;
				margin-top: 20px;
			}

			.summary-row {
				padding: 8px 0;
				font-size: 0.95rem;
			}

			.summary-row.total {
				font-size: 1.3rem;
				padding-top: 10px;
			}

			.invoice-footer {
				padding: 15px;
			}

			.footer-actions {
				flex-direction: column;
				gap: 10px;
				margin-bottom: 10px;
			}

			.btn-print {
				padding: 10px 20px;
				font-size: 0.9rem;
			}
		}

		/* Extra small screens */
		@media (max-width: 480px) {
			body {
				padding: 6px;
			}

			.container {
				max-width: 100%;
			}

			header div:last-child {
				width: 100%;
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 8px;
			}

			#categoryButtons {
				grid-column: 1 / -1;
				display: flex;
				flex-wrap: wrap;
				gap: 5px;
			}

			#categoryButtons .btn {
				flex: 1 1 calc(50% - 5px);
				font-size: 0.65rem;
				padding: 8px 5px;
				justify-content: center;
			}

			.btn {
				padding: 8px 10px;
				font-size: 0.8rem;
			}

			header h1 {
				font-size: 1.2rem;
				margin-bottom: 4px;
			}

			header p {
				font-size: 0.8rem;
			}

			.form-card {
				border-radius: 12px;
				margin-bottom: 15px;
			}

			table,
			thead,
			tbody,
			th,
			td,
			tr {
				display: block !important;
				width: 100% !important;
				min-width: 0 !important;
				box-sizing: border-box;
			}

			.form-card div[style*="overflow-x: auto"] {
				overflow-x: visible !important;
			}

			thead {
				display: none !important;
			}

			tr {
				background: #fff;
				border: 1px solid var(--border);
				border-radius: 12px;
				padding: 15px;
				margin-bottom: 20px;
				box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
				position: relative;
				width: 100% !important;
				overflow: hidden;
			}

			td {
				display: flex !important;
				justify-content: space-between;
				align-items: flex-start;
				padding: 10px 0 !important;
				border-bottom: 1px dashed #eee !important;
				white-space: normal !important;
				text-align: right;
				gap: 15px;
			}

			td:last-child {
				border-bottom: none !important;
				padding-top: 15px !important;
				justify-content: center;
				text-align: center;
			}

			td::before {
				content: attr(data-label);
				font-weight: 700;
				color: #888;
				text-align: left;
				font-size: 0.7rem;
				text-transform: uppercase;
				flex: 0 0 40%;
				white-space: normal;
			}

			.order-id {
				position: static !important;
				box-shadow: none !important;
				font-size: 1.1rem !important;
				color: #2980b9 !important;
				word-break: break-all;
			}

			.actions {
				width: 100%;
			}

			.actions .btn {
				width: 100%;
				padding: 14px !important;
				font-size: 0.9rem !important;
				text-transform: uppercase;
				letter-spacing: 0.5px;
			}

			.modal-content {
				width: 96%;
				max-height: 95vh;
				border-radius: 8px;
			}

			.invoice-header {
				padding: 20px 15px;
			}

			.invoice-header h1 {
				font-size: 1.3rem;
			}

			.invoice-header .order-id {
				font-size: 0.8rem;
			}

			.invoice-body {
				padding: 12px;
			}

			.section-title {
				font-size: 0.9rem;
				margin-bottom: 10px;
			}

			.info-grid {
				gap: 8px;
			}

			.info-label {
				min-width: 90px;
				font-size: 0.8rem;
			}

			.info-value {
				font-size: 0.8rem;
			}

			.products-table th,
			.products-table td {
				padding: 6px 4px;
				font-size: 0.7rem;
			}

			.summary-row {
				font-size: 0.8rem;
				padding: 6px 0;
			}

			.summary-row.total {
				font-size: 1rem;
				padding-top: 8px;
			}

			.invoice-footer {
				padding: 12px;
			}

			.btn-print {
				padding: 8px 16px;
				font-size: 0.8rem;
			}
		}
	</style>
</head>

<body>

	<div class="container">
		<header>
			<div>
				<h1 style="font-weight: 800; text-transform: uppercase;">Qu·∫£n L√Ω ƒê∆°n H√†ng</h1>
				<p style="color: #666;">Danh s√°ch ƒë∆°n h√†ng t·ª´ Google Sheet</p>
			</div>
			<div style="display: flex; gap: 12px; align-items:center;">
				<a href="len-don.html" class="btn btn-success">+ T·∫†O ƒê∆†N M·ªöI</a>
				<a href="index.html" class="btn btn-primary">TRANG CH·ª¶</a>
				<div style="width:12px"></div>
				<div id="categoryButtons" style="display:flex;gap:8px;">
					<button class="btn" id="btnAll" style="background:#ffffff;border:1px solid var(--border);">T·∫§T
						C·∫¢</button>
					<button class="btn" id="btnDuraflex" style="background:#27ae60;color:#fff;">T·∫§M DURAFLEX</button>
					<button class="btn" id="btnWeber" style="background:#000;color:#fff;">SILICONE WEBER</button>
					<button class="btn" id="btnPima" style="background:#f1c40f;color:#000;">TR·∫¶N NANO PIMA</button>
				</div>
			</div>
		</header>

		<div class="form-card">
			<div id="orderList" class="loading">ƒêang t·∫£i danh s√°ch ƒë∆°n h√†ng...</div>
		</div>
	</div>

	<!-- Invoice Modal -->
	<div id="invoiceModal" class="modal">
		<div class="modal-content">
			<button class="modal-close" onclick="closeInvoiceModal()">‚úï</button>
			<div id="invoiceContent"></div>
		</div>
	</div>

	<script>
		const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzIHfOV9rW_GQ8_Xv-WWA3KAqPMONiZQPDdOdNOcYmMSMlt93KG3zZJ7Z53OJ-d-LIJZg/exec';

		document.addEventListener('DOMContentLoaded', () => {
			initCategoryButtons();
			fetchOrders(); // load all by default
		});

		const CATEGORY_TO_SHEET = {
			'duraflex': 'don_hang_duraflex',
			'weber': 'don_hang_weber',
			'pima': 'don_hang_pima'
		};

		function initCategoryButtons() {
			const btnAll = document.getElementById('btnAll');
			const btnDur = document.getElementById('btnDuraflex');
			const btnWeb = document.getElementById('btnWeber');
			const btnPima = document.getElementById('btnPima');

			btnAll.addEventListener('click', () => { setActiveButton(btnAll); fetchOrders(); });
			btnDur.addEventListener('click', () => { setActiveButton(btnDur); fetchOrders('duraflex'); });
			btnWeb.addEventListener('click', () => { setActiveButton(btnWeb); fetchOrders('weber'); });
			btnPima.addEventListener('click', () => { setActiveButton(btnPima); fetchOrders('pima'); });

			// initial active
			setActiveButton(document.getElementById('btnAll'));
		}

		function setActiveButton(activeBtn) {
			const btns = document.querySelectorAll('#categoryButtons .btn');
			btns.forEach(b => {
				b.style.opacity = '0.9';
				b.style.transform = 'none';
			});
			activeBtn.style.opacity = '1';
			activeBtn.style.transform = 'translateY(-1px)';
		}

		function parseCurrency(str) {
			if (!str) return 0;
			return parseInt(str.toString().replace(/[^0-9]/g, '')) || 0;
		}

		function removeAccents(str) {
			return str.normalize('NFD')
				.replace(/[\u0300-\u036f]/g, '')
				.replace(/ƒë/g, 'd').replace(/ƒê/g, 'D');
		}

		// Helper to find value in row by trying multiple possible header names (case-insensitive & trimmed)
		function getRowValue(row, possibleLabels) {
			if (!row) return '';
			if (typeof possibleLabels === 'string') possibleLabels = [possibleLabels];

			const normalize = (s) => removeAccents((s || '').toString().toLowerCase().trim().replace(/\s+/g, ' '));

			const normLabels = possibleLabels.map(normalize);
			const rowKeys = Object.keys(row);

			// 1. Try exact or normalized match
			for (const key of rowKeys) {
				const nKey = normalize(key);
				if (normLabels.includes(nKey)) return row[key];
			}

			// 2. Try partial keyword match if no exact match (useful for long Vietnamese headers)
			for (const key of rowKeys) {
				const nKey = normalize(key);
				for (const label of normLabels) {
					if (nKey.length > 0 && nKey.includes(label)) {
						return row[key];
					}
				}
			}
			return '';
		}

		const CATEGORY_HEADERS = {
			'duraflex': ['Th·ªùi gian', 'M√£ ƒê∆°n', 'Lo·∫°i SP', 'Kh√°ch H√†ng', 'Ph√¢n Lo·∫°i KH', 'S·∫£n Ph·∫©m', 'ƒê∆°n Gi√°', 'S·ªë L∆∞·ª£ng', 'Th√†nh Ti·ªÅn', 's·ªë ki·ªán', 's·ªë ti·ªÅn chi·∫øt kh·∫•u ki·ªán', 's·ªë ti·ªÅn c√≤n l·∫°i trong ƒë∆°n', 'Ghi Ch√∫'],
			'weber': ['Th·ªùi gian', 'M√£ ƒê∆°n', 'Lo·∫°i SP', 'Kh√°ch H√†ng', 'Ph√¢n Lo·∫°i KH', 'S·∫£n Ph·∫©m', 'ƒê∆°n Gi√°', 'S·ªë L∆∞·ª£ng', 'Th√†nh Ti·ªÅn', 's·ªë th√πng', 't·ªïng th√πng trong ƒë∆°n', 'ghi ch√∫ ƒë∆°n h√†ng'],
			'pima': ['Th·ªùi gian', 'M√£ ƒê∆°n', 'Lo·∫°i SP', 'Kh√°ch H√†ng', 'Ph√¢n Lo·∫°i KH', 'S·∫£n Ph·∫©m', 'ƒê∆°n Gi√°', 'S·ªë L∆∞·ª£ng', 'Th√†nh Ti·ªÅn', 'ti·ªÅn h·ªó tr·ª£ v·∫≠n chuy·ªÉn', 't·ªïng ti·ªÅn trong ƒë∆°n', 't·ªïng ti·ªÅn h·ªó tr·ª£ v·∫≠n chuy·ªÉn', 's·ªë ti·ªÅn c√≤n l·∫°i trong ƒë∆°n', 'ghi ch√∫']
		};

		async function fetchOrders(category) {
			const container = document.getElementById('orderList');
			container.innerHTML = '<div class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>';
			try {
				let rows = [];

				if (!category) {
					// fetch all and merge
					const cats = Object.keys(CATEGORY_TO_SHEET);
					const fetches = cats.map(c => fetch(`${SCRIPT_URL}?category=${encodeURIComponent(c)}`).then(r => r.text()));
					const results = await Promise.all(fetches);
					results.forEach(txt => {
						const parsed = csvToJson(txt);
						rows = rows.concat(parsed);
					});

					if (rows.length === 0) {
						container.innerHTML = "Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.";
						return;
					}

					// G·ªôp c√°c d√≤ng (Summary View)
					const ordersMap = {};
					rows.forEach(r => {
						const id = getRowValue(r, ["M√£ ƒê∆°n", "M√£ ƒë∆°n", "Ma Don", "Ma don"]) || 'UNKNOWN';
						const rawCategory = getRowValue(r, ["Lo·∫°i SP", "Loai SP", "Lo·∫°i s·∫£n ph·∫©m", "Lo·∫°i"]);
						const categoryNorm = (rawCategory || '').toString().toLowerCase().trim();

						const time = getRowValue(r, ["Th·ªùi gian", "Thoi gian"]);
						const customer = getRowValue(r, ["Kh√°ch H√†ng", "Khach Hang"]);
						const custType = getRowValue(r, ["Ph√¢n Lo·∫°i KH", "Lo·∫°i KH", "Phan loai"]);
						const notes = getRowValue(r, ["Ghi Ch√∫", "Ghi ch√∫", "ghi ch√∫", "ghi ch√∫ ƒë∆°n h√†ng"]);

						let rowValue = 0;
						if (categoryNorm === 'pima' || id.startsWith('P')) {
							rowValue = parseCurrency(getRowValue(r, ["s·ªë ti·ªÅn c√≤n l·∫°i trong ƒë∆°n", "s·ªë ti·ªÅn c√≤n l·∫°i", "Remaining Amount"]));
						} else if (categoryNorm === 'duraflex' || id.startsWith('D')) {
							rowValue = parseCurrency(getRowValue(r, ["s·ªë ti·ªÅn c√≤n l·∫°i trong ƒë∆°n", "s·ªë ti·ªÅn c√≤n l·∫°i"]));
						} else {
							rowValue = parseCurrency(getRowValue(r, ["Th√†nh Ti·ªÅn", "Thanh Tien", "Th√†nh ti·ªÅn"]));
						}

						if (!ordersMap[id]) {
							ordersMap[id] = {
								id: id,
								time: time,
								category: categoryNorm,
								category_display: rawCategory || (id.startsWith('P') ? 'PIMA' : id.startsWith('D') ? 'DURAFLEX' : 'WEBER'),
								customer: customer,
								customer_type: custType,
								total: rowValue,
								items: [],
								notes: notes
							};
						} else {
							// Weber th√¨ c·ªông d·ªìn Th√†nh Ti·ªÅn, Pima/Duraflex th√¨ l·∫•y gi√° tr·ªã l·∫∑p l·∫°i (pick max)
							if (categoryNorm === 'weber' || id.startsWith('W')) {
								ordersMap[id].total += rowValue;
							} else {
								if (rowValue > ordersMap[id].total) ordersMap[id].total = rowValue;
							}
						}

						ordersMap[id].items.push({
							name: getRowValue(r, ["S·∫£n Ph·∫©m", "San Pham", "S·∫£n ph·∫©m"]),
							qty: getRowValue(r, ["S·ªë L∆∞·ª£ng", "So Luong", "S·ªë l∆∞·ª£ng"]),
							price: getRowValue(r, ["ƒê∆°n Gi√°", "Don Gia", "ƒê∆°n gi√°"]),
							subtotal: getRowValue(r, ["Th√†nh Ti·ªÅn", "Thanh Tien", "Th√†nh ti·ªÅn"]),
							surplus: parseCurrency(getRowValue(r, ["h·ªó tr·ª£", "v·∫≠n chuy·ªÉn", "ti·ªÅn h·ªó tr·ª£", "ph·∫ßn d∆∞", "surplus"]))
						});
					});

					renderTable(Object.values(ordersMap).sort((a, b) => parseVNTime(b.time) - parseVNTime(a.time)));
				} else {
					// FULL TABLE VIEW for specific category
					const res = await fetch(`${SCRIPT_URL}?category=${encodeURIComponent(category)}`);
					const csvText = await res.text();
					rows = csvToJson(csvText);

					if (rows.length === 0) {
						container.innerHTML = "Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o trong m·ª•c n√†y.";
						return;
					}

					renderCategoryFullTable(rows, category);
				}
			} catch (e) {
				console.error(e);
				container.innerHTML = `<span style="color:red">L·ªói t·∫£i d·ªØ li·ªáu: ${e.message}</span>`;
			}
		}

		function csvToJson(csv) {
			const lines = csv.trim().split(/\r?\n/);
			if (lines.length < 2) return [];

			// Parse header
			const headers = parseCSVLine(lines[0]);

			// Parse data rows
			const data = [];
			for (let i = 1; i < lines.length; i++) {
				if (lines[i].trim() === '') continue;
				const values = parseCSVLine(lines[i]);
				const obj = {};
				headers.forEach((h, idx) => {
					obj[h.trim()] = values[idx] ? values[idx].trim() : '';
				});
				data.push(obj);
			}
			return data;
		}

		function parseCSVLine(line) {
			const result = [];
			let current = '';
			let inQuotes = false;

			for (let i = 0; i < line.length; i++) {
				const char = line[i];
				const nextChar = line[i + 1];

				if (char === '"') {
					if (inQuotes && nextChar === '"') {
						current += '"';
						i++;
					} else {
						inQuotes = !inQuotes;
					}
				} else if (char === ',' && !inQuotes) {
					result.push(current);
					current = '';
				} else {
					current += char;
				}
			}
			result.push(current);
			return result;
		}

		function parseVNTime(str) {
			if (!str) return new Date(0);
			// Format: "23/12/2025 08:30:15" ho·∫∑c ISO
			const parts = str.split(/[ /:]/);
			if (parts.length >= 6) {
				return new Date(parts[2], parts[1] - 1, parts[0], parts[3], parts[4], parts[5]);
			}
			const d = new Date(str);
			return isNaN(d) ? new Date(0) : d;
		}

		function renderTable(orders) {
			const container = document.getElementById('orderList');
			let html = `
            <table style="min-width: 1000px;">
                <thead>
                    <tr>
                        <th style="width: 150px;">Th·ªùi gian</th>
                        <th style="width: 100px;">M√£ ƒê∆°n</th>
                        <th>Kh√°ch H√†ng</th>
                        <th style="width: 120px;">Lo·∫°i SP</th>
                        <th>S·∫£n ph·∫©m</th>
                        <th style="width: 150px;">T·ªïng c·ªông</th>
                        <th style="width: 150px;">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
        `;

			orders.forEach(order => {
				const catClass = `cat-${(order.category || 'pima')}`;
				const displayCat = order.category_display || (order.category ? order.category.toUpperCase() : 'PIMA');
				html += `
				<tr class="${catClass}">
					<td data-label="Th·ªùi gian" style="font-size: 0.8rem; color: #888;">${order.time}</td>
					<td data-label="M√£ ƒê∆°n" class="order-id">${order.id}</td>
					<td data-label="Kh√°ch H√†ng"><strong>${order.customer}</strong><br><small style="color:#999">${order.customer_type}</small></td>
					<td data-label="Lo·∫°i SP"><span class="status-badge">${displayCat}</span></td>
                    <td data-label="S·∫£n ph·∫©m" style="font-size: 0.85rem;">
                        ${order.items.map(i => i.name).join(', ')}
                    </td>
                    <td data-label="T·ªïng c·ªông" style="font-weight: 800; color: #e67e22; font-size: 1.1rem;">${formatCurrency(order.total || 0)}</td>
                    <td class="actions">
						<button class="btn btn-primary" style="padding: 6px 14px; font-size: 0.8rem; width:100%;" onclick='viewInvoice(${JSON.stringify(order)})'>XEM CHI TI·∫æT</button>
                    </td>
                </tr>
            `;
			});

			html += `</tbody></table>`;
			container.innerHTML = `<div style="overflow-x: auto;">${html}</div>`;
		}

		function renderCategoryFullTable(rows, category) {
			const container = document.getElementById('orderList');
			const headers = CATEGORY_HEADERS[category] || Object.keys(rows[0]);

			let html = `
				<div style="overflow-x: auto;">
					<table style="min-width: 1500px;">
						<thead>
							<tr>
								${headers.map(h => `<th>${h}</th>`).join('')}
								<th>Thao t√°c</th>
							</tr>
						</thead>
						<tbody>
			`;

			rows.reverse().forEach(row => {
				html += `<tr>`;
				headers.forEach(h => {
					let val = getRowValue(row, h) || '';
					if (h.toLowerCase().includes('ti·ªÅn') || h.toLowerCase().includes('gi√°') || h.toLowerCase().includes('t·ªïng') || h.toLowerCase().includes('chi·∫øt kh·∫•u')) {
						val = formatCurrency(parseCurrency(val));
					}
					if (h === 'M√£ ƒê∆°n') {
						html += `<td data-label="${h}" class="order-id">${val}</td>`;
					} else {
						html += `<td data-label="${h}">${val}</td>`;
					}
				});

				// Add a simplified order object for the modal
				const orderObj = { id: row["M√£ ƒê∆°n"] || row["M√£ ƒë∆°n"], time: row["Th·ªùi gian"], customer: row["Kh√°ch H√†ng"], category: category };
				html += `
					<td class="actions">
						<button class="btn btn-primary" style="padding: 5px 10px; font-size: 0.75rem;" onclick='viewInvoiceFromId("${row["M√£ ƒê∆°n"] || row["M√£ ƒë∆°n"]}", "${category}")'>XEM PHI·∫æU</button>
					</td>
				</tr>`;
			});

			html += `</tbody></table></div>`;
			container.innerHTML = html;
		}

		async function viewInvoiceFromId(orderId, category) {
			// This helper groups rows for the specific orderId to show the invoice
			const res = await fetch(`${SCRIPT_URL}?category=${encodeURIComponent(category)}`);
			const csvText = await res.text();
			const allRows = csvToJson(csvText);
			const orderRows = allRows.filter(r => (r["M√£ ƒê∆°n"] || r["M√£ ƒë∆°n"]) === orderId);

			if (orderRows.length === 0) { alert("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë∆°n h√†ng!"); return; }

			const first = orderRows[0];
			const order = {
				id: orderId,
				time: getRowValue(first, ["Th·ªùi gian", "Thoi gian"]),
				customer: getRowValue(first, ["Kh√°ch H√†ng", "Khach Hang"]),
				customer_type: getRowValue(first, ["Ph√¢n Lo·∫°i KH", "Lo·∫°i KH", "Phan Lo·∫°i KH", "Loai KH"]),
				category: category,
				notes: getRowValue(first, ["Ghi Ch√∫", "Ghi ch√∫", "ghi ch√∫", "ghi ch√∫ ƒë∆°n h√†ng"]),
				items: orderRows.map(r => ({
					name: getRowValue(r, ["S·∫£n Ph·∫©m", "San Pham", "S·∫£n ph·∫©m"]),
					qty: getRowValue(r, ["S·ªë L∆∞·ª£ng", "So Luong", "S·ªë l∆∞·ª£ng"]),
					price: getRowValue(r, ["ƒê∆°n Gi√°", "Don Gia", "ƒê∆°n gi√°"]),
					subtotal: getRowValue(r, ["Th√†nh Ti·ªÅn", "Thanh Tien", "Th√†nh ti·ªÅn"]),
					promo: getRowValue(r, ["s·ªë ti·ªÅn chi·∫øt kh·∫•u ki·ªán", "Chi·∫øt Kh·∫•u"]),
					delivery_type: getRowValue(r, ["Giao h√†ng"]),
					surplus: parseCurrency(getRowValue(r, ["h·ªó tr·ª£", "v·∫≠n chuy·ªÉn", "ti·ªÅn h·ªó tr·ª£", "ph·∫ßn d∆∞", "surplus"]))
				}))
			};

			// Calculate totals properly for the modal
			if (category === 'pima') {
				order.total = parseCurrency(first["s·ªë ti·ªÅn c√≤n l·∫°i trong ƒë∆°n"] || 0);
			} else if (category === 'duraflex') {
				order.total = parseCurrency(first["s·ªë ti·ªÅn c√≤n l·∫°i trong ƒë∆°n"] || 0);
			} else {
				order.total = orderRows.reduce((sum, r) => sum + parseCurrency(r["Th√†nh Ti·ªÅn"] || 0), 0);
			}

			viewInvoice(order);
		}

		function formatCurrency(num) {
			return new Intl.NumberFormat('vi-VN').format(num) + ' ƒë';
		}

		async function viewInvoice(order) {
			// Display invoice in modal by loading the appropriate external template
			const modal = document.getElementById('invoiceModal');
			const content = document.getElementById('invoiceContent');
			console.log('Order object:', order);

			const category = ((order.category || '') + '').toLowerCase().trim();
			const catNorm = category;
			console.log('Category normalized:', catNorm);

			// Map to template file
			const templateMap = {
				'duraflex': 'phieu-don-hang-duraflex.html',
				'weber': 'phieu-don-hang-weber.html',
				'pima': 'phieu-don-hang-pima.html'
			};

			const templateFile = templateMap[catNorm] || templateMap['pima'];

			try {
				const resp = await fetch(templateFile);
				if (!resp.ok) throw new Error('Kh√¥ng th·ªÉ load template: ' + templateFile);
				const html = await resp.text();

				// Parse template and extract the invoice container
				const parser = new DOMParser();
				const doc = parser.parseFromString(html, 'text/html');
				const invoiceNode = doc.querySelector('.invoice-container');

				if (!invoiceNode) {
					throw new Error('Template kh√¥ng ch·ª©a .invoice-container');
				}

				// Clone node into current document
				const clone = invoiceNode.cloneNode(true);
				clone.classList.add(catNorm); // dynamic styling by category (pima, duraflex, weber)

				// Populate fields inside clone
				const setText = (selector, text) => {
					const el = clone.querySelector(selector);
					if (el) el.textContent = text;
				};

				setText('#orderIdDisplay', `M√£ ƒë∆°n: ${order.id || 'N/A'}`);
				setText('#orderTimeDisplay', `Th·ªùi gian: ${order.time ? new Date(order.time).toLocaleString('vi-VN') : 'N/A'}`);
				setText('#customerName', order.customer || 'N/A');
				setText('#customerType', order.customer_type || order.phan_loai || 'N/A');

				// Products ‚Äî compute category-specific pricing and promos
				const tbody = clone.querySelector('#productsTableBody');
				if (tbody) {
					tbody.innerHTML = '';
					if (!order.items || order.items.length === 0) {
						tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 30px;">Kh√¥ng c√≥ s·∫£n ph·∫©m</td></tr>';
					} else {
						// Load pricing data depending on category
						let duraflexData = null;
						let chietKhauData = null;
						let weberData = null;
						let pimaData = null;
						try {
							if (catNorm === 'duraflex') {
								const [dResp, cResp] = await Promise.all([
									fetch('data/gia_duraflex.json'),
									fetch('data/chiet_khau_duraflex.json')
								]);
								duraflexData = dResp.ok ? await dResp.json() : null;
								chietKhauData = cResp.ok ? await cResp.json() : null;
							} else if (catNorm === 'weber') {
								const wResp = await fetch('data/gia_silicon_weber.json');
								weberData = wResp.ok ? await wResp.json() : null;
							} else if (catNorm === 'pima') {
								const pResp = await fetch('data/gia_web_nano.json');
								pimaData = pResp.ok ? await pResp.json() : null;
							}
						} catch (e) {
							console.warn('Kh√¥ng th·ªÉ load pricing data:', e);
						}

						// Totals
						let computedGross = 0;
						let computedDiscount = 0;
						let computedSurplus = 0;
						let computedPackages = 0;
						let computedBoxes = 0;
						let computedDiff = 0; // for pima kho diff

						order.items.forEach((item, index) => {
							const tr = document.createElement('tr');
							const qty = parseInt(item.qty || item.quantity || 0) || 0;
							let unitPrice = parseInt(item.price || item.unit_price || 0) || 0;
							let promoAmount = 0;
							let lineSubtotal = parseInt(item.subtotal || 0) || unitPrice * qty;

							if (catNorm === 'duraflex' && duraflexData) {
								const nameLower = (item.name || '').toString().toLowerCase();
								const found = duraflexData.find(p => (p["T√™n s·∫£n ph·∫©m"] || '').toString().toLowerCase().includes(nameLower) || nameLower.includes((p["T√™n s·∫£n ph·∫©m"] || '').toString().toLowerCase()));
								if (found) {
									const listed = parseInt((found["gi√° ni√™m y·∫øt"] || '').toString().replace(/[^0-9]/g, '')) || unitPrice;
									unitPrice = listed;
									const perPackage = parseInt((found["s·ªë t·∫•m trong 1 ki·ªán"] || '').toString().replace(/[^0-9]/g, '')) || 1;
									const packages = Math.floor(qty / perPackage);
									promoAmount = 0;
									if (chietKhauData && packages > 0) {
										const applicable = chietKhauData.filter(t => parseInt(t["g√≥i chi·∫øt kh·∫•u theo ki·ªán"] || '0') <= packages);
										if (applicable && applicable.length) {
											const best = applicable.reduce((a, b) => parseInt(a["g√≥i chi·∫øt kh·∫•u theo ki·ªán"]) > parseInt(b["g√≥i chi·∫øt kh·∫•u theo ki·ªán"]) ? a : b);
											const perPackageDiscount = parseInt((best["s·ªë ti·ªÅn chi·∫øt kh·∫•u"] || '0').toString().replace(/[^0-9]/g, '')) || 0;
											promoAmount = perPackageDiscount * packages;
										}
									}
									lineSubtotal = unitPrice * qty - promoAmount;
									computedDiscount += promoAmount;
									computedPackages += packages;
								}
							} else if (catNorm === 'weber' && weberData) {
								const nameLower = (item.name || '').toString().toLowerCase();
								const found = weberData.find(p => (p['t√™n s·∫£n ph·∫©m'] || '').toString().toLowerCase().includes(nameLower) || nameLower.includes((p['t√™n s·∫£n ph·∫©m'] || '').toString().toLowerCase()));
								if (found) {
									const bottlesPerBox = parseInt((found['s·ªë chai trong 1 th√πng'] || '').toString().replace(/[^0-9]/g, '')) || 1;
									const listedUnit = parseInt((found['gi√° ni√™m y·∫øt theo chai'] || found['gi√° b√°n l·∫ª theo chai'] || '').toString().replace(/[^0-9]/g, '')) || unitPrice;
									unitPrice = listedUnit;
									const boxes = Math.floor(qty / bottlesPerBox);
									let promoText = '';
									if (boxes >= 3) {
										const freeBoxes = Math.floor(boxes / 3);
										promoText = `T·∫∂NG ${freeBoxes} th√πng`;
									} else if (boxes === 2) {
										promoText = (found['khuy·∫øn m√£i 2 th√πng'] || 'mua 2 th√πng t·∫∑ng 15 chai');
									} else if (boxes === 1) {
										promoText = (found['khuy·∫øn m√£i 1 th√πng'] || 'mua 1 th√πng t·∫∑ng 5 chai');
									}
									if (promoText) {
										item._promoNote = promoText;
									}
									lineSubtotal = unitPrice * qty;
									computedBoxes += boxes;
								}
							} else if (catNorm === 'pima' && pimaData) {
								const nameLower = (item.name || '').toString().toLowerCase();
								const found = pimaData.find(p => (p['t√™n s·∫£n ph·∫©m'] || '').toString().toLowerCase().includes(nameLower) || nameLower.includes((p['t√™n s·∫£n ph·∫©m'] || '').toString().toLowerCase()));
								if (found) {
									const priceKho = parseInt(found['gi√° t·∫°i kho'] || 0) || 0;
									const priceChanh = parseInt(found['gi√° ra ch√†nh'] || 0) || unitPrice;
									if ((item.delivery_type || '').toString().toLowerCase().includes('t·∫°i kho') || (item.delivery_type || '').toString().toLowerCase().includes('tai kho')) {
										unitPrice = priceKho || unitPrice;
										const diff = (priceChanh - unitPrice) * qty;
										computedDiff += diff > 0 ? diff : 0;
									} else {
										unitPrice = priceChanh || unitPrice;
									}
									lineSubtotal = unitPrice * qty;
								}
							}

							computedGross += lineSubtotal;
							computedSurplus += parseInt(item.surplus || 0);

							// Column 5 decision logic
							let column5Content = '-';
							if (catNorm === 'duraflex') {
								column5Content = formatCurrency(promoAmount);
							} else if (catNorm === 'weber') {
								column5Content = item._promoNote || '-';
							} else if (catNorm === 'pima') {
								const transportVal = parseInt(item.surplus || 0);
								const status = transportVal > 0 ? 'T·∫°i kho' : 'Ra ch√†nh';
								column5Content = `<span class="delivery-badge">${status}</span>`;
							} else {
								column5Content = item.delivery_type ? `<span class="delivery-badge">${item.delivery_type}</span>` : '-';
							}

							tr.innerHTML = `
								<td>${index + 1}</td>
								<td><strong>${item.name || 'N/A'}</strong></td>
								<td>${qty}</td>
								<td>${formatCurrency(unitPrice)}</td>
								<td>${column5Content}</td>
								<td><strong>${formatCurrency(lineSubtotal)}</strong></td>
							`;
							tbody.appendChild(tr);
						});

						// After loop, handle category-specific summary population
						if (catNorm === 'pima') {
							setText('#summaryTransportSupport', formatCurrency(computedSurplus));
							setText('#summaryOrderTotal', formatCurrency(computedGross + computedSurplus));
							setText('#summaryTotal', formatCurrency(parseInt(order.total || 0) || computedGross));
						} else if (catNorm === 'duraflex') {
							setText('#summaryTotalPackages', computedPackages);
							setText('#summaryGross', formatCurrency(computedGross + computedDiscount));
							setText('#summaryDiscount', `- ${formatCurrency(computedDiscount)}`);
							setText('#summaryTotal', formatCurrency(parseInt(order.total || 0) || computedGross));
						} else if (catNorm === 'weber') {
							setText('#summaryTotalBoxes', computedBoxes);
							setText('#summaryTotal', formatCurrency(parseInt(order.total || 0) || computedGross));
						} else {
							// default summary for weber/pima
							setText('#summaryTotal', formatCurrency(parseInt(order.total || 0) || computedGross));
						}
					}
				}

				// Summary
				const total = parseInt(order.total || 0);
				const summaryEl = clone.querySelector('#summaryTotal');
				if (summaryEl) summaryEl.textContent = formatCurrency(total);

				// Notes
				if (order.notes && order.notes.trim()) {
					const notesSection = clone.querySelector('#notesSection');
					const notesEl = clone.querySelector('#orderNotes');
					if (notesSection && notesEl) {
						notesSection.style.display = 'block';
						notesEl.textContent = order.notes;
					}
				}

				// Inject clone into modal content
				content.innerHTML = '';
				content.appendChild(clone);
				modal.style.display = 'flex';
				document.body.style.overflow = 'hidden';
			} catch (e) {
				console.error(e);
				// No inline fallback ‚Äî show a clear error to user
				content.innerHTML = `
					<div style="padding:24px; max-width:700px; color:#c0392b; background:#fff3f3; border-radius:8px;">
						<h3 style="margin-bottom:8px;">L·ªói t·∫£i m·∫´u phi·∫øu</h3>
						<p>Kh√¥ng th·ªÉ t·∫£i m·∫´u phi·∫øu "${templateFile}". Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi ho·∫∑c th·ª≠ l·∫°i sau.</p>
					</div>
				`;
				modal.style.display = 'flex';
				document.body.style.overflow = 'hidden';
			}
		}

		function generateInvoiceHTML(order, category) {
			// Normalize category - ensure it's a clean string
			const catNorm = ((category || '') + '').toLowerCase().trim();
			console.log('generateInvoiceHTML: category input =', category, 'normalized =', catNorm);

			// Determine header color and class based on category
			let headerClass = 'pima';
			let headerGradient = 'linear-gradient(135deg, #f1c40f, #f39c12)';
			let headerTextColor = '#000';
			let footerText = 'C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ tin t∆∞·ªüng s·ª≠ d·ª•ng s·∫£n ph·∫©m Pima Nano';
			let btnColor = '#f1c40f';

			if (catNorm === 'duraflex') {
				headerClass = 'duraflex';
				headerGradient = 'linear-gradient(135deg, #2ecc71, #27ae60)';
				headerTextColor = '#fff';
				footerText = 'C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ tin t∆∞·ªüng s·ª≠ d·ª•ng s·∫£n ph·∫©m Duraflex';
				btnColor = '#2ecc71';
			} else if (catNorm === 'weber') {
				headerClass = 'weber';
				headerGradient = 'linear-gradient(135deg, #000, #222)';
				headerTextColor = '#fff';
				footerText = 'C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ tin t∆∞·ªüng s·ª≠ d·ª•ng s·∫£n ph·∫©m Weber';
				btnColor = '#000';
			}

			console.log('invoice visual: catNorm=', catNorm, 'headerGradient=', headerGradient, 'btnColor=', btnColor, 'headerTextColor=', headerTextColor);

			// Generate products table
			let productsHTML = '';
			let totalGross = 0;
			let totalSurplus = 0;

			if (!order.items || order.items.length === 0) {
				productsHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 30px;">Kh√¥ng c√≥ s·∫£n ph·∫©m</td></tr>';
			} else {
				order.items.forEach((item, index) => {
					const subtotal = parseInt(item.subtotal || 0);
					const price = parseInt(item.price || 0);
					const qty = parseInt(item.qty || 0);
					const surplus = parseInt(item.surplus || 0);

					if (surplus > 0) {
						totalSurplus += surplus;
						totalGross += subtotal + surplus;
					} else {
						totalGross += subtotal;
					}

					let tableCell = `
						<tr>
							<td>${index + 1}</td>
							<td><strong>${item.name || 'N/A'}</strong></td>
							<td>${qty}</td>
							<td>${formatCurrency(price)}</td>
					`;

					if (catNorm === 'duraflex') {
						tableCell += `<td>${formatCurrency(item.promo || 0)}</td>`;
					} else if (catNorm === 'weber') {
						tableCell += `<td><span style="background: #e9ecef; padding: 4px 10px; border-radius: 5px; font-size: 0.75rem; font-weight: 700;">${item.delivery_type || '-'}</span></td>`;
					} else {
						tableCell += `<td><span style="background: #fff3cd; padding: 4px 10px; border-radius: 5px; font-size: 0.75rem; font-weight: 700; color: #856404;">${item.delivery_type || '-'}</span></td>`;
					}

					tableCell += `<td><strong>${formatCurrency(subtotal)}</strong></td></tr>`;
					productsHTML += tableCell;
				});
			}

			// Generate summary
			const total = parseInt(order.total || 0);
			let summaryHTML = '';

			if (catNorm === 'duraflex') {
				summaryHTML = `
					<div class="summary-row total">
						<span>T·ªîNG C·ªòNG:</span>
						<span>${formatCurrency(total)}</span>
					</div>
				`;
			} else if (catNorm === 'weber') {
				summaryHTML = `
					<div class="summary-row total">
						<span>T·ªîNG C·ªòNG:</span>
						<span>${formatCurrency(total)}</span>
					</div>
				`;
			} else {
				summaryHTML = `
					<div class="summary-row">
						<span>T·ªïng gi√° tr·ªã:</span>
						<span>${formatCurrency(totalGross)}</span>
					</div>
					${totalSurplus > 0 ? `
					<div class="summary-row" style="color: #e67e22; font-weight: 700;">
						<span>H·ªó tr·ª£ v·∫≠n chuy·ªÉn:</span>
						<span>- ${formatCurrency(totalSurplus)}</span>
					</div>
					` : ''}
					<div class="summary-row total">
						<span>${totalSurplus > 0 ? 'S·ªê TI·ªÄN C√íN L·∫†I:' : 'T·ªîNG C·ªòNG:'}</span>
						<span>${formatCurrency(total)}</span>
					</div>
				`;
			}

			const invoiceHTML = `
				<div style="max-width: 900px; margin: 0 auto; background: white; border-radius: 10px; overflow: hidden;">
					<div style="background: ${headerGradient}; color: ${headerTextColor}; padding: 30px 28px; text-align: center;">
						<h1 style="font-size: 1.8rem; font-weight: 800; margin-bottom: 6px;">PHI·∫æU ƒê∆†N H√ÄNG</h1>
						<div style="font-size: 0.95rem; font-weight: 600; opacity: 0.9;">M√£ ƒë∆°n: ${order.id || 'N/A'}</div>
						<div style="margin-top: 10px; font-size: 0.95rem; opacity: 0.9;">Th·ªùi gian: ${order.time ? new Date(order.time).toLocaleString('vi-VN') : 'N/A'}</div>
							<!-- DEBUG: hi·ªÉn th·ªã category ƒë∆∞·ª£c d√πng ƒë·ªÉ t·∫°o phi·∫øu -->
							<div style="margin-top:6px; font-size:0.85rem; opacity:0.95; font-weight:700; color: ${headerTextColor};">DEBUG category: ${catNorm}</div>
					</div>

					<div style="padding: 28px;">
						<!-- Customer Info -->
						<div style="margin-bottom: 22px;">
							<div style="font-size: 1rem; font-weight: 700; color: #2d3436; margin-bottom: 14px; padding-bottom: 6px; border-bottom: 2px solid ${catNorm === 'duraflex' ? '#2ecc71' : catNorm === 'weber' ? '#000' : '#f1c40f'};">TH√îNG TIN KH√ÅCH H√ÄNG</div>
							<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; margin-bottom: 16px;">
								<div style="display: flex; gap: 8px;">
									<span style="font-weight: 700; color: #666; min-width: 120px; font-size: 0.9rem;">T√™n kh√°ch h√†ng:</span>
									<span style="color: #2d3436; font-weight: 500; font-size: 0.9rem;">${order.customer || 'N/A'}</span>
								</div>
								<div style="display: flex; gap: 8px;">
									<span style="font-weight: 700; color: #666; min-width: 120px; font-size: 0.9rem;">Ph√¢n lo·∫°i:</span>
									<span style="color: #2d3436; font-weight: 500; font-size: 0.9rem;">${order.customer_type || 'N/A'}</span>
								</div>
							</div>
						</div>

						<!-- Products -->
						<div style="margin-bottom: 22px;">
							<div style="font-size: 1rem; font-weight: 700; color: #2d3436; margin-bottom: 14px; padding-bottom: 6px; border-bottom: 2px solid ${catNorm === 'duraflex' ? '#2ecc71' : catNorm === 'weber' ? '#000' : '#f1c40f'};">CHI TI·∫æT S·∫¢N PH·∫®M</div>
							<table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
								<thead>
									<tr style="background: #2d3436; color: white;">
										<th style="padding: 10px; text-align: left; font-size: 0.85rem; font-weight: 700;">STT</th>
										<th style="padding: 10px; text-align: left; font-size: 0.85rem; font-weight: 700;">T√™n s·∫£n ph·∫©m</th>
										<th style="padding: 10px; text-align: left; font-size: 0.85rem; font-weight: 700;">S·ªë l∆∞·ª£ng</th>
										<th style="padding: 10px; text-align: left; font-size: 0.85rem; font-weight: 700;">ƒê∆°n gi√°</th>
										<th style="padding: 10px; text-align: left; font-size: 0.85rem; font-weight: 700;">${catNorm === 'duraflex' ? 'Chi·∫øt kh·∫•u' : catNorm === 'weber' ? 'T·∫°i kho' : 'Giao h√†ng'}</th>
										<th style="padding: 10px; text-align: left; font-size: 0.85rem; font-weight: 700;">Th√†nh ti·ªÅn</th>
									</tr>
								</thead>
								<tbody>
									${productsHTML}
								</tbody>
							</table>
						</div>

						<!-- Summary -->
						<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 18px;">
							${summaryHTML}
						</div>

						${order.notes ? `
						<div style="margin-bottom: 22px; margin-top: 22px;">
							<div style="font-size: 1rem; font-weight: 700; color: #2d3436; margin-bottom: 14px; padding-bottom: 6px; border-bottom: 2px solid ${catNorm === 'duraflex' ? '#2ecc71' : catNorm === 'weber' ? '#000' : '#f1c40f'};">GHI CH√ö</div>
							<p style="color: #666; line-height: 1.6;">${order.notes}</p>
						</div>
						` : ''}
					</div>

					<div style="padding: 20px 28px; background: #2d3436; color: white; text-align: center;">
						<div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 12px;">
							<button onclick="printInvoice()" style="padding: 9px 24px; border-radius: 7px; border: none; font-weight: 700; cursor: pointer; background: ${btnColor}; color: ${catNorm === 'pima' ? '#000' : '#fff'}; font-size: 0.9rem;">üìÑ IN PHI·∫æU</button>
							<button onclick="closeInvoiceModal()" style="padding: 9px 24px; border-radius: 7px; border: none; font-weight: 700; cursor: pointer; background: #95a5a6; color: white; font-size: 0.9rem;">‚úï ƒê√ìNG</button>
						</div>
						<p style="font-size: 0.9rem; opacity: 0.8;">${footerText}</p>
					</div>
				</div>
			`;

			return invoiceHTML;
		}

		function closeInvoiceModal() {
			const modal = document.getElementById('invoiceModal');
			modal.style.display = 'none';
			document.body.style.overflow = 'auto';
		}

		function printInvoice() {
			const content = document.getElementById('invoiceContent').innerHTML;
			const printWindow = window.open('', '', 'width=800,height=600');
			printWindow.document.write(`
			<html>
			<head>
				<title>Phi·∫øu ƒê∆°n H√†ng</title>
				<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
				<style>
					* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
					body { background: white; }
					.invoice-container { background: white; }
					.footer-actions { display: none !important; }
					table { width: 100%; border-collapse: collapse; }
					th, td { padding: 10px; border: 1px solid #e9ecef; text-align: left; }
					th { background: #2d3436; color: white; }
				</style>
			</head>
			<body>${content}</body>
			</html>
		`);
			printWindow.document.close();
			setTimeout(() => {
				printWindow.print();
				printWindow.close();
			}, 250);
		}

		function generateInvoiceHTML(order) {
			let totalGross = 0;
			let totalSurplus = 0;

			let productsHTML = '';
			if (!order.items || order.items.length === 0) {
				productsHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 30px;">Kh√¥ng c√≥ s·∫£n ph·∫©m</td></tr>';
			} else {
				order.items.forEach((item, index) => {
					const deliveryBadge = item.delivery_type ? `<span class="delivery-badge">${item.delivery_type}</span>` : '-';
					const surplus = parseInt(item.surplus || 0);
					const subtotal = parseInt(item.subtotal || 0);
					const price = parseInt(item.price || item.unit_price || 0);
					const qty = parseInt(item.qty || item.quantity || 0);

					if (surplus > 0) {
						totalSurplus += surplus;
						totalGross += subtotal + surplus;
					} else {
						totalGross += subtotal;
					}

					productsHTML += `
					<tr>
						<td>${index + 1}</td>
						<td><strong>${item.name || 'N/A'}</strong></td>
						<td>${qty}</td>
						<td>${formatCurrency(price)}</td>
						<td>${deliveryBadge}</td>
						<td><strong>${formatCurrency(subtotal)}</strong></td>
					</tr>
				`;
				});
			}

			const total = parseInt(order.total || 0);
			const surplusRowHTML = totalSurplus > 0 ? `
			<div class="summary-row highlight">
				<span>H·ªó tr·ª£ v·∫≠n chuy·ªÉn:</span>
				<span>- ${formatCurrency(totalSurplus)}</span>
			</div>
		` : '';

			const totalLabel = totalSurplus > 0 ? 'S·ªê TI·ªÄN C√íN L·∫†I:' : 'T·ªîNG C·ªòNG:';
			const notesHTML = order.notes && order.notes.trim() ? `
			<div class="section">
				<div class="section-title">GHI CH√ö</div>
				<p style="color: #666; line-height: 1.6;">${order.notes}</p>
			</div>
		` : '';

			return `
			<div class="invoice-container">
				<div class="invoice-header">
					<h1>PHI·∫æU ƒê∆†N H√ÄNG</h1>
					<div class="order-id">M√£ ƒë∆°n: ${order.id || 'N/A'}</div>
					<div style="margin-top: 10px; font-size: 0.95rem; opacity: 0.9;">Th·ªùi gian: ${order.time ? new Date(order.time).toLocaleString('vi-VN') : 'N/A'}</div>
				</div>

				<div class="invoice-body">
					<div class="section">
						<div class="section-title">TH√îNG TIN KH√ÅCH H√ÄNG</div>
						<div class="info-grid">
							<div class="info-item">
								<span class="info-label">T√™n kh√°ch h√†ng:</span>
								<span class="info-value">${order.customer || 'N/A'}</span>
							</div>
							<div class="info-item">
								<span class="info-label">Ph√¢n lo·∫°i:</span>
								<span class="info-value">${order.customer_type || 'N/A'}</span>
							</div>
							<div class="info-item">
								<span class="info-label">Lo·∫°i s·∫£n ph·∫©m:</span>
								<span class="info-value">${order.category || 'N/A'}</span>
							</div>
						</div>
					</div>

					<div class="section">
						<div class="section-title">CHI TI·∫æT S·∫¢N PH·∫®M</div>
						<table class="products-table">
							<thead>
								<tr>
									<th>STT</th>
									<th>T√™n s·∫£n ph·∫©m</th>
									<th>S·ªë l∆∞·ª£ng</th>
									<th>ƒê∆°n gi√°</th>
									<th>Giao h√†ng</th>
									<th>Th√†nh ti·ªÅn</th>
								</tr>
							</thead>
							<tbody>
								${productsHTML}
							</tbody>
						</table>
					</div>

					<div class="summary-box">
						<div class="summary-row">
							<span>T·ªïng gi√° tr·ªã (Gi√° ch√†nh):</span>
							<span>${formatCurrency(totalGross || total)}</span>
						</div>
						${surplusRowHTML}
						<div class="summary-row total">
							<span>${totalLabel}</span>
							<span>${formatCurrency(total)}</span>
						</div>
					</div>

					${notesHTML}
				</div>

				<div class="invoice-footer">
					<div class="footer-actions">
						<button class="btn btn-print" onclick="printInvoice()">üìÑ IN PHI·∫æU</button>
					</div>
					<p style="font-size: 0.9rem; opacity: 0.8;">C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ tin t∆∞·ªüng s·ª≠ d·ª•ng s·∫£n ph·∫©m Pima Nano</p>
				</div>
			</div>
		`;
		}

		function editOrder(order) {
			// L∆∞u data v√†o localStorage v√† chuy·ªÉn sang trang l√™n ƒë∆°n v·ªõi mode edit
			localStorage.setItem('editingOrder', JSON.stringify(order));
			window.location.href = 'len-don.html';
		}

		// Close modal on clicking outside
		document.addEventListener('click', function (e) {
			const modal = document.getElementById('invoiceModal');
			if (e.target === modal) {
				closeInvoiceModal();
			}
		});

		// Close modal on ESC key
		document.addEventListener('keydown', function (e) {
			if (e.key === 'Escape') {
				closeInvoiceModal();
			}
		});
	</script>

</body>

</html>