<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>S·ª≠a ƒê∆°n H√†ng | Dunvex Digital</title>
	<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
	<style>
		:root {
			--primary: #6366f1;
			--bg-dark: #0f172a;
			--card-bg: rgba(30, 41, 59, 0.7);
			--glass-border: rgba(255, 255, 255, 0.1);
			--text-main: #f8fafc;
			--text-muted: #94a3b8;
			--accent-purple: #c084fc;
			--success: #22c55e;
			--danger: #ef4444;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Outfit', sans-serif;
		}

		body {
			background-color: var(--bg-dark);
			color: var(--text-main);
			min-height: 100vh;
			background-image: radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%), radial-gradient(at 100% 100%, rgba(192, 132, 252, 0.15) 0px, transparent 50%);
			padding: 20px;
		}

		.container {
			max-width: 1000px;
			margin: 40px auto;
		}

		.header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
		}

		.header h1 {
			font-size: 1.8rem;
			font-weight: 800;
			background: linear-gradient(135deg, #fff, var(--primary));
			-webkit-background-clip: text;
			background-clip: text;
			-webkit-text-fill-color: transparent;
		}

		.card {
			background: var(--card-bg);
			backdrop-filter: blur(20px);
			border: 1px solid var(--glass-border);
			border-radius: 24px;
			padding: 30px;
			margin-bottom: 25px;
		}

		.form-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 20px;
		}

		.form-group {
			margin-bottom: 20px;
		}

		label {
			display: block;
			font-size: 0.8rem;
			color: var(--text-muted);
			margin-bottom: 8px;
			text-transform: uppercase;
			letter-spacing: 1px;
		}

		input,
		select,
		textarea {
			width: 100%;
			padding: 12px 16px;
			background: rgba(0, 0, 0, 0.2);
			border: 1px solid var(--glass-border);
			border-radius: 12px;
			color: white;
			font-size: 1rem;
			outline: none;
			transition: 0.3s;
		}

		input:focus,
		select:focus {
			border-color: var(--primary);
			background: rgba(0, 0, 0, 0.4);
		}

		/* Item Table */
		table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 20px;
		}

		th {
			text-align: left;
			font-size: 0.75rem;
			color: var(--text-muted);
			padding: 10px;
			border-bottom: 1px solid var(--glass-border);
		}

		td {
			padding: 10px;
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
		}

		.btn {
			padding: 10px 20px;
			border-radius: 12px;
			font-weight: 600;
			cursor: pointer;
			transition: 0.3s;
			border: none;
			font-size: 0.9rem;
		}

		.btn-primary {
			background: var(--primary);
			color: white;
		}

		.btn-primary:hover {
			transform: translateY(-2px);
			box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
		}

		.btn-add {
			background: rgba(99, 102, 241, 0.1);
			color: var(--primary);
			border: 1px dashed var(--primary);
			width: 100%;
			margin-top: 15px;
		}

		.btn-add:hover {
			background: rgba(99, 102, 241, 0.2);
		}

		.btn-remove {
			background: rgba(239, 68, 68, 0.1);
			color: var(--danger);
			padding: 5px 10px;
			font-size: 0.8rem;
		}

		/* Summary */
		.summary-card {
			display: flex;
			flex-direction: column;
			align-items: flex-end;
			gap: 10px;
			margin-top: 20px;
		}

		.summary-row {
			display: flex;
			justify-content: space-between;
			width: 300px;
			font-size: 1rem;
		}

		.total-large {
			font-size: 1.8rem;
			font-weight: 800;
			color: var(--primary);
			margin-top: 10px;
		}

		#toast {
			position: fixed;
			top: 20px;
			right: 20px;
			padding: 16px 24px;
			border-radius: 12px;
			background: var(--success);
			color: white;
			font-weight: 600;
			transform: translateX(200%);
			transition: 0.4s;
			z-index: 3000;
		}

		#toast.active {
			transform: translateX(0);
		}

		.back-btn {
			text-decoration: none;
			color: var(--text-muted);
			font-size: 0.9rem;
			transition: 0.3s;
		}

		.back-btn:hover {
			color: white;
		}

		.logo-box {
			display: flex;
			align-items: center;
			gap: 8px;
			font-weight: 800;
			font-size: 1.8rem;
			letter-spacing: -1px;
			color: var(--text-main);
			text-decoration: none;
			margin-bottom: 5px;
		}

		.logo-box span {
			background: linear-gradient(135deg, var(--primary), var(--accent-purple));
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
		}

		.status-badge {
			padding: 4px 12px;
			border-radius: 20px;
			font-size: 0.75rem;
			font-weight: 700;
			background: rgba(99, 102, 241, 0.2);
			color: var(--primary);
		}

		/* Toggle Adjustment */
		.adjustment-toggle {
			display: flex;
			background: rgba(0, 0, 0, 0.3);
			padding: 4px;
			border-radius: 12px;
			border: 1px solid var(--glass-border);
			margin-bottom: 12px;
		}

		.adj-btn {
			flex: 1;
			padding: 8px;
			border: none;
			background: transparent;
			color: var(--text-muted);
			font-size: 0.8rem;
			font-weight: 600;
			cursor: pointer;
			border-radius: 8px;
			transition: 0.3s;
		}

		.adj-btn.active {
			background: var(--primary);
			color: white;
		}

		#loadingOverlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: var(--bg-dark);
			display: flex;
			justify-content: center;
			align-items: center;
			z-index: 9999;
			flex-direction: column;
			gap: 20px;
		}

		.spinner {
			width: 50px;
			height: 50px;
			border: 5px solid rgba(255, 255, 255, 0.1);
			border-top-color: var(--primary);
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			to {
				transform: rotate(360deg);
			}
		}

		/* Responsive Adjustments */
		@media (max-width: 768px) {
			body {
				padding: 10px;
			}

			.container {
				margin: 10px auto;
			}

			.header {
				flex-direction: column;
				align-items: flex-start;
				gap: 15px;
			}

			.header h1 {
				font-size: 1.5rem;
			}

			.form-grid {
				grid-template-columns: 1fr;
			}

			.card {
				padding: 20px 15px;
				border-radius: 16px;
			}

			/* Table to Card Transformation */
			table thead {
				display: none;
			}

			table,
			tbody,
			tr,
			td {
				display: block;
				width: 100%;
			}

			tr {
				margin-bottom: 25px;
				padding-bottom: 20px;
				border-bottom: 2px solid var(--glass-border);
				position: relative;
			}

			td {
				border: none;
				padding: 8px 0;
				display: flex;
				flex-direction: column;
				gap: 5px;
			}

			td:before {
				content: attr(data-label);
				font-size: 0.7rem;
				color: var(--text-muted);
				text-transform: uppercase;
				font-weight: 700;
			}

			.item-total {
				font-size: 1.1rem;
				text-align: right;
			}

			.btn-remove {
				position: absolute;
				top: 0;
				right: 0;
				border-radius: 50%;
				width: 30px;
				height: 30px;
				padding: 0;
				display: flex;
				align-items: center;
				justify-content: center;
			}

			/* Summary Section */
			.summary-section-grid {
				grid-template-columns: 1fr !important;
				gap: 20px !important;
			}

			.summary-card {
				align-items: center;
				border-top: 1px solid var(--glass-border);
				padding-top: 20px;
			}

			.summary-row {
				width: 100%;
			}

			.total-large {
				font-size: 2rem;
			}
		}
	</style>
</head>

<body>

	<div id="loadingOverlay">
		<div class="spinner"></div>
		<p>ƒêang chu·∫©n b·ªã d·ªØ li·ªáu ch·ªânh s·ª≠a...</p>
	</div>

	<div id="toast">Th√¥ng b√°o!</div>

	<div class="container">
		<div class="header">
			<div>
				<a href="index.html" class="logo-box">Dun<span>vex</span></a>
				<h1 id="pageTitle" style="font-size: 1.5rem; margin-top: 5px;">üìù Ch·ªânh S·ª≠a ƒê∆°n H√†ng</h1>
				<p style="color: var(--text-muted); font-size: 0.9rem;" id="orderIdDisplay">ƒêang t·∫£i...</p>
			</div>
			<a href="danh-sach-don-hang.html" class="back-btn">‚Üê Quay l·∫°i danh s√°ch</a>
		</div>

		<form id="orderForm">
			<!-- PH·∫¶N 1: TH√îNG TIN CHUNG -->
			<div class="card">
				<div class="form-grid">
					<div class="form-group">
						<label>Kh√°ch h√†ng *</label>
						<select id="ten_khach_hang" required>
							<option value="">-- Ch·ªçn kh√°ch h√†ng --</option>
						</select>
					</div>
					<div class="form-group">
						<label>Tr·∫°ng th√°i ƒë∆°n</label>
						<select id="trang_thai_don_hang">
							<option value="ƒê∆°n ch·ªët">ƒê∆°n ch·ªët</option>
							<option value="ƒêang x·ª≠ l√Ω">ƒêang x·ª≠ l√Ω</option>
							<option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
							<option value="ƒê√£ h·ªßy">ƒê√£ h·ªßy</option>
						</select>
					</div>
				</div>
				<div class="form-group">
					<label>Ghi ch√∫ ƒë∆°n h√†ng</label>
					<textarea id="ghi_chu_don_hang" rows="2" placeholder="Y√™u c·∫ßu giao h√†ng s·ªõm..."></textarea>
				</div>
			</div>

			<!-- PH·∫¶N 2: CHI TI·∫æT S·∫¢N PH·∫®M -->
			<div class="card">
				<label>Danh s√°ch s·∫£n ph·∫©m</label>
				<table>
					<thead>
						<tr>
							<th style="width: 25%;">Ng√†nh h√†ng</th>
							<th style="width: 30%;">S·∫£n ph·∫©m</th>
							<th style="width: 10%;">S·ªë l∆∞·ª£ng</th>
							<th style="width: 15%;">ƒê∆°n gi√°</th>
							<th style="width: 5%;">Ki·ªán</th>
							<th style="width: 10%;">Th√†nh ti·ªÅn</th>
							<th style="width: 5%;"></th>
						</tr>
					</thead>
					<tbody id="itemsBody">
						<!-- Rows added here -->
					</tbody>
				</table>
				<button type="button" class="btn btn-add" onclick="addItemRow()">+ Th√™m s·∫£n ph·∫©m</button>
			</div>

			<!-- PH·∫¶N 3: T·ªîNG H·ª¢P & THANH TO√ÅN -->
			<div class="card">
				<div class="summary-section-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
					<div class="form-group">
						<label>ƒêi·ªÅu ch·ªânh ƒë∆°n h√†ng</label>
						<div class="adjustment-toggle">
							<button type="button" class="adj-btn active" onclick="setAdjustment('add', this)">+ V·∫¨N
								CHUY·ªÇN</button>
							<button type="button" class="adj-btn" onclick="setAdjustment('sub', this)">- CHI·∫æT
								KH·∫§U</button>
						</div>
						<input type="hidden" id="adj_type" value="add">
						<input type="number" id="tong_tien_dich_vu" value="0" placeholder="S·ªë ti·ªÅn..."
							oninput="calculateTotal()">
					</div>
					<div class="summary-card">
						<div class="summary-row">
							<span>Ti·ªÅn h√†ng:</span>
							<span id="label_tien_hang">0 ƒë</span>
						</div>
						<div class="summary-row">
							<span id="label_adj_name">Ph√≠ v·∫≠n chuy·ªÉn:</span>
							<span id="label_phi_dv">0 ƒë</span>
						</div>
						<div class="total-large" id="label_tong_cong">0 ƒë</div>
						<button type="submit" class="btn btn-primary" id="btnSubmit"
							style="width: 100%; margin-top: 20px; padding: 15px;">L∆ØU CH·ªàNH S·ª¨A</button>
					</div>
				</div>
			</div>
		</form>
	</div>

	<script>
		const ORDER_URL = 'https://script.google.com/macros/s/AKfycby_Uduzhl4k6aVfQEcgRr7XV3Vz-xJSIHIuQ4sD50I8Y0662wEHcWHgQMGJ2IaRgeNL5w/exec';

		let productsLookup = [];
		let customersList = [];
		let currentUser = JSON.parse(localStorage.getItem('user'));
		if (!currentUser) window.location.href = 'auth.html';

		async function initPage() {
			try {
				// 1. T·∫£i kh√°ch h√†ng & s·∫£n ph·∫©m tr∆∞·ªõc
				const resInitial = await fetch(ORDER_URL, {
					method: 'POST',
					body: JSON.stringify({ action: 'get_initial_data', salesId: currentUser.email, adminEmail: currentUser.adminEmail })
				});
				const dataInitial = await resInitial.json();

				if (!dataInitial.success) {
					alert("L·ªói t·∫£i d·ªØ li·ªáu c∆° b·∫£n: " + dataInitial.message);
					return;
				}

				productsLookup = dataInitial.products || [];
				customersList = dataInitial.customers || [];

				// ƒê·ªï d·ªØ li·ªáu kh√°ch h√†ng
				document.getElementById('ten_khach_hang').innerHTML = '<option value="">-- Ch·ªçn kh√°ch h√†ng --</option>' +
					customersList.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

				// 2. X√°c ƒë·ªãnh ID ƒë∆°n h√†ng c·∫ßn s·ª≠a
				const params = new URLSearchParams(window.location.search);
				let orderId = params.get('id') || localStorage.getItem('edit_order_id');

				if (!orderId) {
					alert("Kh√¥ng t√¨m th·∫•y m√£ ƒë∆°n h√†ng ƒë·ªÉ s·ª≠a!");
					window.location.href = 'danh-sach-don-hang.html';
					return;
				}

				// 3. T·∫£i th√¥ng tin ƒë∆°n h√†ng
				await loadOrderData(orderId);

				// T·∫Øt overlay sau khi xong
				document.getElementById('loadingOverlay').style.display = 'none';
				localStorage.removeItem('edit_order_id');

			} catch (e) {
				console.error(e);
				alert("L·ªói kh·ªüi t·∫°o trang s·ª≠a ƒë∆°n: " + e.message);
			}
		}

		async function loadOrderData(orderId) {
			document.getElementById('orderIdDisplay').innerText = "ƒêang t·∫£i d·ªØ li·ªáu ƒë∆°n: " + orderId;

			const [resOrders, resDetails] = await Promise.all([
				fetch(ORDER_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'get_orders',
						userEmail: currentUser.email,
						isAdmin: currentUser.roleId === 'R001'
					})
				}),
				fetch(ORDER_URL, { method: 'POST', body: JSON.stringify({ action: 'get_order_details', order_id: orderId }) })
			]);

			const dataOrders = await resOrders.json();
			const dataDetails = await resDetails.json();
			const header = dataOrders.orders.find(o => o.id_don_hang === orderId);

			if (!header || !dataDetails.success) {
				alert("Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng m√£: " + orderId);
				window.location.href = 'danh-sach-don-hang.html';
				return;
			}

			// ƒê·ªï d·ªØ li·ªáu Header
			document.getElementById('ten_khach_hang').value = header.ten_khach_hang;
			document.getElementById('trang_thai_don_hang').value = header.trang_thai_don_hang;
			document.getElementById('ghi_chu_don_hang').value = header.ghi_chu_don_hang || '';
			document.getElementById('orderForm').setAttribute('data-id', orderId);
			document.getElementById('orderIdDisplay').innerText = "S·ª≠a ƒê∆°n: " + orderId + " (" + header.ngay_len_don + ")";

			// X·ª≠ l√Ω Ph√≠/Chi·∫øt kh·∫•u
			const fee = parseFloat(header.tong_tien_dich_vu) || 0;
			if (fee < 0) {
				document.getElementById('tong_tien_dich_vu').value = Math.abs(fee);
				setAdjustment('sub', document.querySelectorAll('.adj-btn')[1]);
			} else {
				document.getElementById('tong_tien_dich_vu').value = fee;
				setAdjustment('add', document.querySelectorAll('.adj-btn')[0]);
			}

			// ƒê·ªï d·ªØ li·ªáu Items
			const tbody = document.getElementById('itemsBody');
			tbody.innerHTML = '';

			if (dataDetails.details && dataDetails.details.length > 0) {
				dataDetails.details.forEach(item => {
					addItemRow(item);
				});
			} else {
				addItemRow();
			}

			calculateTotal();
		}

		function addItemRow(itemData = null) {
			const tbody = document.getElementById('itemsBody');
			const rowId = 'row_' + Date.now() + Math.random().toString(36).substr(2, 5);
			const tr = document.createElement('tr');
			tr.id = rowId;

			const categoriesCached = productsLookup.map(p => getCategoryName(p));
			const categories = [...new Set(categoriesCached)].sort();

			tr.innerHTML = `
                <td data-label="Ng√†nh h√†ng">
                    <select class="cat-select" onchange="onCategoryChange('${rowId}', this.value)" required>
                        <option value="">-- Ng√†nh --</option>
                        ${categories.map(c => `<option value="${c}">${c}</option>`).join('')}
                    </select>
                </td>
                <td data-label="S·∫£n ph·∫©m">
                    <select class="item-select" onchange="onProductChange('${rowId}', this.value)" required disabled>
                        <option value="">-- Ch·ªçn SP --</option>
                    </select>
                    <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px;" class="item-spec">${itemData ? itemData.quy_cach_san_pham : ''}</div>
                </td>
                <td data-label="S·ªë l∆∞·ª£ng"><input type="number" class="item-qty" value="${itemData ? itemData.so_luong : '1'}" min="1" oninput="onQtyChange('${rowId}')" required></td>
                <td data-label="ƒê∆°n gi√°"><input type="number" class="item-price" value="${itemData ? itemData.gia_tien : ''}" oninput="calculateTotal()" required></td>
                <td data-label="S·ªë ki·ªán" class="item-pack" style="font-size: 0.8rem; font-weight: 600;">${itemData ? itemData.tinh_kien_trong_don : '0'}</td>
                <td data-label="Th√†nh ti·ªÅn" class="item-total" style="font-weight: 700; color: var(--primary);">0 ƒë</td>
                <td><button type="button" class="btn-remove" onclick="removeRow('${rowId}')">√ó</button></td>
            `;

			tbody.appendChild(tr);

			if (itemData) {
				const p = productsLookup.find(x => x.id_san_pham === itemData.id_san_pham);
				if (p) {
					tr.setAttribute('data-packing', p.dong_kien || 1);
					const catSel = tr.querySelector('.cat-select');
					catSel.value = getCategoryName(p);
					onCategoryChange(rowId, catSel.value, itemData.id_san_pham);
				}
			}
			return rowId;
		}

		function onCategoryChange(rowId, catName, selectedItemId = null) {
			const row = document.getElementById(rowId);
			const itemSel = row.querySelector('.item-select');

			if (!catName) {
				itemSel.innerHTML = '<option value="">-- Ch·ªçn SP --</option>';
				itemSel.disabled = true;
				return;
			}

			const filtered = productsLookup.filter(p => getCategoryName(p) === catName).sort((a, b) => a.ten_san_pham.localeCompare(b.ten_san_pham));
			itemSel.innerHTML = '<option value="">-- Ch·ªçn SP --</option>' +
				filtered.map(p => `<option value="${p.id_san_pham}" ${selectedItemId === p.id_san_pham ? 'selected' : ''}>${p.ten_san_pham}</option>`).join('');
			itemSel.disabled = false;
		}

		function onProductChange(rowId, prodId) {
			const p = productsLookup.find(x => x.id_san_pham === prodId);
			const row = document.getElementById(rowId);
			if (p) {
				row.querySelector('.item-price').value = p.gia_san_pham;
				row.querySelector('.item-spec').innerText = p.quy_cach;
				row.setAttribute('data-packing', p.dong_kien || 1);
				onQtyChange(rowId);
			}
		}

		function onQtyChange(rowId) {
			const row = document.getElementById(rowId);
			const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
			const packing = parseFloat(row.getAttribute('data-packing')) || 1;
			row.querySelector('.item-pack').innerText = (qty / packing).toFixed(2);
			calculateTotal();
		}

		function removeRow(id) {
			const row = document.getElementById(id);
			if (document.querySelectorAll('#itemsBody tr').length > 1) {
				row.remove();
				calculateTotal();
			}
		}

		function setAdjustment(type, btn) {
			document.getElementById('adj_type').value = type;
			document.querySelectorAll('.adj-btn').forEach(b => b.classList.remove('active'));
			btn.classList.add('active');
			document.getElementById('label_adj_name').innerText = type === 'add' ? 'Ph√≠ v·∫≠n chuy·ªÉn:' : 'Chi·∫øt kh·∫•u:';
			calculateTotal();
		}

		function calculateTotal() {
			let subtotal = 0;
			document.querySelectorAll('#itemsBody tr').forEach(row => {
				const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
				const price = parseFloat(row.querySelector('.item-price').value) || 0;
				const total = qty * price;
				subtotal += total;
				row.querySelector('.item-total').innerText = formatCurrency(total);
			});

			const adjType = document.getElementById('adj_type').value;
			const serviceFee = parseFloat(document.getElementById('tong_tien_dich_vu').value) || 0;
			const grandTotal = adjType === 'add' ? (subtotal + serviceFee) : (subtotal - serviceFee);

			document.getElementById('label_tien_hang').innerText = formatCurrency(subtotal);
			document.getElementById('label_phi_dv').innerText = (adjType === 'sub' ? '- ' : '+ ') + formatCurrency(serviceFee);
			document.getElementById('label_tong_cong').innerText = formatCurrency(grandTotal);

			return { subtotal, serviceFee, grandTotal, adjType };
		}

		document.getElementById('orderForm').onsubmit = async (e) => {
			e.preventDefault();
			const btn = document.getElementById('btnSubmit');
			btn.disabled = true;
			btn.innerText = "ƒêANG L∆ØU CH·ªàNH S·ª¨A...";

			const totals = calculateTotal();
			const items = [];
			document.querySelectorAll('#itemsBody tr').forEach(row => {
				const pId = row.querySelector('.item-select').value;
				const p = productsLookup.find(x => x.id_san_pham === pId);
				const qty = parseFloat(row.querySelector('.item-qty').value);
				const price = parseFloat(row.querySelector('.item-price').value);

				if (pId) {
					items.push({
						id_san_pham: pId,
						ten_san_pham: p.ten_san_pham,
						quy_cach_san_pham: p.quy_cach,
						gia_tien: price,
						so_luong: qty,
						thanh_tien: qty * price,
						tinh_kien_trong_don: (qty / (p.dong_kien || 1)).toFixed(2)
					});
				}
			});

			const header = {
				id_don_hang: document.getElementById('orderForm').getAttribute('data-id'),
				ten_khach_hang: document.getElementById('ten_khach_hang').value,
				trang_thai_don_hang: document.getElementById('trang_thai_don_hang').value,
				tong_tien_trong_don: totals.subtotal,
				tong_tien_dich_vu: totals.adjType === 'sub' ? -totals.serviceFee : totals.serviceFee,
				so_tien_con_lai: totals.grandTotal,
				nguoi_len_don: currentUser.email,
				ghi_chu_don_hang: document.getElementById('ghi_chu_don_hang').value
			};

			try {
				const res = await fetch(ORDER_URL, {
					method: 'POST',
					body: JSON.stringify({ action: 'save_order', header, items })
				});
				const data = await res.json();
				if (data.success) {
					// --- ƒê·ªíNG B·ªò KHO T·ª∞ ƒê·ªòNG ---
					const finalizedStatuses = ['ƒê∆°n ch·ªët', 'Ho√†n th√†nh'];
					if (finalizedStatuses.includes(header.trang_thai_don_hang)) {
						try {
							const SYNC_INV_URL = 'https://script.google.com/macros/s/AKfycbxhXNBpF0lgvQg-EQ-Y5GpBIfGl7orPeIZdkVIOo3BoJmvJpdqHvSnvrMQOtOzGZh_u/exec';
							await fetch(SYNC_INV_URL, {
								method: 'POST',
								body: JSON.stringify({
									action: 'sync_order_to_inventory',
									orderId: header.id_don_hang,
									userEmail: currentUser.email,
									adminEmail: (currentUser.roleId === 'R005' ? currentUser.adminEmail : currentUser.email)
								})
							});
						} catch (eInv) { console.error("L·ªói ƒë·ªìng b·ªô kho:", eInv); }
					}
					// ---------------------------

					showToast("C·∫≠p nh·∫≠t ƒë∆°n h√†ng th√†nh c√¥ng!");
					setTimeout(() => window.location.href = 'danh-sach-don-hang.html', 2000);
				} else {
					showToast("L·ªói: " + data.message, true);
					btn.disabled = false;
				}
			} catch (e) {
				showToast("L·ªói k·∫øt n·ªëi", true);
				btn.disabled = false;
			}
		};

		function getCategoryName(p) {
			if (!p) return 'S·∫£n ph·∫©m kh√°c';
			return (p.ten_nghanh_hang || p.ten_nghanh || p.loai_san_pham || p.nhom_hang || 'S·∫£n ph·∫©m kh√°c').toString().trim();
		}
		function formatCurrency(val) { return new Intl.NumberFormat('vi-VN').format(val) + ' ƒë'; }
		function showToast(msg, isError = false) {
			const t = document.getElementById('toast');
			t.innerText = msg;
			t.style.background = isError ? 'var(--danger)' : 'var(--success)';
			t.classList.add('active');
			setTimeout(() => t.classList.remove('active'), 3000);
		}

		window.onload = initPage;
	</script>
</body>

</html>