<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Danh S√°ch B·∫£ng Gi√° | Dunvex Digital</title>
	<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
	<style>
		:root {
			--primary: #6366f1;
			--bg-dark: #0f172a;
			--card-bg: rgba(30, 41, 59, 0.7);
			--glass-border: rgba(255, 255, 255, 0.1);
			--text-main: #f8fafc;
			--text-muted: #94a3b8;
			--accent-purple: #c084fc;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Outfit', sans-serif;
		}

		body {
			background-color: var(--bg-dark);
			color: var(--text-main);
			min-height: 100vh;
			padding: 40px 20px;
			background-image: radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%), radial-gradient(at 100% 100%, rgba(192, 132, 252, 0.15) 0px, transparent 50%);
		}

		.container {
			max-width: 1000px;
			margin: 0 auto;
		}

		.header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 40px;
		}

		.header h1 {
			font-size: 2rem;
			font-weight: 800;
			background: linear-gradient(135deg, #fff, var(--primary));
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
		}

		.btn {
			padding: 12px 24px;
			border-radius: 12px;
			font-weight: 700;
			cursor: pointer;
			text-decoration: none;
			display: inline-flex;
			align-items: center;
			gap: 8px;
			transition: 0.3s;
		}

		.btn-primary {
			background: var(--primary);
			color: white;
			border: none;
		}

		.btn-primary:hover {
			transform: translateY(-2px);
			box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
		}

		/* Grid List */
		.grid-list {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
			gap: 24px;
		}

		.pl-card {
			background: var(--card-bg);
			backdrop-filter: blur(10px);
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			padding: 24px;
			transition: 0.3s;
			position: relative;
			overflow: hidden;
		}

		.pl-card:hover {
			transform: translateY(-5px);
			border-color: var(--primary);
			box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
		}

		.logo-strip {
			width: 100%;
			height: 60px;
			object-fit: contain;
			margin-bottom: 20px;
			filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.2));
		}

		.pl-title {
			font-size: 1.1rem;
			font-weight: 800;
			margin-bottom: 8px;
			color: white;
		}

		.pl-customer {
			font-size: 0.85rem;
			color: var(--accent-purple);
			margin-bottom: 15px;
			display: flex;
			align-items: center;
			gap: 6px;
		}

		.pl-meta {
			font-size: 0.75rem;
			color: var(--text-muted);
			margin-top: 15px;
			padding-top: 15px;
			border-top: 1px solid var(--glass-border);
			display: flex;
			justify-content: space-between;
		}

		.actions {
			display: flex;
			gap: 10px;
			margin-top: 20px;
		}

		.btn-action {
			flex: 1;
			padding: 8px;
			border-radius: 8px;
			font-size: 0.8rem;
			font-weight: 600;
			text-align: center;
			cursor: pointer;
			transition: 0.2s;
			border: 1px solid var(--glass-border);
			background: rgba(255, 255, 255, 0.05);
			color: white;
			text-decoration: none;
		}

		.btn-action:hover {
			background: var(--primary);
			border-color: var(--primary);
		}

		.btn-delete:hover {
			background: #ef4444;
			border-color: #ef4444;
		}

		/* Loading */
		#loader {
			display: none;
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
		}

		.spinner {
			width: 40px;
			height: 40px;
			border: 4px solid rgba(255, 255, 255, 0.1);
			border-top-color: var(--primary);
			border-radius: 50%;
			animation: spin 1s infinite linear;
		}

		@keyframes spin {
			to {
				transform: rotate(360deg);
			}
		}
	</style>
</head>

<body>
	<div id="loader">
		<div class="spinner"></div>
	</div>

	<div class="container">
		<div class="header">
			<h1>Danh S√°ch B·∫£ng Gi√°</h1>
			<a href="tao-bang-gia.html" class="btn btn-primary">‚ûï T·∫°o M·ªõi</a>
		</div>

		<div id="plList" class="grid-list">
			<!-- Price lists will appear here -->
		</div>
	</div>

	<script>
		const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxJAbSw_qt8cYDU6DD0eOUL0cL_UHsSEWFNE59WO32JTvySnOHztKnAULpXTi8gkiEl/exec';
		let currentUser = JSON.parse(localStorage.getItem('user'));
		let perms = JSON.parse(localStorage.getItem('permissions'));

		if (!currentUser) window.location.href = 'auth.html';

		async function loadList() {
			const loader = document.getElementById('loader');
			loader.style.display = 'block';

			try {
				const res = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'get_price_lists',
						userEmail: currentUser.email,
						isAdmin: currentUser.roleId === 'R001'
					})
				});
				const data = await res.json();
				if (data.success) {
					renderList(data.lists);
				}
			} catch (e) {
				console.error(e);
			} finally {
				loader.style.display = 'none';
			}
		}

		function renderList(lists) {
			const container = document.getElementById('plList');
			if (!lists || lists.length === 0) {
				container.innerHTML = '<p style="text-align: center; grid-column: 1/-1; color: var(--text-muted); padding: 50px;">Ch∆∞a c√≥ b·∫£ng gi√° n√†o ƒë∆∞·ª£c t·∫°o.</p>';
				return;
			}

			container.innerHTML = lists.map(pl => `
				<div class="pl-card">
					${pl.logo ? `<img src="${pl.logo}" class="logo-strip">` : '<div class="logo-strip" style="background: rgba(255,255,255,0.05); border-radius: 10px;"></div>'}
					<div class="pl-title">${pl.title}</div>
					<div class="pl-customer">üè¢ ${pl.customer}</div>
					
					<div class="actions">
						<a href="view-bang-gia.html?id=${pl.id}" class="btn-action" onclick="localStorage.setItem('last_view_pl_id', '${pl.id}')">üëÅÔ∏è Xem chi ti·∫øt</a>
						<a href="tao-bang-gia.html?id=${pl.id}" class="btn-action" style="background: rgba(99, 102, 241, 0.1); color: var(--primary);" onclick="localStorage.setItem('last_edit_pl_id', '${pl.id}')">‚úèÔ∏è S·ª≠a</a>
						<button class="btn-action btn-delete" onclick="deletePL('${pl.id}')">üóëÔ∏è X√≥a</button>
					</div>

					<div class="pl-meta">
						<span>üë§ ${pl.createdBy.split('@')[0]}</span>
						<span>üìÖ ${new Date(pl.createdAt).toLocaleDateString('vi-VN')}</span>
					</div>
				</div>
			`).join('');
		}

		async function deletePL(id) {
			if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£ng gi√° n√†y kh√¥ng?")) return;

			const loader = document.getElementById('loader');
			loader.style.display = 'block';

			try {
				const res = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({ action: 'delete_price_list', fileId: id })
				});
				const data = await res.json();
				if (data.success) {
					loadList();
				}
			} catch (e) {
				console.error(e);
			} finally {
				loader.style.display = 'none';
			}
		}

		if (currentUser) loadList();
		else window.location.href = 'auth.html';
	</script>
</body>

</html>