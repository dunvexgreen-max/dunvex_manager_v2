<!DOCTYPE html>
<html lang="vi">

<head>
	<!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-QFQ2HMYTDH"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag() { dataLayer.push(arguments); }
		gtag('js', new Date());

		gtag('config', 'G-QFQ2HMYTDH');
	</script>

	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Qu·∫£n L√Ω C√¥ng N·ª£ Kh√°ch H√†ng | Dunvex Digital</title>
	<link rel="icon" type="image/svg+xml"
		href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23FACC15'/><text x='50%' y='50%' dominant-baseline='central' text-anchor='middle' fill='white' font-size='60' font-family='sans-serif' font-weight='800'>DV</text></svg>">
	<link
		href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@600;800&display=swap"
		rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<script src="security-utils.js"></script>
	<script src="assets/theme-toggle.js"></script>
	<script>
		const session = SecurityProvider.validateAccess();
		const currentUser = session ? session.user : null;
	</script>
	<link rel="stylesheet" href="assets/theme.css">
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
			text-rendering: optimizeLegibility;
			-webkit-font-smoothing: antialiased;
			-moz-osx-font-smoothing: grayscale;
			font-weight: 500;
		}

		body {
			background-color: var(--bg-body);
			color: var(--text-main);
			min-height: 100vh;
			padding: 20px;
			-webkit-text-size-adjust: 100%;
			background-image: var(--bg-gradient-1), var(--bg-gradient-2);
			background-attachment: fixed;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
		}

		/* Header */
		.header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
			padding: 24px 30px;
			background: var(--card-bg);
			border: 1px solid var(--glass-border);
			border-radius: 24px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
		}

		.header-title h1 {
			font-size: 2.2rem;
			font-weight: 800;
			color: var(--text-main);
			letter-spacing: -0.5px;
		}

		.header-title p {
			color: var(--text-muted);
			font-size: 0.9rem;
		}

		.btn {
			padding: 12px 24px;
			border-radius: 12px;
			border: none;
			font-weight: 800;
			cursor: pointer;
			transition: all 0.3s;
			display: flex;
			align-items: center;
			gap: 8px;
			text-decoration: none;
			font-size: 0.95rem;
		}

		.btn-primary {
			background: var(--primary);
			color: #0f172a;
			box-shadow: 0 4px 12px rgba(250, 204, 21, 0.3);
		}

		.btn-primary:hover {
			background: #facc15;
			transform: translateY(-2px);
			box-shadow: 0 8px 20px rgba(250, 204, 21, 0.4);
		}

		/* Stats Grid */
		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
			gap: 20px;
			margin-bottom: 30px;
		}

		.stat-card {
			background: var(--card-bg);
			border: 1px solid var(--glass-border);
			padding: 24px;
			border-radius: 20px;
			display: flex;
			flex-direction: column;
			gap: 15px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
			transition: transform 0.3s;
		}

		.stat-card:hover {
			transform: translateY(-5px);
		}

		.stat-header-row {
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.stat-label {
			color: #64748b;
			font-size: 0.8rem;
			font-weight: 700;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}

		.stat-value {
			font-size: 1.8rem;
			font-weight: 900;
			color: var(--text-main);
			letter-spacing: -0.5px;
		}

		.stat-value.danger {
			color: #e11d48;
		}

		.stat-value.success {
			color: #16a34a;
		}

		/* Tabs */
		.tabs {
			display: flex;
			gap: 10px;
			margin-bottom: 25px;
			background: var(--card-bg);
			padding: 6px;
			border-radius: 16px;
			width: fit-content;
			border: 1px solid var(--glass-border);
		}

		.tab-btn {
			padding: 10px 25px;
			border-radius: 12px;
			border: none;
			background: transparent;
			color: var(--text-muted);
			font-weight: 800;
			cursor: pointer;
			transition: 0.3s;
		}

		.tab-btn.active {
			background: var(--primary);
			color: #0f172a;
			box-shadow: 0 4px 12px rgba(250, 204, 21, 0.2);
		}

		/* Content Sections */
		.section {
			display: none;
			animation: fadeIn 0.4s ease;
		}

		.section.active {
			display: block;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(10px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		/* Table Styles */
		.table-container {
			background: var(--card-bg);
			border: 1px solid var(--glass-border);
			border-radius: 24px;
			overflow-x: auto;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
			-webkit-overflow-scrolling: touch;
		}

		.table-responsive {
			width: 100%;
			overflow-x: auto;
			-webkit-overflow-scrolling: touch;
		}

		table {
			width: 100%;
			border-collapse: collapse;
		}

		th {
			text-align: left;
			padding: 20px;
			background: var(--bg-dark);
			color: var(--text-muted);
			font-size: 0.85rem;
			text-transform: uppercase;
			letter-spacing: 1px;
			font-weight: 900;
			border-bottom: 2px solid var(--glass-border);
		}

		td {
			padding: 20px;
			border-bottom: 1px solid var(--glass-border);
			vertical-align: middle;
			font-weight: 600;
			color: var(--text-main);
		}

		tr:last-child td {
			border-bottom: none;
		}

		tr:hover {
			background: rgba(255, 255, 255, 0.02);
		}

		.cust-name {
			font-weight: 600;
			color: var(--text-main);
		}

		.amount {
			font-weight: 800;
			color: #166534;
		}

		.amount.debt {
			color: var(--danger);
		}

		/* Floating Actions */
		.payment-form {
			background: var(--card-bg);
			border: 1px solid var(--glass-border);
			padding: 40px;
			border-radius: 28px;
			max-width: 600px;
			margin: 0 auto;
			box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
		}

		.form-group {
			margin-bottom: 20px;
		}

		.form-group label {
			display: block;
			margin-bottom: 10px;
			font-size: 0.9rem;
			color: #475569;
			font-weight: 800;
			text-transform: uppercase;
		}

		input,
		select,
		textarea {
			width: 100%;
			padding: 15px 18px;
			background: var(--card-bg) !important;
			border: 1.5px solid var(--glass-border) !important;
			border-radius: 14px;
			color: var(--text-main) !important;
			font-size: 1rem;
			transition: 0.3s;
			font-weight: 600;
		}

		input:focus {
			border-color: var(--primary) !important;
			box-shadow: 0 0 0 4px rgba(250, 204, 21, 0.15);
		}

		.file-upload {
			position: relative;
			height: 150px;
			border: 2px dashed var(--glass-border);
			border-radius: 14px;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: 0.3s;
			overflow: hidden;
		}

		.file-upload:hover {
			border-color: var(--primary);
		}

		.file-upload img {
			width: 100%;
			height: 100%;
			object-fit: contain;
			display: none;
		}

		.file-upload .upload-icon {
			font-size: 2rem;
			color: var(--text-muted);
		}

		/* Toast & Loader */
		#toast {
			position: fixed;
			top: 20px;
			right: 20px;
			padding: 15px 30px;
			border-radius: 12px;
			background: var(--success);
			color: white;
			font-weight: 600;
			transform: translateX(200%);
			transition: 0.4s;
			z-index: 10000;
		}

		#toast.active {
			transform: translateX(0);
		}

		.loader {
			position: fixed;
			inset: 0;
			background: rgba(15, 23, 42, 0.8);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 20000;
			backdrop-filter: blur(5px);
		}

		.spinner {
			width: 50px;
			height: 50px;
			border: 5px solid rgba(255, 255, 255, 0.1);
			border-top-color: var(--primary);
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			to {
				transform: rotate(360deg);
			}
		}

		/* Details Toggle */
		.history-btn {
			background: rgba(192, 132, 252, 0.1);
			color: var(--accent-purple);
			padding: 6px 12px;
			border-radius: 8px;
			font-size: 0.8rem;
			cursor: pointer;
			border: none;
		}

		.btn-remove {
			background: rgba(239, 68, 68, 0.1);
			color: var(--danger);
			border: none;
			padding: 8px;
			border-radius: 8px;
			cursor: pointer;
			transition: 0.3s;
		}

		.btn-remove:hover {
			background: var(--danger);
			color: white;
		}

		.btn-mail {
			background: rgba(56, 189, 248, 0.1);
			color: var(--accent-blue);
			border: none;
			padding: 8px 12px;
			border-radius: 8px;
			cursor: pointer;
			transition: 0.3s;
			font-size: 0.8rem;
			font-weight: 600;
			display: flex;
			align-items: center;
			gap: 6px;
		}

		.btn-mail:hover:not(:disabled) {
			background: var(--accent-blue);
			color: white;
		}

		.btn-locked {
			opacity: 0.5;
			cursor: not-allowed !important;
			filter: grayscale(1);
		}

		/* Modal History */
		.modal {
			display: none;
			position: fixed;
			inset: 0;
			background: rgba(0, 0, 0, 0.8);
			z-index: 5000;
			padding: 40px;
			align-items: center;
			justify-content: center;
		}

		.modal.active {
			display: flex;
		}

		.modal-content {
			background: var(--card-bg);
			width: 100%;
			max-width: 800px;
			max-height: 85vh;
			border: 1px solid var(--glass-border);
			border-radius: 28px;
			padding: 40px;
			overflow-y: auto;
			position: relative;
			box-shadow: 0 25px 70px rgba(0, 0, 0, 0.2);
		}

		.close-modal {
			position: absolute;
			top: 20px;
			right: 20px;
			color: var(--text-muted);
			cursor: pointer;
			font-size: 1.5rem;
		}

		.toggle-switch {
			display: flex;
			align-items: center;
			gap: 10px;
			cursor: pointer;
		}

		.switch {
			position: relative;
			display: inline-block;
			width: 44px;
			height: 24px;
		}

		.switch input {
			opacity: 0;
			width: 0;
			height: 0;
		}

		.slider {
			position: absolute;
			cursor: pointer;
			inset: 0;
			background-color: rgba(255, 255, 255, 0.1);
			transition: .4s;
			border-radius: 24px;
		}

		.slider:before {
			position: absolute;
			content: "";
			height: 18px;
			width: 18px;
			left: 3px;
			bottom: 3px;
			background-color: white;
			transition: .4s;
			border-radius: 50%;
		}

		input:checked+.slider {
			background-color: var(--primary);
		}

		/* Suggestions Handled globally by theme.css */

		input:checked+.slider:before {
			transform: translateX(20px);
		}

		@media (max-width: 768px) {
			body {
				padding: 10px;
			}

			.header {
				flex-direction: column;
				gap: 20px;
				padding: 20px;
				text-align: center;
				border-radius: 20px;
			}

			.header-title h1 {
				font-size: 1.8rem;
			}

			.header-title p {
				font-size: 0.85rem;
			}

			.header .btn {
				width: 100%;
				justify-content: center;
			}

			.stats-grid {
				grid-template-columns: 1fr;
				gap: 12px;
			}

			.stat-card {
				padding: 20px;
				border-radius: 20px;
				align-items: center;
				text-align: center;
			}

			.stat-header-row {
				justify-content: center;
			}

			.stat-label {
				font-size: 0.75rem;
			}

			.stat-value {
				font-size: 1.6rem;
			}

			/* Tabs as grid for mobile */
			.tabs {
				display: grid;
				grid-template-columns: repeat(2, 1fr);
				width: 100%;
				gap: 8px;
				background: transparent;
				border: none;
				padding: 0;
			}

			.tab-btn {
				padding: 12px 10px;
				background: var(--card-bg);
				border: 1px solid var(--glass-border);
				font-size: 0.75rem;
				border-radius: 12px;
				text-align: center;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}

			/* Scope card-view to tables in .table-container only */
			.table-container table,
			.table-container thead,
			.table-container tbody,
			.table-container th,
			.table-container td,
			.table-container tr {
				display: block;
			}

			.table-container thead tr {
				position: absolute;
				top: -9999px;
				left: -9999px;
			}

			.table-container tr {
				background: var(--card-bg);
				border: 1px solid var(--glass-border);
				border-radius: 20px;
				margin-bottom: 15px;
				padding: 15px;
				display: block;
				box-shadow: 0 4px 10px rgba(0, 0, 0, 0.02);
			}

			.table-container td {
				border: none;
				border-bottom: 1px solid rgba(255, 255, 255, 0.05);
				position: relative;
				padding: 12px 5px 12px 45%;
				text-align: right;
				font-size: 0.9rem;
				min-height: 45px;
				display: flex;
				align-items: center;
				justify-content: flex-end;
			}

			.table-container td:last-child {
				border-bottom: none;
			}

			.table-container td:before {
				content: attr(data-label);
				position: absolute;
				left: 5px;
				width: 40%;
				text-align: left;
				font-weight: 800;
				color: var(--text-muted);
				font-size: 0.75rem;
				text-transform: uppercase;
			}

			/* Explicitly force table layout for statement */
			.statement-table {
				display: table !important;
				width: 100% !important;
				border-collapse: collapse !important;
			}

			.statement-table tr {
				display: table-row !important;
			}

			.statement-table th,
			.statement-table td {
				display: table-cell !important;
			}

			.cust-name {
				font-size: 1rem;
				color: var(--primary);
			}

			.payment-form {
				padding: 25px 20px;
				border-radius: 20px;
			}

			.file-upload {
				height: 120px;
			}

			.btn-mail {
				width: 100%;
				justify-content: center;
				margin-bottom: 8px;
			}

			.history-btn {
				width: 100%;
				padding: 10px;
				justify-content: center;
				display: flex;
			}

			.modal {
				padding: 5px;
			}

			/* Specific Modal & Statement Fixes */
			.modal-content {
				padding: 5px;
				border-radius: 12px;
				width: 100%;
				max-width: 100%;
				margin: 0;
				max-height: 98vh;
				background: #f8fafc;
				overflow-y: auto;
				/* ALLOW SCROLLING */
				-webkit-overflow-scrolling: touch;
			}

			#statementSheet {
				width: 100%;
				min-height: 300px;
				display: block;
				overflow: hidden;
				position: relative;
			}

			.statement-paper {
				width: 800px !important;
				max-width: 800px !important;
				min-width: 800px !important;
				padding: 25px !important;
				background: white !important;
				color: #333 !important;
				transform-origin: 0 0;
				position: absolute;
				top: 0;
				left: 0;
				margin: 0 !important;
				border: none !important;
				box-shadow: none !important;
				/* Scale to fit the actual modal width */
				transform: scale(0.42);
				/* Default for small phones */
			}

			/* Dynamic scales for different screen widths */
			@media (min-width: 360px) {
				.statement-paper {
					transform: scale(0.43);
				}
			}

			@media (min-width: 380px) {
				.statement-paper {
					transform: scale(0.45);
				}
			}

			@media (min-width: 400px) {
				.statement-paper {
					transform: scale(0.48);
				}
			}

			@media (min-width: 450px) {
				.statement-paper {
					transform: scale(0.53);
				}
			}

			@media (min-width: 500px) {
				.statement-paper {
					transform: scale(0.60);
				}
			}

			@media (min-width: 600px) {
				.statement-paper {
					transform: scale(0.70);
				}
			}
		}

		/* Global Statement Sheet Style (Desktop Default) */
		.statement-paper {
			background: white;
			color: #333;
			padding: 40px;
			border-radius: 4px;
			box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
			max-width: 800px;
			margin: 0 auto;
			font-family: 'Inter', sans-serif;
		}

		.statement-header {
			display: flex;
			justify-content: space-between;
			border-bottom: 2px solid var(--primary);
			padding-bottom: 20px;
			margin-bottom: 30px;
		}

		.statement-table {
			width: 100%;
			border-collapse: collapse;
			margin: 20px 0;
		}

		.statement-table th {
			background: #f1f5f9;
			color: #475569;
			padding: 12px;
			border: 1px solid #e2e8f0;
			text-transform: none;
			font-size: 0.9rem;
		}

		.statement-table td {
			padding: 12px;
			border: 1px solid #e2e8f0;
			color: #1e293b;
		}


		.statement-footer {
			background: var(--primary);
			color: #0f172a;
			padding: 20px;
			border-radius: 8px;
			margin-top: 40px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.statement-signatures {
			margin-top: 50px;
			display: flex;
			justify-content: space-between;
		}

		.signature-box {
			text-align: center;
			width: 200px;
		}

		.btn-print {
			background: #1e293b;
			color: white;
			padding: 10px 20px;
			border-radius: 8px;
			border: none;
			cursor: pointer;
			margin-top: 20px;
			font-weight: 600;
		}

		/* Professional Print Styles for Statement */
		@media print {
			@page {
				size: A4 portrait;
				margin: 15mm;
			}

			body * {
				visibility: hidden;
			}

			#statementModal,
			#statementModal * {
				visibility: visible;
			}

			#statementModal {
				position: absolute;
				left: 0;
				top: 0;
				width: 100%;
				background: white !important;
				padding: 0 !important;
				margin: 0 !important;
				display: block !important;
			}

			.modal-content {
				box-shadow: none !important;
				border: none !important;
				width: 100% !important;
				max-width: none !important;
				margin: 0 !important;
				padding: 0 !important;
				background: white !important;
			}

			.statement-paper {
				padding: 0 !important;
				box-shadow: none !important;
				width: 100% !important;
			}


			.statement-table th {
				background: #f1f5f9 !important;
				-webkit-print-color-adjust: exact;
				print-color-adjust: exact;
			}

			.btn-print,
			.btn,
			.close-modal,
			.header,
			.stats-grid,
			.tabs,
			.section,
			#floating-menu,
			#chatbot-widget {
				display: none !important;
			}

			#statementModal .btn,
			#statementModal .btn-print,
			#statementModal .close-modal {
				display: none !important;
			}
		}

		.header-actions {
			display: flex;
			gap: 15px;
			align-items: center;
			flex-wrap: wrap;
			justify-content: flex-end;
		}

		.date-filter-group {
			display: flex;
			gap: 10px;
			align-items: center;
			background: rgba(var(--primary-rgb), 0.05);
			/* Use a slight tint of primary */
			padding: 8px 15px;
			border-radius: 16px;
			border: 1px solid var(--glass-border);
		}

		.filter-item {
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.filter-item span {
			font-size: 0.75rem;
			font-weight: 800;
			color: var(--text-muted);
			letter-spacing: 0.5px;
		}

		.filter-item input[type="date"] {
			padding: 6px 10px;
			font-size: 0.9rem;
			width: auto;
			height: 38px;
			border-radius: 10px;
			background: var(--card-bg) !important;
			border: 1px solid var(--glass-border) !important;
			cursor: pointer;
		}

		@media (max-width: 768px) {
			.header-actions {
				width: 100%;
				flex-direction: column;
				gap: 12px;
			}

			.date-filter-group {
				width: 100%;
				flex-direction: column;
				align-items: stretch;
				gap: 12px;
				padding: 15px;
			}

			.filter-item {
				width: 100%;
				flex-direction: row;
				justify-content: space-between;
				align-items: center;
				gap: 10px;
			}

			.filter-item span {
				min-width: 40px;
				font-size: 0.75rem;
			}

			.filter-item input[type="date"] {
				flex: 1;
				width: auto;
				min-width: 0;
				font-size: 0.9rem;
			}

			.home-btn {
				width: 100%;
				justify-content: center;
			}
		}
	</style>
</head>

<body>

	<div id="loader" class="loader">
		<div class="spinner"></div>
	</div>
	<div id="toast">Th√¥ng b√°o</div>

	<div class="container">
		<!-- Header -->
		<div class="header">
			<div class="header-title">
				<h1>üìä Qu·∫£n L√Ω C√¥ng N·ª£</h1>
				<p>Theo d√µi s·ªë d∆∞ v√† l·ªãch s·ª≠ thanh to√°n c·ªßa kh√°ch h√†ng</p>
			</div>
			<div class="header-actions">
				<div class="date-filter-group">
					<div class="filter-item">
						<span>T·ª™</span>
						<input type="date" id="filterFromDate" onchange="runFilters()">
					</div>
					<div class="filter-item">
						<span>ƒê·∫æN</span>
						<input type="date" id="filterToDate" onchange="runFilters()">
					</div>
				</div>
				<a href="index.html" class="btn btn-glass home-btn">
					<i class="fa-solid fa-house"></i> Trang ch·ªß
				</a>
			</div>
		</div>

		<!-- Stats -->
		<div class="stats-grid">
			<div class="stat-card">
				<div class="stat-header-row">
					<i class="fa-solid fa-file-invoice-dollar" style="color: var(--danger); font-size: 1.2rem;"></i>
					<span class="stat-label">T·ªïng n·ª£ ch∆∞a thu</span>
				</div>
				<span class="stat-value danger" id="statTotalDebt">0 ƒë</span>
			</div>
			<div class="stat-card">
				<div class="stat-header-row">
					<i class="fa-solid fa-money-bill-trend-up" style="color: var(--success); font-size: 1.2rem;"></i>
					<span class="stat-label">T·ªïng ti·ªÅn ƒë√£ thu</span>
				</div>
				<span class="stat-value success" id="statTotalPaid">0 ƒë</span>
			</div>
			<div class="stat-card">
				<div class="stat-header-row">
					<i class="fa-solid fa-users" style="color: var(--primary); font-size: 1.2rem;"></i>
					<span class="stat-label">S·ªë kh√°ch h√†ng c√≤n n·ª£</span>
				</div>
				<span class="stat-value" id="statCustomerCount">0</span>
			</div>
		</div>

		<!-- Tabs -->
		<div class="tabs">
			<button class="tab-btn active" onclick="switchTab('orders')">üì¶ Danh s√°ch ƒë∆°n ch·ªët</button>
			<button class="tab-btn" onclick="switchTab('payment')">üí∞ Nh·∫≠p thanh to√°n</button>
			<button class="tab-btn" onclick="switchTab('history')">üìú L·ªãch s·ª≠ thanh to√°n</button>
			<button class="tab-btn" onclick="switchTab('summary')">üèÅ C√¥ng n·ª£ c√≤n l·∫°i</button>
		</div>

		<!-- SECTION: ORDERS -->
		<div id="section-orders" class="section active">
			<div class="table-container">
				<table>
					<thead>
						<tr>
							<th>Ng√†y l√™n ƒë∆°n</th>
							<th>Kh√°ch h√†ng</th>
							<th>M√£ ƒë∆°n h√†ng</th>
							<th>Gi√° tr·ªã ƒë∆°n</th>
						</tr>
					</thead>
					<tbody id="ordersTableBody"></tbody>
				</table>
			</div>
		</div>

		<!-- SECTION: PAYMENT HISTORY -->
		<div id="section-history" class="section">
			<div class="table-container">
				<table>
					<thead>
						<tr>
							<th>Ng√†y thu</th>
							<th>Kh√°ch h√†ng</th>
							<th>S·ªë ti·ªÅn tr·∫£</th>
							<th>Ghi ch√∫</th>
							<th>B·∫±ng ch·ª©ng</th>
							<th style="width: 50px;"></th>
						</tr>
					</thead>
					<tbody id="historyListTableBody"></tbody>
				</table>
			</div>
		</div>

		<!-- SECTION: SUMMARY (THE NEW TAB 4) -->
		<div id="section-summary" class="section">
			<div class="table-container">
				<table>
					<thead>
						<tr>
							<th>Kh√°ch H√†ng</th>
							<th>T·ªïng N·ª£ ƒê∆°n</th>
							<th>T·ªïng ƒê√£ Tr·∫£</th>
							<th>C√¥ng n·ª£ c√≤n l·∫°i</th>
							<th>Phi·∫øu b√°o</th>
							<th>G·ª≠i Mail</th>
						</tr>
					</thead>
					<tbody id="summaryTableBody"></tbody>
				</table>
			</div>
		</div>

		<!-- SECTION: PAYMENT FORM -->
		<div id="section-payment" class="section">
			<div class="payment-form">
				<h3 style="margin-bottom: 25px; color: var(--primary);">üì• Phi·∫øu Thu Ti·ªÅn</h3>
				<form id="paymentForm">
					<div class="form-group">
						<label>M√£ phi·∫øu thu (T·ª± ƒë·ªông)</label>
						<input type="text" id="payIdDisp" readonly
							style="opacity: 0.7; cursor: not-allowed; background: var(--bg-dark);">
					</div>
					<div class="form-group" style="position: relative;">
						<label>Ch·ªçn Kh√°ch H√†ng *</label>
						<input type="text" id="custSearch" placeholder="üîç Nh·∫≠p t√™n ho·∫∑c t√¨m kh√°ch h√†ng..."
							autocomplete="off" oninput="filterCustomers()" onfocus="filterCustomers()" required>
						<input type="hidden" id="selectedCustId">
						<input type="hidden" id="selectedCustName">
						<div id="custSuggestions" class="suggestions-list"></div>
					</div>
					<div class="form-group" id="custEmailBox" style="display:none">
						<label>Email kh√°ch h√†ng (T·ª± ƒë·ªông)</label>
						<input type="text" id="custEmailDisp" readonly
							style="opacity: 0.7; cursor: not-allowed; background: var(--bg-dark);">
					</div>
					<div class="form-group" id="custDebtInfo"
						style="display: none; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 12px; margin-bottom: 20px;">
						<div style="display: flex; justify-content: space-between;">
							<span style="color: var(--text-muted);">D∆∞ n·ª£ hi·ªán t·∫°i:</span>
							<b id="lblCurrentDebt" style="color: var(--danger);">0 ƒë</b>
						</div>
					</div>
					<div class="form-group">
						<label>S·ªë ti·ªÅn thanh to√°n (VNƒê) *</label>
						<input type="number" id="payAmount" placeholder="Nh·∫≠p s·ªë ti·ªÅn..." required>
					</div>
					<div class="form-group">
						<label>B·∫±ng ch·ª©ng thanh to√°n (·∫¢nh l·ªánh chuy·ªÉn/H√≥a ƒë∆°n)</label>
						<div class="file-upload" onclick="document.getElementById('fileInput').click()">
							<div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
							<p id="uploadText" style="color: var(--text-muted); margin-top: 10px;">Nh·∫•p ƒë·ªÉ t·∫£i ·∫£nh l√™n
							</p>
							<img id="previewImg" alt="Preview">
						</div>
						<input type="file" id="fileInput" hidden accept="image/*" onchange="handleFile(event)">
					</div>
					<div class="form-group">
						<label>Ghi ch√∫</label>
						<textarea id="payNote" rows="3" placeholder="N·ªôi dung thanh to√°n..."></textarea>
					</div>
					<div class="form-group"
						style="display: flex; align-items: center; justify-content: space-between; background: var(--bg-dark); padding: 12px 15px; border-radius: 12px; margin-bottom: 25px;">
						<div style="display: flex; flex-direction: column;">
							<b style="font-size: 0.9rem;">G·ª≠i th√¥ng b√°o Email</b>
							<span style="color: var(--text-muted); font-size: 0.75rem;">G·ª≠i x√°c nh·∫≠n thanh to√°n cho
								kh√°ch</span>
						</div>
						<label class="switch">
							<input type="checkbox" id="notifyToggle" checked>
							<span class="slider"></span>
						</label>
					</div>
					<button type="submit" class="btn btn-primary" style="width: 100%; padding: 16px;">
						<i class="fas fa-save"></i> L∆ØU PHI·∫æU THU
					</button>
				</form>
			</div>
		</div>
	</div>

	<!-- Modal History (Payment Detail) -->
	<div id="historyModal" class="modal">
		<div class="modal-content">
			<span class="close-modal" onclick="closeModal()">&times;</span>
			<h2 id="modalTitle" style="margin-bottom: 20px;">Chi ti·∫øt thanh to√°n</h2>
			<div id="paymentDetailContent"></div>
		</div>
	</div>

	<!-- Modal Professional Statement -->
	<div id="statementModal" class="modal">
		<div class="modal-content" style="max-width: 900px; background: #f8fafc;">
			<span class="close-modal" onclick="closeModal()">&times;</span>
			<div id="statementSheet">
				<!-- Content generated by JS -->
			</div>
			<div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
				<button class="btn-print" onclick="window.print()"><i class="fas fa-print"></i> In b√°o c√°o</button>
				<button class="btn" style="background: #94a3b8; color: white; margin-top: 20px;"
					onclick="closeModal()">ƒê√≥ng</button>
			</div>
		</div>
	</div>

	<script src="security-utils.js"></script>
	<script>
		const DEBT_URL = 'https://script.google.com/macros/s/AKfycbz6PRwKYaCcIEXcEHiFnWz9JFMeJ2aZZ8H8tJZMSTdDdca2cgG8ztuxAcLjHCdhWccU/exec';
		const CUST_URL = 'https://script.google.com/macros/s/AKfycby_Uduzhl4k6aVfQEcgRr7XV3Vz-xJSIHIuQ4sD50I8Y0662wEHcWHgQMGJ2IaRgeNL5w/exec';

		// currentUser already defined in head script
		let debtData = { summary: [], orders: [], payments: [] };
		let filteredData = { summary: [], orders: [], payments: [] };
		let customersLookup = [];
		let selectedFileBase64 = null;
		let selectedFileType = null;

		function setDateDefaults() {
			const now = new Date();
			const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
			document.getElementById('filterFromDate').value = firstDay.toISOString().split('T')[0];
			document.getElementById('filterToDate').value = now.toISOString().split('T')[0];
		}

		function parseVietDate(str) {
			if (!str) return null;
			// Format: HH:mm:ss dd/MM/yyyy or dd/MM/yyyy
			const parts = str.split(' ');
			const datePart = parts.length > 1 ? parts[1] : parts[0];
			const [d, m, y] = datePart.split('/').map(Number);
			return new Date(y, m - 1, d);
		}

		function runFilters() {
			const fromStr = document.getElementById('filterFromDate').value;
			const toStr = document.getElementById('filterToDate').value;

			const fromDate = fromStr ? new Date(fromStr) : null;
			const toDate = toStr ? new Date(toStr) : null;
			if (fromDate) fromDate.setHours(0, 0, 0, 0);
			if (toDate) toDate.setHours(23, 59, 59, 999);

			// 1. L·ªçc Danh s√°ch ƒê∆°n v√† Thanh to√°n (Transaction Logs)
			filteredData.orders = (debtData.orders || []).filter(o => {
				const d = parseVietDate(o.ngay_len_don);
				if (!d) return true;
				return (!fromDate || d >= fromDate) && (!toDate || d <= toDate);
			});

			filteredData.payments = (debtData.payments || []).filter(p => {
				const d = parseVietDate(p.date);
				if (!d) return true;
				return (!fromDate || d >= fromDate) && (!toDate || d <= toDate);
			});

			// 2. X√¢y d·ª±ng Summary: Hi·ªÉn th·ªã nh·ªØng ng∆∞·ªùi C√ì HO·∫†T ƒê·ªòNG TRONG K·ª≤ ho·∫∑c ƒêANG C√íN N·ª¢
			const activeIds = new Set();

			// Th√™m nh·ªØng ng∆∞·ªùi c√≥ giao d·ªãch trong k·ª≥
			filteredData.orders.forEach(o => {
				const sItem = (debtData.summary || []).find(s => s.customerName.toUpperCase() === o.ten_khach_hang.toUpperCase());
				if (sItem) activeIds.add(sItem.customerId);
			});
			filteredData.payments.forEach(p => activeIds.add(p.customerId));

			// Th√™m nh·ªØng ng∆∞·ªùi ƒêANG C√íN N·ª¢ th·ª±c t·∫ø (D√π kh√¥ng c√≥ ho·∫°t ƒë·ªông trong k·ª≥ l·ªçc)
			(debtData.summary || []).forEach(s => {
				if (Math.abs(parseFloat(s.remaining)) > 100) { // N·ª£ > 100ƒë th√¨ hi·ªán
					activeIds.add(s.customerId);
				}
			});

			filteredData.summary = Array.from(activeIds).map(id => {
				const base = (debtData.summary || []).find(s => s.customerId === id);

				// T√≠nh to√°n s·ªë li·ªáu ph√°t sinh trong k·ª≥ ƒë·ªÉ hi·ªÉn th·ªã (N·∫øu mu·ªën)
				// ·ªû ƒë√¢y ch√∫ng ta v·∫´n d√πng 'remaining' l√† T·ªîNG N·ª¢ TH·ª∞C T·∫æ CU·ªêI C√ôNG
				return {
					customerId: id,
					customerName: base ? base.customerName : "Kh√°ch h√†ng " + id,
					totalDebt: base ? base.totalDebt : 0,
					paid: base ? base.paid : 0,
					remaining: base ? base.remaining : 0
				};
			}).sort((a, b) => b.remaining - a.remaining);

			renderAllTabs();
			updateStats();
		}

		async function init() {
			if (!currentUser) {
				window.location.href = 'auth.html';
				return;
			}

			setDateDefaults();
			refreshPermissions(); // Sync with server for real-time updates

			document.getElementById('payIdDisp').value = 'PAY-' + new Date().getTime();

			showLoader(true);
			await loadDebtReport(); // loadDebtReport will now handle both

			showLoader(false);
		}

		async function refreshPermissions() {
			const AUTH_URL = 'https://script.google.com/macros/s/AKfycbyaz_6xI3Nz0FHnNgr9qEcPuOUGf4OY53l8x1ofSoh_LIGozbKmpSJNAwpq8U6ygpPNHw/exec';
			try {
				const res = await fetch(AUTH_URL, {
					method: 'POST',
					body: SecurityProvider.prepareRequest('get_permissions', {
						roleId: currentUser.roleId,
						adminEmail: currentUser.adminEmail || currentUser.email
					})
				});
				const data = await res.json();
				if (data.success && data.permissions) {
					localStorage.setItem('permissions', JSON.stringify(data.permissions));
					renderSummary(); // Re-render to show/hide email button
				}
			} catch (e) { console.error("Sync perms error", e); }
		}



		async function loadDebtReport() {
			try {
				const [resDebt, resCust] = await Promise.all([
					fetch(DEBT_URL, {
						method: 'POST',
						body: SecurityProvider.prepareRequest('get_debt_report', { adminEmail: currentUser.adminEmail || currentUser.email })
					}),
					fetch(CUST_URL, {
						method: 'POST',
						body: SecurityProvider.prepareRequest('get_initial_data', { salesId: currentUser.email, adminEmail: currentUser.adminEmail || currentUser.email })
					})
				]);

				const debtDataRes = await resDebt.json();
				const custDataRes = await resCust.json();

				if (debtDataRes.success) {
					debtData = debtDataRes;
					runFilters();
				} else {
					console.error("Failed to load debt report:", debtDataRes.message);
				}

				if (custDataRes.success) {
					customersLookup = custDataRes.customers;
				} else {
					console.error("Failed to load customers:", custDataRes.message);
				}

			} catch (e) { console.error("Load debt error", e); }
		}

		// Removed loadInitialData function as its logic is now merged into loadDebtReport

		function renderAllTabs() {
			renderOrders();
			renderHistoryList();
			renderSummary();
		}

		function renderOrders() {
			const tbody = document.getElementById('ordersTableBody');
			const list = filteredData.orders || [];
			if (list.length === 0) {
				tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 40px; color: var(--text-muted);">Kh√¥ng c√≥ ƒë∆°n h√†ng ch·ªët</td></tr>';
				return;
			}
			tbody.innerHTML = list.map(o => `
				<tr>
					<td data-label="Ng√†y">${o.ngay_len_don}</td>
					<td data-label="Kh√°ch h√†ng" class="cust-name">${o.ten_khach_hang}</td>
					<td data-label="M√£ ƒë∆°n" style="color: var(--accent-purple); font-weight: 600;">${o.id_don_hang}</td>
					<td data-label="Gi√° tr·ªã" class="amount debt">${formatCurrency(o.so_tien_con_lai)}</td>
				</tr>
			`).join('');
		}

		function renderHistoryList() {
			const tbody = document.getElementById('historyListTableBody');
			const list = filteredData.payments || [];
			if (list.length === 0) {
				tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px; color: var(--text-muted);">Ch∆∞a c√≥ l·ªãch s·ª≠ thanh to√°n</td></tr>';
				return;
			}
			tbody.innerHTML = list.map(p => `
				<tr>
					<td data-label="Ng√†y thu" style="font-size: 0.8rem;">${p.date}</td>
					<td data-label="Kh√°ch h√†ng" class="cust-name">${p.customerName}</td>
					<td data-label="S·ªë ti·ªÅn tr·∫£" class="amount">${formatCurrency(p.amount)}</td>
					<td data-label="Ghi ch√∫" style="font-size: 0.85rem; color: var(--text-muted);">${p.note || ''}</td>
					<td data-label="B·∫±ng ch·ª©ng">
						${p.imageUrl ? `<a href="${p.imageUrl}" target="_blank" style="color: var(--primary);"><i class="fas fa-image"></i> Xem</a>` : 'Kh√¥ng c√≥'}
					</td>
					<td data-label="Thao t√°c">
						<button class="btn-remove" onclick="confirmDeletePayment('${p.id}')" title="X√≥a phi·∫øu thu">
							<i class="fas fa-trash-alt"></i>
						</button>
					</td>
				</tr>
			`).join('');
		}

		function renderSummary() {
			const tbody = document.getElementById('summaryTableBody');
			const list = filteredData.summary || [];

			if (list.length === 0) {
				tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 40px; color: var(--text-muted);">Kh√¥ng c√≥ d·ªØ li·ªáu t·ªïng h·ª£p</td></tr>';
				return;
			}
			tbody.innerHTML = list.map(d => `
                <tr>
                    <td data-label="Kh√°ch H√†ng">
						<div class="cust-name">${d.customerName}</div>
						<div style="font-size: 0.75rem; color: var(--text-muted);">${d.customerId}</div>
					</td>
                    <td data-label="T·ªïng N·ª£ ƒê∆°n">${formatCurrency(d.totalDebt)}</td>
                    <td data-label="T·ªïng ƒê√£ Tr·∫£"><span style="color: var(--success); font-weight: 600;">${formatCurrency(d.paid)}</span></td>
                    <td data-label="C√¥ng n·ª£ c√≤n l·∫°i"><span class="amount ${d.remaining > 0 ? 'debt' : ''}">${formatCurrency(d.remaining)}</span></td>
                    <td data-label="Phi·∫øu b√°o">
                        <button class="history-btn" onclick="showStatement('${d.customerId}')">
                            <i class="fas fa-file-invoice-dollar"></i> Xu·∫•t phi·∫øu
                        </button>
                    </td>
					<td data-label="G·ª≠i Mail">
						<button class="btn-mail" onclick="sendStatementEmail('${d.customerId}')" style="margin-bottom: 5px;">
							<i class="fas fa-paper-plane"></i> G·ª≠i Mail
						</button>
						<button class="btn-mail" onclick="sendStatementEmail('${d.customerId}', true)" style="background: #f59e0b; border-color: #d97706;">
							<i class="fas fa-vial"></i> G·ª≠i Th·ª≠
						</button>
					</td>
                </tr>
            `).join('');
		}

		async function sendStatementEmail(custId, isTest = false) {
			const d = debtData.summary.find(s => s.customerId === custId);
			if (!d) return;

			const msg = isTest
				? `B·∫°n mu·ªën g·ª≠i TH·ª¨ phi·∫øu b√°o c√¥ng n·ª£ c·ªßa ${d.customerName} ƒë·∫øn email c·ªßa b·∫°n (${currentUser.email}) ƒë·ªÉ xem tr∆∞·ªõc?`
				: `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën g·ª≠i Phi·∫øu b√°o c√¥ng n·ª£ t·ª± ƒë·ªông ƒë·∫øn kh√°ch h√†ng ${d.customerName} kh√¥ng?`;

			if (!confirm(msg)) return;

			showLoader(true);
			try {
				const payload = {
					action: 'send_statement_email',
					customerId: custId,
					adminEmail: currentUser.adminEmail || currentUser.email,
					fromDate: document.getElementById('filterFromDate').value,
					toDate: document.getElementById('filterToDate').value
				};
				if (isTest) payload.testEmail = currentUser.email;

				const res = await fetch(DEBT_URL, {
					method: 'POST',
					body: SecurityProvider.prepareRequest('send_statement_email', payload)
				});
				const data = await res.json();
				if (data.success) {
					showToast(data.message);
				} else {
					showToast(data.message, true);
				}
			} catch (e) {
				showToast("L·ªói g·ª≠i mail h·ªá th·ªëng", true);
			} finally {
				showLoader(false);
			}
		}

		function updateStats() {
			// Red and Yellow cards -> Always Global (To see realistic outstanding debt)
			const globalList = debtData.summary || [];
			const globalDebt = globalList.reduce((s, d) => s + (parseFloat(d.remaining) > 0 ? parseFloat(d.remaining) : 0), 0);
			const globalCount = globalList.filter(d => parseFloat(d.remaining) > 100).length;

			// Green card -> Period-specific (To see cash flow collected in time range)
			const periodPayments = filteredData.payments || [];
			const periodPaid = periodPayments.reduce((s, p) => s + (parseFloat(p.amount) || 0), 0);

			document.getElementById('statTotalDebt').innerText = formatCurrency(globalDebt);
			document.getElementById('statTotalPaid').innerText = formatCurrency(periodPaid);
			document.getElementById('statCustomerCount').innerText = globalCount;
		}

		function filterCustomers() {
			const input = document.getElementById('custSearch');
			const val = input.value.toLowerCase().trim();
			const suggestions = document.getElementById('custSuggestions');
			const hiddenId = document.getElementById('selectedCustId');

			if (!val) {
				hiddenId.value = "";
				suggestions.style.display = 'none';
				return;
			}

			const filtered = customersLookup.filter(c =>
				c.name.toLowerCase().includes(val) ||
				(c.phone && c.phone.includes(val)) ||
				(c.id && c.id.toString().toLowerCase().includes(val))
			).slice(0, 10);

			if (filtered.length > 0) {
				suggestions.innerHTML = filtered.map(c => `
					<div class="suggestion-item" onclick="selectCustomer('${c.id}', '${c.name.replace(/'/g, "\\'")}')">
						<span style="font-weight: 600;">${c.name}</span>
						<span class="sub-info">${c.id} ${c.phone ? ' - ' + c.phone : ''}</span>
					</div>
				`).join('');
				suggestions.style.display = 'block';
			} else {
				suggestions.style.display = 'none';
			}
		}

		function selectCustomer(id, name) {
			document.getElementById('custSearch').value = name;
			document.getElementById('selectedCustId').value = id;
			document.getElementById('selectedCustName').value = name;
			document.getElementById('custSuggestions').style.display = 'none';
			updateSelectedCustomerInfo();
		}

		document.addEventListener('click', (e) => {
			if (!e.target.closest('.form-group')) {
				const suggestions = document.getElementById('custSuggestions');
				if (suggestions) suggestions.style.display = 'none';
			}
		});

		function updateSelectedCustomerInfo() {
			const cId = document.getElementById('selectedCustId').value;
			const infoBox = document.getElementById('custDebtInfo');
			const emailBox = document.getElementById('custEmailBox');
			const emailDisp = document.getElementById('custEmailDisp');

			const item = (debtData.summary || []).find(d => d.customerId === cId);
			const custObj = customersLookup.find(c => c.id === cId);

			if (item) {
				infoBox.style.display = 'block';
				document.getElementById('lblCurrentDebt').innerText = formatCurrency(item.remaining);
			} else {
				infoBox.style.display = 'none';
			}

			if (custObj && custObj.email) {
				emailBox.style.display = 'block';
				emailDisp.value = custObj.email;
			} else {
				emailBox.style.display = 'none';
				emailDisp.value = '';
			}
		}

		document.getElementById('paymentForm').onsubmit = async (e) => {
			e.preventDefault();
			const cId = document.getElementById('selectedCustId').value;
			const cName = document.getElementById('selectedCustName').value;
			const amount = document.getElementById('payAmount').value;
			const note = document.getElementById('payNote').value;
			const notify = document.getElementById('notifyToggle').checked;

			if (!cId) {
				showToast("Vui l√≤ng ch·ªçn kh√°ch h√†ng!", true);
				return;
			}

			const custObj = customersLookup.find(c => c.id === cId);

			showLoader(true);
			try {
				const payload = {
					action: 'save_payment',
					customerId: cId,
					customerName: cName,
					customerEmail: custObj ? (custObj.email || "") : "",
					amount: amount,
					note: note,
					evidenceImage: selectedFileBase64 ? { base64: selectedFileBase64, type: selectedFileType } : null,
					userEmail: currentUser.email,
					adminEmail: currentUser.adminEmail || currentUser.email,
					managingAdminEmail: (currentUser.roleId === 'R001') ? currentUser.email : (currentUser.adminEmail || currentUser.email),
					sendEmail: notify
				};

				const res = await fetch(DEBT_URL, {
					method: 'POST',
					body: SecurityProvider.prepareRequest('save_payment', payload)
				});
				const data = await res.json();

				if (data.success) {
					const emailMsg = (data.emailSentTo && data.emailSentTo.includes('@'))
						? ` (ƒê√£ g·ª≠i mail ƒë·∫øn: ${data.emailSentTo})`
						: ' (C·∫£nh b√°o: Kh√¥ng t√¨m th·∫•y email kh√°ch)';
					showToast("ƒê√£ l∆∞u phi·∫øu thu th√†nh c√¥ng!" + emailMsg);
					e.target.reset();
					resetUpload();
					document.getElementById('payIdDisp').value = 'PAY-' + new Date().getTime();
					await loadDebtReport();
					switchTab('history');
				} else {
					showToast(data.message, true);
				}
			} catch (err) {
				showToast("L·ªói k·∫øt n·ªëi m√°y ch·ªß", true);
			} finally {
				showLoader(false);
			}
		};

		function showStatement(custId) {
			const d = filteredData.summary.find(s => s.customerId === custId);
			if (!d) return;

			const fromStr = document.getElementById('filterFromDate').value;
			const fromDate = fromStr ? new Date(fromStr) : null;
			if (fromDate) fromDate.setHours(0, 0, 0, 0);

			const orders = (filteredData.orders || []).filter(o => o.ten_khach_hang === d.customerName);
			const payments = (filteredData.payments || []).filter(p => p.customerId === custId);

			// T√çNH TO√ÅN D∆Ø N·ª¢ ƒê·∫¶U K·ª≤ (Tr∆∞·ªõc FromDate)
			let openingDebt = 0;
			let openingPaid = 0;
			if (fromDate) {
				const preOrders = (debtData.orders || []).filter(o => {
					const dObj = parseVietDate(o.ngay_len_don);
					return o.ten_khach_hang === d.customerName && dObj && dObj < fromDate;
				});
				const prePayments = (debtData.payments || []).filter(p => {
					const dObj = parseVietDate(p.date);
					return p.customerId === custId && dObj && dObj < fromDate;
				});
				openingDebt = preOrders.reduce((s, o) => s + (parseFloat(o.so_tien_con_lai) || 0), 0);
				openingPaid = prePayments.reduce((s, p) => s + (parseFloat(p.amount) || 0), 0);
			}
			const openingBalance = openingDebt - openingPaid;

			// T√çNH TO√ÅN L·∫†I T·ªîNG D·ª∞A TR√äN DANH S√ÅCH TH·ª∞C T·∫æ TR√äN PHI·∫æU
			const periodOrderAmount = orders.reduce((s, o) => s + (parseFloat(o.so_tien_con_lai) || 0), 0);
			const periodPaidAmount = payments.reduce((s, p) => s + (parseFloat(p.amount) || 0), 0);
			const totalOrderAmountWithOpening = openingBalance + periodOrderAmount;
			const remainingBalance = totalOrderAmountWithOpening - periodPaidAmount;

			const modal = document.getElementById('statementModal');
			const content = document.getElementById('statementSheet');

			content.innerHTML = `
				<div class="statement-paper">
					<div class="statement-header">
						<div>
							<h2 style="color: var(--primary); margin:0;">PHI·∫æU B√ÅO C√îNG N·ª¢</h2>
							<p style="color: #64748b; font-size: 0.9rem;">H·ªá th·ªëng qu·∫£n l√Ω Dunvex Digital</p>
						</div>
						<div style="text-align: right;">
							<p><b>Ng√†y b√°o:</b> ${new Date().toLocaleDateString('vi-VN')}</p>
							<p><b>M√£ KH:</b> ${d.customerId}</p>
						</div>
					</div>
					
					<div style="margin-bottom: 30px;">
						<p><b>K√≠nh g·ª≠i:</b> ${d.customerName}</p>
						<p>Ch√∫ng t√¥i xin th√¥ng b√°o t√¨nh tr·∫°ng c√¥ng n·ª£ t√≠nh ƒë·∫øn hi·ªán t·∫°i nh∆∞ sau:</p>
					</div>

					<h4 style="border-left: 4px solid var(--primary); padding-left: 10px; margin-bottom: 10px;">1. Danh s√°ch ƒë∆°n h√†ng</h4>
					<table class="statement-table">
						<thead>
							<tr>
								<th>Ng√†y</th>
								<th>M√£ ƒë∆°n</th>
								<th style="text-align: right;">Gi√° tr·ªã</th>
							</tr>
						</thead>
						<tbody>
							${openingBalance !== 0 ? `
								<tr style="background: rgba(250, 204, 21, 0.1); font-weight: 700;">
									<td>${fromStr ? fromStr.split('-').reverse().join('/') : ''}</td>
									<td>D∆Ø N·ª¢ ƒê·∫¶U K·ª≤</td>
									<td style="text-align: right;">${formatCurrency(openingBalance)}</td>
								</tr>
							` : ''}
							${orders.map(o => `
								<tr>
									<td>${o.ngay_len_don.split(' ')[1] || o.ngay_len_don}</td>
									<td>${o.id_don_hang}</td>
									<td style="text-align: right;">${formatCurrency(o.so_tien_con_lai)}</td>
								</tr>
							`).join('') || (openingBalance === 0 ? '<tr><td colspan="3" style="text-align:center;">Kh√¥ng c√≥ ƒë∆°n h√†ng n·ª£ trong k·ª≥</td></tr>' : '')}
							<tr style="background: #f8fafc; font-weight: 800;">
								<td colspan="2">T·ªîNG C·ªòNG (ƒê·∫¶U K·ª≤ + PH√ÅT SINH)</td>
								<td style="text-align: right; color: var(--danger); font-size: 1.1rem;">${formatCurrency(totalOrderAmountWithOpening)}</td>
							</tr>
						</tbody>
					</table>

					<h4 style="border-left: 4px solid var(--success); padding-left: 10px; margin-top: 30px; margin-bottom: 10px;">2. L·ªãch s·ª≠ ƒë√£ thanh to√°n</h4>
					<table class="statement-table">
						<thead>
							<tr>
								<th>Ng√†y</th>
								<th>N·ªôi dung</th>
								<th style="text-align: right;">S·ªë ti·ªÅn</th>
							</tr>
						</thead>
						<tbody>
							${payments.map(p => `
								<tr>
									<td>${safeFormatDate(p.date)}</td>
									<td>${p.note || 'Thanh to√°n c√¥ng n·ª£'}</td>
									<td style="text-align: right; color: var(--success);">${formatCurrency(p.amount)}</td>
								</tr>
							`).join('') || '<tr><td colspan="3" style="text-align:center;">Ch∆∞a c√≥ d·ªØ li·ªáu thanh to√°n</td></tr>'}
							<tr style="background: #f8fafc; font-weight: 800;">
								<td colspan="2">T·ªîNG ƒê√É THANH TO√ÅN TRONG K·ª≤</td>
								<td style="text-align: right; color: var(--success); font-size: 1.1rem;">${formatCurrency(periodPaidAmount)}</td>
							</tr>
						</tbody>
					</table>

					<div class="statement-footer">
						<span style="font-size: 1.1rem; font-weight: 600;">S·ªê D∆Ø C√îNG N·ª¢ C√íN L·∫†I</span>
						<span style="font-size: 1.5rem; font-weight: 800;">${formatCurrency(remainingBalance)}</span>
					</div>
					<div class="statement-signatures">
						<div class="signature-box">
							<p><b>ƒê·∫°i di·ªán kh√°ch h√†ng</b></p>
							<p style="margin-top: 60px; color: #94a3b8; font-style: italic;">(K√Ω v√† ghi r√µ h·ªç t√™n)</p>
						</div>
						<div class="signature-box">
							<p><b>Ng∆∞·ªùi l·∫≠p phi·∫øu</b></p>
							<p style="margin-top: 60px;">${currentUser.fullName}</p>
						</div>
					</div>
				</div>
			`;
			modal.classList.add('active');

			// T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu gao v√πng ch·ª©a phi·∫øu sau khi scale (ƒë·ªÉ tr√°nh kho·∫£ng tr·∫Øng th·ª´a)
			setTimeout(() => {
				const paper = content.querySelector('.statement-paper');
				if (paper && window.innerWidth <= 768) {
					// Use offsetHeight (original height) * scale factor to get real visual height
					// This is more reliable than getBoundingClientRect for absolute items sometimes
					const style = window.getComputedStyle(paper);
					const matrix = new WebKitCSSMatrix(style.transform);
					const scale = matrix.a;
					const visualHeight = paper.offsetHeight * scale;
					content.style.height = (visualHeight + 40) + 'px'; // Add more buffer
				} else {
					content.style.height = 'auto';
				}
			}, 300); // Increase timeout for rendering
		}

		// Helper function to safely format date
		function safeFormatDate(dateStr) {
			if (!dateStr) return '';
			if (dateStr.includes('/')) return dateStr; // Already formatted DD/MM/YYYY
			const d = new Date(dateStr);
			return isNaN(d.getTime()) ? dateStr : d.toLocaleDateString('vi-VN');
		}

		function resetUpload() {
			selectedFileBase64 = null;
			selectedFileType = null;
			document.getElementById('previewImg').style.display = 'none';
			document.getElementById('uploadText').style.display = 'block';
			const icon = document.querySelector('.upload-icon');
			if (icon) icon.style.display = 'block';
		}

		function handleFile(e) {
			const file = e.target.files[0];
			if (!file) return;
			const reader = new FileReader();
			reader.onload = (event) => {
				selectedFileBase64 = event.target.result.split(',')[1];
				selectedFileType = file.type;
				const preview = document.getElementById('previewImg');
				const text = document.getElementById('uploadText');
				const icon = document.querySelector('.upload-icon');
				preview.src = event.target.result;
				preview.style.display = 'block';
				text.style.display = 'none';
				if (icon) icon.style.display = 'none';
			};
			reader.readAsDataURL(file);
		}

		function switchTab(tab) {
			document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
			const activeBtn = document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`);
			if (activeBtn) activeBtn.classList.add('active');

			document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
			const activeSection = document.getElementById(`section-${tab}`);
			if (activeSection) activeSection.classList.add('active');
		}

		function closeModal() {
			document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
		}

		async function confirmDeletePayment(id) {
			if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi thanh to√°n n√†y? S·ªë d∆∞ c√¥ng n·ª£ c·ªßa kh√°ch s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t l·∫°i.")) return;

			showLoader(true);
			try {
				const res = await fetch(DEBT_URL, {
					method: 'POST',
					body: SecurityProvider.prepareRequest('delete_payment', {
						paymentId: id,
						adminEmail: currentUser.adminEmail || currentUser.email
					})
				});
				const data = await res.json();
				if (data.success) {
					showToast("ƒê√£ x√≥a thanh to√°n th√†nh c√¥ng");
					await loadDebtReport();
				} else {
					showToast(data.message, true);
				}
			} catch (e) {
				showToast("L·ªói khi x√≥a d·ªØ li·ªáu", true);
			} finally {
				showLoader(false);
			}
		}

		function showLoader(show) {
			document.getElementById('loader').style.display = show ? 'flex' : 'none';
		}

		function showToast(msg, isError = false) {
			const t = document.getElementById('toast');
			if (!t) return;
			t.innerText = msg;
			t.style.background = isError ? 'var(--danger)' : 'var(--success)';
			t.classList.add('active');
			setTimeout(() => t.classList.remove('active'), 5000);
		}

		function formatCurrency(val) {
			return new Intl.NumberFormat('vi-VN').format(val || 0) + ' ƒë';
		}

		init();
	</script>
	<script src="chatbot.js"></script>
	<script src="floating-menu.js"></script>
</body>

</html>