/**
 * DUNVEX CHATBOT BACKEND (STANDALONE - STABLE VERSION)
 * Handles Chat Logic, History (JSON), and Gemini AI API.
 */

const CRM_SS_ID = '15niaoQ7FozkRCushPGNtq4zj6pwA0UQ5Wel61ksv8L8';
const DATA_FOLDER_ID = '1_LT4rzVui2E3BgfcwUSfMsUGQMN9NRTs'; 
const GEMINI_API_KEY = 'AIzaSyCteYtXxsWSEbV75aiGY-oKjpX1eINCR-w'; // New API Key

function doPost(e) {
  let result;
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;

    switch (action) {
      case 'chat': result = handleChatAction(data); break;
      case 'clearChat': result = handleClearChat(data); break;
      case 'getBotContext': result = getBotContext(data); break;
      case 'listModels': result = { success: true, models: listSupportedModels() }; break;
      default: result = { success: false, message: 'Invalid Action' };
    }
  } catch (error) {
    result = { success: false, message: 'Error: ' + error.toString() };
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

// --- CORE HANDLERS ---

function handleChatAction(data) {
  const userId = data.userId;
  const userMsg = data.message;
  const clientContext = data.context || ""; 

  if (!userId || !userMsg) return { success: false, message: "Missing data" };

  try {
    let historyData = getChatHistoryFromFile();
    let userHistory = historyData[userId] || [];

    userHistory.push({ role: "user", content: userMsg, timestamp: new Date().toISOString() });

    const botResponse = callGeminiAI(userMsg, userHistory, clientContext);

    userHistory.push({ role: "model", content: botResponse, timestamp: new Date().toISOString() });

    if (userHistory.length > 50) userHistory = userHistory.slice(userHistory.length - 50);
    historyData[userId] = userHistory;
    saveChatHistoryToFile(historyData);

    return { success: true, response: botResponse, history: userHistory };
  } catch (e) {
    return { success: false, message: "AI Error: " + e.toString() };
  }
}

function handleClearChat(data) {
  const userId = data.userId;
  try {
    let history = getChatHistoryFromFile();
    if (history[userId]) {
      delete history[userId];
      saveChatHistoryToFile(history);
    }
    return { success: true };
  } catch (e) { return { success: false, message: e.toString() }; }
}

function getBotContext(data) {
  const stats = {};
  const customerNames = {};
  try {
    const ss = SpreadsheetApp.openById(CRM_SS_ID);
    const sheetCust = ss.getSheetByName('data_khach_hang');
    if(sheetCust) {
      const rows = sheetCust.getDataRange().getValues();
      for (let i = 1; i < rows.length; i++) {
          customerNames[rows[i][0]] = rows[i][1];
      }
    }

    const folder = DriveApp.getFolderById(DATA_FOLDER_ID);
    const files = folder.getFilesByName('order.json');
    if (files.hasNext()) {
      const orders = JSON.parse(files.next().getBlob().getDataAsString());
      orders.forEach(o => {
        if (o.status !== 'DELETED') {
           if (!stats[o.customer_id]) {
             stats[o.customer_id] = { 
               id: o.customer_id,
               name: customerNames[o.customer_id] || "Khách lạ",
               totalOrders: 0, 
               totalRevenue: 0, 
               lastOrder: '' 
             };
           }
           stats[o.customer_id].totalOrders += 1;
           stats[o.customer_id].totalRevenue += (parseInt(o.grand_total) || 0);
           if (!stats[o.customer_id].lastOrder || new Date(o.created_at) > new Date(stats[o.customer_id].lastOrder)) {
             stats[o.customer_id].lastOrder = o.created_at;
           }
        }
      });
    }
  } catch (e) {}
  return { success: true, stats: stats };
}

// --- GEMINI API ENGINE (OPTIMIZED FOR V1BETA) ---

function callGeminiAI(currentMsg, history, context) {
  // Try v1beta first as it supports all newer models (Flash 1.5, 2.0, etc.)
  const versions = ['v1beta', 'v1'];
  const modelNames = [
    'gemini-1.5-flash',
    'gemini-1.5-flash-8b',
    'gemini-1.5-pro',
    'gemini-1.0-pro',
    'gemini-2.0-flash-exp'
  ];

  let errors = [];

  const contents = history.map(h => ({
    role: h.role,
    parts: [{ text: h.content }]
  }));

  if (contents.length > 0 && context) {
     contents[contents.length - 1].parts[0].text = `System: Sales Assistant Context: ${JSON.stringify(context)}\nUser Query: ${currentMsg}`;
  }
  
  const payload = { contents: contents };

  for (const ver of versions) {
    for (const model of modelNames) {
      try {
        const apiUrl = `https://generativelanguage.googleapis.com/${ver}/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
        const options = {
          method: 'post',
          contentType: 'application/json',
          payload: JSON.stringify(payload),
          muteHttpExceptions: true
        };

        const response = UrlFetchApp.fetch(apiUrl, options);
        const responseText = response.getContentText();
        const json = JSON.parse(responseText);

        if (json.candidates && json.candidates.length > 0) {
          return json.candidates[0].content.parts[0].text;
        } else if (json.error) {
           const msg = json.error.message;
           // If quota error, skip this model but log it
           if (msg.toLowerCase().includes("quota")) {
              errors.push(`[${model}@${ver}]: Hết lượt miễn phí (Quota Limit 0)`);
           } else if (msg.toLowerCase().includes("not found")) {
              // Ignore not found errors to keep logs clean, only care about real errors
           } else {
              errors.push(`[${model}@${ver}]: ${msg}`);
           }
        }
      } catch (e) {
        errors.push(`[${model}@${ver} Exc]: ${e.toString()}`);
      }
    }
  }

  return "Xin chào! Hiện tại Key API của bạn đang được Google quét và kích hoạt (thường mất 5-10 phút sau khi tạo). \n\nHoặc bạn hãy thử đổi sang model 'gemini-1.5-flash' trong AI Studio và tạo Key mới nếu lỗi này kéo dài.\n\nChi tiết lỗi: " + (errors.length > 0 ? errors.slice(0, 2).join(", ") : "Không tìm thấy model phù hợp trên cả v1 và v1beta.");
}

// --- DIAGNOSTICS ---
function listSupportedModels() {
  try {
    const url = `https://generativelanguage.googleapis.com/v1beta/models?key=${GEMINI_API_KEY}`;
    const response = UrlFetchApp.fetch(url, { muteHttpExceptions: true });
    return JSON.parse(response.getContentText());
  } catch (e) { return { error: e.toString() }; }
}

// --- FILE HELPERS ---
function getChatHistoryFromFile() {
  try {
    const folder = DriveApp.getFolderById(DATA_FOLDER_ID);
    const files = folder.getFilesByName('chat_history.json');
    if (files.hasNext()) return JSON.parse(files.next().getBlob().getDataAsString());
    return {};
  } catch (e) { return {}; }
}

function saveChatHistoryToFile(data) {
  try {
    const folder = DriveApp.getFolderById(DATA_FOLDER_ID);
    const files = folder.getFilesByName('chat_history.json');
    if (files.hasNext()) files.next().setContent(JSON.stringify(data, null, 2));
    else folder.createFile('chat_history.json', JSON.stringify(data, null, 2), MimeType.PLAIN_TEXT);
  } catch (e) {}
}
