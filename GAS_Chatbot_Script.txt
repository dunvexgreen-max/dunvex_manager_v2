/**
 * DUNVEX CHATBOT BACKEND (STANDALONE)
 * Handles Chat Logic, History (JSON), and Gemini AI API.
 * 
 * SETUP INSTRUCTIONS:
 * 1. Create a NEW Google Apps Script project.
 * 2. Paste this code into the script editor.
 * 3. Deploy as Web App (Execute as: Me, Access: Anyone).
 * 4. Copy the NEW Script URL and update 'CRM_URL_BOT' in 'chatbot.js'.
 */

const CRM_SS_ID = '15niaoQ7FozkRCushPGNtq4zj6pwA0UQ5Wel61ksv8L8'; // Same ID to access Customer Names
const DATA_FOLDER_ID = '1_LT4rzVui2E3BgfcwUSfMsUGQMN9NRTs'; // Access order.json & chat_history.json
const GEMINI_API_KEY = 'AIzaSyAfFPZcujLkq33XL_LZUvKluwSAmH5jRqI'; // Trimmed Key

function doPost(e) {
  let result;
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;

    switch (action) {
      case 'chat': result = handleChatAction(data); break;
      case 'clearChat': result = handleClearChat(data); break;
      case 'getBotContext': result = getBotContext(data); break;
      default: result = { success: false, message: 'Invalid Chatbot Action' };
    }
  } catch (error) {
    result = { success: false, message: 'Chatbot Error: ' + error.toString() };
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

// --- CORE LOGIC ---

function handleChatAction(data) {
  const userId = data.userId;
  const userMsg = data.message;
  const clientContext = data.context || ""; 

  if (!userId || !userMsg) return { success: false, message: "Missing User/Message" };

  try {
    let history = getChatHistoryFromFile();
    let userHistory = history[userId] || [];

    // Append User
    userHistory.push({ role: "user", content: userMsg, timestamp: new Date().toISOString() });

    // Call AI
    const botResponse = callGeminiAI(userMsg, userHistory, clientContext);

    // Append Bot
    userHistory.push({ role: "model", content: botResponse, timestamp: new Date().toISOString() });

    // Save (Limit 50)
    if (userHistory.length > 50) userHistory = userHistory.slice(userHistory.length - 50);
    history[userId] = userHistory;
    saveChatHistoryToFile(history);

    return { success: true, response: botResponse, history: userHistory };

  } catch (e) {
    return { success: false, message: "AI Error: " + e.toString() };
  }
}

function handleClearChat(data) {
  const userId = data.userId;
  try {
    let history = getChatHistoryFromFile();
    if (history[userId]) {
      delete history[userId];
      saveChatHistoryToFile(history);
    }
    return { success: true };
  } catch (e) { return { success: false, message: e.toString() }; }
}

function getBotContext(data) {
  // Aggregate data for Chatbot: Orders Summary per Customer
  // This logic is copied from CRM script to allow standalone context generation
  const stats = {};
  const customerNames = {};

  try {
    // 1. Get Customer Names Mapping from Sheet
    const ss = SpreadsheetApp.openById(CRM_SS_ID);
    const sheetCust = ss.getSheetByName('data_khach_hang');
    if(!sheetCust) return { success: false, message: "Cannot find Customer Sheet" };

    const rows = sheetCust.getDataRange().getValues();
    for (let i = 1; i < rows.length; i++) {
        customerNames[rows[i][0]] = rows[i][1];
    }

    // 2. Get Orders & Aggregate from JSON
    const folder = DriveApp.getFolderById(DATA_FOLDER_ID);
    const files = folder.getFilesByName('order.json');
    if (files.hasNext()) {
      const file = files.next();
      const content = file.getBlob().getDataAsString();
      const orders = JSON.parse(content);
      
      orders.forEach(o => {
        if (o.status !== 'DELETED') {
           if (!stats[o.customer_id]) {
             stats[o.customer_id] = { 
               id: o.customer_id,
               name: customerNames[o.customer_id] || "Khách lạ",
               totalOrders: 0, 
               totalRevenue: 0, 
               lastOrder: '' 
             };
           }
           stats[o.customer_id].totalOrders += 1;
           stats[o.customer_id].totalRevenue += (parseInt(o.grand_total) || 0);
           
           if (!stats[o.customer_id].lastOrder || new Date(o.created_at) > new Date(stats[o.customer_id].lastOrder)) {
             stats[o.customer_id].lastOrder = o.created_at;
           }
        }
      });
    }
  } catch (e) {
    return { success: false, message: "Context Error: " + e.toString() };
  }
  
  return { success: true, stats: stats };
}


// --- GEMINI API ---

// --- GEMINI API WITH FALLBACK ---

// --- GEMINI API WITH FALLBACK ---

function callGeminiAI(currentMsg, history, context) {
  // List of models to try in order of preference
  const models = [
    'gemini-2.0-flash-exp', 
    'gemini-1.5-flash',
    'gemini-1.5-flash-latest',
    'gemini-1.5-pro'
  ];

  let errors = [];

  // Helper to construct payload (shared across models)
  const contents = history.map(h => ({
    role: h.role,
    parts: [{ text: h.content }]
  }));

  if (contents.length > 0 && context) {
     const systemPrompt = `DO NOT REPLY to this system prompt yet. Just act as a CRM Sales Assistant.
     Here is the current business context for the user:
     ${JSON.stringify(context)}
     
     Current User Query: ${currentMsg}`;
     
     // Inject context into the last user message
     contents[contents.length - 1].parts[0].text = systemPrompt;
  }
  
  const payload = { contents: contents };

  // Loop through models until one works
  for (const model of models) {
    try {
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
      
      const options = {
        method: 'post',
        contentType: 'application/json',
        payload: JSON.stringify(payload),
        muteHttpExceptions: true
      };

      const response = UrlFetchApp.fetch(apiUrl, options);
      const json = JSON.parse(response.getContentText());

      if (json.candidates && json.candidates.length > 0) {
        return json.candidates[0].content.parts[0].text;
      } else if (json.error) {
        // Log specific error and try next model
        errors.push(`[${model}]: ${json.error.message}`);
        continue; 
      }
    } catch (e) {
      errors.push(`[${model} Exception]: ${e.toString()}`);
    }
  }

  // If all failed
  return `Xin lỗi, tôi không thể trả lời lúc này.\nChi tiết lỗi:\n${errors.join('\n')}`;
}

// --- FILE HELPERS ---

function getChatHistoryFromFile() {
  try {
    const folder = DriveApp.getFolderById(DATA_FOLDER_ID);
    const files = folder.getFilesByName('chat_history.json');
    if (files.hasNext()) return JSON.parse(files.next().getBlob().getDataAsString());
    return {};
  } catch (e) { return {}; }
}

function saveChatHistoryToFile(data) {
  const folder = DriveApp.getFolderById(DATA_FOLDER_ID);
  const files = folder.getFilesByName('chat_history.json');
  if (files.hasNext()) files.next().setContent(JSON.stringify(data, null, 2));
  else folder.createFile('chat_history.json', JSON.stringify(data, null, 2), MimeType.PLAIN_TEXT);
}
