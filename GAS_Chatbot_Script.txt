/**
 * DUNVEX CHATBOT DATA STORAGE (SAFE JSON)
 * Lưu trữ lịch sử chat và xử lý feedback khách hàng
 */

const DATA_FOLDER_ID = '1_LT4rzVui2E3BgfcwUSfMsUGQMN9NRTs'; 
const HISTORY_FILE = 'chat_history.json';

const SafeStore = {
  read: function(filename) {
    try {
      const folder = DriveApp.getFolderById(DATA_FOLDER_ID);
      const files = folder.getFilesByName(filename);
      if (!files.hasNext()) return [];
      const content = files.next().getBlob().getDataAsString().trim();
      if (!content) return [];
      
      if (content.startsWith('[')) return JSON.parse(content);
      return content.split('\n').filter(l => l.trim()).map(l => JSON.parse(l));
    } catch (e) { return []; }
  },
  write: function(filename, newData, action = 'APPEND') {
    const lock = LockService.getScriptLock();
    try {
      lock.waitLock(30000);
      
      const folder = DriveApp.getFolderById(DATA_FOLDER_ID);
      let file, files = folder.getFilesByName(filename);
      if (files.hasNext()) file = files.next();
      else file = folder.createFile(filename, '', MimeType.PLAIN_TEXT);

      let data = this.read(filename);
      if (action === 'APPEND') data.push(newData);
      else if (action === 'REPLACE_ALL') data = newData;
      
      file.setContent(data.map(item => JSON.stringify(item)).join('\n'));
      return { success: true };
    } catch (e) { 
      return { success: false, message: e.toString() }; 
    } finally {
      lock.releaseLock();
    }
  }
};

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const intent = data.action || data.intent;
    let result;

    switch(intent) {
      case 'track_chat': result = saveChatMessage(data.userEmail, data.message, data.botResponse); break;
      case 'get_history': result = getChatHistory(data.userEmail); break;
      case 'send_feedback': result = sendFeedbackEmail(data.userEmail, data.feedback, data.adminEmail); break;
      default: result = { success: false, message: 'Invalid action' };
    }
    return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ success: false, message: error.toString() })).setMimeType(ContentService.MimeType.JSON);
  }
}

function saveChatMessage(email, userMsg, botMsg) {
  try {
    const entry = { id: new Date().getTime().toString(), email: email, userMsg: userMsg, botMsg: botMsg, timestamp: new Date().toISOString() };
    SafeStore.write(HISTORY_FILE, entry, 'APPEND');
    return { success: true };
  } catch (e) { return { success: false, message: e.toString() }; }
}

function getChatHistory(email) {
  try {
    const all = SafeStore.read(HISTORY_FILE);
    const filtered = all.filter(h => h.email === email).slice(-20);
    return { success: true, history: filtered };
  } catch (e) { return { success: false, message: e.toString() }; }
}

function sendFeedbackEmail(userEmail, feedback, adminEmail) {
  try {
    const target = adminEmail || "dunvex.digital@gmail.com";
    MailApp.sendEmail({
      to: target,
      subject: `[FEEDBACK BOT] Từ khách hàng: ${userEmail}`,
      htmlBody: `
        <div style="font-family: Arial, sans-serif; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px;">
          <h2 style="color: #6366f1;">Góp ý từ Chatbot</h2>
          <p><b>Khách hàng:</b> ${userEmail}</p>
          <div style="background: #f1f5f9; padding: 15px; border-radius: 8px; margin-top: 10px;">
            ${feedback}
          </div>
          <p style="font-size: 12px; color: #94a3b8; margin-top: 20px;">Tin nhắn được gửi tự động từ hệ thống Dunvex Digital.</p>
        </div>
      `
    });
    return { success: true, message: "Cảm ơn đóng góp của bạn. Chúng tôi sẽ sớm phản hồi qua email!" };
  } catch (e) { return { success: false, message: e.toString() }; }
}
