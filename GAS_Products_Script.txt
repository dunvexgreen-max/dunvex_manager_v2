/**
 * DUNVEX PRODUCT MANAGEMENT SYSTEM (CRUD JSON)
 * Xử lý dữ liệu sản phẩm lưu dưới dạng file JSON trên Google Drive
 */

const PRODUCT_JSON_FILENAME = 'tao_san_pham.json';
const IMAGE_FOLDER_ID = '1dGFgw96a6gWVdHMq6rkk4fFRpDJqi5cG';

// --- SECURITY CONFIG ---
const CIPHER_KEY = Utilities.newBlob('dunvex_secure_16').getBytes();

function encryptData(text) {
  if (!text) return "";
  try {
    const blob = Utilities.newBlob(text.toString().trim()); 
    const encrypted = Utilities.encrypt(Utilities.CipherAlgorithm.AES_128, CIPHER_KEY, blob);
    return Utilities.base64Encode(encrypted);
  } catch (e) { return text; }
}

function decryptData(base64Text) {
  if (!base64Text || base64Text.length < 10) return base64Text;
  try {
    const decoded = Utilities.base64Decode(base64Text);
    const decrypted = Utilities.decrypt(Utilities.CipherAlgorithm.AES_128, CIPHER_KEY, decoded);
    return decrypted.getDataAsString();
  } catch (e) { return base64Text; }
}

function doPost(e) {
  let result;
  try {
    const contents = e.postData ? e.postData.contents : "";
    if (!contents) {
       return ContentService.createTextOutput(JSON.stringify({ success: false, message: 'Dữ liệu POST trống (Sản Phẩm Script)' })).setMimeType(ContentService.MimeType.JSON);
    }
    
    const data = JSON.parse(contents);
    const action = (data.action || "").toString().trim();

    switch (action) {
      case 'get_products':
      case 'getProducts':
        result = getProducts(data.userEmail, data.isAdmin, data.adminEmail);
        break;
      case 'save_product':
      case 'saveProduct':
        result = saveProduct(data.product, data.image_data);
        break;
      case 'delete_product':
      case 'deleteProduct':
        result = deleteProduct(data.id_san_pham);
        break;
      case 'upload_image':
      case 'uploadImage':
        result = handleImageUpload(data.filename, data.base64, data.mimetype);
        break;
      case 'get_initial_data': // Alias để tương thích chéo
        result = getProducts(data.userEmail || data.salesId, data.isAdmin, data.adminEmail);
        break;
      default:
        result = { success: false, message: 'Hành động [' + action + '] không hợp lệ tại Sản Phẩm Script' };
    }
  } catch (error) {
    result = { success: false, message: 'Lỗi Backend Sản Phẩm: ' + error.toString() };
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

/**
 * Lấy hoặc tạo file JSON trên Drive
 */
function getJsonFile() {
  const files = DriveApp.getFilesByName(PRODUCT_JSON_FILENAME);
  if (files.hasNext()) {
    return files.next();
  } else {
    return DriveApp.createFile(PRODUCT_JSON_FILENAME, '[]', MimeType.PLAIN_TEXT);
  }
}

function getProducts(userEmail, isAdmin, adminEmail) {
  try {
    const file = getJsonFile();
    const content = file.getBlob().getDataAsString();
    const list = JSON.parse(content || '[]');
    
    const encUser = encryptData(userEmail);
    const filtered = list.filter(p => {
      const pCreatorEnc = (p.ten_dang_nhap || "").toString();
      return pCreatorEnc === encUser;
    }).map(p => {
      const copy = Object.assign({}, p);
      copy.ten_dang_nhap = decryptData(p.ten_dang_nhap);
      return copy;
    });
    
    return { success: true, products: filtered };
  } catch (e) {
    return { success: false, message: e.toString() };
  }
}

function saveProduct(productDict, imageData) {
  try {
    const file = getJsonFile();
    let products = JSON.parse(file.getBlob().getDataAsString() || '[]');
    
    // 1. Xử lý ID
    if (!productDict.id_san_pham) {
      const nextId = products.length > 0 
        ? "S" + (Math.max(...products.map(p => parseInt(p.id_san_pham.replace('S', '')))) + 1).toString().padStart(3, '0')
        : "S001";
      productDict.id_san_pham = nextId;
    }

    // 2. Xử lý Hình ảnh (Nếu có data base64 gửi kèm)
    if (imageData && imageData.base64) {
      const uploadRes = handleImageUpload(imageData.filename, imageData.base64, imageData.mimetype);
      if (uploadRes.success) {
        productDict.image_san_pham = uploadRes.url;
      }
    }

    // 3. Encrypt identity
    if (productDict.ten_dang_nhap) {
      productDict.ten_dang_nhap = encryptData(productDict.ten_dang_nhap);
    }

    // 4. Cập nhật hoặc Thêm mới
    const index = products.findIndex(p => p.id_san_pham === productDict.id_san_pham);
    if (index > -1) {
      products[index] = productDict;
    } else {
      products.push(productDict);
    }

    // 5. Lưu lại file
    file.setContent(JSON.stringify(products, null, 2));
    
    // Return decrypted for UI
    const resultDict = Object.assign({}, productDict);
    resultDict.ten_dang_nhap = decryptData(productDict.ten_dang_nhap);
    return { success: true, product: resultDict };
  } catch (e) {
    return { success: false, message: e.toString() };
  }
}

function deleteProduct(id) {
  try {
    const file = getJsonFile();
    let products = JSON.parse(file.getBlob().getDataAsString() || '[]');
    const newProducts = products.filter(p => p.id_san_pham !== id);
    file.setContent(JSON.stringify(newProducts, null, 2));
    return { success: true };
  } catch (e) {
    return { success: false, message: e.toString() };
  }
}

function handleImageUpload(filename, base64, mimetype) {
  try {
    const folder = DriveApp.getFolderById(IMAGE_FOLDER_ID);
    const decoded = Utilities.base64Decode(base64);
    const blob = Utilities.newBlob(decoded, mimetype, filename);
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    const url = "https://lh3.googleusercontent.com/d/" + file.getId();
    return { success: true, url: url };
  } catch (e) {
    return { success: false, message: e.toString() };
  }
}

// --- MIGRATION UTILITY ---
function migrateProductsToEncrypted() {
  const file = getJsonFile();
  let products = JSON.parse(file.getBlob().getDataAsString() || '[]');
  let changed = false;

  products.forEach(p => {
    const val = (p.ten_dang_nhap || "").toString();
    if (val && !val.includes('+') && val.includes('@')) {
      p.ten_dang_nhap = encryptData(val);
      changed = true;
    }
  });

  if (changed) {
    file.setContent(JSON.stringify(products, null, 2));
    return "Products Migration Complete!";
  }
  return "No changes needed.";
}
