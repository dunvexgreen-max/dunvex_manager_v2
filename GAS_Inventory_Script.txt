const DATA_FOLDER_ID = '1_LT4rzVui2E3BgfcwUSfMsUGQMN9NRTs';

const FILES = {
  NHAP: 'ton_kho_nhap.json',
  XUAT: 'ton_kho_xuat.json',
  TONG_HOP: 'ton_kho_tong_hop.json',
  ORDER_DETAIL: 'order_chi_tiet.json'
};

const LOW_STOCK_THRESHOLD = 10;

// --- SECURITY CONFIG (XOR ENCRYPTION) ---
const XOR_SECRET = 'dunvex_secure_key_2025_custom';
// Legacy AES Key
const AES_KEY = Utilities.newBlob('dunvex_secure_16').getBytes();

/**
 * H·ªÜ TH·ªêNG L∆ØU TR·ªÆ AN TO√ÄN (SAFE STORAGE ENGINE)
 * Ch·ªëng Race Condition b·∫±ng LockService v√† JSON Lines
 */
const SafeStore = {
  read: function(filename) {
    try {
      const folder = DriveApp.getFolderById(DATA_FOLDER_ID);
      const files = folder.getFilesByName(filename);
      if (!files.hasNext()) return [];
      const content = files.next().getBlob().getDataAsString().trim();
      if (!content) return [];
      if (content.startsWith('[')) return JSON.parse(content);
      return content.split('\n').filter(l => l.trim()).map(l => JSON.parse(l));
    } catch (e) { return []; }
  },
  write: function(filename, newData, action = 'APPEND') {
    const lock = LockService.getScriptLock();
    try {
      lock.waitLock(30000);
      const folder = DriveApp.getFolderById(DATA_FOLDER_ID);
      let file, files = folder.getFilesByName(filename);
      if (files.hasNext()) file = files.next();
      else file = folder.createFile(filename, '', MimeType.PLAIN_TEXT);

      let data = this.read(filename);
      if (action === 'APPEND') data.push(newData);
      else if (action === 'UPDATE') {
        const id = newData.id || newData.id_don_hang || newData.productId;
        const idx = data.findIndex(item => (item.id === id || item.id_don_hang === id || item.productId === id));
        if (idx !== -1) data[idx] = newData;
        else data.push(newData);
      } else if (action === 'DELETE') {
        const id = typeof newData === 'string' ? newData : (newData.id || newData.id_don_hang || newData.productId);
        data = data.filter(item => (item.id !== id && item.id_don_hang !== id && item.productId !== id && item.id_san_pham !== id));
      } else if (action === 'REPLACE_ALL') data = newData;

      file.setContent(data.map(item => JSON.stringify(item)).join('\n'));
      return { success: true };
    } catch (e) { return { success: false, message: e.toString() }; }
    finally { lock.releaseLock(); }
  }
};

function encryptXOR(text) {
  if (!text) return "";
  try {
    const inputBytes = Utilities.newBlob(text.toString()).getBytes();
    const keyBytes = Utilities.newBlob(XOR_SECRET).getBytes();
    const outputBytes = [];
    for (let i = 0; i < inputBytes.length; i++) {
        outputBytes.push(inputBytes[i] ^ keyBytes[i % keyBytes.length]);
    }
    return Utilities.base64Encode(outputBytes);
  } catch (e) { return "ENC_ERR: " + e.toString(); }
}

function decryptXOR(base64Text) {
  if (!base64Text || base64Text.length < 5 || base64Text.startsWith("ENC_ERR")) return base64Text;
  try {
    const inputBytes = Utilities.base64Decode(base64Text);
    const keyBytes = Utilities.newBlob(XOR_SECRET).getBytes();
    const outputBytes = [];
    for (let i = 0; i < inputBytes.length; i++) {
        outputBytes.push(inputBytes[i] ^ keyBytes[i % keyBytes.length]);
    }
    return Utilities.newBlob(outputBytes).getDataAsString();
  } catch (e) { return base64Text; }
}

function decryptAES(base64Text) {
  if (!base64Text || base64Text.length < 10) return base64Text;
  try {
    const decoded = Utilities.base64Decode(base64Text);
    const decrypted = Utilities.decrypt(Utilities.CipherAlgorithm.AES_128, AES_KEY, decoded);
    return decrypted.getDataAsString();
  } catch (e) { return null; }
}

function encryptData(text) { return encryptXOR(text); }

function decryptData(base64Text) {
  let dec = decryptXOR(base64Text);
  if ((!dec || !dec.includes('@')) && base64Text) {
     const aes = decryptAES(base64Text);
     if (aes && aes.includes('@')) return aes;
  }
  return dec || base64Text;
}

function doGet(e) {
  const action = e.parameter.action;
  const adminEmail = e.parameter.adminEmail || e.parameter.mail; // Compatibility with old ton-kho.html
  let result;
  if (action === 'read' || action === 'get_inventory_logs') {
    result = getInventoryLogs(adminEmail);
  } else if (action === 'get_inventory_report') {
    result = getInventoryReport(adminEmail);
  } else {
    result = { success: false, message: 'Invalid GET action' };
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  let result;
  try {
    const contents = e.postData ? e.postData.contents : "";
    if (!contents) return ContentService.createTextOutput(JSON.stringify({ success: false, message: 'Data empty' })).setMimeType(ContentService.MimeType.JSON);
    const data = JSON.parse(contents);
    const action = (data.action || "").toString().trim();
    switch (action) {
      case 'get_inventory_report': result = getInventoryReport(data.adminEmail); break;
      case 'save_inventory_entry': result = saveInventoryEntry(data, data.adminEmail); break;
      case 'sync_order_to_inventory': result = syncOrderToInventory(data.orderId, data.userEmail, data.adminEmail, data.status); break;
      case 'get_inventory_logs': result = getInventoryLogs(data.adminEmail); break;
      case 'delete_inventory_entry': result = deleteInventoryEntry(data.id, data.adminEmail); break;
      case 'update_inventory_entry': result = updateInventoryEntry(data, data.adminEmail); break;
      case 'test_email_alert': result = testEmailAlert(data.adminEmail); break;
      default: result = { success: false, message: 'Invalid action: ' + action };
    }
  } catch (error) { result = { success: false, message: error.toString() }; }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

function getFile(filename) {
  const folder = DriveApp.getFolderById(DATA_FOLDER_ID);
  const files = folder.getFilesByName(filename);
  if (files.hasNext()) return files.next();
  return folder.createFile(filename, '[]', MimeType.PLAIN_TEXT);
}

function syncOrderToInventory(orderId, userEmail, adminEmail, status) {
  try {
    const finalizedStatuses = ['ƒê∆°n ch·ªët'];
    const isFinalized = finalizedStatuses.includes((status || "").toString().trim());
    const safeAdmin = (adminEmail || "").toLowerCase().trim();
    const prefix = "SYNC-" + orderId;

    let logsXuat = SafeStore.read(FILES.XUAT);
    logsXuat = logsXuat.filter(l => !l.id || !l.id.startsWith(prefix));

    if (isFinalized) {
      const allDetails = SafeStore.read(FILES.ORDER_DETAIL);
      const items = allDetails.filter(d => d.id_don_hang === orderId);
      items.forEach(item => {
        logsXuat.push({
          id: prefix + "-" + new Date().getTime() + "-" + Math.random().toString(36).substr(2, 5),
          productId: item.ma_san_pham || item.id_san_pham,
          productName: item.ten_san_pham,
          quantity: parseFloat(item.so_luong || 0),
          unit: item.don_vi_tinh || 'C√°i',
          date: new Date().toISOString(),
          user: encryptData(userEmail),
          ownedByAdmin: encryptData(safeAdmin),
          note: "Xu·∫•t t·ª´ ƒë∆°n h√†ng: " + orderId
        });
      });
    }

    SafeStore.write(FILES.XUAT, logsXuat, 'REPLACE_ALL');
    calculateStock(safeAdmin); 
    return { success: true, message: isFinalized ? 'ƒê√£ c·∫≠p nh·∫≠t xu·∫•t kho' : 'ƒê√£ g·ª° b·ªè xu·∫•t kho' };
  } catch (e) { return { success: false, message: e.toString() }; }
}

function saveInventoryEntry(data, adminEmail) {
  try {
    const filename = data.type === 'NHAP' ? FILES.NHAP : FILES.XUAT;
    const safeAdmin = (adminEmail || "").toLowerCase().trim();
    const entry = {
      id: "INV-" + new Date().getTime(),
      productId: data.productId,
      productName: data.productName,
      quantity: parseFloat(data.quantity || 0),
      unit: data.unit,
      date: new Date().toISOString(),
      user: encryptData(data.userEmail),
      ownedByAdmin: encryptData(safeAdmin),
      note: data.note || ''
    };
    const res = SafeStore.write(filename, entry, 'APPEND');
    calculateStock(safeAdmin);
    return res;
  } catch (e) { return { success: false, message: e.toString() }; }
}

function calculateStock(adminEmail) {
  if (!adminEmail) return { success: false, message: "Email Admin missing" };
  const safeAdmin = adminEmail.toLowerCase().trim();
  try {
    const nhapData = SafeStore.read(FILES.NHAP);
    const xuatData = SafeStore.read(FILES.XUAT);
    const stockMap = {};

    nhapData.filter(i => (decryptData(i.ownedByAdmin) || "").toLowerCase() === safeAdmin).forEach(i => {
      if (!stockMap[i.productId]) stockMap[i.productId] = { id: i.productId, name: i.productName, unit: i.unit, in: 0, out: 0 };
      stockMap[i.productId].in += (parseFloat(i.quantity) || 0);
    });

    xuatData.filter(i => (decryptData(i.ownedByAdmin) || "").toLowerCase() === safeAdmin).forEach(i => {
      if (!stockMap[i.productId]) stockMap[i.productId] = { id: i.productId, name: i.productName, unit: i.unit, in: 0, out: 0 };
      stockMap[i.productId].out += (parseFloat(i.quantity) || 0);
    });

    const encAdmin = encryptData(safeAdmin);
    const finalStock = Object.values(stockMap).map(i => ({
      id: i.id, name: i.name, unit: i.unit, 
      tongNhap: i.in, tongXuat: i.out, tonKho: i.in - i.out,
      ownedByAdmin: encAdmin
    }));

    let allSummary = SafeStore.read(FILES.TONG_HOP);
    allSummary = allSummary.filter(s => (decryptData(s.ownedByAdmin) || "").toLowerCase() !== safeAdmin);
    allSummary.push(...finalStock);
    SafeStore.write(FILES.TONG_HOP, allSummary, 'REPLACE_ALL');
    
    // T·ª± ƒë·ªông ki·ªÉm tra v√† g·ª≠i c·∫£nh b√°o mail n·∫øu t·ªìn th·∫•p
    checkLowStockAndNotify(finalStock, safeAdmin);

    return { success: true, data: finalStock };
  } catch (e) { return { success: false, message: e.toString() }; }
}

/**
 * G·ª≠i email c·∫£nh b√°o khi c√≥ s·∫£n ph·∫©m s·∫Øp h·∫øt h√†ng (< 10)
 * T√≠ch h·ª£p Cache ƒë·ªÉ tr√°nh g·ª≠i mail spam li√™n t·ª•c
 */
function checkLowStockAndNotify(stockList, adminEmail) {
  if (!adminEmail || !stockList) return;
  
  const cache = CacheService.getScriptCache();
  const lowStockItems = stockList.filter(item => {
    if (parseFloat(item.tonKho) < LOW_STOCK_THRESHOLD) {
      // Ch·ªâ g·ª≠i c·∫£nh b√°o n·∫øu trong 12 gi·ªù qua ch∆∞a b√°o cho m√£ h√†ng n√†y
      const cacheKey = 'LOW_STOCK_' + adminEmail + '_' + item.id;
      if (!cache.get(cacheKey)) {
        cache.put(cacheKey, 'SENT', 43200); // 12 ti·∫øng (43200 gi√¢y)
        return true;
      }
    }
    return false;
  });

  if (lowStockItems.length === 0) return;

  const subject = `‚ö†Ô∏è [C·∫¢NH B√ÅO KHO] M·ªôt s·ªë m·∫∑t h√†ng s·∫Øp h·∫øt - Dunvex Digital`;
  let itemsHtml = lowStockItems.map(item => `
    <tr style="border-bottom: 1px solid #eee;">
      <td style="padding: 12px; text-align: left;">
        <span style="font-weight: bold; color: #1e293b;">${item.name}</span><br>
        <small style="color: #94a3b8;">M√£: ${item.id}</small>
      </td>
      <td style="padding: 12px; text-align: center; font-weight: 800; color: #ef4444; font-size: 16px;">
        ${item.tonKho} ${item.unit}
      </td>
    </tr>
  `).join('');

  const htmlBody = `
    <div style="font-family: Arial, sans-serif; max-width: 550px; margin: 0 auto; border: 2px solid #ef4444; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
      <div style="background: #ef4444; padding: 25px; text-align: center; color: white;">
        <div style="font-size: 40px; margin-bottom: 10px;">üö®</div>
        <h2 style="margin: 0; text-transform: uppercase; letter-spacing: 1px;">C·∫£nh B√°o S·∫Øp H·∫øt H√†ng</h2>
        <p style="opacity: 0.9; margin-top: 5px;">H·ªá th·ªëng ph√°t hi·ªán t·ªìn kho ƒëang d∆∞·ªõi ng∆∞·ª°ng b√°o ƒë·ªông (< ${LOW_STOCK_THRESHOLD})</p>
      </div>
      <div style="padding: 30px; background: white;">
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 25px;">
          <thead>
            <tr style="background: #f8fafc; border-bottom: 2px solid #eee;">
              <th style="padding: 12px; text-align: left; color: #64748b; font-size: 11px; text-transform: uppercase;">M·∫∑t h√†ng</th>
              <th style="padding: 12px; text-align: center; color: #64748b; font-size: 11px; text-transform: uppercase;">T·ªìn th·ª±c t·∫ø</th>
            </tr>
          </thead>
          <tbody>${itemsHtml}</tbody>
        </table>
        
        <div style="background: #fff7ed; padding: 15px; border-radius: 12px; border: 1px solid #ffedd5; margin-bottom: 25px; text-align: center;">
          <p style="margin: 0; color: #9a3412; font-size: 14px; font-weight: 600;">‚ö†Ô∏è L∆∞u √Ω: B·∫°n c·∫ßn nh·∫≠p kho th√™m ƒë·ªÉ ƒë·∫£m b·∫£o vi·ªác kinh doanh.</p>
        </div>

        <div style="text-align: center;">
          <a href="https://dunvex.com/quan-ly-kho.html" style="display: inline-block; background: #6366f1; color: white; padding: 14px 28px; text-decoration: none; border-radius: 12px; font-weight: bold; font-size: 15px; box-shadow: 0 4px 6px rgba(99, 102, 241, 0.2);">üì¶ V√ÄO QU·∫¢N L√ù KHO T·ªîNG</a>
        </div>
      </div>
      <div style="background: #f8fafc; padding: 15px; text-align: center; font-size: 11px; color: #94a3b8; border-top: 1px solid #eee;">
        H·ªá th·ªëng th√¥ng b√°o t·ªìn kho t·ª± ƒë·ªông Dunvex Digital. C·∫£nh b√°o n√†y g·ª≠i t·ªëi ƒëa 1 l·∫ßn m·ªói 12 gi·ªù cho c√πng 1 m·∫∑t h√†ng.
      </div>
    </div>`;

  try {
    MailApp.sendEmail({
      to: adminEmail,
      subject: subject,
      htmlBody: htmlBody
    });
  } catch (e) {
    Logger.log("L·ªói g·ª≠i mail c·∫£nh b√°o kho: " + e.toString());
  }
}

function getInventoryLogs(adminEmail) {
  try {
    const safeAdmin = (adminEmail || "").toLowerCase().trim();
    const nhaps = SafeStore.read(FILES.NHAP).filter(i => (decryptData(i.ownedByAdmin) || "").toLowerCase() === safeAdmin).map(i => {
      i.type = 'NHAP'; i.user = decryptData(i.user); return i;
    });
    const xuats = SafeStore.read(FILES.XUAT).filter(i => (decryptData(i.ownedByAdmin) || "").toLowerCase() === safeAdmin).map(i => {
      i.type = 'XUAT'; i.user = decryptData(i.user); return i;
    });
    const all = [...nhaps, ...xuats].sort((a, b) => new Date(b.date) - new Date(a.date));
    return { success: true, data: all };
  } catch (e) { return { success: false, message: e.toString() }; }
}

function getInventoryReport(adminEmail) {
  try {
    const safeAdmin = (adminEmail || "").toLowerCase().trim();
    const filtered = SafeStore.read(FILES.TONG_HOP).filter(s => (decryptData(s.ownedByAdmin) || "").toLowerCase() === safeAdmin);
    return { success: true, data: filtered };
  } catch(e) { return { success: false, message: e.toString() }; }
}

function deleteInventoryEntry(id, adminEmail) {
  if (!id) return { success: false, message: "Missing ID" };
  try {
     const safeAdmin = (adminEmail || "").toLowerCase().trim();
     SafeStore.write(FILES.NHAP, id, 'DELETE');
     SafeStore.write(FILES.XUAT, id, 'DELETE');
     calculateStock(safeAdmin);
     return { success: true };
  } catch(e) { return { success: false, message: e.toString() }; }
}

function updateInventoryEntry(data, adminEmail) {
   try {
    const safeAdmin = (adminEmail || "").toLowerCase().trim();
    let res = SafeStore.write(FILES.NHAP, data, 'UPDATE');
    if (!res.success) res = SafeStore.write(FILES.XUAT, data, 'UPDATE');
    calculateStock(safeAdmin);
    return { success: true };
   } catch(e) { return { success: false, message: e.toString() }; }
}

/**
 * H√†m test ƒë·ªÉ g·ª≠i email m·∫´u
 */
function testEmailAlert(adminEmail) {
  if (!adminEmail) return { success: false, message: "Email Admin missing" };
  const mockStock = [
    { id: 'TEST-ID', name: 'S·∫¢N PH·∫®M TEST (C√ÄNH B√ÅO)', unit: 'C√°i', tonKho: 5 }
  ];
  const subject = `üß™ [TEST ALERT] C·∫£nh b√°o t·ªìn kho m·∫´u - Dunvex Digital`;
  
  // X√≥a cache test n·∫øu c√≥ ƒë·ªÉ ƒë·∫£m b·∫£o g·ª≠i ƒë∆∞·ª£c
  const cache = CacheService.getScriptCache();
  cache.remove('LOW_STOCK_' + adminEmail + '_TEST-ID');
  
  checkLowStockAndNotify(mockStock, adminEmail.toLowerCase().trim());
  return { success: true, message: "ƒê√£ g·ª≠i email test ƒë·∫øn: " + adminEmail };
}

