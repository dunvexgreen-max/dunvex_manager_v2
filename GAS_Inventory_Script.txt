const DATA_FOLDER_ID = '1_LT4rzVui2E3BgfcwUSfMsUGQMN9NRTs';

const FILES = {
  NHAP: 'ton_kho_nhap.json',
  XUAT: 'ton_kho_xuat.json',
  TONG_HOP: 'ton_kho_tong_hop.json',
  ORDER_DETAIL: 'order_chi_tiet.json'
};

// --- SECURITY CONFIG ---
const CIPHER_KEY = PropertiesService.getScriptProperties().getProperty('CRM_SECRET') || 'dv_secure_fallback_2024';

function encryptData(text) {
  if (!text) return "";
  try {
    const blob = Utilities.newBlob(text.toString().trim().toLowerCase());
    const encrypted = Utilities.encrypt(Utilities.CipherAlgorithm.AES_128, CIPHER_KEY, blob);
    return Utilities.base64Encode(encrypted);
  } catch (e) { return text; }
}

function decryptData(base64Text) {
  if (!base64Text || base64Text.length < 10) return base64Text;
  try {
    const decoded = Utilities.base64Decode(base64Text);
    const decrypted = Utilities.decrypt(Utilities.CipherAlgorithm.AES_128, CIPHER_KEY, decoded);
    return decrypted.getDataAsString();
  } catch (e) { return base64Text; }
}

function doPost(e) {
  let result;
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;

    // L·∫•y ng·ªØ c·∫£nh Admin (T·ª´ th√¥ng tin ng∆∞·ªùi d√πng g·ª≠i l√™n)
    const adminContext = data.adminEmail; 

    switch (action) {
      case 'save_inventory_entry':
        result = saveInventoryEntry(data, adminContext);
        break;
      case 'sync_order_to_inventory':
        result = syncOrderToInventory(data.orderId, data.userEmail, adminContext);
        break;
      case 'get_inventory_report':
        result = getInventoryReport(adminContext);
        break;
      default:
        result = { success: false, message: 'H√†nh ƒë·ªông kh√¥ng h·ª£p l·ªá' };
    }
  } catch (error) {
    result = { success: false, message: 'L·ªói doPost: ' + error.toString() };
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

function getFile(filename) {
  const folder = DriveApp.getFolderById(DATA_FOLDER_ID);
  const files = folder.getFilesByName(filename);
  if (files.hasNext()) return files.next();
  return folder.createFile(filename, '[]', MimeType.PLAIN_TEXT);
}

function syncOrderToInventory(orderId, userEmail, adminEmail) {
  try {
    const fileDetail = getFile(FILES.ORDER_DETAIL);
    const allDetails = JSON.parse(fileDetail.getBlob().getDataAsString() || '[]');
    const items = allDetails.filter(d => d.id_don_hang === orderId);

    if (items.length === 0) return { success: false, message: 'Kh√¥ng th·∫•y chi ti·∫øt ƒë∆°n h√†ng' };

    const fileXuat = getFile(FILES.XUAT);
    let logsXuat = JSON.parse(fileXuat.getBlob().getDataAsString() || '[]');

    // Ki·ªÉm tra xem ƒë∆°n h√†ng n√†y ƒë√£ ƒë∆∞·ª£c ƒë·ªìng b·ªô xu·∫•t kho ch∆∞a ƒë·ªÉ tr√°nh tr√πng l·∫∑p
    const isSynced = logsXuat.some(l => l.id && l.id.startsWith("SYNC-" + orderId));
    if (isSynced) return { success: true, message: 'ƒê∆°n h√†ng n√†y ƒë√£ ƒë∆∞·ª£c xu·∫•t kho tr∆∞·ªõc ƒë√≥' };

    items.forEach(item => {
      logsXuat.push({
        id: "SYNC-" + orderId + "-" + new Date().getTime() + "-" + Math.random().toString(36).substr(2, 5),
        productId: item.ma_san_pham || item.id_san_pham,
        productName: item.ten_san_pham,
        quantity: parseFloat(item.so_luong || 0),
        unit: item.don_vi_tinh || 'C√°i',
        date: new Date().toISOString(),
        user: encryptData(userEmail),
        ownedByAdmin: encryptData(adminEmail),
        note: "Xu·∫•t t·ª´ ƒë∆°n h√†ng: " + orderId
      });
    });

    fileXuat.setContent(JSON.stringify(logsXuat, null, 2));
    calculateStock(adminEmail); 

    return { success: true, message: 'ƒê√£ ƒë·ªìng b·ªô ƒë∆°n h√†ng v√†o kho' };
  } catch (e) {
    return { success: false, message: 'L·ªói sync: ' + e.toString() };
  }
}

function saveInventoryEntry(data, adminEmail) {
  try {
    const filename = data.type === 'NHAP' ? FILES.NHAP : FILES.XUAT;
    const file = getFile(filename);
    let logs = JSON.parse(file.getBlob().getDataAsString() || '[]');
    
    logs.push({
      id: "INV-" + new Date().getTime(),
      productId: data.productId,
      productName: data.productName,
      quantity: parseFloat(data.quantity || 0),
      unit: data.unit,
      date: new Date().toISOString(),
      user: encryptData(data.userEmail),
      ownedByAdmin: encryptData(adminEmail),
      note: data.note || ''
    });
    
    file.setContent(JSON.stringify(logs, null, 2));
    calculateStock(adminEmail);
    
    return { success: true, message: 'C·∫≠p nh·∫≠t kho th√†nh c√¥ng' };
  } catch (e) {
    return { success: false, message: 'L·ªói save: ' + e.toString() };
  }
}

function calculateStock(adminEmail) {
  if (!adminEmail) return { success: false, message: "Email Admin kh√¥ng t·ªìn t·∫°i" };

  try {
    const fileNhap = getFile(FILES.NHAP);
    const fileXuat = getFile(FILES.XUAT);
    const nhapData = JSON.parse(fileNhap.getBlob().getDataAsString() || '[]');
    const xuatData = JSON.parse(fileXuat.getBlob().getDataAsString() || '[]');
    
    const stockMap = {};
    const encAdmin = encryptData(adminEmail);

    // T√≠nh Nh·∫≠p
    nhapData.filter(i => (i.ownedByAdmin || "").toString() === encAdmin).forEach(i => {
      if (!stockMap[i.productId]) stockMap[i.productId] = { id: i.productId, name: i.productName, unit: i.unit, in: 0, out: 0 };
      stockMap[i.productId].in += i.quantity;
    });

    // T√≠nh Xu·∫•t
    xuatData.filter(i => (i.ownedByAdmin || "").toString() === encAdmin).forEach(i => {
      if (!stockMap[i.productId]) stockMap[i.productId] = { id: i.productId, name: i.productName, unit: i.unit, in: 0, out: 0 };
      stockMap[i.productId].out += i.quantity;
    });

    const finalStock = Object.values(stockMap).map(i => ({
      id: i.id, name: i.name, unit: i.unit, 
      tongNhap: i.in, tongXuat: i.out, tonKho: i.in - i.out,
      ownedByAdmin: encAdmin
    }));

    const fileTongHop = getFile(FILES.TONG_HOP);
    let allSummary = JSON.parse(fileTongHop.getBlob().getDataAsString() || '[]');
    
    allSummary = allSummary.filter(s => (s.ownedByAdmin || "").toString() !== encAdmin);
    allSummary.push(...finalStock);
    
    fileTongHop.setContent(JSON.stringify(allSummary, null, 2));
    
    // G·ª¨I EMAIL C·∫¢NH B√ÅO
    checkAndSendEmailAlert(finalStock, adminEmail);
    
    return { success: true, data: finalStock };
  } catch (e) {
    return { success: false, message: 'L·ªói calculate: ' + e.toString() };
  }
}

function checkAndSendEmailAlert(stockList, adminEmail) {
  try {
    if (!adminEmail || !adminEmail.includes('@')) return; // Ki·ªÉm tra mail h·ª£p l·ªá

    const lowStockItems = stockList.filter(item => item.tonKho < 10);
    if (lowStockItems.length === 0) return;

    let htmlBody = `
      <div style="font-family: Arial, sans-serif; padding: 20px; border: 1px solid #eee; border-radius: 10px;">
        <h2 style="color: #ef4444;">üö® C·∫¢NH B√ÅO T·ªíN KHO TH·∫§P</h2>
        <p>H·ªá th·ªëng Dunvex ph√°t hi·ªán doanh nghi·ªáp c·ªßa b·∫°n ƒëang s·∫Øp h·∫øt c√°c s·∫£n ph·∫©m sau:</p>
        <table border="1" style="border-collapse: collapse; width: 100%; text-align: left;">
          <tr style="background: #f8fafc;">
            <th style="padding: 10px;">S·∫£n ph·∫©m</th>
            <th style="padding: 10px;">M√£ s·ªë</th>
            <th style="padding: 10px;">T·ªìn th·ª±c t·∫ø</th>
          </tr>
    `;

    lowStockItems.forEach(item => {
      htmlBody += `
        <tr>
          <td style="padding: 10px;">${item.name}</td>
          <td style="padding: 10px;">${item.id}</td>
          <td style="padding: 10px; color: red; font-weight: bold;">${item.tonKho} ${item.unit}</td>
        </tr>
      `;
    });

    htmlBody += `
        </table>
        <p style="margin-top: 20px;">Vui l√≤ng ki·ªÉm tra v√† nh·∫≠p h√†ng k·ªãp th·ªùi cho doanh nghi·ªáp c·ªßa b·∫°n.</p>
      </div>
    `;

    MailApp.sendEmail({
      to: adminEmail,
      subject: "üö® [Dunvex Inventory] C·∫£nh b√°o s·∫£n ph·∫©m s·∫Øp h·∫øt h√†ng",
      htmlBody: htmlBody
    });
  } catch (e) {
    console.error("L·ªói g·ª≠i mail: " + e.toString());
  }
}

function getInventoryReport(adminEmail) {
  try {
    const file = getFile(FILES.TONG_HOP);
    const allData = JSON.parse(file.getBlob().getDataAsString() || '[]');
    const encAdmin = encryptData(adminEmail);
    
    const filtered = allData.filter(d => (d.ownedByAdmin || "").toString() === encAdmin).map(d => {
      const copy = Object.assign({}, d);
      copy.ownedByAdmin = decryptData(d.ownedByAdmin);
      return copy;
    });
    return { success: true, data: filtered };
  } catch (e) {
    return { success: false, message: 'L·ªói getReport: ' + e.toString() };
  }
}
