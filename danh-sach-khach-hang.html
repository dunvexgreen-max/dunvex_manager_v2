<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Danh Sách Khách Hàng - Premium</title>
	<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
		rel="stylesheet">
	<style>
		:root {
			--primary: #FFD700;
			--primary-hover: #e6c200;
			--dark: #0f0f0f;
			--dark-card: #1a1a1a;
			--text-light: #ffffff;
			--text-gray: #a0a0a0;
			--glass: rgba(255, 255, 255, 0.03);
			--glass-border: rgba(255, 255, 255, 0.1);
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Plus Jakarta Sans', sans-serif;
		}

		body {
			background-color: var(--dark);
			color: var(--text-light);
			min-height: 100vh;
			padding: 40px 20px;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
		}

		header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 40px;
		}

		.title-area h1 {
			font-size: 2.5rem;
			font-weight: 800;
			background: linear-gradient(to right, #fff, var(--primary));
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
		}

		.btn-add {
			background: var(--primary);
			color: var(--dark);
			padding: 12px 24px;
			border-radius: 16px;
			text-decoration: none;
			font-weight: 700;
			display: flex;
			align-items: center;
			gap: 10px;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			box-shadow: 0 10px 20px rgba(255, 215, 0, 0.2);
		}

		.btn-add:hover {
			transform: translateY(-3px);
			box-shadow: 0 15px 30px rgba(255, 215, 0, 0.3);
		}

		.search-box {
			background: var(--glass);
			border: 1px solid var(--glass-border);
			padding: 15px 25px;
			border-radius: 20px;
			margin-bottom: 30px;
			display: flex;
			align-items: center;
			backdrop-filter: blur(10px);
		}

		.search-box input {
			background: transparent;
			border: none;
			color: white;
			width: 100%;
			margin-left: 15px;
			font-size: 1rem;
			outline: none;
		}

		.table-container {
			background: var(--dark-card);
			border-radius: 30px;
			border: 1px solid var(--glass-border);
			overflow: hidden;
			box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
		}

		table {
			width: 100%;
			border-collapse: collapse;
		}

		th {
			background: rgba(255, 255, 255, 0.05);
			text-align: left;
			padding: 20px;
			font-size: 0.85rem;
			text-transform: uppercase;
			letter-spacing: 1px;
			color: var(--text-gray);
		}

		td {
			padding: 20px;
			border-bottom: 1px solid var(--glass-border);
		}

		tr:hover {
			background: rgba(255, 215, 0, 0.02);
		}

		.customer-id {
			color: var(--primary);
			font-weight: 700;
		}

		.phone {
			color: var(--text-gray);
			font-family: monospace;
		}

		.location-badge {
			display: inline-flex;
			align-items: center;
			gap: 5px;
			background: rgba(0, 200, 83, 0.1);
			color: #00c853;
			padding: 4px 10px;
			border-radius: 8px;
			font-size: 0.8rem;
			text-decoration: none;
		}

		.actions {
			display: flex;
			gap: 10px;
		}

		.btn-icon {
			width: 38px;
			height: 38px;
			border-radius: 12px;
			display: flex;
			align-items: center;
			justify-content: center;
			border: 1px solid var(--glass-border);
			background: var(--glass);
			color: white;
			cursor: pointer;
			transition: all 0.2s;
		}

		.btn-icon:hover {
			background: white;
			color: var(--dark);
		}

		.loader {
			text-align: center;
			padding: 50px;
		}

		.spinner {
			width: 40px;
			height: 40px;
			border: 3px solid var(--glass-border);
			border-top-color: var(--primary);
			border-radius: 50%;
			animation: spin 1s linear infinite;
			margin: 0 auto 15px;
		}

		@keyframes spin {
			to {
				transform: rotate(360deg);
			}
		}

		/* Responsive */
		@media (max-width: 768px) {
			header {
				flex-direction: column;
				gap: 20px;
				align-items: flex-start;
			}

			.search-box {
				padding: 12px 15px;
			}

			td,
			th {
				padding: 12px;
				font-size: 0.9rem;
			}

			.hide-mobile {
				display: none;
			}
		}
	</style>
</head>

<body>
	<div class="container">
		<header>
			<div class="title-area">
				<h1>Khách Hàng</h1>
				<p style="color: var(--text-gray);">Quản lý đối tác và thông tin liên hệ</p>
			</div>
			<a href="khach-hang-form.html" class="btn-add">
				<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
					<line x1="12" y1="5" x2="12" y2="19"></line>
					<line x1="5" y1="12" x2="19" y2="12"></line>
				</svg>
				THÊM KHÁCH HÀNG
			</a>
		</header>

		<div class="search-box">
			<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--text-gray)" stroke-width="2">
				<circle cx="11" cy="11" r="8"></circle>
				<line x1="21" y1="21" x2="16.65" y2="16.65"></line>
			</svg>
			<input type="text" id="searchInput" placeholder="Tìm kiếm theo tên, số điện thoại, ID..."
				oninput="handleSearch()">
		</div>

		<div class="table-container">
			<table id="customerTable">
				<thead>
					<tr>
						<th>ID</th>
						<th>Khách Hàng</th>
						<th class="hide-mobile">Liên Hệ</th>
						<th class="hide-mobile">Khu Vực</th>
						<th>Vị Trí</th>
						<th>Thao Tác</th>
					</tr>
				</thead>
				<tbody id="tableBody">
					<!-- Data will be loaded here -->
				</tbody>
			</table>
			<div id="loader" class="loader">
				<div class="spinner"></div>
				<p>Đang tải dữ liệu...</p>
			</div>
		</div>
	</div>

	<script>
		// Cùng SCRIPT_URL với các trang khác hoặc cái mới cho project này
		const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzM8tzbdJJvXE0r6NcP8cJGO2RHsgYUR6Jy73U4NDLkSQRjT3fus_i4lugwVQZIKI8zhw/exec'; // Vẫn dùng script cũ vì nó đa năng, hoặc thay bằng script riêng của Khách hàng
		const KHACH_SCRIPT_URL = 'YOUR_NEW_DEPLOYED_URL_HERE'; // Thay bằng URL sau khi bạn Deploy GAS_KhachHang_Script.txt

		let allCustomers = [];

		async function loadCustomers() {
			const userStr = localStorage.getItem('userLoggedIn');
			if (!userStr) {
				window.location.href = 'index.html';
				return;
			}
			const user = JSON.parse(userStr);

			try {
				// Sử dụng KHACH_SCRIPT_URL nếu bạn deploy file mới, hoặc SCRIPT_URL nếu gộp
				// Để demo tôi sẽ giả định KHACH_SCRIPT_URL
				const url = `${KHACH_SCRIPT_URL}?action=read&username=${encodeURIComponent(user.email)}`;
				const res = await fetch(url);
				const result = await res.json();

				if (result.success) {
					allCustomers = result.data;
					renderTable(allCustomers);
				}
			} catch (err) {
				console.error(err);
				document.getElementById('loader').innerHTML = '<p style="color: #ff3d00;">Lỗi không thể tải dữ liệu</p>';
			} finally {
				document.getElementById('loader').style.display = 'none';
			}
		}

		function renderTable(data) {
			const tbody = document.getElementById('tableBody');
			if (data.length === 0) {
				tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 40px; color: var(--text-gray);">Chưa có khách hàng nào</td></tr>';
				return;
			}

			tbody.innerHTML = data.map(item => {
				const viTri = item.vi_tri || '';
				const mapLink = viTri ? `https://www.google.com/maps?q=${viTri}` : '#';

				return `
                    <tr>
                        <td><span class="customer-id">${item.id_khach_hang}</span></td>
                        <td>
                            <div style="font-weight: 700;">${item.ten_khach_hang}</div>
                            <div style="font-size: 0.8rem; color: var(--text-gray);" class="show-mobile">${item.so_dien_thoai}</div>
                        </td>
                        <td class="hide-mobile">
                            <div class="phone">${item.so_dien_thoai}</div>
                        </td>
                        <td class="hide-mobile">
                            <div style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${item.dia_chi}">
                                ${item.dia_chi}
                            </div>
                        </td>
                        <td>
                            ${viTri ? `<a href="${mapLink}" target="_blank" class="location-badge">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                                Maps
                            </a>` : '<span style="color:var(--text-gray); font-size: 0.8rem;">---</span>'}
                        </td>
                        <td>
                            <div class="actions">
                                <button class="btn-icon" onclick="editCustomer('${item.id_khach_hang}')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                </button>
                                <button class="btn-icon" style="color: #ff3d00;" onclick="deleteCustomer('${item.id_khach_hang}')">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
			}).join('');
		}

		function handleSearch() {
			const query = document.getElementById('searchInput').value.toLowerCase();
			const filtered = allCustomers.filter(c =>
				(c.ten_khach_hang || '').toLowerCase().includes(query) ||
				(c.so_dien_thoai || '').includes(query) ||
				(c.id_khach_hang || '').toLowerCase().includes(query)
			);
			renderTable(filtered);
		}

		function editCustomer(id) {
			window.location.href = `khach-hang-form.html?id=${id}`;
		}

		async function deleteCustomer(id) {
			if (!confirm('Bạn có chắc chắn muốn xóa khách hàng này?')) return;

			try {
				const payload = { action: 'delete', idValue: id };
				const fd = new URLSearchParams();
				fd.append('payload', JSON.stringify(payload));

				const res = await fetch(KHACH_SCRIPT_URL, {
					method: 'POST',
					body: fd
				});
				const result = await res.json();
				if (result.success) {
					loadCustomers();
				}
			} catch (err) {
				alert('Lỗi: ' + err.toString());
			}
		}

		document.addEventListener('DOMContentLoaded', loadCustomers);
	</script>
</body>

</html>