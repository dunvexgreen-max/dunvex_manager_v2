<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>T·∫°o B·∫£ng Gi√° T√πy Ch·ªânh | Dunvex Digital</title>
	<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
	<style>
		:root {
			--primary: #6366f1;
			--bg-dark: #0f172a;
			--card-bg: rgba(30, 41, 59, 0.7);
			--glass-border: rgba(255, 255, 255, 0.1);
			--text-main: #f8fafc;
			--text-muted: #94a3b8;
			--accent-purple: #c084fc;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Outfit', sans-serif;
		}

		body {
			background-color: var(--bg-dark);
			color: var(--text-main);
			min-height: 100vh;
			background-image: radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%), radial-gradient(at 100% 100%, rgba(192, 132, 252, 0.15) 0px, transparent 50%);
			padding: 40px 20px;
		}

		.container {
			max-width: 1100px;
			margin: 0 auto;
		}

		.header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 40px;
		}

		.header h1 {
			font-size: 2rem;
			font-weight: 800;
			background: linear-gradient(135deg, #fff, var(--primary));
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
		}

		.back-btn {
			text-decoration: none;
			color: var(--text-muted);
			display: flex;
			align-items: center;
			gap: 8px;
			font-weight: 600;
			transition: 0.3s;
		}

		.back-btn:hover {
			color: white;
		}

		/* Form Sections */
		.card {
			background: var(--card-bg);
			backdrop-filter: blur(20px);
			border: 1px solid var(--glass-border);
			border-radius: 24px;
			padding: 32px;
			margin-bottom: 30px;
			box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
		}

		.grid-info {
			display: grid;
			grid-template-columns: 1fr 2fr;
			gap: 30px;
		}

		@media (max-width: 768px) {
			.grid-info {
				grid-template-columns: 1fr;
			}
		}

		.form-group {
			margin-bottom: 20px;
		}

		label {
			display: block;
			font-size: 0.85rem;
			color: var(--text-muted);
			margin-bottom: 8px;
			text-transform: uppercase;
			letter-spacing: 1px;
			font-weight: 600;
		}

		input,
		textarea {
			width: 100%;
			padding: 14px 18px;
			background: rgba(15, 23, 42, 0.5);
			border: 1px solid var(--glass-border);
			border-radius: 12px;
			color: white;
			outline: none;
			transition: 0.3s;
		}

		input:focus,
		textarea:focus {
			border-color: var(--primary);
			box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
		}

		/* Logo Upload */
		.logo-uploader {
			width: 100%;
			height: 200px;
			border: 2px dashed var(--glass-border);
			border-radius: 20px;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: 0.3s;
			position: relative;
			overflow: hidden;
		}

		.logo-uploader:hover {
			border-color: var(--primary);
			background: rgba(99, 102, 241, 0.05);
		}

		.logo-preview {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			object-fit: contain;
			background: rgba(0, 0, 0, 0.3);
			display: none;
		}

		/* Dynamic Table */
		.table-wrapper {
			overflow-x: auto;
			margin-top: 20px;
			border-radius: 16px;
			border: 1px solid var(--glass-border);
		}

		table {
			width: 100%;
			border-collapse: collapse;
			min-width: 800px;
		}

		th,
		td {
			padding: 15px;
			border: 1px solid var(--glass-border);
			text-align: left;
		}

		th {
			background: rgba(255, 255, 255, 0.05);
			color: var(--text-muted);
			font-size: 0.85rem;
			font-weight: 600;
			text-transform: uppercase;
		}

		.col-header-wrap {
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.col-header-wrap input {
			background: transparent;
			border: none;
			padding: 5px;
			font-weight: 800;
			color: var(--primary);
		}

		.btn-mini {
			padding: 4px 8px;
			font-size: 0.7rem;
			border-radius: 6px;
			border: 1px solid var(--glass-border);
			background: rgba(255, 255, 255, 0.05);
			color: var(--text-muted);
			cursor: pointer;
			transition: 0.3s;
		}

		.btn-mini:hover {
			background: #ef4444;
			color: white;
			border-color: #ef4444;
		}

		/* Control Buttons */
		.controls {
			display: flex;
			gap: 12px;
			margin-top: 20px;
		}

		.btn {
			padding: 14px 28px;
			border-radius: 14px;
			font-weight: 700;
			cursor: pointer;
			transition: 0.3s;
			display: flex;
			align-items: center;
			gap: 10px;
			border: none;
		}

		.btn-primary {
			background: var(--primary);
			color: white;
		}

		.btn-primary:hover {
			transform: translateY(-2px);
			box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
		}

		.btn-glass {
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid var(--glass-border);
			color: white;
		}

		.btn-glass:hover {
			background: rgba(255, 255, 255, 0.1);
		}

		.btn-outline {
			background: transparent;
			border: 2px solid var(--primary);
			color: var(--primary);
		}

		.btn-outline:hover {
			background: var(--primary);
			color: white;
		}

		/* Loading */
		.loading-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(15, 23, 42, 0.8);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 1000;
			backdrop-filter: blur(5px);
		}

		.spinner {
			width: 50px;
			height: 50px;
			border: 5px solid rgba(255, 255, 255, 0.1);
			border-top-color: var(--primary);
			border-radius: 50%;
			animation: spin 1s infinite linear;
		}

		@keyframes spin {
			to {
				transform: rotate(360deg);
			}
		}

		#toast {
			position: fixed;
			bottom: 30px;
			right: 30px;
			padding: 16px 32px;
			border-radius: 12px;
			background: #22c55e;
			color: white;
			font-weight: 800;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
			transform: translateY(200px);
			transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
			z-index: 2000;
		}

		#toast.show {
			transform: translateY(0);
		}
	</style>
</head>

<body>
	<div class="loading-overlay" id="loader">
		<div class="spinner"></div>
	</div>

	<div id="toast">Th√¥ng b√°o</div>

	<div class="container">
		<div class="header">
			<div>
				<a href="index.html" class="back-btn">‚Üê Trang ch·ªß</a>
				<h1 id="pageTitle">T·∫°o B·∫£ng Gi√° T√πy Ch·ªânh</h1>
			</div>
			<div class="controls">
				<button class="btn btn-glass" onclick="window.location.href='danh-sach-bang-gia.html'">üìã Danh
					s√°ch</button>
				<button class="btn btn-primary" onclick="saveData()">üíæ <span id="saveBtnText">L∆∞u B·∫£ng
						Gi√°</span></button>
			</div>
		</div>

		<div class="grid-info">
			<!-- Logo Card -->
			<div class="card">
				<label>Logo ƒê·∫°i L√Ω / Kh√°ch H√†ng</label>
				<div class="logo-uploader" onclick="document.getElementById('logoFile').click()">
					<div id="uploadPrompt">
						<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor"
							stroke-width="2" style="margin-bottom: 15px; color: var(--primary);">
							<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
							<polyline points="17 8 12 3 7 8"></polyline>
							<line x1="12" y1="3" x2="12" y2="15"></line>
						</svg>
						<p style="font-size: 0.9rem; color: var(--text-muted);">Nh·∫•n ƒë·ªÉ t·∫£i l√™n Logo</p>
					</div>
					<img id="logoPreview" class="logo-preview">
				</div>
				<input type="file" id="logoFile" hidden accept="image/*" onchange="previewLogo(this)">
			</div>

			<!-- Info Card -->
			<div class="card">
				<div class="form-group">
					<label>Ti√™u ƒë·ªÅ b·∫£ng gi√°</label>
					<input type="text" id="pl_title" placeholder="V√≠ d·ª•: B·∫£ng Gi√° V·∫≠t T∆∞ C√¥ng Tr√¨nh ABC - Th√°ng 1/2026">
				</div>
				<div class="form-group">
					<label>T√™n kh√°ch h√†ng / ƒê·ªëi t√°c</label>
					<input type="text" id="pl_customer" placeholder="C√¥ng ty TNHH X√¢y D·ª±ng Dunvex">
				</div>
				<div class="form-group">
					<label>Ghi ch√∫ ch√¢n trang</label>
					<textarea id="pl_notes" rows="2"
						placeholder="V√≠ d·ª•: Gi√° tr√™n ƒë√£ bao g·ªìm VAT. Giao h√†ng t·∫°i kho..."></textarea>
				</div>
			</div>
		</div>

		<!-- Table Card -->
		<div class="card" style="padding-top: 20px;">
			<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
				<h2 style="font-size: 1.2rem; display: flex; align-items: center; gap: 10px;">
					<span style="color: var(--primary);">üìä</span> Chi Ti·∫øt B·∫£ng Gi√°
				</h2>
				<div class="controls">
					<button class="btn btn-mini"
						style="background: rgba(99, 102, 241, 0.1); color: var(--primary); font-weight: 800;"
						onclick="addColumn()">‚ûï Th√™m C·ªôt</button>
					<button class="btn btn-mini"
						style="background: rgba(192, 132, 252, 0.1); color: var(--accent-purple); font-weight: 800;"
						onclick="addRow()">‚ûï Th√™m H√†ng</button>
				</div>
			</div>

			<div class="table-wrapper">
				<table id="priceTable">
					<thead>
						<tr id="headerRow">
							<th style="width: 60px;">STT</th>
							<th>
								<div class="col-header-wrap">
									<input type="text" value="T√™n S·∫£n Ph·∫©m" onchange="updateColName(0, this.value)">
								</div>
							</th>
							<th>
								<div class="col-header-wrap">
									<input type="text" value="ƒê∆°n V·ªã" onchange="updateColName(1, this.value)">
								</div>
							</th>
							<th>
								<div class="col-header-wrap">
									<input type="text" value="ƒê∆°n Gi√°" onchange="updateColName(2, this.value)">
								</div>
							</th>
							<th style="width: 50px;">-</th>
						</tr>
					</thead>
					<tbody id="tableBody">
						<!-- Rows here -->
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<script>
		const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxJAbSw_qt8cYDU6DD0eOUL0cL_UHsSEWFNE59WO32JTvySnOHztKnAULpXTi8gkiEl/exec';
		let currentUser = JSON.parse(localStorage.getItem('user'));
		let perms = JSON.parse(localStorage.getItem('permissions'));
		let currentId = null;
		let currentLogoUrl = null;

		let columns = ["T√™n S·∫£n Ph·∫©m", "ƒê∆°n V·ªã", "ƒê∆°n Gi√°"];
		let rows = [
			{ "T√™n S·∫£n Ph·∫©m": "", "ƒê∆°n V·ªã": "", "ƒê∆°n Gi√°": "" }
		];

		if (!currentUser) window.location.href = 'auth.html';

		async function init() {
			const urlParams = new URLSearchParams(window.location.search);
			currentId = urlParams.get('id');

			// Smart Bridge ID: L·∫•y t·ª´ localStorage n·∫øu URL b·ªã thi·∫øu (ph√≤ng tr∆∞·ªùng h·ª£p m·∫•t parameter)
			if (!currentId) {
				currentId = localStorage.getItem('last_edit_pl_id');
			}

			if (currentId) {
				document.getElementById('pageTitle').innerText = "Ch·ªânh S·ª≠a B·∫£ng Gi√°";
				document.getElementById('saveBtnText').innerText = "C·∫≠p Nh·∫≠t B·∫£ng Gi√°";
				await loadExistingData(currentId);
				// X√≥a ID d·ª± ph√≤ng sau khi ƒë√£ load th√†nh c√¥ng ƒë·ªÉ tr√°nh nh·∫ßm l·∫´n l·∫ßn sau
				localStorage.removeItem('last_edit_pl_id');
			} else {
				renderTable();
			}
		}

		async function loadExistingData(id) {
			const loader = document.getElementById('loader');
			loader.style.display = 'flex';
			try {
				const res = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({ action: 'get_price_list_detail', fileId: id })
				});
				const data = await res.json();
				if (data.success) {
					const pl = data.data;
					document.getElementById('pl_title').value = pl.title;
					document.getElementById('pl_customer').value = pl.customerName;
					document.getElementById('pl_notes').value = pl.notes || '';
					columns = pl.columns;
					rows = pl.rows;
					currentLogoUrl = pl.logoUrl;

					if (currentLogoUrl) {
						const prev = document.getElementById('logoPreview');
						prev.src = currentLogoUrl;
						prev.style.display = 'block';
						document.getElementById('uploadPrompt').style.display = 'none';
					}
					renderTable();
				} else {
					showToast("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë·ªÉ s·ª≠a", true);
				}
			} catch (e) {
				showToast("L·ªói t·∫£i d·ªØ li·ªáu", true);
			} finally {
				loader.style.display = 'none';
			}
		}

		function showToast(msg, isError = false) {
			const t = document.getElementById('toast');
			t.innerText = msg;
			t.style.background = isError ? '#ef4444' : '#22c55e';
			t.classList.add('show');
			setTimeout(() => t.classList.remove('show'), 3000);
		}

		function previewLogo(input) {
			if (input.files && input.files[0]) {
				const reader = new FileReader();
				reader.onload = function (e) {
					const prev = document.getElementById('logoPreview');
					prev.src = e.target.result;
					prev.style.display = 'block';
					document.getElementById('uploadPrompt').style.display = 'none';
				}
				reader.readAsDataURL(input.files[0]);
			}
		}

		function renderTable() {
			const headerRow = document.getElementById('headerRow');
			const tbody = document.getElementById('tableBody');

			// Header
			headerRow.innerHTML = `<th style="width: 60px;">STT</th>`;
			columns.forEach((col, idx) => {
				headerRow.innerHTML += `
					<th>
						<div class="col-header-wrap">
							<input type="text" value="${col}" onchange="updateColName(${idx}, this.value)">
							<button class="btn-mini" onclick="removeColumn(${idx})">√ó</button>
						</div>
					</th>
				`;
			});
			headerRow.innerHTML += `<th style="width: 50px;">-</th>`;

			// Body
			tbody.innerHTML = '';
			rows.forEach((row, rowIdx) => {
				let rowHtml = `<td>${rowIdx + 1}</td>`;
				columns.forEach((col, colIdx) => {
					rowHtml += `<td><input type="text" value="${row[col] || ''}" oninput="updateCellValue(${rowIdx}, ${colIdx}, this.value)"></td>`;
				});
				rowHtml += `<td><button class="btn-mini" onclick="removeRow(${rowIdx})">√ó</button></td>`;
				const tr = document.createElement('tr');
				tr.innerHTML = rowHtml;
				tbody.appendChild(tr);
			});
		}

		function addColumn() {
			const newColName = "C·ªôt m·ªõi " + (columns.length + 1);
			columns.push(newColName);
			rows.forEach(r => r[newColName] = "");
			renderTable();
		}

		function removeColumn(idx) {
			if (columns.length <= 1) return;
			const colName = columns[idx];
			columns.splice(idx, 1);
			rows.forEach(r => delete r[colName]);
			renderTable();
		}

		function updateColName(idx, val) {
			const oldName = columns[idx];
			columns[idx] = val;
			rows.forEach(r => {
				r[val] = r[oldName];
				delete r[oldName];
			});
		}

		function addRow() {
			const newRow = {};
			columns.forEach(col => newRow[col] = "");
			rows.push(newRow);
			renderTable();
		}

		function removeRow(idx) {
			if (rows.length <= 1) return;
			rows.splice(idx, 1);
			renderTable();
		}

		function updateCellValue(rowIdx, colIdx, val) {
			const colName = columns[colIdx];
			rows[rowIdx][colName] = val;
		}

		async function saveData() {
			const title = document.getElementById('pl_title').value;
			const customer = document.getElementById('pl_customer').value;
			if (!title || !customer) {
				showToast("Vui l√≤ng ƒëi·ªÅn ti√™u ƒë·ªÅ v√† t√™n kh√°ch h√†ng!", true);
				return;
			}

			const loader = document.getElementById('loader');
			loader.style.display = 'flex';

			const logoFile = document.getElementById('logoFile').files[0];
			let logo_base64 = null;
			let logo_mimetype = null;

			if (logoFile) {
				logo_base64 = await fileToBase64(logoFile);
				logo_mimetype = logoFile.type;
			}

			const payload = {
				action: 'save_price_list',
				id: currentId,
				userEmail: currentUser.email,
				title: title,
				customerName: customer,
				notes: document.getElementById('pl_notes').value,
				columns: columns,
				rows: rows,
				logo_base64: logo_base64,
				logo_mimetype: logo_mimetype,
				logoUrl: currentLogoUrl
			};

			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify(payload)
				});
				const data = await response.json();
				if (data.success) {
					showToast(currentId ? "ƒê√£ c·∫≠p nh·∫≠t b·∫£ng gi√°!" : "ƒê√£ l∆∞u b·∫£ng gi√° th√†nh c√¥ng!");
					setTimeout(() => window.location.href = 'danh-sach-bang-gia.html', 1500);
				} else {
					showToast("L·ªói: " + data.message, true);
				}
			} catch (e) {
				showToast("L·ªói k·∫øt n·ªëi m√°y ch·ªß!", true);
			} finally {
				loader.style.display = 'none';
			}
		}

		function fileToBase64(file) {
			return new Promise((resolve, reject) => {
				const reader = new FileReader();
				reader.readAsDataURL(file);
				reader.onload = () => resolve(reader.result.split(',')[1]);
				reader.onerror = error => reject(error);
			});
		}

		init();
	</script>
</body>

</html>