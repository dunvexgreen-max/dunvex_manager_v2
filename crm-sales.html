<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>CRM Sales | Dunvex Digital</title>
	<link rel="icon" type="image/svg+xml"
		href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%236366f1'/><text x='50%' y='50%' dominant-baseline='central' text-anchor='middle' fill='white' font-size='60' font-family='sans-serif' font-weight='800'>DV</text></svg>">
	<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
	<!-- Leaflet Map CSS -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
	<style>
		:root {
			--primary: #6366f1;
			--bg-dark: #0f172a;
			--card-bg: rgba(30, 41, 59, 0.7);
			--glass-border: rgba(255, 255, 255, 0.1);
			--text-main: #f8fafc;
			--text-muted: #94a3b8;
			--accent-purple: #c084fc;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Outfit', sans-serif;
		}

		body {
			background-color: var(--bg-dark);
			color: var(--text-main);
			min-height: 100vh;
			background-image: radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%), radial-gradient(at 100% 100%, rgba(192, 132, 252, 0.15) 0px, transparent 50%);
			padding: 20px;
		}

		.container {
			max-width: 800px;
			margin: 40px auto;
		}

		.top-bar {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
		}

		.top-bar h1 {
			font-size: 1.8rem;
			font-weight: 800;
			background: linear-gradient(135deg, #fff, var(--primary));
			background-clip: text;
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
		}



		/* Tabs */
		.tabs {
			display: flex;
			gap: 10px;
			margin-bottom: 24px;
			background: rgba(255, 255, 255, 0.05);
			padding: 5px;
			border-radius: 12px;
		}

		.tab-btn {
			flex: 1;
			padding: 12px;
			border: none;
			background: none;
			color: var(--text-muted);
			font-weight: 600;
			cursor: pointer;
			border-radius: 8px;
			transition: 0.3s;
		}

		.tab-btn.active {
			background: var(--primary);
			color: white;
			box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
		}

		/* Form Card */
		.form-card {
			background: var(--card-bg);
			backdrop-filter: blur(20px);
			border: 1px solid var(--glass-border);
			border-radius: 24px;
			padding: 30px;
			display: none;
		}

		.form-card.active {
			display: block;
			animation: fadeInUp 0.4s ease;
		}

		@keyframes fadeInUp {
			from {
				opacity: 0;
				transform: translateY(20px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.form-group {
			margin-bottom: 20px;
			position: relative;
		}

		.address-suggestions {
			position: absolute;
			top: 100%;
			left: 0;
			right: 0;
			background: #1e293b;
			border: 1px solid var(--glass-border);
			border-radius: 12px;
			z-index: 2000;
			margin-top: 5px;
			max-height: 250px;
			overflow-y: auto;
			box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
		}

		.suggestion-item {
			padding: 12px 16px;
			cursor: pointer;
			font-size: 0.85rem;
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
			line-height: 1.4;
		}

		.suggestion-item:hover {
			background: var(--primary);
			color: white;
		}

		.suggestion-item:last-child {
			border-bottom: none;
		}

		label {
			display: block;
			font-size: 0.85rem;
			color: var(--text-muted);
			margin-bottom: 8px;
			text-transform: uppercase;
			letter-spacing: 1px;
		}

		input,
		select,
		textarea {
			width: 100%;
			padding: 12px 16px;
			background: rgba(0, 0, 0, 0.2);
			border: 1px solid var(--glass-border);
			border-radius: 12px;
			color: white;
			font-size: 1rem;
			outline: none;
			transition: 0.3s;
		}

		input:focus,
		select:focus,
		textarea:focus {
			border-color: var(--primary);
			background: rgba(0, 0, 0, 0.4);
		}

		.btn-submit {
			width: 100%;
			padding: 15px;
			background: var(--primary);
			border: none;
			border-radius: 12px;
			color: white;
			font-weight: 700;
			font-size: 1.1rem;
			cursor: pointer;
			transition: 0.3s;
			margin-top: 10px;
		}

		.btn-submit:hover {
			transform: translateY(-3px);
			box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
		}

		.btn-submit:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		.gps-status {
			font-size: 0.8rem;
			color: #22c55e;
			margin-top: 8px;
			display: flex;
			align-items: center;
			gap: 6px;
		}

		.gps-status.error {
			color: #ef4444;
		}

		.hidden {
			display: none;
		}

		.btn-glass {
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid var(--glass-border);
			color: var(--text-muted);
			border-radius: 8px;
			cursor: pointer;
			transition: 0.3s;
		}

		.btn-glass:hover {
			background: rgba(255, 255, 255, 0.1);
			color: white;
		}

		/* Toast */
		#toast {
			position: fixed;
			top: 20px;
			right: 20px;
			padding: 16px 24px;
			border-radius: 12px;
			background: #22c55e;
			color: white;
			font-weight: 600;
			transform: translateX(200%);
			transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
			z-index: 3000;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
		}

		#toast.active {
			transform: translateX(0);
		}

		.back-btn {
			text-decoration: none;
			color: var(--text-muted);
			font-size: 0.9rem;
			display: flex;
			align-items: center;
			gap: 5px;
		}

		.back-btn:hover {
			color: white;
		}

		/* Purpose Filters */
		.filter-group {
			display: flex;
			gap: 8px;
			margin: 20px 0;
			overflow-x: auto;
			padding-bottom: 5px;
		}

		.purpose-btn {
			padding: 8px 16px;
			border-radius: 20px;
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid var(--glass-border);
			color: var(--text-muted);
			font-size: 0.8rem;
			font-weight: 600;
			white-space: nowrap;
			transition: 0.3s;
			cursor: pointer;
		}

		.purpose-btn.active {
			background: var(--primary);
			color: white;
			border-color: var(--primary);
		}

		/* History List */
		.history-list {
			margin-top: 30px;
			border-top: 1px solid var(--glass-border);
			padding-top: 20px;
		}

		.history-item {
			background: rgba(0, 0, 0, 0.2);
			border: 1px solid var(--glass-border);
			border-radius: 16px;
			padding: 15px;
			margin-bottom: 12px;
			display: flex;
			gap: 15px;
			align-items: center;
		}

		.history-img {
			width: 60px;
			height: 60px;
			border-radius: 8px;
			object-fit: cover;
			cursor: zoom-in;
			transition: 0.3s;
		}

		.history-img:hover {
			transform: scale(1.05);
		}

		.history-info {
			flex: 1;
		}

		.history-name {
			font-weight: 600;
			font-size: 0.95rem;
			margin-bottom: 2px;
		}

		.history-meta {
			font-size: 0.75rem;
			color: var(--text-muted);
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
			margin-top: 4px;
		}

		.history-purpose {
			background: rgba(99, 102, 241, 0.2);
			color: var(--primary);
			padding: 2px 8px;
			border-radius: 4px;
			font-size: 0.65rem;
			font-weight: 700;
			text-transform: uppercase;
		}

		/* Zoom Modal */
		.zoom-modal {
			position: fixed;
			inset: 0;
			background: rgba(0, 0, 0, 0.9);
			z-index: 5000;
			display: none;
			justify-content: center;
			align-items: center;
			padding: 40px;
		}

		.zoom-modal.active {
			display: flex;
		}

		.zoom-img {
			max-width: 100%;
			max-height: 100%;
			border-radius: 8px;
			box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
		}

		.zoom-close {
			position: absolute;
			top: 20px;
			right: 20px;
			color: white;
			font-size: 2rem;
			cursor: pointer;
		}

		/* Customer Detail Overlay */
		.detail-overlay {
			position: fixed;
			top: 0;
			right: -100%;
			width: 100%;
			max-width: 500px;
			height: 100%;
			background: var(--bg-dark);
			z-index: 4000;
			box-shadow: -10px 0 50px rgba(0, 0, 0, 0.5);
			transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
			padding: 40px 30px;
			overflow-y: auto;
			border-left: 1px solid var(--glass-border);
		}

		.detail-overlay.active {
			right: 0;
		}

		.detail-header {
			display: flex;
			justify-content: space-between;
			align-items: flex-start;
			margin-bottom: 30px;
		}

		.detail-close {
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid var(--glass-border);
			color: white;
			width: 40px;
			height: 40px;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
		}

		.detail-section {
			margin-bottom: 25px;
			background: rgba(255, 255, 255, 0.03);
			border-radius: 16px;
			padding: 20px;
			border: 1px solid var(--glass-border);
		}

		.detail-label {
			font-size: 0.75rem;
			color: var(--text-muted);
			text-transform: uppercase;
			letter-spacing: 1px;
			margin-bottom: 5px;
		}

		.detail-value {
			font-size: 1.1rem;
			font-weight: 600;
		}

		.clickable-row {
			cursor: pointer;
			transition: 0.2s;
		}

		.clickable-row:hover {
			background: rgba(255, 255, 255, 0.05) !important;
		}

		/* Map Styles */
		#map-container {
			height: 500px;
			border-radius: 16px;
			border: 1px solid var(--glass-border);
			z-index: 10;
		}

		.map-wrapper {
			position: relative;
			width: 100%;
			margin-top: 15px;
			transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
		}

		.map-wrapper.fullscreen {
			position: fixed;
			top: 10px;
			left: 10px;
			right: 10px;
			bottom: 10px;
			z-index: 6000;
			margin: 0;
			height: calc(100vh - 20px);
		}

		.map-wrapper.fullscreen #map-container {
			height: 100%;
			border-radius: 20px;
		}

		.map-controls-overlay {
			position: absolute;
			top: 15px;
			left: 55px;
			/* Avoiding Leaflet controls */
			right: 15px;
			z-index: 2000;
			display: flex;
			gap: 10px;
			pointer-events: none;
		}

		.map-search-box {
			flex: 1;
			max-width: 300px;
			pointer-events: auto;
			position: relative;
		}

		.map-search-box input {
			height: 40px;
			padding: 0 15px 0 35px;
			background: rgba(15, 23, 42, 0.9);
			backdrop-filter: blur(10px);
			border: 1px solid var(--glass-border);
			border-radius: 10px;
			font-size: 0.85rem;
			color: white;
		}

		.map-search-box::before {
			content: 'üîç';
			position: absolute;
			left: 10px;
			top: 50%;
			transform: translateY(-50%);
			font-size: 0.8rem;
			opacity: 0.6;
		}

		.map-btn-group {
			display: flex;
			gap: 8px;
			pointer-events: auto;
		}

		.btn-map-control {
			width: 40px;
			height: 40px;
			background: rgba(15, 23, 42, 0.9);
			backdrop-filter: blur(10px);
			border: 1px solid var(--glass-border);
			border-radius: 10px;
			color: white;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: 0.3s;
		}

		.btn-map-control:hover {
			background: var(--primary);
			transform: scale(1.05);
		}

		.map-legend-wrapper {
			position: absolute;
			bottom: 25px;
			left: 15px;
			z-index: 2000;
			background: rgba(15, 23, 42, 0.95);
			backdrop-filter: blur(10px);
			border: 1px solid var(--glass-border);
			border-radius: 12px;
			overflow: hidden;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			width: 180px;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
			display: flex;
			flex-direction: column;
		}

		.map-legend-wrapper.collapsed {
			width: auto;
			min-width: 120px;
		}

		.legend-header {
			padding: 8px 12px;
			font-size: 0.75rem;
			font-weight: 600;
			color: #e2e8f0;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: space-between;
			background: rgba(255, 255, 255, 0.05);
			border-bottom: 1px solid var(--glass-border);
			user-select: none;
		}

		.map-legend-wrapper.collapsed .legend-header {
			border-bottom: none;
		}

		.map-legend-content {
			padding: 8px;
			display: flex;
			flex-direction: column;
			gap: 6px;
			max-height: 200px;
			overflow-y: auto;
			transition: 0.3s;
		}

		.map-legend-wrapper.collapsed .map-legend-content {
			display: none;
		}

		.legend-item {
			display: flex;
			align-items: center;
			gap: 8px;
			font-size: 0.75rem;
			cursor: pointer;
			transition: 0.2s;
			padding: 4px 6px;
			border-radius: 6px;
		}

		.legend-item:hover {
			background: rgba(255, 255, 255, 0.05);
		}

		.legend-item.hidden {
			opacity: 0.4;
			text-decoration: line-through;
		}

		.legend-color {
			width: 10px;
			height: 10px;
			border-radius: 50%;
			flex-shrink: 0;
		}

		.map-date-filters {
			display: grid;
			grid-template-columns: 1fr 1fr 1fr;
			gap: 15px;
			margin-bottom: 20px;
		}

		.user-pulse-marker {
			animation: mapPulse 2s infinite;
		}

		@keyframes mapPulse {
			0% {
				filter: drop-shadow(0 0 0 rgba(59, 130, 246, 0.7));
			}

			70% {
				filter: drop-shadow(0 0 15px rgba(59, 130, 246, 0));
			}

			100% {
				filter: drop-shadow(0 0 0 rgba(59, 130, 246, 0));
			}
		}

		.map-popup-card {
			color: #1e293b;
			padding: 5px;
		}

		.map-popup-card h3 {
			margin: 0 0 5px 0;
			color: var(--primary);
			font-size: 1rem;
		}

		.map-popup-card p {
			margin: 2px 0;
			font-size: 0.8rem;
		}

		.map-popup-card .btn-popup:hover {
			filter: brightness(1.2);
		}

		.custom-marker {
			background: none !important;
			border: none !important;
		}

		.custom-marker div {
			transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
		}

		.custom-marker:hover div {
			transform: rotate(-45deg) scale(1.2) !important;
			z-index: 1000;
		}

		/* Responsive Optimizations */
		@media (max-width: 600px) {
			body {
				padding: 10px;
			}

			.container {
				margin: 10px auto;
			}

			.top-bar {
				flex-direction: column;
				align-items: flex-start;
				gap: 15px;
			}

			.top-bar .back-btn {
				order: -1;
				margin-bottom: 5px;
			}

			.tabs {
				overflow-x: auto;
				padding: 5px;
				gap: 8px;
				justify-content: flex-start;
				mask-image: linear-gradient(to right, black 85%, transparent 100%);
				-webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%);
			}

			.tab-btn {
				flex: 0 0 auto;
				padding: 10px 15px;
				font-size: 0.85rem;
				white-space: nowrap;
			}

			.form-card {
				padding: 20px 15px;
				border-radius: 16px;
			}

			.map-date-filters {
				grid-template-columns: 1fr;
				gap: 10px;
			}

			.map-date-filters div {
				width: 100%;
			}

			#map-container {
				height: 350px;
			}

			.detail-overlay {
				padding: 25px 15px;
			}

			h1 {
				font-size: 1.4rem !important;
			}

			.form-group label {
				font-size: 0.75rem;
			}

			#admin_toggle_container {
				width: 100%;
				justify-content: center;
				margin-top: 10px;
			}

			.form-card {
				padding: 20px 12px !important;
				border-radius: 12px !important;
			}

			.list-controls {
				flex-direction: column !important;
			}

			.search-wrapper {
				width: 100% !important;
			}

			/* Make table font smaller on mobile */
			table {
				font-size: 0.8rem !important;
			}

			th,
			td {
				padding: 8px 5px !important;
			}

			.sub-tabs {
				overflow-x: auto;
				justify-content: flex-start !important;
				gap: 5px;
			}

			.sub-tab-btn {
				flex: 0 0 auto !important;
				padding: 8px 15px !important;
				font-size: 0.8rem !important;
			}

			.top-bar {
				margin-bottom: 20px;
			}

			.top-bar h1 {
				font-size: 1.3rem !important;
			}

			#user_display {
				font-size: 0.75rem !important;
				word-break: break-all;
			}

			.top-bar div div {
				flex-wrap: wrap !important;
			}
		}
	</style>
</head>

<body>
	<div id="toast">Th√¥ng b√°o ·ªü ƒë√¢y!</div>

	<div id="zoomModal" class="zoom-modal" onclick="closeZoom()">
		<span class="zoom-close">&times;</span>
		<img id="zoomImg" class="zoom-img" src="">
	</div>

	<div id="detailOverlay" class="detail-overlay">
		<div class="detail-header">
			<div>
				<h2 id="det_name" style="font-size: 1.6rem; font-weight: 800; color: var(--primary);">T√™n Kh√°ch H√†ng
				</h2>
				<p id="det_id" style="color: var(--text-muted); font-size: 0.8rem;">ID: KH00000</p>
			</div>
			<button class="detail-close" onclick="closeDetail()">‚úï</button>
		</div>

		<div class="detail-section">
			<div class="detail-label">Li√™n H·ªá</div>
			<div id="det_contact" class="detail-value">Nguy·ªÖn VƒÉn A</div>
			<div id="det_phone" style="color: var(--accent-purple); font-weight: 600; margin-top: 5px;">0901234567</div>
		</div>

		<div class="detail-section">
			<div class="detail-label">ƒê·ªãa Ch·ªâ & Khu V·ª±c</div>
			<div id="det_address" class="detail-value" style="font-size: 0.95rem;">S·ªë 123 ƒê∆∞·ªùng ABC...</div>
			<div id="det_area" style="color: var(--text-muted); font-size: 0.85rem; margin-top: 5px;">üìç Mi·ªÅn Nam</div>
		</div>

		<div class="detail-section">
			<div class="detail-label">Ph√¢n Lo·∫°i ƒê·ªëi T∆∞·ª£ng</div>
			<div id="det_type" class="detail-value" style="color: var(--accent-purple);">Nh√† m√°y t√¥n</div>
		</div>

		<div class="detail-section">
			<div class="detail-label">V·ªã Tr√≠ GPS</div>
			<div id="det_location" class="detail-value" style="font-family: monospace; font-size: 0.9rem;">10.123,
				106.456</div>
			<button class="btn-glass" onclick="openInGoogleMaps()"
				style="margin-top: 10px; width: 100%; padding: 10px;">Xem tr√™n b·∫£n ƒë·ªì</button>
		</div>

		<div class="detail-section">
			<div class="detail-label">Tr·∫°ng Th√°i</div>
			<div id="det_status"
				style="display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; background: rgba(34, 197, 94, 0.2); color: #22c55e;">
				ƒêang ho·∫°t ƒë·ªông</div>
		</div>

		<div class="history-list" id="det_history">
			<!-- Personal History Highlights -->
		</div>
		<div class="history-list" id="det_history">
			<!-- Personal History Highlights -->
		</div>
	</div>

	<!-- Checkin Detail Overlay -->
	<div id="checkinDetailOverlay" class="detail-overlay">
		<div class="detail-header">
			<div>
				<h2 id="ci_det_name" style="font-size: 1.4rem; font-weight: 800; color: var(--primary);">Kh√°ch h√†ng A
				</h2>
				<p id="ci_det_time" style="color: var(--text-muted); font-size: 0.9rem;">12:30 20/10/2023</p>
			</div>
			<button class="detail-close" onclick="closeCheckinDetail()">‚úï</button>
		</div>

		<div class="detail-section">
			<div class="detail-label">M·ª•c ƒë√≠ch</div>
			<div id="ci_det_purpose" class="detail-value" style="color: var(--accent-purple);">ThƒÉm h·ªèi</div>
		</div>

		<div class="detail-section">
			<div class="detail-label">Kho·∫£ng c√°ch & V·ªã tr√≠</div>
			<div id="ci_det_dist" class="detail-value">50m</div>
			<div id="ci_det_loc"
				style="font-family: monospace; font-size: 0.85rem; color: var(--text-muted); margin-top: 5px;">10.123,
				106.123</div>
			<button class="btn-glass" onclick="openCheckinMap()"
				style="margin-top: 10px; width: 100%; padding: 8px;">Xem v·ªã tr√≠ Check-in</button>
		</div>

		<div class="detail-section">
			<div class="detail-label">Ghi ch√∫ k·∫øt qu·∫£</div>
			<div id="ci_det_note" class="detail-value" style="font-size: 0.95rem; white-space: pre-line;">...</div>
		</div>

		<div class="detail-section">
			<div class="detail-label">H√¨nh ·∫£nh minh ch·ª©ng</div>
			<img id="ci_det_img" src="" style="width: 100%; border-radius: 8px; margin-top: 10px; cursor: pointer;"
				onclick="zoomImage(this.src)">
		</div>
	</div>

	<!-- CHATBOT WIDGET -->

	<div class="container">
		<div class="top-bar">
			<div>
				<h1>CRM & Sales Check-in</h1>
				<div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
					<p id="user_display" style="font-size: 0.85rem; color: var(--text-muted);"></p>
					<span id="role_badge"
						style="font-size: 0.7rem; padding: 2px 8px; border-radius: 20px; background: rgba(99, 102, 241, 0.2); color: var(--primary); font-weight: 800; border: 1px solid var(--primary);"></span>
				</div>
			</div>
			<a href="index.html" class="back-btn">‚Üê Quay l·∫°i</a>
		</div>

		<div class="tabs">
			<button class="tab-btn active" onclick="switchTab('create')">üÜï Kh√°ch h√†ng</button>
			<button class="tab-btn" onclick="switchTab('list')">üìã Danh s√°ch & L·ªçc</button>
			<button class="tab-btn" onclick="switchTab('checkin')">üìç Check-in</button>
			<button class="tab-btn" onclick="switchTab('map')">üó∫Ô∏è B·∫£n ƒë·ªì</button>
			<button class="tab-btn" onclick="switchTab('docs')">üìÅ T√†i li·ªáu</button>
		</div>

		<div id="formCreate" class="form-card active">
			<h2 id="formTitle" style="font-size: 1.2rem; margin-bottom: 20px; color: var(--primary);">üÜï T·∫°o
				Kh√°ch H√†ng
				M·ªõi</h2>
			<form id="customerForm">
				<input type="hidden" id="edit_cust_id" value="">
				<div class="form-group">
					<label>T√™n Kh√°ch h√†ng *</label>
					<input type="text" id="cust_name" placeholder="V√≠ d·ª•: C√¥ng ty TNHH ABC" required>
				</div>
				<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
					<div class="form-group">
						<label>Ng∆∞·ªùi li√™n h·ªá</label>
						<input type="text" id="cust_contact" placeholder="Nguy·ªÖn VƒÉn A">
					</div>
					<div class="form-group">
						<label>S·ªë ƒëi·ªán tho·∫°i</label>
						<input type="tel" id="cust_phone" placeholder="090...">
					</div>
				</div>
				<div class="form-group">
					<label>Email</label>
					<input type="email" id="cust_email" placeholder="email@gmail.com">
				</div>
				<div class="form-group">
					<label>ƒê·ªãa ch·ªâ Kho/C·ª≠a h√†ng *</label>
					<input type="text" id="cust_address" placeholder="S√¥ 1, ƒê∆∞·ªùng X, Qu·∫≠n Y" required
						oninput="handleAddressAutocomplete(this.value)" autocomplete="off">
					<div id="addressSuggestions" class="address-suggestions hidden"></div>
				</div>
				<div class="form-group">
					<label>V·ªã tr√≠ Shop/Kho (GPS) *</label>
					<div style="display: flex; gap: 10px;">
						<input type="text" id="cust_location" placeholder="Nh·∫•n n√∫t ƒë·ªÉ l·∫•y v·ªã tr√≠ ho·∫∑c d√°n t·ªça ƒë·ªô..."
							oninput="handleDirectLocationInput(this.value, 'create')">
						<button type="button" id="btnGetGPS" class="btn-glass" onclick="captureGPS()"
							style="padding: 0 15px; font-size: 0.8rem; background: var(--primary); color: white;">L·∫•y
							GPS</button>
					</div>
					<div id="gpsStatusCreate" class="gps-status">‚åõ ƒêang k·∫øt n·ªëi GPS...</div>
				</div>
				<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
					<div class="form-group">
						<label>Khu v·ª±c th·ªã tr∆∞·ªùng</label>
						<input type="text" id="cust_area" list="area_list" placeholder="Ch·ªçn ho·∫∑c th√™m...">
						<datalist id="area_list"></datalist>
					</div>
					<div class="form-group">
						<label>Ph√¢n lo·∫°i kh√°ch h√†ng</label>
						<input type="text" id="cust_type" list="type_list" placeholder="Ch·ªçn ho·∫∑c th√™m m·ªõi...">
						<datalist id="type_list"></datalist>
					</div>
				</div>
				<div style="display: flex; gap: 10px; margin-top: 10px;">
					<button type="submit" class="btn-submit" id="btnCust" style="flex: 3;">L∆∞u Kh√°ch H√†ng</button>
					<button type="button" class="btn-glass" onclick="resetCustomerForm()"
						style="flex: 1; margin-top: 10px;">L√†m m·ªõi</button>
				</div>
			</form>
		</div>

		<div id="formList" class="form-card">
			<div class="list-controls" style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center;">
				<div class="search-wrapper" style="flex: 1; position: relative;">
					<input type="text" id="custSearch" placeholder="üîç T√¨m t√™n kh√°ch h√†ng ho·∫∑c khu v·ª±c..."
						oninput="filterLocalList()" style="padding-left: 40px;">
				</div>
				<div id="admin_toggle_container"
					style="display: none; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); padding: 5px 15px; border-radius: 12px; border: 1px solid var(--glass-border); height: 45px;">
					<label
						style="margin-bottom: 0; font-size: 0.75rem; white-space: nowrap; cursor: pointer; display: flex; align-items: center; gap: 8px;">
						<input type="checkbox" id="chk_view_all" onchange="loadCustomers(); loadCheckinHistory();"
							style="width: 18px; height: 18px; cursor: pointer;">
						Xem to√†n b·ªô (Admin)
					</label>
				</div>
			</div>
			<div style="overflow-x: auto;">
				<table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
					<thead>
						<tr
							style="text-align: left; color: var(--text-muted); border-bottom: 1px solid var(--glass-border);">
							<th style="padding: 10px; width: 30%;">KH√ÅCH H√ÄNG</th>
							<th style="padding: 10px;">PH√ÇN LO·∫†I</th>
							<th style="padding: 10px;">KHU V·ª∞C</th>
							<th style="padding: 10px;">SALES</th>
							<th style="padding: 10px;">TR·∫†NG TH√ÅI</th>
							<th style="padding: 10px; text-align: center;">THAO T√ÅC</th>
						</tr>
					</thead>
					<tbody id="customerTableBody">
						<!-- Rendered dynamically -->
					</tbody>
				</table>
			</div>
		</div>

		<!-- Custom CSS for Sub Tabs -->
		<style>
			.sub-tabs {
				display: flex;
				background: rgba(255, 255, 255, 0.05);
				padding: 4px;
				border-radius: 12px;
				margin-bottom: 20px;
			}

			.sub-tab-btn {
				flex: 1;
				padding: 10px;
				text-align: center;
				cursor: pointer;
				border-radius: 8px;
				font-size: 0.9rem;
				font-weight: 600;
				color: var(--text-muted);
				transition: 0.3s;
			}

			.sub-tab-btn.active {
				background: var(--primary);
				color: white;
			}

			.sub-tab-content {
				display: none;
				animation: fadeIn 0.3s ease;
			}

			.sub-tab-content.active {
				display: block;
			}
		</style>

		<!-- FORM 2: CHECK-IN -->
		<div id="formCheckin" class="form-card">
			<div class="sub-tabs">
				<div class="sub-tab-btn active" onclick="switchCheckinSubTab('form')">üìç Form Check-in</div>
				<div class="sub-tab-btn" onclick="switchCheckinSubTab('history')">üìú L·ªãch s·ª≠ ƒë√£ Check-in</div>
			</div>

			<!-- SUB TAB 1: FORM -->
			<div id="ci_tab_form" class="sub-tab-content active">
				<form id="checkinForm">
					<div class="form-group">
						<label>Th·ªùi gian Check-in</label>
						<input type="text" id="ci_time" readonly
							style="background: rgba(255,255,255,0.02); color: var(--text-muted);">
					</div>
					<div class="form-group">
						<label>Ch·ªçn Kh√°ch h√†ng *</label>
						<select id="ci_customer" required onchange="updateDistance()">
							<option value="">-- ƒêang t·∫£i danh s√°ch --</option>
						</select>
					</div>
					<div class="form-group">
						<label>M·ª•c ƒë√≠ch G·∫∑p m·∫∑t</label>
						<select id="ci_purpose">
							<option value="ThƒÉm h·ªèi ƒë·ªãnh k·ª≥">ThƒÉm h·ªèi ƒë·ªãnh k·ª≥</option>
							<option value="Ch√†o h√†ng m·ªõi">Ch√†o h√†ng m·ªõi</option>
							<option value="Ch√†o m·ªõi">Ch√†o m·ªõi</option>
							<option value="X·ª≠ l√Ω khi·∫øu n·∫°i">X·ª≠ l√Ω khi·∫øu n·∫°i</option>
							<option value="Thu n·ª£">Thu n·ª£</option>
						</select>
					</div>
					<div class="form-group">
						<label>Ghi ch√∫ k·∫øt qu·∫£</label>
						<textarea id="ci_note" rows="3" placeholder="Kh√°ch ch∆∞a l·∫•y h√†ng v√¨..."></textarea>
					</div>
					<div class="form-group">
						<label>·∫¢nh minh ch·ª©ng (Ch·ª•p ·∫£nh/T·∫£i l√™n) *</label>
						<input type="file" id="ci_file" accept="image/*">
					</div>
					<div class="form-group">
						<label>V·ªã tr√≠ Check-in</label>
						<div style="display: flex; gap: 10px;">
							<input type="text" id="ci_location" placeholder="T·ª± ƒë·ªông l·∫•y v·ªã tr√≠ ho·∫∑c d√°n th·ªß c√¥ng..."
								oninput="handleDirectLocationInput(this.value, 'checkin')">
						</div>
						<div id="gpsStatusCheckin" class="gps-status"></div>
					</div>
					<div class="form-group">
						<label>Kho·∫£ng c√°ch ∆∞·ªõc t√≠nh</label>
						<div id="ci_dist_display"
							style="font-weight: 800; color: var(--accent-purple); font-size: 1.2rem;">
							0 m</div>
					</div>
					<button type="submit" class="btn-submit" id="btnCI">X√°c Nh·∫≠n Check-in</button>
				</form>
			</div>

			<!-- SUB TAB 2: HISTORY -->
			<div id="ci_tab_history" class="sub-tab-content">
				<div class="history-list">
					<div class="filter-group">
						<div class="purpose-btn active" onclick="filterHistory('T·∫•t c·∫£', this)">T·∫•t c·∫£</div>
						<div class="purpose-btn" onclick="filterHistory('ThƒÉm h·ªèi ƒë·ªãnh k·ª≥', this)">ThƒÉm h·ªèi
						</div>
						<div class="purpose-btn" onclick="filterHistory('Ch√†o h√†ng m·ªõi', this)">Ch√†o h√†ng</div>
						<div class="purpose-btn" onclick="filterHistory('Ch√†o m·ªõi', this)">Ch√†o m·ªõi</div>
						<div class="purpose-btn" onclick="filterHistory('X·ª≠ l√Ω khi·∫øu n·∫°i', this)">Khi·∫øu n·∫°i
						</div>
						<div class="purpose-btn" onclick="filterHistory('Thu n·ª£', this)">Thu n·ª£</div>
					</div>
					<div id="checkinHistoryBody" style="max-height: 500px; overflow-y: auto; padding-right: 5px;">
						<p style="text-align: center; color: var(--text-muted); padding: 20px;">ƒêang t·∫£i l·ªãch s·ª≠...</p>
					</div>
				</div>
			</div>
		</div>

		<!-- FORM 2.5: MAP -->
		<div id="formMap" class="form-card">
			<div class="sub-tabs">
				<div class="sub-tab-btn active" onclick="switchMapSubTab('new_customers')">üë§ Kh√°ch m·ªõi</div>
				<div class="sub-tab-btn" onclick="switchMapSubTab('checkin')">üèÉ Check-in</div>
			</div>

			<div class="map-date-filters" style="display: flex; flex-direction: column; gap: 10px;">
				<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
					<div>
						<label>T·ª´ ng√†y</label>
						<input type="date" id="map_date_start" onchange="refreshMapData()">
					</div>
					<div>
						<label>ƒê·∫øn ng√†y</label>
						<input type="date" id="map_date_end" onchange="refreshMapData()">
					</div>
				</div>
				<button class="btn-glass" onclick="centerMapOnUser()"
					style="width: 100%; height: 45px; display: flex; align-items: center; justify-content: center; gap: 10px;">
					üéØ V·ªã tr√≠ c·ªßa t√¥i
				</button>
			</div>

			<div class="map-wrapper" id="mapWrapper">
				<div class="map-controls-overlay">
					<div class="map-search-box">
						<input type="text" id="mapSearchInput" placeholder="T√¨m t√™n kh√°ch h√†ng..."
							oninput="handleMapSearch(this.value)">
					</div>
					<div class="map-btn-group">
						<button class="btn-map-control" onclick="toggleMapFullscreen()" title="Ph√≥ng l·ªõn">üìê</button>
						<button class="btn-map-control" onclick="centerMapOnUser()" title="V·ªã tr√≠ hi·ªán t·∫°i">üéØ</button>
					</div>
				</div>
				<div id="map-container"></div>
				<div id="mapLegendWrapper" class="map-legend-wrapper">
					<div class="legend-header" onclick="toggleMapLegend()">
						<span>üé® Ph√¢n lo·∫°i</span>
						<span id="legendIcon">‚ñº</span>
					</div>
					<div id="mapLegend" class="map-legend-content"></div>
				</div>
			</div>
		</div>

		<!-- FORM 3: T√ÄI LI·ªÜU -->
		<div id="formDocs" class="form-card">
			<form id="docForm">
				<div class="form-group">
					<label>Ch·ªçn Kh√°ch h√†ng *</label>
					<select id="doc_customer" required>
						<option value="">-- ƒêang t·∫£i danh s√°ch --</option>
					</select>
				</div>
				<div class="form-group">
					<label>T√™n t√†i li·ªáu</label>
					<input type="text" id="doc_name" placeholder="Gi·∫•y ph√©p kinh doanh" required>
				</div>
				<div class="form-group">
					<label>Lo·∫°i t√†i li·ªáu</label>
					<select id="doc_type" onchange="updateAcceptAttr()">
						<option value="Gi·∫•y ph√©p KD">Gi·∫•y ph√©p KD (PDF/·∫¢nh)</option>
						<option value="H·ª£p ƒë·ªìng">H·ª£p ƒë·ªìng (PDF)</option>
						<option value="H√¨nh ·∫£nh">H√¨nh ·∫£nh</option>
						<option value="PDF">PDF</option>
					</select>
				</div>
				<div class="form-group">
					<label>T·∫£i t·ªáp l√™n (PDF/·∫¢nh) *</label>
					<input type="file" id="doc_file" required>
				</div>
				<div class="form-group">
					<label>Ghi ch√∫ th√™m</label>
					<textarea id="doc_note" rows="2"></textarea>
				</div>
				<button type="submit" class="btn-submit" id="btnDoc">Th√™m T√†i Li·ªáu</button>
			</form>
		</div>
	</div>

	<script>
		const CRM_URL = 'https://script.google.com/macros/s/AKfycbymqtjIrsThq1lxSbY5TwjxCBvAzNhEP9su2BfJIvE-DV55CnDXiSg7GwrBTaoae3Pg/exec';
		let currentUser = JSON.parse(localStorage.getItem('user'));
		let customerList = [];
		let checkinHistory = [];
		let currentPurposeFilter = 'T·∫•t c·∫£';
		let currentCoords = ""; // T·ªça ƒë·ªô d√πng cho form (c√≥ th·ªÉ l√† th·ªß c√¥ng/ƒë·ªãa ch·ªâ)
		let addressResults = [];
		let addressTimeout = null;
		let areaList = [];
		let liveCoords = ""; // V·ªã tr√≠ GPS th·ªùi gian th·ª±c
		let hiddenTypes = new Set(); // For map filtering

		const CLASSIFICATION_COLORS = {
			'T·∫•m nh·ª±a': '#facc15', // Yellow
			'C·ª≠a h√†ng nh·ª±a': '#facc15', // Yellow
			'T·∫•m s√†n': '#22c55e',  // Green
			'Nh√† m√°y t√¥n': '#22c55e', // Green
			'Keo silicon': '#3b82f6', // Blue
			'C·ª≠a h√†ng nh√¥m': '#3b82f6', // Blue
			'Kh√°c': '#94a3b8'
		};

		function getColorForType(type) {
			if (!type || type === "Ch∆∞a ph√¢n lo·∫°i") return '#ef4444'; // Red default
			if (CLASSIFICATION_COLORS[type]) return CLASSIFICATION_COLORS[type];

			// Simple hash for dynamic colors if type is new
			let hash = 0;
			for (let i = 0; i < type.length; i++) hash = type.charCodeAt(i) + ((hash << 5) - hash);
			const h = Math.abs(hash % 360);
			return `hsl(${h}, 70%, 60%)`;
		}

		if (!currentUser) window.location.href = 'auth.html';

		async function handleAddressAutocomplete(val) {
			const container = document.getElementById('addressSuggestions');
			if (!val || val.length < 3) {
				container.innerHTML = "";
				container.classList.add('hidden');
				return;
			}

			if (addressTimeout) clearTimeout(addressTimeout);
			addressTimeout = setTimeout(async () => {
				try {
					const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}&addressdetails=1&limit=5&countrycodes=vn`);
					addressResults = await res.json();
					if (addressResults.length > 0) {
						container.innerHTML = addressResults.map((item, i) => `
							<div class="suggestion-item" onclick="selectSuggestedAddress(${i})">${item.display_name}</div>
						`).join('');
						container.classList.remove('hidden');
					} else {
						container.classList.add('hidden');
					}
				} catch (e) { console.warn("L·ªói fetch ƒë·ªãa ch·ªâ", e); }
			}, 600);
		}

		function selectSuggestedAddress(idx) {
			const item = addressResults[idx];
			if (!item) return;

			document.getElementById('cust_address').value = item.display_name;

			// User request: DO NOT auto-fill GPS from address. Only manual GPS or Paste.

			// Tr√≠ch xu·∫•t khu v·ª±c (Huy·ªán/Th√†nh ph·ªë/T·ªânh)
			const addr = item.address;
			let areaSuggestion = addr.suburb || addr.city_district || addr.district || addr.town || addr.city || addr.state || "";

			// L√†m g·ªçn t√™n khu v·ª±c n·∫øu c√≥ (B·ªè d·∫•u ph·∫©y th·ª´a)
			document.getElementById('cust_area').value = areaSuggestion;

			document.getElementById('addressSuggestions').classList.add('hidden');
			// Removed automatic GPS success status
		}

		function captureGPS() {
			if (!liveCoords) {
				showToast("Ch∆∞a nh·∫≠n ƒë∆∞·ª£c t√≠n hi·ªáu GPS. Vui l√≤ng ƒë·ª£i ho·∫∑c ki·ªÉm tra quy·ªÅn v·ªã tr√≠.", true);
				return;
			}
			currentCoords = liveCoords;
			document.getElementById('cust_location').value = currentCoords;
			document.getElementById('gpsStatusCreate').innerHTML = "‚úÖ V·ªã tr√≠ ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n!";
			showToast("ƒê√£ l·∫•y v·ªã tr√≠ GPS hi·ªán t·∫°i!");
		}

		// ƒê√≥ng suggestion khi click ra ngo√†i
		document.addEventListener('click', (e) => {
			if (!e.target.closest('.form-group')) {
				document.getElementById('addressSuggestions').classList.add('hidden');
			}
		});

		// Helper: Convert File to Base64
		function fileToBase64(file) {
			return new Promise((resolve, reject) => {
				const reader = new FileReader();
				reader.readAsDataURL(file);
				reader.onload = () => resolve(reader.result.split(',')[1]);
				reader.onerror = error => reject(error);
			});
		}

		async function uploadToDrive(file) {
			if (!file) return null;
			const base64 = await fileToBase64(file);
			const isPdf = file.name.toLowerCase().endsWith('.pdf');
			const res = await fetch(CRM_URL, {
				method: 'POST',
				body: JSON.stringify({
					action: 'uploadFile',
					filename: file.name,
					mimetype: file.type,
					base64: base64,
					type: isPdf ? 'pdf' : 'image'
				})
			});
			const data = await res.json();
			return data.success ? data.url : null;
		}

		function handleDirectLocationInput(val, type = 'create') {
			if (val.includes(',') && val.length > 5) {
				const displayId = type === 'create' ? 'gpsStatusCreate' : 'gpsStatusCheckin';
				document.getElementById(displayId).innerHTML = "‚úÖ ƒê√£ nh·∫≠n di·ªán t·ªça ƒë·ªô th·ªß c√¥ng";

				if (type === 'create') {
					currentCoords = val.trim();
				} else {
					updateDistance();
				}
			}
		}

		function updateAcceptAttr() {
			const type = document.getElementById('doc_type').value;
			const input = document.getElementById('doc_file');
			if (type === 'H√¨nh ·∫£nh') input.accept = "image/*";
			else if (type === 'H·ª£p ƒë·ªìng' || type === 'PDF') input.accept = ".pdf";
			else input.accept = "image/*, .pdf";
		}

		function showToast(msg, isError = false) {
			const t = document.getElementById('toast');
			t.innerText = msg;
			t.style.background = isError ? '#ef4444' : '#22c55e';
			t.classList.add('active');
			setTimeout(() => t.classList.remove('active'), 3000);
		}

		function switchTab(tab) {
			document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
			document.querySelectorAll('.form-card').forEach(c => c.classList.remove('active'));

			if (tab === 'create') {
				document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
				document.getElementById('formCreate').classList.add('active');
				// N·∫øu kh√¥ng ph·∫£i ƒëang Edit th√¨ reset form v·ªÅ ch·∫ø ƒë·ªô Create
				if (!document.getElementById('edit_cust_id').value) {
					document.getElementById('formTitle').innerText = "üÜï T·∫°o Kh√°ch H√†ng M·ªõi";
					document.getElementById('btnCust').innerText = "L∆∞u Kh√°ch H√†ng";
				}
				loadAreas();
			} else if (tab === 'list') {
				document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
				document.getElementById('formList').classList.add('active');
				loadCustomers();
			} else if (tab === 'checkin') {
				document.querySelector('.tab-btn:nth-child(3)').classList.add('active');
				document.getElementById('formCheckin').classList.add('active');
				loadCustomers();
				loadCheckinHistory();
			} else if (tab === 'map') {
				document.querySelector('.tab-btn:nth-child(4)').classList.add('active');
				document.getElementById('formMap').classList.add('active');
				initMap();
			} else {
				document.querySelector('.tab-btn:nth-child(5)').classList.add('active');
				document.getElementById('formDocs').classList.add('active');
				loadCustomers();
			}
		}

		// Sub-tab Logic
		function switchCheckinSubTab(tab) {
			document.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
			document.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));

			if (tab === 'form') {
				document.querySelector('.sub-tab-btn:nth-child(1)').classList.add('active');
				document.getElementById('ci_tab_form').classList.add('active');
			} else {
				document.querySelector('.sub-tab-btn:nth-child(2)').classList.add('active');
				document.getElementById('ci_tab_history').classList.add('active');
				loadCheckinHistory(); // Refresh when switching to history
			}
		}

		// Live Clock for Check-in Form
		setInterval(() => {
			const now = new Date();
			const timeStr = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) + ' ' + now.toLocaleDateString('vi-VN');
			const el = document.getElementById('ci_time');
			if (el) el.value = timeStr;
		}, 1000);

		// GPS Logic

		function initGPS(forceLowAccuracy = false) {
			if (!navigator.geolocation) {
				const noGpsMsg = "‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã GPS.";
				showToast(noGpsMsg, true);
				updateGPSUI(noGpsMsg, "error");
				return;
			}

			updateGPSUI("‚åõ ƒêang t√¨m ki·∫øm t√≠n hi·ªáu GPS...", "searching");

			// Clear existing observer if any (to prevent multiple parallel watchers)
			if (window.gpsWatcherId) navigator.geolocation.clearWatch(window.gpsWatcherId);

			window.gpsWatcherId = navigator.geolocation.watchPosition(
				pos => {
					liveCoords = `${pos.coords.latitude}, ${pos.coords.longitude}`;

					// Update form inputs
					const ciLoc = document.getElementById('ci_location');
					if (ciLoc) ciLoc.value = liveCoords;

					// Update UI Status
					updateGPSUI("‚úÖ T√≠n hi·ªáu GPS s·∫µn s√†ng", "success");

					const btn = document.getElementById('btnCust');
					if (btn) {
						btn.disabled = false;
						if (!document.getElementById('edit_cust_id').value) btn.innerText = "L∆∞u Kh√°ch H√†ng";
					}

					if (typeof updateDistance === 'function') updateDistance();
					if (typeof updateUserLocationMarker === 'function') updateUserLocationMarker();
				},
				err => {
					// Quietly handle timeout retry without spamming console errors
					if (err.code === 3 && !forceLowAccuracy) {
						console.log("GPS Timeout (High Accuracy). Switching to backup mode...");
						setTimeout(() => initGPS(true), 1000);
						return;
					}

					console.warn("GPS Error Callback:", err);

					// Detailed logging for debugging
					let diagnosticInfo = `Code: ${err.code}, Msg: ${err.message}`;
					if (err.code === 2) diagnosticInfo += " (V·ªã tr√≠ ch∆∞a x√°c ƒë·ªãnh - kCLErrorLocationUnknown)";
					console.error("GPS Diagnostics:", diagnosticInfo);

					let errorMsg = "‚ö†Ô∏è Kh√¥ng l·∫•y ƒë∆∞·ª£c GPS.";
					let isFatal = false;

					if (err.code === 1) {
						errorMsg = "üö´ Vui l√≤ng cho ph√©p quy·ªÅn truy c·∫≠p GPS trong c√†i ƒë·∫∑t tr√¨nh duy·ªát.";
						isFatal = true;
					} else if (err.code === 3) {
						errorMsg = "‚åõ T√≠n hi·ªáu y·∫øu ho·∫∑c ƒëang ·ªü trong nh√†. ƒêang chuy·ªÉn sang ch·∫ø ƒë·ªô d·ª± ph√≤ng...";
					}

					showToast(errorMsg, true);
					updateGPSUI(errorMsg + ' <button onclick="initGPS()" style="margin-left:10px; padding:2px 8px; font-size:10px; background:var(--primary); border:none; border-radius:4px; color:white; pointer-events:auto; cursor:pointer;">Th·ª≠ l·∫°i</button>', "error");

					const btn = document.getElementById('btnCust');
					if (btn) btn.disabled = false;
				},
				{
					enableHighAccuracy: !forceLowAccuracy,
					timeout: forceLowAccuracy ? 10000 : 30000,
					maximumAge: 10000
				}
			);
		}

		function updateGPSUI(html, statusClass) {
			const stCreate = document.getElementById('gpsStatusCreate');
			const stCheckin = document.getElementById('gpsStatusCheckin');

			[stCreate, stCheckin].forEach(el => {
				if (el) {
					el.innerHTML = html;
					el.className = `gps-status ${statusClass}`;
				}
			});
		}

		// --- MAP LOGIC ---
		let mainMap = null;
		let userMarker = null;
		let currentMapTab = 'new_customers';

		function initMap() {
			if (!mainMap) {
				mainMap = L.map('map-container', {
					zoomControl: true,
					tap: false // Better for mobile
				}).setView([10.8231, 106.6297], 13);

				L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png', {
					attribution: '&copy; OpenStreetMap contributors'
				}).addTo(mainMap);

				// Style fix for maps in hidden tabs
				setTimeout(() => mainMap.invalidateSize(), 400);
			} else {
				setTimeout(() => mainMap.invalidateSize(), 100);
			}

			updateUserLocationMarker();
			refreshMapData();
		}

		// Icon Definitions
		const storeIcon = L.divIcon({
			className: 'custom-marker',
			html: `<div style="background: var(--primary); width: 30px; height: 30px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
                    <div style="transform: rotate(45deg); font-size: 14px;">üè™</div>
                   </div>`,
			iconSize: [30, 30],
			iconAnchor: [15, 30]
		});

		const checkinMarkerIcon = L.divIcon({
			className: 'custom-marker',
			html: `<div style="background: var(--accent-purple); width: 30px; height: 30px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
                    <div style="transform: rotate(45deg); font-size: 14px;">üìç</div>
                   </div>`,
			iconSize: [30, 30],
			iconAnchor: [15, 30]
		});

		function updateUserLocationMarker() {
			if (!mainMap || !liveCoords) return;
			const coords = liveCoords.split(',').map(n => parseFloat(n.trim()));
			if (isNaN(coords[0])) return;

			if (!userMarker) {
				userMarker = L.circleMarker(coords, {
					radius: 10,
					fillColor: "#3b82f6",
					color: "#fff",
					weight: 3,
					opacity: 1,
					fillOpacity: 0.9,
					className: 'user-pulse-marker'
				}).addTo(mainMap);
				userMarker.bindTooltip("B·∫°n ƒëang ·ªü ƒë√¢y", { permanent: false, direction: 'top' });
			} else {
				userMarker.setLatLng(coords);
			}
		}

		function centerMapOnUser() {
			if (!mainMap) return;

			if (liveCoords) {
				const coords = liveCoords.split(',').map(n => parseFloat(n.trim()));
				mainMap.flyTo(coords, 17);
				updateUserLocationMarker();
			} else {
				showToast("üåç ƒêang c·ªë g·∫Øng x√°c ƒë·ªãnh v·ªã tr√≠... Vui l√≤ng ƒë·ª£i.", false);
				navigator.geolocation.getCurrentPosition(pos => {
					liveCoords = `${pos.coords.latitude}, ${pos.coords.longitude}`;
					const coords = [pos.coords.latitude, pos.coords.longitude];
					mainMap.flyTo(coords, 17);
					updateUserLocationMarker();
					showToast("‚úÖ ƒê√£ t√¨m th·∫•y v·ªã tr√≠!");
				}, err => {
					showToast("‚ùå Kh√¥ng th·ªÉ x√°c ƒë·ªãnh v·ªã tr√≠. Vui l√≤ng ki·ªÉm tra quy·ªÅn GPS.", true);
				}, { enableHighAccuracy: true, timeout: 10000 });
			}
		}

		function switchMapSubTab(tab) {
			currentMapTab = tab;
			document.querySelectorAll('#formMap .sub-tab-btn').forEach((b, i) => {
				b.classList.toggle('active', (tab === 'new_customers' && i === 0) || (tab === 'checkin' && i === 1));
			});
			refreshMapData();
		}

		function toggleMapFullscreen() {
			const wrapper = document.getElementById('mapWrapper');
			wrapper.classList.toggle('fullscreen');
			setTimeout(() => {
				if (mainMap) mainMap.invalidateSize();
			}, 400);
		}

		function handleMapSearch(q) {
			if (!q || q.length < 2 || !mainMap) return;
			const query = q.toLowerCase();
			const match = customerList.find(c => c.name.toLowerCase().includes(query));
			if (match && match.location) {
				const coords = match.location.split(',').map(n => parseFloat(n.trim()));
				mainMap.flyTo(coords, 17);
			}
		}

		function toggleTypeFilter(type) {
			if (hiddenTypes.has(type)) hiddenTypes.delete(type);
			else hiddenTypes.add(type);
			refreshMapData();
		}

		function toggleMapLegend() {
			const wrapper = document.getElementById('mapLegendWrapper');
			const icon = document.getElementById('legendIcon');
			if (wrapper) {
				wrapper.classList.toggle('collapsed');
				const isCollapsed = wrapper.classList.contains('collapsed');
				if (icon) icon.innerText = isCollapsed ? '‚ñ≤' : '‚ñº';
			}
		}

		function parseDateVN(str) {
			if (!str) return null;
			// HH:mm dd/MM/yyyy or dd/MM/yyyy
			const datePart = str.includes(' ') ? str.split(' ')[1] : str;
			const [d, m, y] = datePart.split('/');
			if (!d || !m || !y) return null;
			return new Date(`${y}-${m}-${d}`);
		}

		async function refreshMapData() {
			if (!mainMap) return;

			// Clear layers, except user marker
			mainMap.eachLayer(layer => {
				if ((layer instanceof L.Marker || layer instanceof L.CircleMarker) && layer !== userMarker) {
					mainMap.removeLayer(layer);
				}
			});

			const start = document.getElementById('map_date_start').value ? new Date(document.getElementById('map_date_start').value) : null;
			const end = document.getElementById('map_date_end').value ? new Date(document.getElementById('map_date_end').value) : null;

			// Update Legend
			const types = [...new Set(customerList.map(c => c.phanLoai || "Ch∆∞a ph√¢n lo·∫°i"))];
			const legend = document.getElementById('mapLegend');
			legend.innerHTML = types.map(t => {
				const color = getColorForType(t);
				const isHidden = hiddenTypes.has(t);
				return `
					<div class="legend-item ${isHidden ? 'hidden' : ''}" onclick="toggleTypeFilter('${t}')" title="${t}">
						<span class="legend-color" style="background: ${color}"></span>
						<span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${t}</span>
					</div>
				`;
			}).join('');

			// Ensure we have current filtered data
			if (customerList.length === 0) await loadCustomers();
			// Only load history if we are on checkin tab to save bandwidth
			if (currentMapTab === 'checkin' && checkinHistory.length === 0) await loadCheckinHistory();

			const markerGroup = [];

			if (currentMapTab === 'new_customers') {
				customerList.forEach(c => {
					const type = c.phanLoai || "Ch∆∞a ph√¢n lo·∫°i";
					if (hiddenTypes.has(type)) return;

					const date = parseDateVN(c.ngay_tao);
					if (start && date && date < start) return;
					if (end && date && date > end) return;

					if (c.location && c.location.includes(',')) {
						const coords = c.location.split(',').map(n => parseFloat(n.trim()));
						if (!isNaN(coords[0])) {
							const color = getColorForType(type);
							const customIcon = L.divIcon({
								html: `<div style="background-color: ${color}; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>`,
								className: 'custom-dot-icon',
								iconSize: [14, 14],
								iconAnchor: [7, 7]
							});

							const marker = L.marker(coords, { icon: customIcon }).addTo(mainMap);
							marker.bindPopup(`
									<div class="map-popup-card">
										<h3 style="color: ${color}">${c.name}</h3>
										<p>üè∑Ô∏è <b>${type}</b></p>
										<p>üìç ${c.address}</p>
										<p>üìÖ T·∫°o ng√†y: ${c.ngay_tao}</p>
										<button class="btn-popup" style="background: ${color}" onclick="openDetailFromMap('${c._internal_id}')">Chi ti·∫øt kh√°ch</button>
									</div>
								`, { closeButton: false });
							marker.bindTooltip(c.name, { permanent: false, direction: 'top', offset: [0, -10] });
							markerGroup.push(marker);
						}
					}
				});
			} else {
				checkinHistory.forEach(ci => {
					const cust = customerList.find(c => c.id === ci.customer_id);
					const type = cust ? (cust.phanLoai || "Ch∆∞a ph√¢n lo·∫°i") : "Ch∆∞a ph√¢n lo·∫°i";
					if (hiddenTypes.has(type)) return;

					const date = parseDateVN(ci.thoi_gian_checkin);
					if (start && date && date < start) return;
					if (end && date && date > end) return;

					if (ci.vi_tri_checkin && ci.vi_tri_checkin.includes(',')) {
						const coords = ci.vi_tri_checkin.split(',').map(n => parseFloat(n.trim()));
						if (!isNaN(coords[0])) {
							const color = getColorForType(type);
							const customIcon = L.divIcon({
								html: `<div style="background-color: ${color}; width: 18px; height: 18px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 8px ${color}80; display:flex; align-items:center; justify-content:center; color:white; font-size:10px;">üìç</div>`,
								className: 'custom-checkin-icon',
								iconSize: [20, 20],
								iconAnchor: [10, 10]
							});

							const marker = L.marker(coords, { icon: customIcon }).addTo(mainMap);
							marker.bindPopup(`
									<div class="map-popup-card">
										<h3 style="color: ${color}">Check-in: ${cust ? cust.name : 'Kh√°ch l·∫°'}</h3>
										<p>üéØ ${ci.muc_dich_gap_mat}</p>
										<p>üïí ${ci.thoi_gian_checkin}</p>
										<button class="btn-popup" style="background: ${color}" onclick="openCheckinDetailFromMap('${ci.checkin_id}')">Xem k·∫øt qu·∫£</button>
									</div>
								`, { closeButton: false });
							markerGroup.push(marker);
						}
					}
				});
			}

			// Auto-zoom to fit all markers if any
			if (markerGroup.length > 0) {
				const group = L.featureGroup(markerGroup);
				mainMap.fitBounds(group.getBounds().pad(0.2));
			}
		}

		function openDetailFromMap(uid) {
			viewCustomerDetail(uid);
		}

		function openCheckinDetailFromMap(id) {
			const ci = checkinHistory.find(x => x.checkin_id === id);
			if (ci) showCheckinDetail(ci);
		}


		async function loadAreas() {
			try {
				const currentUser = JSON.parse(localStorage.getItem('user'));
				const viewAll = document.getElementById('chk_view_all').checked;

				const res = await fetch(CRM_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'getAreas',
						salesId: currentUser.email,
						isAdmin: currentUser.roleId === 'R001',
						viewAll: viewAll
					})
				});
				const data = await res.json();
				if (data.success && data.areas) {
					areaList = data.areas;
					const options = areaList.map(a => `<option value="${a}">${a}</option>`).join('');
					document.getElementById('area_list').innerHTML = options;
				}
			} catch (e) { console.error("L·ªói t·∫£i khu v·ª±c", e); }
		}

		async function loadCustomers() {
			try {
				const currentUser = JSON.parse(localStorage.getItem('user'));
				const viewAll = document.getElementById('chk_view_all').checked;

				const res = await fetch(CRM_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'getCustomers',
						salesId: currentUser.email,
						isAdmin: currentUser.roleId === 'R001',
						viewAll: viewAll
					})
				});
				const data = await res.json();
				if (data.success) {
					// Assign unique internal ID to handle duplicate real IDs in Sheet
					customerList = data.customers.map((c, i) => ({ ...c, _internal_id: `uid_${i}_${Date.now()}` }));
					renderCustomerTable(customerList);

					// Populate Classification Choice List based on user's own items
					const userCategories = [...new Set(customerList
						.filter(c => c.salesOwner === currentUser.email)
						.map(c => c.phanLoai)
						.filter(v => v && v !== "Ch∆∞a ph√¢n lo·∫°i")
					)];
					const typeList = document.getElementById('type_list');
					if (typeList) {
						typeList.innerHTML = userCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
					}

					const options = '<option value="">-- Ch·ªçn kh√°ch h√†ng --</option>' +
						customerList.map(c => `<option value="${c.id}" data-loc="${c.location}">${c.name}</option>`).join('');
					const ciCust = document.getElementById('ci_customer');
					const docCust = document.getElementById('doc_customer');
					if (ciCust) ciCust.innerHTML = options;
					if (docCust) docCust.innerHTML = options;
				}
			} catch (e) { showToast("L·ªói t·∫£i kh√°ch h√†ng!", true); }
		}

		async function loadCheckinHistory() {
			try {
				const currentUser = JSON.parse(localStorage.getItem('user'));
				const viewAll = document.getElementById('chk_view_all').checked;

				const res = await fetch(CRM_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'getCheckinHistory',
						salesId: currentUser.email,
						isAdmin: currentUser.roleId === 'R001',
						viewAll: viewAll
					})
				});
				const data = await res.json();
				if (data.success) {
					// Ensure sorted by time descending (Newest first)
					checkinHistory = (data.history || []).sort((a, b) => new Date(b.time) - new Date(a.time));
					applyHistoryFilters();
				} else {
					document.getElementById('checkinHistoryBody').innerHTML =
						`<p style="text-align: center; color: var(--danger); padding: 20px;">L·ªói: ${data.message}</p>`;
				}
			} catch (e) {
				console.error("L·ªói t·∫£i l·ªãch s·ª≠", e);
				document.getElementById('checkinHistoryBody').innerHTML =
					'<p style="text-align: center; color: var(--danger); padding: 20px;">L·ªói k·∫øt n·ªëi m√°y ch·ªß.</p>';
			}
		}

		function filterHistory(purpose, el) {
			currentPurposeFilter = purpose;
			document.querySelectorAll('.purpose-btn').forEach(b => b.classList.remove('active'));
			el.classList.add('active');
			applyHistoryFilters();
		}

		function applyHistoryFilters() {
			const filtered = currentPurposeFilter === 'T·∫•t c·∫£'
				? checkinHistory
				: checkinHistory.filter(h => h.purpose === currentPurposeFilter);

			body.innerHTML = filtered.map(h => {
				const imgUrl = h.image || 'https://placehold.co/100x100/1e293b/white?text=No+Img';
				const directImg = (imgUrl.includes('drive.google.com'))
					? `https://drive.google.com/uc?export=view&id=${imgUrl.match(/[-\w]{25,}/)}`
					: imgUrl;

				return `
					<div class="history-item clickable-row" onclick="viewCheckinDetail('${h.id}')">
						<img src="${directImg}" 
							 class="history-img" onerror="this.src='https://placehold.co/100x100/1e293b/white?text=Error'" 
							 onclick="event.stopPropagation(); zoomImage(this.src)">
						<div class="history-info">
							<div class="history-name">${h.customerName}</div>
							<div class="history-meta">
								<span>${formatTime(h.time)}</span>
								<span class="history-purpose">${h.purpose}</span>
							</div>
							<div style="font-size: 0.8rem; margin-top: 5px; color: var(--text-muted); line-height: 1.4;">${h.note || 'Kh√¥ng c√≥ ghi ch√∫'}</div>
						</div>
					</div>
				`;
			}).join('');
		}

		function zoomImage(src) {
			document.getElementById('zoomImg').src = src;
			document.getElementById('zoomModal').classList.add('active');
		}

		function closeZoom() {
			document.getElementById('zoomModal').classList.remove('active');
		}

		function formatTime(iso) {
			if (!iso) return '';
			try {
				const d = new Date(iso);
				if (isNaN(d.getTime())) return iso; // Tr·∫£ v·ªÅ text g·ªëc n·∫øu kh√¥ng parse ƒë∆∞·ª£c date
				return d.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) + ' ' + d.toLocaleDateString('vi-VN');
			} catch (e) { return iso; }
		}

		function renderCustomerTable(list) {
			const body = document.getElementById('customerTableBody');
			body.innerHTML = list.map(c => `
				<tr class="clickable-row" style="border-bottom: 1px solid rgba(255,255,255,0.05);">
					<td style="padding: 12px;" onclick="viewCustomerDetail('${c._internal_id}')">
						<div style="font-weight: 600;">${c.name}</div>
						<div style="font-size: 0.75rem; color: var(--text-muted);">${c.address}</div>
					</td>
					<td style="padding: 12px; font-size: 0.8rem; color: var(--primary); font-weight: 600;" onclick="viewCustomerDetail('${c._internal_id}')">${c.phanLoai || '-'}</td>
					<td style="padding: 12px; color: var(--accent-purple); font-size: 0.8rem;" onclick="viewCustomerDetail('${c._internal_id}')">${c.area}</td>
					<td style="padding: 12px; font-size: 0.8rem; color: var(--text-muted);" onclick="viewCustomerDetail('${c._internal_id}')">${c.salesOwner || 'N/A'}</td>
					<td style="padding: 12px;" onclick="viewCustomerDetail('${c._internal_id}')">
						<span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 4px 8px; border-radius: 6px; font-size: 0.7rem;">${c.status}</span>
					</td>
					<td style="padding: 12px; text-align: center;">
						<div style="display: flex; gap: 8px; justify-content: center;">
							<button class="btn-glass" onclick="editCustomer('${c._internal_id}')" style="padding: 5px 10px; font-size: 0.8rem;" title="S·ª≠a">‚úèÔ∏è</button>
							<button class="btn-glass" onclick="deleteCustomer('${c._internal_id}')" style="padding: 5px 10px; font-size: 0.8rem; color: #ef4444;" title="X√≥a">üóëÔ∏è</button>
						</div>
					</td>
				</tr>
			`).join('');
		}

		function editCustomer(uid) {
			const c = customerList.find(x => x._internal_id === uid);
			if (!c) return;

			document.getElementById('formTitle').innerText = "‚úèÔ∏è Ch·ªânh S·ª≠a Kh√°ch H√†ng";
			document.getElementById('edit_cust_id').value = c.id;
			document.getElementById('cust_name').value = c.name;
			document.getElementById('cust_contact').value = c.contact || "";
			document.getElementById('cust_phone').value = c.phone || "";
			document.getElementById('cust_email').value = c.email || "";
			document.getElementById('cust_address').value = c.address;
			document.getElementById('cust_area').value = c.area;
			document.getElementById('cust_type').value = c.phanLoai || "";

			// Gi·ªØ nguy√™n t·ªça ƒë·ªô c≈©, kh√¥ng ghi ƒë√® t·ª± ƒë·ªông
			currentCoords = c.location || "";
			document.getElementById('cust_location').value = currentCoords;
			document.getElementById('btnGetGPS').innerText = "L·∫•y GPS m·ªõi";
			document.getElementById('gpsStatusCreate').innerHTML = "‚úÖ ƒêang s·ª≠ d·ª•ng v·ªã tr√≠ ƒë√£ l∆∞u";

			document.getElementById('btnCust').innerText = "C·∫≠p Nh·∫≠t Kh√°ch H√†ng";
			document.getElementById('btnCust').disabled = false;
			switchTab('create');
		}

		function resetCustomerForm() {
			document.getElementById('customerForm').reset();
			document.getElementById('edit_cust_id').value = "";
			document.getElementById('formTitle').innerText = "üÜï T·∫°o Kh√°ch H√†ng M·ªõi";
			document.getElementById('btnCust').innerText = "L∆∞u Kh√°ch H√†ng";
			currentCoords = "";
			document.getElementById('cust_location').value = "";
		}

		async function deleteCustomer(uid) {
			const c = customerList.find(x => x._internal_id === uid);
			if (!c) return;

			if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√°ch h√†ng "${c.name}"?`)) return;

			try {
				const res = await fetch(CRM_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'deleteCustomer',
						id: c.id
					})
				});
				const data = await res.json();
				if (data.success) {
					showToast("ƒê√£ x√≥a kh√°ch h√†ng!");
					loadCustomers();
				} else {
					showToast("L·ªói: " + data.message, true);
				}
			} catch (e) {
				showToast("L·ªói k·∫øt n·ªëi khi x√≥a!", true);
			}
		}

		function viewCustomerDetail(uid) {
			const c = customerList.find(x => x._internal_id === uid);
			if (!c) return;

			// Populate Data
			document.getElementById('det_name').innerText = c.name;
			document.getElementById('det_id').innerText = `ID: ${c.id}`;
			document.getElementById('det_contact').innerText = c.contact || 'Ch∆∞a c·∫≠p nh·∫≠t';
			document.getElementById('det_phone').innerText = c.phone || 'N/A';
			document.getElementById('det_address').innerText = c.address;
			document.getElementById('det_area').innerText = `üìç ${c.area}`;
			document.getElementById('det_location').innerText = c.location || 'N/A';
			document.getElementById('det_type').innerText = c.phanLoai || 'Ch∆∞a ph√¢n lo·∫°i';
			document.getElementById('det_status').innerText = c.status;

			// Handle History
			const hist = checkinHistory.filter(h => h.customerId === c.id); // Use c.id here
			const histContainer = document.getElementById('det_history');
			if (hist.length > 0) {
				histContainer.innerHTML = '<h3 style="font-size: 1rem; margin-bottom: 15px;">Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h3>' +
					hist.slice(0, 3).map(h => `
						<div class="history-item" style="margin-bottom: 8px; padding: 10px;">
							<div class="history-info">
								<div class="history-meta">
									<span>${formatTime(h.time)}</span>
									<span class="history-purpose">${h.purpose}</span>
								</div>
								<div style="font-size: 0.8rem; margin-top: 3px;">${h.note || ''}</div>
							</div>
						</div>
					`).join('');
			} else {
				histContainer.innerHTML = '';
			}

			document.getElementById('detailOverlay').classList.add('active');
		}

		function closeDetail() {
			document.getElementById('detailOverlay').classList.remove('active');
		}

		function viewCheckinDetail(id) {
			const h = checkinHistory.find(x => x.id === id);
			if (!h) return;

			document.getElementById('ci_det_name').innerText = h.customerName;
			document.getElementById('ci_det_time').innerText = formatTime(h.time);
			document.getElementById('ci_det_purpose').innerText = h.purpose;
			document.getElementById('ci_det_dist').innerText = h.distance + " m";
			document.getElementById('ci_det_loc').innerText = h.location;
			document.getElementById('ci_det_note').innerText = h.note || "Kh√¥ng c√≥ ghi ch√∫";

			const detailImg = h.image || '';
			const directDetailImg = (detailImg.includes('drive.google.com'))
				? `https://drive.google.com/uc?export=view&id=${detailImg.match(/[-\w]{25,}/)}`
				: detailImg;
			document.getElementById('ci_det_img').src = directDetailImg;

			// Store location for map button
			document.getElementById('checkinDetailOverlay').setAttribute('data-loc', h.location);

			document.getElementById('checkinDetailOverlay').classList.add('active');
		}

		function closeCheckinDetail() {
			document.getElementById('checkinDetailOverlay').classList.remove('active');
		}

		function openCheckinMap() {
			const loc = document.getElementById('checkinDetailOverlay').getAttribute('data-loc');
			if (loc) window.open(`https://www.google.com/maps?q=${loc}`, '_blank');
		}

		function openInGoogleMaps() {
			const loc = document.getElementById('det_location').innerText;
			if (loc && loc !== 'N/A') {
				window.open(`https://www.google.com/maps?q=${loc}`, '_blank');
			} else {
				showToast("Kh√°ch h√†ng n√†y ch∆∞a c√≥ t·ªça ƒë·ªô GPS!", true);
			}
		}

		function filterLocalList() {
			const q = document.getElementById('custSearch').value.toLowerCase();
			const filtered = customerList.filter(c =>
				c.name.toLowerCase().includes(q) ||
				c.area.toLowerCase().includes(q) ||
				c.id.toLowerCase().includes(q)
			);
			renderCustomerTable(filtered);
		}

		function haversine(loc1, loc2) {
			if (!loc1 || !loc2) return 0;
			const [lat1, lon1] = loc1.split(',').map(Number);
			const [lat2, lon2] = loc2.split(',').map(Number);
			const R = 6371e3;
			const dLat = (lat2 - lat1) * Math.PI / 180;
			const dLon = (lon2 - lon1) * Math.PI / 180;
			const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
			return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
		}

		function updateDistance() {
			const sel = document.getElementById('ci_customer');
			const opt = sel.options[sel.selectedIndex];
			if (!opt || !opt.value) return;
			const custLoc = opt.getAttribute('data-loc');
			const dist = haversine(custLoc, liveCoords);
			document.getElementById('ci_dist_display').innerText = dist + " m";

			// X√≥a n√∫t c·∫≠p nh·∫≠t c≈© n·∫øu c√≥
			const oldBtn = document.getElementById('btnSmartUpdate');
			if (oldBtn) oldBtn.remove();

			if (dist > 500) {
				document.getElementById('ci_dist_display').style.color = '#ef4444';
				showToast("C·∫£nh b√°o: V·ªã tr√≠ l∆∞u qu√° xa (>500m)", true);

				// Th√™m n√∫t C·∫≠p nh·∫≠t nhanh
				const container = document.getElementById('ci_dist_display').parentNode;
				const btn = document.createElement('button');
				btn.id = 'btnSmartUpdate';
				btn.className = 'btn-glass';
				btn.innerHTML = 'üîÑ C·∫≠p nh·∫≠t t·ªça ƒë·ªô g·ªëc ngay';
				btn.style.marginTop = '10px';
				btn.style.width = '100%';
				btn.style.background = 'rgba(239, 68, 68, 0.2)';
				btn.style.color = '#ef4444';
				btn.style.fontSize = '0.85rem';
				btn.onclick = () => smartUpdateLocation(opt.value);
				container.appendChild(btn);
			} else {
				document.getElementById('ci_dist_display').style.color = '#22c55e';
			}
		}

		async function smartUpdateLocation(custId) {
			if (!confirm("B·∫°n ƒëang ƒë·ª©ng t·∫°i ƒë√∫ng c·ª≠a h√†ng? H√†nh ƒë·ªông n√†y s·∫Ω c·∫≠p nh·∫≠t l·∫°i t·ªça ƒë·ªô g·ªëc c·ªßa kh√°ch h√†ng theo v·ªã tr√≠ hi·ªán t·∫°i c·ªßa b·∫°n.")) return;

			const btn = document.getElementById('btnSmartUpdate');
			btn.disabled = true;
			btn.innerHTML = "ƒêang c·∫≠p nh·∫≠t...";

			try {
				const res = await fetch(CRM_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'updateCustomerLocation',
						id: custId,
						location: document.getElementById('ci_location').value
					})
				});
				const data = await res.json();
				if (data.success) {
					showToast("ƒê√£ c·∫≠p nh·∫≠t t·ªça ƒë·ªô m·ªõi th√†nh c√¥ng!");
					btn.remove();
					// Reload customers to update data-loc
					await loadCustomers();
					// Reselect customer
					document.getElementById('ci_customer').value = custId;
					updateDistance();
				} else {
					showToast("L·ªói: " + data.message, true);
					btn.disabled = false;
					btn.innerHTML = 'üîÑ C·∫≠p nh·∫≠t t·ªça ƒë·ªô g·ªëc ngay';
				}
			} catch (e) {
				showToast("L·ªói k·∫øt n·ªëi", true);
				btn.disabled = false;
			}
		}

		// Form Handlers
		// Form Handlers
		document.getElementById('customerForm').onsubmit = async (e) => {
			e.preventDefault();
			const btn = document.getElementById('btnCust');

			// Prevent double submission if already processing
			if (btn.disabled || btn.getAttribute('data-processing') === 'true') return;

			btn.disabled = true;
			btn.setAttribute('data-processing', 'true');
			const originalText = btn.innerText;
			btn.innerText = "‚è≥ ƒêang l∆∞u...";

			try {
				const editId = document.getElementById('edit_cust_id').value;
				const payload = {
					action: editId ? 'updateCustomer' : 'createCustomer',
					id: editId || undefined,
					name: document.getElementById('cust_name').value,
					contact: document.getElementById('cust_contact').value,
					phone: document.getElementById('cust_phone').value,
					email: document.getElementById('cust_email').value,
					address: document.getElementById('cust_address').value,
					location: currentCoords,
					salesId: currentUser.email,
					area: document.getElementById('cust_area').value,
					phan_loai: document.getElementById('cust_type').value
				};

				const res = await fetch(CRM_URL, { method: 'POST', body: JSON.stringify(payload) });
				const data = await res.json();

				if (data.success) {
					showToast(editId ? "ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!" : "ƒê√£ t·∫°o kh√°ch h√†ng th√†nh c√¥ng!");
					resetCustomerForm();
					loadCustomers();
					loadAreas();
				} else {
					showToast("L·ªói: " + data.message, true);
				}
			} catch (error) {
				console.error(error);
				showToast("L·ªói k·∫øt n·ªëi ho·∫∑c x·ª≠ l√Ω!", true);
			} finally {
				// Always unlock the button, even on error
				btn.disabled = false;
				btn.removeAttribute('data-processing');
				// Only restore text if form wasn't reset (which sets it to "L∆∞u Kh√°ch H√†ng")
				// Check if we are still in edit mode or not
				const currentEditId = document.getElementById('edit_cust_id').value;
				if (currentEditId) {
					btn.innerText = "C·∫≠p Nh·∫≠t Kh√°ch H√†ng";
				} else {
					btn.innerText = "L∆∞u Kh√°ch H√†ng";
				}
			}
		};

		document.getElementById('checkinForm').onsubmit = async (e) => {
			e.preventDefault();
			const btn = document.getElementById('btnCI');
			const fileInput = document.getElementById('ci_file');

			if (!fileInput.files[0]) {
				showToast("Vui l√≤ng ch·ª•p ·∫£nh minh ch·ª©ng!", true);
				return;
			}

			btn.disabled = true;
			btn.innerText = "ƒêang upload ·∫£nh...";

			// Upload file first
			const imageUrl = await uploadToDrive(fileInput.files[0]);
			if (!imageUrl) {
				showToast("L·ªói upload ·∫£nh!", true);
				btn.disabled = false;
				btn.innerText = "X√°c Nh·∫≠n Check-in";
				return;
			}

			const sel = document.getElementById('ci_customer');
			const custLoc = sel.options[sel.selectedIndex].getAttribute('data-loc');

			const payload = {
				action: 'handleCheckin',
				customerId: sel.value,
				customerLocation: custLoc,
				checkinLocation: document.getElementById('ci_location').value, // Use the actual displayed/live coordinates
				salesId: currentUser.email,
				purpose: document.getElementById('ci_purpose').value,
				note: document.getElementById('ci_note').value,
				imageUrl: imageUrl
			};

			const res = await fetch(CRM_URL, { method: 'POST', body: JSON.stringify(payload) });
			const data = await res.json();
			if (data.success) {
				showToast("Check-in th√†nh c√¥ng!");
				e.target.reset();
				loadCheckinHistory(); // Refresh history
				switchCheckinSubTab('history'); // Auto switch to history tab
			}
			btn.disabled = false;
			btn.innerText = "X√°c Nh·∫≠n Check-in";
		};

		document.getElementById('docForm').onsubmit = async (e) => {
			e.preventDefault();
			const btn = document.getElementById('btnDoc');
			const fileInput = document.getElementById('doc_file');

			btn.disabled = true;
			btn.innerText = "ƒêang t·∫£i t·ªáp l√™n...";

			const fileUrl = await uploadToDrive(fileInput.files[0]);
			if (!fileUrl) {
				showToast("L·ªói t·∫£i t·ªáp!", true);
				btn.disabled = false;
				btn.innerText = "Th√™m T√†i Li·ªáu";
				return;
			}

			const payload = {
				action: 'addDoc',
				customerId: document.getElementById('doc_customer').value,
				docName: document.getElementById('doc_name').value,
				type: document.getElementById('doc_type').value,
				fileUrl: fileUrl,
				note: document.getElementById('doc_note').value
			};

			const res = await fetch(CRM_URL, { method: 'POST', body: JSON.stringify(payload) });
			const data = await res.json();
			if (data.success) {
				showToast("ƒê√£ l∆∞u t√†i li·ªáu!");
				e.target.reset();
			}
			btn.disabled = false;
			btn.innerText = "Th√™m T√†i Li·ªáu";
		};


		// --- CHATBOT LOGIC ---

		initGPS();
		if (currentUser) {
			document.getElementById('user_display').innerText = `üë§ ${currentUser.fullName} (${currentUser.email})`;

			const roleBadge = document.getElementById('role_badge');
			if (currentUser.roleId === 'R001') {
				roleBadge.innerText = 'QU·∫¢N TR·ªä VI√äN';
				document.getElementById('admin_toggle_container').style.display = 'flex';
			} else {
				roleBadge.innerText = 'NH√ÇN VI√äN KINH DOANH';
			}
		}
		loadCustomers(); // Initial data load
		loadAreas();
	</script>
	<script src="chatbot.js"></script>
	<script src="floating-menu.js"></script>
	<script src="floating-menu.js"></script>
</body>

</html>