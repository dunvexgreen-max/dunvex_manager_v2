<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>CRM Sales | Dunvex Digital</title>
	<link rel="icon" type="image/svg+xml"
		href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%236366f1'/><text x='50%' y='50%' dominant-baseline='central' text-anchor='middle' fill='white' font-size='60' font-family='sans-serif' font-weight='800'>DV</text></svg>">
	<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
	<style>
		:root {
			--primary: #6366f1;
			--bg-dark: #0f172a;
			--card-bg: rgba(30, 41, 59, 0.7);
			--glass-border: rgba(255, 255, 255, 0.1);
			--text-main: #f8fafc;
			--text-muted: #94a3b8;
			--accent-purple: #c084fc;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Outfit', sans-serif;
		}

		body {
			background-color: var(--bg-dark);
			color: var(--text-main);
			min-height: 100vh;
			background-image: radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%), radial-gradient(at 100% 100%, rgba(192, 132, 252, 0.15) 0px, transparent 50%);
			padding: 20px;
		}

		.container {
			max-width: 800px;
			margin: 40px auto;
		}

		.top-bar {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
		}

		.top-bar h1 {
			font-size: 1.8rem;
			font-weight: 800;
			background: linear-gradient(135deg, #fff, var(--primary));
			background-clip: text;
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
		}

		/* Tabs */
		.tabs {
			display: flex;
			gap: 10px;
			margin-bottom: 24px;
			background: rgba(255, 255, 255, 0.05);
			padding: 5px;
			border-radius: 12px;
		}

		.tab-btn {
			flex: 1;
			padding: 12px;
			border: none;
			background: none;
			color: var(--text-muted);
			font-weight: 600;
			cursor: pointer;
			border-radius: 8px;
			transition: 0.3s;
		}

		.tab-btn.active {
			background: var(--primary);
			color: white;
			box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
		}

		/* Form Card */
		.form-card {
			background: var(--card-bg);
			backdrop-filter: blur(20px);
			border: 1px solid var(--glass-border);
			border-radius: 24px;
			padding: 30px;
			display: none;
		}

		.form-card.active {
			display: block;
			animation: fadeInUp 0.4s ease;
		}

		@keyframes fadeInUp {
			from {
				opacity: 0;
				transform: translateY(20px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.form-group {
			margin-bottom: 20px;
			position: relative;
		}

		.address-suggestions {
			position: absolute;
			top: 100%;
			left: 0;
			right: 0;
			background: #1e293b;
			border: 1px solid var(--glass-border);
			border-radius: 12px;
			z-index: 2000;
			margin-top: 5px;
			max-height: 250px;
			overflow-y: auto;
			box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
		}

		.suggestion-item {
			padding: 12px 16px;
			cursor: pointer;
			font-size: 0.85rem;
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
			line-height: 1.4;
		}

		.suggestion-item:hover {
			background: var(--primary);
			color: white;
		}

		.suggestion-item:last-child {
			border-bottom: none;
		}

		label {
			display: block;
			font-size: 0.85rem;
			color: var(--text-muted);
			margin-bottom: 8px;
			text-transform: uppercase;
			letter-spacing: 1px;
		}

		input,
		select,
		textarea {
			width: 100%;
			padding: 12px 16px;
			background: rgba(0, 0, 0, 0.2);
			border: 1px solid var(--glass-border);
			border-radius: 12px;
			color: white;
			font-size: 1rem;
			outline: none;
			transition: 0.3s;
		}

		input:focus,
		select:focus,
		textarea:focus {
			border-color: var(--primary);
			background: rgba(0, 0, 0, 0.4);
		}

		.btn-submit {
			width: 100%;
			padding: 15px;
			background: var(--primary);
			border: none;
			border-radius: 12px;
			color: white;
			font-weight: 700;
			font-size: 1.1rem;
			cursor: pointer;
			transition: 0.3s;
			margin-top: 10px;
		}

		.btn-submit:hover {
			transform: translateY(-3px);
			box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
		}

		.btn-submit:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		.gps-status {
			font-size: 0.8rem;
			color: #22c55e;
			margin-top: 8px;
			display: flex;
			align-items: center;
			gap: 6px;
		}

		.gps-status.error {
			color: #ef4444;
		}

		.hidden {
			display: none;
		}

		.btn-glass {
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid var(--glass-border);
			color: var(--text-muted);
			border-radius: 8px;
			cursor: pointer;
			transition: 0.3s;
		}

		.btn-glass:hover {
			background: rgba(255, 255, 255, 0.1);
			color: white;
		}

		/* Toast */
		#toast {
			position: fixed;
			top: 20px;
			right: 20px;
			padding: 16px 24px;
			border-radius: 12px;
			background: #22c55e;
			color: white;
			font-weight: 600;
			transform: translateX(200%);
			transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
			z-index: 3000;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
		}

		#toast.active {
			transform: translateX(0);
		}

		.back-btn {
			text-decoration: none;
			color: var(--text-muted);
			font-size: 0.9rem;
			display: flex;
			align-items: center;
			gap: 5px;
		}

		.back-btn:hover {
			color: white;
		}

		/* Purpose Filters */
		.filter-group {
			display: flex;
			gap: 8px;
			margin: 20px 0;
			overflow-x: auto;
			padding-bottom: 5px;
		}

		.purpose-btn {
			padding: 8px 16px;
			border-radius: 20px;
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid var(--glass-border);
			color: var(--text-muted);
			font-size: 0.8rem;
			font-weight: 600;
			white-space: nowrap;
			transition: 0.3s;
			cursor: pointer;
		}

		.purpose-btn.active {
			background: var(--primary);
			color: white;
			border-color: var(--primary);
		}

		/* History List */
		.history-list {
			margin-top: 30px;
			border-top: 1px solid var(--glass-border);
			padding-top: 20px;
		}

		.history-item {
			background: rgba(0, 0, 0, 0.2);
			border: 1px solid var(--glass-border);
			border-radius: 16px;
			padding: 15px;
			margin-bottom: 12px;
			display: flex;
			gap: 15px;
			align-items: center;
		}

		.history-img {
			width: 60px;
			height: 60px;
			border-radius: 8px;
			object-fit: cover;
			cursor: zoom-in;
			transition: 0.3s;
		}

		.history-img:hover {
			transform: scale(1.05);
		}

		.history-info {
			flex: 1;
		}

		.history-name {
			font-weight: 600;
			font-size: 0.95rem;
			margin-bottom: 2px;
		}

		.history-meta {
			font-size: 0.75rem;
			color: var(--text-muted);
			display: flex;
			gap: 10px;
		}

		.history-purpose {
			background: rgba(99, 102, 241, 0.2);
			color: var(--primary);
			padding: 2px 8px;
			border-radius: 4px;
			font-size: 0.7rem;
			font-weight: 600;
		}

		/* Zoom Modal */
		.zoom-modal {
			position: fixed;
			inset: 0;
			background: rgba(0, 0, 0, 0.9);
			z-index: 5000;
			display: none;
			justify-content: center;
			align-items: center;
			padding: 40px;
		}

		.zoom-modal.active {
			display: flex;
		}

		.zoom-img {
			max-width: 100%;
			max-height: 100%;
			border-radius: 8px;
			box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
		}

		.zoom-close {
			position: absolute;
			top: 20px;
			right: 20px;
			color: white;
			font-size: 2rem;
			cursor: pointer;
		}

		/* Customer Detail Overlay */
		.detail-overlay {
			position: fixed;
			top: 0;
			right: -100%;
			width: 100%;
			max-width: 500px;
			height: 100%;
			background: var(--bg-dark);
			z-index: 4000;
			box-shadow: -10px 0 50px rgba(0, 0, 0, 0.5);
			transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
			padding: 40px 30px;
			overflow-y: auto;
			border-left: 1px solid var(--glass-border);
		}

		.detail-overlay.active {
			right: 0;
		}

		.detail-header {
			display: flex;
			justify-content: space-between;
			align-items: flex-start;
			margin-bottom: 30px;
		}

		.detail-close {
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid var(--glass-border);
			color: white;
			width: 40px;
			height: 40px;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
		}

		.detail-section {
			margin-bottom: 25px;
			background: rgba(255, 255, 255, 0.03);
			border-radius: 16px;
			padding: 20px;
			border: 1px solid var(--glass-border);
		}

		.detail-label {
			font-size: 0.75rem;
			color: var(--text-muted);
			text-transform: uppercase;
			letter-spacing: 1px;
			margin-bottom: 5px;
		}

		.detail-value {
			font-size: 1.1rem;
			font-weight: 600;
		}

		.clickable-row {
			cursor: pointer;
			transition: 0.2s;
		}

		.clickable-row:hover {
			background: rgba(255, 255, 255, 0.05) !important;
		}
	</style>
</head>

<body>
	<div id="toast">Th√¥ng b√°o ·ªü ƒë√¢y!</div>

	<div id="zoomModal" class="zoom-modal" onclick="closeZoom()">
		<span class="zoom-close">&times;</span>
		<img id="zoomImg" class="zoom-img" src="">
	</div>

	<div id="detailOverlay" class="detail-overlay">
		<div class="detail-header">
			<div>
				<h2 id="det_name" style="font-size: 1.6rem; font-weight: 800; color: var(--primary);">T√™n Kh√°ch H√†ng
				</h2>
				<p id="det_id" style="color: var(--text-muted); font-size: 0.8rem;">ID: KH00000</p>
			</div>
			<button class="detail-close" onclick="closeDetail()">‚úï</button>
		</div>

		<div class="detail-section">
			<div class="detail-label">Li√™n H·ªá</div>
			<div id="det_contact" class="detail-value">Nguy·ªÖn VƒÉn A</div>
			<div id="det_phone" style="color: var(--accent-purple); font-weight: 600; margin-top: 5px;">0901234567</div>
		</div>

		<div class="detail-section">
			<div class="detail-label">ƒê·ªãa Ch·ªâ & Khu V·ª±c</div>
			<div id="det_address" class="detail-value" style="font-size: 0.95rem;">S·ªë 123 ƒê∆∞·ªùng ABC...</div>
			<div id="det_area" style="color: var(--text-muted); font-size: 0.85rem; margin-top: 5px;">üìç Mi·ªÅn Nam</div>
		</div>

		<div class="detail-section">
			<div class="detail-label">V·ªã Tr√≠ GPS</div>
			<div id="det_location" class="detail-value" style="font-family: monospace; font-size: 0.9rem;">10.123,
				106.456</div>
			<button class="btn-glass" onclick="openInGoogleMaps()"
				style="margin-top: 10px; width: 100%; padding: 10px;">Xem tr√™n b·∫£n ƒë·ªì</button>
		</div>

		<div class="detail-section">
			<div class="detail-label">Tr·∫°ng Th√°i</div>
			<div id="det_status"
				style="display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; background: rgba(34, 197, 94, 0.2); color: #22c55e;">
				ƒêang ho·∫°t ƒë·ªông</div>
		</div>

		<div class="history-list" id="det_history">
			<!-- Personal History Highlights -->
		</div>
	</div>

	<div class="container">
		<div class="top-bar">
			<h1>CRM & Sales Check-in</h1>
			<a href="index.html" class="back-btn">‚Üê Quay l·∫°i</a>
		</div>

		<div class="tabs">
			<button class="tab-btn active" onclick="switchTab('create')">üÜï Kh√°ch h√†ng</button>
			<button class="tab-btn" onclick="switchTab('list')">üìã Danh s√°ch & L·ªçc</button>
			<button class="tab-btn" onclick="switchTab('checkin')">üìç Check-in</button>
			<button class="tab-btn" onclick="switchTab('docs')">üìÅ T√†i li·ªáu</button>
		</div>

		<div id="formCreate" class="form-card active">
			<h2 id="formTitle" style="font-size: 1.2rem; margin-bottom: 20px; color: var(--primary);">üÜï T·∫°o Kh√°ch H√†ng
				M·ªõi</h2>
			<form id="customerForm">
				<input type="hidden" id="edit_cust_id" value="">
				<div class="form-group">
					<label>T√™n Kh√°ch h√†ng *</label>
					<input type="text" id="cust_name" placeholder="V√≠ d·ª•: C√¥ng ty TNHH ABC" required>
				</div>
				<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
					<div class="form-group">
						<label>Ng∆∞·ªùi li√™n h·ªá</label>
						<input type="text" id="cust_contact" placeholder="Nguy·ªÖn VƒÉn A">
					</div>
					<div class="form-group">
						<label>S·ªë ƒëi·ªán tho·∫°i</label>
						<input type="tel" id="cust_phone" placeholder="090...">
					</div>
				</div>
				<div class="form-group">
					<label>Email</label>
					<input type="email" id="cust_email" placeholder="email@gmail.com">
				</div>
				<div class="form-group">
					<label>ƒê·ªãa ch·ªâ Kho/C·ª≠a h√†ng *</label>
					<input type="text" id="cust_address" placeholder="S√¥ 1, ƒê∆∞·ªùng X, Qu·∫≠n Y" required
						oninput="handleAddressAutocomplete(this.value)" autocomplete="off">
					<div id="addressSuggestions" class="address-suggestions hidden"></div>
				</div>
				<div class="form-group">
					<label>V·ªã tr√≠ Shop/Kho (GPS) *</label>
					<div style="display: flex; gap: 10px;">
						<input type="text" id="cust_location" readonly placeholder="Nh·∫•n n√∫t ƒë·ªÉ l·∫•y v·ªã tr√≠...">
						<button type="button" id="btnGetGPS" class="btn-glass" onclick="captureGPS()"
							style="padding: 0 15px; font-size: 0.8rem; background: var(--primary); color: white;">L·∫•y
							GPS</button>
						<button type="button" class="btn-glass" onclick="toggleManualLocation()"
							style="padding: 0 15px; font-size: 0.8rem;">Th·ªß c√¥ng</button>
					</div>
					<div id="manual_loc_box" class="hidden" style="margin-top: 10px;">
						<input type="text" id="cust_location_manual"
							placeholder="D√°n t·ªça ƒë·ªô v√†o ƒë√¢y (v√≠ d·ª•: 10.1234, 106.1234)"
							oninput="syncManualLocation(this.value)">
					</div>
					<div id="gpsStatusCreate" class="gps-status">‚åõ ƒêang k·∫øt n·ªëi GPS...</div>
				</div>
				<div class="form-group">
					<label>Khu v·ª±c th·ªã tr∆∞·ªùng (Ch·ªçn ho·∫∑c Nh·∫≠p m·ªõi)</label>
					<input type="text" id="cust_area" list="area_list" placeholder="T√¨m ho·∫∑c th√™m khu v·ª±c m·ªõi...">
					<datalist id="area_list"></datalist>
				</div>
				<div style="display: flex; gap: 10px; margin-top: 10px;">
					<button type="submit" class="btn-submit" id="btnCust" disabled style="flex: 3;">ƒêang kh·ªüi
						t·∫°o...</button>
					<button type="button" class="btn-glass" onclick="resetCustomerForm()"
						style="flex: 1; margin-top: 10px;">L√†m m·ªõi</button>
				</div>
			</form>
		</div>

		<!-- TAB: DANH S√ÅCH -->
		<div id="formList" class="form-card">
			<div class="form-group">
				<input type="text" id="custSearch" placeholder="üîç T√¨m t√™n kh√°ch h√†ng ho·∫∑c khu v·ª±c..."
					oninput="filterLocalList()">
			</div>
			<div style="overflow-x: auto;">
				<table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
					<thead>
						<tr
							style="text-align: left; color: var(--text-muted); border-bottom: 1px solid var(--glass-border);">
							<th style="padding: 10px;">KH√ÅCH H√ÄNG</th>
							<th style="padding: 10px;">KHU V·ª∞C</th>
							<th style="padding: 10px;">SƒêT</th>
							<th style="padding: 10px;">TR·∫†NG TH√ÅI</th>
							<th style="padding: 10px; text-align: center;">THAO T√ÅC</th>
						</tr>
					</thead>
					<tbody id="customerTableBody">
						<!-- Rendered dynamically -->
					</tbody>
				</table>
			</div>
		</div>

		<!-- FORM 2: CHECK-IN -->
		<div id="formCheckin" class="form-card">
			<form id="checkinForm">
				<div class="form-group">
					<label>Ch·ªçn Kh√°ch h√†ng *</label>
					<select id="ci_customer" required onchange="updateDistance()">
						<option value="">-- ƒêang t·∫£i danh s√°ch --</option>
					</select>
				</div>
				<div class="form-group">
					<label>M·ª•c ƒë√≠ch G·∫∑p m·∫∑t</label>
					<select id="ci_purpose">
						<option value="ThƒÉm h·ªèi ƒë·ªãnh k·ª≥">ThƒÉm h·ªèi ƒë·ªãnh k·ª≥</option>
						<option value="Ch√†o h√†ng m·ªõi">Ch√†o h√†ng m·ªõi</option>
						<option value="Ch√†o m·ªõi">Ch√†o m·ªõi</option>
						<option value="X·ª≠ l√Ω khi·∫øu n·∫°i">X·ª≠ l√Ω khi·∫øu n·∫°i</option>
						<option value="Thu n·ª£">Thu n·ª£</option>
					</select>
				</div>
				<div class="form-group">
					<label>Ghi ch√∫ k·∫øt qu·∫£</label>
					<textarea id="ci_note" rows="3" placeholder="Kh√°ch ch∆∞a l·∫•y h√†ng v√¨..."></textarea>
				</div>
				<div class="form-group">
					<label>·∫¢nh minh ch·ª©ng (Ch·ª•p ·∫£nh/T·∫£i l√™n) *</label>
					<input type="file" id="ci_file" accept="image/*">
				</div>
				<div class="form-group">
					<label>V·ªã tr√≠ Check-in</label>
					<div style="display: flex; gap: 10px;">
						<input type="text" id="ci_location" readonly>
						<button type="button" class="btn-glass" onclick="toggleManualLocation('checkin')"
							style="padding: 0 15px; font-size: 0.8rem;">Th·ªß c√¥ng</button>
					</div>
					<div id="manual_loc_box_ci" class="hidden" style="margin-top: 10px;">
						<input type="text" id="ci_location_manual"
							placeholder="D√°n t·ªça ƒë·ªô check-in (v√≠ d·ª•: 10.1234, 106.1234)"
							oninput="syncManualLocation(this.value, 'checkin')">
					</div>
					<div id="gpsStatusCheckin" class="gps-status"></div>
				</div>
				<div class="form-group">
					<label>Kho·∫£ng c√°ch ∆∞·ªõc t√≠nh</label>
					<div id="ci_dist_display" style="font-weight: 800; color: var(--accent-purple); font-size: 1.2rem;">
						0 m</div>
				</div>
				<button type="submit" class="btn-submit" id="btnCI">X√°c Nh·∫≠n Check-in</button>
			</form>

			<!-- DANH S√ÅCH L·ªäCH S·ª¨ CHECK-IN -->
			<div class="history-list">
				<h3 style="font-size: 1.1rem; margin-bottom: 15px;">L·ªãch s·ª≠ Check-in</h3>

				<div class="filter-group">
					<div class="purpose-btn active" onclick="filterHistory('T·∫•t c·∫£', this)">T·∫•t c·∫£</div>
					<div class="purpose-btn" onclick="filterHistory('ThƒÉm h·ªèi ƒë·ªãnh k·ª≥', this)">ThƒÉm h·ªèi ƒë·ªãnh k·ª≥</div>
					<div class="purpose-btn" onclick="filterHistory('Ch√†o h√†ng m·ªõi', this)">Ch√†o h√†ng m·ªõi</div>
					<div class="purpose-btn" onclick="filterHistory('Ch√†o m·ªõi', this)">Ch√†o m·ªõi</div>
					<div class="purpose-btn" onclick="filterHistory('X·ª≠ l√Ω khi·∫øu n·∫°i', this)">X·ª≠ l√Ω khi·∫øu n·∫°i</div>
					<div class="purpose-btn" onclick="filterHistory('Thu n·ª£', this)">Thu n·ª£</div>
				</div>

				<div id="checkinHistoryBody">
					<p style="text-align: center; color: var(--text-muted); padding: 20px;">ƒêang t·∫£i l·ªãch s·ª≠...</p>
				</div>
			</div>
		</div>

		<!-- FORM 3: T√ÄI LI·ªÜU -->
		<div id="formDocs" class="form-card">
			<form id="docForm">
				<div class="form-group">
					<label>Ch·ªçn Kh√°ch h√†ng *</label>
					<select id="doc_customer" required>
						<option value="">-- ƒêang t·∫£i danh s√°ch --</option>
					</select>
				</div>
				<div class="form-group">
					<label>T√™n t√†i li·ªáu</label>
					<input type="text" id="doc_name" placeholder="Gi·∫•y ph√©p kinh doanh" required>
				</div>
				<div class="form-group">
					<label>Lo·∫°i t√†i li·ªáu</label>
					<select id="doc_type" onchange="updateAcceptAttr()">
						<option value="Gi·∫•y ph√©p KD">Gi·∫•y ph√©p KD (PDF/·∫¢nh)</option>
						<option value="H·ª£p ƒë·ªìng">H·ª£p ƒë·ªìng (PDF)</option>
						<option value="H√¨nh ·∫£nh">H√¨nh ·∫£nh</option>
						<option value="PDF">PDF</option>
					</select>
				</div>
				<div class="form-group">
					<label>T·∫£i t·ªáp l√™n (PDF/·∫¢nh) *</label>
					<input type="file" id="doc_file" required>
				</div>
				<div class="form-group">
					<label>Ghi ch√∫ th√™m</label>
					<textarea id="doc_note" rows="2"></textarea>
				</div>
				<button type="submit" class="btn-submit" id="btnDoc">Th√™m T√†i Li·ªáu</button>
			</form>
		</div>
	</div>

	<script>
		const CRM_URL = 'https://script.google.com/macros/s/AKfycbymqtjIrsThq1lxSbY5TwjxCBvAzNhEP9su2BfJIvE-DV55CnDXiSg7GwrBTaoae3Pg/exec';
		let currentUser = JSON.parse(localStorage.getItem('user'));
		let customerList = [];
		let checkinHistory = [];
		let currentPurposeFilter = 'T·∫•t c·∫£';
		let areaList = [];
		let liveCoords = ""; // V·ªã tr√≠ GPS th·ªùi gian th·ª±c
		let currentCoords = ""; // T·ªça ƒë·ªô d√πng cho form (c√≥ th·ªÉ l√† th·ªß c√¥ng/ƒë·ªãa ch·ªâ)
		let addressResults = [];
		let addressTimeout = null;

		if (!currentUser) window.location.href = 'auth.html';

		async function handleAddressAutocomplete(val) {
			const container = document.getElementById('addressSuggestions');
			if (!val || val.length < 3) {
				container.innerHTML = "";
				container.classList.add('hidden');
				return;
			}

			if (addressTimeout) clearTimeout(addressTimeout);
			addressTimeout = setTimeout(async () => {
				try {
					const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}&addressdetails=1&limit=5&countrycodes=vn`);
					addressResults = await res.json();
					if (addressResults.length > 0) {
						container.innerHTML = addressResults.map((item, i) => `
							<div class="suggestion-item" onclick="selectSuggestedAddress(${i})">${item.display_name}</div>
						`).join('');
						container.classList.remove('hidden');
					} else {
						container.classList.add('hidden');
					}
				} catch (e) { console.warn("L·ªói fetch ƒë·ªãa ch·ªâ", e); }
			}, 600);
		}

		function selectSuggestedAddress(idx) {
			const item = addressResults[idx];
			if (!item) return;

			document.getElementById('cust_address').value = item.display_name;
			currentCoords = `${item.lat}, ${item.lon}`;
			document.getElementById('cust_location').value = currentCoords;

			// Tr√≠ch xu·∫•t khu v·ª±c (Huy·ªán/Th√†nh ph·ªë/T·ªânh)
			const addr = item.address;
			let areaSuggestion = addr.suburb || addr.city_district || addr.district || addr.town || addr.city || addr.state || "";

			// L√†m g·ªçn t√™n khu v·ª±c n·∫øu c√≥ (B·ªè d·∫•u ph·∫©y th·ª´a)
			document.getElementById('cust_area').value = areaSuggestion;

			document.getElementById('addressSuggestions').classList.add('hidden');
			document.getElementById('gpsStatusCreate').innerHTML = "‚úÖ V·ªã tr√≠ ƒë∆∞·ª£c x√°c ƒë·ªãnh t·ª´ ƒë·ªãa ch·ªâ";
			document.getElementById('btnCust').disabled = false;
			document.getElementById('btnCust').innerText = "C·∫≠p Nh·∫≠t Kh√°ch H√†ng";
		}

		function captureGPS() {
			if (!liveCoords) {
				showToast("Ch∆∞a nh·∫≠n ƒë∆∞·ª£c t√≠n hi·ªáu GPS. Vui l√≤ng ƒë·ª£i ho·∫∑c ki·ªÉm tra quy·ªÅn v·ªã tr√≠.", true);
				return;
			}
			currentCoords = liveCoords;
			document.getElementById('cust_location').value = currentCoords;
			document.getElementById('gpsStatusCreate').innerHTML = "‚úÖ V·ªã tr√≠ ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n!";
			showToast("ƒê√£ l·∫•y v·ªã tr√≠ GPS hi·ªán t·∫°i!");
		}

		// ƒê√≥ng suggestion khi click ra ngo√†i
		document.addEventListener('click', (e) => {
			if (!e.target.closest('.form-group')) {
				document.getElementById('addressSuggestions').classList.add('hidden');
			}
		});

		// Helper: Convert File to Base64
		function fileToBase64(file) {
			return new Promise((resolve, reject) => {
				const reader = new FileReader();
				reader.readAsDataURL(file);
				reader.onload = () => resolve(reader.result.split(',')[1]);
				reader.onerror = error => reject(error);
			});
		}

		async function uploadToDrive(file) {
			if (!file) return null;
			const base64 = await fileToBase64(file);
			const isPdf = file.name.toLowerCase().endsWith('.pdf');
			const res = await fetch(CRM_URL, {
				method: 'POST',
				body: JSON.stringify({
					action: 'uploadFile',
					filename: file.name,
					mimetype: file.type,
					base64: base64,
					type: isPdf ? 'pdf' : 'image'
				})
			});
			const data = await res.json();
			return data.success ? data.url : null;
		}

		function toggleManualLocation(type = 'create') {
			const boxId = type === 'create' ? 'manual_loc_box' : 'manual_loc_box_ci';
			document.getElementById(boxId).classList.toggle('hidden');
		}

		function syncManualLocation(val, type = 'create') {
			if (val.includes(',')) {
				currentCoords = val.trim();
				const displayId = type === 'create' ? 'cust_location' : 'ci_location';
				document.getElementById(displayId).value = currentCoords;
				updateDistance();
			}
		}

		function updateAcceptAttr() {
			const type = document.getElementById('doc_type').value;
			const input = document.getElementById('doc_file');
			if (type === 'H√¨nh ·∫£nh') input.accept = "image/*";
			else if (type === 'H·ª£p ƒë·ªìng' || type === 'PDF') input.accept = ".pdf";
			else input.accept = "image/*, .pdf";
		}

		function showToast(msg, isError = false) {
			const t = document.getElementById('toast');
			t.innerText = msg;
			t.style.background = isError ? '#ef4444' : '#22c55e';
			t.classList.add('active');
			setTimeout(() => t.classList.remove('active'), 3000);
		}

		function switchTab(tab) {
			document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
			document.querySelectorAll('.form-card').forEach(c => c.classList.remove('active'));

			if (tab === 'create') {
				document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
				document.getElementById('formCreate').classList.add('active');
				// N·∫øu kh√¥ng ph·∫£i ƒëang Edit th√¨ reset form v·ªÅ ch·∫ø ƒë·ªô Create
				if (!document.getElementById('edit_cust_id').value) {
					document.getElementById('formTitle').innerText = "üÜï T·∫°o Kh√°ch H√†ng M·ªõi";
					document.getElementById('btnCust').innerText = "L∆∞u Kh√°ch H√†ng";
				}
				loadAreas();
			} else if (tab === 'list') {
				document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
				document.getElementById('formList').classList.add('active');
				loadCustomers();
			} else if (tab === 'checkin') {
				document.querySelector('.tab-btn:nth-child(3)').classList.add('active');
				document.getElementById('formCheckin').classList.add('active');
				loadCustomers();
				loadCheckinHistory();
			} else {
				document.querySelector('.tab-btn:nth-child(4)').classList.add('active');
				document.getElementById('formDocs').classList.add('active');
				loadCustomers();
			}
		}

		// GPS Logic
		function initGPS() {
			if (navigator.geolocation) {
				navigator.geolocation.watchPosition(pos => {
					liveCoords = `${pos.coords.latitude}, ${pos.coords.longitude}`;
					// Ch·ªâ t·ª± ƒë·ªông c·∫≠p nh·∫≠t cho Check-in, KH√îNG c·∫≠p nh·∫≠t v√†o customerForm
					document.getElementById('ci_location').value = liveCoords;
					document.getElementById('gpsStatusCreate').innerHTML = "‚úÖ T√≠n hi·ªáu GPS s·∫µn s√†ng";
					document.getElementById('gpsStatusCheckin').innerHTML = "‚úÖ V·ªã tr√≠ hi·ªán t·∫°i s·∫µn s√†ng";

					// N·∫øu ƒëang t·∫°o m·ªõi (kh√¥ng ph·∫£i Edit) v√† ch∆∞a c√≥ t·ªça ƒë·ªô th√¨ c√≥ th·ªÉ nh·∫Øc ng∆∞·ªùi d√πng
					if (!document.getElementById('edit_cust_id').value) {
						document.getElementById('btnCust').disabled = false;
						document.getElementById('btnCust').innerText = "L∆∞u Kh√°ch H√†ng";
					}
					updateDistance();
				}, err => {
					console.warn("GPS Access Denied/Error:", err);
					document.getElementById('gpsStatusCreate').innerHTML = "‚ö†Ô∏è GPS b·ªã ch·∫∑n. Nh·∫•n 'Th·ªß c√¥ng' ƒë·ªÉ d√°n t·ªça ƒë·ªô.";
					document.getElementById('gpsStatusCreate').className = "gps-status error";
					document.getElementById('btnCust').disabled = false;
				}, { enableHighAccuracy: true, timeout: 5000 });
			}
		}

		async function loadAreas() {
			try {
				const res = await fetch(CRM_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'getAreas',
						salesId: currentUser.email,
						isAdmin: currentUser.roleId === 'R001'
					})
				});
				const data = await res.json();
				if (data.success && data.areas) {
					areaList = data.areas;
					const options = areaList.map(a => `<option value="${a}">${a}</option>`).join('');
					document.getElementById('area_list').innerHTML = options;
				}
			} catch (e) { console.error("L·ªói t·∫£i khu v·ª±c", e); }
		}

		async function loadCustomers() {
			try {
				const res = await fetch(CRM_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'getCustomers',
						salesId: currentUser.email,
						isAdmin: currentUser.roleId === 'R001'
					})
				});
				const data = await res.json();
				if (data.success) {
					customerList = data.customers;
					renderCustomerTable(customerList);
					const options = '<option value="">-- Ch·ªçn kh√°ch h√†ng --</option>' +
						customerList.map(c => `<option value="${c.id}" data-loc="${c.location}">${c.name}</option>`).join('');
					const ciCust = document.getElementById('ci_customer');
					const docCust = document.getElementById('doc_customer');
					if (ciCust) ciCust.innerHTML = options;
					if (docCust) docCust.innerHTML = options;
				}
			} catch (e) { showToast("L·ªói t·∫£i kh√°ch h√†ng!", true); }
		}

		async function loadCheckinHistory() {
			try {
				const res = await fetch(CRM_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'getCheckinHistory',
						salesId: currentUser.email,
						isAdmin: currentUser.roleId === 'R001'
					})
				});
				const data = await res.json();
				if (data.success) {
					checkinHistory = data.history || [];
					applyHistoryFilters();
				} else {
					document.getElementById('checkinHistoryBody').innerHTML =
						`<p style="text-align: center; color: var(--danger); padding: 20px;">L·ªói: ${data.message}</p>`;
				}
			} catch (e) {
				console.error("L·ªói t·∫£i l·ªãch s·ª≠", e);
				document.getElementById('checkinHistoryBody').innerHTML =
					'<p style="text-align: center; color: var(--danger); padding: 20px;">L·ªói k·∫øt n·ªëi m√°y ch·ªß.</p>';
			}
		}

		function filterHistory(purpose, el) {
			currentPurposeFilter = purpose;
			document.querySelectorAll('.purpose-btn').forEach(b => b.classList.remove('active'));
			el.classList.add('active');
			applyHistoryFilters();
		}

		function applyHistoryFilters() {
			const filtered = currentPurposeFilter === 'T·∫•t c·∫£'
				? checkinHistory
				: checkinHistory.filter(h => h.purpose === currentPurposeFilter);

			const body = document.getElementById('checkinHistoryBody');
			if (filtered.length === 0) {
				body.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">Kh√¥ng c√≥ b·∫£n ghi n√†o.</p>';
				return;
			}

			body.innerHTML = filtered.map(h => `
				<div class="history-item">
					<img src="${h.image || 'https://placehold.co/100x100/1e293b/white?text=No+Img'}" 
						 class="history-img" onclick="zoomImage(this.src)">
					<div class="history-info">
						<div class="history-name">${h.customerName}</div>
						<div class="history-meta">
							<span>${formatTime(h.time)}</span>
							<span>${h.distance} m</span>
							<span class="history-purpose">${h.purpose}</span>
						</div>
						<div style="font-size: 0.8rem; margin-top: 5px; color: var(--text-main); opacity: 0.8;">${h.note || ''}</div>
					</div>
				</div>
			`).join('');
		}

		function zoomImage(src) {
			document.getElementById('zoomImg').src = src;
			document.getElementById('zoomModal').classList.add('active');
		}

		function closeZoom() {
			document.getElementById('zoomModal').classList.remove('active');
		}

		function formatTime(iso) {
			if (!iso) return '';
			try {
				const d = new Date(iso);
				if (isNaN(d.getTime())) return iso; // Tr·∫£ v·ªÅ text g·ªëc n·∫øu kh√¥ng parse ƒë∆∞·ª£c date
				return d.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) + ' ' + d.toLocaleDateString('vi-VN');
			} catch (e) { return iso; }
		}

		function renderCustomerTable(list) {
			const body = document.getElementById('customerTableBody');
			body.innerHTML = list.map(c => `
				<tr class="clickable-row" style="border-bottom: 1px solid rgba(255,255,255,0.05);">
					<td style="padding: 12px;" onclick="viewCustomerDetail('${c.id}')">
						<div style="font-weight: 600;">${c.name}</div>
						<div style="font-size: 0.75rem; color: var(--text-muted);">${c.address}</div>
					</td>
					<td style="padding: 12px; color: var(--accent-purple); font-size: 0.8rem;" onclick="viewCustomerDetail('${c.id}')">${c.area}</td>
					<td style="padding: 12px; font-size: 0.8rem;" onclick="viewCustomerDetail('${c.id}')">${c.phone}</td>
					<td style="padding: 12px;" onclick="viewCustomerDetail('${c.id}')">
						<span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 4px 8px; border-radius: 6px; font-size: 0.7rem;">${c.status}</span>
					</td>
					<td style="padding: 12px; text-align: center;">
						<div style="display: flex; gap: 8px; justify-content: center;">
							<button class="btn-glass" onclick="editCustomer('${c.id}')" style="padding: 5px 10px; font-size: 0.8rem;" title="S·ª≠a">‚úèÔ∏è</button>
							<button class="btn-glass" onclick="deleteCustomer('${c.id}')" style="padding: 5px 10px; font-size: 0.8rem; color: #ef4444;" title="X√≥a">üóëÔ∏è</button>
						</div>
					</td>
				</tr>
			`).join('');
		}

		function editCustomer(id) {
			const c = customerList.find(x => x.id === id);
			if (!c) return;

			document.getElementById('formTitle').innerText = "‚úèÔ∏è Ch·ªânh S·ª≠a Kh√°ch H√†ng";
			document.getElementById('edit_cust_id').value = c.id;
			document.getElementById('cust_name').value = c.name;
			document.getElementById('cust_contact').value = c.contact || "";
			document.getElementById('cust_phone').value = c.phone || "";
			document.getElementById('cust_email').value = c.email || "";
			document.getElementById('cust_address').value = c.address;
			document.getElementById('cust_area').value = c.area;

			// Gi·ªØ nguy√™n t·ªça ƒë·ªô c≈©, kh√¥ng ghi ƒë√® t·ª± ƒë·ªông
			currentCoords = c.location || "";
			document.getElementById('cust_location').value = currentCoords;
			document.getElementById('btnGetGPS').innerText = "L·∫•y GPS m·ªõi";
			document.getElementById('gpsStatusCreate').innerHTML = "‚úÖ ƒêang s·ª≠ d·ª•ng v·ªã tr√≠ ƒë√£ l∆∞u";

			document.getElementById('btnCust').innerText = "C·∫≠p Nh·∫≠t Kh√°ch H√†ng";
			document.getElementById('btnCust').disabled = false;
			switchTab('create');
		}

		function resetCustomerForm() {
			document.getElementById('customerForm').reset();
			document.getElementById('edit_cust_id').value = "";
			document.getElementById('formTitle').innerText = "üÜï T·∫°o Kh√°ch H√†ng M·ªõi";
			document.getElementById('btnCust').innerText = "L∆∞u Kh√°ch H√†ng";
			currentCoords = "";
			document.getElementById('cust_location').value = "";
		}

		async function deleteCustomer(id) {
			if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√°ch h√†ng n√†y?")) return;

			try {
				const res = await fetch(CRM_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'deleteCustomer',
						id: id
					})
				});
				const data = await res.json();
				if (data.success) {
					showToast("ƒê√£ x√≥a kh√°ch h√†ng!");
					loadCustomers();
				} else {
					showToast("L·ªói: " + data.message, true);
				}
			} catch (e) {
				showToast("L·ªói k·∫øt n·ªëi khi x√≥a!", true);
			}
		}

		function viewCustomerDetail(id) {
			const c = customerList.find(x => x.id === id);
			if (!c) return;

			// Populate Data
			document.getElementById('det_name').innerText = c.name;
			document.getElementById('det_id').innerText = `ID: ${c.id}`;
			document.getElementById('det_contact').innerText = c.contact || 'Ch∆∞a c·∫≠p nh·∫≠t';
			document.getElementById('det_phone').innerText = c.phone || 'N/A';
			document.getElementById('det_address').innerText = c.address;
			document.getElementById('det_area').innerText = `üìç ${c.area}`;
			document.getElementById('det_location').innerText = c.location || 'N/A';
			document.getElementById('det_status').innerText = c.status;

			// Handle History
			const hist = checkinHistory.filter(h => h.customerId === id);
			const histContainer = document.getElementById('det_history');
			if (hist.length > 0) {
				histContainer.innerHTML = '<h3 style="font-size: 1rem; margin-bottom: 15px;">Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h3>' +
					hist.slice(0, 3).map(h => `
						<div class="history-item" style="margin-bottom: 8px; padding: 10px;">
							<div class="history-info">
								<div class="history-meta">
									<span>${formatTime(h.time)}</span>
									<span class="history-purpose">${h.purpose}</span>
								</div>
								<div style="font-size: 0.8rem; margin-top: 3px;">${h.note || ''}</div>
							</div>
						</div>
					`).join('');
			} else {
				histContainer.innerHTML = '';
			}

			document.getElementById('detailOverlay').classList.add('active');
		}

		function closeDetail() {
			document.getElementById('detailOverlay').classList.remove('active');
		}

		function openInGoogleMaps() {
			const loc = document.getElementById('det_location').innerText;
			if (loc && loc !== 'N/A') {
				window.open(`https://www.google.com/maps?q=${loc}`, '_blank');
			} else {
				showToast("Kh√°ch h√†ng n√†y ch∆∞a c√≥ t·ªça ƒë·ªô GPS!", true);
			}
		}

		function filterLocalList() {
			const q = document.getElementById('custSearch').value.toLowerCase();
			const filtered = customerList.filter(c =>
				c.name.toLowerCase().includes(q) ||
				c.area.toLowerCase().includes(q) ||
				c.id.toLowerCase().includes(q)
			);
			renderCustomerTable(filtered);
		}

		function haversine(loc1, loc2) {
			if (!loc1 || !loc2) return 0;
			const [lat1, lon1] = loc1.split(',').map(Number);
			const [lat2, lon2] = loc2.split(',').map(Number);
			const R = 6371e3;
			const dLat = (lat2 - lat1) * Math.PI / 180;
			const dLon = (lon2 - lon1) * Math.PI / 180;
			const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
			return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
		}

		function updateDistance() {
			const sel = document.getElementById('ci_customer');
			const opt = sel.options[sel.selectedIndex];
			if (!opt || !opt.value) return;
			const custLoc = opt.getAttribute('data-loc');
			const dist = haversine(custLoc, liveCoords);
			document.getElementById('ci_dist_display').innerText = dist + " m";
			if (dist > 500) {
				document.getElementById('ci_dist_display').style.color = '#ef4444';
				showToast("C·∫£nh b√°o: B·∫°n ƒëang ·ªü qu√° xa kh√°ch h√†ng (>500m)", true);
			} else {
				document.getElementById('ci_dist_display').style.color = '#22c55e';
			}
		}

		// Form Handlers
		document.getElementById('customerForm').onsubmit = async (e) => {
			e.preventDefault();
			const btn = document.getElementById('btnCust');
			btn.disabled = true;
			btn.innerText = "ƒêang l∆∞u...";

			const editId = document.getElementById('edit_cust_id').value;
			const payload = {
				action: editId ? 'updateCustomer' : 'createCustomer',
				id: editId || undefined,
				name: document.getElementById('cust_name').value,
				contact: document.getElementById('cust_contact').value,
				phone: document.getElementById('cust_phone').value,
				email: document.getElementById('cust_email').value,
				address: document.getElementById('cust_address').value,
				location: currentCoords,
				salesId: currentUser.email,
				area: document.getElementById('cust_area').value
			};

			const res = await fetch(CRM_URL, { method: 'POST', body: JSON.stringify(payload) });
			const data = await res.json();
			if (data.success) {
				showToast(editId ? "ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!" : "ƒê√£ t·∫°o kh√°ch h√†ng th√†nh c√¥ng!");
				e.target.reset();
				document.getElementById('edit_cust_id').value = "";
				document.getElementById('formTitle').innerText = "üÜï T·∫°o Kh√°ch H√†ng M·ªõi";
				document.getElementById('btnCust').innerText = "L∆∞u Kh√°ch H√†ng";
				loadCustomers();
				loadAreas();
			}
			btn.disabled = false;
			btn.innerText = editId ? "C·∫≠p Nh·∫≠t Kh√°ch H√†ng" : "L∆∞u Kh√°ch H√†ng";
		};

		document.getElementById('checkinForm').onsubmit = async (e) => {
			e.preventDefault();
			const btn = document.getElementById('btnCI');
			const fileInput = document.getElementById('ci_file');

			if (!fileInput.files[0]) {
				showToast("Vui l√≤ng ch·ª•p ·∫£nh minh ch·ª©ng!", true);
				return;
			}

			btn.disabled = true;
			btn.innerText = "ƒêang upload ·∫£nh...";

			// Upload file first
			const imageUrl = await uploadToDrive(fileInput.files[0]);
			if (!imageUrl) {
				showToast("L·ªói upload ·∫£nh!", true);
				btn.disabled = false;
				btn.innerText = "X√°c Nh·∫≠n Check-in";
				return;
			}

			const sel = document.getElementById('ci_customer');
			const custLoc = sel.options[sel.selectedIndex].getAttribute('data-loc');

			const payload = {
				action: 'handleCheckin',
				customerId: sel.value,
				customerLocation: custLoc,
				checkinLocation: currentCoords,
				salesId: currentUser.email,
				purpose: document.getElementById('ci_purpose').value,
				note: document.getElementById('ci_note').value,
				imageUrl: imageUrl
			};

			const res = await fetch(CRM_URL, { method: 'POST', body: JSON.stringify(payload) });
			const data = await res.json();
			if (data.success) {
				showToast("Check-in th√†nh c√¥ng!");
				e.target.reset();
				document.getElementById('ci_dist_display').innerText = "0 m";
				loadCheckinHistory(); // Refresh history
			}
			btn.disabled = false;
			btn.innerText = "X√°c Nh·∫≠n Check-in";
		};

		document.getElementById('docForm').onsubmit = async (e) => {
			e.preventDefault();
			const btn = document.getElementById('btnDoc');
			const fileInput = document.getElementById('doc_file');

			btn.disabled = true;
			btn.innerText = "ƒêang t·∫£i t·ªáp l√™n...";

			const fileUrl = await uploadToDrive(fileInput.files[0]);
			if (!fileUrl) {
				showToast("L·ªói t·∫£i t·ªáp!", true);
				btn.disabled = false;
				btn.innerText = "Th√™m T√†i Li·ªáu";
				return;
			}

			const payload = {
				action: 'addDoc',
				customerId: document.getElementById('doc_customer').value,
				docName: document.getElementById('doc_name').value,
				type: document.getElementById('doc_type').value,
				fileUrl: fileUrl,
				note: document.getElementById('doc_note').value
			};

			const res = await fetch(CRM_URL, { method: 'POST', body: JSON.stringify(payload) });
			const data = await res.json();
			if (data.success) {
				showToast("ƒê√£ l∆∞u t√†i li·ªáu!");
				e.target.reset();
			}
			btn.disabled = false;
			btn.innerText = "Th√™m T√†i Li·ªáu";
		};

		initGPS();
	</script>
</body>

</html>