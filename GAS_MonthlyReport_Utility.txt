/**
 * GAS_MonthlyReport_Utility.txt
 * H·ªÜ TH·ªêNG T·ªîNG H·ª¢P B√ÅO C√ÅO TH√ÅNG & T·∫†O FILE D·ªÆ LI·ªÜU CHI TI·∫æT (LINK GOOGLE SHEET)
 * (Script n√†y n√™n ƒë∆∞·ª£c tri·ªÉn khai d∆∞·ªõi d·∫°ng Web App ƒë·ªôc l·∫≠p)
 */

const REPORT_CRM_SS_ID = '15niaoQ7FozkRCushPGNtq4zj6pwA0UQ5Wel61ksv8L8';
const REPORT_AUTH_SS_ID = '1rhP1UCiMLi8yNVvcd56SsZIJAm09Yxu6WpjxuHKYKb0';
const REPORT_DATA_FOLDER_ID = '1_LT4rzVui2E3BgfcwUSfMsUGQMN9NRTs';
const REPORT_ORDER_HEADER_FILE = 'order.json';
const REPORT_ORDER_DETAIL_FILE = 'order_chi_tiet.json';

// --- ƒêI·ªÇM TI·∫æP NH·∫¨N Y√äU C·∫¶U T·ª™ GIAO DI·ªÜN WEB ---
// --- ƒêI·ªÇM TI·∫æP NH·∫¨N Y√äU C·∫¶U T·ª™ GIAO DI·ªÜN WEB ---
function doPost(e) {
  let result;
  try {
    const data = JSON.parse(e.postData.contents);
    
    // KI·ªÇM TRA KH√ìA (LOCK) - CH·ªêNG XUNG ƒê·ªòT D·ªÆ LI·ªÜU
    const cache = CacheService.getScriptCache();
    const lockKey = 'REPORT_GENERATING_LOCK';
    
    if (cache.get(lockKey)) {
      return ContentService.createTextOutput(JSON.stringify({ 
        success: false, 
        message: 'H·ªá th·ªëng ƒëang x·ª≠ l√Ω b√°o c√°o cho Admin kh√°c. Vui l√≤ng ƒë·ª£i 15 ph√∫t ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n d·ªØ li·ªáu.' 
      })).setMimeType(ContentService.MimeType.JSON);
    }

    // ƒê·∫∑t kh√≥a trong 15 ph√∫t (900 gi√¢y)
    cache.put(lockKey, 'TRUE', 900);

    if (data.action === 'sendMonthlyReport') {
      result = sendMonthlyAdminReport(data.month, data.year);
      // X·ª≠ l√Ω xong th√¨ gi·∫£i ph√≥ng kh√≥a ƒë·ªÉ ng∆∞·ªùi kh√°c c√≥ th·ªÉ d√πng ti·∫øp (n·∫øu xong s·ªõm h∆°n 15p)
      // Tuy nhi√™n theo y√™u c·∫ßu c·ªßa b·∫°n l√† "ƒë·ª£i 15 ph√∫t", ta c√≥ th·ªÉ gi·ªØ kh√≥a ho·∫∑c x√≥a t√πy √Ω.
      // ·ªû ƒë√¢y t√¥i ch·ªçn x√≥a kh√≥a ngay khi xong ƒë·ªÉ ti·ªán test, n·∫øu b·∫°n mu·ªën c·ª©ng nh·∫Øc 15p th√¨ comment d√≤ng d∆∞·ªõi.
      cache.remove(lockKey); 
    } else if (data.action === 'setupTrigger') {
      result = { success: true, message: initMonthlyTrigger() };
    } else {
      result = { success: false, message: 'H√†nh ƒë·ªông kh√¥ng h·ª£p l·ªá' };
    }

  } catch (error) {
    result = { success: false, message: 'L·ªói Backend Report: ' + error.toString() };
    CacheService.getScriptCache().remove('REPORT_GENERATING_LOCK'); // M·ªü kh√≥a n·∫øu l·ªói
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

/**
 * H√†m ch√≠nh th·ª±c hi·ªán g·ª≠i b√°o c√°o th√°ng cho c√°c Admin
 */
function sendMonthlyAdminReport(month, year) {
  const now = new Date();
  const targetMonth = month || (now.getMonth() + 1);
  const targetYear = year || now.getFullYear();
  
  // ƒê·∫£m b·∫£o th∆∞ m·ª•c l∆∞u tr·ªØ t·ªìn t·∫°i
  const reportFolder = getOrCreateReportFolder();

  const hierarchy = getAdminSalesHierarchy();
  const allCustomers = getMonthlyCustomers(targetMonth, targetYear);
  const allOrders = getMonthlyOrders(targetMonth, targetYear);
  const allOrderDetails = getMonthlyOrderDetails(allOrders.map(o => o.id_don_hang));

  for (let adminEmail in hierarchy) {
    const subordinates = hierarchy[adminEmail]; 
    const staffReports = [];
    let adminTotalRevenue = 0;

    const adminCustomersRaw = allCustomers.filter(c => subordinates.includes(c.salesId.toLowerCase()));
    const adminOrdersRaw = allOrders.filter(o => subordinates.includes(o.salesId.toLowerCase()));
    const adminOrderIds = adminOrdersRaw.map(o => o.id_don_hang);
    const adminDetailsRaw = allOrderDetails.filter(d => adminOrderIds.includes(d.id_don_hang));

    subordinates.forEach(staffEmail => {
      const emailLower = staffEmail.toLowerCase();
      const staffCustomers = adminCustomersRaw.filter(c => c.salesId.toLowerCase() === emailLower);
      const staffOrders = adminOrdersRaw.filter(o => o.salesId.toLowerCase() === emailLower);
      const staffRevenue = staffOrders.reduce((sum, o) => sum + (o.value || 0), 0);
      
      staffReports.push({
        email: staffEmail,
        name: getStaffName(staffEmail),
        customerCount: staffCustomers.length,
        orderCount: staffOrders.length,
        revenue: staffRevenue
      });
      adminTotalRevenue += staffRevenue;
    });

    if (staffReports.length > 0) {
      // T·∫†O FILE SHEET V√Ä L∆ØU V√ÄO TH∆Ø M·ª§C RI√äNG
      const sheetUrl = generateDataSheet(adminCustomersRaw, adminOrdersRaw, adminDetailsRaw, targetMonth, targetYear, adminEmail, reportFolder);
      sendEmailToAdmin(adminEmail, staffReports, adminTotalRevenue, targetMonth, targetYear, sheetUrl);
    }
  }

  return { success: true, message: `ƒê√£ g·ª≠i b√°o c√°o th√°ng ${targetMonth}/${targetYear}` };
}

/**
 * T·∫°o/L·∫•y th∆∞ m·ª•c "Bao_Cao_Thang" ƒë·ªÉ gom g·ªçn file
 */
function getOrCreateReportFolder() {
  const folders = DriveApp.getFoldersByName("Bao_Cao_Thang");
  if (folders.hasNext()) {
    return folders.next();
  } else {
    return DriveApp.createFolder("Bao_Cao_Thang");
  }
}

function generateDataSheet(customers, orders, details, month, year, adminEmail, folder) {
  const fileName = `[TEMP] D·ªØ li·ªáu T${month}/${year} - ${adminEmail}`;
  
  // T√¨m v√† x√≥a file c≈© c·ªßa Admin n√†y trong th√°ng n√†y (C∆° ch·∫ø Override)
  const existingFiles = folder.getFilesByName(fileName);
  while (existingFiles.hasNext()) {
    existingFiles.next().setTrashed(true);
  }

  const ss = SpreadsheetApp.create(fileName);
  
  // Di chuy·ªÉn file v√†o th∆∞ m·ª•c b√°o c√°o
  const file = DriveApp.getFileById(ss.getId());
  file.moveTo(folder);

  // Sheet 1: Kh√°ch h√†ng m·ªõi
  const sheetKH = ss.getActiveSheet();
  sheetKH.setName("KH M·ªõi");
  const khHeaders = ['ID', 'T√™n Kh√°ch', 'Ng∆∞·ªùi li√™n h·ªá', 'SƒêT', 'ƒê·ªãa ch·ªâ', 'Khu v·ª±c', 'Sale ph·ª• tr√°ch', 'Ng√†y t·∫°o'];
  sheetKH.appendRow(khHeaders);
  sheetKH.getRange(1, 1, 1, khHeaders.length).setFontWeight('bold').setBackground('#f1f5f9');
  customers.forEach(c => {
    sheetKH.appendRow([c.id, c.name, c.contact, c.phone, c.address, c.area, c.salesId, c.dateStr]);
  });
  sheetKH.autoResizeColumns(1, 8);
  
  // Sheet 2: ƒê∆°n h√†ng
  const sheetOrder = ss.insertSheet("ƒê∆°n h√†ng");
  const oh = ['ID ƒê∆°n', 'Kh√°ch h√†ng', 'Sale', 'Ng√†y ƒë∆°n', 'Tr·∫°ng th√°i', 'Gi√° tr·ªã', 'C√≤n l·∫°i'];
  sheetOrder.appendRow(oh);
  sheetOrder.getRange(1, 1, 1, oh.length).setFontWeight('bold').setBackground('#f1f5f9');
  
  orders.forEach(o => {
    const fmt = (n) => (n || 0).toLocaleString('vi-VN');
    sheetOrder.appendRow([
      o.id_don_hang, 
      o.ten_khach_hang, 
      o.nguoi_len_don, 
      o.ngay_len_don, 
      o.trang_thai_don_hang, 
      fmt(o.tong_tien_dich_vu || o.tong_gia_tri),      
      fmt(o.so_tien_con_lai)    
    ]);
  });
  sheetOrder.autoResizeColumns(1, 7);

  // Sheet 3: Chi ti·∫øt s·∫£n ph·∫©m
  const sheetDetail = ss.insertSheet("Chi ti·∫øt s·∫£n ph·∫©m");
  const dh = ['ID ƒê∆°n', 'T√™n s·∫£n ph·∫©m', 'ƒê∆°n gi√°', 'S·ªë l∆∞·ª£ng', 'Th√†nh ti·ªÅn'];
  sheetDetail.appendRow(dh);
  sheetDetail.getRange(1, 1, 1, dh.length).setFontWeight('bold').setBackground('#f1f5f9');
  
  details.forEach(d => {
    const fmt = (n) => (n || 0).toLocaleString('vi-VN');
    sheetDetail.appendRow([
      d.id_don_hang, 
      d.ten_san_pham, 
      fmt(d.gia_tien),      
      d.so_luong, 
      fmt(d.thanh_tien)    
    ]);
  });
  sheetDetail.autoResizeColumns(1, 5);

  return ss.getUrl();
}


/**
 * L·∫•y c·∫•u tr√∫c Admin - Sale
 */
function getAdminSalesHierarchy() {
  const ss = SpreadsheetApp.openById(REPORT_AUTH_SS_ID);
  const useSheet = ss.getSheetByName('use');
  const data = useSheet.getDataRange().getValues();
  const hierarchy = {};
  for (let i = 1; i < data.length; i++) {
    const adminEmail = (data[i][5] || "").toString().toLowerCase();
    if (adminEmail && adminEmail !== 'n/a') {
      if (!hierarchy[adminEmail]) hierarchy[adminEmail] = [];
      hierarchy[adminEmail].push(data[i][1].toString().toLowerCase());
    }
  }
  return hierarchy;
}

function getStaffName(email) {
  const ss = SpreadsheetApp.openById(REPORT_AUTH_SS_ID);
  const data = ss.getSheetByName('use').getDataRange().getValues();
  const found = data.find(r => r[1].toString().toLowerCase() === email.toLowerCase());
  return found ? found[3] : email;
}

function getMonthlyCustomers(month, year) {
  const ss = SpreadsheetApp.openById(REPORT_CRM_SS_ID);
  const data = ss.getSheetByName('data_khach_hang').getDataRange().getValues();
  const results = [];
  for (let i = 1; i < data.length; i++) {
    const d = new Date(data[i][9]);
    if (d.getMonth() + 1 === month && d.getFullYear() === year) {
      results.push({
        id: data[i][0], name: data[i][1], contact: data[i][2], phone: data[i][3],
        address: data[i][5], salesId: data[i][7], area: data[i][8],
        dateStr: Utilities.formatDate(d, "GMT+7", "dd/MM/yyyy")
      });
    }
  }
  return results;
}

function getMonthlyOrders(month, year) {
  const folder = DriveApp.getFolderById(REPORT_DATA_FOLDER_ID);
  const files = folder.getFilesByName(REPORT_ORDER_HEADER_FILE);
  if (!files.hasNext()) return [];
  const content = JSON.parse(files.next().getBlob().getDataAsString() || '[]');
  const results = [];
  const finalizedStatuses = ['ƒë∆°n ch·ªët', 'ho√†n th√†nh'];
  content.forEach(o => {
    const status = (o.trang_thai_don_hang || "").toLowerCase();
    if (!finalizedStatuses.includes(status)) return;
    const parts = o.ngay_len_don.split(' ');
    if (parts.length < 2) return;
    const dateParts = parts[1].split('/');
    if (parseInt(dateParts[1]) === month && parseInt(dateParts[2]) === year) {
      o.value = parseMoney(o.so_tien_con_lai || o.tong_gia_tri || 0);
      o.salesId = (o.nguoi_len_don || "").toLowerCase();
      results.push(o);
    }
  });
  return results;
}

function getMonthlyOrderDetails(orderIds) {
  if (orderIds.length === 0) return [];
  const folder = DriveApp.getFolderById(REPORT_DATA_FOLDER_ID);
  const files = folder.getFilesByName(REPORT_ORDER_DETAIL_FILE);
  if (!files.hasNext()) return [];
  const allDetails = JSON.parse(files.next().getBlob().getDataAsString() || '[]');
  return allDetails.filter(d => orderIds.includes(d.id_don_hang));
}

function parseMoney(val) {
  if (typeof val === 'number') return val;
  return parseFloat(val ? val.toString().replace(/[^\d]/g, '') : 0);
}


function sendEmailToAdmin(adminEmail, staffReports, totalRevenue, month, year, sheetUrl) {
  const fmt = (num) => num.toLocaleString('vi-VN') + " ƒë";
  let rowsHtml = staffReports.map(s => `
    <tr>
      <td style="padding:10px; border-bottom:1px solid #eee;"><b>${s.name}</b><br><small>${s.email}</small></td>
      <td style="padding:10px; border-bottom:1px solid #eee; text-align:center;">${s.customerCount}</td>
      <td style="padding:10px; border-bottom:1px solid #eee; text-align:center;">${s.orderCount}</td>
      <td style="padding:10px; border-bottom:1px solid #eee; text-align:right; font-weight:bold; color:#6366f1;">${fmt(s.revenue)}</td>
    </tr>`).join('');

  const htmlBody = `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: auto; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden;">
      <div style="background: #1e1b4b; color: white; padding: 25px; text-align: center;">
        <h2 style="margin:0; text-transform: uppercase;">B√ÅO C√ÅO T·ªîNG H·ª¢P TH√ÅNG ${month}/${year}</h2>
        <p style="margin:5px 0 0; opacity: 0.8;">H·ªá th·ªëng Qu·∫£n l√Ω Dunvex Digital</p>
      </div>
      <div style="padding: 20px;">
        
        <div style="background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 13px;">
          ‚ö†Ô∏è <b>QUAN TR·ªåNG:</b> ƒê·ªÉ tr√°nh xung ƒë·ªôt d·ªØ li·ªáu, h·ªá th·ªëng ch·ªâ l∆∞u file b√°o c√°o t·∫°m th·ªùi. 
          Vui l√≤ng <b>T·∫¢I XU·ªêNG</b> m√°y t√≠nh ngay. <br>
          N·∫øu c√≥ ng∆∞·ªùi kh√°c ƒëang t·∫°o b√°o c√°o, b·∫°n vui l√≤ng ƒë·ª£i <b>15 ph√∫t</b> sau m·ªõi t·∫°o l·∫°i ƒë∆∞·ª£c.
        </div>

        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #6366f1;">
          <div style="font-size: 13px; color: #64748b; font-weight: bold;">T·ªîNG DOANH THU ƒê∆†N CH·ªêT TRONG TH√ÅNG</div>
          <div style="font-size: 26px; font-weight: 800; color: #1e1b4b;">${fmt(totalRevenue)}</div>
        </div>
        
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 25px;">
          <thead>
            <tr style="background: #f1f5f9; text-align: left; font-size: 11px; color: #64748b;">
              <th style="padding: 10px;">NH√ÇN VI√äN</th>
              <th style="padding: 10px; text-align: center;">KH M·ªöI</th>
              <th style="padding: 10px; text-align: center;">ƒê∆†N CH·ªêT</th>
              <th style="padding: 10px; text-align: right;">DOANH S·ªê</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
        </table>

        <div style="text-align: center; margin-top: 20px;">
          <a href="${sheetUrl}" target="_blank" style="display: inline-block; padding: 12px 24px; background: #22c55e; color: white; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 14px;">
            üìÇ XEM V√Ä T·∫¢I D·ªÆ LI·ªÜU (GOOGLE SHEET)
          </a>
          <p style="font-size: 12px; color: #64748b; margin-top: 10px;">
            (Nh·∫•n v√†o n√∫t tr√™n -> Ch·ªçn menu T·ªáp -> T·∫£i xu·ªëng -> Excel)
          </p>
        </div>
      </div>
      <div style="background: #f1f5f9; padding: 15px; text-align: center; font-size: 11px; color: #94a3b8;">
        Th·ªùi gian xu·∫•t b√°o c√°o: ${Utilities.formatDate(new Date(), "GMT+7", "HH:mm dd/MM/yyyy")}
      </div>
    </div>`;

  MailApp.sendEmail({
    to: adminEmail,
    subject: `[B√ÅO C√ÅO TH√ÅNG] D·ªØ li·ªáu doanh s·ªë & Kh√°ch h√†ng th√°ng ${month}/${year} - Dunvex Digital`,
    htmlBody: htmlBody
  });
}

function initMonthlyTrigger() {
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(t => { if (t.getHandlerFunction() === 'sendReportForPreviousMonth') ScriptApp.deleteTrigger(t); });
  ScriptApp.newTrigger('sendReportForPreviousMonth').timeBased().onMonthDay(1).atHour(8).create();
  return "ƒê√£ thi·∫øt l·∫≠p b√°o c√°o t·ª± ƒë·ªông v√†o 8h s√°ng ng√†y 01 h√†ng th√°ng.";
}

function sendReportForPreviousMonth() {
  const now = new Date();
  let m = now.getMonth(); let y = now.getFullYear();
  if (m === 0) { m = 12; y--; } else { m++; }
  return sendMonthlyAdminReport(m, y);
}

/**
 * H√ÄM N√ÄY CH·ªà D√ôNG ƒê·ªÇ K√çCH HO·∫†T QUY·ªÄN (CH·∫†Y TH·ª¶ C√îNG 1 L·∫¶N TRONG EDITOR)
 * B·∫°n h√£y ch·ªçn h√†m n√†y v√† nh·∫•n n√∫t "Run" (Tam gi√°c) tr√™n thanh c√¥ng c·ª• ƒë·ªÉ c·∫•p quy·ªÅn.
 */
function manualAuthorize() {
  console.log("ƒêang k√≠ch ho·∫°t quy·ªÅn truy c·∫≠p...");
  
  // 1. K√≠ch ho·∫°t quy·ªÅn T·∫°o Th∆∞ m·ª•c & File (Quan tr·ªçng cho t√≠nh nƒÉng m·ªõi)
  const tempFolder = DriveApp.createFolder("Temp_Auth_Check_Delete_Me");
  tempFolder.setTrashed(true);

  // 2. K√≠ch ho·∫°t quy·ªÅn Spreadsheet
  const tempSheet = SpreadsheetApp.create("Temp_Sheet_Auth");
  DriveApp.getFileById(tempSheet.getId()).setTrashed(true);

  // 3. K√≠ch ho·∫°t quy·ªÅn Mail
  MailApp.getRemainingDailyQuota();
  
  // 4. K√≠ch ho·∫°t quy·ªÅn Cache
  CacheService.getScriptCache().put('test_lock', '1', 1);

  console.log("‚úÖ K√≠ch ho·∫°t quy·ªÅn th√†nh c√¥ng! B√¢y gi·ªù b·∫°n h√£y Deploy l·∫°i Web App.");
}
