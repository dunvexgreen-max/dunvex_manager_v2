/**
 * GAS_MonthlyReport_Utility.txt
 * H·ªÜ TH·ªêNG T·ªîNG H·ª¢P B√ÅO C√ÅO TH√ÅNG, G·ª¨I MAIL & ƒê√çNH K√àM FILE EXCEL PH√ÇN T√çCH
 * (Script n√†y n√™n ƒë∆∞·ª£c tri·ªÉn khai d∆∞·ªõi d·∫°ng Web App ƒë·ªôc l·∫≠p)
 */

const REPORT_CRM_SS_ID = '15niaoQ7FozkRCushPGNtq4zj6pwA0UQ5Wel61ksv8L8';
const REPORT_AUTH_SS_ID = '1rhP1UCiMLi8yNVvcd56SsZIJAm09Yxu6WpjxuHKYKb0';
const REPORT_DATA_FOLDER_ID = '1_LT4rzVui2E3BgfcwUSfMsUGQMN9NRTs';
const REPORT_ORDER_HEADER_FILE = 'order.json';
const REPORT_ORDER_DETAIL_FILE = 'order_chi_tiet.json';

// --- ƒêI·ªÇM TI·∫æP NH·∫¨N Y√äU C·∫¶U T·ª™ GIAO DI·ªÜN WEB ---
function doPost(e) {
  let result;
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;

    switch (action) {
      case 'sendMonthlyReport':
        result = sendMonthlyAdminReport(data.month, data.year);
        break;
      case 'setupTrigger':
        result = { success: true, message: initMonthlyTrigger() };
        break;
      default:
        result = { success: false, message: 'H√†nh ƒë·ªông kh√¥ng h·ª£p l·ªá' };
    }
  } catch (error) {
    result = { success: false, message: 'L·ªói Backend Report: ' + error.toString() };
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

/**
 * H√†m ch√≠nh th·ª±c hi·ªán g·ª≠i b√°o c√°o th√°ng cho c√°c Admin
 */
function sendMonthlyAdminReport(month, year) {
  const now = new Date();
  const targetMonth = month || (now.getMonth() + 1);
  const targetYear = year || now.getFullYear();
  
  console.log(`B·∫Øt ƒë·∫ßu t·∫°o b√°o c√°o th√°ng ${targetMonth}/${targetYear}`);

  const hierarchy = getAdminSalesHierarchy();
  const allCustomers = getMonthlyCustomers(targetMonth, targetYear);
  const allOrders = getMonthlyOrders(targetMonth, targetYear);
  const allOrderDetails = getMonthlyOrderDetails(allOrders.map(o => o.id_don_hang));

  for (let adminEmail in hierarchy) {
    const subordinates = hierarchy[adminEmail]; 
    const staffReports = [];
    let adminTotalRevenue = 0;

    // L·ªçc d·ªØ li·ªáu th√¥ cho Admin n√†y ƒë·ªÉ l√†m file ƒë√≠nh k√®m
    const adminCustomersRaw = allCustomers.filter(c => subordinates.includes(c.salesId.toLowerCase()));
    const adminOrdersRaw = allOrders.filter(o => subordinates.includes(o.salesId.toLowerCase()));
    const adminOrderIds = adminOrdersRaw.map(o => o.id_don_hang);
    const adminDetailsRaw = allOrderDetails.filter(d => adminOrderIds.includes(d.id_don_hang));

    subordinates.forEach(staffEmail => {
      const staffEmailLower = staffEmail.toLowerCase();
      const staffCustomers = adminCustomersRaw.filter(c => c.salesId.toLowerCase() === staffEmailLower);
      const staffOrders = adminOrdersRaw.filter(o => o.salesId.toLowerCase() === staffEmailLower);
      const staffRevenue = staffOrders.reduce((sum, o) => sum + (o.value || 0), 0);
      
      staffReports.push({
        email: staffEmail,
        name: getStaffName(staffEmail),
        customerCount: staffCustomers.length,
        orderCount: staffOrders.length,
        revenue: staffRevenue
      });

      adminTotalRevenue += staffRevenue;
    });

    if (staffReports.length > 0) {
      // T·∫°o file Excel ƒë√≠nh k√®m
      const excelBlob = generateExcelBlob(adminCustomersRaw, adminOrdersRaw, adminDetailsRaw, targetMonth, targetYear);
      sendEmailToAdmin(adminEmail, staffReports, adminTotalRevenue, targetMonth, targetYear, excelBlob);
    }
  }

  return { success: true, message: `ƒê√£ g·ª≠i b√°o c√°o th√°ng ${targetMonth}/${targetYear}` };
}

/**
 * T·∫°o file Excel (Spreadsheet) v√† tr·∫£ v·ªÅ Blob
 */
function generateExcelBlob(customers, orders, details, month, year) {
  const ss = SpreadsheetApp.create(`Bao_Cao_Chi_Tiet_Thang_${month}_${year}`);
  
  // Sheet 1: Kh√°ch h√†ng m·ªõi
  const sheetKH = ss.getActiveSheet();
  sheetKH.setName("KH Moi Trong Thang");
  const khHeaders = ['ID Kh√°ch', 'T√™n Kh√°ch H√†ng', 'Ng∆∞·ªùi Li√™n H·ªá', 'SƒêT', 'ƒê·ªãa Ch·ªâ', 'Khu V·ª±c', 'Sale Ph·ª• Tr√°ch', 'Ng√†y T·∫°o'];
  sheetKH.appendRow(khHeaders);
  sheetKH.getRange(1, 1, 1, khHeaders.length).setFontWeight('bold').setBackground('#f1f5f9');
  customers.forEach(c => {
    sheetKH.appendRow([c.id, c.name, c.contact, c.phone, c.address, c.area, c.salesId, c.dateStr]);
  });

  // Sheet 2: ƒê∆°n h√†ng ch·ªët
  const sheetOrder = ss.insertSheet("Danh Sach Don Hang");
  const orderHeaders = ['ID ƒê∆°n', 'Kh√°ch H√†ng', 'Sale L√™n ƒê∆°n', 'Ng√†y L√™n ƒê∆°n', 'Tr·∫°ng Th√°i', 'T·ªïng Gi√° Tr·ªã', 'S·ªë Ti·ªÅn C√≤n L·∫°i'];
  sheetOrder.appendRow(orderHeaders);
  sheetOrder.getRange(1, 1, 1, orderHeaders.length).setFontWeight('bold').setBackground('#f1f5f9');
  orders.forEach(o => {
    sheetOrder.appendRow([o.id_don_hang, o.ten_khach_hang, o.nguoi_len_don, o.ngay_len_don, o.trang_thai_don_hang, o.tong_gia_tri, o.so_tien_con_lai]);
  });

  // Sheet 3: Chi ti·∫øt s·∫£n ph·∫©m
  const sheetDetail = ss.insertSheet("Chi Tiet San Pham");
  const detailHeaders = ['ID ƒê∆°n', 'T√™n S·∫£n Ph·∫©m', 'ƒê∆°n Gi√°', 'S·ªë L∆∞·ª£ng', 'Th√†nh Ti·ªÅn'];
  sheetDetail.appendRow(detailHeaders);
  sheetDetail.getRange(1, 1, 1, detailHeaders.length).setFontWeight('bold').setBackground('#f1f5f9');
  details.forEach(d => {
    sheetDetail.appendRow([d.id_don_hang, d.ten_san_pham, d.don_gia, d.so_luong, d.thanh_tien]);
  });

  SpreadsheetApp.flush();
  
  // Export to XLSX
  const url = "https://docs.google.com/spreadsheets/d/" + ss.getId() + "/export?format=xlsx";
  const params = { method: "get", headers: { "Authorization": "Bearer " + ScriptApp.getOAuthToken() }, muteHttpExceptions: true };
  const blob = UrlFetchApp.fetch(url, params).getBlob().setName(`Dunvex_Report_T${month}_${year}.xlsx`);
  
  // X√≥a file t·∫°m tr√™n Drive (tr√°nh r√°c)
  DriveApp.getFileById(ss.getId()).setTrashed(true);
  
  return blob;
}

/**
 * L·∫•y c·∫•u tr√∫c Admin - Sale
 */
function getAdminSalesHierarchy() {
  const ss = SpreadsheetApp.openById(REPORT_AUTH_SS_ID);
  const useSheet = ss.getSheetByName('use');
  const data = useSheet.getDataRange().getValues();
  const hierarchy = {};
  for (let i = 1; i < data.length; i++) {
    const adminEmail = (data[i][5] || "").toString().toLowerCase();
    if (adminEmail && adminEmail !== 'n/a') {
      if (!hierarchy[adminEmail]) hierarchy[adminEmail] = [];
      hierarchy[adminEmail].push(data[i][1].toString().toLowerCase());
    }
  }
  return hierarchy;
}

function getStaffName(email) {
  const ss = SpreadsheetApp.openById(REPORT_AUTH_SS_ID);
  const data = ss.getSheetByName('use').getDataRange().getValues();
  const found = data.find(r => r[1].toString().toLowerCase() === email.toLowerCase());
  return found ? found[3] : email;
}

function getMonthlyCustomers(month, year) {
  const ss = SpreadsheetApp.openById(REPORT_CRM_SS_ID);
  const data = ss.getSheetByName('data_khach_hang').getDataRange().getValues();
  const results = [];
  for (let i = 1; i < data.length; i++) {
    const d = new Date(data[i][9]);
    if (d.getMonth() + 1 === month && d.getFullYear() === year) {
      results.push({
        id: data[i][0], name: data[i][1], contact: data[i][2], phone: data[i][3],
        address: data[i][5], salesId: data[i][7], area: data[i][8],
        dateStr: Utilities.formatDate(d, "GMT+7", "dd/MM/yyyy")
      });
    }
  }
  return results;
}

function getMonthlyOrders(month, year) {
  const folder = DriveApp.getFolderById(REPORT_DATA_FOLDER_ID);
  const files = folder.getFilesByName(REPORT_ORDER_HEADER_FILE);
  if (!files.hasNext()) return [];
  const content = JSON.parse(files.next().getBlob().getDataAsString() || '[]');
  const results = [];
  const finalizedStatuses = ['ƒë∆°n ch·ªët', 'ho√†n th√†nh'];
  content.forEach(o => {
    const status = (o.trang_thai_don_hang || "").toLowerCase();
    if (!finalizedStatuses.includes(status)) return;
    const parts = o.ngay_len_don.split(' ');
    if (parts.length < 2) return;
    const dateParts = parts[1].split('/');
    if (parseInt(dateParts[1]) === month && parseInt(dateParts[2]) === year) {
      o.value = parseMoney(o.so_tien_con_lai || o.tong_gia_tri || 0); // Ti·ªán t√≠nh doanh s·ªë
      o.salesId = (o.nguoi_len_don || "").toLowerCase();
      results.push(o);
    }
  });
  return results;
}

function getMonthlyOrderDetails(orderIds) {
  if (orderIds.length === 0) return [];
  const folder = DriveApp.getFolderById(REPORT_DATA_FOLDER_ID);
  const files = folder.getFilesByName(REPORT_ORDER_DETAIL_FILE);
  if (!files.hasNext()) return [];
  const allDetails = JSON.parse(files.next().getBlob().getDataAsString() || '[]');
  return allDetails.filter(d => orderIds.includes(d.id_don_hang));
}

function parseMoney(val) {
  if (typeof val === 'number') return val;
  return parseFloat(val ? val.toString().replace(/[^\d]/g, '') : 0);
}

function sendEmailToAdmin(adminEmail, staffReports, totalRevenue, month, year, attachment) {
  const fmt = (num) => num.toLocaleString('vi-VN') + " ƒë";
  let rowsHtml = staffReports.map(s => `
    <tr>
      <td style="padding:10px; border-bottom:1px solid #eee;"><b>${s.name}</b><br><small>${s.email}</small></td>
      <td style="padding:10px; border-bottom:1px solid #eee; text-align:center;">${s.customerCount}</td>
      <td style="padding:10px; border-bottom:1px solid #eee; text-align:center;">${s.orderCount}</td>
      <td style="padding:10px; border-bottom:1px solid #eee; text-align:right; font-weight:bold; color:#6366f1;">${fmt(s.revenue)}</td>
    </tr>`).join('');

  const htmlBody = `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: auto; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden;">
      <div style="background: #1e1b4b; color: white; padding: 25px; text-align: center;">
        <h2 style="margin:0; text-transform: uppercase;">B√ÅO C√ÅO T·ªîNG H·ª¢P TH√ÅNG ${month}/${year}</h2>
        <p style="margin:5px 0 0; opacity: 0.8;">H·ªá th·ªëng Qu·∫£n l√Ω Dunvex Digital</p>
      </div>
      <div style="padding: 20px;">
        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #6366f1;">
          <div style="font-size: 13px; color: #64748b; font-weight: bold;">T·ªîNG DOANH THU ƒê∆†N CH·ªêT TRONG TH√ÅNG</div>
          <div style="font-size: 26px; font-weight: 800; color: #1e1b4b;">${fmt(totalRevenue)}</div>
        </div>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
          <thead>
            <tr style="background: #f1f5f9; text-align: left; font-size: 11px; color: #64748b;">
              <th style="padding: 10px;">NH√ÇN VI√äN</th>
              <th style="padding: 10px; text-align: center;">KH M·ªöI</th>
              <th style="padding: 10px; text-align: center;">ƒê∆†N CH·ªêT</th>
              <th style="padding: 10px; text-align: right;">DOANH S·ªê</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
        </table>
        <div style="padding: 15px; background: #f0fdf4; border-radius: 8px; border: 1px solid #bbf7d0; color: #166534; font-size: 13px;">
          üìé <b>Th√¥ng b√°o:</b> H·ªá th·ªëng ƒë√£ ƒë√≠nh k√®m file Excel chi ti·∫øt ch·ª©a danh s√°ch kh√°ch h√†ng v√† ƒë∆°n h√†ng trong th√°ng ƒë·ªÉ b·∫°n c√≥ th·ªÉ t·∫£i v·ªÅ ph√¢n t√≠ch.
        </div>
      </div>
      <div style="background: #f1f5f9; padding: 15px; text-align: center; font-size: 11px; color: #94a3b8;">
        Th·ªùi gian xu·∫•t b√°o c√°o: ${Utilities.formatDate(new Date(), "GMT+7", "HH:mm dd/MM/yyyy")}
      </div>
    </div>`;

  MailApp.sendEmail({
    to: adminEmail,
    subject: `[B√ÅO C√ÅO TH√ÅNG] D·ªØ li·ªáu doanh s·ªë & Kh√°ch h√†ng th√°ng ${month}/${year} - Dunvex Digital`,
    htmlBody: htmlBody,
    attachments: [attachment]
  });
}

function initMonthlyTrigger() {
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(t => { if (t.getHandlerFunction() === 'sendReportForPreviousMonth') ScriptApp.deleteTrigger(t); });
  ScriptApp.newTrigger('sendReportForPreviousMonth').timeBased().onMonthDay(1).atHour(8).create();
  return "ƒê√£ thi·∫øt l·∫≠p b√°o c√°o t·ª± ƒë·ªông v√†o 8h s√°ng ng√†y 01 h√†ng th√°ng.";
}

function sendReportForPreviousMonth() {
  const now = new Date();
  let m = now.getMonth(); let y = now.getFullYear();
  if (m === 0) { m = 12; y--; } else { m++; }
  return sendMonthlyAdminReport(m, y);
}

/**
 * H√ÄM N√ÄY CH·ªà D√ôNG ƒê·ªÇ K√çCH HO·∫†T QUY·ªÄN (CH·∫†Y TH·ª¶ C√îNG 1 L·∫¶N TRONG EDITOR)
 * H√£y ch·ªçn h√†m n√†y trong danh s√°ch v√† nh·∫•n "Run" (Ch·∫°y) ƒë·ªÉ Google hi·ªÉn th·ªã b·∫£ng h·ªèi quy·ªÅn.
 */
function manualAuthorize() {
  Logger.log("ƒêang k√≠ch ho·∫°t quy·ªÅn truy c·∫≠p...");
  DriveApp.getRootFolder();
  SpreadsheetApp.create("Temp");
  MailApp.getRemainingDailyQuota();
  UrlFetchApp.fetch("https://www.google.com");
  Logger.log("K√≠ch ho·∫°t quy·ªÅn th√†nh c√¥ng! B√¢y gi·ªù b·∫°n c√≥ th·ªÉ d√πng n√∫t b√°o c√°o tr√™n web.");
}

/**
 * OAuth Scopes required:
 * https://www.googleapis.com/auth/spreadsheets
 * https://www.googleapis.com/auth/drive
 * https://www.googleapis.com/auth/script.external_request
 * https://www.googleapis.com/auth/script.send_mail
 */
