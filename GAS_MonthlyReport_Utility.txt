/**
 * GAS_MonthlyReport_Utility.txt
 * H·ªÜ TH·ªêNG T·ªîNG H·ª¢P B√ÅO C√ÅO DOANH THU THEO KHO·∫¢NG TH·ªúI GIAN
 * (Updated: Date Range Support + XOR Encryption Compatibility)
 */

const REPORT_CRM_SS_ID = '15niaoQ7FozkRCushPGNtq4zj6pwA0UQ5Wel61ksv8L8';
const REPORT_AUTH_SS_ID = '1rhP1UCiMLi8yNVvcd56SsZIJAm09Yxu6WpjxuHKYKb0';
const REPORT_DATA_FOLDER_ID = '1_LT4rzVui2E3BgfcwUSfMsUGQMN9NRTs';
const REPORT_ORDER_HEADER_FILE = 'order.json';
const REPORT_ORDER_DETAIL_FILE = 'order_chi_tiet.json';
const MASTER_SPREADSHEET_ID = '1SiB4k-T7HoT9cNv-Q8KPIS3AnA6C_8HAX0hFyR3ZWOc';
const MASTER_SHEET_NAME = 'menu';

// --- ENCRYPTION HELPERS (COPIED FOR STANDALONE LOGIC) ---
const XOR_SECRET = 'dunvex_secure_key_2025_custom';
const AES_KEY = Utilities.newBlob('dunvex_secure_16').getBytes();

function decryptXOR(base64Text) {
  if (!base64Text || base64Text.length < 5 || base64Text.startsWith("ENC_ERR")) return base64Text;
  try {
    const inputBytes = Utilities.base64Decode(base64Text);
    const keyBytes = Utilities.newBlob(XOR_SECRET).getBytes();
    const outputBytes = [];
    for (let i = 0; i < inputBytes.length; i++) {
        outputBytes.push(inputBytes[i] ^ keyBytes[i % keyBytes.length]);
    }
    return Utilities.newBlob(outputBytes).getDataAsString();
  } catch (e) { return base64Text; }
}

function decryptAES(base64Text) {
  if (!base64Text || base64Text.length < 10) return base64Text;
  try {
    const decoded = Utilities.base64Decode(base64Text);
    const decrypted = Utilities.decrypt(Utilities.CipherAlgorithm.AES_128, AES_KEY, decoded);
    return decrypted.getDataAsString();
  } catch (e) { return null; }
}

function decryptData(base64Text) {
  let dec = decryptXOR(base64Text);
  if ((!dec || !dec.includes('@')) && base64Text) {
     const aes = decryptAES(base64Text);
     if (aes && aes.includes('@')) return aes;
  }
  return dec || base64Text;
}

function getUserPackage(email) {
  try {
    const ss = SpreadsheetApp.openById(MASTER_SPREADSHEET_ID);
    const sheet = ss.getSheetByName(MASTER_SHEET_NAME);
    if (!sheet) return { package: 'Free', expiry: '' };
    const rows = sheet.getDataRange().getValues();
    const config = rows.find(r => r[0].toString().toLowerCase() === email.toLowerCase());
    return config ? { package: config[1], expiry: config[3] } : { package: 'Free', expiry: '' };
  } catch (e) { return { package: 'Free', expiry: '' }; }
}
// ------------------------------------------------------------

function doPost(e) {
  let result;
  try {
    const cache = CacheService.getScriptCache();
    const lockKey = 'REPORT_GENERATING_LOCK';
    
    const contents = e.postData ? e.postData.contents : "";
    if (!contents) return ContentService.createTextOutput(JSON.stringify({ success: false, message: 'No Data' })).setMimeType(ContentService.MimeType.JSON);
    
    const data = JSON.parse(contents);
    const requester = (data.requesterEmail || "").toLowerCase().trim();
    
    // Ki·ªÉm tra Premium ƒë·ªÉ b·ªè qua gi·ªõi h·∫°n 5 ph√∫t
    const pkgInfo = getUserPackage(requester);
    const isPremium = pkgInfo.package === 'Premium';

    if (cache.get(lockKey) && !isPremium) {
      return ContentService.createTextOutput(JSON.stringify({ 
        success: false, 
        message: 'H·ªá th·ªëng ƒëang x·ª≠ l√Ω b√°o c√°o kh√°c. Vui l√≤ng ƒë·ª£i 5 ph√∫t (Ho·∫∑c n√¢ng c·∫•p Premium ƒë·ªÉ d√πng ngay).' 
      })).setMimeType(ContentService.MimeType.JSON);
    }
    cache.put(lockKey, 'TRUE', 300); // Lock 5 mins

    const action = (data.action || "").toString().trim();
    
    if (action === 'sendReportByDate') {
      result = sendAdminReportByDate(data.startDate, data.endDate, data.requesterEmail);
      cache.remove(lockKey); 
    } else if (action === 'getRevenueData') {
      result = getRevenueData(data);
      cache.remove(lockKey);
    } else if (action === 'setupTrigger') {
      result = { success: true, message: initMonthlyTrigger() };
    } else {
      return ContentService.createTextOutput(JSON.stringify({ 
        success: false, 
        message: 'H√†nh ƒë·ªông [' + action + '] kh√¥ng h·ª£p l·ªá t·∫°i Report Script. Vui l√≤ng ki·ªÉm tra SCRIPT_URL.' 
      })).setMimeType(ContentService.MimeType.JSON);
    }

  } catch (error) {
    result = { success: false, message: 'Err: ' + error.toString() };
    CacheService.getScriptCache().remove('REPORT_GENERATING_LOCK');
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

function sendAdminReportByDate(startStr, endStr, requester) {
  // Parse Dates
  let startDate, endDate;
  const now = new Date();
  
  if (startStr && endStr) {
      // Expect YYYY-MM-DD
      const s = startStr.split('-');
      const e = endStr.split('-');
      startDate = new Date(s[0], s[1]-1, s[2], 0, 0, 0);
      endDate = new Date(e[0], e[1]-1, e[2], 23, 59, 59);
  } else {
      // Default: Last month
      startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      endDate = new Date(now.getFullYear(), now.getMonth(), 0);
  }

  const reportFolder = getOrCreateReportFolder();
  const hierarchy = getAdminSalesHierarchy();
  const allCustomers = getCustomersByDateRange(startDate, endDate);
  const allOrders = getOrdersByDateRange(startDate, endDate);
  const allOrderDetails = getMonthlyOrderDetails(allOrders.map(o => o.id_don_hang)); // Helper handles list

  // Determine who to send to
  // If requester is provided, only send to them (if they are Admin).
  // If not, send to ALL admins (Auto-trigger case).
  
  let targetAdmins = Object.keys(hierarchy);
  if (requester) {
    targetAdmins = [requester.toLowerCase()];
  }

  let sentCount = 0;
  for (let adminEmail of targetAdmins) {
    const subordinates = [adminEmail].concat(hierarchy[adminEmail] || []); 
    
    // Add Admin themselves to subordinates to see own sales? usually yes
    // But our logic separates Admin vs Sale Roles. 
    // If admin also creates orders, they should be in 'subordinates' list if 'use' sheet says so?
    // Current logic: subordinates comes from 'use' sheet where Admin assigns manager.
    
    const staffReports = [];
    let adminTotalRevenue = 0;

    // Filter Data for this Admin's team
    const adminCustomersRaw = allCustomers.filter(c => subordinates.includes(c.salesId));
    const adminOrdersRaw = allOrders.filter(o => subordinates.includes(o.salesId));
    const adminOrderIds = adminOrdersRaw.map(o => o.id_don_hang);
    const adminDetailsRaw = allOrderDetails.filter(d => adminOrderIds.includes(d.id_don_hang));

    subordinates.forEach(staffEmail => {
      const emailLower = staffEmail.toLowerCase();
      const staffCustomers = adminCustomersRaw.filter(c => c.salesId === emailLower);
      const staffOrders = adminOrdersRaw.filter(o => o.salesId === emailLower);
      const staffRevenue = staffOrders.reduce((sum, o) => sum + (o.value || 0), 0);
      
      // Only include if they have data OR if we want full roster
      if (staffCustomers.length > 0 || staffOrders.length > 0) {
        staffReports.push({
            email: staffEmail,
            name: getStaffName(staffEmail),
            customerCount: staffCustomers.length,
            orderCount: staffOrders.length,
            revenue: staffRevenue
        });
        adminTotalRevenue += staffRevenue;
      }
    });

    if (staffReports.length > 0) {
      const dateLabel = `${Utilities.formatDate(startDate, "GMT+7", "dd/MM")} - ${Utilities.formatDate(endDate, "GMT+7", "dd/MM/yyyy")}`;
      const sheetUrl = generateDataSheet(adminCustomersRaw, adminOrdersRaw, adminDetailsRaw, dateLabel, adminEmail, reportFolder);
      sendEmailToAdmin(adminEmail, staffReports, adminTotalRevenue, dateLabel, sheetUrl);
      sentCount++;
    }
  }

  return { success: true, message: `ƒê√£ g·ª≠i b√°o c√°o (${sentCount} qu·∫£n l√Ω)` };
}

function getOrCreateReportFolder() {
  const folders = DriveApp.getFoldersByName("Bao_Cao_Doanh_Thu");
  if (folders.hasNext()) return folders.next();
  return DriveApp.createFolder("Bao_Cao_Doanh_Thu");
}

function generateDataSheet(customers, orders, details, dateLabel, adminEmail, folder) {
  const fileName = `[TEMP] B√°o C√°o ${dateLabel} - ${adminEmail}`;
  const existingFiles = folder.getFilesByName(fileName);
  while (existingFiles.hasNext()) existingFiles.next().setTrashed(true);

  const ss = SpreadsheetApp.create(fileName);
  DriveApp.getFileById(ss.getId()).moveTo(folder);
  try { DriveApp.getFileById(ss.getId()).setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW); } catch (e) {}

  // Sheets...
  const sheetKH = ss.getActiveSheet();
  sheetKH.setName("KH M·ªõi");
  sheetKH.appendRow(['ID', 'T√™n Kh√°ch', 'Ng∆∞·ªùi li√™n h·ªá', 'SƒêT', 'ƒê·ªãa ch·ªâ', 'Khu v·ª±c', 'Sale ph·ª• tr√°ch', 'Ng√†y t·∫°o']);
  customers.forEach(c => sheetKH.appendRow([c.id, c.name, c.contact, c.phone, c.address, c.area, c.salesId, c.dateStr]));
  
  const sheetOrder = ss.insertSheet("ƒê∆°n h√†ng");
  sheetOrder.appendRow(['ID ƒê∆°n', 'Kh√°ch h√†ng', 'Sale', 'Ng√†y ƒë∆°n', 'Tr·∫°ng th√°i', 'Gi√° tr·ªã', 'C√≤n l·∫°i']);
  orders.forEach(o => sheetOrder.appendRow([o.id_don_hang, o.ten_khach_hang, o.nguoi_len_don, o.ngay_len_don, o.trang_thai_don_hang, (o.value||0), (o.so_tien_con_lai||0)]));

  const sheetDetail = ss.insertSheet("Chi ti·∫øt");
  sheetDetail.appendRow(['ID ƒê∆°n', 'T√™n s·∫£n ph·∫©m', 'ƒê∆°n gi√°', 'S·ªë l∆∞·ª£ng', 'Th√†nh ti·ªÅn']);
  details.forEach(d => sheetDetail.appendRow([d.id_don_hang, d.ten_san_pham, d.gia_tien, d.so_luong, d.thanh_tien]));

  return ss.getUrl();
}

function getAdminSalesHierarchy() {
  const ss = SpreadsheetApp.openById(REPORT_AUTH_SS_ID);
  const useSheet = ss.getSheetByName('use');
  const data = useSheet.getDataRange().getValues();
  const hierarchy = {};
  for (let i = 1; i < data.length; i++) {
    // Decrypt Admin Email
    const adminEmail = (decryptData(data[i][5]) || "").toLowerCase();
    // Decrypt User Email
    const userEmail = (decryptData(data[i][1]) || "").toLowerCase();
    
    if (adminEmail && adminEmail !== 'n/a' && userEmail) {
      if (!hierarchy[adminEmail]) hierarchy[adminEmail] = [];
      hierarchy[adminEmail].push(userEmail);
    }
  }
  return hierarchy;
}

function getStaffName(email) {
  const ss = SpreadsheetApp.openById(REPORT_AUTH_SS_ID);
  const data = ss.getSheetByName('use').getDataRange().getValues();
  const found = data.find(r => decryptData(r[1]).toLowerCase() === email.toLowerCase());
  return found ? found[3] : email; // Fullname is usually plain text
}

function getCustomersByDateRange(start, end) {
  const ss = SpreadsheetApp.openById(REPORT_CRM_SS_ID);
  const data = ss.getSheetByName('data_khach_hang').getDataRange().getValues();
  const results = [];
  for (let i = 1; i < data.length; i++) {
    const d = new Date(data[i][9]);
    if (d >= start && d <= end) {
      // Decrypt Sales ID if needed? Usually CRM salesId is plain or encrypted? 
      // In CRM Script, 'salesId' (Col 8, index 7) is plain text code usually or email?
      // Step 5122: CRM encrypts Phone/Email but salesId?
      // Filter logic in CRM script uses "salesId" filter.
      // Let's assume salesId is Email (User Email). 
      // If previous system used Plain, and Auth uses Encrypted...
      // CRM Sheet Col 8 (Index 7) is `salesId`.
      // Let's assume it matches Auth Email (Decrypted).
      
      const salesId = (data[i][7] || "").toLowerCase();
      // If salesId looks encrypted (base64), decrypt it.
      const safeSalesId = decryptData(salesId).toLowerCase(); 

      results.push({
        id: data[i][0], name: data[i][1], contact: data[i][2], phone: data[i][3],
        address: data[i][5], salesId: safeSalesId, area: data[i][8],
        dateStr: Utilities.formatDate(d, "GMT+7", "dd/MM/yyyy")
      });
    }
  }
  return results;
}

function getOrdersByDateRange(start, end) {
  const folder = DriveApp.getFolderById(REPORT_DATA_FOLDER_ID);
  const files = folder.getFilesByName(REPORT_ORDER_HEADER_FILE);
  if (!files.hasNext()) return [];
  const content = JSON.parse(files.next().getBlob().getDataAsString() || '[]');
  const results = [];
  const finalizedStatuses = ['ƒë∆°n ch·ªët', 'ho√†n th√†nh'];
  
  content.forEach(o => {
    const status = (o.trang_thai_don_hang || "").toLowerCase();
    if (!finalizedStatuses.includes(status)) return;
    
    // Parse Date "HH:mm dd/MM/YYYY"
    const parts = o.ngay_len_don.split(' ');
    if (parts.length < 2) return;
    const dateParts = parts[1].split('/');
    // Check parts validity
    if(dateParts.length < 3) return;
    
    const d = new Date(parseInt(dateParts[2]), parseInt(dateParts[1])-1, parseInt(dateParts[0]), 0, 0, 0); // Start of that day
    
    // Check range (inclusive)
    if (d >= start && d <= end) { // Simplified comparison
      o.value = parseMoney(o.so_tien_con_lai || o.tong_gia_tri || 0);
      // Decrypt Email
      o.salesId = (decryptData(o.nguoi_len_don) || "").toLowerCase();
      results.push(o);
    }
  });
  return results;
}

function getMonthlyOrderDetails(orderIds) {
  if (orderIds.length === 0) return [];
  const folder = DriveApp.getFolderById(REPORT_DATA_FOLDER_ID);
  const files = folder.getFilesByName(REPORT_ORDER_DETAIL_FILE);
  if (!files.hasNext()) return [];
  const allDetails = JSON.parse(files.next().getBlob().getDataAsString() || '[]');
  return allDetails.filter(d => orderIds.includes(d.id_don_hang));
}

function parseMoney(val) {
  if (typeof val === 'number') return val;
  return parseFloat(val ? val.toString().replace(/[^\d]/g, '') : 0);
}

function sendEmailToAdmin(adminEmail, staffReports, totalRevenue, dateLabel, sheetUrl) {
  const fmt = (num) => num.toLocaleString('vi-VN') + " ƒë";
  let rowsHtml = staffReports.map(s => `
    <tr>
      <td style="padding:10px; border-bottom:1px solid #eee;"><b>${s.name}</b><br><small>${s.email}</small></td>
      <td style="padding:10px; border-bottom:1px solid #eee; text-align:center;">${s.customerCount}</td>
      <td style="padding:10px; border-bottom:1px solid #eee; text-align:center;">${s.orderCount}</td>
      <td style="padding:10px; border-bottom:1px solid #eee; text-align:right; font-weight:bold; color:#6366f1;">${fmt(s.revenue)}</td>
    </tr>`).join('');

  const htmlBody = `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: auto; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden;">
      <div style="background: #1e1b4b; color: white; padding: 25px; text-align: center;">
        <h2 style="margin:0; text-transform: uppercase;">B√ÅO C√ÅO DOANH THU</h2>
        <p style="margin:5px 0 0; opacity: 0.8;">Kho·∫£ng th·ªùi gian: ${dateLabel}</p>
      </div>
      <div style="padding: 20px;">
        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #6366f1;">
          <div style="font-size: 13px; color: #64748b; font-weight: bold;">T·ªîNG DOANH THU (ƒê∆†N CH·ªêT + HO√ÄN TH√ÄNH)</div>
          <div style="font-size: 26px; font-weight: 800; color: #1e1b4b;">${fmt(totalRevenue)}</div>
        </div>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 25px;">
          <thead>
            <tr style="background: #f1f5f9; text-align: left; font-size: 11px; color: #64748b;">
              <th style="padding: 10px;">NH√ÇN VI√äN (Tr·ª±c thu·ªôc)</th>
              <th style="padding: 10px; text-align: center;">KH M·ªöI</th>
              <th style="padding: 10px; text-align: center;">ƒê∆†N</th>
              <th style="padding: 10px; text-align: right;">DOANH S·ªê</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
        </table>
        <div style="text-align: center; margin-top: 20px;">
          <a href="${sheetUrl}" target="_blank" style="display: inline-block; padding: 12px 24px; background: #22c55e; color: white; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 14px;">
            üìÇ XEM V√Ä T·∫¢I D·ªÆ LI·ªÜU CHI TI·∫æT
          </a>
        </div>
      </div>
    </div>`;

  MailApp.sendEmail({
    to: adminEmail,
    subject: `[B√ÅO C√ÅO] Doanh thu t·ª´ ${dateLabel} - Dunvex Admin`,
    htmlBody: htmlBody
  });
}

function initMonthlyTrigger() {
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(t => { if (t.getHandlerFunction() === 'sendReportForPreviousMonth') ScriptApp.deleteTrigger(t); });
  ScriptApp.newTrigger('sendReportForPreviousMonth').timeBased().onMonthDay(1).atHour(8).create();
  return "Auto trigger set.";
}
function sendReportForPreviousMonth() {
  // Logic default: previous month
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
  const end = new Date(now.getFullYear(), now.getMonth(), 0);
  const sStr = Utilities.formatDate(start, "GMT+7", "yyyy-MM-dd");
  const eStr = Utilities.formatDate(end, "GMT+7", "yyyy-MM-dd");
  sendAdminReportByDate(sStr, eStr, null);
}

/**
 * NEW: getRevenueData for Frontend Tab
 */
function getRevenueData(d) {
  const s = d.startDate.split('-');
  const e = d.endDate.split('-');
  const start = new Date(s[0], s[1]-1, s[2], 0,0,0);
  const end = new Date(e[0], e[1]-1, e[2], 23,59,59);
  
  const staffFilter = (d.staffEmail || "ALL").toLowerCase();
  const statusFilter = (d.status || "ALL").toLowerCase();
  const requester = (d.requesterEmail || "").toLowerCase().trim();

  // Get Managed Emails (Team Filter)
  const hierarchy = getAdminSalesHierarchy();
  const managedEmails = [requester];
  if (hierarchy[requester]) {
    hierarchy[requester].forEach(email => {
      if (!managedEmails.includes(email)) managedEmails.push(email);
    });
  }

  // 1. Get All Orders
  const folder = DriveApp.getFolderById(REPORT_DATA_FOLDER_ID);
  const files = folder.getFilesByName(REPORT_ORDER_HEADER_FILE);
  if (!files.hasNext()) return { success: true, orders: [], summary: { orderCount: 0, totalRevenue: 0, newCustomers: 0 } };
  
  const allOrdersHeader = JSON.parse(files.next().getBlob().getDataAsString() || '[]');
  
  const filteredOrders = [];
  let totalRev = 0;

  allOrdersHeader.forEach(o => {
    // a. Date Filter Support both "ngay_len_don" and "ng√†y t·∫°o"
    const rawDate = o.ngay_len_don || o['ng√†y t·∫°o'];
    if (!rawDate || typeof rawDate !== 'string') return;

    const parts = rawDate.split(' ');
    if (parts.length < 2) return;
    const dateParts = parts[1].split('/');
    if (dateParts.length < 3) return;
    
    const dObj = new Date(parseInt(dateParts[2]), parseInt(dateParts[1])-1, parseInt(dateParts[0]));
    if (dObj < start || dObj > end) return;

    // b. Staff Filter
    const staffKey = o.nguoi_len_don || o['mail ƒëƒÉng nh·∫≠p'];
    const orderStaff = (decryptData(staffKey) || "").toLowerCase().trim();
    
    if (staffFilter !== "all") {
      if (orderStaff !== staffFilter) return;
    } else {
      // If "ALL", restrict to managed group IF requester is not a super-admin who should see all?
      // But based on user request, they want separation.
      if (orderStaff !== requester && !managedEmails.includes(orderStaff)) return;
    }

    // c. Status Filter
    const orderStatus = (o.trang_thai_don_hang || o['tr·∫°ng th√°i l√™n ƒë∆°n'] || "").toLowerCase();
    if (statusFilter !== "all" && orderStatus !== statusFilter) return;

    // Passed filters
    const val = parseMoney(o.so_tien_con_lai || o.tong_gia_tri || o['t·ªïng ti·ªÅn trong ƒë∆°n'] || 0);
    totalRev += val;
    
    filteredOrders.push({
      date: rawDate,
      customerName: o.ten_khach_hang || o['t√™n kh√°ch h√†ng'],
      staffName: getStaffName(orderStaff),
      total: val,
      status: o.trang_thai_don_hang || o['tr·∫°ng th√°i l√™n ƒë∆°n'] || "N/A"
    });
  });

  // 2. Get New Customers
  const newCustomers = getCustomersByDateRange(start, end);
  let filteredNewCustomersCount = 0;
  
  if (staffFilter !== "all") {
    filteredNewCustomersCount = newCustomers.filter(c => c.salesId === staffFilter).length;
  } else {
    filteredNewCustomersCount = newCustomers.filter(c => managedEmails.includes(c.salesId)).length;
  }

  return {
    success: true,
    orders: filteredOrders,
    summary: {
      orderCount: filteredOrders.length,
      totalRevenue: totalRev,
      newCustomers: filteredNewCustomersCount
    }
  };
}
