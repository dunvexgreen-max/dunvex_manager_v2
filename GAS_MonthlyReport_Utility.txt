/**
 * GAS_MonthlyReport_Utility.txt
 * H·ªÜ TH·ªêNG T·ªîNG H·ª¢P B√ÅO C√ÅO TH√ÅNG & T·∫†O FILE D·ªÆ LI·ªÜU CHI TI·∫æT (LINK GOOGLE SHEET)
 * (Script n√†y n√™n ƒë∆∞·ª£c tri·ªÉn khai d∆∞·ªõi d·∫°ng Web App ƒë·ªôc l·∫≠p)
 */

const REPORT_CRM_SS_ID = '15niaoQ7FozkRCushPGNtq4zj6pwA0UQ5Wel61ksv8L8';
const REPORT_AUTH_SS_ID = '1rhP1UCiMLi8yNVvcd56SsZIJAm09Yxu6WpjxuHKYKb0';
const REPORT_DATA_FOLDER_ID = '1_LT4rzVui2E3BgfcwUSfMsUGQMN9NRTs';
const REPORT_ORDER_HEADER_FILE = 'order.json';
const REPORT_ORDER_DETAIL_FILE = 'order_chi_tiet.json';

// --- ƒêI·ªÇM TI·∫æP NH·∫¨N Y√äU C·∫¶U T·ª™ GIAO DI·ªÜN WEB ---
function doPost(e) {
  let result;
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;

    switch (action) {
      case 'sendMonthlyReport':
        result = sendMonthlyAdminReport(data.month, data.year);
        break;
      case 'setupTrigger':
        result = { success: true, message: initMonthlyTrigger() };
        break;
      default:
        result = { success: false, message: 'H√†nh ƒë·ªông kh√¥ng h·ª£p l·ªá' };
    }
  } catch (error) {
    result = { success: false, message: 'L·ªói Backend Report: ' + error.toString() };
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

/**
 * H√†m ch√≠nh th·ª±c hi·ªán g·ª≠i b√°o c√°o th√°ng cho c√°c Admin
 */
function sendMonthlyAdminReport(month, year) {
  const now = new Date();
  const targetMonth = month || (now.getMonth() + 1);
  const targetYear = year || now.getFullYear();
  
  console.log(`B·∫Øt ƒë·∫ßu t·∫°o b√°o c√°o th√°ng ${targetMonth}/${targetYear}`);

  const hierarchy = getAdminSalesHierarchy();
  const allCustomers = getMonthlyCustomers(targetMonth, targetYear);
  const allOrders = getMonthlyOrders(targetMonth, targetYear);
  const allOrderDetails = getMonthlyOrderDetails(allOrders.map(o => o.id_don_hang));

  for (let adminEmail in hierarchy) {
    const subordinates = hierarchy[adminEmail]; 
    const staffReports = [];
    let adminTotalRevenue = 0;

    // L·ªçc d·ªØ li·ªáu th√¥ cho Admin n√†y ƒë·ªÉ l√†m file ƒë√≠nh k√®m
    const adminCustomersRaw = allCustomers.filter(c => subordinates.includes(c.salesId.toLowerCase()));
    const adminOrdersRaw = allOrders.filter(o => subordinates.includes(o.salesId.toLowerCase()));
    const adminOrderIds = adminOrdersRaw.map(o => o.id_don_hang);
    const adminDetailsRaw = allOrderDetails.filter(d => adminOrderIds.includes(d.id_don_hang));

    subordinates.forEach(staffEmail => {
      const staffEmailLower = staffEmail.toLowerCase();
      const staffCustomers = adminCustomersRaw.filter(c => c.salesId.toLowerCase() === staffEmailLower);
      const staffOrders = adminOrdersRaw.filter(o => o.salesId.toLowerCase() === staffEmailLower);
      const staffRevenue = staffOrders.reduce((sum, o) => sum + (o.value || 0), 0);
      
      staffReports.push({
        email: staffEmail,
        name: getStaffName(staffEmail),
        customerCount: staffCustomers.length,
        orderCount: staffOrders.length,
        revenue: staffRevenue
      });

      adminTotalRevenue += staffRevenue;
    });

    if (staffReports.length > 0) {
      // T·∫†O FILE GOOGLE SHEET V√Ä L·∫§Y LINK (Thay v√¨ file Excel ƒë√≠nh k√®m)
      const sheetUrl = generateDataSheet(adminCustomersRaw, adminOrdersRaw, adminDetailsRaw, targetMonth, targetYear, adminEmail);
      sendEmailToAdmin(adminEmail, staffReports, adminTotalRevenue, targetMonth, targetYear, sheetUrl);
    }
  }

  return { success: true, message: `ƒê√£ g·ª≠i b√°o c√°o th√°ng ${targetMonth}/${targetYear}` };
}

/**
 * T·∫°o t√†i li·ªáu Google Sheet ch·ª©a d·ªØ li·ªáu chi ti·∫øt v√† tr·∫£ v·ªÅ Link
 * ƒê√£ b·ªè ph·∫ßn setSharing ƒë·ªÉ tr√°nh l·ªói quy·ªÅn
 */
function generateDataSheet(customers, orders, details, month, year, adminEmail) {
  const fileName = `D·ªØ li·ªáu chi ti·∫øt b√°o c√°o T${month}/${year} - ${adminEmail}`;
  const ss = SpreadsheetApp.create(fileName);
  
  // Sheet 1: Kh√°ch h√†ng m·ªõi
  const sheetKH = ss.getActiveSheet();
  sheetKH.setName("KH M·ªõi");
  const khHeaders = ['ID', 'T√™n Kh√°ch', 'Ng∆∞·ªùi li√™n h·ªá', 'SƒêT', 'ƒê·ªãa ch·ªâ', 'Khu v·ª±c', 'Sale ph·ª• tr√°ch', 'Ng√†y t·∫°o'];
  sheetKH.appendRow(khHeaders);
  sheetKH.getRange(1, 1, 1, khHeaders.length).setFontWeight('bold').setBackground('#f1f5f9');
  customers.forEach(c => {
    sheetKH.appendRow([c.id, c.name, c.contact, c.phone, c.address, c.area, c.salesId, c.dateStr]);
  });
  sheetKH.autoResizeColumns(1, 8);
  
  // Sheet 2: ƒê∆°n h√†ng
  const sheetOrder = ss.insertSheet("ƒê∆°n h√†ng");
  const oh = ['ID ƒê∆°n', 'Kh√°ch h√†ng', 'Sale', 'Ng√†y ƒë∆°n', 'Tr·∫°ng th√°i', 'Gi√° tr·ªã', 'C√≤n l·∫°i'];
  sheetOrder.appendRow(oh);
  sheetOrder.getRange(1, 1, 1, oh.length).setFontWeight('bold').setBackground('#f1f5f9');
  
  orders.forEach(o => {
    // Format money helper
    const fmt = (n) => (n || 0).toLocaleString('vi-VN');
    sheetOrder.appendRow([
      o.id_don_hang, 
      o.ten_khach_hang, 
      o.nguoi_len_don, 
      o.ngay_len_don, 
      o.trang_thai_don_hang, 
      fmt(o.tong_gia_tri),      // Gi√° tr·ªã ƒë∆°n
      fmt(o.so_tien_con_lai)    // C√≤n l·∫°i
    ]);
  });
  sheetOrder.autoResizeColumns(1, 7);

  // Sheet 3: Chi ti·∫øt s·∫£n ph·∫©m
  const sheetDetail = ss.insertSheet("Chi ti·∫øt s·∫£n ph·∫©m");
  const dh = ['ID ƒê∆°n', 'T√™n s·∫£n ph·∫©m', 'ƒê∆°n gi√°', 'S·ªë l∆∞·ª£ng', 'Th√†nh ti·ªÅn'];
  sheetDetail.appendRow(dh);
  sheetDetail.getRange(1, 1, 1, dh.length).setFontWeight('bold').setBackground('#f1f5f9');
  
  details.forEach(d => {
    const fmt = (n) => (n || 0).toLocaleString('vi-VN');
    sheetDetail.appendRow([
      d.id_don_hang, 
      d.ten_san_pham, 
      fmt(d.don_gia),      // ƒê∆°n gi√°
      d.so_luong, 
      fmt(d.thanh_tien)    // Th√†nh ti·ªÅn
    ]);
  });
  sheetDetail.autoResizeColumns(1, 5);

  // Tr·∫£ v·ªÅ URL c·ªßa file v·ª´a t·∫°o
  return ss.getUrl();
}

/**
 * L·∫•y c·∫•u tr√∫c Admin - Sale
 */
function getAdminSalesHierarchy() {
  const ss = SpreadsheetApp.openById(REPORT_AUTH_SS_ID);
  const useSheet = ss.getSheetByName('use');
  const data = useSheet.getDataRange().getValues();
  const hierarchy = {};
  for (let i = 1; i < data.length; i++) {
    const adminEmail = (data[i][5] || "").toString().toLowerCase();
    if (adminEmail && adminEmail !== 'n/a') {
      if (!hierarchy[adminEmail]) hierarchy[adminEmail] = [];
      hierarchy[adminEmail].push(data[i][1].toString().toLowerCase());
    }
  }
  return hierarchy;
}

function getStaffName(email) {
  const ss = SpreadsheetApp.openById(REPORT_AUTH_SS_ID);
  const data = ss.getSheetByName('use').getDataRange().getValues();
  const found = data.find(r => r[1].toString().toLowerCase() === email.toLowerCase());
  return found ? found[3] : email;
}

function getMonthlyCustomers(month, year) {
  const ss = SpreadsheetApp.openById(REPORT_CRM_SS_ID);
  const data = ss.getSheetByName('data_khach_hang').getDataRange().getValues();
  const results = [];
  for (let i = 1; i < data.length; i++) {
    const d = new Date(data[i][9]);
    if (d.getMonth() + 1 === month && d.getFullYear() === year) {
      results.push({
        id: data[i][0], name: data[i][1], contact: data[i][2], phone: data[i][3],
        address: data[i][5], salesId: data[i][7], area: data[i][8],
        dateStr: Utilities.formatDate(d, "GMT+7", "dd/MM/yyyy")
      });
    }
  }
  return results;
}

function getMonthlyOrders(month, year) {
  const folder = DriveApp.getFolderById(REPORT_DATA_FOLDER_ID);
  const files = folder.getFilesByName(REPORT_ORDER_HEADER_FILE);
  if (!files.hasNext()) return [];
  const content = JSON.parse(files.next().getBlob().getDataAsString() || '[]');
  const results = [];
  const finalizedStatuses = ['ƒë∆°n ch·ªët', 'ho√†n th√†nh'];
  content.forEach(o => {
    const status = (o.trang_thai_don_hang || "").toLowerCase();
    if (!finalizedStatuses.includes(status)) return;
    const parts = o.ngay_len_don.split(' ');
    if (parts.length < 2) return;
    const dateParts = parts[1].split('/');
    if (parseInt(dateParts[1]) === month && parseInt(dateParts[2]) === year) {
      o.value = parseMoney(o.so_tien_con_lai || o.tong_gia_tri || 0);
      o.salesId = (o.nguoi_len_don || "").toLowerCase();
      results.push(o);
    }
  });
  return results;
}

function getMonthlyOrderDetails(orderIds) {
  if (orderIds.length === 0) return [];
  const folder = DriveApp.getFolderById(REPORT_DATA_FOLDER_ID);
  const files = folder.getFilesByName(REPORT_ORDER_DETAIL_FILE);
  if (!files.hasNext()) return [];
  const allDetails = JSON.parse(files.next().getBlob().getDataAsString() || '[]');
  return allDetails.filter(d => orderIds.includes(d.id_don_hang));
}

function parseMoney(val) {
  if (typeof val === 'number') return val;
  return parseFloat(val ? val.toString().replace(/[^\d]/g, '') : 0);
}

function sendEmailToAdmin(adminEmail, staffReports, totalRevenue, month, year, sheetUrl) {
  const fmt = (num) => num.toLocaleString('vi-VN') + " ƒë";
  let rowsHtml = staffReports.map(s => `
    <tr>
      <td style="padding:10px; border-bottom:1px solid #eee;"><b>${s.name}</b><br><small>${s.email}</small></td>
      <td style="padding:10px; border-bottom:1px solid #eee; text-align:center;">${s.customerCount}</td>
      <td style="padding:10px; border-bottom:1px solid #eee; text-align:center;">${s.orderCount}</td>
      <td style="padding:10px; border-bottom:1px solid #eee; text-align:right; font-weight:bold; color:#6366f1;">${fmt(s.revenue)}</td>
    </tr>`).join('');

  const htmlBody = `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: auto; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden;">
      <div style="background: #1e1b4b; color: white; padding: 25px; text-align: center;">
        <h2 style="margin:0; text-transform: uppercase;">B√ÅO C√ÅO T·ªîNG H·ª¢P TH√ÅNG ${month}/${year}</h2>
        <p style="margin:5px 0 0; opacity: 0.8;">H·ªá th·ªëng Qu·∫£n l√Ω Dunvex Digital</p>
      </div>
      <div style="padding: 20px;">
        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #6366f1;">
          <div style="font-size: 13px; color: #64748b; font-weight: bold;">T·ªîNG DOANH THU ƒê∆†N CH·ªêT TRONG TH√ÅNG</div>
          <div style="font-size: 26px; font-weight: 800; color: #1e1b4b;">${fmt(totalRevenue)}</div>
        </div>
        
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 25px;">
          <thead>
            <tr style="background: #f1f5f9; text-align: left; font-size: 11px; color: #64748b;">
              <th style="padding: 10px;">NH√ÇN VI√äN</th>
              <th style="padding: 10px; text-align: center;">KH M·ªöI</th>
              <th style="padding: 10px; text-align: center;">ƒê∆†N CH·ªêT</th>
              <th style="padding: 10px; text-align: right;">DOANH S·ªê</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
        </table>

        <div style="text-align: center; margin-top: 20px;">
          <a href="${sheetUrl}" target="_blank" style="display: inline-block; padding: 12px 24px; background: #22c55e; color: white; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 14px;">
            üìÇ XEM D·ªÆ LI·ªÜU CHI TI·∫æT (GOOGLE SHEET)
          </a>
          <p style="font-size: 12px; color: #64748b; margin-top: 10px;">
            (Nh·∫•n v√†o n√∫t tr√™n ƒë·ªÉ xem danh s√°ch kh√°ch h√†ng v√† chi ti·∫øt ƒë∆°n h√†ng)
          </p>
        </div>
      </div>
      <div style="background: #f1f5f9; padding: 15px; text-align: center; font-size: 11px; color: #94a3b8;">
        Th·ªùi gian xu·∫•t b√°o c√°o: ${Utilities.formatDate(new Date(), "GMT+7", "HH:mm dd/MM/yyyy")}
      </div>
    </div>`;

  MailApp.sendEmail({
    to: adminEmail,
    subject: `[B√ÅO C√ÅO TH√ÅNG] D·ªØ li·ªáu doanh s·ªë & Kh√°ch h√†ng th√°ng ${month}/${year} - Dunvex Digital`,
    htmlBody: htmlBody
  });
}

function initMonthlyTrigger() {
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(t => { if (t.getHandlerFunction() === 'sendReportForPreviousMonth') ScriptApp.deleteTrigger(t); });
  ScriptApp.newTrigger('sendReportForPreviousMonth').timeBased().onMonthDay(1).atHour(8).create();
  return "ƒê√£ thi·∫øt l·∫≠p b√°o c√°o t·ª± ƒë·ªông v√†o 8h s√°ng ng√†y 01 h√†ng th√°ng.";
}

function sendReportForPreviousMonth() {
  const now = new Date();
  let m = now.getMonth(); let y = now.getFullYear();
  if (m === 0) { m = 12; y--; } else { m++; }
  return sendMonthlyAdminReport(m, y);
}

/**
 * H√ÄM N√ÄY CH·ªà D√ôNG ƒê·ªÇ K√çCH HO·∫†T QUY·ªÄN (CH·∫†Y TH·ª¶ C√îNG 1 L·∫¶N TRONG EDITOR)
 */
function manualAuthorize() {
  Logger.log("ƒêang k√≠ch ho·∫°t quy·ªÅn truy c·∫≠p...");
  DriveApp.getRootFolder();
  SpreadsheetApp.create("Temp");
  MailApp.getRemainingDailyQuota();
  Logger.log("K√≠ch ho·∫°t quy·ªÅn th√†nh c√¥ng!");
}
